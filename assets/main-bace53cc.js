(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))h(d);new MutationObserver(d=>{for(const g of d)if(g.type==="childList")for(const x of g.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&h(x)}).observe(document,{childList:!0,subtree:!0});function u(d){const g={};return d.integrity&&(g.integrity=d.integrity),d.referrerPolicy&&(g.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?g.credentials="include":d.crossOrigin==="anonymous"?g.credentials="omit":g.credentials="same-origin",g}function h(d){if(d.ep)return;d.ep=!0;const g=u(d);fetch(d.href,g)}})();var VR=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function UR(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var BT={exports:{}};(function(c,o){(function(u,h){c.exports=h()})(VR,function(){var u,h,d;function g(I,S){if(!u)u=S;else if(!h)h=S;else{var D="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+u+")(sharedChunk); ("+h+")(sharedChunk); self.onerror = null;",O={};u(O),d=S(O),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(d.workerUrl=window.URL.createObjectURL(new Blob([D],{type:"text/javascript"})))}}g(["exports"],function(I){var S=typeof self<"u"?self:{},D="3.0.0-beta.1";let O;const B={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(O==null){const e=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{O={}.API_URL_REGEX!=null?new RegExp({}.API_URL_REGEX):e}catch{O=e}}return O},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!B.API_URL)return null;try{const e=new URL(B.API_URL);return e.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":e.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard-beta",MAX_PARALLEL_IMAGE_REQUESTS:16,LOADERS_URL:"https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl-loaders.js"},W={supported:!1,testSupport:function(e){!bt&&it&&(ft?Pt(e):et=e)}};let et,it,bt=!1,ft=!1;function Pt(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,it),e.isContextLost())return;W.supported=!0}catch{}e.deleteTexture(t),bt=!0}S.document&&(it=S.document.createElement("img"),it.onload=function(){et&&Pt(et),et=null,ft=!0},it.onerror=function(){bt=!0,et=null},it.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const kt="01";function Nt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ne=Te;function Te(e,t,r,n){this.cx=3*e,this.bx=3*(r-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(n-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=r,this.p2y=n}Te.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(t===void 0&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var r=e,n=0;n<8;n++){var i=this.sampleCurveX(r)-e;if(Math.abs(i)<t)return r;var s=this.sampleCurveDerivativeX(r);if(Math.abs(s)<1e-6)break;r-=i/s}var a=0,l=1;for(r=e,n=0;n<20&&(i=this.sampleCurveX(r),!(Math.abs(i-e)<t));n++)e>i?a=r:l=r,r=.5*(l-a)+a;return r},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}};var we=Nt(ne),Ve=Ne;function Ne(e,t){this.x=e,this.y=t}Ne.prototype={clone:function(){return new Ne(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,r=e.y-this.y;return t*t+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),r=Math.sin(e),n=r*this.x+t*this.y;return this.x=t*this.x-r*this.y,this.y=n,this},_rotateAround:function(e,t){var r=Math.cos(e),n=Math.sin(e),i=t.y+n*(this.x-t.x)+r*(this.y-t.y);return this.x=t.x+r*(this.x-t.x)-n*(this.y-t.y),this.y=i,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Ne.convert=function(e){return e instanceof Ne?e:Array.isArray(e)?new Ne(e[0],e[1]):e};var H=Nt(Ve);function ue(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!ue(e[r],t[r]))return!1;return!0}if(typeof e=="object"&&e!==null&&t!==null){if(typeof t!="object"||Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(!ue(e[r],t[r]))return!1;return!0}return e===t}const Tr=Math.PI/180,Ir=180/Math.PI;function re(e){return e*Tr}function qt(e){return e*Ir}const ir=[[0,0],[1,0],[1,1],[0,1]];function Sr(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,r=t*e;return 4*(e<.5?r:3*(e-t)+r-.75)}function Mn(e){let t=1/0,r=1/0,n=-1/0,i=-1/0;for(const s of e)t=Math.min(t,s.x),r=Math.min(r,s.y),n=Math.max(n,s.x),i=Math.max(i,s.y);return{min:new H(t,r),max:new H(n,i)}}function An(e,t,r=0,n=!0){const i=new H(r,r),s=e.sub(i),a=t.add(i),l=[s,new H(a.x,s.y),a,new H(s.x,a.y)];return n&&l.push(s.clone()),l}function Bn(e,t,r,n){const i=new we(e,t,r,n);return function(s){return i.solve(s)}}const ai=Bn(.25,.1,.25,1);function Bt(e,t,r){return Math.min(r,Math.max(t,e))}function Ti(e,t,r){return(r=Bt((r-e)/(t-e),0,1))*r*(3-2*r)}function Vn(e,t,r){const n=r-t,i=((e-t)%n+n)%n+t;return i===t?r:i}function Lo(e,t,r){if(!e.length)return r(null,[]);let n=e.length;const i=new Array(e.length);let s=null;e.forEach((a,l)=>{t(a,(p,f)=>{p&&(s=p),i[l]=f,--n==0&&r(s,i)})})}function ho(e){const t=[];for(const r in e)t.push(e[r]);return t}function Yt(e,...t){for(const r of t)for(const n in r)e[n]=r[n];return e}function Zi(e,t){const r={};for(let n=0;n<t.length;n++){const i=t[n];i in e&&(r[i]=e[i])}return r}let hm=1;function gu(){return hm++}function Ep(){return function e(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()}function Tp(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function Ip(e){return!!e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function Ln(e,t){e.forEach(r=>{t[r]&&(t[r]=t[r].bind(t))})}function _u(e,t){return e.indexOf(t,e.length-t.length)!==-1}function yu(e,t,r){const n={};for(const i in e)n[i]=t.call(r||this,e[i],i,e);return n}function St(e,t,r){const n={};for(const i in e)t.call(r||this,e[i],i,e)&&(n[i]=e[i]);return n}function j(e){return Array.isArray(e)?e.map(j):typeof e=="object"&&e?yu(e,j):e}const Z={};function Y(e){Z[e]||(typeof console<"u"&&console.warn(e),Z[e]=!0)}function mt(e,t,r){return(r.y-e.y)*(t.x-e.x)>(t.y-e.y)*(r.x-e.x)}function _t(e){let t=0;for(let r,n,i=0,s=e.length,a=s-1;i<s;a=i++)r=e[i],n=e[a],t+=(n.x-r.x)*(r.y+n.y);return t}function Xt([e,t,r]){const n=re(t+90),i=re(r);return{x:e*Math.cos(n)*Math.sin(i),y:e*Math.sin(n)*Math.sin(i),z:e*Math.cos(i),azimuthal:t,polar:r}}function $t(e,t,r){const n=Math.sqrt(e*e+t*t+r*r),i=n>0?Math.acos(r/n)*Ir:0;let s=e!==0||t!==0?Math.atan2(-t,-e)*Ir+90:0;return s<0&&(s+=360),[n,s,i]}function gt(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function ie(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,n,i,s)=>{const a=i||s;return t[n]=!a||a.toLowerCase(),""}),t["max-age"]){const r=parseInt(t["max-age"],10);isNaN(r)?delete t["max-age"]:t["max-age"]=r}return t}let oe=null;function pe(e){if(oe==null){const t=e.navigator?e.navigator.userAgent:null;oe=!!e.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return oe}function yr(){return!!S.document.fullscreenElement||!!S.document.webkitFullscreenElement}function Pn(e){try{const t=S[e];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}}function Jr(e,t){return[e[4*t],e[4*t+1],e[4*t+2],e[4*t+3]]}function Wr(e,t,r){e[4*t+0]=r[0],e[4*t+1]=r[1],e[4*t+2]=r[2],e[4*t+3]=r[3]}function Qr(e,t){return[Math.pow(e[0],2.2)*t,Math.pow(e[1],2.2)*t,Math.pow(e[2],2.2)*t]}function Ur(e){return[Math.pow(e[0],1/2.2),Math.pow(e[1],1/2.2),Math.pow(e[2],1/2.2)]}const _i="mapbox-tiles";let Li=500,Oa=50,Ii,Na;function Do(){try{return S.caches}catch{}}function ss(){Do()&&!Ii&&(Ii=S.caches.open(_i))}function Pl(e){const t=e.indexOf("?");if(t<0)return e;const r=function(i){const s=i.indexOf("?");return s>0?i.slice(s+1).split("&"):[]}(e),n=r.filter(i=>{const s=i.split("=");return s[0]==="language"||s[0]==="worldview"});return n.length?`${e.slice(0,t)}?${n.join("&")}`:e.slice(0,t)}let Ll=1/0;function ht(e){Ll++,Ll>Oa&&(e.getActor().send("enforceCacheSizeLimit",Li),Ll=0)}const ct={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(ct);class vt extends Error{constructor(t,r,n){r===401&&Gr(n)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=r,this.url=n}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Mt=gt()?()=>self.worker&&self.worker.referrer:()=>(S.location.protocol==="blob:"?S.parent:S).location.href,Ct=function(e,t){if(!(/^file:/.test(r=e.url)||/^file:/.test(Mt())&&!/^\w+:/.test(r))){if(S.fetch&&S.Request&&S.AbortController&&S.Request.prototype.hasOwnProperty("signal"))return function(n,i){const s=new S.AbortController,a=new S.Request(n.url,{method:n.method||"GET",body:n.body,credentials:n.credentials,headers:n.headers,referrer:Mt(),referrerPolicy:n.referrerPolicy,signal:s.signal});let l=!1,p=!1;const f=(m=a.url).indexOf("sku=")>0&&Gr(m);var m;n.type==="json"&&a.headers.set("Accept","application/json");const _=(v,b,w)=>{if(p)return;if(v&&v.message!=="SecurityError"&&Y(v.toString()),b&&w)return y(b);const E=Date.now();S.fetch(a).then(T=>{if(T.ok){const C=f?T.clone():null;return y(T,C,E)}return i(new vt(T.statusText,T.status,n.url))}).catch(T=>{T.name!=="AbortError"&&i(new Error(`${T.message} ${n.url}`))})},y=(v,b,w)=>{(n.type==="arrayBuffer"?v.arrayBuffer():n.type==="json"?v.json():v.text()).then(E=>{p||(b&&w&&function(T,C,M){if(ss(),!Ii)return;const A={status:C.status,statusText:C.statusText,headers:new S.Headers};C.headers.forEach((R,N)=>A.headers.set(N,R));const P=ie(C.headers.get("Cache-Control")||"");if(P["no-store"])return;P["max-age"]&&A.headers.set("Expires",new Date(M+1e3*P["max-age"]).toUTCString());const L=A.headers.get("Expires");L&&(new Date(L).getTime()-M<42e4||function(R,N){if(Na===void 0)try{new Response(new ReadableStream),Na=!0}catch{Na=!1}Na?N(R.body):R.blob().then(N)}(C,R=>{const N=new S.Response(R,A);ss(),Ii&&Ii.then(k=>k.put(Pl(T.url),N)).catch(k=>Y(k.message))}))}(a,b,w),l=!0,i(null,E,v.headers.get("Cache-Control"),v.headers.get("Expires")))}).catch(E=>{p||i(new Error(E.message))})};return f?function(v,b){if(ss(),!Ii)return b(null);const w=Pl(v.url);Ii.then(E=>{E.match(w).then(T=>{const C=function(M){if(!M)return!1;const A=new Date(M.headers.get("Expires")||0),P=ie(M.headers.get("Cache-Control")||"");return A>Date.now()&&!P["no-cache"]}(T);E.delete(w),C&&E.put(w,T.clone()),b(null,T,C)}).catch(b)}).catch(b)}(a,_):_(null,null),{cancel:()=>{p=!0,l||s.abort()}}}(e,t);if(gt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0)}var r;return function(n,i){const s=new S.XMLHttpRequest;s.open(n.method||"GET",n.url,!0),n.type==="arrayBuffer"&&(s.responseType="arraybuffer");for(const a in n.headers)s.setRequestHeader(a,n.headers[a]);return n.type==="json"&&(s.responseType="text",s.setRequestHeader("Accept","application/json")),s.withCredentials=n.credentials==="include",s.onerror=()=>{i(new Error(s.statusText))},s.onload=()=>{if((s.status>=200&&s.status<300||s.status===0)&&s.response!==null){let a=s.response;if(n.type==="json")try{a=JSON.parse(s.response)}catch(l){return i(l)}i(null,a,s.getResponseHeader("Cache-Control"),s.getResponseHeader("Expires"))}else i(new vt(s.statusText,s.status,n.url))},s.send(n.body),{cancel:()=>s.abort()}}(e,t)},Lt=function(e,t){return Ct(Yt(e,{type:"json"}),t)},Dt=function(e,t){return Ct(Yt(e,{type:"arrayBuffer"}),t)};function At(e){const t=S.document.createElement("a");return t.href=e,t.protocol===S.document.location.protocol&&t.host===S.document.location.host}const Wt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Rt,Ie;Rt=[],Ie=0;const Ke=function(e,t){if(W.supported&&(e.headers||(e.headers={}),e.headers.accept="image/webp,*/*"),Ie>=B.MAX_PARALLEL_IMAGE_REQUESTS){const s={requestParameters:e,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return Rt.push(s),s}Ie++;let r=!1;const n=()=>{if(!r)for(r=!0,Ie--;Rt.length&&Ie<B.MAX_PARALLEL_IMAGE_REQUESTS;){const s=Rt.shift(),{requestParameters:a,callback:l,cancelled:p}=s;p||(s.cancel=Ke(a,l).cancel)}},i=Dt(e,(s,a,l,p)=>{n(),s?t(s):a&&(S.createImageBitmap?function(f,m){const _=new S.Blob([new Uint8Array(f)],{type:"image/png"});S.createImageBitmap(_).then(y=>{m(null,y)}).catch(y=>{m(new Error(`Could not load image because of ${y.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(a,(f,m)=>t(f,m,l,p)):function(f,m){const _=new S.Image,y=S.URL;_.onload=()=>{m(null,_),y.revokeObjectURL(_.src),_.onload=null,S.requestAnimationFrame(()=>{_.src=Wt})},_.onerror=()=>m(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const v=new S.Blob([new Uint8Array(f)],{type:"image/png"});_.src=f.byteLength?y.createObjectURL(v):Wt}(a,(f,m)=>t(f,m,l,p)))});return{cancel:()=>{i.cancel(),n()}}},ee="NO_ACCESS_TOKEN";class Pr{constructor(t,r,n){this._transformRequestFn=t,this._customAccessToken=r,this._silenceAuthErrors=!!n,this._createSkuToken()}_createSkuToken(){const t=function(){let r="";for(let n=0;n<10;n++)r+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",kt,r].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,r){return this._transformRequestFn&&this._transformRequestFn(t,r)||{url:t}}normalizeStyleURL(t,r){if(!br(t))return t;const n=Un(t);return n.path=`/styles/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||r)}normalizeGlyphsURL(t,r){if(!br(t))return t;const n=Un(t);return n.path=`/fonts/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||r)}normalizeModelURL(t,r){if(!br(t))return t;const n=Un(t);return n.path=`/models/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||r)}normalizeSourceURL(t,r,n,i){if(!br(t))return t;const s=Un(t);return s.path=`/v4/${s.authority}.json`,s.params.push("secure"),n&&s.params.push(`language=${n}`),i&&s.params.push(`worldview=${i}`),this._makeAPIURL(s,this._customAccessToken||r)}normalizeSpriteURL(t,r,n,i){const s=Un(t);return br(t)?(s.path=`/styles/v1${s.path}/sprite${r}${n}`,this._makeAPIURL(s,this._customAccessToken||i)):(s.path+=`${r}${n}`,Gn(s))}normalizeTileURL(t,r,n){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!br(t))return t;const i=Un(t);i.path=i.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${r||n&&i.authority!=="raster"&&n===512?"@2x":""}${W.supported?".webp":"$1"}`),i.authority==="raster"?i.path=`/${B.RASTER_URL_PREFIX}${i.path}`:(i.path=i.path.replace(/^.+\/v4\//,"/"),i.path=`/${B.TILE_URL_VERSION}${i.path}`);const s=this._customAccessToken||function(a){for(const l of a){const p=l.match(/^access_token=(.*)$/);if(p)return p[1]}return null}(i.params)||B.ACCESS_TOKEN;return B.REQUIRE_ACCESS_TOKEN&&s&&this._skuToken&&i.params.push(`sku=${this._skuToken}`),this._makeAPIURL(i,s)}canonicalizeTileURL(t,r){const n=Un(t);if(!n.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!n.path.match(/\.[\w]+$/))return t;let i="mapbox://";n.path.match(/^\/raster\/v1\//)?i+=`raster/${n.path.replace(`/${B.RASTER_URL_PREFIX}/`,"")}`:i+=`tiles/${n.path.replace(`/${B.TILE_URL_VERSION}/`,"")}`;let s=n.params;return r&&(s=s.filter(a=>!a.match(/^access_token=/))),s.length&&(i+=`?${s.join("&")}`),i}canonicalizeTileset(t,r){const n=!!r&&br(r),i=[];for(const s of t.tiles||[])Gr(s)?i.push(this.canonicalizeTileURL(s,n)):i.push(s);return i}_makeAPIURL(t,r){const n="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",i=Un(B.API_URL);if(t.protocol=i.protocol,t.authority=i.authority,t.protocol==="http"){const s=t.params.indexOf("secure");s>=0&&t.params.splice(s,1)}if(i.path!=="/"&&(t.path=`${i.path}${t.path}`),!B.REQUIRE_ACCESS_TOKEN)return Gn(t);if(r=r||B.ACCESS_TOKEN,!this._silenceAuthErrors){if(!r)throw new Error(`An API access token is required to use Mapbox GL. ${n}`);if(r[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${n}`)}return t.params=t.params.filter(s=>s.indexOf("access_token")===-1),t.params.push(`access_token=${r||""}`),Gn(t)}}function br(e){return e.indexOf("mapbox:")===0}function Gr(e){return B.API_URL_REGEX.test(e)}function vn(e){return B.API_CDN_URL_REGEX.test(e)}function yi(e){return B.API_STYLE_REGEX.test(e)&&!po(e)}function po(e){return B.API_SPRITE_REGEX.test(e)}const Ro=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Un(e){const t=e.match(Ro);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function Gn(e){const t=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${t}`}const vu="mapbox.eventData";function xu(e){if(!e)return null;const t=e.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(decodeURIComponent(S.atob(t[1]).split("").map(r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class za{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const r=xu(B.ACCESS_TOKEN);let n="";return n=r&&r.u?S.btoa(encodeURIComponent(r.u).replace(/%([0-9A-F]{2})/g,(i,s)=>String.fromCharCode(+("0x"+s)))):B.ACCESS_TOKEN||"",t?`${vu}.${t}:${n}`:`${vu}:${n}`}fetchEventData(){const t=Pn("localStorage"),r=this.getStorageKey(),n=this.getStorageKey("uuid");if(t)try{const i=S.localStorage.getItem(r);i&&(this.eventData=JSON.parse(i));const s=S.localStorage.getItem(n);s&&(this.anonId=s)}catch{Y("Unable to read from LocalStorage")}}saveEventData(){const t=Pn("localStorage"),r=this.getStorageKey(),n=this.getStorageKey("uuid");if(t)try{S.localStorage.setItem(n,this.anonId),Object.keys(this.eventData).length>=1&&S.localStorage.setItem(r,JSON.stringify(this.eventData))}catch{Y("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,r,n,i){if(!B.EVENTS_URL)return;const s=Un(B.EVENTS_URL);s.params.push(`access_token=${i||B.ACCESS_TOKEN||""}`);const a={event:this.type,created:new Date(t).toISOString()},l=r?Yt(a,r):a,p={url:Gn(s),headers:{"Content-Type":"text/plain"},body:JSON.stringify([l])};this.pendingRequest=function(f,m){return Ct(Yt(f,{method:"POST"}),m)}(p,f=>{this.pendingRequest=null,n(f),this.saveEventData(),this.processRequests(i)})}queueRequest(t,r){this.queue.push(t),this.processRequests(r)}}const Sv=new class extends za{constructor(e){super("appUserTurnstile"),this._customAccessToken=e}postTurnstileEvent(e,t){B.EVENTS_URL&&B.ACCESS_TOKEN&&Array.isArray(e)&&e.some(r=>br(r)||Gr(r))&&this.queueRequest(Date.now(),t)}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=xu(B.ACCESS_TOKEN),r=t?t.u:B.ACCESS_TOKEN;let n=r!==this.eventData.tokenU;Ip(this.anonId)||(this.anonId=Ep(),n=!0);const i=this.queue.shift();if(this.eventData.lastSuccess){const s=new Date(this.eventData.lastSuccess),a=new Date(i),l=(i-this.eventData.lastSuccess)/864e5;n=n||l>=1||l<-1||s.getDate()!==a.getDate()}else n=!0;n?this.postEvent(i,{sdkIdentifier:"mapbox-gl-js",sdkVersion:D,skuId:kt,"enabled.telemetry":!1,userId:this.anonId},s=>{s||(this.eventData.lastSuccess=i,this.eventData.tokenU=r)},e):this.processRequests()}},pm=Sv.postTurnstileEvent.bind(Sv),Cv=new class extends za{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(e,t,r,n){this.skuToken=t,this.errorCb=n,B.EVENTS_URL&&(r||B.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},r):this.errorCb(new Error(ee)))}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),Ip(this.anonId)||(this.anonId=Ep()),this.postEvent(r,{sdkIdentifier:"mapbox-gl-js",sdkVersion:D,skuId:kt,skuToken:this.skuToken,userId:this.anonId},n=>{n?this.errorCb(n):t&&(this.success[t]=!0)},e))}},kI=Cv.postMapLoadEvent.bind(Cv),Mv=new class extends za{constructor(){super("gljs.performance")}postPerformanceEvent(e,t){B.EVENTS_URL&&(e||B.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},e)}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:r}=this.queue.shift(),n=function(i){const s=S.performance.getEntriesByType("resource"),a=S.performance.getEntriesByType("mark"),l=function(y){const v={};if(y){for(const b in y)if(b!=="other")for(const w of y[b]){const E=`${b}ResolveRangeMin`,T=`${b}ResolveRangeMax`,C=`${b}RequestCount`,M=`${b}RequestCachedCount`;v[E]=Math.min(v[E]||1/0,w.startTime),v[T]=Math.max(v[T]||-1/0,w.responseEnd);const A=P=>{v[P]===void 0&&(v[P]=0),++v[P]};w.transferSize!==void 0&&w.transferSize===0&&A(M),A(C)}}return v}(function(y,v){const b={};if(y)for(const w of y){const E=v(w);b[E]===void 0&&(b[E]=[]),b[E].push(w)}return b}(s,VI)),p=S.devicePixelRatio,f=S.navigator.connection||S.navigator.mozConnection||S.navigator.webkitConnection,m={counters:[],metadata:[],attributes:[]},_=(y,v,b)=>{b!=null&&y.push({name:v,value:b.toString()})};for(const y in l)_(m.counters,y,l[y]);if(i.interactionRange[0]!==1/0&&i.interactionRange[1]!==-1/0&&(_(m.counters,"interactionRangeMin",i.interactionRange[0]),_(m.counters,"interactionRangeMax",i.interactionRange[1])),a)for(const y of Object.keys(Cp)){const v=Cp[y],b=a.find(w=>w.name===v);b&&_(m.counters,v,b.startTime)}return _(m.counters,"visibilityHidden",i.visibilityHidden),_(m.attributes,"style",function(y){if(y)for(const v of y){const b=v.name.split("?")[0];if(yi(b)){const w=b.split("/").slice(-2);if(w.length===2)return`mapbox://styles/${w[0]}/${w[1]}`}}}(s)),_(m.attributes,"terrainEnabled",i.terrainEnabled?"true":"false"),_(m.attributes,"fogEnabled",i.fogEnabled?"true":"false"),_(m.attributes,"projection",i.projection),_(m.attributes,"zoom",i.zoom),_(m.metadata,"devicePixelRatio",p),_(m.metadata,"connectionEffectiveType",f?f.effectiveType:void 0),_(m.metadata,"navigatorUserAgent",S.navigator.userAgent),_(m.metadata,"screenWidth",S.screen.width),_(m.metadata,"screenHeight",S.screen.height),_(m.metadata,"windowWidth",S.innerWidth),_(m.metadata,"windowHeight",S.innerHeight),_(m.metadata,"mapWidth",i.width/p),_(m.metadata,"mapHeight",i.height/p),_(m.metadata,"webglRenderer",i.renderer),_(m.metadata,"webglVendor",i.vendor),_(m.metadata,"sdkVersion",D),_(m.metadata,"sdkIdentifier","mapbox-gl-js"),m}(r);for(const i of n.metadata);for(const i of n.counters);for(const i of n.attributes);this.postEvent(t,n,()=>{},e)}},FI=Mv.postPerformanceEvent.bind(Mv),Av=new class extends za{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(e,t,r,n){if(!B.API_URL||!B.SESSION_PATH)return;const i=Un(B.API_URL+B.SESSION_PATH);i.params.push(`sku=${t||""}`),i.params.push(`access_token=${n||B.ACCESS_TOKEN||""}`);const s={url:Gn(i),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(a,l){return Ct(Yt(a,{method:"GET"}),l)}(s,a=>{this.pendingRequest=null,r(a),this.saveEventData(),this.processRequests(n)})}getSessionAPI(e,t,r,n){this.skuToken=t,this.errorCb=n,B.SESSION_PATH&&B.API_URL&&(r||B.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},r):this.errorCb(new Error(ee)))}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||this.getSession(r,this.skuToken,n=>{n?this.errorCb(n):t&&(this.success[t]=!0)},e)}},BI=Av.getSessionAPI.bind(Av),Sp=new Set;function Pv(e,t){t?Sp.add(e):Sp.delete(e)}const Cp={create:"create",load:"load",fullLoad:"fullLoad"},Lv={mark(e){S.performance.mark(e)},measure(e,t,r){S.performance.measure(e,t,r)}};function VI(e){const t=e.name.split("?")[0];return vn(t)&&t.includes("mapbox-gl.js")?"javascript":vn(t)&&t.includes("mapbox-gl.css")?"css":function(r){return B.API_FONTS_REGEX.test(r)}(t)?"fontRange":po(t)?"sprite":yi(t)?"style":function(r){return B.API_TILEJSON_REGEX.test(r)}(t)?"tilejson":"other"}const UI=S.performance;function Dv(e){const t=e?e.url.toString():void 0;return UI.getEntriesByName(t)}var Rv=fm;function fm(e){return!function(t){return typeof window>"u"||typeof document>"u"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var n,i,s=new Blob([""],{type:"text/javascript"}),a=URL.createObjectURL(s);try{i=new Worker(a),n=!0}catch{n=!1}return i&&i.terminate(),URL.revokeObjectURL(a),n}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var n=document.createElement("canvas");n.width=n.height=1;var i=n.getContext("2d");if(!i)return!1;var s=i.getImageData(0,0,1,1);return s&&s.width===n.width}()?(dm[r=t&&t.failIfMajorPerformanceCaveat]===void 0&&(dm[r]=function(n){var i,s=function(a){var l=document.createElement("canvas"),p=Object.create(fm.webGLContextAttributes);return p.failIfMajorPerformanceCaveat=a,l.getContext("webgl",p)||l.getContext("experimental-webgl",p)}(n);if(!s)return!1;try{i=s.createShader(s.VERTEX_SHADER)}catch{return!1}return!(!i||s.isContextLost())&&(s.shaderSource(i,"void main() {}"),s.compileShader(i),s.getShaderParameter(i,s.COMPILE_STATUS)===!0)}(r)),dm[r]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var r}(e)}var dm={};let Mp,mm,Ap,Dl;fm.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const ge={now:()=>Ap!==void 0?Ap:S.performance.now(),setNow(e){Ap=e},restoreNow(){Ap=void 0},frame(e){const t=S.requestAnimationFrame(e);return{cancel:()=>S.cancelAnimationFrame(t)}},getImageData(e,t=0){const{width:r,height:n}=e;Dl||(Dl=S.document.createElement("canvas"));const i=Dl.getContext("2d",{willReadFrequently:!0});if(!i)throw new Error("failed to create canvas 2d context");return(r>Dl.width||n>Dl.height)&&(Dl.width=r,Dl.height=n),i.clearRect(-t,-t,r+2*t,n+2*t),i.drawImage(e,0,0,r,n),i.getImageData(-t,-t,r+2*t,n+2*t)},resolveURL:e=>(Mp||(Mp=S.document.createElement("a")),Mp.href=e,Mp.href),get devicePixelRatio(){return S.devicePixelRatio},get prefersReducedMotion(){return!!S.matchMedia&&(mm==null&&(mm=S.matchMedia("(prefers-reduced-motion: reduce)")),mm.matches)}};function vr(e,t,r){const n=S.document.createElement(e);return t!==void 0&&(n.className=t),r&&r.appendChild(n),n}function ra(e,t,r){const n=S.document.createElementNS("http://www.w3.org/2000/svg",e);for(const i of Object.keys(t))n.setAttributeNS(null,i,t[i]);return r&&r.appendChild(n),n}const Rl=S.document&&S.document.documentElement.style,qc=Rl&&Rl.userSelect!==void 0?"userSelect":"WebkitUserSelect";let Ov;function Nv(){Rl&&qc&&(Ov=Rl[qc],Rl[qc]="none")}function zv(){Rl&&qc&&(Rl[qc]=Ov)}function gm(e){e.preventDefault(),e.stopPropagation(),S.removeEventListener("click",gm,!0)}function _m(){S.addEventListener("click",gm,!0),S.setTimeout(()=>{S.removeEventListener("click",gm,!0)},0)}function Zc(e,t){const r=e.getBoundingClientRect();return Fv(e,r,t)}function Pp(e,t){const r=e.getBoundingClientRect(),n=[];for(let i=0;i<t.length;i++)n.push(Fv(e,r,t[i]));return n}function kv(e){return S.InstallTrigger!==void 0&&e.button===2&&e.ctrlKey&&S.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:e.button}function Fv(e,t,r){const n=e.offsetWidth===t.width?1:e.offsetWidth/t.width;return new H((r.clientX-t.left)*n,(r.clientY-t.top)*n)}function Bv(e,t,r){r[e]&&r[e].indexOf(t)!==-1||(r[e]=r[e]||[],r[e].push(t))}function ym(e,t,r){if(r&&r[e]){const n=r[e].indexOf(t);n!==-1&&r[e].splice(n,1)}}class wt{constructor(t,r={}){Yt(this,r),this.type=t}}class fe extends wt{constructor(t,r={}){super("error",Yt({error:t},r))}}class hn{on(t,r){return this._listeners=this._listeners||{},Bv(t,r,this._listeners),this}off(t,r){return ym(t,r,this._listeners),ym(t,r,this._oneTimeListeners),this}once(t,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},Bv(t,r,this._oneTimeListeners),this):new Promise(n=>this.once(t,n))}fire(t,r){typeof t=="string"&&(t=new wt(t,r||{}));const n=t.type;if(this.listens(n)){t.target=this;const i=this._listeners&&this._listeners[n]?this._listeners[n].slice():[];for(const l of i)l.call(this,t);const s=this._oneTimeListeners&&this._oneTimeListeners[n]?this._oneTimeListeners[n].slice():[];for(const l of s)ym(n,l,this._oneTimeListeners),l.call(this,t);const a=this._eventedParent;a&&(Yt(t,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),a.fire(t))}else t instanceof fe&&console.error(t.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,r){return this._eventedParent=t,this._eventedParentData=r,this}}var rt=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":{},"number":{},"boolean":{},"color":{}}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"transition":false,"expression":{"interpolated":false},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":{},"batched-model":{}}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"},"model-id":{"type":"string","property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]},"transition":false,"requires":[{"source":["geojson","vector"]}]}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":false},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","expression":{"interpolated":false},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":{},"orthographic":{}},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{},"globe":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["source"]}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"units":"intensity","expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["fill-extrusion-edge-radius"]},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["fill-extrusion-edge-radius"]},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","units":"meters","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","units":"meters","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"requires":["fill-extrusion-edge-radius"],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":false,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"transition":false,"requires":[{"source":"geojson","has":{"lineMetrics":true}}],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"units":"intensity","expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"units":"intensity","expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"units":"intensity","expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"units":"intensity","expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","transition":false,"expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","default":[0,1],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"units":"intensity","expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"units":"degrees","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":{},"location-indicator":{}},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"units":"number","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function na(e,...t){for(const r of t)for(const n in r)e[n]=r[n];return e}class Vt{constructor(t,r,n,i){this.message=(t?`${t}: `:"")+n,i&&(this.identifier=i),r!=null&&r.__line__&&(this.line=r.__line__)}}function jn(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function ia(e){if(Array.isArray(e))return e.map(ia);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const r in e)t[r]=ia(e[r]);return t}return jn(e)}class GI extends Error{constructor(t,r){super(r),this.message=r,this.key=t}}var Ps=GI;class vm{constructor(t,r=[]){this.parent=t,this.bindings={};for(const[n,i]of r)this.bindings[n]=i}concat(t){return new vm(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var jI=vm;const bu={kind:"null"},Ft={kind:"number"},Xe={kind:"string"},$e={kind:"boolean"},Oo={kind:"color"},wu={kind:"object"},We={kind:"value"},Lp={kind:"collator"},Xc={kind:"formatted"},Wc={kind:"resolvedImage"};function Xi(e,t){return{kind:"array",itemType:e,N:t}}function pn(e){if(e.kind==="array"){const t=pn(e.itemType);return typeof e.N=="number"?`array<${t}, ${e.N}>`:e.itemType.kind==="value"?"array":`array<${t}>`}return e.kind}const qI=[bu,Ft,Xe,$e,Oo,Xc,wu,Xi(We),Wc];function Hc(e,t){if(t.kind==="error")return null;if(e.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!Hc(e.itemType,t.itemType))&&(typeof e.N!="number"||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if(e.kind==="value"){for(const r of qI)if(!Hc(r,t))return null}}return`Expected ${pn(e)} but found ${pn(t)} instead.`}function xm(e,t){return t.some(r=>r.kind===e.kind)}function Yc(e,t){return t.some(r=>r==="null"?e===null:r==="array"?Array.isArray(e):r==="object"?e&&!Array.isArray(e)&&typeof e=="object":r===typeof e)}var bm,Vv={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Dp(e){return(e=Math.round(e))<0?0:e>255?255:e}function wm(e){return Dp(e[e.length-1]==="%"?parseFloat(e)/100*255:parseInt(e))}function Rp(e){return(t=e[e.length-1]==="%"?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t}function Em(e,t,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?e+(t-e)*r*6:2*r<1?t:3*r<2?e+(t-e)*(2/3-r)*6:e}try{bm={}.parseCSSColor=function(e){var t,r=e.replace(/ /g,"").toLowerCase();if(r in Vv)return Vv[r].slice();if(r[0]==="#")return r.length===4?(t=parseInt(r.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:r.length===7&&(t=parseInt(r.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var n=r.indexOf("("),i=r.indexOf(")");if(n!==-1&&i+1===r.length){var s=r.substr(0,n),a=r.substr(n+1,i-(n+1)).split(","),l=1;switch(s){case"rgba":if(a.length!==4)return null;l=Rp(a.pop());case"rgb":return a.length!==3?null:[wm(a[0]),wm(a[1]),wm(a[2]),l];case"hsla":if(a.length!==4)return null;l=Rp(a.pop());case"hsl":if(a.length!==3)return null;var p=(parseFloat(a[0])%360+360)%360/360,f=Rp(a[1]),m=Rp(a[2]),_=m<=.5?m*(f+1):m+f-m*f,y=2*m-_;return[Dp(255*Em(y,_,p+1/3)),Dp(255*Em(y,_,p)),Dp(255*Em(y,_,p-1/3)),l];default:return null}}return null}}catch{}class Wi{constructor(t,r,n,i=1){this.r=t,this.g=r,this.b=n,this.a=i}static parse(t){if(!t)return;if(t instanceof Wi)return t;if(typeof t!="string")return;const r=bm(t);return r?new Wi(r[0]/255*r[3],r[1]/255*r[3],r[2]/255*r[3],r[3]):void 0}toString(){const[t,r,n,i]=this.toArray();return`rgba(${Math.round(t)},${Math.round(r)},${Math.round(n)},${i})`}toArray(){const{r:t,g:r,b:n,a:i}=this;return i===0?[0,0,0,0]:[255*t/i,255*r/i,255*n/i,i]}toArray01(){const{r:t,g:r,b:n,a:i}=this;return i===0?[0,0,0,0]:[t/i,r/i,n/i,i]}toArray01Scaled(t){const{r,g:n,b:i,a:s}=this;return s===0?[0,0,0]:[r/s*t,n/s*t,i/s*t]}toArray01PremultipliedAlpha(){const{r:t,g:r,b:n,a:i}=this;return[t,r,n,i]}toArray01Linear(){const{r:t,g:r,b:n,a:i}=this;return i===0?[0,0,0,0]:[Math.pow(t/i,2.2),Math.pow(r/i,2.2),Math.pow(n/i,2.2),i]}}Wi.black=new Wi(0,0,0,1),Wi.white=new Wi(1,1,1,1),Wi.transparent=new Wi(0,0,0,0),Wi.red=new Wi(1,0,0,1),Wi.blue=new Wi(0,0,1,1);var Se=Wi;class Tm{constructor(t,r,n){this.sensitivity=t?r?"variant":"case":r?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,r){return this.collator.compare(t,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Im{constructor(t,r,n,i,s){this.text=t.normalize?t.normalize():t,this.image=r,this.scale=n,this.fontStack=i,this.textColor=s}}class Hi{constructor(t){this.sections=t}static fromString(t){return new Hi([new Im(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.namePrimary.length!==0)}static factory(t){return t instanceof Hi?t:Hi.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const r of this.sections){if(r.image){t.push(["image",r.image.namePrimary]);continue}t.push(r.text);const n={};r.fontStack&&(n["text-font"]=["literal",r.fontStack.split(",")]),r.scale&&(n["font-scale"]=r.scale),r.textColor&&(n["text-color"]=["rgba"].concat(r.textColor.toArray())),t.push(n)}return t}}class No{constructor(t){this.namePrimary=t.namePrimary,t.nameSecondary&&(this.nameSecondary=t.nameSecondary),this.available=t.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(t,r){return t?new No({namePrimary:t,nameSecondary:r,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function Uv(e,t,r,n){return typeof e=="number"&&e>=0&&e<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof r=="number"&&r>=0&&r<=255?n===void 0||typeof n=="number"&&n>=0&&n<=1?null:`Invalid rgba value [${[e,t,r,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof n=="number"?[e,t,r,n]:[e,t,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Eu(e){if(e===null||typeof e=="string"||typeof e=="boolean"||typeof e=="number"||e instanceof Se||e instanceof Tm||e instanceof Hi||e instanceof No)return!0;if(Array.isArray(e)){for(const t of e)if(!Eu(t))return!1;return!0}if(typeof e=="object"){for(const t in e)if(!Eu(e[t]))return!1;return!0}return!1}function Dn(e){if(e===null)return bu;if(typeof e=="string")return Xe;if(typeof e=="boolean")return $e;if(typeof e=="number")return Ft;if(e instanceof Se)return Oo;if(e instanceof Tm)return Lp;if(e instanceof Hi)return Xc;if(e instanceof No)return Wc;if(Array.isArray(e)){const t=e.length;let r;for(const n of e){const i=Dn(n);if(r){if(r===i)continue;r=We;break}r=i}return Xi(r||We,t)}return wu}function $c(e){const t=typeof e;return e===null?"":t==="string"||t==="number"||t==="boolean"?String(e):e instanceof Se||e instanceof Hi||e instanceof No?e.toString():JSON.stringify(e)}class Sm{constructor(t,r){this.type=t,this.value=r}static parse(t,r){if(t.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Eu(t[1]))return r.error("invalid value");const n=t[1];let i=Dn(n);const s=r.expectedType;return i.kind!=="array"||i.N!==0||!s||s.kind!=="array"||typeof s.N=="number"&&s.N!==0||(i=s),new Sm(i,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Se?["rgba"].concat(this.value.toArray()):this.value instanceof Hi?this.value.serialize():this.value}}var Kc=Sm,qn=class{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}};const Cm={string:Xe,number:Ft,boolean:$e,object:wu};class Mm{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");let n,i=1;const s=t[0];if(s==="array"){let l,p;if(t.length>2){const f=t[1];if(typeof f!="string"||!(f in Cm)||f==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);l=Cm[f],i++}else l=We;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return r.error('The length argument to "array" must be a positive integer literal',2);p=t[2],i++}n=Xi(l,p)}else n=Cm[s];const a=[];for(;i<t.length;i++){const l=r.parse(t[i],i,We);if(!l)return null;a.push(l)}return new Mm(n,a)}evaluate(t){for(let r=0;r<this.args.length;r++){const n=this.args[r].evaluate(t);if(!Hc(this.type,Dn(n)))return n;if(r===this.args.length-1)throw new qn(`Expected value to be of type ${pn(this.type)}, but found ${pn(Dn(n))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,r=[t.kind];if(t.kind==="array"){const n=t.itemType;if(n.kind==="string"||n.kind==="number"||n.kind==="boolean"){r.push(n.kind);const i=t.N;(typeof i=="number"||this.args.length>1)&&r.push(i)}}return r.concat(this.args.map(n=>n.serialize()))}}var oa=Mm;class Jc{constructor(t){this.type=Xc,this.sections=t}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const n=t[1];if(!Array.isArray(n)&&typeof n=="object")return r.error("First argument must be an image or text section.");const i=[];let s=!1;for(let a=1;a<=t.length-1;++a){const l=t[a];if(s&&typeof l=="object"&&!Array.isArray(l)){s=!1;let p=null;if(l["font-scale"]&&(p=r.parse(l["font-scale"],1,Ft),!p))return null;let f=null;if(l["text-font"]&&(f=r.parse(l["text-font"],1,Xi(Xe)),!f))return null;let m=null;if(l["text-color"]&&(m=r.parse(l["text-color"],1,Oo),!m))return null;const _=i[i.length-1];_.scale=p,_.font=f,_.textColor=m}else{const p=r.parse(t[a],1,We);if(!p)return null;const f=p.type.kind;if(f!=="string"&&f!=="value"&&f!=="null"&&f!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");s=!0,i.push({content:p,scale:null,font:null,textColor:null})}}return new Jc(i)}evaluate(t){return new Hi(this.sections.map(r=>{const n=r.content.evaluate(t);return Dn(n)===Wc?new Im("",n,null,null,null):new Im($c(n),null,r.scale?r.scale.evaluate(t):null,r.font?r.font.evaluate(t).join(","):null,r.textColor?r.textColor.evaluate(t):null)}))}eachChild(t){for(const r of this.sections)t(r.content),r.scale&&t(r.scale),r.font&&t(r.font),r.textColor&&t(r.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const r of this.sections){t.push(r.content.serialize());const n={};r.scale&&(n["font-scale"]=r.scale.serialize()),r.font&&(n["text-font"]=r.font.serialize()),r.textColor&&(n["text-color"]=r.textColor.serialize()),t.push(n)}return t}}class Qc{constructor(t,r){this.type=Wc,this.inputPrimary=t,this.inputSecondary=r}static parse(t,r){if(t.length<2)return r.error("Expected two or more arguments.");const n=r.parse(t[1],1,Xe);if(!n)return r.error("No image name provided.");if(t.length===2)return new Qc(n);const i=r.parse(t[2],1,Xe);return i?new Qc(n,i):r.error("Secondary image variant is not a string.")}evaluate(t){const r=No.fromString(this.inputPrimary.evaluate(t),this.inputSecondary?this.inputSecondary.evaluate(t):void 0);return r&&t.availableImages&&(r.available=t.availableImages.indexOf(r.namePrimary)>-1,r.nameSecondary&&r.available&&t.availableImages&&(r.available=t.availableImages.indexOf(r.nameSecondary)>-1)),r}eachChild(t){t(this.inputPrimary),this.inputSecondary&&t(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function or(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":e===null?"null":typeof e}const ZI={"to-boolean":$e,"to-color":Oo,"to-number":Ft,"to-string":Xe};class Am{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const n=t[0],i=[];let s=bu;if(n==="to-array"){if(!Array.isArray(t[1]))return null;const a=t[1].length;if(r.expectedType){if(r.expectedType.kind!=="array")return r.error(`Expected ${r.expectedType.kind} but found array.`);s=Xi(r.expectedType.itemType,a)}else{if(!(a>0&&Eu(t[1][0])))return null;s=Xi(Dn(t[1][0]),a)}for(let l=0;l<a;l++){const p=t[1][l];let f;if(or(p)==="array")f=r.parse(p,void 0,s.itemType);else{const m=or(p);if(m!==s.itemType.kind)return r.error(`Expected ${s.itemType.kind} but found ${m}.`);f=r.registry.literal.parse(["literal",p===void 0?null:p],r)}if(!f)return null;i.push(f)}}else{if((n==="to-boolean"||n==="to-string")&&t.length!==2)return r.error("Expected one argument.");s=ZI[n];for(let a=1;a<t.length;a++){const l=r.parse(t[a],a,We);if(!l)return null;i.push(l)}}return new Am(s,i)}evaluate(t){if(this.type.kind==="boolean")return!!this.args[0].evaluate(t);if(this.type.kind==="color"){let r,n;for(const i of this.args){if(r=i.evaluate(t),n=null,r instanceof Se)return r;if(typeof r=="string"){const s=t.parseColor(r);if(s)return s}else if(Array.isArray(r)&&(n=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:Uv(r[0],r[1],r[2],r[3]),!n))return new Se(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new qn(n||`Could not parse color from value '${typeof r=="string"?r:String(JSON.stringify(r))}'`)}if(this.type.kind==="number"){let r=null;for(const n of this.args){if(r=n.evaluate(t),r===null)return 0;const i=Number(r);if(!isNaN(i))return i}throw new qn(`Could not convert ${JSON.stringify(r)} to number.`)}return this.type.kind==="formatted"?Hi.fromString($c(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?No.fromString($c(this.args[0].evaluate(t))):this.type.kind==="array"?this.args.map(r=>r.evaluate(t)):$c(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Jc([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Qc(this.args[0]).serialize();const t=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(r=>{t.push(r.serialize())}),t}}var Ol=Am;const XI=["Unknown","Point","LineString","Polygon"];var Gv=class{constructor(e){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.options=e}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?XI[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:r,y:n}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(r*t-e[0])+this.featureDistanceData.bearing[1]*(n*t-e[1])}return 0}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=Se.parse(e)),t}getConfig(e){return this.options?this.options.get(e):null}};class Tu{constructor(t,r,n,i){this.name=t,this.type=r,this._evaluate=n,this.args=i}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,r){const n=t[0],i=Tu.definitions[n];if(!i)return r.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const s=Array.isArray(i)?i[0]:i.type,a=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,l=a.filter(([f])=>!Array.isArray(f)||f.length===t.length-1);let p=null;for(const[f,m]of l){p=new o0(r.registry,r.path,null,r.scope,void 0,r.options);const _=[];let y=!1;for(let v=1;v<t.length;v++){const b=t[v],w=Array.isArray(f)?f[v-1]:f.type,E=p.parse(b,1+_.length,w);if(!E){y=!0;break}_.push(E)}if(!y)if(Array.isArray(f)&&f.length!==_.length)p.error(`Expected ${f.length} arguments, but found ${_.length} instead.`);else{for(let v=0;v<_.length;v++){const b=Array.isArray(f)?f[v]:f.type,w=_[v];p.concat(v+1).checkSubtype(b,w.type)}if(p.errors.length===0)return new Tu(n,s,m,_)}}if(l.length===1)r.errors.push(...p.errors);else{const f=(l.length?l:a).map(([_])=>{return y=_,Array.isArray(y)?`(${y.map(pn).join(", ")})`:`(${pn(y.type)}...)`;var y}).join(" | "),m=[];for(let _=1;_<t.length;_++){const y=r.parse(t[_],1+m.length);if(!y)return null;m.push(pn(y.type))}r.error(`Expected arguments of type ${f}, but found (${m.join(", ")}) instead.`)}return null}static register(t,r){Tu.definitions=r;for(const n in r)t[n]=Tu}}var Ls=Tu;class Op{constructor(t,r,n){this.type=Lp,this.locale=n,this.caseSensitive=t,this.diacriticSensitive=r}static parse(t,r){if(t.length!==2)return r.error("Expected one argument.");const n=t[1];if(typeof n!="object"||Array.isArray(n))return r.error("Collator options argument must be an object.");const i=r.parse(n["case-sensitive"]!==void 0&&n["case-sensitive"],1,$e);if(!i)return null;const s=r.parse(n["diacritic-sensitive"]!==void 0&&n["diacritic-sensitive"],1,$e);if(!s)return null;let a=null;return n.locale&&(a=r.parse(n.locale,1,Xe),!a)?null:new Op(i,s,a)}evaluate(t){return new Tm(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}var jv={exports:{}};jv.exports=function(){function e(n,i,s,a,l){for(;a>s;){if(a-s>600){var p=a-s+1,f=i-s+1,m=Math.log(p),_=.5*Math.exp(2*m/3),y=.5*Math.sqrt(m*_*(p-_)/p)*(f-p/2<0?-1:1);e(n,i,Math.max(s,Math.floor(i-f*_/p+y)),Math.min(a,Math.floor(i+(p-f)*_/p+y)),l)}var v=n[i],b=s,w=a;for(t(n,s,i),l(n[a],v)>0&&t(n,s,a);b<w;){for(t(n,b,w),b++,w--;l(n[b],v)<0;)b++;for(;l(n[w],v)>0;)w--}l(n[s],v)===0?t(n,s,w):t(n,++w,a),w<=i&&(s=w+1),i<=w&&(a=w-1)}}function t(n,i,s){var a=n[i];n[i]=n[s],n[s]=a}function r(n,i){return n<i?-1:n>i?1:0}return function(n,i,s,a,l){e(n,i,s||0,a||n.length-1,l||r)}}();var WI=Nt(jv.exports);function HI(e){let t=0;for(let r,n,i=0,s=e.length,a=s-1;i<s;a=i++)r=e[i],n=e[a],t+=(n.x-r.x)*(r.y+n.y);return t}function th(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function eh(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function YI(e,t,r){const n=e[0]-t[0],i=e[1]-t[1],s=e[0]-r[0],a=e[1]-r[1];return n*a-s*i==0&&n*s<=0&&i*a<=0}function Iu(e,t,r=!1){let n=!1;for(let l=0,p=t.length;l<p;l++){const f=t[l];for(let m=0,_=f.length,y=_-1;m<_;y=m++){const v=f[y],b=f[m];if(YI(e,v,b))return r;(s=v)[1]>(i=e)[1]!=(a=b)[1]>i[1]&&i[0]<(a[0]-s[0])*(i[1]-s[1])/(a[1]-s[1])+s[0]&&(n=!n)}}var i,s,a;return n}function qv(e,t,r,n){const i=n[0]-r[0],s=n[1]-r[1],a=(e[0]-r[0])*s-i*(e[1]-r[1]),l=(t[0]-r[0])*s-i*(t[1]-r[1]);return a>0&&l<0||a<0&&l>0}function Np(e,t,r,n){return(i=[n[0]-r[0],n[1]-r[1]])[0]*(s=[t[0]-e[0],t[1]-e[1]])[1]-i[1]*s[0]!=0&&!(!qv(e,t,r,n)||!qv(r,n,e,t));var i,s}const ka=8192;function $I(e,t){const r=(180+e[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,i=Math.pow(2,t.z);return[Math.round(r*i*ka),Math.round(n*i*ka)]}function KI(e,t){for(let r=0;r<t.length;r++)if(Iu(e,t[r]))return!0;return!1}function JI(e,t,r){for(const n of r)for(let i=0,s=n.length,a=s-1;i<s;a=i++)if(Np(e,t,n[a],n[i]))return!0;return!1}function Zv(e,t){for(let r=0;r<e.length;++r)if(!Iu(e[r],t))return!1;for(let r=0;r<e.length-1;++r)if(JI(e[r],e[r+1],t))return!1;return!0}function QI(e,t){for(let r=0;r<t.length;r++)if(Zv(e,t[r]))return!0;return!1}function Pm(e,t,r){const n=[];for(let i=0;i<e.length;i++){const s=[];for(let a=0;a<e[i].length;a++){const l=$I(e[i][a],r);th(t,l),s.push(l)}n.push(s)}return n}function Xv(e,t,r){const n=[];for(let i=0;i<e.length;i++){const s=Pm(e[i],t,r);n.push(s)}return n}function Wv(e,t,r,n){if(e[0]<r[0]||e[0]>r[2]){const i=.5*n;let s=e[0]-r[0]>i?-n:r[0]-e[0]>i?n:0;s===0&&(s=e[0]-r[2]>i?-n:r[2]-e[0]>i?n:0),e[0]+=s}th(t,e)}function Hv(e,t,r,n){const i=Math.pow(2,n.z)*ka,s=[n.x*ka,n.y*ka],a=[];if(!e)return a;for(const l of e)for(const p of l){const f=[p.x+s[0],p.y+s[1]];Wv(f,t,r,i),a.push(f)}return a}function Yv(e,t,r,n){const i=Math.pow(2,n.z)*ka,s=[n.x*ka,n.y*ka],a=[];if(!e)return a;for(const p of e){const f=[];for(const m of p){const _=[m.x+s[0],m.y+s[1]];th(t,_),f.push(_)}a.push(f)}if(t[2]-t[0]<=i/2){(l=t)[0]=l[1]=1/0,l[2]=l[3]=-1/0;for(const p of a)for(const f of p)Wv(f,t,r,i)}var l;return a}class rh{constructor(t,r){this.type=$e,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Eu(t[1])){const n=t[1];if(n.type==="FeatureCollection")for(let i=0;i<n.features.length;++i){const s=n.features[i].geometry.type;if(s==="Polygon"||s==="MultiPolygon")return new rh(n,n.features[i].geometry)}else if(n.type==="Feature"){const i=n.geometry.type;if(i==="Polygon"||i==="MultiPolygon")return new rh(n,n.geometry)}else if(n.type==="Polygon"||n.type==="MultiPolygon")return new rh(n,n)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(r,n){const i=[1/0,1/0,-1/0,-1/0],s=[1/0,1/0,-1/0,-1/0],a=r.canonicalID();if(!a)return!1;if(n.type==="Polygon"){const l=Pm(n.coordinates,s,a),p=Hv(r.geometry(),i,s,a);if(!eh(i,s))return!1;for(const f of p)if(!Iu(f,l))return!1}if(n.type==="MultiPolygon"){const l=Xv(n.coordinates,s,a),p=Hv(r.geometry(),i,s,a);if(!eh(i,s))return!1;for(const f of p)if(!KI(f,l))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(r,n){const i=[1/0,1/0,-1/0,-1/0],s=[1/0,1/0,-1/0,-1/0],a=r.canonicalID();if(!a)return!1;if(n.type==="Polygon"){const l=Pm(n.coordinates,s,a),p=Yv(r.geometry(),i,s,a);if(!eh(i,s))return!1;for(const f of p)if(!Zv(f,l))return!1}if(n.type==="MultiPolygon"){const l=Xv(n.coordinates,s,a),p=Yv(r.geometry(),i,s,a);if(!eh(i,s))return!1;for(const f of p)if(!QI(f,l))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Lm=rh,$v={exports:{}};$v.exports=function(){var e={kilometers:1,miles:.621371192237334,nauticalmiles:.5399568034557235,meters:1e3,metres:1e3,yards:1093.6132983377079,feet:3280.839895013123,inches:39370.078740157485},t=1/298.257223563,r=t*(2-t),n=Math.PI/180,i=function(f,m){if(f===void 0)throw new Error("No latitude given.");if(m&&!e[m])throw new Error("Unknown unit "+m+". Use one of: "+Object.keys(e).join(", "));var _=6378.137*n*(m?e[m]:1),y=Math.cos(f*n),v=1/(1-r*(1-y*y)),b=Math.sqrt(v);this.kx=_*b*y,this.ky=_*b*v*(1-r)},s={units:{configurable:!0}};function a(f,m){return f[0]===m[0]&&f[1]===m[1]}function l(f,m,_){var y=p(m[0]-f[0]);return[f[0]+y*_,f[1]+(m[1]-f[1])*_]}function p(f){for(;f<-180;)f+=360;for(;f>180;)f-=360;return f}return i.fromTile=function(f,m,_){var y=Math.PI*(1-2*(f+.5)/Math.pow(2,m)),v=Math.atan(.5*(Math.exp(y)-Math.exp(-y)))/n;return new i(v,_)},s.units.get=function(){return e},i.prototype.distance=function(f,m){var _=p(f[0]-m[0])*this.kx,y=(f[1]-m[1])*this.ky;return Math.sqrt(_*_+y*y)},i.prototype.bearing=function(f,m){var _=p(m[0]-f[0])*this.kx;return Math.atan2(_,(m[1]-f[1])*this.ky)/n},i.prototype.destination=function(f,m,_){var y=_*n;return this.offset(f,Math.sin(y)*m,Math.cos(y)*m)},i.prototype.offset=function(f,m,_){return[f[0]+m/this.kx,f[1]+_/this.ky]},i.prototype.lineDistance=function(f){for(var m=0,_=0;_<f.length-1;_++)m+=this.distance(f[_],f[_+1]);return m},i.prototype.area=function(f){for(var m=0,_=0;_<f.length;_++)for(var y=f[_],v=0,b=y.length,w=b-1;v<b;w=v++)m+=p(y[v][0]-y[w][0])*(y[v][1]+y[w][1])*(_?-1:1);return Math.abs(m)/2*this.kx*this.ky},i.prototype.along=function(f,m){var _=0;if(m<=0)return f[0];for(var y=0;y<f.length-1;y++){var v=f[y],b=f[y+1],w=this.distance(v,b);if((_+=w)>m)return l(v,b,(m-(_-w))/w)}return f[f.length-1]},i.prototype.pointToSegmentDistance=function(f,m,_){var y=m[0],v=m[1],b=p(_[0]-y)*this.kx,w=(_[1]-v)*this.ky,E=0;return b===0&&w===0||((E=(p(f[0]-y)*this.kx*b+(f[1]-v)*this.ky*w)/(b*b+w*w))>1?(y=_[0],v=_[1]):E>0&&(y+=b/this.kx*E,v+=w/this.ky*E)),b=p(f[0]-y)*this.kx,w=(f[1]-v)*this.ky,Math.sqrt(b*b+w*w)},i.prototype.pointOnLine=function(f,m){for(var _,y,v,b,w=1/0,E=0;E<f.length-1;E++){var T=f[E][0],C=f[E][1],M=p(f[E+1][0]-T)*this.kx,A=(f[E+1][1]-C)*this.ky,P=0;M===0&&A===0||((P=(p(m[0]-T)*this.kx*M+(m[1]-C)*this.ky*A)/(M*M+A*A))>1?(T=f[E+1][0],C=f[E+1][1]):P>0&&(T+=M/this.kx*P,C+=A/this.ky*P));var L=(M=p(m[0]-T)*this.kx)*M+(A=(m[1]-C)*this.ky)*A;L<w&&(w=L,_=T,y=C,v=E,b=P)}return{point:[_,y],index:v,t:Math.max(0,Math.min(1,b))}},i.prototype.lineSlice=function(f,m,_){var y=this.pointOnLine(_,f),v=this.pointOnLine(_,m);if(y.index>v.index||y.index===v.index&&y.t>v.t){var b=y;y=v,v=b}var w=[y.point],E=y.index+1,T=v.index;!a(_[E],w[0])&&E<=T&&w.push(_[E]);for(var C=E+1;C<=T;C++)w.push(_[C]);return a(_[T],v.point)||w.push(v.point),w},i.prototype.lineSliceAlong=function(f,m,_){for(var y=0,v=[],b=0;b<_.length-1;b++){var w=_[b],E=_[b+1],T=this.distance(w,E);if((y+=T)>f&&v.length===0&&v.push(l(w,E,(f-(y-T))/T)),y>=m)return v.push(l(w,E,(m-(y-T))/T)),v;y>f&&v.push(E)}return v},i.prototype.bufferPoint=function(f,m){var _=m/this.ky,y=m/this.kx;return[f[0]-y,f[1]-_,f[0]+y,f[1]+_]},i.prototype.bufferBBox=function(f,m){var _=m/this.ky,y=m/this.kx;return[f[0]-y,f[1]-_,f[2]+y,f[3]+_]},i.prototype.insideBBox=function(f,m){return p(f[0]-m[0])>=0&&p(f[0]-m[2])<=0&&f[1]>=m[1]&&f[1]<=m[3]},Object.defineProperties(i,s),i}();var Dm=Nt($v.exports),Kv={exports:{}};Kv.exports=function(){var e=function(r,n){if(r===void 0&&(r=[]),n===void 0&&(n=t),this.data=r,this.length=this.data.length,this.compare=n,this.length>0)for(var i=(this.length>>1)-1;i>=0;i--)this._down(i)};function t(r,n){return r<n?-1:r>n?1:0}return e.prototype.push=function(r){this.data.push(r),this.length++,this._up(this.length-1)},e.prototype.pop=function(){if(this.length!==0){var r=this.data[0],n=this.data.pop();return this.length--,this.length>0&&(this.data[0]=n,this._down(0)),r}},e.prototype.peek=function(){return this.data[0]},e.prototype._up=function(r){for(var n=this.data,i=this.compare,s=n[r];r>0;){var a=r-1>>1,l=n[a];if(i(s,l)>=0)break;n[r]=l,r=a}n[r]=s},e.prototype._down=function(r){for(var n=this.data,i=this.compare,s=this.length>>1,a=n[r];r<s;){var l=1+(r<<1),p=n[l],f=l+1;if(f<this.length&&i(n[f],p)<0&&(l=f,p=n[f]),i(p,a)>=0)break;n[r]=p,r=l}n[r]=a},e}();var Rm=Nt(Kv.exports),lt=8192;function Jv(e,t){return t.dist-e.dist}const Om=100,Nm=50;function Qv(e){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}function zp(e){return e[1]-e[0]+1}function sa(e,t){const r=e[1]>=e[0]&&e[1]<t;return r||console.warn("Distance Expression: Index is out of range"),r}function zm(e,t){if(e[0]>e[1])return[null,null];const r=zp(e);if(t){if(r===2)return[e,null];const n=Math.floor(r/2);return[[e[0],e[0]+n],[e[0]+n,e[1]]]}{if(r===1)return[e,null];const n=Math.floor(r/2)-1;return[[e[0],e[0]+n],[e[0]+n+1,e[1]]]}}function Nl(e,t){const r=[1/0,1/0,-1/0,-1/0];if(!sa(t,e.length))return r;for(let n=t[0];n<=t[1];++n)th(r,e[n]);return r}function kp(e){const t=[1/0,1/0,-1/0,-1/0];for(let r=0;r<e.length;++r)for(let n=0;n<e[r].length;++n)th(t,e[r][n]);return t}function Su(e,t,r){if(Qv(e)||Qv(t))return NaN;let n=0,i=0;return e[2]<t[0]&&(n=t[0]-e[2]),e[0]>t[2]&&(n=e[0]-t[2]),e[1]>t[3]&&(i=e[1]-t[3]),e[3]<t[1]&&(i=t[1]-e[3]),r.distance([0,0],[n,i])}function km(e,t){const r=Math.pow(2,t.z);return[(i=(e.x/lt+t.x)/r,360*i-180),(n=(e.y/lt+t.y)/r,360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90)];var n,i}function tS(e,t){const r=[];for(let n=0;n<e.length;++n)r.push(km(e[n],t));return r}function t0(e,t,r){const n=r.pointOnLine(t,e).point;return r.distance(e,n)}function e0(e,t,r,n,i){const s=r.slice(n[0],n[1]+1);let a=1/0;for(let l=t[0];l<=t[1];++l)if((a=Math.min(a,t0(e[l],s,i)))===0)return 0;return a}function Fm(e,t,r,n,i){const s=Math.min(i.pointToSegmentDistance(e,r,n),i.pointToSegmentDistance(t,r,n)),a=Math.min(i.pointToSegmentDistance(r,e,t),i.pointToSegmentDistance(n,e,t));return Math.min(s,a)}function eS(e,t,r,n,i){if(!sa(t,e.length)||!sa(n,r.length))return NaN;let s=1/0;for(let a=t[0];a<t[1];++a)for(let l=n[0];l<n[1];++l){if(Np(e[a],e[a+1],r[l],r[l+1]))return 0;s=Math.min(s,Fm(e[a],e[a+1],r[l],r[l+1],i))}return s}function rS(e,t,r,n,i){if(!sa(t,e.length)||!sa(n,r.length))return NaN;let s=1/0;for(let a=t[0];a<=t[1];++a)for(let l=n[0];l<=n[1];++l)if((s=Math.min(s,i.distance(e[a],r[l])))===0)return s;return s}function nS(e,t,r){if(Iu(e,t,!0))return 0;let n=1/0;for(const i of t){const s=i.length;if(s<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(i[0]!==i[s-1]&&(n=Math.min(n,r.pointToSegmentDistance(e,i[s-1],i[0])))===0||(n=Math.min(n,t0(e,i,r)))===0)return n}return n}function iS(e,t,r,n){if(!sa(t,e.length))return NaN;for(let s=t[0];s<=t[1];++s)if(Iu(e[s],r,!0))return 0;let i=1/0;for(let s=t[0];s<t[1];++s)for(const a of r)for(let l=0,p=a.length,f=p-1;l<p;f=l++){if(Np(e[s],e[s+1],a[f],a[l]))return 0;i=Math.min(i,Fm(e[s],e[s+1],a[f],a[l],n))}return i}function r0(e,t){for(const r of e)for(let n=0;n<=r.length-1;++n)if(Iu(r[n],t,!0))return!0;return!1}function oS(e,t,r,n=1/0){const i=kp(e),s=kp(t);if(n!==1/0&&Su(i,s,r)>=n)return n;if(eh(i,s)){if(r0(e,t))return 0}else if(r0(t,e))return 0;let a=n;for(const l of e)for(let p=0,f=l.length,m=f-1;p<f;m=p++)for(const _ of t)for(let y=0,v=_.length,b=v-1;y<v;b=y++){if(Np(l[m],l[p],_[b],_[y]))return 0;a=Math.min(a,Fm(l[m],l[p],_[b],_[y],r))}return a}function Fp(e,t,r,n,i,s,a){if(s===null||a===null)return;const l=Su(Nl(n,s),Nl(i,a),r);l<t&&e.push({dist:l,range1:s,range2:a})}function sS(e,t,r,n,i=1/0){let s=Math.min(n.distance(e[0],r[0][0]),i);if(s===0)return s;const a=new Rm([{dist:0,range1:[0,e.length-1],range2:[0,0]}],Jv),l=t?Nm:Om,p=kp(r);for(;a.length;){const f=a.pop();if(f.dist>=s)continue;const m=f.range1;if(zp(m)<=l){if(!sa(m,e.length))return NaN;if(t){const _=iS(e,m,r,n);if((s=Math.min(s,_))===0)return s}else for(let _=m[0];_<=m[1];++_){const y=nS(e[_],r,n);if((s=Math.min(s,y))===0)return s}}else{const _=zm(m,t);if(_[0]!==null){const y=Su(Nl(e,_[0]),p,n);y<s&&a.push({dist:y,range1:_[0],range2:[0,0]})}if(_[1]!==null){const y=Su(Nl(e,_[1]),p,n);y<s&&a.push({dist:y,range1:_[1],range2:[0,0]})}}}return s}function n0(e,t,r,n,i,s=1/0){let a=Math.min(s,i.distance(e[0],r[0]));if(a===0)return a;const l=new Rm([{dist:0,range1:[0,e.length-1],range2:[0,r.length-1]}],Jv),p=t?Nm:Om,f=n?Nm:Om;for(;l.length;){const m=l.pop();if(m.dist>=a)continue;const _=m.range1,y=m.range2;if(zp(_)<=p&&zp(y)<=f){if(!sa(_,e.length)||!sa(y,r.length))return NaN;if(t&&n?a=Math.min(a,eS(e,_,r,y,i)):t||n?t&&!n?a=Math.min(a,e0(r,y,e,_,i)):!t&&n&&(a=Math.min(a,e0(e,_,r,y,i))):a=Math.min(a,rS(e,_,r,y,i)),a===0)return a}else{const v=zm(_,t),b=zm(y,n);Fp(l,a,i,e,r,v[0],b[0]),Fp(l,a,i,e,r,v[0],b[1]),Fp(l,a,i,e,r,v[1],b[0]),Fp(l,a,i,e,r,v[1],b[1])}}return a}function Bm(e,t,r,n,i=1/0){let s=i;const a=Nl(e,[0,e.length-1]);for(const l of r)if(!(s!==1/0&&Su(a,Nl(l,[0,l.length-1]),n)>=s)&&(s=Math.min(s,n0(e,t,l,!0,n,s)),s===0))return s;return s}function Bp(e,t,r,n,i=1/0){let s=i;const a=Nl(e,[0,e.length-1]);for(const l of r){if(s!==1/0&&Su(a,kp(l),n)>=s)continue;const p=sS(e,t,l,n,s);if(isNaN(p))return p;if((s=Math.min(s,p))===0)return s}return s}function Vm(e){return e==="Point"||e==="MultiPoint"||e==="LineString"||e==="MultiLineString"||e==="Polygon"||e==="MultiPolygon"}class nh{constructor(t,r){this.type=Ft,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'distance' expression requires either one argument, but found ' ${t.length-1} instead.`);if(Eu(t[1])){const n=t[1];if(n.type==="FeatureCollection"){for(let i=0;i<n.features.length;++i)if(Vm(n.features[i].geometry.type))return new nh(n,n.features[i].geometry)}else if(n.type==="Feature"){if(Vm(n.geometry.type))return new nh(n,n.geometry)}else if(Vm(n.type))return new nh(n,n)}return r.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(t){const r=t.geometry(),n=t.canonicalID();if(r!=null&&n!=null){if(t.geometryType()==="Point")return function(i,s,a){const l=[];for(const f of i)for(const m of f)l.push(km(m,s));const p=new Dm(l[0][1],"meters");return a.type==="Point"||a.type==="MultiPoint"||a.type==="LineString"?n0(l,!1,a.type==="Point"?[a.coordinates]:a.coordinates,a.type==="LineString",p):a.type==="MultiLineString"?Bm(l,!1,a.coordinates,p):a.type==="Polygon"||a.type==="MultiPolygon"?Bp(l,!1,a.type==="Polygon"?[a.coordinates]:a.coordinates,p):null}(r,n,this.geometries);if(t.geometryType()==="LineString")return function(i,s,a){const l=[];for(const f of i){const m=[];for(const _ of f)m.push(km(_,s));l.push(m)}const p=new Dm(l[0][0][1],"meters");if(a.type==="Point"||a.type==="MultiPoint"||a.type==="LineString")return Bm(a.type==="Point"?[a.coordinates]:a.coordinates,a.type==="LineString",l,p);if(a.type==="MultiLineString"){let f=1/0;for(let m=0;m<a.coordinates.length;m++){const _=Bm(a.coordinates[m],!0,l,p,f);if(isNaN(_))return _;if((f=Math.min(f,_))===0)return f}return f}if(a.type==="Polygon"||a.type==="MultiPolygon"){let f=1/0;for(let m=0;m<l.length;m++){const _=Bp(l[m],!0,a.type==="Polygon"?[a.coordinates]:a.coordinates,p,f);if(isNaN(_))return _;if((f=Math.min(f,_))===0)return f}return f}return null}(r,n,this.geometries);if(t.geometryType()==="Polygon")return function(i,s,a){const l=[];for(const f of function(m,_){const y=m.length;if(y<=1)return[m];const v=[];let b,w;for(let E=0;E<y;E++){const T=HI(m[E]);T!==0&&(m[E].area=Math.abs(T),w===void 0&&(w=T<0),w===T<0?(b&&v.push(b),b=[m[E]]):b.push(m[E]))}return b&&v.push(b),v}(i)){const m=[];for(let _=0;_<f.length;++_)m.push(tS(f[_],s));l.push(m)}const p=new Dm(l[0][0][0][1],"meters");if(a.type==="Point"||a.type==="MultiPoint"||a.type==="LineString")return Bp(a.type==="Point"?[a.coordinates]:a.coordinates,a.type==="LineString",l,p);if(a.type==="MultiLineString"){let f=1/0;for(let m=0;m<a.coordinates.length;m++){const _=Bp(a.coordinates[m],!0,l,p,f);if(isNaN(_))return _;if((f=Math.min(f,_))===0)return f}return f}return a.type==="Polygon"||a.type==="MultiPolygon"?function(f,m,_){let y=1/0;for(const v of f)for(const b of m){const w=oS(v,b,_,y);if(isNaN(w))return w;if((y=Math.min(y,w))===0)return y}return y}(a.type==="Polygon"?[a.coordinates]:a.coordinates,l,p):null}(r,n,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var Um=nh;function ih(e){if(e instanceof Ls&&(e.name==="get"&&e.args.length===1||e.name==="feature-state"||e.name==="has"&&e.args.length===1||e.name==="properties"||e.name==="geometry-type"||e.name==="id"||/^filter-/.test(e.name))||e instanceof Lm||e instanceof Um)return!1;let t=!0;return e.eachChild(r=>{t&&!ih(r)&&(t=!1)}),t}function Vp(e){if(e instanceof Ls&&e.name==="feature-state")return!1;let t=!0;return e.eachChild(r=>{t&&!Vp(r)&&(t=!1)}),t}function Gm(e){if(e instanceof Ls&&e.name==="config")return!1;let t=!0;return e.eachChild(r=>{t&&!Gm(r)&&(t=!1)}),t}function zl(e,t){if(e instanceof Ls&&t.indexOf(e.name)>=0)return!1;let r=!0;return e.eachChild(n=>{r&&!zl(n,t)&&(r=!1)}),r}class jm{constructor(t,r){this.type=r.type,this.name=t,this.boundExpression=r}static parse(t,r){if(t.length!==2||typeof t[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const n=t[1];return r.scope.has(n)?new jm(n,r.scope.get(n)):r.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var i0=jm;class qm{constructor(t,r=[],n,i=new jI,s=[],a){this.registry=t,this.path=r,this.key=r.map(l=>`[${l}]`).join(""),this.scope=i,this.errors=s,this.expectedType=n,this.options=a}parse(t,r,n,i,s={}){return r||n?this.concat(r,n,i)._parse(t,s):this._parse(t,s)}_parse(t,r){function n(i,s,a){return a==="assert"?new oa(s,[i]):a==="coerce"?new Ol(s,[i]):i}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=typeof t[0]=="string"?this.registry[t[0]]:void 0;if(i){let s=i.parse(t,this);if(!s)return null;if(this.expectedType){const a=this.expectedType,l=s.type;if(a.kind!=="string"&&a.kind!=="number"&&a.kind!=="boolean"&&a.kind!=="object"&&a.kind!=="array"||l.kind!=="value")if(a.kind!=="color"&&a.kind!=="formatted"&&a.kind!=="resolvedImage"||l.kind!=="value"&&l.kind!=="string"){if(this.checkSubtype(a,l))return null}else s=n(s,a,r.typeAnnotation||"coerce");else s=n(s,a,r.typeAnnotation||"assert")}if(!(s instanceof Kc)&&s.type.kind!=="resolvedImage"&&Zm(s)){const a=new Gv(this.options);try{s=new Kc(s.type,s.evaluate(a))}catch(l){return this.error(l.message),null}}return s}return Ol.parse(["to-array",t],this)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,r,n){const i=typeof t=="number"?this.path.concat(t):this.path,s=n?this.scope.concat(n):this.scope;return new qm(this.registry,i,r||null,s,this.errors,this.options)}error(t,...r){const n=`${this.key}${r.map(i=>`[${i}]`).join("")}`;this.errors.push(new Ps(n,t))}checkSubtype(t,r){const n=Hc(t,r);return n&&this.error(n),n}}var o0=qm;function Zm(e){if(e instanceof i0)return Zm(e.boundExpression);if(e instanceof Ls&&e.name==="error"||e instanceof Ls&&e.name==="config"||e instanceof Op||e instanceof Lm||e instanceof Um)return!1;const t=e instanceof Ol||e instanceof oa;let r=!0;return e.eachChild(n=>{r=t?r&&Zm(n):r&&n instanceof Kc}),!!r&&ih(e)&&zl(e,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light"])}function Up(e,t){const r=e.length-1;let n,i,s=0,a=r,l=0;for(;s<=a;)if(l=Math.floor((s+a)/2),n=e[l],i=e[l+1],n<=t){if(l===r||t<i)return l;s=l+1}else{if(!(n>t))throw new qn("Input is not a number.");a=l-1}return 0}class Xm{constructor(t,r,n){this.type=t,this.input=r,this.labels=[],this.outputs=[];for(const[i,s]of n)this.labels.push(i),this.outputs.push(s)}static parse(t,r){if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");const n=r.parse(t[1],1,Ft);if(!n)return null;const i=[];let s=null;r.expectedType&&r.expectedType.kind!=="value"&&(s=r.expectedType);for(let a=1;a<t.length;a+=2){const l=a===1?-1/0:t[a],p=t[a+1],f=a,m=a+1;if(typeof l!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',f);if(i.length&&i[i.length-1][0]>=l)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',f);const _=r.parse(p,m,s);if(!_)return null;s=s||_.type,i.push([l,_])}return new Xm(s,n,i)}evaluate(t){const r=this.labels,n=this.outputs;if(r.length===1)return n[0].evaluate(t);const i=this.input.evaluate(t);if(i<=r[0])return n[0].evaluate(t);const s=r.length;return i>=r[s-1]?n[s-1].evaluate(t):n[Up(r,i)].evaluate(t)}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let r=0;r<this.labels.length;r++)r>0&&t.push(this.labels[r]),t.push(this.outputs[r].serialize());return t}}var Wm=Xm;function ce(e,t,r){return e*(1-r)+t*r}var Gp=Object.freeze({__proto__:null,array:function(e,t,r){return e.map((n,i)=>ce(n,t[i],r))},color:function(e,t,r){return new Se(ce(e.r,t.r,r),ce(e.g,t.g,r),ce(e.b,t.b,r),ce(e.a,t.a,r))},number:ce});const s0=.95047,a0=1.08883,l0=4/29,Cu=6/29,u0=3*Cu*Cu,aS=Cu*Cu*Cu,lS=Math.PI/180,uS=180/Math.PI;function Hm(e){return e>aS?Math.pow(e,1/3):e/u0+l0}function Ym(e){return e>Cu?e*e*e:u0*(e-l0)}function $m(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function Km(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function c0(e){const t=Km(e.r),r=Km(e.g),n=Km(e.b),i=Hm((.4124564*t+.3575761*r+.1804375*n)/s0),s=Hm((.2126729*t+.7151522*r+.072175*n)/1);return{l:116*s-16,a:500*(i-s),b:200*(s-Hm((.0193339*t+.119192*r+.9503041*n)/a0)),alpha:e.a}}function h0(e){let t=(e.l+16)/116,r=isNaN(e.a)?t:t+e.a/500,n=isNaN(e.b)?t:t-e.b/200;return t=1*Ym(t),r=s0*Ym(r),n=a0*Ym(n),new Se($m(3.2404542*r-1.5371385*t-.4985314*n),$m(-.969266*r+1.8760108*t+.041556*n),$m(.0556434*r-.2040259*t+1.0572252*n),e.alpha)}function cS(e,t,r){const n=t-e;return e+r*(n>180||n<-180?n-360*Math.round(n/360):n)}const oh={forward:c0,reverse:h0,interpolate:function(e,t,r){return{l:ce(e.l,t.l,r),a:ce(e.a,t.a,r),b:ce(e.b,t.b,r),alpha:ce(e.alpha,t.alpha,r)}}},sh={forward:function(e){const{l:t,a:r,b:n}=c0(e),i=Math.atan2(n,r)*uS;return{h:i<0?i+360:i,c:Math.sqrt(r*r+n*n),l:t,alpha:e.a}},reverse:function(e){const t=e.h*lS,r=e.c;return h0({l:e.l,a:Math.cos(t)*r,b:Math.sin(t)*r,alpha:e.alpha})},interpolate:function(e,t,r){return{h:cS(e.h,t.h,r),c:ce(e.c,t.c,r),l:ce(e.l,t.l,r),alpha:ce(e.alpha,t.alpha,r)}}};var p0=Object.freeze({__proto__:null,hcl:sh,lab:oh});class jp{constructor(t,r,n,i,s){this.type=t,this.operator=r,this.interpolation=n,this.input=i,this.labels=[],this.outputs=[];for(const[a,l]of s)this.labels.push(a),this.outputs.push(l)}static interpolationFactor(t,r,n,i){let s=0;if(t.name==="exponential")s=Jm(r,t.base,n,i);else if(t.name==="linear")s=Jm(r,1,n,i);else if(t.name==="cubic-bezier"){const a=t.controlPoints;s=new we(a[0],a[1],a[2],a[3]).solve(Jm(r,1,n,i))}return s}static parse(t,r){let[n,i,s,...a]=t;if(!Array.isArray(i)||i.length===0)return r.error("Expected an interpolation type expression.",1);if(i[0]==="linear")i={name:"linear"};else if(i[0]==="exponential"){const f=i[1];if(typeof f!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:f}}else{if(i[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(i[0])}`,1,0);{const f=i.slice(1);if(f.length!==4||f.some(m=>typeof m!="number"||m<0||m>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:f}}}if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(s=r.parse(s,2,Ft),!s)return null;const l=[];let p=null;n==="interpolate-hcl"||n==="interpolate-lab"?p=Oo:r.expectedType&&r.expectedType.kind!=="value"&&(p=r.expectedType);for(let f=0;f<a.length;f+=2){const m=a[f],_=a[f+1],y=f+3,v=f+4;if(typeof m!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',y);if(l.length&&l[l.length-1][0]>=m)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',y);const b=r.parse(_,v,p);if(!b)return null;p=p||b.type,l.push([m,b])}return p.kind==="number"||p.kind==="color"||p.kind==="array"&&p.itemType.kind==="number"&&typeof p.N=="number"?new jp(p,n,i,s,l):r.error(`Type ${pn(p)} is not interpolatable.`)}evaluate(t){const r=this.labels,n=this.outputs;if(r.length===1)return n[0].evaluate(t);const i=this.input.evaluate(t);if(i<=r[0])return n[0].evaluate(t);const s=r.length;if(i>=r[s-1])return n[s-1].evaluate(t);const a=Up(r,i),l=jp.interpolationFactor(this.interpolation,i,r[a],r[a+1]),p=n[a].evaluate(t),f=n[a+1].evaluate(t);return this.operator==="interpolate"?Gp[this.type.kind.toLowerCase()](p,f,l):this.operator==="interpolate-hcl"?sh.reverse(sh.interpolate(sh.forward(p),sh.forward(f),l)):oh.reverse(oh.interpolate(oh.forward(p),oh.forward(f),l))}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const r=[this.operator,t,this.input.serialize()];for(let n=0;n<this.labels.length;n++)r.push(this.labels[n],this.outputs[n].serialize());return r}}function Jm(e,t,r,n){const i=n-r,s=e-r;return i===0?0:t===1?s/i:(Math.pow(t,s)-1)/(Math.pow(t,i)-1)}var Ds=jp;class Qm{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expectected at least one argument.");let n=null;const i=r.expectedType;i&&i.kind!=="value"&&(n=i);const s=[];for(const l of t.slice(1)){const p=r.parse(l,1+s.length,n,void 0,{typeAnnotation:"omit"});if(!p)return null;n=n||p.type,s.push(p)}const a=i&&s.some(l=>Hc(i,l.type));return new Qm(a?We:n,s)}evaluate(t){let r,n=null,i=0;for(const s of this.args){if(i++,n=s.evaluate(t),n&&n instanceof No&&!n.available&&(r||(r=n),n=null,i===this.args.length))return r;if(n!==null)break}return n}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(r=>{t.push(r.serialize())}),t}}var f0=Qm;class tg{constructor(t,r){this.type=r.type,this.bindings=[].concat(t),this.result=r}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const r of this.bindings)t(r[1]);t(this.result)}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const n=[];for(let s=1;s<t.length-1;s+=2){const a=t[s];if(typeof a!="string")return r.error(`Expected string, but found ${typeof a} instead.`,s);if(/[^a-zA-Z0-9_]/.test(a))return r.error("Variable names must contain only alphanumeric characters or '_'.",s);const l=r.parse(t[s+1],s+1);if(!l)return null;n.push([a,l])}const i=r.parse(t[t.length-1],t.length-1,r.expectedType,n);return i?new tg(n,i):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[r,n]of this.bindings)t.push(r,n.serialize());return t.push(this.result.serialize()),t}}var d0=tg;class eg{constructor(t,r,n){this.type=t,this.index=r,this.input=n}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=r.parse(t[1],1,Ft),i=r.parse(t[2],2,Xi(r.expectedType||We));return n&&i?new eg(i.type.itemType,n,i):null}evaluate(t){const r=this.index.evaluate(t),n=this.input.evaluate(t);if(r<0)throw new qn(`Array index out of bounds: ${r} < 0.`);if(r>=n.length)throw new qn(`Array index out of bounds: ${r} > ${n.length-1}.`);if(r!==Math.floor(r))throw new qn(`Array index must be an integer, but found ${r} instead.`);return n[r]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var hS=eg;class rg{constructor(t,r){this.type=$e,this.needle=t,this.haystack=r}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=r.parse(t[1],1,We),i=r.parse(t[2],2,We);return n&&i?xm(n.type,[$e,Xe,Ft,bu,We])?new rg(n,i):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${pn(n.type)} instead`):null}evaluate(t){const r=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(n==null)return!1;if(!Yc(r,["boolean","string","number","null"]))throw new qn(`Expected first argument to be of type boolean, string, number or null, but found ${pn(Dn(r))} instead.`);if(!Yc(n,["string","array"]))throw new qn(`Expected second argument to be of type array or string, but found ${pn(Dn(n))} instead.`);return n.indexOf(r)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var pS=rg;class qp{constructor(t,r,n){this.type=Ft,this.needle=t,this.haystack=r,this.fromIndex=n}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=r.parse(t[1],1,We),i=r.parse(t[2],2,We);if(!n||!i)return null;if(!xm(n.type,[$e,Xe,Ft,bu,We]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${pn(n.type)} instead`);if(t.length===4){const s=r.parse(t[3],3,Ft);return s?new qp(n,i,s):null}return new qp(n,i)}evaluate(t){const r=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(!Yc(r,["boolean","string","number","null"]))throw new qn(`Expected first argument to be of type boolean, string, number or null, but found ${pn(Dn(r))} instead.`);if(!Yc(n,["string","array"]))throw new qn(`Expected second argument to be of type array or string, but found ${pn(Dn(n))} instead.`);if(this.fromIndex){const i=this.fromIndex.evaluate(t);return n.indexOf(r,i)}return n.indexOf(r)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var fS=qp;class ng{constructor(t,r,n,i,s,a){this.inputType=t,this.type=r,this.input=n,this.cases=i,this.outputs=s,this.otherwise=a}static parse(t,r){if(t.length<5)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return r.error("Expected an even number of arguments.");let n,i;r.expectedType&&r.expectedType.kind!=="value"&&(i=r.expectedType);const s={},a=[];for(let f=2;f<t.length-1;f+=2){let m=t[f];const _=t[f+1];Array.isArray(m)||(m=[m]);const y=r.concat(f);if(m.length===0)return y.error("Expected at least one branch label.");for(const b of m){if(typeof b!="number"&&typeof b!="string")return y.error("Branch labels must be numbers or strings.");if(typeof b=="number"&&Math.abs(b)>Number.MAX_SAFE_INTEGER)return y.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof b=="number"&&Math.floor(b)!==b)return y.error("Numeric branch labels must be integer values.");if(n){if(y.checkSubtype(n,Dn(b)))return null}else n=Dn(b);if(s[String(b)]!==void 0)return y.error("Branch labels must be unique.");s[String(b)]=a.length}const v=r.parse(_,f,i);if(!v)return null;i=i||v.type,a.push(v)}const l=r.parse(t[1],1,We);if(!l)return null;const p=r.parse(t[t.length-1],t.length-1,i);return p?l.type.kind!=="value"&&r.concat(1).checkSubtype(n,l.type)?null:new ng(n,i,l,s,a,p):null}evaluate(t){const r=this.input.evaluate(t);return(Dn(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],r=Object.keys(this.cases).sort(),n=[],i={};for(const a of r){const l=i[this.cases[a]];l===void 0?(i[this.cases[a]]=n.length,n.push([this.cases[a],[a]])):n[l][1].push(a)}const s=a=>this.inputType.kind==="number"?Number(a):a;for(const[a,l]of n)t.push(l.length===1?s(l[0]):l.map(s)),t.push(this.outputs[a].serialize());return t.push(this.otherwise.serialize()),t}}var dS=ng;class ig{constructor(t,r,n){this.type=t,this.branches=r,this.otherwise=n}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return r.error("Expected an odd number of arguments.");let n;r.expectedType&&r.expectedType.kind!=="value"&&(n=r.expectedType);const i=[];for(let a=1;a<t.length-1;a+=2){const l=r.parse(t[a],a,$e);if(!l)return null;const p=r.parse(t[a+1],a+1,n);if(!p)return null;i.push([l,p]),n=n||p.type}const s=r.parse(t[t.length-1],t.length-1,n);return s?new ig(n,i,s):null}evaluate(t){for(const[r,n]of this.branches)if(r.evaluate(t))return n.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[r,n]of this.branches)t(r),t(n);t(this.otherwise)}outputDefined(){return this.branches.every(([t,r])=>r.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(r=>{t.push(r.serialize())}),t}}var mS=ig;class Zp{constructor(t,r,n,i){this.type=t,this.input=r,this.beginIndex=n,this.endIndex=i}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=r.parse(t[1],1,We),i=r.parse(t[2],2,Ft);if(!n||!i)return null;if(!xm(n.type,[Xi(We),Xe,We]))return r.error(`Expected first argument to be of type array or string, but found ${pn(n.type)} instead`);if(t.length===4){const s=r.parse(t[3],3,Ft);return s?new Zp(n.type,n,i,s):null}return new Zp(n.type,n,i)}evaluate(t){const r=this.input.evaluate(t),n=this.beginIndex.evaluate(t);if(!Yc(r,["string","array"]))throw new qn(`Expected first argument to be of type array or string, but found ${pn(Dn(r))} instead.`);if(this.endIndex){const i=this.endIndex.evaluate(t);return r.slice(n,i)}return r.slice(n)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var gS=Zp;function m0(e,t){return e==="=="||e==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function g0(e,t,r,n){return n.compare(t,r)===0}function Mu(e,t,r){const n=e!=="=="&&e!=="!=";return class VT{constructor(s,a,l){this.type=$e,this.lhs=s,this.rhs=a,this.collator=l,this.hasUntypedArgument=s.type.kind==="value"||a.type.kind==="value"}static parse(s,a){if(s.length!==3&&s.length!==4)return a.error("Expected two or three arguments.");const l=s[0];let p=a.parse(s[1],1,We);if(!p)return null;if(!m0(l,p.type))return a.concat(1).error(`"${l}" comparisons are not supported for type '${pn(p.type)}'.`);let f=a.parse(s[2],2,We);if(!f)return null;if(!m0(l,f.type))return a.concat(2).error(`"${l}" comparisons are not supported for type '${pn(f.type)}'.`);if(p.type.kind!==f.type.kind&&p.type.kind!=="value"&&f.type.kind!=="value")return a.error(`Cannot compare types '${pn(p.type)}' and '${pn(f.type)}'.`);n&&(p.type.kind==="value"&&f.type.kind!=="value"?p=new oa(f.type,[p]):p.type.kind!=="value"&&f.type.kind==="value"&&(f=new oa(p.type,[f])));let m=null;if(s.length===4){if(p.type.kind!=="string"&&f.type.kind!=="string"&&p.type.kind!=="value"&&f.type.kind!=="value")return a.error("Cannot use collator to compare non-string types.");if(m=a.parse(s[3],3,Lp),!m)return null}return new VT(p,f,m)}evaluate(s){const a=this.lhs.evaluate(s),l=this.rhs.evaluate(s);if(n&&this.hasUntypedArgument){const p=Dn(a),f=Dn(l);if(p.kind!==f.kind||p.kind!=="string"&&p.kind!=="number")throw new qn(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${p.kind}, ${f.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const p=Dn(a),f=Dn(l);if(p.kind!=="string"||f.kind!=="string")return t(s,a,l)}return this.collator?r(s,a,l,this.collator.evaluate(s)):t(s,a,l)}eachChild(s){s(this.lhs),s(this.rhs),this.collator&&s(this.collator)}outputDefined(){return!0}serialize(){const s=[e];return this.eachChild(a=>{s.push(a.serialize())}),s}}}const _S=Mu("==",function(e,t,r){return t===r},g0),yS=Mu("!=",function(e,t,r){return t!==r},function(e,t,r,n){return!g0(0,t,r,n)}),vS=Mu("<",function(e,t,r){return t<r},function(e,t,r,n){return n.compare(t,r)<0}),xS=Mu(">",function(e,t,r){return t>r},function(e,t,r,n){return n.compare(t,r)>0}),bS=Mu("<=",function(e,t,r){return t<=r},function(e,t,r,n){return n.compare(t,r)<=0}),wS=Mu(">=",function(e,t,r){return t>=r},function(e,t,r,n){return n.compare(t,r)>=0});class og{constructor(t,r,n,i,s,a){this.type=Xe,this.number=t,this.locale=r,this.currency=n,this.unit=i,this.minFractionDigits=s,this.maxFractionDigits=a}static parse(t,r){if(t.length!==3)return r.error("Expected two arguments.");const n=r.parse(t[1],1,Ft);if(!n)return null;const i=t[2];if(typeof i!="object"||Array.isArray(i))return r.error("NumberFormat options argument must be an object.");let s=null;if(i.locale&&(s=r.parse(i.locale,1,Xe),!s))return null;let a=null;if(i.currency&&(a=r.parse(i.currency,1,Xe),!a))return null;let l=null;if(i.unit&&(l=r.parse(i.unit,1,Xe),!l))return null;let p=null;if(i["min-fraction-digits"]&&(p=r.parse(i["min-fraction-digits"],1,Ft),!p))return null;let f=null;return i["max-fraction-digits"]&&(f=r.parse(i["max-fraction-digits"],1,Ft),!f)?null:new og(n,s,a,l,p,f)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class sg{constructor(t){this.type=Ft,this.input=t}static parse(t,r){if(t.length!==2)return r.error(`Expected 1 argument, but found ${t.length-1} instead.`);const n=r.parse(t[1],1);return n?n.type.kind!=="array"&&n.type.kind!=="string"&&n.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${pn(n.type)} instead.`):new sg(n):null}evaluate(t){const r=this.input.evaluate(t);if(typeof r=="string"||Array.isArray(r))return r.length;throw new qn(`Expected value to be of type string or array, but found ${pn(Dn(r))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(r=>{t.push(r.serialize())}),t}}function ag(e){return function(){e=1831565813+(e|=0)|0;let t=Math.imul(e^e>>>15,1|e);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const _0={"==":_S,"!=":yS,">":xS,"<":vS,">=":wS,"<=":bS,array:oa,at:hS,boolean:oa,case:mS,coalesce:f0,collator:Op,format:Jc,image:Qc,in:pS,"index-of":fS,interpolate:Ds,"interpolate-hcl":Ds,"interpolate-lab":Ds,length:sg,let:d0,literal:Kc,match:dS,number:oa,"number-format":og,object:oa,slice:gS,step:Wm,string:oa,"to-boolean":Ol,"to-color":Ol,"to-number":Ol,"to-string":Ol,var:i0,within:Lm,distance:Um};function y0(e,[t,r,n,i]){t=t.evaluate(e),r=r.evaluate(e),n=n.evaluate(e);const s=i?i.evaluate(e):1,a=Uv(t,r,n,s);if(a)throw new qn(a);return new Se(t/255*s,r/255*s,n/255*s,s)}function v0(e,[t,r,n,i]){t=t.evaluate(e),r=r.evaluate(e),n=n.evaluate(e);const s=i?i.evaluate(e):1,a=function(f,m,_,y){return typeof f=="number"&&f>=0&&f<=360?typeof m=="number"&&m>=0&&m<=100&&typeof _=="number"&&_>=0&&_<=100?y===void 0||typeof y=="number"&&y>=0&&y<=1?null:`Invalid hsla value [${[f,m,_,y].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof y=="number"?[f,m,_,y]:[f,m,_]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof y=="number"?[f,m,_,y]:[f,m,_]).join(", ")}]: 'h' must be between 0 and 360.`}(t,r,n,s);if(a)throw new qn(a);const l=`hsla(${t}, ${r}%, ${n}%, ${s})`,p=Se.parse(l);if(!p)throw new qn(`Failed to parse HSLA color: ${l}`);return p}function x0(e,t){return e in t}function lg(e,t){const r=t[e];return r===void 0?null:r}function b0(e,t,r){r.length&&(t+=`${r}`);const n=e.getConfig(t);return n?n.evaluate(e):null}function kl(e){return{type:e}}Ls.register(_0,{error:[{kind:"error"},[Xe],(e,[t])=>{throw new qn(t.evaluate(e))}],typeof:[Xe,[We],(e,[t])=>pn(Dn(t.evaluate(e)))],"to-rgba":[Xi(Ft,4),[Oo],(e,[t])=>t.evaluate(e).toArray()],rgb:[Oo,[Ft,Ft,Ft],y0],rgba:[Oo,[Ft,Ft,Ft,Ft],y0],hsl:[Oo,[Ft,Ft,Ft],v0],hsla:[Oo,[Ft,Ft,Ft,Ft],v0],has:{type:$e,overloads:[[[Xe],(e,[t])=>x0(t.evaluate(e),e.properties())],[[Xe,wu],(e,[t,r])=>x0(t.evaluate(e),r.evaluate(e))]]},get:{type:We,overloads:[[[Xe],(e,[t])=>lg(t.evaluate(e),e.properties())],[[Xe,wu],(e,[t,r])=>lg(t.evaluate(e),r.evaluate(e))]]},config:{type:We,overloads:[[[Xe],(e,[t])=>b0(e,t.evaluate(e),"")],[[Xe,Xe],(e,[t,r])=>b0(e,t.evaluate(e),r.evaluate(e))]]},"feature-state":[We,[Xe],(e,[t])=>lg(t.evaluate(e),e.featureState||{})],properties:[wu,[],e=>e.properties()],"geometry-type":[Xe,[],e=>e.geometryType()],id:[We,[],e=>e.id()],zoom:[Ft,[],e=>e.globals.zoom],pitch:[Ft,[],e=>e.globals.pitch||0],"distance-from-center":[Ft,[],e=>e.distanceFromCenter()],"measure-light":[Ft,[Xe],(e,[t])=>e.measureLight(t.evaluate(e))],"heatmap-density":[Ft,[],e=>e.globals.heatmapDensity||0],"line-progress":[Ft,[],e=>e.globals.lineProgress||0],"raster-value":[Ft,[],e=>e.globals.rasterValue||0],"sky-radial-progress":[Ft,[],e=>e.globals.skyRadialProgress||0],accumulated:[We,[],e=>e.globals.accumulated===void 0?null:e.globals.accumulated],"+":[Ft,kl(Ft),(e,t)=>{let r=0;for(const n of t)r+=n.evaluate(e);return r}],"*":[Ft,kl(Ft),(e,t)=>{let r=1;for(const n of t)r*=n.evaluate(e);return r}],"-":{type:Ft,overloads:[[[Ft,Ft],(e,[t,r])=>t.evaluate(e)-r.evaluate(e)],[[Ft],(e,[t])=>-t.evaluate(e)]]},"/":[Ft,[Ft,Ft],(e,[t,r])=>t.evaluate(e)/r.evaluate(e)],"%":[Ft,[Ft,Ft],(e,[t,r])=>t.evaluate(e)%r.evaluate(e)],ln2:[Ft,[],()=>Math.LN2],pi:[Ft,[],()=>Math.PI],e:[Ft,[],()=>Math.E],"^":[Ft,[Ft,Ft],(e,[t,r])=>Math.pow(t.evaluate(e),r.evaluate(e))],sqrt:[Ft,[Ft],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[Ft,[Ft],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[Ft,[Ft],(e,[t])=>Math.log(t.evaluate(e))],log2:[Ft,[Ft],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[Ft,[Ft],(e,[t])=>Math.sin(t.evaluate(e))],cos:[Ft,[Ft],(e,[t])=>Math.cos(t.evaluate(e))],tan:[Ft,[Ft],(e,[t])=>Math.tan(t.evaluate(e))],asin:[Ft,[Ft],(e,[t])=>Math.asin(t.evaluate(e))],acos:[Ft,[Ft],(e,[t])=>Math.acos(t.evaluate(e))],atan:[Ft,[Ft],(e,[t])=>Math.atan(t.evaluate(e))],min:[Ft,kl(Ft),(e,t)=>Math.min(...t.map(r=>r.evaluate(e)))],max:[Ft,kl(Ft),(e,t)=>Math.max(...t.map(r=>r.evaluate(e)))],abs:[Ft,[Ft],(e,[t])=>Math.abs(t.evaluate(e))],round:[Ft,[Ft],(e,[t])=>{const r=t.evaluate(e);return r<0?-Math.round(-r):Math.round(r)}],floor:[Ft,[Ft],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[Ft,[Ft],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[$e,[Xe,We],(e,[t,r])=>e.properties()[t.value]===r.value],"filter-id-==":[$e,[We],(e,[t])=>e.id()===t.value],"filter-type-==":[$e,[Xe],(e,[t])=>e.geometryType()===t.value],"filter-<":[$e,[Xe,We],(e,[t,r])=>{const n=e.properties()[t.value],i=r.value;return typeof n==typeof i&&n<i}],"filter-id-<":[$e,[We],(e,[t])=>{const r=e.id(),n=t.value;return typeof r==typeof n&&r<n}],"filter->":[$e,[Xe,We],(e,[t,r])=>{const n=e.properties()[t.value],i=r.value;return typeof n==typeof i&&n>i}],"filter-id->":[$e,[We],(e,[t])=>{const r=e.id(),n=t.value;return typeof r==typeof n&&r>n}],"filter-<=":[$e,[Xe,We],(e,[t,r])=>{const n=e.properties()[t.value],i=r.value;return typeof n==typeof i&&n<=i}],"filter-id-<=":[$e,[We],(e,[t])=>{const r=e.id(),n=t.value;return typeof r==typeof n&&r<=n}],"filter->=":[$e,[Xe,We],(e,[t,r])=>{const n=e.properties()[t.value],i=r.value;return typeof n==typeof i&&n>=i}],"filter-id->=":[$e,[We],(e,[t])=>{const r=e.id(),n=t.value;return typeof r==typeof n&&r>=n}],"filter-has":[$e,[We],(e,[t])=>t.value in e.properties()],"filter-has-id":[$e,[],e=>e.id()!==null&&e.id()!==void 0],"filter-type-in":[$e,[Xi(Xe)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[$e,[Xi(We)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[$e,[Xe,Xi(We)],(e,[t,r])=>r.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[$e,[Xe,Xi(We)],(e,[t,r])=>function(n,i,s,a){for(;s<=a;){const l=s+a>>1;if(i[l]===n)return!0;i[l]>n?a=l-1:s=l+1}return!1}(e.properties()[t.value],r.value,0,r.value.length-1)],all:{type:$e,overloads:[[[$e,$e],(e,[t,r])=>t.evaluate(e)&&r.evaluate(e)],[kl($e),(e,t)=>{for(const r of t)if(!r.evaluate(e))return!1;return!0}]]},any:{type:$e,overloads:[[[$e,$e],(e,[t,r])=>t.evaluate(e)||r.evaluate(e)],[kl($e),(e,t)=>{for(const r of t)if(r.evaluate(e))return!0;return!1}]]},"!":[$e,[$e],(e,[t])=>!t.evaluate(e)],"is-supported-script":[$e,[Xe],(e,[t])=>{const r=e.globals&&e.globals.isSupportedScript;return!r||r(t.evaluate(e))}],upcase:[Xe,[Xe],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[Xe,[Xe],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[Xe,kl(We),(e,t)=>t.map(r=>$c(r.evaluate(e))).join("")],"resolved-locale":[Xe,[Lp],(e,[t])=>t.evaluate(e).resolvedLocale()],random:[Ft,[Ft,Ft,We],(e,t)=>{const[r,n,i]=t.map(a=>a.evaluate(e));if(r>n||r===n)return r;let s;if(typeof i=="string")s=function(a){let l=0;if(a.length===0)return l;for(let p=0;p<a.length;p++)l=(l<<5)-l+a.charCodeAt(p),l&=l;return l}(i);else{if(typeof i!="number")throw new qn(`Invalid seed input: ${i}`);s=i}return r+ag(s)()*(n-r)}]});var ah=_0;function w0(e){return{result:"success",value:e}}function Fl(e){return{result:"error",value:e}}function E0(e,t){return!!e&&!!e.parameters&&e.parameters.indexOf(t)>-1}function Bl(e){return e["property-type"]==="data-driven"}function T0(e){return E0(e.expression,"measure-light")}function ug(e){return E0(e.expression,"zoom")}function cg(e){return!!e.expression&&e.expression.interpolated}function Xp(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function ES(e){return e}function I0(e,t){const r=t.type==="color",n=e.stops&&typeof e.stops[0][0]=="object",i=n||!(n||e.property!==void 0),s=e.type||(cg(t)?"exponential":"interval");if(r&&((e=na({},e)).stops&&(e.stops=e.stops.map(f=>[f[0],Se.parse(f[1])])),e.default=Se.parse(e.default?e.default:t.default)),e.colorSpace&&e.colorSpace!=="rgb"&&!p0[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let a,l,p;if(s==="exponential")a=S0;else if(s==="interval")a=IS;else if(s==="categorical"){a=TS,l=Object.create(null);for(const f of e.stops)l[f[0]]=f[1];p=typeof e.stops[0][0]}else{if(s!=="identity")throw new Error(`Unknown function type "${s}"`);a=SS}if(n){const f={},m=[];for(let v=0;v<e.stops.length;v++){const b=e.stops[v],w=b[0].zoom;f[w]===void 0&&(f[w]={zoom:w,type:e.type,property:e.property,default:e.default,stops:[]},m.push(w)),f[w].stops.push([b[0].value,b[1]])}const _=[];for(const v of m)_.push([f[v].zoom,I0(f[v],t)]);const y={name:"linear"};return{kind:"composite",interpolationType:y,interpolationFactor:Ds.interpolationFactor.bind(void 0,y),zoomStops:_.map(v=>v[0]),evaluate:({zoom:v},b)=>S0({stops:_,base:e.base},t,v).evaluate(v,b)}}if(i){const f=s==="exponential"?{name:"exponential",base:e.base!==void 0?e.base:1}:null;return{kind:"camera",interpolationType:f,interpolationFactor:Ds.interpolationFactor.bind(void 0,f),zoomStops:e.stops.map(m=>m[0]),evaluate:({zoom:m})=>a(e,t,m,l,p)}}return{kind:"source",evaluate(f,m){const _=m&&m.properties?m.properties[e.property]:void 0;return _===void 0?lh(e.default,t.default):a(e,t,_,l,p)}}}function lh(e,t,r){return e!==void 0?e:t!==void 0?t:r!==void 0?r:void 0}function TS(e,t,r,n,i){return lh(typeof r===i?n[r]:void 0,e.default,t.default)}function IS(e,t,r){if(or(r)!=="number")return lh(e.default,t.default);const n=e.stops.length;if(n===1||r<=e.stops[0][0])return e.stops[0][1];if(r>=e.stops[n-1][0])return e.stops[n-1][1];const i=Up(e.stops.map(s=>s[0]),r);return e.stops[i][1]}function S0(e,t,r){const n=e.base!==void 0?e.base:1;if(or(r)!=="number")return lh(e.default,t.default);const i=e.stops.length;if(i===1||r<=e.stops[0][0])return e.stops[0][1];if(r>=e.stops[i-1][0])return e.stops[i-1][1];const s=Up(e.stops.map(m=>m[0]),r),a=function(m,_,y,v){const b=v-y,w=m-y;return b===0?0:_===1?w/b:(Math.pow(_,w)-1)/(Math.pow(_,b)-1)}(r,n,e.stops[s][0],e.stops[s+1][0]),l=e.stops[s][1],p=e.stops[s+1][1];let f=Gp[t.type]||ES;if(e.colorSpace&&e.colorSpace!=="rgb"){const m=p0[e.colorSpace];f=(_,y)=>m.reverse(m.interpolate(m.forward(_),m.forward(y),a))}return typeof l.evaluate=="function"?{evaluate(...m){const _=l.evaluate.apply(void 0,m),y=p.evaluate.apply(void 0,m);if(_!==void 0&&y!==void 0)return f(_,y,a)}}:f(l,p,a)}function SS(e,t,r){return t.type==="color"?r=Se.parse(r):t.type==="formatted"?r=Hi.fromString(r.toString()):t.type==="resolvedImage"?r=No.fromString(r.toString()):or(r)===t.type||t.type==="enum"&&t.values[r]||(r=void 0),lh(r,e.default,t.default)}class hg{constructor(t,r,n){this.expression=t,this._warningHistory={},this._evaluator=new Gv(n),this._defaultValue=r?function(i){return i.type==="color"&&(Xp(i.default)||Array.isArray(i.default))?new Se(0,0,0,0):i.type==="color"?Se.parse(i.default)||null:i.default===void 0?null:i.default}(r):null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(t,r,n,i,s,a,l,p){return this._evaluator.globals=t,this._evaluator.feature=r,this._evaluator.featureState=n,this._evaluator.canonical=i||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=a,this._evaluator.featureTileCoord=l||null,this._evaluator.featureDistanceData=p||null,this.expression.evaluate(this._evaluator)}evaluate(t,r,n,i,s,a,l,p){this._evaluator.globals=t,this._evaluator.feature=r||null,this._evaluator.featureState=n||null,this._evaluator.canonical=i||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=a||null,this._evaluator.featureTileCoord=l||null,this._evaluator.featureDistanceData=p||null;try{const f=this.expression.evaluate(this._evaluator);if(f==null||typeof f=="number"&&f!=f)return this._defaultValue;if(this._enumValues&&!(f in this._enumValues))throw new qn(`Expected value to be one of ${Object.keys(this._enumValues).map(m=>JSON.stringify(m)).join(", ")}, but found ${JSON.stringify(f)} instead.`);return f}catch(f){return this._warningHistory[f.message]||(this._warningHistory[f.message]=!0,typeof console<"u"&&console.warn(f.message)),this._defaultValue}}}function Wp(e){return Array.isArray(e)&&e.length>0&&typeof e[0]=="string"&&e[0]in ah}function Fa(e,t,r){const n=new o0(ah,[],t?function(s){const a={color:Oo,string:Xe,number:Ft,enum:Xe,boolean:$e,formatted:Xc,resolvedImage:Wc};return s.type==="array"?Xi(a[s.value]||We,s.length):a[s.type]}(t):void 0,void 0,void 0,r),i=n.parse(e,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return i?w0(new hg(i,t,r)):Fl(n.errors)}class pg{constructor(t,r,n){this.kind=t,this._styleExpression=r,this.isLightConstant=n,this.isStateDependent=t!=="constant"&&!Vp(r.expression),this.isConfigDependent=!Gm(r.expression)}evaluateWithoutErrorHandling(t,r,n,i,s,a){return this._styleExpression.evaluateWithoutErrorHandling(t,r,n,i,s,a)}evaluate(t,r,n,i,s,a){return this._styleExpression.evaluate(t,r,n,i,s,a)}}class Hp{constructor(t,r,n,i,s){this.kind=t,this.zoomStops=n,this._styleExpression=r,this.isStateDependent=t!=="camera"&&!Vp(r.expression),this.isLightConstant=s,this.isConfigDependent=!Gm(r.expression),this.interpolationType=i}evaluateWithoutErrorHandling(t,r,n,i,s,a){return this._styleExpression.evaluateWithoutErrorHandling(t,r,n,i,s,a)}evaluate(t,r,n,i,s,a){return this._styleExpression.evaluate(t,r,n,i,s,a)}interpolationFactor(t,r,n){return this.interpolationType?Ds.interpolationFactor(this.interpolationType,t,r,n):0}}function fg(e,t,r){if((e=Fa(e,t,r)).result==="error")return e;const n=e.value.expression,i=ih(n);if(!i&&!Bl(t))return Fl([new Ps("","data expressions not supported")]);const s=zl(n,["zoom","pitch","distance-from-center"]);if(!s&&!ug(t))return Fl([new Ps("","zoom expressions not supported")]);const a=zl(n,["measure-light"]);if(!a&&!T0(t))return Fl([new Ps("","measure-light expression not supported")]);const l=t.expression&&t.expression.relaxZoomRestriction,p=$p(n);return p||s||l?p instanceof Ps?Fl([p]):p instanceof Ds&&!cg(t)?Fl([new Ps("",'"interpolate" expressions cannot be used with this property')]):w0(p?new Hp(i?"camera":"composite",e.value,p.labels,p instanceof Ds?p.interpolation:void 0,a):new pg(i?"constant":"source",e.value,a)):Fl([new Ps("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Yp{constructor(t,r){this._parameters=t,this._specification=r,na(this,I0(this._parameters,this._specification))}static deserialize(t){return new Yp(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function $p(e){let t=null;if(e instanceof d0)t=$p(e.result);else if(e instanceof f0){for(const r of e.args)if(t=$p(r),t)break}else(e instanceof Wm||e instanceof Ds)&&e.input instanceof Ls&&e.input.name==="zoom"&&(t=e);return t instanceof Ps||e.eachChild(r=>{const n=$p(r);n instanceof Ps?t=n:t&&n&&t!==n&&(t=new Ps("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function zo(e){const t=e.key,r=e.value,n=e.valueSpec||{},i=e.objectElementValidators||{},s=e.style,a=e.styleSpec;let l=[];const p=or(r);if(p!=="object")return[new Vt(t,r,`object expected, ${p} found`)];for(const f in r){const m=f.split(".")[0];let _;i[m]?_=i[m]:n[m]?_=ti:i["*"]?_=i["*"]:n["*"]&&(_=ti),_?l=l.concat(_({key:(t&&`${t}.`)+f,value:r[f],valueSpec:n[m]||n["*"],style:s,styleSpec:a,object:r,objectKey:f},r)):l.push(new Vt(t,r[f],`unknown property "${f}"`))}for(const f in n)i[f]||n[f].required&&n[f].default===void 0&&r[f]===void 0&&l.push(new Vt(t,r,`missing required property "${f}"`));return l}function C0(e){const t=e.value,r=e.valueSpec,n=e.style,i=e.styleSpec,s=e.key,a=e.arrayElementValidator||ti;if(or(t)!=="array")return[new Vt(s,t,`array expected, ${or(t)} found`)];if(r.length&&t.length!==r.length)return[new Vt(s,t,`array length ${r.length} expected, length ${t.length} found`)];if(r["min-length"]&&t.length<r["min-length"])return[new Vt(s,t,`array length at least ${r["min-length"]} expected, length ${t.length} found`)];let l={type:r.value,values:r.values,minimum:r.minimum,maximum:r.maximum,function:void 0};i.$version<7&&(l.function=r.function),or(r.value)==="object"&&(l=r.value);let p=[];for(let f=0;f<t.length;f++)p=p.concat(a({array:t,arrayIndex:f,value:t[f],valueSpec:l,style:n,styleSpec:i,key:`${s}[${f}]`},!0));return p}function M0(e){const t=e.key,r=e.value,n=e.valueSpec;let i=or(r);if(i==="number"&&r!=r&&(i="NaN"),i!=="number")return[new Vt(t,r,`number expected, ${i} found`)];if("minimum"in n){let s=n.minimum;if(or(n.minimum)==="array"&&(s=n.minimum[e.arrayIndex]),r<s)return[new Vt(t,r,`${r} is less than the minimum value ${s}`)]}if("maximum"in n){let s=n.maximum;if(or(n.maximum)==="array"&&(s=n.maximum[e.arrayIndex]),r>s)return[new Vt(t,r,`${r} is greater than the maximum value ${s}`)]}return[]}function A0(e){const t=e.valueSpec,r=jn(e.value.type);let n,i,s,a={};const l=r!=="categorical"&&e.value.property===void 0,p=!l,f=or(e.value.stops)==="array"&&or(e.value.stops[0])==="array"&&or(e.value.stops[0][0])==="object",m=zo({key:e.key,value:e.value,valueSpec:e.styleSpec.function,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{stops:function(v){if(r==="identity")return[new Vt(v.key,v.value,'identity function may not have a "stops" property')];let b=[];const w=v.value;return b=b.concat(C0({key:v.key,value:w,valueSpec:v.valueSpec,style:v.style,styleSpec:v.styleSpec,arrayElementValidator:_})),or(w)==="array"&&w.length===0&&b.push(new Vt(v.key,w,"array must have at least one stop")),b},default:function(v){return ti({key:v.key,value:v.value,valueSpec:t,style:v.style,styleSpec:v.styleSpec})}}});return r==="identity"&&l&&m.push(new Vt(e.key,e.value,'missing required property "property"')),r==="identity"||e.value.stops||m.push(new Vt(e.key,e.value,'missing required property "stops"')),r==="exponential"&&e.valueSpec.expression&&!cg(e.valueSpec)&&m.push(new Vt(e.key,e.value,"exponential functions not supported")),e.styleSpec.$version>=8&&(p&&!Bl(e.valueSpec)?m.push(new Vt(e.key,e.value,"property functions not supported")):l&&!ug(e.valueSpec)&&m.push(new Vt(e.key,e.value,"zoom functions not supported"))),r!=="categorical"&&!f||e.value.property!==void 0||m.push(new Vt(e.key,e.value,'"property" property is required')),m;function _(v){let b=[];const w=v.value,E=v.key;if(or(w)!=="array")return[new Vt(E,w,`array expected, ${or(w)} found`)];if(w.length!==2)return[new Vt(E,w,`array length 2 expected, length ${w.length} found`)];if(f){if(or(w[0])!=="object")return[new Vt(E,w,`object expected, ${or(w[0])} found`)];if(w[0].zoom===void 0)return[new Vt(E,w,"object stop key must have zoom")];if(w[0].value===void 0)return[new Vt(E,w,"object stop key must have value")];const T=jn(w[0].zoom);if(typeof T!="number")return[new Vt(E,w[0].zoom,"stop zoom values must be numbers")];if(s&&s>T)return[new Vt(E,w[0].zoom,"stop zoom values must appear in ascending order")];T!==s&&(s=T,i=void 0,a={}),b=b.concat(zo({key:`${E}[0]`,value:w[0],valueSpec:{zoom:{}},style:v.style,styleSpec:v.styleSpec,objectElementValidators:{zoom:M0,value:y}}))}else b=b.concat(y({key:`${E}[0]`,value:w[0],valueSpec:{},style:v.style,styleSpec:v.styleSpec},w));return Wp(ia(w[1]))?b.concat([new Vt(`${E}[1]`,w[1],"expressions are not allowed in function stops.")]):b.concat(ti({key:`${E}[1]`,value:w[1],valueSpec:t,style:v.style,styleSpec:v.styleSpec}))}function y(v,b){const w=or(v.value),E=jn(v.value),T=v.value!==null?v.value:b;if(n){if(w!==n)return[new Vt(v.key,T,`${w} stop domain type must match previous stop domain type ${n}`)]}else n=w;if(w!=="number"&&w!=="string"&&w!=="boolean"&&typeof E!="number"&&typeof E!="string"&&typeof E!="boolean")return[new Vt(v.key,T,"stop domain value must be a number, string, or boolean")];if(w!=="number"&&r!=="categorical"){let C=`number expected, ${w} found`;return Bl(t)&&r===void 0&&(C+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Vt(v.key,T,C)]}return r!=="categorical"||w!=="number"||typeof E=="number"&&isFinite(E)&&Math.floor(E)===E?r!=="categorical"&&w==="number"&&typeof E=="number"&&typeof i=="number"&&i!==void 0&&E<i?[new Vt(v.key,T,"stop domain values must appear in ascending order")]:(i=E,r==="categorical"&&E in a?[new Vt(v.key,T,"stop domain values must be unique")]:(a[E]=!0,[])):[new Vt(v.key,T,`integer expected, found ${String(E)}`)]}}function Vl(e){const t=(e.expressionContext==="property"?fg:Fa)(ia(e.value),e.valueSpec);if(t.result==="error")return t.value.map(n=>new Vt(`${e.key}${n.key}`,e.value,n.message));const r=t.value.expression||t.value._styleExpression.expression;if(e.expressionContext==="property"&&e.propertyKey==="text-font"&&!r.outputDefined())return[new Vt(e.key,e.value,`Invalid data expression for "${e.propertyKey}". Output values must be contained as literals within the expression.`)];if(e.expressionContext==="property"&&e.propertyType==="layout"&&!Vp(r))return[new Vt(e.key,e.value,'"feature-state" data expressions are not supported with layout properties.')];if(e.expressionContext==="filter")return P0(r,e);if(e.expressionContext&&e.expressionContext.indexOf("cluster")===0){if(!zl(r,["zoom","feature-state"]))return[new Vt(e.key,e.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(e.expressionContext==="cluster-initial"&&!ih(r))return[new Vt(e.key,e.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function P0(e,t){const r=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const i of t.valueSpec.expression.parameters)r.delete(i);if(r.size===0)return[];const n=[];return e instanceof Ls&&r.has(e.name)?[new Vt(t.key,t.value,`["${e.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(e.eachChild(i=>{n.push(...P0(i,t))}),n)}function Kp(e){const t=e.key,r=e.value,n=e.valueSpec,i=[];return Array.isArray(n.values)?n.values.indexOf(jn(r))===-1&&i.push(new Vt(t,r,`expected one of [${n.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(n.values).indexOf(jn(r))===-1&&i.push(new Vt(t,r,`expected one of [${Object.keys(n.values).join(", ")}], ${JSON.stringify(r)} found`)),i}function dg(e){if(e===!0||e===!1)return!0;if(!Array.isArray(e)||e.length===0)return!1;switch(e[0]){case"has":return e.length>=2&&e[1]!=="$id"&&e[1]!=="$type";case"in":return e.length>=3&&(typeof e[1]!="string"||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return e.length!==3||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!dg(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}function Jp(e,t="fill"){if(e==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};dg(e)||(e=Qp(e));const r=e;let n=!0;try{n=function(f){if(!Au(f))return f;let m=ia(f);return D0(m),m=L0(m),m}(r)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(r,null,2)}
        `)}const i=rt[`filter_${t}`],s=Fa(n,i);let a=null;if(s.result==="error")throw new Error(s.value.map(f=>`${f.key}: ${f.message}`).join(", "));a=(f,m,_)=>s.value.evaluate(f,m,{},_);let l=null,p=null;if(n!==r){const f=Fa(r,i);if(f.result==="error")throw new Error(f.value.map(m=>`${m.key}: ${m.message}`).join(", "));l=(m,_,y,v,b)=>f.value.evaluate(m,_,{},y,void 0,void 0,v,b),p=!ih(f.value.expression)}return{filter:a,dynamicFilter:l||void 0,needGeometry:R0(n),needFeature:!!p}}function L0(e){if(!Array.isArray(e))return e;const t=function(r){if(CS.has(r[0])){for(let n=1;n<r.length;n++)if(Au(r[n]))return!0}return r}(e);return t===!0?t:t.map(r=>L0(r))}function D0(e){let t=!1;const r=[];if(e[0]==="case"){for(let n=1;n<e.length-1;n+=2)t=t||Au(e[n]),r.push(e[n+1]);r.push(e[e.length-1])}else if(e[0]==="match"){t=t||Au(e[1]);for(let n=2;n<e.length-1;n+=2)r.push(e[n+1]);r.push(e[e.length-1])}else if(e[0]==="step"){t=t||Au(e[1]);for(let n=1;n<e.length-1;n+=2)r.push(e[n+1])}t&&(e.length=0,e.push("any",...r));for(let n=1;n<e.length;n++)D0(e[n])}function Au(e){if(!Array.isArray(e))return!1;if((t=e[0])==="pitch"||t==="distance-from-center")return!0;var t;for(let r=1;r<e.length;r++)if(Au(e[r]))return!0;return!1}const CS=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function MS(e,t){return e<t?-1:e>t?1:0}function R0(e){if(!Array.isArray(e))return!1;if(e[0]==="within"||e[0]==="distance")return!0;for(let t=1;t<e.length;t++)if(R0(e[t]))return!0;return!1}function Qp(e){if(!e)return!0;const t=e[0];return e.length<=1?t!=="any":t==="=="?mg(e[1],e[2],"=="):t==="!="?tf(mg(e[1],e[2],"==")):t==="<"||t===">"||t==="<="||t===">="?mg(e[1],e[2],t):t==="any"?(r=e.slice(1),["any"].concat(r.map(Qp))):t==="all"?["all"].concat(e.slice(1).map(Qp)):t==="none"?["all"].concat(e.slice(1).map(Qp).map(tf)):t==="in"?O0(e[1],e.slice(2)):t==="!in"?tf(O0(e[1],e.slice(2))):t==="has"?N0(e[1]):t!=="!has"||tf(N0(e[1]));var r}function mg(e,t,r){switch(e){case"$type":return[`filter-type-${r}`,t];case"$id":return[`filter-id-${r}`,t];default:return[`filter-${r}`,e,t]}}function O0(e,t){if(t.length===0)return!1;switch(e){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(r=>typeof r!=typeof t[0])?["filter-in-large",e,["literal",t.sort(MS)]]:["filter-in-small",e,["literal",t]]}}function N0(e){switch(e){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",e]}}function tf(e){return["!",e]}function gg(e){return dg(ia(e.value))?Vl(na({},e,{expressionContext:"filter",valueSpec:e.styleSpec[`filter_${e.layerType||"fill"}`]})):z0(e)}function z0(e){const t=e.value,r=e.key;if(or(t)!=="array")return[new Vt(r,t,`array expected, ${or(t)} found`)];const n=e.styleSpec;let i,s=[];if(t.length<1)return[new Vt(r,t,"filter array must have at least 1 element")];switch(s=s.concat(Kp({key:`${r}[0]`,value:t[0],valueSpec:n.filter_operator,style:e.style,styleSpec:e.styleSpec})),jn(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&jn(t[1])==="$type"&&s.push(new Vt(r,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&s.push(new Vt(r,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(i=or(t[1]),i!=="string"&&s.push(new Vt(`${r}[1]`,t[1],`string expected, ${i} found`)));for(let a=2;a<t.length;a++)i=or(t[a]),jn(t[1])==="$type"?s=s.concat(Kp({key:`${r}[${a}]`,value:t[a],valueSpec:n.geometry_type,style:e.style,styleSpec:e.styleSpec})):i!=="string"&&i!=="number"&&i!=="boolean"&&s.push(new Vt(`${r}[${a}]`,t[a],`string, number, or boolean expected, ${i} found`));break;case"any":case"all":case"none":for(let a=1;a<t.length;a++)s=s.concat(z0({key:`${r}[${a}]`,value:t[a],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":i=or(t[1]),t.length!==2?s.push(new Vt(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):i!=="string"&&s.push(new Vt(`${r}[1]`,t[1],`string expected, ${i} found`))}return s}function k0(e,t){const r=e.key,n=e.style,i=e.layer,s=e.styleSpec,a=e.value,l=e.objectKey,p=s[`${t}_${e.layerType}`];if(!p)return[];const f=l.match(/^(.*)-transition$/);if(t==="paint"&&f&&p[f[1]]&&p[f[1]].transition)return ti({key:r,value:a,valueSpec:s.transition,style:n,styleSpec:s});const m=e.valueSpec||p[l];if(!m)return[new Vt(r,a,`unknown property "${l}"`)];let _;if(or(a)==="string"&&Bl(m)&&!m.tokens&&(_=/^{([^}]+)}$/.exec(a))){const v=`\`{ "type": "identity", "property": ${_?JSON.stringify(_[1]):'"_"'} }\``;return[new Vt(r,a,`"${l}" does not support interpolation syntax
Use an identity property function instead: ${v}.`)]}const y=[];if(e.layerType==="symbol")l==="text-field"&&n&&!n.glyphs&&y.push(new Vt(r,a,'use of "text-field" requires a style "glyphs" property')),l==="text-font"&&Xp(ia(a))&&jn(a.type)==="identity"&&y.push(new Vt(r,a,'"text-font" does not support identity functions'));else if(e.layerType==="model"&&t==="paint"&&i&&i.layout&&i.layout.hasOwnProperty("model-id")&&Bl(m)&&(T0(m)||ug(m))){const v=fg(ia(a),m),b=v.value.expression||v.value._styleExpression.expression;!b||zl(b,["zoom"])&&zl(b,["measure-light"])||y.push(new Vt(r,a,`${l} does not support zoom or measure-light expressions when the model layer source is vector tile or GeoJSON.`))}return y.concat(ti({key:e.key,value:a,valueSpec:m,style:n,styleSpec:s,expressionContext:"property",propertyType:t,propertyKey:l}))}function F0(e){return k0(e,"paint")}function B0(e){return k0(e,"layout")}function V0(e){let t=[];const r=e.value,n=e.key,i=e.style,s=e.styleSpec;r.type||r.ref||t.push(new Vt(n,r,'either "type" or "ref" is required'));let a=jn(r.type);const l=jn(r.ref);if(r.id){const p=jn(r.id);for(let f=0;f<e.arrayIndex;f++){const m=i.layers[f];jn(m.id)===p&&t.push(new Vt(n,r.id,`duplicate layer id "${r.id}", previously used at line ${m.id.__line__}`))}}if("ref"in r){let p;["type","source","source-layer","filter","layout"].forEach(f=>{f in r&&t.push(new Vt(n,r[f],`"${f}" is prohibited for ref layers`))}),i.layers.forEach(f=>{jn(f.id)===l&&(p=f)}),p?p.ref?t.push(new Vt(n,r.ref,"ref cannot reference another ref layer")):a=jn(p.type):typeof l=="string"&&t.push(new Vt(n,r.ref,`ref layer "${l}" not found`))}else if(a!=="background"&&a!=="sky"&&a!=="slot")if(r.source){const p=i.sources&&i.sources[r.source],f=p&&jn(p.type);p?f==="vector"&&a==="raster"?t.push(new Vt(n,r.source,`layer "${r.id}" requires a raster source`)):f==="raster"&&a!=="raster"?t.push(new Vt(n,r.source,`layer "${r.id}" requires a vector source`)):f!=="vector"||r["source-layer"]?f==="raster-dem"&&a!=="hillshade"?t.push(new Vt(n,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):a!=="line"||!r.paint||!r.paint["line-gradient"]&&!r.paint["line-trim-offset"]||f==="geojson"&&p.lineMetrics||t.push(new Vt(n,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new Vt(n,r,`layer "${r.id}" must specify a "source-layer"`)):t.push(new Vt(n,r.source,`source "${r.source}" not found`))}else t.push(new Vt(n,r,'missing required property "source"'));return t=t.concat(zo({key:n,value:r,valueSpec:s.layer,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ti({key:`${n}.type`,value:r.type,valueSpec:s.layer.type,style:e.style,styleSpec:e.styleSpec,object:r,objectKey:"type"}),filter:p=>gg(na({layerType:a},p)),layout:p=>zo({layer:r,key:p.key,value:p.value,valueSpec:{},style:p.style,styleSpec:p.styleSpec,objectElementValidators:{"*":f=>B0(na({layerType:a},f))}}),paint:p=>zo({layer:r,key:p.key,value:p.value,valueSpec:{},style:p.style,styleSpec:p.styleSpec,objectElementValidators:{"*":f=>F0(na({layerType:a,layer:r},f))}})}})),t}function Pu(e){const t=e.value,r=e.key,n=or(t);return n!=="string"?[new Vt(r,t,`string expected, ${n} found`)]:[]}const U0={promoteId:function({key:e,value:t}){if(or(t)==="string")return Pu({key:e,value:t});{const r=[];for(const n in t)r.push(...Pu({key:`${e}.${n}`,value:t[n]}));return r}}};function G0(e){const t=e.value,r=e.key,n=e.styleSpec,i=e.style;if(!t.type)return[new Vt(r,t,'"type" is required')];const s=jn(t.type);let a;switch(s){case"vector":case"raster":case"raster-dem":return a=zo({key:r,value:t,valueSpec:n[`source_${s.replace("-","_")}`],style:e.style,styleSpec:n,objectElementValidators:U0}),a;case"geojson":if(a=zo({key:r,value:t,valueSpec:n.source_geojson,style:i,styleSpec:n,objectElementValidators:U0}),t.cluster)for(const l in t.clusterProperties){const[p,f]=t.clusterProperties[l],m=typeof p=="string"?[p,["accumulated"],["get",l]]:p;a.push(...Vl({key:`${r}.${l}.map`,value:f,expressionContext:"cluster-map"})),a.push(...Vl({key:`${r}.${l}.reduce`,value:m,expressionContext:"cluster-reduce"}))}return a;case"video":return zo({key:r,value:t,valueSpec:n.source_video,style:i,styleSpec:n});case"image":return zo({key:r,value:t,valueSpec:n.source_image,style:i,styleSpec:n});case"canvas":return[new Vt(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Kp({key:`${r}.type`,value:t.type,valueSpec:{values:AS(n)},style:i,styleSpec:n})}}function AS(e){return e.source.reduce((t,r)=>{const n=e[r];return n.type.type==="enum"&&(t=t.concat(Object.keys(n.type.values))),t},[])}function j0(e){const t=e.value;let r=[];if(!t)return r;const n=or(t);return n!=="string"?(r=r.concat([new Vt(e.key,t,`string expected, "${n}" found`)]),r):(function(i){const s=i.indexOf("://")===-1;try{return new URL(i,s?"http://example.com":void 0),!0}catch{return!1}}(t)||(r=r.concat([new Vt(e.key,t,`invalid url "${t}"`)])),r)}function q0(e){const t=e.value,r=e.styleSpec,n=r.light,i=e.style;let s=[];const a=or(t);if(t===void 0)return s;if(a!=="object")return s=s.concat([new Vt("light",t,`object expected, ${a} found`)]),s;for(const l in t){const p=l.match(/^(.*)-transition$/);s=s.concat(p&&n[p[1]]&&n[p[1]].transition?ti({key:l,value:t[l],valueSpec:r.transition,style:i,styleSpec:r}):n[l]?ti({key:l,value:t[l],valueSpec:n[l],style:i,styleSpec:r}):[new Vt(l,t[l],`unknown property "${l}"`)])}return s}function Z0(e){const t=e.value;let r=[];if(!t)return r;const n=or(t);if(n!=="object")return r=r.concat([new Vt("light-3d",t,`object expected, ${n} found`)]),r;const i=e.styleSpec,s=i["light-3d"],a=e.style;for(const f of["type","id"])if(!(f in t))return r=r.concat([new Vt("light-3d",t,`missing property ${f} on light`)]),r;const l=`properties_light_${t.type}`;if(!(l in i))return r=r.concat([new Vt("light-3d",t,`Invalid light type ${t.type}`)]),r;const p=i[l];for(const f in t)if(f==="properties"){const m=t[f],_=or(m);if(_!=="object")return r=r.concat([new Vt("properties",m,`object expected, ${_} found`)]),r;for(const y in m)r=r.concat(ti({key:y,value:m[y],valueSpec:p[y],style:a,styleSpec:i}))}else{const m=f.match(/^(.*)-transition$/);r=r.concat(m&&s[m[1]]&&s[m[1]].transition?ti({key:f,value:t[f],valueSpec:i.transition,style:a,styleSpec:i}):s[f]?ti({key:f,value:t[f],valueSpec:s[f],style:a,styleSpec:i}):[new Vt(f,t[f],`unknown property "${f}"`)])}return r}function X0(e){const t=e.value,r=e.key,n=e.style,i=e.styleSpec,s=i.terrain;let a=[];const l=or(t);if(t===void 0)return a;if(l!=="object")return a=a.concat([new Vt("terrain",t,`object expected, ${l} found`)]),a;for(const p in t){const f=p.match(/^(.*)-transition$/);a=a.concat(f&&s[f[1]]&&s[f[1]].transition?ti({key:p,value:t[p],valueSpec:i.transition,style:n,styleSpec:i}):s[p]?ti({key:p,value:t[p],valueSpec:s[p],style:n,styleSpec:i}):[new Vt(p,t[p],`unknown property "${p}"`)])}if(t.source){const p=n.sources&&n.sources[t.source],f=p&&jn(p.type);p?f!=="raster-dem"&&a.push(new Vt(r,t.source,`terrain cannot be used with a source of type ${String(f)}, it only be used with a "raster-dem" source type`)):a.push(new Vt(r,t.source,`source "${t.source}" not found`))}else a.push(new Vt(r,t,'terrain is missing required property "source"'));return a}function W0(e){const t=e.value,r=e.style,n=e.styleSpec,i=n.fog;let s=[];const a=or(t);if(t===void 0)return s;if(a!=="object")return s=s.concat([new Vt("fog",t,`object expected, ${a} found`)]),s;for(const l in t){const p=l.match(/^(.*)-transition$/);s=s.concat(p&&i[p[1]]&&i[p[1]].transition?ti({key:l,value:t[l],valueSpec:n.transition,style:r,styleSpec:n}):i[l]?ti({key:l,value:t[l],valueSpec:i[l],style:r,styleSpec:n}):[new Vt(l,t[l],`unknown property "${l}"`)])}return s}const H0={"*":()=>[],array:C0,boolean:function(e){const t=e.value,r=e.key,n=or(t);return n!=="boolean"?[new Vt(r,t,`boolean expected, ${n} found`)]:[]},number:M0,color:function(e){const t=e.key,r=e.value,n=or(r);return n!=="string"?[new Vt(t,r,`color expected, ${n} found`)]:bm(r)===null?[new Vt(t,r,`color expected, "${r}" found`)]:[]},enum:Kp,filter:gg,function:A0,layer:V0,object:zo,source:G0,model:j0,light:q0,"light-3d":Z0,terrain:X0,fog:W0,string:Pu,formatted:function(e){return Pu(e).length===0?[]:Vl(e)},resolvedImage:function(e){return Pu(e).length===0?[]:Vl(e)},projection:function(e){const t=e.value,r=e.styleSpec,n=r.projection,i=e.style;let s=[];const a=or(t);if(a==="object")for(const l in t)s=s.concat(ti({key:l,value:t[l],valueSpec:n[l],style:i,styleSpec:r}));else a!=="string"&&(s=s.concat([new Vt("projection",t,`object or string expected, ${a} found`)]));return s},import:function(e){const{value:t,styleSpec:r}=e,{data:n,...i}=t;Object.defineProperty(i,"__line__",{value:t.__line__,enumerable:!1});let s=zo(na({},e,{value:i,valueSpec:r.import}));return n&&(s=s.concat(Y0(n,r,{key:`${e.key}.data`}))),s}};function ti(e,t=!1){const r=e.value,n=e.valueSpec,i=e.styleSpec;if(n.expression&&Xp(jn(r)))return A0(e);if(n.expression&&Wp(ia(r)))return Vl(e);if(n.type&&H0[n.type]){const s=H0[n.type](e);return t===!0&&s.length>0&&or(e.value)==="array"?Vl(e):s}return zo(na({},e,{valueSpec:n.type?i[n.type]:n}))}function PS(e){const t=e.value,r=e.key,n=Pu(e);return n.length||(t.indexOf("{fontstack}")===-1&&n.push(new Vt(r,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&n.push(new Vt(r,t,'"glyphs" url must include a "{range}" token'))),n}function Y0(e,t=rt,r={}){return ti({key:r.key||"",value:e,valueSpec:t.$root,styleSpec:t,style:e,objectElementValidators:{glyphs:PS,"*":()=>[]}})}function Lu(e,t=rt){return as(Y0(e,t))}const LS=e=>as(G0(e)),DS=e=>as(q0(e)),RS=e=>as(Z0(e)),OS=e=>as(X0(e)),NS=e=>as(W0(e)),zS=e=>as(V0(e)),_g=e=>as(gg(e)),kS=e=>as(F0(e)),FS=e=>as(B0(e)),BS=e=>as(j0(e));function as(e){return e.slice().sort((t,r)=>t.line&&r.line?t.line-r.line:0)}function ef(e,t){let r=!1;if(t&&t.length)for(const n of t)e.fire(new fe(new Error(n.message))),r=!0;return r}var VS=Rs,Ba=3;function Rs(e,t,r){var n=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;var i=new Int32Array(this.arrayBuffer);e=i[0],this.d=(t=i[1])+2*(r=i[2]);for(var s=0;s<this.d*this.d;s++){var a=i[Ba+s],l=i[Ba+s+1];n.push(a===l?null:i.subarray(a,l))}var p=i[Ba+n.length+1];this.keys=i.subarray(i[Ba+n.length],p),this.bboxes=i.subarray(p),this.insert=this._insertReadonly}else{this.d=t+2*r;for(var f=0;f<this.d*this.d;f++)n.push([]);this.keys=[],this.bboxes=[]}this.n=t,this.extent=e,this.padding=r,this.scale=t/e,this.uid=0;var m=r/t*e;this.min=-m,this.max=e+m}Rs.prototype.insert=function(e,t,r,n,i){this._forEachCell(t,r,n,i,this._insertCell,this.uid++),this.keys.push(e),this.bboxes.push(t),this.bboxes.push(r),this.bboxes.push(n),this.bboxes.push(i)},Rs.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Rs.prototype._insertCell=function(e,t,r,n,i,s){this.cells[i].push(s)},Rs.prototype.query=function(e,t,r,n,i){var s=this.min,a=this.max;if(e<=s&&t<=s&&a<=r&&a<=n&&!i)return Array.prototype.slice.call(this.keys);var l=[];return this._forEachCell(e,t,r,n,this._queryCell,l,{},i),l},Rs.prototype._queryCell=function(e,t,r,n,i,s,a,l){var p=this.cells[i];if(p!==null)for(var f=this.keys,m=this.bboxes,_=0;_<p.length;_++){var y=p[_];if(a[y]===void 0){var v=4*y;(l?l(m[v+0],m[v+1],m[v+2],m[v+3]):e<=m[v+2]&&t<=m[v+3]&&r>=m[v+0]&&n>=m[v+1])?(a[y]=!0,s.push(f[y])):a[y]=!1}}},Rs.prototype._forEachCell=function(e,t,r,n,i,s,a,l){for(var p=this._convertToCellCoord(e),f=this._convertToCellCoord(t),m=this._convertToCellCoord(r),_=this._convertToCellCoord(n),y=p;y<=m;y++)for(var v=f;v<=_;v++){var b=this.d*v+y;if((!l||l(this._convertFromCellCoord(y),this._convertFromCellCoord(v),this._convertFromCellCoord(y+1),this._convertFromCellCoord(v+1)))&&i.call(this,e,t,r,n,b,s,a,l))return}},Rs.prototype._convertFromCellCoord=function(e){return(e-this.padding)/this.scale},Rs.prototype._convertToCellCoord=function(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))},Rs.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var e=this.cells,t=Ba+this.cells.length+1+1,r=0,n=0;n<this.cells.length;n++)r+=this.cells[n].length;var i=new Int32Array(t+r+this.keys.length+this.bboxes.length);i[0]=this.extent,i[1]=this.n,i[2]=this.padding;for(var s=t,a=0;a<e.length;a++){var l=e[a];i[Ba+a]=s,i.set(l,s),s+=l.length}return i[Ba+e.length]=s,i.set(this.keys,s),i[Ba+e.length+1]=s+=this.keys.length,i.set(this.bboxes,s),s+=this.bboxes.length,i.buffer};var Du=Nt(VS);const rf={};function Ut(e,t,r={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writeable:!1}),rf[t]={klass:e,omit:r.omit||[]}}Ut(Object,"Object"),Du.serialize=function(e,t){const r=e.toArrayBuffer();return t&&t.push(r),{buffer:r}},Du.deserialize=function(e){return new Du(e.buffer)},Object.defineProperty(Du,"name",{value:"Grid"}),Ut(Du,"Grid"),Ut(Se,"Color"),Ut(Error,"Error"),Ut(vt,"AJAXError"),Ut(No,"ResolvedImage"),Ut(Yp,"StylePropertyFunction"),Ut(hg,"StyleExpression",{omit:["_evaluator"]}),Ut(Hp,"ZoomDependentExpression"),Ut(pg,"ZoomConstantExpression"),Ut(Ls,"CompoundExpression",{omit:["_evaluate"]});for(const e in ah)rf[ah[e]._classRegistryKey]||Ut(ah[e],`Expression${e}`);function $0(e){return e&&typeof ArrayBuffer<"u"&&(e instanceof ArrayBuffer||e.constructor&&e.constructor.name==="ArrayBuffer")}function K0(e){return S.ImageBitmap&&e instanceof S.ImageBitmap}function Ru(e,t){if(e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp)return e;if($0(e)||K0(e))return t&&t.push(e),e;if(ArrayBuffer.isView(e)){const r=e;return t&&t.push(r.buffer),r}if(e instanceof S.ImageData)return t&&t.push(e.data.buffer),e;if(Array.isArray(e)){const r=[];for(const n of e)r.push(Ru(n,t));return r}if(e instanceof Map){const r={$name:"Map"};for(const[n,i]of e.entries())r[n]=Ru(i);return r}if(typeof e=="object"){const r=e.constructor,n=r._classRegistryKey;if(!n)throw new Error(`can't serialize object of unregistered class ${n}`);const i=r.serialize?r.serialize(e,t):{};if(!r.serialize){for(const s in e)e.hasOwnProperty(s)&&(rf[n].omit.indexOf(s)>=0||(i[s]=Ru(e[s],t)));e instanceof Error&&(i.message=e.message)}if(i.$name)throw new Error("$name property is reserved for worker serialization logic.");return n!=="Object"&&(i.$name=n),i}throw new Error("can't serialize object of type "+typeof e)}function Ou(e){if(e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||$0(e)||K0(e)||ArrayBuffer.isView(e)||e instanceof S.ImageData)return e;if(Array.isArray(e))return e.map(Ou);if(typeof e=="object"){const t=e.$name||"Object";if(t==="Map"){const i=new Map;for(const s of Object.keys(e))s!=="$name"&&i.set(s,Ou(e[s]));return i}const{klass:r}=rf[t];if(!r)throw new Error(`can't deserialize unregistered class ${t}`);if(r.deserialize)return r.deserialize(e);const n=Object.create(r.prototype);for(const i of Object.keys(e))i!=="$name"&&(n[i]=Ou(e[i]));return n}throw new Error("can't deserialize object of type "+typeof e)}const Ht={"Latin-1 Supplement":e=>e>=128&&e<=255,Arabic:e=>e>=1536&&e<=1791,"Arabic Supplement":e=>e>=1872&&e<=1919,"Arabic Extended-A":e=>e>=2208&&e<=2303,"Hangul Jamo":e=>e>=4352&&e<=4607,"Unified Canadian Aboriginal Syllabics":e=>e>=5120&&e<=5759,Khmer:e=>e>=6016&&e<=6143,"Unified Canadian Aboriginal Syllabics Extended":e=>e>=6320&&e<=6399,"General Punctuation":e=>e>=8192&&e<=8303,"Letterlike Symbols":e=>e>=8448&&e<=8527,"Number Forms":e=>e>=8528&&e<=8591,"Miscellaneous Technical":e=>e>=8960&&e<=9215,"Control Pictures":e=>e>=9216&&e<=9279,"Optical Character Recognition":e=>e>=9280&&e<=9311,"Enclosed Alphanumerics":e=>e>=9312&&e<=9471,"Geometric Shapes":e=>e>=9632&&e<=9727,"Miscellaneous Symbols":e=>e>=9728&&e<=9983,"Miscellaneous Symbols and Arrows":e=>e>=11008&&e<=11263,"CJK Radicals Supplement":e=>e>=11904&&e<=12031,"Kangxi Radicals":e=>e>=12032&&e<=12255,"Ideographic Description Characters":e=>e>=12272&&e<=12287,"CJK Symbols and Punctuation":e=>e>=12288&&e<=12351,Hiragana:e=>e>=12352&&e<=12447,Katakana:e=>e>=12448&&e<=12543,Bopomofo:e=>e>=12544&&e<=12591,"Hangul Compatibility Jamo":e=>e>=12592&&e<=12687,Kanbun:e=>e>=12688&&e<=12703,"Bopomofo Extended":e=>e>=12704&&e<=12735,"CJK Strokes":e=>e>=12736&&e<=12783,"Katakana Phonetic Extensions":e=>e>=12784&&e<=12799,"Enclosed CJK Letters and Months":e=>e>=12800&&e<=13055,"CJK Compatibility":e=>e>=13056&&e<=13311,"CJK Unified Ideographs Extension A":e=>e>=13312&&e<=19903,"Yijing Hexagram Symbols":e=>e>=19904&&e<=19967,"CJK Unified Ideographs":e=>e>=19968&&e<=40959,"Yi Syllables":e=>e>=40960&&e<=42127,"Yi Radicals":e=>e>=42128&&e<=42191,"Hangul Jamo Extended-A":e=>e>=43360&&e<=43391,"Hangul Syllables":e=>e>=44032&&e<=55215,"Hangul Jamo Extended-B":e=>e>=55216&&e<=55295,"Private Use Area":e=>e>=57344&&e<=63743,"CJK Compatibility Ideographs":e=>e>=63744&&e<=64255,"Arabic Presentation Forms-A":e=>e>=64336&&e<=65023,"Vertical Forms":e=>e>=65040&&e<=65055,"CJK Compatibility Forms":e=>e>=65072&&e<=65103,"Small Form Variants":e=>e>=65104&&e<=65135,"Arabic Presentation Forms-B":e=>e>=65136&&e<=65279,"Halfwidth and Fullwidth Forms":e=>e>=65280&&e<=65519,"CJK Unified Ideographs Extension B":e=>e>=131072&&e<=173791};function yg(e){for(const t of e)if(vg(t.charCodeAt(0)))return!0;return!1}function US(e){for(const t of e)if(!GS(t.charCodeAt(0)))return!1;return!0}function GS(e){return!(Ht.Arabic(e)||Ht["Arabic Supplement"](e)||Ht["Arabic Extended-A"](e)||Ht["Arabic Presentation Forms-A"](e)||Ht["Arabic Presentation Forms-B"](e))}function vg(e){return!(e!==746&&e!==747&&(e<4352||!(Ht["Bopomofo Extended"](e)||Ht.Bopomofo(e)||Ht["CJK Compatibility Forms"](e)&&!(e>=65097&&e<=65103)||Ht["CJK Compatibility Ideographs"](e)||Ht["CJK Compatibility"](e)||Ht["CJK Radicals Supplement"](e)||Ht["CJK Strokes"](e)||!(!Ht["CJK Symbols and Punctuation"](e)||e>=12296&&e<=12305||e>=12308&&e<=12319||e===12336)||Ht["CJK Unified Ideographs Extension A"](e)||Ht["CJK Unified Ideographs"](e)||Ht["Enclosed CJK Letters and Months"](e)||Ht["Hangul Compatibility Jamo"](e)||Ht["Hangul Jamo Extended-A"](e)||Ht["Hangul Jamo Extended-B"](e)||Ht["Hangul Jamo"](e)||Ht["Hangul Syllables"](e)||Ht.Hiragana(e)||Ht["Ideographic Description Characters"](e)||Ht.Kanbun(e)||Ht["Kangxi Radicals"](e)||Ht["Katakana Phonetic Extensions"](e)||Ht.Katakana(e)&&e!==12540||!(!Ht["Halfwidth and Fullwidth Forms"](e)||e===65288||e===65289||e===65293||e>=65306&&e<=65310||e===65339||e===65341||e===65343||e>=65371&&e<=65503||e===65507||e>=65512&&e<=65519)||!(!Ht["Small Form Variants"](e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||Ht["Unified Canadian Aboriginal Syllabics"](e)||Ht["Unified Canadian Aboriginal Syllabics Extended"](e)||Ht["Vertical Forms"](e)||Ht["Yijing Hexagram Symbols"](e)||Ht["Yi Syllables"](e)||Ht["Yi Radicals"](e))))}function J0(e){return!(vg(e)||function(t){return!!(Ht["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||Ht["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||Ht["Letterlike Symbols"](t)||Ht["Number Forms"](t)||Ht["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||Ht["Control Pictures"](t)&&t!==9251||Ht["Optical Character Recognition"](t)||Ht["Enclosed Alphanumerics"](t)||Ht["Geometric Shapes"](t)||Ht["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||Ht["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Ht["CJK Symbols and Punctuation"](t)||Ht.Katakana(t)||Ht["Private Use Area"](t)||Ht["CJK Compatibility Forms"](t)||Ht["Small Form Variants"](t)||Ht["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(e))}function Q0(e){return e>=1424&&e<=2303||Ht["Arabic Presentation Forms-A"](e)||Ht["Arabic Presentation Forms-B"](e)}function jS(e,t){return!(!t&&Q0(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||Ht.Khmer(e))}function qS(e){for(const t of e)if(Q0(t.charCodeAt(0)))return!0;return!1}const xg="deferred",bg="loading",wg="loaded";let Eg=null,Yi="unavailable",Va=null;const tx=function(e){e&&typeof e=="string"&&e.indexOf("NetworkError")>-1&&(Yi="error"),Eg&&Eg(e)};function Tg(){Ig.fire(new wt("pluginStateChange",{pluginStatus:Yi,pluginURL:Va}))}const Ig=new hn,Sg=function(){return Yi},ex=function(){if(Yi!==xg||!Va)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Yi=bg,Tg(),Va&&Dt({url:Va},e=>{e?tx(e):(Yi=wg,Tg())})},ko={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Yi===wg||ko.applyArabicShaping!=null,isLoading:()=>Yi===bg,setState(e){Yi=e.pluginStatus,Va=e.pluginURL},isParsed:()=>ko.applyArabicShaping!=null&&ko.processBidirectionalText!=null&&ko.processStyledBidirectionalText!=null,getPluginURL:()=>Va};class jr{constructor(t,r){this.zoom=t,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.transition=r.transition,this.pitch=r.pitch,this.brightness=r.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(t){return function(r,n){for(const i of r)if(!jS(i.charCodeAt(0),n))return!1;return!0}(t,ko.isLoaded())}}class nf{constructor(t,r,n){this.property=t,this.value=r,this.expression=function(i,s,a){if(Xp(i))return new Yp(i,s);if(Wp(i)||Array.isArray(i)&&i.length>0){const l=fg(i,s,a);if(l.result==="error")throw new Error(l.value.map(p=>`${p.key}: ${p.message}`).join(", "));return l.value}{let l=i;return typeof i=="string"&&s.type==="color"&&(l=Se.parse(i)),{kind:"constant",isConfigDependent:!1,evaluate:()=>l}}}(r===void 0?t.specification.default:r,t.specification,n)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,r,n){return this.property.possiblyEvaluate(this,t,r,n)}}class Cg{constructor(t,r){this.property=t,this.value=new nf(t,void 0,r)}transitioned(t,r){return new rx(this.property,this.value,r,Yt({},t.transition,this.transition),t.now)}untransitioned(){return new rx(this.property,this.value,null,{},0)}}class uh{constructor(t,r){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues),this._options=r,this.isConfigDependent=!1}getValue(t){return j(this._values[t].value.value)}setValue(t,r){this._values.hasOwnProperty(t)||(this._values[t]=new Cg(this._values[t].property,this._options)),this._values[t].value=new nf(this._values[t].property,r===null?void 0:j(r),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].value.expression.isConfigDependent}setTransitionOrValue(t){if(t)for(const r in t){const n=t[r];_u(r,"-transition")?this.setTransition(r.slice(0,-11),n):this.setValue(r,n)}}getTransition(t){return j(this._values[t].transition)}setTransition(t,r){this._values.hasOwnProperty(t)||(this._values[t]=new Cg(this._values[t].property)),this._values[t].transition=j(r)||void 0}serialize(){const t={};for(const r of Object.keys(this._values)){const n=this.getValue(r);n!==void 0&&(t[r]=n);const i=this.getTransition(r);i!==void 0&&(t[`${r}-transition`]=i)}return t}transitioned(t,r){const n=new nx(this._properties);for(const i of Object.keys(this._values))n._values[i]=this._values[i].transitioned(t,r._values[i]);return n}untransitioned(){const t=new nx(this._properties);for(const r of Object.keys(this._values))t._values[r]=this._values[r].untransitioned();return t}}class rx{constructor(t,r,n,i,s){const a=i.delay||0,l=i.duration||0;s=s||0,this.property=t,this.value=r,this.begin=s+a,this.end=this.begin+l,t.specification.transition&&(i.delay||i.duration)&&(this.prior=n)}possiblyEvaluate(t,r,n){const i=t.now||0,s=this.value.possiblyEvaluate(t,r,n),a=this.prior;if(a){if(i>this.end)return this.prior=null,s;if(this.value.isDataDriven())return this.prior=null,s;if(i<this.begin)return a.possiblyEvaluate(t,r,n);{const l=(i-this.begin)/(this.end-this.begin);return this.property.interpolate(a.possiblyEvaluate(t,r,n),s,Sr(l))}}return s}}class nx{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,r,n){const i=new of(this._properties);for(const s of Object.keys(this._values))i._values[s]=this._values[s].possiblyEvaluate(t,r,n);return i}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class ZS{constructor(t,r){this._properties=t,this._values=Object.create(t.defaultPropertyValues),this._options=r,this.isConfigDependent=!1}getValue(t){return j(this._values[t].value)}setValue(t,r){this._values[t]=new nf(this._values[t].property,r===null?void 0:j(r),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].expression.isConfigDependent}serialize(){const t={};for(const r of Object.keys(this._values)){const n=this.getValue(r);n!==void 0&&(t[r]=n)}return t}possiblyEvaluate(t,r,n){const i=new of(this._properties);for(const s of Object.keys(this._values))i._values[s]=this._values[s].possiblyEvaluate(t,r,n);return i}}class Nu{constructor(t,r,n){this.property=t,this.value=r,this.parameters=n}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,r,n,i){return this.property.evaluate(this.value,this.parameters,t,r,n,i)}}class of{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class Tt{constructor(t){this.specification=t}possiblyEvaluate(t,r){return t.expression.evaluate(r)}interpolate(t,r,n){const i=Gp[this.specification.type];return i?i(t,r,n):t}}class te{constructor(t,r){this.specification=t,this.overrides=r}possiblyEvaluate(t,r,n,i){return new Nu(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(r,null,{},n,i)}:t.expression,r)}interpolate(t,r,n){if(t.value.kind!=="constant"||r.value.kind!=="constant")return t;if(t.value.value===void 0||r.value.value===void 0)return new Nu(this,{kind:"constant",value:void 0},t.parameters);const i=Gp[this.specification.type];return i?new Nu(this,{kind:"constant",value:i(t.value.value,r.value.value,n)},t.parameters):t}evaluate(t,r,n,i,s,a){return t.kind==="constant"?t.value:t.evaluate(r,n,i,s,a)}}class ch{constructor(t){this.specification=t}possiblyEvaluate(t,r,n,i){return!!t.expression.evaluate(r,null,{},n,i)}interpolate(){return!1}}class qr{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const r=new jr(0,{});for(const n in t){const i=t[n];i.specification.overridable&&this.overridableProperties.push(n);const s=this.defaultPropertyValues[n]=new nf(i,void 0),a=this.defaultTransitionablePropertyValues[n]=new Cg(i);this.defaultTransitioningPropertyValues[n]=a.untransitioned(),this.defaultPossiblyEvaluatedValues[n]=s.possiblyEvaluate(r)}}}function ix(e,t){return 256*(e=Bt(Math.floor(e),0,255))+Bt(Math.floor(t),0,255)}Ut(te,"DataDrivenProperty"),Ut(Tt,"DataConstantProperty"),Ut(ch,"ColorRampProperty");const XS={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class sf{constructor(t,r){this._structArray=t,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class kr{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,r){return t._trim(),r&&(t.isTransferred=!0,r.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const r=Object.create(this.prototype);return r.arrayBuffer=t.arrayBuffer,r.length=t.length,r.capacity=t.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Je(e,t=1){let r=0,n=0;return{members:e.map(i=>{const s=XS[i.type].BYTES_PER_ELEMENT,a=r=ox(r,Math.max(t,s)),l=i.components||1;return n=Math.max(n,s),r+=s*l,{name:i.name,type:i.type,components:l,offset:a}}),size:ox(r,Math.max(n,t)),alignment:t}}function ox(e,t){return Math.ceil(e/t)*t}class $i extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r){const n=this.length;return this.resize(n+1),this.emplace(n,t,r)}emplace(t,r,n){const i=2*t;return this.int16[i+0]=r,this.int16[i+1]=n,t}}$i.prototype.bytesPerElement=4,Ut($i,"StructArrayLayout2i4");class af extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,n){const i=this.length;return this.resize(i+1),this.emplace(i,t,r,n)}emplace(t,r,n,i){const s=3*t;return this.int16[s+0]=r,this.int16[s+1]=n,this.int16[s+2]=i,t}}af.prototype.bytesPerElement=6,Ut(af,"StructArrayLayout3i6");class Ua extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,n,i){const s=this.length;return this.resize(s+1),this.emplace(s,t,r,n,i)}emplace(t,r,n,i,s){const a=4*t;return this.int16[a+0]=r,this.int16[a+1]=n,this.int16[a+2]=i,this.int16[a+3]=s,t}}Ua.prototype.bytesPerElement=8,Ut(Ua,"StructArrayLayout4i8");class Mg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l){const p=this.length;return this.resize(p+1),this.emplace(p,t,r,n,i,s,a,l)}emplace(t,r,n,i,s,a,l,p){const f=6*t,m=12*t,_=3*t;return this.int16[f+0]=r,this.int16[f+1]=n,this.uint8[m+4]=i,this.uint8[m+5]=s,this.uint8[m+6]=a,this.uint8[m+7]=l,this.float32[_+2]=p,t}}Mg.prototype.bytesPerElement=12,Ut(Mg,"StructArrayLayout2i4ub1f12");class Ga extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i){const s=this.length;return this.resize(s+1),this.emplace(s,t,r,n,i)}emplace(t,r,n,i,s){const a=4*t;return this.float32[a+0]=r,this.float32[a+1]=n,this.float32[a+2]=i,this.float32[a+3]=s,t}}Ga.prototype.bytesPerElement=16,Ut(Ga,"StructArrayLayout4f16");class ja extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,t,r,n,i,s)}emplace(t,r,n,i,s,a){const l=6*t,p=3*t;return this.uint16[l+0]=r,this.uint16[l+1]=n,this.uint16[l+2]=i,this.uint16[l+3]=s,this.float32[p+2]=a,t}}ja.prototype.bytesPerElement=12,Ut(ja,"StructArrayLayout4ui1f12");class lf extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,n,i){const s=this.length;return this.resize(s+1),this.emplace(s,t,r,n,i)}emplace(t,r,n,i,s){const a=4*t;return this.uint16[a+0]=r,this.uint16[a+1]=n,this.uint16[a+2]=i,this.uint16[a+3]=s,t}}lf.prototype.bytesPerElement=8,Ut(lf,"StructArrayLayout4ui8");class uf extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,r,n,i,s,a)}emplace(t,r,n,i,s,a,l){const p=6*t;return this.int16[p+0]=r,this.int16[p+1]=n,this.int16[p+2]=i,this.int16[p+3]=s,this.int16[p+4]=a,this.int16[p+5]=l,t}}uf.prototype.bytesPerElement=12,Ut(uf,"StructArrayLayout6i12");class Ag extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l,p,f,m,_,y){const v=this.length;return this.resize(v+1),this.emplace(v,t,r,n,i,s,a,l,p,f,m,_,y)}emplace(t,r,n,i,s,a,l,p,f,m,_,y,v){const b=12*t;return this.int16[b+0]=r,this.int16[b+1]=n,this.int16[b+2]=i,this.int16[b+3]=s,this.uint16[b+4]=a,this.uint16[b+5]=l,this.uint16[b+6]=p,this.uint16[b+7]=f,this.int16[b+8]=m,this.int16[b+9]=_,this.int16[b+10]=y,this.int16[b+11]=v,t}}Ag.prototype.bytesPerElement=24,Ut(Ag,"StructArrayLayout4i4ui4i24");class Pg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,r,n,i,s,a)}emplace(t,r,n,i,s,a,l){const p=10*t,f=5*t;return this.int16[p+0]=r,this.int16[p+1]=n,this.int16[p+2]=i,this.float32[f+2]=s,this.float32[f+3]=a,this.float32[f+4]=l,t}}Pg.prototype.bytesPerElement=20,Ut(Pg,"StructArrayLayout3i3f20");class Lg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint32[1*t+0]=r,t}}Lg.prototype.bytesPerElement=4,Ut(Lg,"StructArrayLayout1ul4");class qa extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r){const n=this.length;return this.resize(n+1),this.emplace(n,t,r)}emplace(t,r,n){const i=2*t;return this.uint16[i+0]=r,this.uint16[i+1]=n,t}}qa.prototype.bytesPerElement=4,Ut(qa,"StructArrayLayout2ui4");class Dg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l,p,f,m,_,y,v){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,n,i,s,a,l,p,f,m,_,y,v)}emplace(t,r,n,i,s,a,l,p,f,m,_,y,v,b){const w=20*t,E=10*t;return this.int16[w+0]=r,this.int16[w+1]=n,this.int16[w+2]=i,this.int16[w+3]=s,this.int16[w+4]=a,this.float32[E+3]=l,this.float32[E+4]=p,this.float32[E+5]=f,this.float32[E+6]=m,this.int16[w+14]=_,this.uint32[E+8]=y,this.uint16[w+18]=v,this.uint16[w+19]=b,t}}Dg.prototype.bytesPerElement=40,Ut(Dg,"StructArrayLayout5i4f1i1ul2ui40");class cf extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l){const p=this.length;return this.resize(p+1),this.emplace(p,t,r,n,i,s,a,l)}emplace(t,r,n,i,s,a,l,p){const f=8*t;return this.int16[f+0]=r,this.int16[f+1]=n,this.int16[f+2]=i,this.int16[f+4]=s,this.int16[f+5]=a,this.int16[f+6]=l,this.int16[f+7]=p,t}}cf.prototype.bytesPerElement=16,Ut(cf,"StructArrayLayout3i2i2i16");class Rg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,t,r,n,i,s)}emplace(t,r,n,i,s,a){const l=4*t,p=8*t;return this.float32[l+0]=r,this.float32[l+1]=n,this.float32[l+2]=i,this.int16[p+6]=s,this.int16[p+7]=a,t}}Rg.prototype.bytesPerElement=16,Ut(Rg,"StructArrayLayout2f1f2i16");class Og extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i){const s=this.length;return this.resize(s+1),this.emplace(s,t,r,n,i)}emplace(t,r,n,i,s){const a=12*t,l=3*t;return this.uint8[a+0]=r,this.uint8[a+1]=n,this.float32[l+1]=i,this.float32[l+2]=s,t}}Og.prototype.bytesPerElement=12,Ut(Og,"StructArrayLayout2ub2f12");class Za extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n){const i=this.length;return this.resize(i+1),this.emplace(i,t,r,n)}emplace(t,r,n,i){const s=3*t;return this.float32[s+0]=r,this.float32[s+1]=n,this.float32[s+2]=i,t}}Za.prototype.bytesPerElement=12,Ut(Za,"StructArrayLayout3f12");class xn extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,n){const i=this.length;return this.resize(i+1),this.emplace(i,t,r,n)}emplace(t,r,n,i){const s=3*t;return this.uint16[s+0]=r,this.uint16[s+1]=n,this.uint16[s+2]=i,t}}xn.prototype.bytesPerElement=6,Ut(xn,"StructArrayLayout3ui6");class Ng extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C,M,A,P){const L=this.length;return this.resize(L+1),this.emplace(L,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C,M,A,P)}emplace(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C,M,A,P,L){const R=30*t,N=15*t,k=60*t;return this.int16[R+0]=r,this.int16[R+1]=n,this.int16[R+2]=i,this.float32[N+2]=s,this.float32[N+3]=a,this.uint16[R+8]=l,this.uint16[R+9]=p,this.uint32[N+5]=f,this.uint32[N+6]=m,this.uint32[N+7]=_,this.uint16[R+16]=y,this.uint16[R+17]=v,this.uint16[R+18]=b,this.float32[N+10]=w,this.float32[N+11]=E,this.uint8[k+48]=T,this.uint8[k+49]=C,this.uint8[k+50]=M,this.uint32[N+13]=A,this.int16[R+28]=P,this.uint8[k+58]=L,t}}Ng.prototype.bytesPerElement=60,Ut(Ng,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class zg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C,M,A,P,L,R,N,k,F,z,U,G,V,K){const $=this.length;return this.resize($+1),this.emplace($,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C,M,A,P,L,R,N,k,F,z,U,G,V,K)}emplace(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C,M,A,P,L,R,N,k,F,z,U,G,V,K,$){const tt=40*t,X=20*t,J=80*t;return this.int16[tt+0]=r,this.int16[tt+1]=n,this.int16[tt+2]=i,this.float32[X+2]=s,this.float32[X+3]=a,this.int16[tt+8]=l,this.int16[tt+9]=p,this.int16[tt+10]=f,this.int16[tt+11]=m,this.int16[tt+12]=_,this.int16[tt+13]=y,this.uint16[tt+14]=v,this.uint16[tt+15]=b,this.uint16[tt+16]=w,this.uint16[tt+17]=E,this.uint16[tt+18]=T,this.uint16[tt+19]=C,this.uint16[tt+20]=M,this.uint16[tt+21]=A,this.uint16[tt+22]=P,this.uint16[tt+23]=L,this.uint16[tt+24]=R,this.uint16[tt+25]=N,this.uint16[tt+26]=k,this.uint16[tt+27]=F,this.uint16[tt+28]=z,this.uint32[X+15]=U,this.float32[X+16]=G,this.float32[X+17]=V,this.float32[X+18]=K,this.uint8[J+76]=$,t}}zg.prototype.bytesPerElement=80,Ut(zg,"StructArrayLayout3i2f6i15ui1ul3f1ub80");class hf extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.float32[1*t+0]=r,t}}hf.prototype.bytesPerElement=4,Ut(hf,"StructArrayLayout1f4");class hh extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,t,r,n,i,s)}emplace(t,r,n,i,s,a){const l=5*t;return this.float32[l+0]=r,this.float32[l+1]=n,this.float32[l+2]=i,this.float32[l+3]=s,this.float32[l+4]=a,t}}hh.prototype.bytesPerElement=20,Ut(hh,"StructArrayLayout5f20");class kg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l){const p=this.length;return this.resize(p+1),this.emplace(p,t,r,n,i,s,a,l)}emplace(t,r,n,i,s,a,l,p){const f=7*t;return this.float32[f+0]=r,this.float32[f+1]=n,this.float32[f+2]=i,this.float32[f+3]=s,this.float32[f+4]=a,this.float32[f+5]=l,this.float32[f+6]=p,t}}kg.prototype.bytesPerElement=28,Ut(kg,"StructArrayLayout7f28");class Fg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,n,i){const s=this.length;return this.resize(s+1),this.emplace(s,t,r,n,i)}emplace(t,r,n,i,s){const a=6*t;return this.uint32[3*t+0]=r,this.uint16[a+2]=n,this.uint16[a+3]=i,this.uint16[a+4]=s,t}}Fg.prototype.bytesPerElement=12,Ut(Fg,"StructArrayLayout1ul3ui12");class ph extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint16[1*t+0]=r,t}}ph.prototype.bytesPerElement=2,Ut(ph,"StructArrayLayout1ui2");class fh extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r){const n=this.length;return this.resize(n+1),this.emplace(n,t,r)}emplace(t,r,n){const i=2*t;return this.float32[i+0]=r,this.float32[i+1]=n,t}}fh.prototype.bytesPerElement=8,Ut(fh,"StructArrayLayout2f8");class Bg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E){const T=this.length;return this.resize(T+1),this.emplace(T,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E)}emplace(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T){const C=16*t;return this.float32[C+0]=r,this.float32[C+1]=n,this.float32[C+2]=i,this.float32[C+3]=s,this.float32[C+4]=a,this.float32[C+5]=l,this.float32[C+6]=p,this.float32[C+7]=f,this.float32[C+8]=m,this.float32[C+9]=_,this.float32[C+10]=y,this.float32[C+11]=v,this.float32[C+12]=b,this.float32[C+13]=w,this.float32[C+14]=E,this.float32[C+15]=T,t}}Bg.prototype.bytesPerElement=64,Ut(Bg,"StructArrayLayout16f64");class pf extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,n,i,s,a,l){const p=this.length;return this.resize(p+1),this.emplace(p,t,r,n,i,s,a,l)}emplace(t,r,n,i,s,a,l,p){const f=10*t,m=5*t;return this.uint16[f+0]=r,this.uint16[f+1]=n,this.uint16[f+2]=i,this.uint16[f+3]=s,this.float32[m+2]=a,this.float32[m+3]=l,this.float32[m+4]=p,t}}pf.prototype.bytesPerElement=20,Ut(pf,"StructArrayLayout4ui3f20");class Vg extends kr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint8[1*t+0]=r,t}}Vg.prototype.bytesPerElement=1,Ut(Vg,"StructArrayLayout1ub1");class sx extends sf{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}sx.prototype.size=40;class Ug extends Dg{get(t){return new sx(this,t)}}Ut(Ug,"CollisionBoxArray");class ax extends sf{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}ax.prototype.size=60;class lx extends Ng{get(t){return new ax(this,t)}}Ut(lx,"PlacedSymbolArray");class ux extends sf{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(t){this._structArray.uint32[this._pos4+15]=t}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}ux.prototype.size=80;class cx extends zg{get(t){return new ux(this,t)}}Ut(cx,"SymbolInstanceArray");class hx extends hf{getoffsetX(t){return this.float32[1*t+0]}}Ut(hx,"GlyphOffsetArray");class px extends $i{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}Ut(px,"SymbolLineVertexArray");class fx extends sf{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}fx.prototype.size=12;class dx extends Fg{get(t){return new fx(this,t)}}Ut(dx,"FeatureIndexArray");class mx extends qa{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}Ut(mx,"FillExtrusionCentroidArray");const WS=Je([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),HS=Je([{name:"a_dash",components:4,type:"Uint16"}]);var ff={exports:{}},gx={exports:{}};(function(e){e.exports=function(t,r){var n,i,s,a,l,p,f,m;for(i=t.length-(n=3&t.length),s=r,l=3432918353,p=461845907,m=0;m<i;)f=255&t.charCodeAt(m)|(255&t.charCodeAt(++m))<<8|(255&t.charCodeAt(++m))<<16|(255&t.charCodeAt(++m))<<24,++m,s=27492+(65535&(a=5*(65535&(s=(s^=f=(65535&(f=(f=(65535&f)*l+(((f>>>16)*l&65535)<<16)&4294967295)<<15|f>>>17))*p+(((f>>>16)*p&65535)<<16)&4294967295)<<13|s>>>19))+((5*(s>>>16)&65535)<<16)&4294967295))+((58964+(a>>>16)&65535)<<16);switch(f=0,n){case 3:f^=(255&t.charCodeAt(m+2))<<16;case 2:f^=(255&t.charCodeAt(m+1))<<8;case 1:s^=f=(65535&(f=(f=(65535&(f^=255&t.charCodeAt(m)))*l+(((f>>>16)*l&65535)<<16)&4294967295)<<15|f>>>17))*p+(((f>>>16)*p&65535)<<16)&4294967295}return s^=t.length,s=2246822507*(65535&(s^=s>>>16))+((2246822507*(s>>>16)&65535)<<16)&4294967295,s=3266489909*(65535&(s^=s>>>13))+((3266489909*(s>>>16)&65535)<<16)&4294967295,(s^=s>>>16)>>>0}})(gx);var YS=gx.exports,_x={exports:{}};(function(e){e.exports=function(t,r){for(var n,i=t.length,s=r^i,a=0;i>=4;)n=1540483477*(65535&(n=255&t.charCodeAt(a)|(255&t.charCodeAt(++a))<<8|(255&t.charCodeAt(++a))<<16|(255&t.charCodeAt(++a))<<24))+((1540483477*(n>>>16)&65535)<<16),s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16)^(n=1540483477*(65535&(n^=n>>>24))+((1540483477*(n>>>16)&65535)<<16)),i-=4,++a;switch(i){case 3:s^=(255&t.charCodeAt(a+2))<<16;case 2:s^=(255&t.charCodeAt(a+1))<<8;case 1:s=1540483477*(65535&(s^=255&t.charCodeAt(a)))+((1540483477*(s>>>16)&65535)<<16)}return s=1540483477*(65535&(s^=s>>>13))+((1540483477*(s>>>16)&65535)<<16),(s^=s>>>15)>>>0}})(_x);var yx=YS,$S=_x.exports;ff.exports=yx,ff.exports.murmur3=yx,ff.exports.murmur2=$S;var Gg=Nt(ff.exports);class df{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(t,r,n,i){this.ids.push(vx(t)),this.positions.push(r,n,i)}eachPosition(t,r){const n=vx(t);let i=0,s=this.ids.length-1;for(;i<s;){const a=i+s>>1;this.ids[a]>=n?s=a:i=a+1}for(;this.ids[i]===n;)r(this.positions[3*i],this.positions[3*i+1],this.positions[3*i+2]),i++}static serialize(t,r){const n=new Float64Array(t.ids),i=new Uint32Array(t.positions);return jg(n,i,0,n.length-1),r&&r.push(n.buffer,i.buffer),{ids:n,positions:i}}static deserialize(t){const r=new df;let n;r.ids=t.ids,r.positions=t.positions;for(const i of r.ids)i!==n&&r.uniqueIds.push(i),n=i;return r.indexed=!0,r}}function vx(e){const t=+e;return!isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:Gg(String(e))}function jg(e,t,r,n){for(;r<n;){const i=e[r+n>>1];let s=r-1,a=n+1;for(;;){do s++;while(e[s]<i);do a--;while(e[a]>i);if(s>=a)break;mf(e,s,a),mf(t,3*s,3*a),mf(t,3*s+1,3*a+1),mf(t,3*s+2,3*a+2)}a-r<n-a?(jg(e,t,r,a),r=a+1):(jg(e,t,a+1,n),n=a)}}function mf(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}Ut(df,"FeaturePositionMap");class aa{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,r){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,r),this.initialized=!0),!!this.location}}class Pe extends aa{constructor(t){super(t),this.current=0}set(t,r,n){this.fetchUniformLocation(t,r)&&this.current!==n&&(this.current=n,this.gl.uniform1i(this.location,n))}}class Et extends aa{constructor(t){super(t),this.current=0}set(t,r,n){this.fetchUniformLocation(t,r)&&this.current!==n&&(this.current=n,this.gl.uniform1f(this.location,n))}}class Fe extends aa{constructor(t){super(t),this.current=[0,0]}set(t,r,n){this.fetchUniformLocation(t,r)&&(n[0]===this.current[0]&&n[1]===this.current[1]||(this.current=n,this.gl.uniform2f(this.location,n[0],n[1])))}}class _e extends aa{constructor(t){super(t),this.current=[0,0,0]}set(t,r,n){this.fetchUniformLocation(t,r)&&(n[0]===this.current[0]&&n[1]===this.current[1]&&n[2]===this.current[2]||(this.current=n,this.gl.uniform3f(this.location,n[0],n[1],n[2])))}}class fo extends aa{constructor(t){super(t),this.current=[0,0,0,0]}set(t,r,n){this.fetchUniformLocation(t,r)&&(n[0]===this.current[0]&&n[1]===this.current[1]&&n[2]===this.current[2]&&n[3]===this.current[3]||(this.current=n,this.gl.uniform4f(this.location,n[0],n[1],n[2],n[3])))}}class zu extends aa{constructor(t){super(t),this.current=Se.transparent}set(t,r,n){this.fetchUniformLocation(t,r)&&(n.r===this.current.r&&n.g===this.current.g&&n.b===this.current.b&&n.a===this.current.a||(this.current=n,this.gl.uniform4f(this.location,n.r,n.g,n.b,n.a)))}}const KS=new Float32Array(16);class ve extends aa{constructor(t){super(t),this.current=KS}set(t,r,n){if(this.fetchUniformLocation(t,r)){if(n[12]!==this.current[12]||n[0]!==this.current[0])return this.current=n,void this.gl.uniformMatrix4fv(this.location,!1,n);for(let i=1;i<16;i++)if(n[i]!==this.current[i]){this.current=n,this.gl.uniformMatrix4fv(this.location,!1,n);break}}}}const JS=new Float32Array(9);class xx extends aa{constructor(t){super(t),this.current=JS}set(t,r,n){if(this.fetchUniformLocation(t,r)){for(let i=0;i<9;i++)if(n[i]!==this.current[i]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}}const QS=new Float32Array(4);class qg extends aa{constructor(t){super(t),this.current=QS}set(t,r,n){if(this.fetchUniformLocation(t,r)){for(let i=0;i<4;i++)if(n[i]!==this.current[i]){this.current=n,this.gl.uniformMatrix2fv(this.location,!1,n);break}}}}function Zg(e){return[ix(255*e.r,255*e.g),ix(255*e.b,255*e.a)]}class dh{constructor(t,r,n){this.value=t,this.uniformNames=r.map(i=>`u_${i}`),this.type=n}setUniform(t,r,n,i,s){r.set(t,s,i.constantOr(this.value))}getBinding(t,r){return this.type==="color"?new zu(t):new Et(t)}}class ku{constructor(t,r){this.uniformNames=r.map(n=>`u_${n}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(t){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br)}setUniform(t,r,n,i,s){const a=s==="u_pattern"||s==="u_dash"?this.pattern:s==="u_pixel_ratio"?this.pixelRatio:null;a&&r.set(t,s,a)}getBinding(t,r){return r==="u_pattern"||r==="u_dash"?new fo(t):new Et(t)}}class la{constructor(t,r,n,i){this.expression=t,this.type=n,this.maxValue=0,this.paintVertexAttributes=r.map(s=>({name:`a_${s}`,type:"Float32",components:n==="color"?2:1,offset:0})),this.paintVertexArray=new i}populatePaintArray(t,r,n,i,s,a,l){const p=this.paintVertexArray.length,f=this.expression.evaluate(new jr(0,{brightness:a}),r,{},s,i,l);this.paintVertexArray.resize(t),this._setPaintValue(p,t,f)}updatePaintArray(t,r,n,i,s,a,l){const p=this.expression.evaluate({zoom:0,brightness:l},n,i,void 0,s);this._setPaintValue(t,r,p)}_setPaintValue(t,r,n){if(this.type==="color"){const i=Zg(n);for(let s=t;s<r;s++)this.paintVertexArray.emplace(s,i[0],i[1])}else{for(let i=t;i<r;i++)this.paintVertexArray.emplace(i,n);this.maxValue=Math.max(this.maxValue,Math.abs(n))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ls{constructor(t,r,n,i,s,a){this.expression=t,this.uniformNames=r.map(l=>`u_${l}_t`),this.type=n,this.useIntegerZoom=i,this.zoom=s,this.maxValue=0,this.paintVertexAttributes=r.map(l=>({name:`a_${l}`,type:"Float32",components:n==="color"?4:2,offset:0})),this.paintVertexArray=new a}populatePaintArray(t,r,n,i,s,a,l){const p=this.expression.evaluate(new jr(this.zoom,{brightness:a}),r,{},s,i,l),f=this.expression.evaluate(new jr(this.zoom+1,{brightness:a}),r,{},s,i,l),m=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(m,t,p,f)}updatePaintArray(t,r,n,i,s,a,l){const p=this.expression.evaluate({zoom:this.zoom,brightness:l},n,i,void 0,s),f=this.expression.evaluate({zoom:this.zoom+1,brightness:l},n,i,void 0,s);this._setPaintValue(t,r,p,f)}_setPaintValue(t,r,n,i){if(this.type==="color"){const s=Zg(n),a=Zg(i);for(let l=t;l<r;l++)this.paintVertexArray.emplace(l,s[0],s[1],a[0],a[1])}else{for(let s=t;s<r;s++)this.paintVertexArray.emplace(s,n,i);this.maxValue=Math.max(this.maxValue,Math.abs(n),Math.abs(i))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,r,n,i,s){const a=this.useIntegerZoom?Math.floor(n.zoom):n.zoom,l=Bt(this.expression.interpolationFactor(a,this.zoom,this.zoom+1),0,1);r.set(t,s,l)}getBinding(t,r){return new Et(t)}}class Xa{constructor(t,r,n,i,s){this.expression=t,this.layerId=s,this.paintVertexAttributes=(n==="array"?HS:WS).members;for(let a=0;a<r.length;++a);this.paintVertexArray=new i}populatePaintArray(t,r,n){const i=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(i,t,r.patterns&&r.patterns[this.layerId],n)}updatePaintArray(t,r,n,i,s,a,l){this._setPaintValues(t,r,n.patterns&&n.patterns[this.layerId],a)}_setPaintValues(t,r,n,i){if(!i||!n)return;const s=i[n];if(!s)return;const{tl:a,br:l,pixelRatio:p}=s;for(let f=t;f<r;f++)this.paintVertexArray.emplace(f,a[0],a[1],l[0],l[1],p)}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Wa{constructor(t,r,n=()=>!0){this.binders={},this._buffers=[];const i=[];for(const s in t.paint._values){if(!n(s))continue;const a=t.paint.get(s);if(!(a instanceof Nu&&Bl(a.property.specification)))continue;const l=eC(s,t.type),p=a.value,f=a.property.specification.type,m=!!a.property.useIntegerZoom,_=s==="line-dasharray"||s.endsWith("pattern"),y=s==="line-dasharray"&&t.layout.get("line-cap").value.kind!=="constant";if(p.kind!=="constant"||y)if(p.kind==="source"||y||_){const v=bx(s,f,"source");this.binders[s]=_?new Xa(p,l,f,v,t.id):new la(p,l,f,v),i.push(`/a_${s}`)}else{const v=bx(s,f,"composite");this.binders[s]=new ls(p,l,f,m,r,v),i.push(`/z_${s}`)}else this.binders[s]=_?new ku(p.value,l):new dh(p.value,l,f),i.push(`/u_${s}`)}this.cacheKey=i.sort().join("")}getMaxValue(t){const r=this.binders[t];return r instanceof la||r instanceof ls?r.maxValue:0}populatePaintArrays(t,r,n,i,s,a,l){for(const p in this.binders){const f=this.binders[p];(f instanceof la||f instanceof ls||f instanceof Xa)&&f.populatePaintArray(t,r,n,i,s,a,l)}}setConstantPatternPositions(t){for(const r in this.binders){const n=this.binders[r];n instanceof ku&&n.setConstantPatternPositions(t)}}updatePaintArrays(t,r,n,i,s,a,l){let p=!1;const f=Object.keys(t),m=f.length===0?r.uniqueIds:f;if(m.length===0)return!1;for(const _ in this.binders){const y=this.binders[_];if((y instanceof la||y instanceof ls||y instanceof Xa)&&(y.expression.isStateDependent===!0||y.expression.isLightConstant===!1)){const v=i.paint.get(_);y.expression=v.value;for(const b of m){const w=t[b.toString()];r.eachPosition(b,(E,T,C)=>{const M=n.feature(E);y.updatePaintArray(T,C,M,w,s,a,l)})}p=!0}}return p}defines(){const t=[];for(const r in this.binders){const n=this.binders[r];(n instanceof dh||n instanceof ku)&&t.push(...n.uniformNames.map(i=>`#define HAS_UNIFORM_${i}`))}return t}getBinderAttributes(){const t=[];for(const r in this.binders){const n=this.binders[r];if(n instanceof la||n instanceof ls||n instanceof Xa)for(let i=0;i<n.paintVertexAttributes.length;i++)t.push(n.paintVertexAttributes[i].name)}return t}getBinderUniforms(){const t=[];for(const r in this.binders){const n=this.binders[r];if(n instanceof dh||n instanceof ku||n instanceof ls)for(const i of n.uniformNames)t.push(i)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const r=[];for(const n in this.binders){const i=this.binders[n];if(i instanceof dh||i instanceof ku||i instanceof ls)for(const s of i.uniformNames)r.push({name:s,property:n,binding:i.getBinding(t,s)})}return r}setUniforms(t,r,n,i,s){for(const{name:a,property:l,binding:p}of n)this.binders[l].setUniform(t,p,s,i.get(l),a)}updatePaintBuffers(){this._buffers=[];for(const t in this.binders){const r=this.binders[t];(r instanceof la||r instanceof ls||r instanceof Xa)&&r.paintVertexBuffer&&this._buffers.push(r.paintVertexBuffer)}}upload(t){for(const r in this.binders){const n=this.binders[r];(n instanceof la||n instanceof ls||n instanceof Xa)&&n.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const r=this.binders[t];(r instanceof la||r instanceof ls||r instanceof Xa)&&r.destroy()}}}class Ha{constructor(t,r,n=()=>!0){this.programConfigurations={};for(const i of t)this.programConfigurations[i.id]=new Wa(i,r,n);this.needsUpload=!1,this._featureMap=new df,this._bufferOffset=0}populatePaintArrays(t,r,n,i,s,a,l,p){for(const f in this.programConfigurations)this.programConfigurations[f].populatePaintArrays(t,r,i,s,a,l,p);r.id!==void 0&&this._featureMap.add(r.id,n,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,r,n,i,s,a){for(const l of n)this.needsUpload=this.programConfigurations[l.id].updatePaintArrays(t,this._featureMap,r,l,i,s,a||0)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const tC={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function eC(e,t){return tC[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")]}const rC={"line-pattern":{source:ja,composite:ja},"fill-pattern":{source:ja,composite:ja},"fill-extrusion-pattern":{source:ja,composite:ja},"line-dasharray":{source:lf,composite:lf}},nC={color:{source:fh,composite:Ga},number:{source:hf,composite:fh}};function bx(e,t,r){const n=rC[e];return n&&n[r]||nC[t][r]}Ut(dh,"ConstantBinder"),Ut(ku,"PatternConstantBinder"),Ut(la,"SourceExpressionBinder"),Ut(Xa,"PatternCompositeBinder"),Ut(ls,"CompositeExpressionBinder"),Ut(Wa,"ProgramConfiguration",{omit:["_buffers"]}),Ut(Ha,"ProgramConfigurationSet");const wx="-transition";class mo extends hn{constructor(t,r,n){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&t.type!=="sky"&&t.type!=="slot"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),this.options=n,t.slot&&(this.slot=t.slot),r.layout&&(this._unevaluatedLayout=new ZS(r.layout,n),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),r.paint)){this._transitionablePaint=new uh(r.paint,n);for(const i in t.paint)this.setPaintProperty(i,t.paint[i],{validate:!1});for(const i in t.layout)this.setLayoutProperty(i,t.layout[i],{validate:!1});this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new of(r.paint)}}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,r,n={}){r!=null&&this._validate(FS,`layers.${this.id}.layout.${t}`,t,r,n)||(this._unevaluatedLayout.setValue(t,r),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent,t==="visibility"&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})))}getPaintProperty(t){return _u(t,wx)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,r,n={}){if(r!=null&&this._validate(kS,`layers.${this.id}.paint.${t}`,t,r,n))return!1;if(_u(t,wx))return this._transitionablePaint.setTransition(t.slice(0,-11),r||void 0),!1;{const i=this._transitionablePaint._values[t],s=i.value.isDataDriven(),a=i.value;this._transitionablePaint.setValue(t,r),this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._handleSpecialPaintPropertyUpdate(t);const l=this._transitionablePaint._values[t].value,p=l.isDataDriven(),f=_u(t,"pattern")||t==="line-dasharray";return p||s||f||this._handleOverridablePaintPropertyUpdate(t,a,l)}}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getProgramConfiguration(t){return null}_handleOverridablePaintPropertyUpdate(t,r,n){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,r){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,r)}serialize(){return St({id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(t,r)=>!(t===void 0||r==="layout"&&!Object.keys(t).length||r==="paint"&&!Object.keys(t).length))}_validate(t,r,n,i,s={}){return(!s||s.validate!==!1)&&ef(this,t.call(Lu,{key:r,layerType:this.type,objectKey:n,value:i,styleSpec:rt,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}hasLightBeamPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const r=this.paint.get(t);if(r instanceof Nu&&Bl(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Jp(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const iC=Je([{name:"a_pos",components:2,type:"Int16"}],4),oC=Je([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class mr{constructor(t=[]){this.segments=t}prepareSegment(t,r,n,i){let s=this.segments[this.segments.length-1];return t>mr.MAX_VERTEX_ARRAY_LENGTH&&Y(`Max vertices per segment is ${mr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!s||s.vertexLength+t>mr.MAX_VERTEX_ARRAY_LENGTH||s.sortKey!==i)&&(s={vertexOffset:r.length,primitiveOffset:n.length,vertexLength:0,primitiveLength:0},i!==void 0&&(s.sortKey=i),this.segments.push(s)),s}get(){return this.segments}destroy(){for(const t of this.segments)for(const r in t.vaos)t.vaos[r].destroy()}static simpleSegment(t,r,n,i){return new mr([{vertexOffset:t,primitiveOffset:r,vertexLength:n,primitiveLength:i,vaos:{},sortKey:0}])}}mr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ut(mr,"SegmentVector");class go{constructor(t,r){t&&(r?this.setSouthWest(t).setNorthEast(r):t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof se?new se(t.lng,t.lat):se.convert(t),this}setSouthWest(t){return this._sw=t instanceof se?new se(t.lng,t.lat):se.convert(t),this}extend(t){const r=this._sw,n=this._ne;let i,s;if(t instanceof se)i=t,s=t;else{if(!(t instanceof go))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(go.convert(t)):this.extend(se.convert(t)):typeof t=="object"&&t!==null&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(se.convert(t)):this;if(i=t._sw,s=t._ne,!i||!s)return this}return r||n?(r.lng=Math.min(i.lng,r.lng),r.lat=Math.min(i.lat,r.lat),n.lng=Math.max(s.lng,n.lng),n.lat=Math.max(s.lat,n.lat)):(this._sw=new se(i.lng,i.lat),this._ne=new se(s.lng,s.lat)),this}getCenter(){return new se((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new se(this.getWest(),this.getNorth())}getSouthEast(){return new se(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:r,lat:n}=se.convert(t);let i=this._sw.lng<=r&&r<=this._ne.lng;return this._sw.lng>this._ne.lng&&(i=this._sw.lng>=r&&r>=this._ne.lng),this._sw.lat<=n&&n<=this._ne.lat&&i}static convert(t){return!t||t instanceof go?t:new go(t)}}var Rn={},On={};Object.defineProperty(On,"__esModule",{value:!0}),On.setMatrixArrayType=function(e){On.ARRAY_TYPE=Tx=e},On.toRadian=function(e){return e*aC},On.equals=function(e,t){return Math.abs(e-t)<=Ex*Math.max(1,Math.abs(e),Math.abs(t))},On.RANDOM=On.ARRAY_TYPE=On.EPSILON=void 0;var Ex=1e-6;On.EPSILON=Ex;var Tx=typeof Float32Array<"u"?Float32Array:Array;On.ARRAY_TYPE=Tx;var sC=Math.random;On.RANDOM=sC;var aC=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Nr={};function Xg(e){return Xg=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Xg(e)}Object.defineProperty(Nr,"__esModule",{value:!0}),Nr.create=function(){var e=new Ya.ARRAY_TYPE(4);return Ya.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},Nr.clone=function(e){var t=new Ya.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Nr.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Nr.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},Nr.fromValues=function(e,t,r,n){var i=new Ya.ARRAY_TYPE(4);return i[0]=e,i[1]=t,i[2]=r,i[3]=n,i},Nr.set=function(e,t,r,n,i){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e},Nr.transpose=function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},Nr.invert=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r*s-i*n;return a?(e[0]=s*(a=1/a),e[1]=-n*a,e[2]=-i*a,e[3]=r*a,e):null},Nr.adjoint=function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},Nr.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},Nr.multiply=Sx,Nr.rotate=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=Math.sin(r),p=Math.cos(r);return e[0]=n*p+s*l,e[1]=i*p+a*l,e[2]=n*-l+s*p,e[3]=i*-l+a*p,e},Nr.scale=function(e,t,r){var n=t[1],i=t[2],s=t[3],a=r[0],l=r[1];return e[0]=t[0]*a,e[1]=n*a,e[2]=i*l,e[3]=s*l,e},Nr.fromRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=-r,e[3]=n,e},Nr.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},Nr.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},Nr.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3])},Nr.LDU=function(e,t,r,n){return e[2]=n[2]/n[0],r[0]=n[0],r[1]=n[1],r[3]=n[3]-e[2]*r[1],[e,t,r]},Nr.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},Nr.subtract=Cx,Nr.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},Nr.equals=function(e,t){var r=e[0],n=e[1],i=e[2],s=e[3],a=t[0],l=t[1],p=t[2],f=t[3];return Math.abs(r-a)<=Ya.EPSILON*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-l)<=Ya.EPSILON*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(i-p)<=Ya.EPSILON*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(s-f)<=Ya.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))},Nr.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},Nr.multiplyScalarAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e},Nr.sub=Nr.mul=void 0;var Ya=function(e,t){if(e&&e.__esModule)return e;if(e===null||Xg(e)!=="object"&&typeof e!="function")return{default:e};var r=Ix(void 0);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(On);function Ix(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(Ix=function(n){return n?r:t})(e)}function Sx(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=r[0],p=r[1],f=r[2],m=r[3];return e[0]=n*l+s*p,e[1]=i*l+a*p,e[2]=n*f+s*m,e[3]=i*f+a*m,e}function Cx(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}Nr.mul=Sx,Nr.sub=Cx;var Fr={};function Wg(e){return Wg=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Wg(e)}Object.defineProperty(Fr,"__esModule",{value:!0}),Fr.create=function(){var e=new Os.ARRAY_TYPE(6);return Os.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},Fr.clone=function(e){var t=new Os.ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},Fr.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},Fr.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},Fr.fromValues=function(e,t,r,n,i,s){var a=new Os.ARRAY_TYPE(6);return a[0]=e,a[1]=t,a[2]=r,a[3]=n,a[4]=i,a[5]=s,a},Fr.set=function(e,t,r,n,i,s,a){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e},Fr.invert=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],l=t[5],p=r*s-n*i;return p?(e[0]=s*(p=1/p),e[1]=-n*p,e[2]=-i*p,e[3]=r*p,e[4]=(i*l-s*a)*p,e[5]=(n*a-r*l)*p,e):null},Fr.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},Fr.multiply=Ax,Fr.rotate=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=Math.sin(r),m=Math.cos(r);return e[0]=n*m+s*f,e[1]=i*m+a*f,e[2]=n*-f+s*m,e[3]=i*-f+a*m,e[4]=l,e[5]=p,e},Fr.scale=function(e,t,r){var n=t[1],i=t[2],s=t[3],a=t[4],l=t[5],p=r[0],f=r[1];return e[0]=t[0]*p,e[1]=n*p,e[2]=i*f,e[3]=s*f,e[4]=a,e[5]=l,e},Fr.translate=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=r[0],m=r[1];return e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=n*f+s*m+l,e[5]=i*f+a*m+p,e},Fr.fromRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=-r,e[3]=n,e[4]=0,e[5]=0,e},Fr.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},Fr.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},Fr.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},Fr.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},Fr.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e},Fr.subtract=Px,Fr.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e},Fr.multiplyScalarAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e[4]=t[4]+r[4]*n,e[5]=t[5]+r[5]*n,e},Fr.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},Fr.equals=function(e,t){var r=e[0],n=e[1],i=e[2],s=e[3],a=e[4],l=e[5],p=t[0],f=t[1],m=t[2],_=t[3],y=t[4],v=t[5];return Math.abs(r-p)<=Os.EPSILON*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(n-f)<=Os.EPSILON*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(i-m)<=Os.EPSILON*Math.max(1,Math.abs(i),Math.abs(m))&&Math.abs(s-_)<=Os.EPSILON*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(a-y)<=Os.EPSILON*Math.max(1,Math.abs(a),Math.abs(y))&&Math.abs(l-v)<=Os.EPSILON*Math.max(1,Math.abs(l),Math.abs(v))},Fr.sub=Fr.mul=void 0;var Os=function(e,t){if(e&&e.__esModule)return e;if(e===null||Wg(e)!=="object"&&typeof e!="function")return{default:e};var r=Mx(void 0);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(On);function Mx(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(Mx=function(n){return n?r:t})(e)}function Ax(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=r[0],m=r[1],_=r[2],y=r[3],v=r[4],b=r[5];return e[0]=n*f+s*m,e[1]=i*f+a*m,e[2]=n*_+s*y,e[3]=i*_+a*y,e[4]=n*v+s*b+l,e[5]=i*v+a*b+p,e}function Px(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e}Fr.mul=Ax,Fr.sub=Px;var ur={};function Hg(e){return Hg=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Hg(e)}Object.defineProperty(ur,"__esModule",{value:!0}),ur.create=function(){var e=new _o.ARRAY_TYPE(9);return _o.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e},ur.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},ur.clone=function(e){var t=new _o.ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},ur.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},ur.fromValues=function(e,t,r,n,i,s,a,l,p){var f=new _o.ARRAY_TYPE(9);return f[0]=e,f[1]=t,f[2]=r,f[3]=n,f[4]=i,f[5]=s,f[6]=a,f[7]=l,f[8]=p,f},ur.set=function(e,t,r,n,i,s,a,l,p,f){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e[6]=l,e[7]=p,e[8]=f,e},ur.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},ur.transpose=function(e,t){if(e===t){var r=t[1],n=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},ur.invert=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],l=t[5],p=t[6],f=t[7],m=t[8],_=m*a-l*f,y=-m*s+l*p,v=f*s-a*p,b=r*_+n*y+i*v;return b?(e[0]=_*(b=1/b),e[1]=(-m*n+i*f)*b,e[2]=(l*n-i*a)*b,e[3]=y*b,e[4]=(m*r-i*p)*b,e[5]=(-l*r+i*s)*b,e[6]=v*b,e[7]=(-f*r+n*p)*b,e[8]=(a*r-n*s)*b,e):null},ur.adjoint=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],l=t[5],p=t[6],f=t[7],m=t[8];return e[0]=a*m-l*f,e[1]=i*f-n*m,e[2]=n*l-i*a,e[3]=l*p-s*m,e[4]=r*m-i*p,e[5]=i*s-r*l,e[6]=s*f-a*p,e[7]=n*p-r*f,e[8]=r*a-n*s,e},ur.determinant=function(e){var t=e[3],r=e[4],n=e[5],i=e[6],s=e[7],a=e[8];return e[0]*(a*r-n*s)+e[1]*(-a*t+n*i)+e[2]*(s*t-r*i)},ur.multiply=Dx,ur.translate=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=t[8],y=r[0],v=r[1];return e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=l,e[5]=p,e[6]=y*n+v*a+f,e[7]=y*i+v*l+m,e[8]=y*s+v*p+_,e},ur.rotate=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=t[8],y=Math.sin(r),v=Math.cos(r);return e[0]=v*n+y*a,e[1]=v*i+y*l,e[2]=v*s+y*p,e[3]=v*a-y*n,e[4]=v*l-y*i,e[5]=v*p-y*s,e[6]=f,e[7]=m,e[8]=_,e},ur.scale=function(e,t,r){var n=r[0],i=r[1];return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=i*t[3],e[4]=i*t[4],e[5]=i*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},ur.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},ur.fromRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=-r,e[4]=n,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},ur.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},ur.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},ur.fromQuat=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r+r,l=n+n,p=i+i,f=r*a,m=n*a,_=n*l,y=i*a,v=i*l,b=i*p,w=s*a,E=s*l,T=s*p;return e[0]=1-_-b,e[3]=m-T,e[6]=y+E,e[1]=m+T,e[4]=1-f-b,e[7]=v-w,e[2]=y-E,e[5]=v+w,e[8]=1-f-_,e},ur.normalFromMat4=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],l=t[5],p=t[6],f=t[7],m=t[8],_=t[9],y=t[10],v=t[11],b=t[12],w=t[13],E=t[14],T=t[15],C=r*l-n*a,M=r*p-i*a,A=r*f-s*a,P=n*p-i*l,L=n*f-s*l,R=i*f-s*p,N=m*w-_*b,k=m*E-y*b,F=m*T-v*b,z=_*E-y*w,U=_*T-v*w,G=y*T-v*E,V=C*G-M*U+A*z+P*F-L*k+R*N;return V?(e[0]=(l*G-p*U+f*z)*(V=1/V),e[1]=(p*F-a*G-f*k)*V,e[2]=(a*U-l*F+f*N)*V,e[3]=(i*U-n*G-s*z)*V,e[4]=(r*G-i*F+s*k)*V,e[5]=(n*F-r*U-s*N)*V,e[6]=(w*R-E*L+T*P)*V,e[7]=(E*A-b*R-T*M)*V,e[8]=(b*L-w*A+T*C)*V,e):null},ur.projection=function(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},ur.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},ur.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},ur.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e},ur.subtract=Rx,ur.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e},ur.multiplyScalarAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e[4]=t[4]+r[4]*n,e[5]=t[5]+r[5]*n,e[6]=t[6]+r[6]*n,e[7]=t[7]+r[7]*n,e[8]=t[8]+r[8]*n,e},ur.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},ur.equals=function(e,t){var r=e[0],n=e[1],i=e[2],s=e[3],a=e[4],l=e[5],p=e[6],f=e[7],m=e[8],_=t[0],y=t[1],v=t[2],b=t[3],w=t[4],E=t[5],T=t[6],C=t[7],M=t[8];return Math.abs(r-_)<=_o.EPSILON*Math.max(1,Math.abs(r),Math.abs(_))&&Math.abs(n-y)<=_o.EPSILON*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(i-v)<=_o.EPSILON*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(s-b)<=_o.EPSILON*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(a-w)<=_o.EPSILON*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(l-E)<=_o.EPSILON*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(p-T)<=_o.EPSILON*Math.max(1,Math.abs(p),Math.abs(T))&&Math.abs(f-C)<=_o.EPSILON*Math.max(1,Math.abs(f),Math.abs(C))&&Math.abs(m-M)<=_o.EPSILON*Math.max(1,Math.abs(m),Math.abs(M))},ur.sub=ur.mul=void 0;var _o=function(e,t){if(e&&e.__esModule)return e;if(e===null||Hg(e)!=="object"&&typeof e!="function")return{default:e};var r=Lx(void 0);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(On);function Lx(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(Lx=function(n){return n?r:t})(e)}function Dx(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=t[8],y=r[0],v=r[1],b=r[2],w=r[3],E=r[4],T=r[5],C=r[6],M=r[7],A=r[8];return e[0]=y*n+v*a+b*f,e[1]=y*i+v*l+b*m,e[2]=y*s+v*p+b*_,e[3]=w*n+E*a+T*f,e[4]=w*i+E*l+T*m,e[5]=w*s+E*p+T*_,e[6]=C*n+M*a+A*f,e[7]=C*i+M*l+A*m,e[8]=C*s+M*p+A*_,e}function Rx(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}ur.mul=Dx,ur.sub=Rx;var xe={};function Yg(e){return Yg=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Yg(e)}Object.defineProperty(xe,"__esModule",{value:!0}),xe.create=function(){var e=new Hr.ARRAY_TYPE(16);return Hr.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},xe.clone=function(e){var t=new Hr.ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},xe.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},xe.fromValues=function(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w){var E=new Hr.ARRAY_TYPE(16);return E[0]=e,E[1]=t,E[2]=r,E[3]=n,E[4]=i,E[5]=s,E[6]=a,E[7]=l,E[8]=p,E[9]=f,E[10]=m,E[11]=_,E[12]=y,E[13]=v,E[14]=b,E[15]=w,E},xe.set=function(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e[6]=l,e[7]=p,e[8]=f,e[9]=m,e[10]=_,e[11]=y,e[12]=v,e[13]=b,e[14]=w,e[15]=E,e},xe.identity=Nx,xe.transpose=function(e,t){if(e===t){var r=t[1],n=t[2],i=t[3],s=t[6],a=t[7],l=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=s,e[11]=t[14],e[12]=i,e[13]=a,e[14]=l}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},xe.invert=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],l=t[5],p=t[6],f=t[7],m=t[8],_=t[9],y=t[10],v=t[11],b=t[12],w=t[13],E=t[14],T=t[15],C=r*l-n*a,M=r*p-i*a,A=r*f-s*a,P=n*p-i*l,L=n*f-s*l,R=i*f-s*p,N=m*w-_*b,k=m*E-y*b,F=m*T-v*b,z=_*E-y*w,U=_*T-v*w,G=y*T-v*E,V=C*G-M*U+A*z+P*F-L*k+R*N;return V?(e[0]=(l*G-p*U+f*z)*(V=1/V),e[1]=(i*U-n*G-s*z)*V,e[2]=(w*R-E*L+T*P)*V,e[3]=(y*L-_*R-v*P)*V,e[4]=(p*F-a*G-f*k)*V,e[5]=(r*G-i*F+s*k)*V,e[6]=(E*A-b*R-T*M)*V,e[7]=(m*R-y*A+v*M)*V,e[8]=(a*U-l*F+f*N)*V,e[9]=(n*F-r*U-s*N)*V,e[10]=(b*L-w*A+T*C)*V,e[11]=(_*A-m*L-v*C)*V,e[12]=(l*k-a*z-p*N)*V,e[13]=(r*z-n*k+i*N)*V,e[14]=(w*M-b*P-E*C)*V,e[15]=(m*P-_*M+y*C)*V,e):null},xe.adjoint=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],l=t[5],p=t[6],f=t[7],m=t[8],_=t[9],y=t[10],v=t[11],b=t[12],w=t[13],E=t[14],T=t[15];return e[0]=l*(y*T-v*E)-_*(p*T-f*E)+w*(p*v-f*y),e[1]=-(n*(y*T-v*E)-_*(i*T-s*E)+w*(i*v-s*y)),e[2]=n*(p*T-f*E)-l*(i*T-s*E)+w*(i*f-s*p),e[3]=-(n*(p*v-f*y)-l*(i*v-s*y)+_*(i*f-s*p)),e[4]=-(a*(y*T-v*E)-m*(p*T-f*E)+b*(p*v-f*y)),e[5]=r*(y*T-v*E)-m*(i*T-s*E)+b*(i*v-s*y),e[6]=-(r*(p*T-f*E)-a*(i*T-s*E)+b*(i*f-s*p)),e[7]=r*(p*v-f*y)-a*(i*v-s*y)+m*(i*f-s*p),e[8]=a*(_*T-v*w)-m*(l*T-f*w)+b*(l*v-f*_),e[9]=-(r*(_*T-v*w)-m*(n*T-s*w)+b*(n*v-s*_)),e[10]=r*(l*T-f*w)-a*(n*T-s*w)+b*(n*f-s*l),e[11]=-(r*(l*v-f*_)-a*(n*v-s*_)+m*(n*f-s*l)),e[12]=-(a*(_*E-y*w)-m*(l*E-p*w)+b*(l*y-p*_)),e[13]=r*(_*E-y*w)-m*(n*E-i*w)+b*(n*y-i*_),e[14]=-(r*(l*E-p*w)-a*(n*E-i*w)+b*(n*p-i*l)),e[15]=r*(l*y-p*_)-a*(n*y-i*_)+m*(n*p-i*l),e},xe.determinant=function(e){var t=e[0],r=e[1],n=e[2],i=e[3],s=e[4],a=e[5],l=e[6],p=e[7],f=e[8],m=e[9],_=e[10],y=e[11],v=e[12],b=e[13],w=e[14],E=e[15];return(t*a-r*s)*(_*E-y*w)-(t*l-n*s)*(m*E-y*b)+(t*p-i*s)*(m*w-_*b)+(r*l-n*a)*(f*E-y*v)-(r*p-i*a)*(f*w-_*v)+(n*p-i*l)*(f*b-m*v)},xe.multiply=zx,xe.translate=function(e,t,r){var n,i,s,a,l,p,f,m,_,y,v,b,w=r[0],E=r[1],T=r[2];return t===e?(e[12]=t[0]*w+t[4]*E+t[8]*T+t[12],e[13]=t[1]*w+t[5]*E+t[9]*T+t[13],e[14]=t[2]*w+t[6]*E+t[10]*T+t[14],e[15]=t[3]*w+t[7]*E+t[11]*T+t[15]):(i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=t[8],y=t[9],v=t[10],b=t[11],e[0]=n=t[0],e[1]=i,e[2]=s,e[3]=a,e[4]=l,e[5]=p,e[6]=f,e[7]=m,e[8]=_,e[9]=y,e[10]=v,e[11]=b,e[12]=n*w+l*E+_*T+t[12],e[13]=i*w+p*E+y*T+t[13],e[14]=s*w+f*E+v*T+t[14],e[15]=a*w+m*E+b*T+t[15]),e},xe.scale=function(e,t,r){var n=r[0],i=r[1],s=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},xe.rotate=function(e,t,r,n){var i,s,a,l,p,f,m,_,y,v,b,w,E,T,C,M,A,P,L,R,N,k,F,z,U=n[0],G=n[1],V=n[2],K=Math.hypot(U,G,V);return K<Hr.EPSILON?null:(U*=K=1/K,G*=K,V*=K,i=Math.sin(r),s=Math.cos(r),p=t[1],f=t[2],m=t[3],y=t[5],v=t[6],b=t[7],E=t[9],T=t[10],C=t[11],L=U*G*(a=1-s)-V*i,R=G*G*a+s,N=V*G*a+U*i,k=U*V*a+G*i,F=G*V*a-U*i,z=V*V*a+s,e[0]=(l=t[0])*(M=U*U*a+s)+(_=t[4])*(A=G*U*a+V*i)+(w=t[8])*(P=V*U*a-G*i),e[1]=p*M+y*A+E*P,e[2]=f*M+v*A+T*P,e[3]=m*M+b*A+C*P,e[4]=l*L+_*R+w*N,e[5]=p*L+y*R+E*N,e[6]=f*L+v*R+T*N,e[7]=m*L+b*R+C*N,e[8]=l*k+_*F+w*z,e[9]=p*k+y*F+E*z,e[10]=f*k+v*F+T*z,e[11]=m*k+b*F+C*z,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},xe.rotateX=function(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[4],a=t[5],l=t[6],p=t[7],f=t[8],m=t[9],_=t[10],y=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*i+f*n,e[5]=a*i+m*n,e[6]=l*i+_*n,e[7]=p*i+y*n,e[8]=f*i-s*n,e[9]=m*i-a*n,e[10]=_*i-l*n,e[11]=y*i-p*n,e},xe.rotateY=function(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[0],a=t[1],l=t[2],p=t[3],f=t[8],m=t[9],_=t[10],y=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i-f*n,e[1]=a*i-m*n,e[2]=l*i-_*n,e[3]=p*i-y*n,e[8]=s*n+f*i,e[9]=a*n+m*i,e[10]=l*n+_*i,e[11]=p*n+y*i,e},xe.rotateZ=function(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[0],a=t[1],l=t[2],p=t[3],f=t[4],m=t[5],_=t[6],y=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i+f*n,e[1]=a*i+m*n,e[2]=l*i+_*n,e[3]=p*i+y*n,e[4]=f*i-s*n,e[5]=m*i-a*n,e[6]=_*i-l*n,e[7]=y*i-p*n,e},xe.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},xe.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},xe.fromRotation=function(e,t,r){var n,i,s,a=r[0],l=r[1],p=r[2],f=Math.hypot(a,l,p);return f<Hr.EPSILON?null:(a*=f=1/f,l*=f,p*=f,n=Math.sin(t),i=Math.cos(t),e[0]=a*a*(s=1-i)+i,e[1]=l*a*s+p*n,e[2]=p*a*s-l*n,e[3]=0,e[4]=a*l*s-p*n,e[5]=l*l*s+i,e[6]=p*l*s+a*n,e[7]=0,e[8]=a*p*s+l*n,e[9]=l*p*s-a*n,e[10]=p*p*s+i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},xe.fromXRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},xe.fromYRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},xe.fromZRotation=function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},xe.fromRotationTranslation=kx,xe.fromQuat2=function(e,t){var r=new Hr.ARRAY_TYPE(3),n=-t[0],i=-t[1],s=-t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=n*n+i*i+s*s+a*a;return _>0?(r[0]=2*(l*a+m*n+p*s-f*i)/_,r[1]=2*(p*a+m*i+f*n-l*s)/_,r[2]=2*(f*a+m*s+l*i-p*n)/_):(r[0]=2*(l*a+m*n+p*s-f*i),r[1]=2*(p*a+m*i+f*n-l*s),r[2]=2*(f*a+m*s+l*i-p*n)),kx(e,t,r),e},xe.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},xe.getScaling=Fx,xe.getRotation=function(e,t){var r=new Hr.ARRAY_TYPE(3);Fx(r,t);var n=1/r[0],i=1/r[1],s=1/r[2],a=t[0]*n,l=t[1]*i,p=t[2]*s,f=t[4]*n,m=t[5]*i,_=t[6]*s,y=t[8]*n,v=t[9]*i,b=t[10]*s,w=a+m+b,E=0;return w>0?(E=2*Math.sqrt(w+1),e[3]=.25*E,e[0]=(_-v)/E,e[1]=(y-p)/E,e[2]=(l-f)/E):a>m&&a>b?(E=2*Math.sqrt(1+a-m-b),e[3]=(_-v)/E,e[0]=.25*E,e[1]=(l+f)/E,e[2]=(y+p)/E):m>b?(E=2*Math.sqrt(1+m-a-b),e[3]=(y-p)/E,e[0]=(l+f)/E,e[1]=.25*E,e[2]=(_+v)/E):(E=2*Math.sqrt(1+b-a-m),e[3]=(l-f)/E,e[0]=(y+p)/E,e[1]=(_+v)/E,e[2]=.25*E),e},xe.fromRotationTranslationScale=function(e,t,r,n){var i=t[0],s=t[1],a=t[2],l=t[3],p=i+i,f=s+s,m=a+a,_=i*p,y=i*f,v=i*m,b=s*f,w=s*m,E=a*m,T=l*p,C=l*f,M=l*m,A=n[0],P=n[1],L=n[2];return e[0]=(1-(b+E))*A,e[1]=(y+M)*A,e[2]=(v-C)*A,e[3]=0,e[4]=(y-M)*P,e[5]=(1-(_+E))*P,e[6]=(w+T)*P,e[7]=0,e[8]=(v+C)*L,e[9]=(w-T)*L,e[10]=(1-(_+b))*L,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},xe.fromRotationTranslationScaleOrigin=function(e,t,r,n,i){var s=t[0],a=t[1],l=t[2],p=t[3],f=s+s,m=a+a,_=l+l,y=s*f,v=s*m,b=s*_,w=a*m,E=a*_,T=l*_,C=p*f,M=p*m,A=p*_,P=n[0],L=n[1],R=n[2],N=i[0],k=i[1],F=i[2],z=(1-(w+T))*P,U=(v+A)*P,G=(b-M)*P,V=(v-A)*L,K=(1-(y+T))*L,$=(E+C)*L,tt=(b+M)*R,X=(E-C)*R,J=(1-(y+w))*R;return e[0]=z,e[1]=U,e[2]=G,e[3]=0,e[4]=V,e[5]=K,e[6]=$,e[7]=0,e[8]=tt,e[9]=X,e[10]=J,e[11]=0,e[12]=r[0]+N-(z*N+V*k+tt*F),e[13]=r[1]+k-(U*N+K*k+X*F),e[14]=r[2]+F-(G*N+$*k+J*F),e[15]=1,e},xe.fromQuat=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r+r,l=n+n,p=i+i,f=r*a,m=n*a,_=n*l,y=i*a,v=i*l,b=i*p,w=s*a,E=s*l,T=s*p;return e[0]=1-_-b,e[1]=m+T,e[2]=y-E,e[3]=0,e[4]=m-T,e[5]=1-f-b,e[6]=v+w,e[7]=0,e[8]=y+E,e[9]=v-w,e[10]=1-f-_,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},xe.frustum=function(e,t,r,n,i,s,a){var l=1/(r-t),p=1/(i-n),f=1/(s-a);return e[0]=2*s*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*s*p,e[6]=0,e[7]=0,e[8]=(r+t)*l,e[9]=(i+n)*p,e[10]=(a+s)*f,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*s*2*f,e[15]=0,e},xe.perspectiveNO=Bx,xe.perspectiveZO=function(e,t,r,n,i){var s,a=1/Math.tan(t/2);return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0?(e[10]=i*(s=1/(n-i)),e[14]=i*n*s):(e[10]=-1,e[14]=-n),e},xe.perspectiveFromFieldOfView=function(e,t,r,n){var i=Math.tan(t.upDegrees*Math.PI/180),s=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),l=Math.tan(t.rightDegrees*Math.PI/180),p=2/(a+l),f=2/(i+s);return e[0]=p,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=f,e[6]=0,e[7]=0,e[8]=-(a-l)*p*.5,e[9]=(i-s)*f*.5,e[10]=n/(r-n),e[11]=-1,e[12]=0,e[13]=0,e[14]=n*r/(r-n),e[15]=0,e},xe.orthoNO=Vx,xe.orthoZO=function(e,t,r,n,i,s,a){var l=1/(t-r),p=1/(n-i),f=1/(s-a);return e[0]=-2*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*p,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=f,e[11]=0,e[12]=(t+r)*l,e[13]=(i+n)*p,e[14]=s*f,e[15]=1,e},xe.lookAt=function(e,t,r,n){var i,s,a,l,p,f,m,_,y,v,b=t[0],w=t[1],E=t[2],T=n[0],C=n[1],M=n[2],A=r[0],P=r[1],L=r[2];return Math.abs(b-A)<Hr.EPSILON&&Math.abs(w-P)<Hr.EPSILON&&Math.abs(E-L)<Hr.EPSILON?Nx(e):(m=b-A,_=w-P,y=E-L,i=C*(y*=v=1/Math.hypot(m,_,y))-M*(_*=v),s=M*(m*=v)-T*y,a=T*_-C*m,(v=Math.hypot(i,s,a))?(i*=v=1/v,s*=v,a*=v):(i=0,s=0,a=0),l=_*a-y*s,p=y*i-m*a,f=m*s-_*i,(v=Math.hypot(l,p,f))?(l*=v=1/v,p*=v,f*=v):(l=0,p=0,f=0),e[0]=i,e[1]=l,e[2]=m,e[3]=0,e[4]=s,e[5]=p,e[6]=_,e[7]=0,e[8]=a,e[9]=f,e[10]=y,e[11]=0,e[12]=-(i*b+s*w+a*E),e[13]=-(l*b+p*w+f*E),e[14]=-(m*b+_*w+y*E),e[15]=1,e)},xe.targetTo=function(e,t,r,n){var i=t[0],s=t[1],a=t[2],l=n[0],p=n[1],f=n[2],m=i-r[0],_=s-r[1],y=a-r[2],v=m*m+_*_+y*y;v>0&&(m*=v=1/Math.sqrt(v),_*=v,y*=v);var b=p*y-f*_,w=f*m-l*y,E=l*_-p*m;return(v=b*b+w*w+E*E)>0&&(b*=v=1/Math.sqrt(v),w*=v,E*=v),e[0]=b,e[1]=w,e[2]=E,e[3]=0,e[4]=_*E-y*w,e[5]=y*b-m*E,e[6]=m*w-_*b,e[7]=0,e[8]=m,e[9]=_,e[10]=y,e[11]=0,e[12]=i,e[13]=s,e[14]=a,e[15]=1,e},xe.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},xe.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},xe.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e[9]=t[9]+r[9],e[10]=t[10]+r[10],e[11]=t[11]+r[11],e[12]=t[12]+r[12],e[13]=t[13]+r[13],e[14]=t[14]+r[14],e[15]=t[15]+r[15],e},xe.subtract=Ux,xe.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12]*r,e[13]=t[13]*r,e[14]=t[14]*r,e[15]=t[15]*r,e},xe.multiplyScalarAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e[4]=t[4]+r[4]*n,e[5]=t[5]+r[5]*n,e[6]=t[6]+r[6]*n,e[7]=t[7]+r[7]*n,e[8]=t[8]+r[8]*n,e[9]=t[9]+r[9]*n,e[10]=t[10]+r[10]*n,e[11]=t[11]+r[11]*n,e[12]=t[12]+r[12]*n,e[13]=t[13]+r[13]*n,e[14]=t[14]+r[14]*n,e[15]=t[15]+r[15]*n,e},xe.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},xe.equals=function(e,t){var r=e[0],n=e[1],i=e[2],s=e[3],a=e[4],l=e[5],p=e[6],f=e[7],m=e[8],_=e[9],y=e[10],v=e[11],b=e[12],w=e[13],E=e[14],T=e[15],C=t[0],M=t[1],A=t[2],P=t[3],L=t[4],R=t[5],N=t[6],k=t[7],F=t[8],z=t[9],U=t[10],G=t[11],V=t[12],K=t[13],$=t[14],tt=t[15];return Math.abs(r-C)<=Hr.EPSILON*Math.max(1,Math.abs(r),Math.abs(C))&&Math.abs(n-M)<=Hr.EPSILON*Math.max(1,Math.abs(n),Math.abs(M))&&Math.abs(i-A)<=Hr.EPSILON*Math.max(1,Math.abs(i),Math.abs(A))&&Math.abs(s-P)<=Hr.EPSILON*Math.max(1,Math.abs(s),Math.abs(P))&&Math.abs(a-L)<=Hr.EPSILON*Math.max(1,Math.abs(a),Math.abs(L))&&Math.abs(l-R)<=Hr.EPSILON*Math.max(1,Math.abs(l),Math.abs(R))&&Math.abs(p-N)<=Hr.EPSILON*Math.max(1,Math.abs(p),Math.abs(N))&&Math.abs(f-k)<=Hr.EPSILON*Math.max(1,Math.abs(f),Math.abs(k))&&Math.abs(m-F)<=Hr.EPSILON*Math.max(1,Math.abs(m),Math.abs(F))&&Math.abs(_-z)<=Hr.EPSILON*Math.max(1,Math.abs(_),Math.abs(z))&&Math.abs(y-U)<=Hr.EPSILON*Math.max(1,Math.abs(y),Math.abs(U))&&Math.abs(v-G)<=Hr.EPSILON*Math.max(1,Math.abs(v),Math.abs(G))&&Math.abs(b-V)<=Hr.EPSILON*Math.max(1,Math.abs(b),Math.abs(V))&&Math.abs(w-K)<=Hr.EPSILON*Math.max(1,Math.abs(w),Math.abs(K))&&Math.abs(E-$)<=Hr.EPSILON*Math.max(1,Math.abs(E),Math.abs($))&&Math.abs(T-tt)<=Hr.EPSILON*Math.max(1,Math.abs(T),Math.abs(tt))},xe.sub=xe.mul=xe.ortho=xe.perspective=void 0;var Hr=function(e,t){if(e&&e.__esModule)return e;if(e===null||Yg(e)!=="object"&&typeof e!="function")return{default:e};var r=Ox(void 0);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(On);function Ox(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(Ox=function(n){return n?r:t})(e)}function Nx(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function zx(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=t[8],y=t[9],v=t[10],b=t[11],w=t[12],E=t[13],T=t[14],C=t[15],M=r[0],A=r[1],P=r[2],L=r[3];return e[0]=M*n+A*l+P*_+L*w,e[1]=M*i+A*p+P*y+L*E,e[2]=M*s+A*f+P*v+L*T,e[3]=M*a+A*m+P*b+L*C,e[4]=(M=r[4])*n+(A=r[5])*l+(P=r[6])*_+(L=r[7])*w,e[5]=M*i+A*p+P*y+L*E,e[6]=M*s+A*f+P*v+L*T,e[7]=M*a+A*m+P*b+L*C,e[8]=(M=r[8])*n+(A=r[9])*l+(P=r[10])*_+(L=r[11])*w,e[9]=M*i+A*p+P*y+L*E,e[10]=M*s+A*f+P*v+L*T,e[11]=M*a+A*m+P*b+L*C,e[12]=(M=r[12])*n+(A=r[13])*l+(P=r[14])*_+(L=r[15])*w,e[13]=M*i+A*p+P*y+L*E,e[14]=M*s+A*f+P*v+L*T,e[15]=M*a+A*m+P*b+L*C,e}function kx(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=n+n,p=i+i,f=s+s,m=n*l,_=n*p,y=n*f,v=i*p,b=i*f,w=s*f,E=a*l,T=a*p,C=a*f;return e[0]=1-(v+w),e[1]=_+C,e[2]=y-T,e[3]=0,e[4]=_-C,e[5]=1-(m+w),e[6]=b+E,e[7]=0,e[8]=y+T,e[9]=b-E,e[10]=1-(m+v),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function Fx(e,t){var r=t[4],n=t[5],i=t[6],s=t[8],a=t[9],l=t[10];return e[0]=Math.hypot(t[0],t[1],t[2]),e[1]=Math.hypot(r,n,i),e[2]=Math.hypot(s,a,l),e}function Bx(e,t,r,n,i){var s,a=1/Math.tan(t/2);return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0?(e[10]=(i+n)*(s=1/(n-i)),e[14]=2*i*n*s):(e[10]=-1,e[14]=-2*n),e}function Vx(e,t,r,n,i,s,a){var l=1/(t-r),p=1/(n-i),f=1/(s-a);return e[0]=-2*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*p,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*f,e[11]=0,e[12]=(t+r)*l,e[13]=(i+n)*p,e[14]=(a+s)*f,e[15]=1,e}function Ux(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e[9]=t[9]-r[9],e[10]=t[10]-r[10],e[11]=t[11]-r[11],e[12]=t[12]-r[12],e[13]=t[13]-r[13],e[14]=t[14]-r[14],e[15]=t[15]-r[15],e}xe.perspective=Bx,xe.ortho=Vx,xe.mul=zx,xe.sub=Ux;var me={},ye={};function $g(e){return $g=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},$g(e)}Object.defineProperty(ye,"__esModule",{value:!0}),ye.create=jx,ye.clone=function(e){var t=new ua.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},ye.length=qx,ye.fromValues=function(e,t,r){var n=new ua.ARRAY_TYPE(3);return n[0]=e,n[1]=t,n[2]=r,n},ye.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},ye.set=function(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e},ye.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},ye.subtract=Zx,ye.multiply=Xx,ye.divide=Wx,ye.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},ye.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},ye.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},ye.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},ye.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},ye.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},ye.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e},ye.distance=Hx,ye.squaredDistance=Yx,ye.squaredLength=$x,ye.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},ye.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},ye.normalize=function(e,t){var r=t[0],n=t[1],i=t[2],s=r*r+n*n+i*i;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e},ye.dot=Kx,ye.cross=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[0],l=r[1],p=r[2];return e[0]=i*p-s*l,e[1]=s*a-n*p,e[2]=n*l-i*a,e},ye.lerp=function(e,t,r,n){var i=t[0],s=t[1],a=t[2];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e[2]=a+n*(r[2]-a),e},ye.hermite=function(e,t,r,n,i,s){var a=s*s,l=a*(2*s-3)+1,p=a*(s-2)+s,f=a*(s-1),m=a*(3-2*s);return e[0]=t[0]*l+r[0]*p+n[0]*f+i[0]*m,e[1]=t[1]*l+r[1]*p+n[1]*f+i[1]*m,e[2]=t[2]*l+r[2]*p+n[2]*f+i[2]*m,e},ye.bezier=function(e,t,r,n,i,s){var a=1-s,l=a*a,p=s*s,f=l*a,m=3*s*l,_=3*p*a,y=p*s;return e[0]=t[0]*f+r[0]*m+n[0]*_+i[0]*y,e[1]=t[1]*f+r[1]*m+n[1]*_+i[1]*y,e[2]=t[2]*f+r[2]*m+n[2]*_+i[2]*y,e},ye.random=function(e,t){t=t||1;var r=2*ua.RANDOM()*Math.PI,n=2*ua.RANDOM()-1,i=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(r)*i,e[1]=Math.sin(r)*i,e[2]=n*t,e},ye.transformMat4=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[3]*n+r[7]*i+r[11]*s+r[15];return e[0]=(r[0]*n+r[4]*i+r[8]*s+r[12])/(a=a||1),e[1]=(r[1]*n+r[5]*i+r[9]*s+r[13])/a,e[2]=(r[2]*n+r[6]*i+r[10]*s+r[14])/a,e},ye.transformMat3=function(e,t,r){var n=t[0],i=t[1],s=t[2];return e[0]=n*r[0]+i*r[3]+s*r[6],e[1]=n*r[1]+i*r[4]+s*r[7],e[2]=n*r[2]+i*r[5]+s*r[8],e},ye.transformQuat=function(e,t,r){var n=r[0],i=r[1],s=r[2],a=t[0],l=t[1],p=t[2],f=i*p-s*l,m=s*a-n*p,_=n*l-i*a,y=i*_-s*m,v=s*f-n*_,b=n*m-i*f,w=2*r[3];return m*=w,_*=w,v*=2,b*=2,e[0]=a+(f*=w)+(y*=2),e[1]=l+m+v,e[2]=p+_+b,e},ye.rotateX=function(e,t,r,n){var i=[],s=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[0],s[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),s[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2],e},ye.rotateY=function(e,t,r,n){var i=[],s=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),s[1]=i[1],s[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2],e},ye.rotateZ=function(e,t,r,n){var i=[],s=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),s[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),s[2]=i[2],e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2],e},ye.angle=function(e,t){var r=e[0],n=e[1],i=e[2],s=t[0],a=t[1],l=t[2],p=Math.sqrt(r*r+n*n+i*i)*Math.sqrt(s*s+a*a+l*l),f=p&&Kx(e,t)/p;return Math.acos(Math.min(Math.max(f,-1),1))},ye.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e},ye.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},ye.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},ye.equals=function(e,t){var r=e[0],n=e[1],i=e[2],s=t[0],a=t[1],l=t[2];return Math.abs(r-s)<=ua.EPSILON*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(n-a)<=ua.EPSILON*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-l)<=ua.EPSILON*Math.max(1,Math.abs(i),Math.abs(l))},ye.forEach=ye.sqrLen=ye.len=ye.sqrDist=ye.dist=ye.div=ye.mul=ye.sub=void 0;var ua=function(e,t){if(e&&e.__esModule)return e;if(e===null||$g(e)!=="object"&&typeof e!="function")return{default:e};var r=Gx(void 0);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(On);function Gx(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(Gx=function(n){return n?r:t})(e)}function jx(){var e=new ua.ARRAY_TYPE(3);return ua.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function qx(e){return Math.hypot(e[0],e[1],e[2])}function Zx(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function Xx(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function Wx(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function Hx(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function Yx(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return r*r+n*n+i*i}function $x(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n}function Kx(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}ye.sub=Zx,ye.mul=Xx,ye.div=Wx,ye.dist=Hx,ye.sqrDist=Yx,ye.len=qx,ye.sqrLen=$x;var ca,lC=(ca=jx(),function(e,t,r,n,i,s){var a,l;for(t||(t=3),r||(r=0),l=n?Math.min(n*t+r,e.length):e.length,a=r;a<l;a+=t)ca[0]=e[a],ca[1]=e[a+1],ca[2]=e[a+2],i(ca,ca,s),e[a]=ca[0],e[a+1]=ca[1],e[a+2]=ca[2];return e});ye.forEach=lC;var ze={};function Kg(e){return Kg=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Kg(e)}Object.defineProperty(ze,"__esModule",{value:!0}),ze.create=Qx,ze.clone=function(e){var t=new Fo.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},ze.fromValues=function(e,t,r,n){var i=new Fo.ARRAY_TYPE(4);return i[0]=e,i[1]=t,i[2]=r,i[3]=n,i},ze.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},ze.set=function(e,t,r,n,i){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e},ze.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},ze.subtract=t1,ze.multiply=e1,ze.divide=r1,ze.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},ze.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},ze.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},ze.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},ze.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},ze.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},ze.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e},ze.distance=n1,ze.squaredDistance=i1,ze.length=o1,ze.squaredLength=s1,ze.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},ze.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},ze.normalize=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r*r+n*n+i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),e[0]=r*a,e[1]=n*a,e[2]=i*a,e[3]=s*a,e},ze.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},ze.cross=function(e,t,r,n){var i=r[0]*n[1]-r[1]*n[0],s=r[0]*n[2]-r[2]*n[0],a=r[0]*n[3]-r[3]*n[0],l=r[1]*n[2]-r[2]*n[1],p=r[1]*n[3]-r[3]*n[1],f=r[2]*n[3]-r[3]*n[2],m=t[0],_=t[1],y=t[2],v=t[3];return e[0]=_*f-y*p+v*l,e[1]=-m*f+y*a-v*s,e[2]=m*p-_*a+v*i,e[3]=-m*l+_*s-y*i,e},ze.lerp=function(e,t,r,n){var i=t[0],s=t[1],a=t[2],l=t[3];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e[2]=a+n*(r[2]-a),e[3]=l+n*(r[3]-l),e},ze.random=function(e,t){var r,n,i,s,a,l;t=t||1;do a=(r=2*Fo.RANDOM()-1)*r+(n=2*Fo.RANDOM()-1)*n;while(a>=1);do l=(i=2*Fo.RANDOM()-1)*i+(s=2*Fo.RANDOM()-1)*s;while(l>=1);var p=Math.sqrt((1-a)/l);return e[0]=t*r,e[1]=t*n,e[2]=t*i*p,e[3]=t*s*p,e},ze.transformMat4=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3];return e[0]=r[0]*n+r[4]*i+r[8]*s+r[12]*a,e[1]=r[1]*n+r[5]*i+r[9]*s+r[13]*a,e[2]=r[2]*n+r[6]*i+r[10]*s+r[14]*a,e[3]=r[3]*n+r[7]*i+r[11]*s+r[15]*a,e},ze.transformQuat=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[0],l=r[1],p=r[2],f=r[3],m=f*n+l*s-p*i,_=f*i+p*n-a*s,y=f*s+a*i-l*n,v=-a*n-l*i-p*s;return e[0]=m*f+v*-a+_*-p-y*-l,e[1]=_*f+v*-l+y*-a-m*-p,e[2]=y*f+v*-p+m*-l-_*-a,e[3]=t[3],e},ze.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},ze.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},ze.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},ze.equals=function(e,t){var r=e[0],n=e[1],i=e[2],s=e[3],a=t[0],l=t[1],p=t[2],f=t[3];return Math.abs(r-a)<=Fo.EPSILON*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-l)<=Fo.EPSILON*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(i-p)<=Fo.EPSILON*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(s-f)<=Fo.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))},ze.forEach=ze.sqrLen=ze.len=ze.sqrDist=ze.dist=ze.div=ze.mul=ze.sub=void 0;var Fo=function(e,t){if(e&&e.__esModule)return e;if(e===null||Kg(e)!=="object"&&typeof e!="function")return{default:e};var r=Jx(void 0);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(On);function Jx(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(Jx=function(n){return n?r:t})(e)}function Qx(){var e=new Fo.ARRAY_TYPE(4);return Fo.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function t1(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function e1(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e}function r1(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e}function n1(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function i1(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return r*r+n*n+i*i+s*s}function o1(e){return Math.hypot(e[0],e[1],e[2],e[3])}function s1(e){var t=e[0],r=e[1],n=e[2],i=e[3];return t*t+r*r+n*n+i*i}ze.sub=t1,ze.mul=e1,ze.div=r1,ze.dist=n1,ze.sqrDist=i1,ze.len=o1,ze.sqrLen=s1;var uC=function(){var e=Qx();return function(t,r,n,i,s,a){var l,p;for(r||(r=4),n||(n=0),p=i?Math.min(i*r+n,t.length):t.length,l=n;l<p;l+=r)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],e[3]=t[l+3],s(e,e,a),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2],t[l+3]=e[3];return t}}();function Jg(e){return Jg=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Jg(e)}ze.forEach=uC,Object.defineProperty(me,"__esModule",{value:!0}),me.create=Qg,me.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},me.setAxisAngle=l1,me.getAxisAngle=function(e,t){var r=2*Math.acos(t[3]),n=Math.sin(r/2);return n>Ul.EPSILON?(e[0]=t[0]/n,e[1]=t[1]/n,e[2]=t[2]/n):(e[0]=1,e[1]=0,e[2]=0),r},me.getAngle=function(e,t){var r=d1(e,t);return Math.acos(2*r*r-1)},me.multiply=u1,me.rotateX=function(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],a=t[3],l=Math.sin(r),p=Math.cos(r);return e[0]=n*p+a*l,e[1]=i*p+s*l,e[2]=s*p-i*l,e[3]=a*p-n*l,e},me.rotateY=function(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],a=t[3],l=Math.sin(r),p=Math.cos(r);return e[0]=n*p-s*l,e[1]=i*p+a*l,e[2]=s*p+n*l,e[3]=a*p-i*l,e},me.rotateZ=function(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],a=t[3],l=Math.sin(r),p=Math.cos(r);return e[0]=n*p+i*l,e[1]=i*p-n*l,e[2]=s*p+a*l,e[3]=a*p-s*l,e},me.calculateW=function(e,t){var r=t[0],n=t[1],i=t[2];return e[0]=r,e[1]=n,e[2]=i,e[3]=Math.sqrt(Math.abs(1-r*r-n*n-i*i)),e},me.exp=c1,me.ln=h1,me.pow=function(e,t,r){return h1(e,t),f1(e,e,r),c1(e,e),e},me.slerp=_f,me.random=function(e){var t=Ul.RANDOM(),r=Ul.RANDOM(),n=Ul.RANDOM(),i=Math.sqrt(1-t),s=Math.sqrt(t);return e[0]=i*Math.sin(2*Math.PI*r),e[1]=i*Math.cos(2*Math.PI*r),e[2]=s*Math.sin(2*Math.PI*n),e[3]=s*Math.cos(2*Math.PI*n),e},me.invert=function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r*r+n*n+i*i+s*s,l=a?1/a:0;return e[0]=-r*l,e[1]=-n*l,e[2]=-i*l,e[3]=s*l,e},me.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},me.fromMat3=p1,me.fromEuler=function(e,t,r,n){var i=.5*Math.PI/180;t*=i,r*=i,n*=i;var s=Math.sin(t),a=Math.cos(t),l=Math.sin(r),p=Math.cos(r),f=Math.sin(n),m=Math.cos(n);return e[0]=s*p*m-a*l*f,e[1]=a*l*m+s*p*f,e[2]=a*p*f-s*l*m,e[3]=a*p*m+s*l*f,e},me.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},me.setAxes=me.sqlerp=me.rotationTo=me.equals=me.exactEquals=me.normalize=me.sqrLen=me.squaredLength=me.len=me.length=me.lerp=me.dot=me.scale=me.mul=me.add=me.set=me.copy=me.fromValues=me.clone=void 0;var Ul=gf(On),cC=gf(ur),ha=gf(ye),yo=gf(ze);function a1(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(a1=function(n){return n?r:t})(e)}function gf(e,t){if(!t&&e&&e.__esModule)return e;if(e===null||Jg(e)!=="object"&&typeof e!="function")return{default:e};var r=a1(t);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}function Qg(){var e=new Ul.ARRAY_TYPE(4);return Ul.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function l1(e,t,r){r*=.5;var n=Math.sin(r);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(r),e}function u1(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=r[0],p=r[1],f=r[2],m=r[3];return e[0]=n*m+a*l+i*f-s*p,e[1]=i*m+a*p+s*l-n*f,e[2]=s*m+a*f+n*p-i*l,e[3]=a*m-n*l-i*p-s*f,e}function c1(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=Math.sqrt(r*r+n*n+i*i),l=Math.exp(s),p=a>0?l*Math.sin(a)/a:0;return e[0]=r*p,e[1]=n*p,e[2]=i*p,e[3]=l*Math.cos(a),e}function h1(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=Math.sqrt(r*r+n*n+i*i),l=a>0?Math.atan2(a,s)/a:0;return e[0]=r*l,e[1]=n*l,e[2]=i*l,e[3]=.5*Math.log(r*r+n*n+i*i+s*s),e}function _f(e,t,r,n){var i,s,a,l,p,f=t[0],m=t[1],_=t[2],y=t[3],v=r[0],b=r[1],w=r[2],E=r[3];return(s=f*v+m*b+_*w+y*E)<0&&(s=-s,v=-v,b=-b,w=-w,E=-E),1-s>Ul.EPSILON?(i=Math.acos(s),a=Math.sin(i),l=Math.sin((1-n)*i)/a,p=Math.sin(n*i)/a):(l=1-n,p=n),e[0]=l*f+p*v,e[1]=l*m+p*b,e[2]=l*_+p*w,e[3]=l*y+p*E,e}function p1(e,t){var r,n=t[0]+t[4]+t[8];if(n>0)r=Math.sqrt(n+1),e[3]=.5*r,e[0]=(t[5]-t[7])*(r=.5/r),e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var s=(i+1)%3,a=(i+2)%3;r=Math.sqrt(t[3*i+i]-t[3*s+s]-t[3*a+a]+1),e[i]=.5*r,e[3]=(t[3*s+a]-t[3*a+s])*(r=.5/r),e[s]=(t[3*s+i]+t[3*i+s])*r,e[a]=(t[3*a+i]+t[3*i+a])*r}return e}me.clone=yo.clone,me.fromValues=yo.fromValues,me.copy=yo.copy,me.set=yo.set,me.add=yo.add,me.mul=u1;var f1=yo.scale;me.scale=f1;var d1=yo.dot;me.dot=d1,me.lerp=yo.lerp;var m1=yo.length;me.length=m1,me.len=m1;var g1=yo.squaredLength;me.squaredLength=g1,me.sqrLen=g1;var t_=yo.normalize;me.normalize=t_,me.exactEquals=yo.exactEquals,me.equals=yo.equals;var us,_1,y1,hC=(us=ha.create(),_1=ha.fromValues(1,0,0),y1=ha.fromValues(0,1,0),function(e,t,r){var n=ha.dot(t,r);return n<-.999999?(ha.cross(us,_1,t),ha.len(us)<1e-6&&ha.cross(us,y1,t),ha.normalize(us,us),l1(e,us,Math.PI),e):n>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(ha.cross(us,t,r),e[0]=us[0],e[1]=us[1],e[2]=us[2],e[3]=1+n,t_(e,e))});me.rotationTo=hC;var e_,r_,pC=(e_=Qg(),r_=Qg(),function(e,t,r,n,i,s){return _f(e_,t,i,s),_f(r_,r,n,s),_f(e,e_,r_,2*s*(1-s)),e});me.sqlerp=pC;var cs,fC=(cs=cC.create(),function(e,t,r,n){return cs[0]=r[0],cs[3]=r[1],cs[6]=r[2],cs[1]=n[0],cs[4]=n[1],cs[7]=n[2],cs[2]=-t[0],cs[5]=-t[1],cs[8]=-t[2],t_(e,p1(e,cs))});me.setAxes=fC;var qe={};function n_(e){return n_=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n_(e)}Object.defineProperty(qe,"__esModule",{value:!0}),qe.create=function(){var e=new Di.ARRAY_TYPE(8);return Di.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},qe.clone=function(e){var t=new Di.ARRAY_TYPE(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},qe.fromValues=function(e,t,r,n,i,s,a,l){var p=new Di.ARRAY_TYPE(8);return p[0]=e,p[1]=t,p[2]=r,p[3]=n,p[4]=i,p[5]=s,p[6]=a,p[7]=l,p},qe.fromRotationTranslationValues=function(e,t,r,n,i,s,a){var l=new Di.ARRAY_TYPE(8);l[0]=e,l[1]=t,l[2]=r,l[3]=n;var p=.5*i,f=.5*s,m=.5*a;return l[4]=p*n+f*r-m*t,l[5]=f*n+m*e-p*r,l[6]=m*n+p*t-f*e,l[7]=-p*e-f*t-m*r,l},qe.fromRotationTranslation=b1,qe.fromTranslation=function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},qe.fromRotation=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},qe.fromMat4=function(e,t){var r=pa.create();v1.getRotation(r,t);var n=new Di.ARRAY_TYPE(3);return v1.getTranslation(n,t),b1(e,r,n),e},qe.copy=w1,qe.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},qe.set=function(e,t,r,n,i,s,a,l,p){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e[6]=l,e[7]=p,e},qe.getDual=function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},qe.setDual=function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},qe.getTranslation=function(e,t){var r=t[4],n=t[5],i=t[6],s=t[7],a=-t[0],l=-t[1],p=-t[2],f=t[3];return e[0]=2*(r*f+s*a+n*p-i*l),e[1]=2*(n*f+s*l+i*a-r*p),e[2]=2*(i*f+s*p+r*l-n*a),e},qe.translate=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=.5*r[0],p=.5*r[1],f=.5*r[2],m=t[4],_=t[5],y=t[6],v=t[7];return e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=a*l+i*f-s*p+m,e[5]=a*p+s*l-n*f+_,e[6]=a*f+n*p-i*l+y,e[7]=-n*l-i*p-s*f+v,e},qe.rotateX=function(e,t,r){var n=-t[0],i=-t[1],s=-t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=l*a+m*n+p*s-f*i,y=p*a+m*i+f*n-l*s,v=f*a+m*s+l*i-p*n,b=m*a-l*n-p*i-f*s;return pa.rotateX(e,t,r),e[4]=_*(a=e[3])+b*(n=e[0])+y*(s=e[2])-v*(i=e[1]),e[5]=y*a+b*i+v*n-_*s,e[6]=v*a+b*s+_*i-y*n,e[7]=b*a-_*n-y*i-v*s,e},qe.rotateY=function(e,t,r){var n=-t[0],i=-t[1],s=-t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=l*a+m*n+p*s-f*i,y=p*a+m*i+f*n-l*s,v=f*a+m*s+l*i-p*n,b=m*a-l*n-p*i-f*s;return pa.rotateY(e,t,r),e[4]=_*(a=e[3])+b*(n=e[0])+y*(s=e[2])-v*(i=e[1]),e[5]=y*a+b*i+v*n-_*s,e[6]=v*a+b*s+_*i-y*n,e[7]=b*a-_*n-y*i-v*s,e},qe.rotateZ=function(e,t,r){var n=-t[0],i=-t[1],s=-t[2],a=t[3],l=t[4],p=t[5],f=t[6],m=t[7],_=l*a+m*n+p*s-f*i,y=p*a+m*i+f*n-l*s,v=f*a+m*s+l*i-p*n,b=m*a-l*n-p*i-f*s;return pa.rotateZ(e,t,r),e[4]=_*(a=e[3])+b*(n=e[0])+y*(s=e[2])-v*(i=e[1]),e[5]=y*a+b*i+v*n-_*s,e[6]=v*a+b*s+_*i-y*n,e[7]=b*a-_*n-y*i-v*s,e},qe.rotateByQuatAppend=function(e,t,r){var n=r[0],i=r[1],s=r[2],a=r[3],l=t[0],p=t[1],f=t[2],m=t[3];return e[0]=l*a+m*n+p*s-f*i,e[1]=p*a+m*i+f*n-l*s,e[2]=f*a+m*s+l*i-p*n,e[3]=m*a-l*n-p*i-f*s,e[4]=(l=t[4])*a+(m=t[7])*n+(p=t[5])*s-(f=t[6])*i,e[5]=p*a+m*i+f*n-l*s,e[6]=f*a+m*s+l*i-p*n,e[7]=m*a-l*n-p*i-f*s,e},qe.rotateByQuatPrepend=function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=r[0],p=r[1],f=r[2],m=r[3];return e[0]=n*m+a*l+i*f-s*p,e[1]=i*m+a*p+s*l-n*f,e[2]=s*m+a*f+n*p-i*l,e[3]=a*m-n*l-i*p-s*f,e[4]=n*(m=r[7])+a*(l=r[4])+i*(f=r[6])-s*(p=r[5]),e[5]=i*m+a*p+s*l-n*f,e[6]=s*m+a*f+n*p-i*l,e[7]=a*m-n*l-i*p-s*f,e},qe.rotateAroundAxis=function(e,t,r,n){if(Math.abs(n)<Di.EPSILON)return w1(e,t);var i=Math.hypot(r[0],r[1],r[2]);n*=.5;var s=Math.sin(n),a=s*r[0]/i,l=s*r[1]/i,p=s*r[2]/i,f=Math.cos(n),m=t[0],_=t[1],y=t[2],v=t[3];e[0]=m*f+v*a+_*p-y*l,e[1]=_*f+v*l+y*a-m*p,e[2]=y*f+v*p+m*l-_*a,e[3]=v*f-m*a-_*l-y*p;var b=t[4],w=t[5],E=t[6],T=t[7];return e[4]=b*f+T*a+w*p-E*l,e[5]=w*f+T*l+E*a-b*p,e[6]=E*f+T*p+b*l-w*a,e[7]=T*f-b*a-w*l-E*p,e},qe.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e},qe.multiply=E1,qe.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e},qe.lerp=function(e,t,r,n){var i=1-n;return T1(t,r)<0&&(n=-n),e[0]=t[0]*i+r[0]*n,e[1]=t[1]*i+r[1]*n,e[2]=t[2]*i+r[2]*n,e[3]=t[3]*i+r[3]*n,e[4]=t[4]*i+r[4]*n,e[5]=t[5]*i+r[5]*n,e[6]=t[6]*i+r[6]*n,e[7]=t[7]*i+r[7]*n,e},qe.invert=function(e,t){var r=yf(t);return e[0]=-t[0]/r,e[1]=-t[1]/r,e[2]=-t[2]/r,e[3]=t[3]/r,e[4]=-t[4]/r,e[5]=-t[5]/r,e[6]=-t[6]/r,e[7]=t[7]/r,e},qe.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},qe.normalize=function(e,t){var r=yf(t);if(r>0){r=Math.sqrt(r);var n=t[0]/r,i=t[1]/r,s=t[2]/r,a=t[3]/r,l=t[4],p=t[5],f=t[6],m=t[7],_=n*l+i*p+s*f+a*m;e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=(l-n*_)/r,e[5]=(p-i*_)/r,e[6]=(f-s*_)/r,e[7]=(m-a*_)/r}return e},qe.str=function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},qe.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},qe.equals=function(e,t){var r=e[0],n=e[1],i=e[2],s=e[3],a=e[4],l=e[5],p=e[6],f=e[7],m=t[0],_=t[1],y=t[2],v=t[3],b=t[4],w=t[5],E=t[6],T=t[7];return Math.abs(r-m)<=Di.EPSILON*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(n-_)<=Di.EPSILON*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(i-y)<=Di.EPSILON*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(s-v)<=Di.EPSILON*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(a-b)<=Di.EPSILON*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(l-w)<=Di.EPSILON*Math.max(1,Math.abs(l),Math.abs(w))&&Math.abs(p-E)<=Di.EPSILON*Math.max(1,Math.abs(p),Math.abs(E))&&Math.abs(f-T)<=Di.EPSILON*Math.max(1,Math.abs(f),Math.abs(T))},qe.sqrLen=qe.squaredLength=qe.len=qe.length=qe.dot=qe.mul=qe.setReal=qe.getReal=void 0;var Di=i_(On),pa=i_(me),v1=i_(xe);function x1(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(x1=function(n){return n?r:t})(e)}function i_(e,t){if(!t&&e&&e.__esModule)return e;if(e===null||n_(e)!=="object"&&typeof e!="function")return{default:e};var r=x1(t);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}function b1(e,t,r){var n=.5*r[0],i=.5*r[1],s=.5*r[2],a=t[0],l=t[1],p=t[2],f=t[3];return e[0]=a,e[1]=l,e[2]=p,e[3]=f,e[4]=n*f+i*p-s*l,e[5]=i*f+s*a-n*p,e[6]=s*f+n*l-i*a,e[7]=-n*a-i*l-s*p,e}function w1(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}function E1(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],l=r[4],p=r[5],f=r[6],m=r[7],_=t[4],y=t[5],v=t[6],b=t[7],w=r[0],E=r[1],T=r[2],C=r[3];return e[0]=n*C+a*w+i*T-s*E,e[1]=i*C+a*E+s*w-n*T,e[2]=s*C+a*T+n*E-i*w,e[3]=a*C-n*w-i*E-s*T,e[4]=n*m+a*l+i*f-s*p+_*C+b*w+y*T-v*E,e[5]=i*m+a*p+s*l-n*f+y*C+b*E+v*w-_*T,e[6]=s*m+a*f+n*p-i*l+v*C+b*T+_*E-y*w,e[7]=a*m-n*l-i*p-s*f+b*C-_*w-y*E-v*T,e}qe.getReal=pa.copy,qe.setReal=pa.copy,qe.mul=E1;var T1=pa.dot;qe.dot=T1;var I1=pa.length;qe.length=I1,qe.len=I1;var yf=pa.squaredLength;qe.squaredLength=yf,qe.sqrLen=yf;var Ce={};function o_(e){return o_=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o_(e)}Object.defineProperty(Ce,"__esModule",{value:!0}),Ce.create=C1,Ce.clone=function(e){var t=new Gl.ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},Ce.fromValues=function(e,t){var r=new Gl.ARRAY_TYPE(2);return r[0]=e,r[1]=t,r},Ce.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},Ce.set=function(e,t,r){return e[0]=t,e[1]=r,e},Ce.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},Ce.subtract=M1,Ce.multiply=A1,Ce.divide=P1,Ce.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},Ce.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},Ce.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e},Ce.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e},Ce.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},Ce.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},Ce.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e},Ce.distance=L1,Ce.squaredDistance=D1,Ce.length=R1,Ce.squaredLength=O1,Ce.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},Ce.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},Ce.normalize=function(e,t){var r=t[0],n=t[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i)),e[0]=t[0]*i,e[1]=t[1]*i,e},Ce.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},Ce.cross=function(e,t,r){var n=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=n,e},Ce.lerp=function(e,t,r,n){var i=t[0],s=t[1];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e},Ce.random=function(e,t){t=t||1;var r=2*Gl.RANDOM()*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e},Ce.transformMat2=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[2]*i,e[1]=r[1]*n+r[3]*i,e},Ce.transformMat2d=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[2]*i+r[4],e[1]=r[1]*n+r[3]*i+r[5],e},Ce.transformMat3=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[3]*i+r[6],e[1]=r[1]*n+r[4]*i+r[7],e},Ce.transformMat4=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[4]*i+r[12],e[1]=r[1]*n+r[5]*i+r[13],e},Ce.rotate=function(e,t,r,n){var i=t[0]-r[0],s=t[1]-r[1],a=Math.sin(n),l=Math.cos(n);return e[0]=i*l-s*a+r[0],e[1]=i*a+s*l+r[1],e},Ce.angle=function(e,t){var r=e[0],n=e[1],i=t[0],s=t[1],a=Math.sqrt(r*r+n*n)*Math.sqrt(i*i+s*s);return Math.acos(Math.min(Math.max(a&&(r*i+n*s)/a,-1),1))},Ce.zero=function(e){return e[0]=0,e[1]=0,e},Ce.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},Ce.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]},Ce.equals=function(e,t){var r=e[0],n=e[1],i=t[0],s=t[1];return Math.abs(r-i)<=Gl.EPSILON*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(n-s)<=Gl.EPSILON*Math.max(1,Math.abs(n),Math.abs(s))},Ce.forEach=Ce.sqrLen=Ce.sqrDist=Ce.dist=Ce.div=Ce.mul=Ce.sub=Ce.len=void 0;var Gl=function(e,t){if(e&&e.__esModule)return e;if(e===null||o_(e)!=="object"&&typeof e!="function")return{default:e};var r=S1(void 0);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(On);function S1(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(S1=function(n){return n?r:t})(e)}function C1(){var e=new Gl.ARRAY_TYPE(2);return Gl.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e}function M1(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function A1(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function P1(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function L1(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1])}function D1(e,t){var r=t[0]-e[0],n=t[1]-e[1];return r*r+n*n}function R1(e){return Math.hypot(e[0],e[1])}function O1(e){var t=e[0],r=e[1];return t*t+r*r}Ce.len=R1,Ce.sub=M1,Ce.mul=A1,Ce.div=P1,Ce.dist=L1,Ce.sqrDist=D1,Ce.sqrLen=O1;var dC=function(){var e=C1();return function(t,r,n,i,s,a){var l,p;for(r||(r=2),n||(n=0),p=i?Math.min(i*r+n,t.length):t.length,l=n;l<p;l+=r)e[0]=t[l],e[1]=t[l+1],s(e,e,a),t[l]=e[0],t[l+1]=e[1];return t}}();function s_(e){return s_=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s_(e)}Ce.forEach=dC,Object.defineProperty(Rn,"__esModule",{value:!0});var gr=Rn.vec4=q=Rn.vec3=Rn.vec2=Rn.quat2=ei=Rn.quat=Q=Rn.mat4=Ri=Rn.mat3=Rn.mat2d=Fu=Rn.mat2=Rn.glMatrix=void 0,mC=Ns(On);Rn.glMatrix=mC;var gC=Ns(Nr),Fu=Rn.mat2=gC,_C=Ns(Fr);Rn.mat2d=_C;var yC=Ns(ur),Ri=Rn.mat3=yC,vC=Ns(xe),Q=Rn.mat4=vC,xC=Ns(me),ei=Rn.quat=xC,bC=Ns(qe);Rn.quat2=bC;var wC=Ns(Ce);Rn.vec2=wC;var EC=Ns(ye),q=Rn.vec3=EC,TC=Ns(ze);function N1(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,r=new WeakMap;return(N1=function(n){return n?r:t})(e)}function Ns(e,t){if(!t&&e&&e.__esModule)return e;if(e===null||s_(e)!=="object"&&typeof e!="function")return{default:e};var r=N1(t);if(r&&r.has(e))return r.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(s!=="default"&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}gr=Rn.vec4=TC;const IC=Je([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:z1}=IC,k1=Je([{name:"a_pos_3",components:3,type:"Int16"}]);var $a=Je([{name:"a_pos",type:"Int16",components:2}]);class vf{constructor(t,r){this.pos=t,this.dir=r}intersectsPlane(t,r,n){const i=q.dot(r,this.dir);if(Math.abs(i)<1e-6)return!1;const s=((t[0]-this.pos[0])*r[0]+(t[1]-this.pos[1])*r[1]+(t[2]-this.pos[2])*r[2])/i;return n[0]=this.pos[0]+this.dir[0]*s,n[1]=this.pos[1]+this.dir[1]*s,n[2]=this.pos[2]+this.dir[2]*s,!0}closestPointOnSphere(t,r,n){if(q.equals(this.pos,t)||r===0)return n[0]=n[1]=n[2]=0,!1;const[i,s,a]=this.dir,l=this.pos[0]-t[0],p=this.pos[1]-t[1],f=this.pos[2]-t[2],m=i*i+s*s+a*a,_=2*(l*i+p*s+f*a),y=_*_-4*m*(l*l+p*p+f*f-r*r);if(y<0){const v=Math.max(-_/2,0),b=l+i*v,w=p+s*v,E=f+a*v,T=Math.hypot(b,w,E);return n[0]=b*r/T,n[1]=w*r/T,n[2]=E*r/T,!1}{const v=(-_-Math.sqrt(y))/(2*m);if(v<0){const b=Math.hypot(l,p,f);return n[0]=l*r/b,n[1]=p*r/b,n[2]=f*r/b,!1}return n[0]=l+i*v,n[1]=p+s*v,n[2]=f+a*v,!0}}}class a_{constructor(t,r,n,i,s){this.TL=t,this.TR=r,this.BR=n,this.BL=i,this.horizon=s}static fromInvProjectionMatrix(t,r,n){const i=[-1,1,1],s=[1,1,1],a=[1,-1,1],l=[-1,-1,1],p=q.transformMat4(i,i,t),f=q.transformMat4(s,s,t),m=q.transformMat4(a,a,t),_=q.transformMat4(l,l,t);return new a_(p,f,m,_,r/n)}}function l_(e,t,r){let n=1/0,i=-1/0;const s=[];for(const a of e){q.sub(s,a,t);const l=q.dot(s,r);n=Math.min(n,l),i=Math.max(i,l)}return[n,i]}function F1(e,t){let r=!0;for(let n=0;n<e.planes.length;n++){const i=e.planes[n];let s=0;for(let a=0;a<t.length;a++)s+=q.dot(i,t[a])+i[3]>=0;if(s===0)return 0;s!==t.length&&(r=!1)}return r?2:1}function B1(e,t){for(const r of e.projections){const n=l_(t,e.points[0],r.axis);if(r.projection[1]<n[0]||r.projection[0]>n[1])return 0}return 1}class Bu{constructor(t,r){this.points=t||new Array(8).fill([0,0,0]),this.planes=r||new Array(6).fill([0,0,0,0]),this.bounds=Zr.fromPoints(this.points),this.projections=[];const n=[q.sub([],this.points[2],this.points[3]),q.sub([],this.points[0],this.points[3]),q.sub([],this.points[4],this.points[0]),q.sub([],this.points[5],this.points[1]),q.sub([],this.points[6],this.points[2]),q.sub([],this.points[7],this.points[3])];for(const i of n){const s=[0,-i[2],i[1]],a=[i[2],0,-i[0]];this.projections.push({axis:s,projection:l_(this.points,this.points[0],s)}),this.projections.push({axis:a,projection:l_(this.points,this.points[0],a)})}}static fromInvProjectionMatrix(t,r,n,i){const s=Math.pow(2,n),a=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(f=>{const m=gr.transformMat4([],f,t),_=1/m[3]/r*s;return gr.mul(m,m,[_,_,i?1/m[3]:_,_])}),l=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(f=>{const m=q.sub([],a[f[0]],a[f[1]]),_=q.sub([],a[f[2]],a[f[1]]),y=q.normalize([],q.cross([],m,_)),v=-q.dot(y,a[f[1]]);return y.concat(v)}),p=[];for(let f=0;f<a.length;f++)p.push([a[f][0],a[f][1],a[f][2]]);return new Bu(p,l)}}class Zr{static fromPoints(t){const r=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(const i of t)q.min(r,r,i),q.max(n,n,i);return new Zr(r,n)}static applyTransform(t,r){const n=t.getCorners();for(let i=0;i<n.length;++i)q.transformMat4(n[i],n[i],r);return Zr.fromPoints(n)}static projectAabbCorners(t,r){const n=t.getCorners();for(let i=0;i<n.length;++i)q.transformMat4(n[i],n[i],r);return n}constructor(t,r){this.min=t,this.max=r,this.center=q.scale([],q.add([],this.min,this.max),.5)}quadrant(t){const r=[t%2==0,t<2],n=q.clone(this.min),i=q.clone(this.max);for(let s=0;s<r.length;s++)n[s]=r[s]?this.min[s]:this.center[s],i[s]=r[s]?this.center[s]:this.max[s];return i[2]=this.max[2],new Zr(n,i)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,r=this.max;return[[t[0],t[1],t[2]],[r[0],t[1],t[2]],[r[0],r[1],t[2]],[t[0],r[1],t[2]],[t[0],t[1],r[2]],[r[0],t[1],r[2]],[r[0],r[1],r[2]],[t[0],r[1],r[2]]]}intersects(t){return this.intersectsAabb(t.bounds)?F1(t,this.getCorners()):0}intersectsFlat(t){return this.intersectsAabb(t.bounds)?F1(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(t,r){return r||this.intersects(t)?B1(t,this.getCorners()):0}intersectsPreciseFlat(t,r){return r||this.intersectsFlat(t)?B1(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(t){for(let r=0;r<3;++r)if(this.min[r]>t.max[r]||t.min[r]>this.max[r])return!1;return!0}intersectsAabbXY(t){return!(this.min[0]>t.max[0]||t.min[0]>this.max[0]||this.min[1]>t.max[1]||t.min[1]>this.max[1])}encapsulate(t){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],t.min[r]),this.max[r]=Math.max(this.max[r],t.max[r])}encapsulatePoint(t){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],t[r]),this.max[r]=Math.max(this.max[r],t[r])}}Ut(Zr,"Aabb");const mh=5,Ka=6,Ki=lt/Math.PI/2,SC=16383,Vu=64,u_=[Vu,32,16],Bo=-Ki,Vo=Ki,CC=[new Zr([Bo,Bo,Bo],[Vo,Vo,Vo]),new Zr([Bo,Bo,Bo],[0,0,Vo]),new Zr([0,Bo,Bo],[Vo,0,Vo]),new Zr([Bo,0,Bo],[0,Vo,Vo]),new Zr([0,0,Bo],[Vo,Vo,Vo])];function xf(e){return e*Ki/ju}function V1(e,t,r,n=!0){const i=q.scale([],e._camera.position,e.worldSize),s=[t,r,1,1];gr.transformMat4(s,s,e.pixelMatrixInverse),gr.scale(s,s,1/s[3]);const a=q.sub([],s,i),l=q.normalize([],a),p=e.globeMatrix,f=[p[12],p[13],p[14]],m=q.sub([],f,i),_=q.length(m),y=q.normalize([],m),v=e.worldSize/(2*Math.PI),b=q.dot(y,l),w=Math.asin(v/_);if(w<Math.acos(b)){if(!n)return null;const z=[],U=[];q.scale(z,l,_/b),q.normalize(U,q.sub(U,z,m)),q.normalize(l,q.add(l,m,q.scale(l,U,Math.tan(w)*_)))}const E=[];new vf(i,l).closestPointOnSphere(f,v,E);const T=q.normalize([],Jr(p,0)),C=q.normalize([],Jr(p,1)),M=q.normalize([],Jr(p,2)),A=q.dot(T,E),P=q.dot(C,E),L=q.dot(M,E),R=qt(Math.asin(-P/v));let N=qt(Math.atan2(A,L));N=e.center.lng+function(z,U){const G=(U-z+180)%360-180;return G<-180?G+360:G}(e.center.lng,N);const k=Xn(N),F=Bt(ri(R),0,1);return new Ue(k,F)}class MC{constructor(t,r,n){this.a=q.sub([],t,n),this.b=q.sub([],r,n),this.center=n;const i=q.normalize([],this.a),s=q.normalize([],this.b);this.angle=Math.acos(q.dot(i,s))}}function c_(e,t){if(e.angle===0)return null;let r;return r=e.a[t]===0?1/e.angle*.5*Math.PI:1/e.angle*Math.atan(e.b[t]/e.a[t]/Math.sin(e.angle)-1/Math.tan(e.angle)),r<0||r>1?null:function(n,i,s,a){const l=Math.sin(s);return n*(Math.sin((1-a)*s)/l)+i*(Math.sin(a*s)/l)}(e.a[t],e.b[t],e.angle,Bt(r,0,1))+e.center[t]}function hs(e){if(e.z<=1)return CC[e.z+2*e.y+e.x];const t=p_(bf(e));return Zr.fromPoints(t)}function fa(e,t,r){return q.scale(e,e,1-r),q.scaleAndAdd(e,e,t,r)}function U1(e,t){const r=Zn(t.zoom);if(r===0)return hs(e);const n=bf(e),i=p_(n),s=Xn(n.getWest())*t.worldSize,a=Xn(n.getEast())*t.worldSize,l=ri(n.getNorth())*t.worldSize,p=ri(n.getSouth())*t.worldSize,f=[s,l,0],m=[a,l,0],_=[s,p,0],y=[a,p,0],v=Q.invert([],t.globeMatrix);return q.transformMat4(f,f,v),q.transformMat4(m,m,v),q.transformMat4(_,_,v),q.transformMat4(y,y,v),i[0]=fa(i[0],_,r),i[1]=fa(i[1],y,r),i[2]=fa(i[2],m,r),i[3]=fa(i[3],f,r),Zr.fromPoints(i)}function G1(e,t,r){for(const n of e)q.transformMat4(n,n,t),q.scale(n,n,r)}function h_(e,t,r,n){const i=t/e.worldSize,s=e.globeMatrix;if(r.z<=1){const k=hs(r).getCorners();return G1(k,s,i),Zr.fromPoints(k)}const a=bf(r,n),l=p_(a);G1(l,s,i);const p=Number.MAX_VALUE,f=[-p,-p,-p],m=[p,p,p];if(a.contains(e.center)){for(const z of l)q.min(m,m,z),q.max(f,f,z);f[2]=0;const k=e.point,F=[k.x*i,k.y*i,0];return q.min(m,m,F),q.max(f,f,F),new Zr(m,f)}const _=[s[12]*i,s[13]*i,s[14]*i],y=a.getCenter(),v=Bt(e.center.lat,-sn,sn),b=Bt(y.lat,-sn,sn),w=Xn(e.center.lng),E=ri(v);let T=w-Xn(y.lng);const C=E-ri(b);T>.5?T-=1:T<-.5&&(T+=1);let M=0;if(Math.abs(T)>Math.abs(C))M=T>=0?1:3;else{M=C>=0?0:2;const k=[s[4]*i,s[5]*i,s[6]*i],F=-Math.sin(re(C>=0?a.getSouth():a.getNorth()))*Ki;q.scaleAndAdd(_,_,k,F)}const A=l[M],P=l[(M+1)%4],L=new MC(A,P,_),R=[c_(L,0)||A[0],c_(L,1)||A[1],c_(L,2)||A[2]],N=Zn(e.zoom);if(N>0){const k=function({x:z,y:U,z:G},V,K,$,tt){const X=1/(1<<G);let J=z*X,nt=J+X,at=U*X,ot=at+X,It=0;const xt=(J+nt)/2-$;return xt>.5?It=-1:xt<-.5&&(It=1),J=((J+It)*V-($*=V))*K+$,nt=((nt+It)*V-$)*K+$,at=(at*V-(tt*=V))*K+tt,ot=(ot*V-tt)*K+tt,[[J,ot,0],[nt,ot,0],[nt,at,0],[J,at,0]]}(r,t,e._pixelsPerMercatorPixel,w,E);for(let z=0;z<l.length;z++)fa(l[z],k[z],N);const F=q.add([],k[M],k[(M+1)%4]);q.scale(F,F,.5),fa(R,F,N)}for(const k of l)q.min(m,m,k),q.max(f,f,k);return m[2]=Math.min(A[2],P[2]),q.min(m,m,R),q.max(f,f,R),new Zr(m,f)}function bf({x:e,y:t,z:r},n=!1){const i=1/(1<<r),s=new se(Ji(e*i),t===(1<<r)-1&&n?-90:fn((t+1)*i)),a=new se(Ji((e+1)*i),t===0&&n?90:fn(t*i));return new go(s,a)}function p_(e){const t=re(e.getNorth()),r=re(e.getSouth()),n=Math.cos(t),i=Math.cos(r),s=Math.sin(t),a=Math.sin(r),l=e.getWest(),p=e.getEast();return[Uu(i,a,l),Uu(i,a,p),Uu(n,s,p),Uu(n,s,l)]}function Uu(e,t,r,n=Ki){return r=re(r),[e*Math.sin(r)*n,-t*n,e*Math.cos(r)*n]}function Oi(e,t,r){return Uu(Math.cos(re(e)),Math.sin(re(e)),t,r)}function gh(e,t,r,n){const i=1<<r.z,s=(e/lt+r.x)/i;return Oi(fn((t/lt+r.y)/i),Ji(s),n)}function wf({min:e,max:t}){return SC/Math.max(t[0]-e[0],t[1]-e[1],t[2]-e[2])}const j1=new Float64Array(16);function Gu(e){const t=wf(e),r=Q.fromScaling(j1,[t,t,t]);return Q.translate(r,r,q.negate([],e.min))}function f_(e){const t=Q.fromTranslation(j1,e.min),r=1/wf(e);return Q.scale(t,t,[r,r,r])}function d_(e){const t=lt/(2*Math.PI);return e/(2*Math.PI)/t}function q1(e,t){return lt/(512*Math.pow(2,e))*wf(hs(t))}function Z1(e,t,r,n,i){const s=d_(r),a=[e,t,-r/(2*Math.PI)],l=Q.identity(new Float64Array(16));return Q.translate(l,l,a),Q.scale(l,l,[s,s,s]),Q.rotateX(l,l,re(-i)),Q.rotateY(l,l,re(-n)),l}function Zn(e){return Ti(mh,Ka,e)}function AC(e,t,r){const n=Q.identity(new Float64Array(16)),i=(t/(1<<e)-.5)*Math.PI*2;return Q.rotateY(n,r.globeMatrix,i),Float32Array.from(n)}function X1(e,t,r){const n=Zn(r.zoom),i=e.style.map._antialias,s=!!t.extStandardDerivatives,a=t.extStandardDerivativesForceOff||e.terrain&&e.terrain.exaggeration()>0;return n===0&&!i&&!a&&s}function PC(e,t,r,n){const i=t.getNorth(),s=t.getSouth(),a=t.getWest(),l=t.getEast(),p=1<<e.z,f=l-a,m=i-s,_=f/Vu,y=-m/u_[r],v=[0,_,0,y,0,0,i,a,0];if(e.z>0){const b=180/n;Ri.multiply(v,v,[b/f+1,0,0,0,b/m+1,0,-.5*b/_,.5*b/y,1])}return v[2]=p,v[5]=e.x,v[8]=e.y,v}function LC(e){const t=sn-5;e=Bt(e,-t,t)/t*90;const r=Math.pow(Math.abs(Math.sin(re(e))),3);return Math.round(r*(u_.length-1))}function W1(e){const t=[0,0,0],r=Q.identity(new Float64Array(16));return Q.multiply(r,e.pixelMatrix,e.globeMatrix),q.transformMat4(t,t,r),new H(t[0],t[1])}function H1(e,t){const r=Oi(t.lat,t.lng),n=function(s){const a=Oi(s._center.lat,s._center.lng),l=q.fromValues(0,1,0);let p=q.cross([],l,a);const f=Q.fromRotation([],-s.angle,a);p=q.transformMat4(p,p,f),Q.fromRotation(f,-s._pitch,p);const m=q.normalize([],a);return q.scale(m,m,xf(s.cameraToCenterDistance/s.pixelsPerMeter)),q.transformMat4(m,m,f),q.add([],a,m)}(e),i=q.subtract([],n,r);return q.angle(i,r)}function Ef(e,t){return H1(e,t)>Math.PI/2*1.01}const Y1=re(85),DC=Math.cos(Y1),RC=Math.sin(Y1);class OC{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy()}_fillGridMeshWithLods(t,r){const n=new $i,i=new xn,s=[],a=t+1+2,l=r[0]+1,p=r[0]+1+(1+r.length),f=(m,_,y)=>{let v=m===a-1?m-2:m===0?m:m-1;return v+=y?24575:0,[v,_]};for(let m=0;m<a;++m)n.emplaceBack(...f(m,0,!0));for(let m=0;m<l;++m)for(let _=0;_<a;++_)n.emplaceBack(...f(_,m,(_===0||_===a-1)&&!0));for(let m=0;m<r.length;++m){const _=r[m];for(let y=0;y<a;++y)n.emplaceBack(...f(y,_,!0))}for(let m=0;m<r.length;++m){const _=i.length,y=r[m]+1+2,v=new xn;for(let E=0;E<y-1;E++){const T=E===y-2,C=T?a*(p-r.length+m-E):a;for(let M=0;M<a-1;M++){const A=E*a+M;E===0||T||M===0||M===a-2?(v.emplaceBack(A+1,A,A+C),v.emplaceBack(A+C,A+C+1,A+1)):(i.emplaceBack(A+1,A,A+C),i.emplaceBack(A+C,A+C+1,A+1))}}const b=mr.simpleSegment(0,_,n.length,i.length-_);for(let E=0;E<v.uint16.length;E+=3)i.emplaceBack(v.uint16[E],v.uint16[E+1],v.uint16[E+2]);const w=mr.simpleSegment(0,_,n.length,i.length-_);s.push({withoutSkirts:b,withSkirts:w})}return{vertices:n,indices:i,segments:s}}_createGrid(t){const r=this._fillGridMeshWithLods(Vu,u_);this._gridSegments=r.segments,this._gridBuffer=t.createVertexBuffer(r.vertices,$a.members),this._gridIndexBuffer=t.createIndexBuffer(r.indices,!0)}_createPoles(t){const r=new xn;for(let s=0;s<=Vu;s++)r.emplaceBack(0,s+1,s+2);this._poleIndexBuffer=t.createIndexBuffer(r,!0);const n=new hh,i=new hh;this._poleSegments=[];for(let s=0,a=0;s<mh;s++){const l=360/(1<<s);n.emplaceBack(0,-Ki,0,.5,0),i.emplaceBack(0,-Ki,0,.5,1);for(let p=0;p<=Vu;p++){const f=p/Vu,m=ce(0,l,f),[_,y,v]=Uu(DC,RC,m,Ki);n.emplaceBack(_,y,v,f,0),i.emplaceBack(_,y,v,f,1)}this._poleSegments.push(mr.simpleSegment(a,0,66,64)),a+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(n,z1,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(i,z1,!1)}getGridBuffers(t,r){return[this._gridBuffer,this._gridIndexBuffer,r?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t){return[this._poleNorthVertexBuffer,this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}}const ju=63710088e-1,m_=2*Math.PI*ju;class Ja{constructor(t,r){if(isNaN(t)||isNaN(r))throw new Error(`Invalid LngLat object: (${t}, ${r})`);if(this.lng=+t,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ja(Vn(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const r=Math.PI/180,n=this.lat*r,i=t.lat*r,s=Math.sin(n)*Math.sin(i)+Math.cos(n)*Math.cos(i)*Math.cos((t.lng-this.lng)*r);return ju*Math.acos(Math.min(s,1))}toBounds(t=0){const r=360*t/40075017,n=r/Math.cos(Math.PI/180*this.lat);return new go(new Ja(this.lng-n,this.lat-r),new Ja(this.lng+n,this.lat+r))}toEcef(t){const r=xf(t);return Oi(this.lat,this.lng,Ki+r)}static convert(t){if(t instanceof Ja)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new Ja(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new Ja(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}var se=Ja,$1={};(function(e,t){(function(r){function n(s,a,l){var p=i(256*s,256*(a=Math.pow(2,l)-a-1),l),f=i(256*(s+1),256*(a+1),l);return p[0]+","+p[1]+","+f[0]+","+f[1]}function i(s,a,l){var p=2*Math.PI*6378137/256/Math.pow(2,l);return[s*p-2*Math.PI*6378137/2,a*p-2*Math.PI*6378137/2]}r.getURL=function(s,a,l,p,f,m){return m=m||{},s+"?"+["bbox="+n(l,p,f),"format="+(m.format||"image/png"),"service="+(m.service||"WMS"),"version="+(m.version||"1.1.1"),"request="+(m.request||"GetMap"),"srs="+(m.srs||"EPSG:3857"),"width="+(m.width||256),"height="+(m.height||256),"layers="+a].join("&")},r.getTileBBox=n,r.getMercCoords=i,Object.defineProperty(r,"__esModule",{value:!0})})(t)})(0,$1);var NC=$1;class da{constructor(t,r,n){this.z=t,this.x=r,this.y=n,this.key=_h(0,t,t,r,n)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,r){const n=NC.getTileBBox(this.x,this.y,this.z),i=function(s,a,l){let p,f="";for(let m=s;m>0;m--)p=1<<m-1,f+=(a&p?1:0)+(l&p?2:0);return f}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(r==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",i).replace("{bbox-epsg-3857}",n)}toString(){return`${this.z}/${this.x}/${this.y}`}}class g_{constructor(t,r){this.wrap=t,this.canonical=r,this.key=_h(t,r.z,r.z,r.x,r.y)}}class wr{constructor(t,r,n,i,s){this.overscaledZ=t,this.wrap=r,this.canonical=new da(n,+i,+s),this.key=r===0&&t===n?this.canonical.key:_h(r,t,n,i,s)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const r=this.canonical.z-t;return t>this.canonical.z?new wr(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new wr(t,this.wrap,t,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(t,r=!0){if(this.overscaledZ===t&&r)return this.key;if(t>this.canonical.z)return _h(this.wrap*+r,t,this.canonical.z,this.canonical.x,this.canonical.y);{const n=this.canonical.z-t;return _h(this.wrap*+r,t,t,this.canonical.x>>n,this.canonical.y>>n)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const r=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>r&&t.canonical.y===this.canonical.y>>r}children(t){if(this.overscaledZ>=t)return[new wr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,n=2*this.canonical.x,i=2*this.canonical.y;return[new wr(r,this.wrap,r,n,i),new wr(r,this.wrap,r,n+1,i),new wr(r,this.wrap,r,n,i+1),new wr(r,this.wrap,r,n+1,i+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new wr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new wr(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new g_(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function _h(e,t,r,n,i){const s=1<<Math.min(r,22);let a=s*(i%s)+n%s;return e&&r<22&&(a+=s*s*((e<0?-2*e-1:2*e)%(1<<2*(22-r)))),16*(32*a+r)+(t-r)}Ut(da,"CanonicalTileID"),Ut(wr,"OverscaledTileID",{omit:["projMatrix"]});const zC=0,kC=25.5;function Tf(e){return m_*Math.cos(e*Math.PI/180)}function Xn(e){return(180+e)/360}function ri(e){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360}function cr(e,t){return e/Tf(t)}function Ji(e){return 360*e-180}function fn(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function K1(e,t){return e*Tf(fn(t))}const sn=85.051129;function J1(e){return Math.cos(re(Bt(e,-sn,sn)))}function Qa(e,t){const r=Bt(t,zC,kC),n=Math.pow(2,r);return J1(e)*m_/(512*n)}function __(e){return 1/Math.cos(e*Math.PI/180)}function yh(e,t=0){const r=Math.exp(Math.PI*(1-(e.y+t/lt)/(1<<e.z)*2));return 80150034*r/(r*r+1)/lt/(1<<e.z)}class Ue{constructor(t,r,n=0){this.x=+t,this.y=+r,this.z=+n}static fromLngLat(t,r=0){const n=se.convert(t);return new Ue(Xn(n.lng),ri(n.lat),cr(r,n.lat))}toLngLat(){return new se(Ji(this.x),fn(this.y))}toAltitude(){return K1(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/m_*__(fn(this.y))}}function y_(e,t,r,n,i,s,a,l,p){const f=(t+n)/2,m=(r+i)/2,_=new H(f,m);l(_),function(y,v,b,w,E,T){const C=b-E,M=w-T;return Math.abs((w-v)*C-(b-y)*M)/Math.hypot(C,M)}(_.x,_.y,s.x,s.y,a.x,a.y)>=p?(y_(e,t,r,f,m,s,_,l,p),y_(e,f,m,n,i,_,a,l,p)):e.push(a)}function Q1(e,t,r){let n=e[0],i=n.x,s=n.y;t(n);const a=[n];for(let l=1;l<e.length;l++){const p=e[l],{x:f,y:m}=p;t(p),y_(a,i,s,f,m,n,p,t,r),i=f,s=m,n=p}return a}function v_(e,t,r,n){if(n(t,r)){const i=t.add(r)._mult(.5);v_(e,t,i,n),v_(e,i,r,n)}else e.push(r)}function FC(e,t){let r=e[0];const n=[r];for(let i=1;i<e.length;i++){const s=e[i];v_(n,r,s,t),r=s}return n}const x_=Math.pow(2,14)-1,tb=-x_-1;function BC(e,t){const r=Math.round(e.x*t),n=Math.round(e.y*t);return e.x=Bt(r,tb,x_),e.y=Bt(n,tb,x_),(r<e.x||r>e.x+1||n<e.y||n>e.y+1)&&Y("Geometry exceeds allowed extent, reduce your vector tile buffer size"),e}function zs(e,t,r){const n=e.loadGeometry(),i=e.extent,s=lt/i;if(t&&r&&r.projection.isReprojectedInTileSpace){const a=1<<t.z,{scale:l,x:p,y:f,projection:m}=r,_=y=>{const v=Ji((t.x+y.x/i)/a),b=fn((t.y+y.y/i)/a),w=m.project(v,b);y.x=(w.x*l-p)*i,y.y=(w.y*l-f)*i};for(let y=0;y<n.length;y++)if(e.type!==1)n[y]=Q1(n[y],_,1);else{const v=[];for(const b of n[y])b.x<0||b.x>=i||b.y<0||b.y>=i||(_(b),v.push(b));n[y]=v}}for(const a of n)for(const l of a)BC(l,s);return n}function tl(e,t){return{type:e.type,id:e.id,properties:e.properties,geometry:t?zs(e):[]}}function If(e,t,r,n,i){e.emplaceBack(2*t+(n+1)/2,2*r+(i+1)/2)}function Sf(e,t,r){e.emplaceBack(t.x,t.y,t.z,r[0]*16384,r[1]*16384,r[2]*16384)}class b_{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new $i,this.indexArray=new xn,this.segments=new mr,this.programConfigurations=new Ha(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,n,i){const s=this.layers[0],a=[];let l=null;s.type==="circle"&&(l=s.layout.get("circle-sort-key"));for(const{feature:f,id:m,index:_,sourceLayerIndex:y}of t){const v=this.layers[0]._featureFilter.needGeometry,b=tl(f,v);if(!this.layers[0]._featureFilter.filter(new jr(this.zoom),b,n))continue;const w=l?l.evaluate(b,{},n):void 0,E={id:m,properties:f.properties,type:f.type,sourceLayerIndex:y,index:_,geometry:v?b.geometry:zs(f,n,i),patterns:{},sortKey:w};a.push(E)}l&&a.sort((f,m)=>f.sortKey-m.sortKey);let p=null;i.projection.name==="globe"&&(this.globeExtVertexArray=new uf,p=i.projection);for(const f of a){const{geometry:m,index:_,sourceLayerIndex:y}=f,v=t[_].feature;this.addFeature(f,m,_,r.availableImages,n,p,r.brightness),r.featureIndex.insert(v,m,_,y,this.index)}}update(t,r,n,i,s){const a=Object.keys(t).length!==0;a&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,r,a?this.stateDependentLayers:this.layers,n,i,s)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,iC.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,oC.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,r,n,i,s,a,l){for(const p of r)for(const f of p){const m=f.x,_=f.y;if(m<0||m>=lt||_<0||_>=lt)continue;if(a){const b=a.projectTilePoint(m,_,s),w=a.upVector(s,m,_),E=this.globeExtVertexArray;Sf(E,b,w),Sf(E,b,w),Sf(E,b,w),Sf(E,b,w)}const y=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),v=y.vertexLength;If(this.layoutVertexArray,m,_,-1,-1),If(this.layoutVertexArray,m,_,1,-1),If(this.layoutVertexArray,m,_,1,1),If(this.layoutVertexArray,m,_,-1,1),this.indexArray.emplaceBack(v,v+1,v+2),this.indexArray.emplaceBack(v,v+2,v+3),y.vertexLength+=4,y.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,{},i,s,l)}}function eb(e,t){for(let r=0;r<e.length;r++)if(el(t,e[r]))return!0;for(let r=0;r<t.length;r++)if(el(e,t[r]))return!0;return!!w_(e,t)}function VC(e,t,r){return!!el(e,t)||!!E_(t,e,r)}function rb(e,t){if(e.length===1)return ib(t,e[0]);for(let r=0;r<t.length;r++){const n=t[r];for(let i=0;i<n.length;i++)if(el(e,n[i]))return!0}for(let r=0;r<e.length;r++)if(ib(t,e[r]))return!0;for(let r=0;r<t.length;r++)if(w_(e,t[r]))return!0;return!1}function UC(e,t,r){if(e.length>1){if(w_(e,t))return!0;for(let n=0;n<t.length;n++)if(E_(t[n],e,r))return!0}for(let n=0;n<e.length;n++)if(E_(e[n],t,r))return!0;return!1}function w_(e,t){if(e.length===0||t.length===0)return!1;for(let r=0;r<e.length-1;r++){const n=e[r],i=e[r+1];for(let s=0;s<t.length-1;s++)if(GC(n,i,t[s],t[s+1]))return!0}return!1}function GC(e,t,r,n){return mt(e,r,n)!==mt(t,r,n)&&mt(e,t,r)!==mt(e,t,n)}function E_(e,t,r){const n=r*r;if(t.length===1)return e.distSqr(t[0])<n;for(let i=1;i<t.length;i++)if(nb(e,t[i-1],t[i])<n)return!0;return!1}function nb(e,t,r){const n=t.distSqr(r);if(n===0)return e.distSqr(t);const i=((e.x-t.x)*(r.x-t.x)+(e.y-t.y)*(r.y-t.y))/n;return e.distSqr(i<0?t:i>1?r:r.sub(t)._mult(i)._add(t))}function ib(e,t){let r,n,i,s=!1;for(let a=0;a<e.length;a++){r=e[a];for(let l=0,p=r.length-1;l<r.length;p=l++)n=r[l],i=r[p],n.y>t.y!=i.y>t.y&&t.x<(i.x-n.x)*(t.y-n.y)/(i.y-n.y)+n.x&&(s=!s)}return s}function el(e,t){let r=!1;for(let n=0,i=e.length-1;n<e.length;i=n++){const s=e[n],a=e[i];s.y>t.y!=a.y>t.y&&t.x<(a.x-s.x)*(t.y-s.y)/(a.y-s.y)+s.x&&(r=!r)}return r}function ob(e,t,r,n,i){for(const a of e)if(t<=a.x&&r<=a.y&&n>=a.x&&i>=a.y)return!0;const s=[new H(t,r),new H(t,i),new H(n,i),new H(n,r)];if(e.length>2){for(const a of s)if(el(e,a))return!0}for(let a=0;a<e.length-1;a++)if(jC(e[a],e[a+1],s))return!0;return!1}function jC(e,t,r){const n=r[0],i=r[2];if(e.x<n.x&&t.x<n.x||e.x>i.x&&t.x>i.x||e.y<n.y&&t.y<n.y||e.y>i.y&&t.y>i.y)return!1;const s=mt(e,t,r[0]);return s!==mt(e,t,r[1])||s!==mt(e,t,r[2])||s!==mt(e,t,r[3])}function qu(e,t,r,n,i,s){let a=t.y-e.y,l=e.x-t.x;if(s=s||0){const p=a*a+l*l;if(p===0)return!0;const f=Math.sqrt(p);a/=f,l/=f}return!((r.x-e.x)*a+(r.y-e.y)*l-s<0||(n.x-e.x)*a+(n.y-e.y)*l-s<0||(i.x-e.x)*a+(i.y-e.y)*l-s<0)}function T_(e,t,r,n,i,s,a){return!(qu(e,t,n,i,s,a)||qu(t,r,n,i,s,a)||qu(r,e,n,i,s,a)||qu(n,i,e,t,r,a)||qu(i,s,e,t,r,a)||qu(s,n,e,t,r,a))}function Zu(e,t,r){const n=t.paint.get(e).value;return n.kind==="constant"?n.value:r.programConfigurations.get(t.id).getMaxValue(e)}function Cf(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function sb(e,t,r,n,i){if(!t[0]&&!t[1])return e;const s=H.convert(t)._mult(i);r==="viewport"&&s._rotate(-n);const a=[];for(let l=0;l<e.length;l++)a.push(e[l].sub(s));return a}function ab(e,t,r,n){const i=H.convert(e)._mult(n);return t==="viewport"&&i._rotate(-r),i}Ut(b_,"CircleBucket",{omit:["layers"]});const qC=new qr({"circle-sort-key":new te(rt.layout_circle["circle-sort-key"]),visibility:new Tt(rt.layout_circle.visibility)});var ZC={paint:new qr({"circle-radius":new te(rt.paint_circle["circle-radius"]),"circle-color":new te(rt.paint_circle["circle-color"]),"circle-blur":new te(rt.paint_circle["circle-blur"]),"circle-opacity":new te(rt.paint_circle["circle-opacity"]),"circle-translate":new Tt(rt.paint_circle["circle-translate"]),"circle-translate-anchor":new Tt(rt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Tt(rt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Tt(rt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new te(rt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new te(rt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new te(rt.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Tt(rt.paint_circle["circle-emissive-strength"])}),layout:qC};function lb(e,t,r,n,i,s,a,l,p){if(s&&e.queryGeometry.isAboveHorizon)return!1;s&&(p*=e.pixelToTileUnitsFactor);const f=e.tileID.canonical,m=r.projection.upVectorScale(f,r.center.lat,r.worldSize).metersToTile;for(const _ of t)for(const y of _){const v=y.add(l),b=i&&r.elevation?r.elevation.exaggeration()*i.getElevationAt(v.x,v.y,!0):0,w=r.projection.projectTilePoint(v.x,v.y,f);if(b>0){const M=r.projection.upVector(f,v.x,v.y);w.x+=M[0]*m*b,w.y+=M[1]*m*b,w.z+=M[2]*m*b}const E=s?v:XC(w.x,w.y,w.z,n),T=s?e.tilespaceRays.map(M=>HC(M,b)):e.queryGeometry.screenGeometry,C=gr.transformMat4([],[w.x,w.y,w.z,1],n);if(!a&&s?p*=C[3]/r.cameraToCenterDistance:a&&!s&&(p*=r.cameraToCenterDistance/C[3]),s){const M=fn((y.y/lt+f.y)/(1<<f.z));p/=r.projection.pixelsPerMeter(M,1)/cr(1,M)}if(VC(T,E,p))return!0}return!1}function XC(e,t,r,n){const i=gr.transformMat4([],[e,t,r,1],n);return new H(i[0]/i[3],i[1]/i[3])}const ub=q.fromValues(0,0,0),WC=q.fromValues(0,0,1);function HC(e,t){const r=q.create();return ub[2]=t,e.intersectsPlane(ub,WC,r),new H(r[0],r[1])}class cb extends b_{}function hb(e,{width:t,height:r},n,i){if(i){if(i instanceof Uint8ClampedArray)i=new Uint8Array(i.buffer);else if(i.length!==t*r*n)throw new RangeError("mismatched image size")}else i=new Uint8Array(t*r*n);return e.width=t,e.height=r,e.data=i,e}function pb(e,t,r){const{width:n,height:i}=t;n===e.width&&i===e.height||(I_(e,t,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,n),height:Math.min(e.height,i)},r),e.width=n,e.height=i,e.data=t.data)}function I_(e,t,r,n,i,s){if(i.width===0||i.height===0)return t;if(i.width>e.width||i.height>e.height||r.x>e.width-i.width||r.y>e.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>t.width||i.height>t.height||n.x>t.width-i.width||n.y>t.height-i.height)throw new RangeError("out of range destination coordinates for image copy");const a=e.data,l=t.data;for(let p=0;p<i.height;p++){const f=((r.y+p)*e.width+r.x)*s,m=((n.y+p)*t.width+n.x)*s;for(let _=0;_<i.width*s;_++)l[m+_]=a[f+_]}return t}Ut(cb,"HeatmapBucket",{omit:["layers"]});class ma{constructor(t,r){hb(this,t,1,r)}resize(t){pb(this,new ma(t),1)}clone(){return new ma({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,n,i,s){I_(t,r,n,i,s,1)}}class Yr{constructor(t,r){hb(this,t,4,r)}resize(t){pb(this,new Yr(t),4)}replace(t,r){r?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new Yr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,n,i,s){I_(t,r,n,i,s,4)}}Ut(ma,"AlphaImage"),Ut(Yr,"RGBAImage");const YC=new qr({visibility:new Tt(rt.layout_heatmap.visibility)});var $C={paint:new qr({"heatmap-radius":new te(rt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new te(rt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Tt(rt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ch(rt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Tt(rt.paint_heatmap["heatmap-opacity"])}),layout:YC};function Mf(e){const t={},r=e.resolution||256,n=e.clips?e.clips.length:1,i=e.image||new Yr({width:r,height:n}),s=(a,l,p)=>{t[e.evaluationKey]=p;const f=e.expression.evaluate(t);i.data[a+l+0]=Math.floor(255*f.r/f.a),i.data[a+l+1]=Math.floor(255*f.g/f.a),i.data[a+l+2]=Math.floor(255*f.b/f.a),i.data[a+l+3]=Math.floor(255*f.a)};if(e.clips)for(let a=0,l=0;a<n;++a,l+=4*r)for(let p=0,f=0;p<r;p++,f+=4){const m=p/(r-1),{start:_,end:y}=e.clips[a];s(l,f,_*(1-m)+y*m)}else for(let a=0,l=0;a<r;a++,l+=4)s(0,l,a/(r-1));return i}const KC=new qr({visibility:new Tt(rt.layout_hillshade.visibility)});var JC={paint:new qr({"hillshade-illumination-direction":new Tt(rt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Tt(rt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Tt(rt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Tt(rt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Tt(rt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Tt(rt.paint_hillshade["hillshade-accent-color"])}),layout:KC};const QC=Je([{name:"a_pos",components:2,type:"Int16"}],4),{members:tM}=QC;var S_={exports:{}};function Af(e,t,r){r=r||2;var n,i,s,a,l,p,f,m=t&&t.length,_=m?t[0]*r:e.length,y=fb(e,0,_,r,!0),v=[];if(!y||y.next===y.prev)return v;if(m&&(y=function(w,E,T,C){var M,A,P,L=[];for(M=0,A=E.length;M<A;M++)(P=fb(w,E[M]*C,M<A-1?E[M+1]*C:w.length,C,!1))===P.next&&(P.steiner=!0),L.push(lM(P));for(L.sort(oM),M=0;M<L.length;M++)T=sM(L[M],T);return T}(e,t,y,r)),e.length>80*r){n=s=e[0],i=a=e[1];for(var b=r;b<_;b+=r)(l=e[b])<n&&(n=l),(p=e[b+1])<i&&(i=p),l>s&&(s=l),p>a&&(a=p);f=(f=Math.max(s-n,a-i))!==0?32767/f:0}return vh(y,v,r,n,i,f,0),v}function fb(e,t,r,n,i){var s,a;if(i===A_(e,t,r,n)>0)for(s=t;s<r;s+=n)a=gb(s,e[s],e[s+1],a);else for(s=r-n;s>=t;s-=n)a=gb(s,e[s],e[s+1],a);return a&&Pf(a,a.next)&&(bh(a),a=a.next),a}function jl(e,t){if(!e)return e;t||(t=e);var r,n=e;do if(r=!1,n.steiner||!Pf(n,n.next)&&bn(n.prev,n,n.next)!==0)n=n.next;else{if(bh(n),(n=t=n.prev)===n.next)break;r=!0}while(r||n!==t);return t}function vh(e,t,r,n,i,s,a){if(e){!a&&s&&function(m,_,y,v){var b=m;do b.z===0&&(b.z=C_(b.x,b.y,_,y,v)),b.prevZ=b.prev,b.nextZ=b.next,b=b.next;while(b!==m);b.prevZ.nextZ=null,b.prevZ=null,function(w){var E,T,C,M,A,P,L,R,N=1;do{for(T=w,w=null,A=null,P=0;T;){for(P++,C=T,L=0,E=0;E<N&&(L++,C=C.nextZ);E++);for(R=N;L>0||R>0&&C;)L!==0&&(R===0||!C||T.z<=C.z)?(M=T,T=T.nextZ,L--):(M=C,C=C.nextZ,R--),A?A.nextZ=M:w=M,M.prevZ=A,A=M;T=C}A.nextZ=null,N*=2}while(P>1)}(b)}(e,n,i,s);for(var l,p,f=e;e.prev!==e.next;)if(l=e.prev,p=e.next,s?rM(e,n,i,s):eM(e))t.push(l.i/r|0),t.push(e.i/r|0),t.push(p.i/r|0),bh(e),e=p.next,f=p.next;else if((e=p)===f){a?a===1?vh(e=nM(jl(e),t,r),t,r,n,i,s,2):a===2&&iM(e,t,r,n,i,s):vh(jl(e),t,r,n,i,s,1);break}}}function eM(e){var t=e.prev,r=e,n=e.next;if(bn(t,r,n)>=0)return!1;for(var i=t.x,s=r.x,a=n.x,l=t.y,p=r.y,f=n.y,m=i<s?i<a?i:a:s<a?s:a,_=l<p?l<f?l:f:p<f?p:f,y=i>s?i>a?i:a:s>a?s:a,v=l>p?l>f?l:f:p>f?p:f,b=n.next;b!==t;){if(b.x>=m&&b.x<=y&&b.y>=_&&b.y<=v&&Xu(i,l,s,p,a,f,b.x,b.y)&&bn(b.prev,b,b.next)>=0)return!1;b=b.next}return!0}function rM(e,t,r,n){var i=e.prev,s=e,a=e.next;if(bn(i,s,a)>=0)return!1;for(var l=i.x,p=s.x,f=a.x,m=i.y,_=s.y,y=a.y,v=l<p?l<f?l:f:p<f?p:f,b=m<_?m<y?m:y:_<y?_:y,w=l>p?l>f?l:f:p>f?p:f,E=m>_?m>y?m:y:_>y?_:y,T=C_(v,b,t,r,n),C=C_(w,E,t,r,n),M=e.prevZ,A=e.nextZ;M&&M.z>=T&&A&&A.z<=C;){if(M.x>=v&&M.x<=w&&M.y>=b&&M.y<=E&&M!==i&&M!==a&&Xu(l,m,p,_,f,y,M.x,M.y)&&bn(M.prev,M,M.next)>=0||(M=M.prevZ,A.x>=v&&A.x<=w&&A.y>=b&&A.y<=E&&A!==i&&A!==a&&Xu(l,m,p,_,f,y,A.x,A.y)&&bn(A.prev,A,A.next)>=0))return!1;A=A.nextZ}for(;M&&M.z>=T;){if(M.x>=v&&M.x<=w&&M.y>=b&&M.y<=E&&M!==i&&M!==a&&Xu(l,m,p,_,f,y,M.x,M.y)&&bn(M.prev,M,M.next)>=0)return!1;M=M.prevZ}for(;A&&A.z<=C;){if(A.x>=v&&A.x<=w&&A.y>=b&&A.y<=E&&A!==i&&A!==a&&Xu(l,m,p,_,f,y,A.x,A.y)&&bn(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function nM(e,t,r){var n=e;do{var i=n.prev,s=n.next.next;!Pf(i,s)&&db(i,n,n.next,s)&&xh(i,s)&&xh(s,i)&&(t.push(i.i/r|0),t.push(n.i/r|0),t.push(s.i/r|0),bh(n),bh(n.next),n=e=s),n=n.next}while(n!==e);return jl(n)}function iM(e,t,r,n,i,s){var a=e;do{for(var l=a.next.next;l!==a.prev;){if(a.i!==l.i&&uM(a,l)){var p=mb(a,l);return a=jl(a,a.next),p=jl(p,p.next),vh(a,t,r,n,i,s,0),void vh(p,t,r,n,i,s,0)}l=l.next}a=a.next}while(a!==e)}function oM(e,t){return e.x-t.x}function sM(e,t){var r=function(i,s){var a,l=s,p=i.x,f=i.y,m=-1/0;do{if(f<=l.y&&f>=l.next.y&&l.next.y!==l.y){var _=l.x+(f-l.y)*(l.next.x-l.x)/(l.next.y-l.y);if(_<=p&&_>m&&(m=_,a=l.x<l.next.x?l:l.next,_===p))return a}l=l.next}while(l!==s);if(!a)return null;var y,v=a,b=a.x,w=a.y,E=1/0;l=a;do p>=l.x&&l.x>=b&&p!==l.x&&Xu(f<w?p:m,f,b,w,f<w?m:p,f,l.x,l.y)&&(y=Math.abs(f-l.y)/(p-l.x),xh(l,i)&&(y<E||y===E&&(l.x>a.x||l.x===a.x&&aM(a,l)))&&(a=l,E=y)),l=l.next;while(l!==v);return a}(e,t);if(!r)return t;var n=mb(r,e);return jl(n,n.next),jl(r,r.next)}function aM(e,t){return bn(e.prev,e,t.prev)<0&&bn(t.next,e,e.next)<0}function C_(e,t,r,n,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function lM(e){var t=e,r=e;do(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next;while(t!==e);return r}function Xu(e,t,r,n,i,s,a,l){return(i-a)*(t-l)>=(e-a)*(s-l)&&(e-a)*(n-l)>=(r-a)*(t-l)&&(r-a)*(s-l)>=(i-a)*(n-l)}function uM(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(r,n){var i=r;do{if(i.i!==r.i&&i.next.i!==r.i&&i.i!==n.i&&i.next.i!==n.i&&db(i,i.next,r,n))return!0;i=i.next}while(i!==r);return!1}(e,t)&&(xh(e,t)&&xh(t,e)&&function(r,n){var i=r,s=!1,a=(r.x+n.x)/2,l=(r.y+n.y)/2;do i.y>l!=i.next.y>l&&i.next.y!==i.y&&a<(i.next.x-i.x)*(l-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next;while(i!==r);return s}(e,t)&&(bn(e.prev,e,t.prev)||bn(e,t.prev,t))||Pf(e,t)&&bn(e.prev,e,e.next)>0&&bn(t.prev,t,t.next)>0)}function bn(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function Pf(e,t){return e.x===t.x&&e.y===t.y}function db(e,t,r,n){var i=Df(bn(e,t,r)),s=Df(bn(e,t,n)),a=Df(bn(r,n,e)),l=Df(bn(r,n,t));return i!==s&&a!==l||!(i!==0||!Lf(e,r,t))||!(s!==0||!Lf(e,n,t))||!(a!==0||!Lf(r,e,n))||!(l!==0||!Lf(r,t,n))}function Lf(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function Df(e){return e>0?1:e<0?-1:0}function xh(e,t){return bn(e.prev,e,e.next)<0?bn(e,t,e.next)>=0&&bn(e,e.prev,t)>=0:bn(e,t,e.prev)<0||bn(e,e.next,t)<0}function mb(e,t){var r=new M_(e.i,e.x,e.y),n=new M_(t.i,t.x,t.y),i=e.next,s=t.prev;return e.next=t,t.prev=e,r.next=i,i.prev=r,n.next=r,r.prev=n,s.next=n,n.prev=s,n}function gb(e,t,r,n){var i=new M_(e,t,r);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function bh(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function M_(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function A_(e,t,r,n){for(var i=0,s=t,a=r-n;s<r;s+=n)i+=(e[a]-e[s])*(e[s+1]+e[a+1]),a=s;return i}S_.exports=Af,S_.exports.default=Af,Af.deviation=function(e,t,r,n){var i=t&&t.length,s=Math.abs(A_(e,0,i?t[0]*r:e.length,r));if(i)for(var a=0,l=t.length;a<l;a++)s-=Math.abs(A_(e,t[a]*r,a<l-1?t[a+1]*r:e.length,r));var p=0;for(a=0;a<n.length;a+=3){var f=n[a]*r,m=n[a+1]*r,_=n[a+2]*r;p+=Math.abs((e[f]-e[_])*(e[m+1]-e[f+1])-(e[f]-e[m])*(e[_+1]-e[f+1]))}return s===0&&p===0?0:Math.abs((p-s)/s)},Af.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},n=0,i=0;i<e.length;i++){for(var s=0;s<e[i].length;s++)for(var a=0;a<t;a++)r.vertices.push(e[i][s][a]);i>0&&r.holes.push(n+=e[i-1].length)}return r};var Rf=Nt(S_.exports);function P_(e,t){const r=e.length;if(r<=1)return[e];const n=[];let i,s;for(let a=0;a<r;a++){const l=_t(e[a]);l!==0&&(e[a].area=Math.abs(l),s===void 0&&(s=l<0),s===l<0?(i&&n.push(i),i=[e[a]]):i.push(e[a]))}if(i&&n.push(i),t>1)for(let a=0;a<n.length;a++)n[a].length<=t||(WI(n[a],t,1,n[a].length-1,cM),n[a]=n[a].slice(0,t));return n}function cM(e,t){return t.area-e.area}function L_(e,t,r){const n=r.patternDependencies;let i=!1;for(const s of t){const a=s.paint.get(`${e}-pattern`);a.isConstant()||(i=!0);const l=a.constantOr(null);l&&(i=!0,n[l]=!0)}return i}function D_(e,t,r,n,i){const s=i.patternDependencies;for(const a of t){const l=a.paint.get(`${e}-pattern`).value;if(l.kind!=="constant"){let p=l.evaluate({zoom:n},r,{},i.availableImages);p=p&&p.name?p.name:p,s[p]=!0,r.patterns[a.id]=p}}return r}class Of{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new $i,this.indexArray=new xn,this.indexArray2=new qa,this.programConfigurations=new Ha(t.layers,t.zoom),this.segments=new mr,this.segments2=new mr,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.projection=t.projection}populate(t,r,n,i){this.hasPattern=L_("fill",this.layers,r);const s=this.layers[0].layout.get("fill-sort-key"),a=[];for(const{feature:l,id:p,index:f,sourceLayerIndex:m}of t){const _=this.layers[0]._featureFilter.needGeometry,y=tl(l,_);if(!this.layers[0]._featureFilter.filter(new jr(this.zoom),y,n))continue;const v=s?s.evaluate(y,{},n,r.availableImages):void 0,b={id:p,properties:l.properties,type:l.type,sourceLayerIndex:m,index:f,geometry:_?y.geometry:zs(l,n,i),patterns:{},sortKey:v};a.push(b)}s&&a.sort((l,p)=>l.sortKey-p.sortKey);for(const l of a){const{geometry:p,index:f,sourceLayerIndex:m}=l;if(this.hasPattern){const _=D_("fill",this.layers,l,this.zoom,r);this.patternFeatures.push(_)}else this.addFeature(l,p,f,n,{},r.availableImages,r.brightness);r.featureIndex.insert(t[f].feature,p,f,m,this.index)}}update(t,r,n,i,s){const a=Object.keys(t).length!==0;a&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,r,a?this.stateDependentLayers:this.layers,n,i,s)}addFeatures(t,r,n,i,s,a){for(const l of this.patternFeatures)this.addFeature(l,l.geometry,l.index,r,n,i,a)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,tM),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,r,n,i,s,a=[],l){for(const p of P_(r,500)){let f=0;for(const w of p)f+=w.length;const m=this.segments.prepareSegment(f,this.layoutVertexArray,this.indexArray),_=m.vertexLength,y=[],v=[];for(const w of p){if(w.length===0)continue;w!==p[0]&&v.push(y.length/2);const E=this.segments2.prepareSegment(w.length,this.layoutVertexArray,this.indexArray2),T=E.vertexLength;this.layoutVertexArray.emplaceBack(w[0].x,w[0].y),this.indexArray2.emplaceBack(T+w.length-1,T),y.push(w[0].x),y.push(w[0].y);for(let C=1;C<w.length;C++)this.layoutVertexArray.emplaceBack(w[C].x,w[C].y),this.indexArray2.emplaceBack(T+C-1,T+C),y.push(w[C].x),y.push(w[C].y);E.vertexLength+=w.length,E.primitiveLength+=w.length}const b=Rf(y,v);for(let w=0;w<b.length;w+=3)this.indexArray.emplaceBack(_+b[w],_+b[w+1],_+b[w+2]);m.vertexLength+=f,m.primitiveLength+=b.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,s,a,i,l)}}Ut(Of,"FillBucket",{omit:["layers","patternFeatures"]});const hM=new qr({"fill-sort-key":new te(rt.layout_fill["fill-sort-key"]),visibility:new Tt(rt.layout_fill.visibility)});var pM={paint:new qr({"fill-antialias":new Tt(rt.paint_fill["fill-antialias"]),"fill-opacity":new te(rt.paint_fill["fill-opacity"]),"fill-color":new te(rt.paint_fill["fill-color"]),"fill-outline-color":new te(rt.paint_fill["fill-outline-color"]),"fill-translate":new Tt(rt.paint_fill["fill-translate"]),"fill-translate-anchor":new Tt(rt.paint_fill["fill-translate-anchor"]),"fill-pattern":new te(rt.paint_fill["fill-pattern"]),"fill-emissive-strength":new Tt(rt.paint_fill["fill-emissive-strength"])}),layout:hM};const fM=Je([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),dM=Je([{name:"a_pos_end",components:4,type:"Int16"}]),mM=Je([{name:"a_centroid_pos",components:2,type:"Uint16"}]),gM=Je([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),_M=Je([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:yM}=fM;var Nf={},vM=Ve,_b=Wu;function Wu(e,t,r,n,i){this.properties={},this.extent=r,this.type=0,this._pbf=e,this._geometry=-1,this._keys=n,this._values=i,e.readFields(xM,this,t)}function xM(e,t,r){e==1?t.id=r.readVarint():e==2?function(n,i){for(var s=n.readVarint()+n.pos;n.pos<s;){var a=i._keys[n.readVarint()],l=i._values[n.readVarint()];i.properties[a]=l}}(r,t):e==3?t.type=r.readVarint():e==4&&(t._geometry=r.pos)}function bM(e){for(var t,r,n=0,i=0,s=e.length,a=s-1;i<s;a=i++)n+=((r=e[a]).x-(t=e[i]).x)*(t.y+r.y);return n}Wu.types=["Unknown","Point","LineString","Polygon"],Wu.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var t,r=e.readVarint()+e.pos,n=1,i=0,s=0,a=0,l=[];e.pos<r;){if(i<=0){var p=e.readVarint();n=7&p,i=p>>3}if(i--,n===1||n===2)s+=e.readSVarint(),a+=e.readSVarint(),n===1&&(t&&l.push(t),t=[]),t.push(new vM(s,a));else{if(n!==7)throw new Error("unknown command "+n);t&&t.push(t[0].clone())}}return t&&l.push(t),l},Wu.prototype.bbox=function(){var e=this._pbf;e.pos=this._geometry;for(var t=e.readVarint()+e.pos,r=1,n=0,i=0,s=0,a=1/0,l=-1/0,p=1/0,f=-1/0;e.pos<t;){if(n<=0){var m=e.readVarint();r=7&m,n=m>>3}if(n--,r===1||r===2)(i+=e.readSVarint())<a&&(a=i),i>l&&(l=i),(s+=e.readSVarint())<p&&(p=s),s>f&&(f=s);else if(r!==7)throw new Error("unknown command "+r)}return[a,p,l,f]},Wu.prototype.toGeoJSON=function(e,t,r){var n,i,s=this.extent*Math.pow(2,r),a=this.extent*e,l=this.extent*t,p=this.loadGeometry(),f=Wu.types[this.type];function m(v){for(var b=0;b<v.length;b++){var w=v[b];v[b]=[360*(w.x+a)/s-180,360/Math.PI*Math.atan(Math.exp((180-360*(w.y+l)/s)*Math.PI/180))-90]}}switch(this.type){case 1:var _=[];for(n=0;n<p.length;n++)_[n]=p[n][0];m(p=_);break;case 2:for(n=0;n<p.length;n++)m(p[n]);break;case 3:for(p=function(v){var b=v.length;if(b<=1)return[v];for(var w,E,T=[],C=0;C<b;C++){var M=bM(v[C]);M!==0&&(E===void 0&&(E=M<0),E===M<0?(w&&T.push(w),w=[v[C]]):w.push(v[C]))}return w&&T.push(w),T}(p),n=0;n<p.length;n++)for(i=0;i<p[n].length;i++)m(p[n][i])}p.length===1?p=p[0]:f="Multi"+f;var y={type:"Feature",geometry:{type:f,coordinates:p},properties:this.properties};return"id"in this&&(y.id=this.id),y};var wM=_b,yb=vb;function vb(e,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(EM,this,t),this.length=this._features.length}function EM(e,t,r){e===15?t.version=r.readVarint():e===1?t.name=r.readString():e===5?t.extent=r.readVarint():e===2?t._features.push(r.pos):e===3?t._keys.push(r.readString()):e===4&&t._values.push(function(n){for(var i=null,s=n.readVarint()+n.pos;n.pos<s;){var a=n.readVarint()>>3;i=a===1?n.readString():a===2?n.readFloat():a===3?n.readDouble():a===4?n.readVarint64():a===5?n.readVarint():a===6?n.readSVarint():a===7?n.readBoolean():null}return i}(r))}vb.prototype.feature=function(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];var t=this._pbf.readVarint()+this._pbf.pos;return new wM(this._pbf,t,this.extent,this._keys,this._values)};var TM=yb;function IM(e,t,r){if(e===3){var n=new TM(r,r.readVarint()+r.pos);n.length&&(t[n.name]=n)}}var R_=Nf.VectorTile=function(e,t){this.layers=e.readFields(IM,{},t)},zf=Nf.VectorTileFeature=_b;function kf(e,t,r,n){const i=[],s=n===0?(a,l,p,f,m,_)=>{a.push(new H(_,p+(_-l)/(f-l)*(m-p)))}:(a,l,p,f,m,_)=>{a.push(new H(l+(_-p)/(m-p)*(f-l),_))};for(const a of e){const l=[];for(const p of a){if(p.length<=2)continue;const f=[];for(let y=0;y<p.length-1;y++){const v=p[y].x,b=p[y].y,w=p[y+1].x,E=p[y+1].y,T=n===0?v:b,C=n===0?w:E;T<t?C>t&&s(f,v,b,w,E,t):T>r?C<r&&s(f,v,b,w,E,r):f.push(p[y]),C<t&&T>=t&&s(f,v,b,w,E,t),C>r&&T<=r&&s(f,v,b,w,E,r)}let m=p[p.length-1];const _=n===0?m.x:m.y;_>=t&&_<=r&&f.push(m),f.length&&(m=f[f.length-1],f[0].x===m.x&&f[0].y===m.y||f.push(f[0]),l.push(f))}l.length&&i.push(l)}return i}Nf.VectorTileLayer=yb;class xb{constructor(t){this._stringToNumber={},this._numberToString=[];for(let r=0;r<t.length;r++){const n=t[r];this._stringToNumber[n]=r,this._numberToString[r]=n}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}var SM={read:function(e,t,r,n,i){var s,a,l=8*i-n-1,p=(1<<l)-1,f=p>>1,m=-7,_=r?i-1:0,y=r?-1:1,v=e[t+_];for(_+=y,s=v&(1<<-m)-1,v>>=-m,m+=l;m>0;s=256*s+e[t+_],_+=y,m-=8);for(a=s&(1<<-m)-1,s>>=-m,m+=n;m>0;a=256*a+e[t+_],_+=y,m-=8);if(s===0)s=1-f;else{if(s===p)return a?NaN:1/0*(v?-1:1);a+=Math.pow(2,n),s-=f}return(v?-1:1)*a*Math.pow(2,s-n)},write:function(e,t,r,n,i,s){var a,l,p,f=8*s-i-1,m=(1<<f)-1,_=m>>1,y=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,v=n?0:s-1,b=n?1:-1,w=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,a=m):(a=Math.floor(Math.log(t)/Math.LN2),t*(p=Math.pow(2,-a))<1&&(a--,p*=2),(t+=a+_>=1?y/p:y*Math.pow(2,1-_))*p>=2&&(a++,p/=2),a+_>=m?(l=0,a=m):a+_>=1?(l=(t*p-1)*Math.pow(2,i),a+=_):(l=t*Math.pow(2,_-1)*Math.pow(2,i),a=0));i>=8;e[r+v]=255&l,v+=b,l/=256,i-=8);for(a=a<<i|l,f+=i;f>0;e[r+v]=255&a,v+=b,a/=256,f-=8);e[r+v-b]|=128*w}},bb=Lr,Ff=SM;function Lr(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}Lr.Varint=0,Lr.Fixed64=1,Lr.Bytes=2,Lr.Fixed32=5;var O_=4294967296,wb=1/O_,Eb=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function ga(e){return e.type===Lr.Bytes?e.readVarint()+e.pos:e.pos+1}function Hu(e,t,r){return r?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function Tb(e,t,r){var n=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(n);for(var i=r.pos-1;i>=e;i--)r.buf[i+n]=r.buf[i]}function CM(e,t){for(var r=0;r<e.length;r++)t.writeVarint(e[r])}function MM(e,t){for(var r=0;r<e.length;r++)t.writeSVarint(e[r])}function AM(e,t){for(var r=0;r<e.length;r++)t.writeFloat(e[r])}function PM(e,t){for(var r=0;r<e.length;r++)t.writeDouble(e[r])}function LM(e,t){for(var r=0;r<e.length;r++)t.writeBoolean(e[r])}function DM(e,t){for(var r=0;r<e.length;r++)t.writeFixed32(e[r])}function RM(e,t){for(var r=0;r<e.length;r++)t.writeSFixed32(e[r])}function OM(e,t){for(var r=0;r<e.length;r++)t.writeFixed64(e[r])}function NM(e,t){for(var r=0;r<e.length;r++)t.writeSFixed64(e[r])}function Bf(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function Yu(e,t,r){e[r]=t,e[r+1]=t>>>8,e[r+2]=t>>>16,e[r+3]=t>>>24}function Ib(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}Lr.prototype={destroy:function(){this.buf=null},readFields:function(e,t,r){for(r=r||this.length;this.pos<r;){var n=this.readVarint(),i=n>>3,s=this.pos;this.type=7&n,e(i,t,this),this.pos===s&&this.skip(n)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=Bf(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=Ib(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=Bf(this.buf,this.pos)+Bf(this.buf,this.pos+4)*O_;return this.pos+=8,e},readSFixed64:function(){var e=Bf(this.buf,this.pos)+Ib(this.buf,this.pos+4)*O_;return this.pos+=8,e},readFloat:function(){var e=Ff.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=Ff.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,r,n=this.buf;return t=127&(r=n[this.pos++]),r<128?t:(t|=(127&(r=n[this.pos++]))<<7,r<128?t:(t|=(127&(r=n[this.pos++]))<<14,r<128?t:(t|=(127&(r=n[this.pos++]))<<21,r<128?t:function(i,s,a){var l,p,f=a.buf;if(l=(112&(p=f[a.pos++]))>>4,p<128||(l|=(127&(p=f[a.pos++]))<<3,p<128)||(l|=(127&(p=f[a.pos++]))<<10,p<128)||(l|=(127&(p=f[a.pos++]))<<17,p<128)||(l|=(127&(p=f[a.pos++]))<<24,p<128)||(l|=(1&(p=f[a.pos++]))<<31,p<128))return Hu(i,l,s);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(r=n[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&Eb?function(r,n,i){return Eb.decode(r.subarray(n,i))}(this.buf,t,e):function(r,n,i){for(var s="",a=n;a<i;){var l,p,f,m=r[a],_=null,y=m>239?4:m>223?3:m>191?2:1;if(a+y>i)break;y===1?m<128&&(_=m):y===2?(192&(l=r[a+1]))==128&&(_=(31&m)<<6|63&l)<=127&&(_=null):y===3?(p=r[a+2],(192&(l=r[a+1]))==128&&(192&p)==128&&((_=(15&m)<<12|(63&l)<<6|63&p)<=2047||_>=55296&&_<=57343)&&(_=null)):y===4&&(p=r[a+2],f=r[a+3],(192&(l=r[a+1]))==128&&(192&p)==128&&(192&f)==128&&((_=(15&m)<<18|(63&l)<<12|(63&p)<<6|63&f)<=65535||_>=1114112)&&(_=null)),_===null?(_=65533,y=1):_>65535&&(_-=65536,s+=String.fromCharCode(_>>>10&1023|55296),_=56320|1023&_),s+=String.fromCharCode(_),a+=y}return s}(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==Lr.Bytes)return e.push(this.readVarint(t));var r=ga(this);for(e=e||[];this.pos<r;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==Lr.Bytes)return e.push(this.readSVarint());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==Lr.Bytes)return e.push(this.readBoolean());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==Lr.Bytes)return e.push(this.readFloat());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==Lr.Bytes)return e.push(this.readDouble());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==Lr.Bytes)return e.push(this.readFixed32());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==Lr.Bytes)return e.push(this.readSFixed32());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==Lr.Bytes)return e.push(this.readFixed64());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==Lr.Bytes)return e.push(this.readSFixed64());var t=ga(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===Lr.Varint)for(;this.buf[this.pos++]>127;);else if(t===Lr.Bytes)this.pos=this.readVarint()+this.pos;else if(t===Lr.Fixed32)this.pos+=4;else{if(t!==Lr.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),Yu(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),Yu(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),Yu(this.buf,-1&e,this.pos),Yu(this.buf,Math.floor(e*wb),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),Yu(this.buf,-1&e,this.pos),Yu(this.buf,Math.floor(e*wb),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(t,r){var n,i;if(t>=0?(n=t%4294967296|0,i=t/4294967296|0):(i=~(-t/4294967296),4294967295^(n=~(-t%4294967296))?n=n+1|0:(n=0,i=i+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(s,a,l){l.buf[l.pos++]=127&s|128,s>>>=7,l.buf[l.pos++]=127&s|128,s>>>=7,l.buf[l.pos++]=127&s|128,s>>>=7,l.buf[l.pos++]=127&s|128,l.buf[l.pos]=127&(s>>>=7)}(n,0,r),function(s,a){var l=(7&s)<<4;a.buf[a.pos++]|=l|((s>>>=3)?128:0),s&&(a.buf[a.pos++]=127&s|((s>>>=7)?128:0),s&&(a.buf[a.pos++]=127&s|((s>>>=7)?128:0),s&&(a.buf[a.pos++]=127&s|((s>>>=7)?128:0),s&&(a.buf[a.pos++]=127&s|((s>>>=7)?128:0),s&&(a.buf[a.pos++]=127&s)))))}(i,r)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(!!e)},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(n,i,s){for(var a,l,p=0;p<i.length;p++){if((a=i.charCodeAt(p))>55295&&a<57344){if(!l){a>56319||p+1===i.length?(n[s++]=239,n[s++]=191,n[s++]=189):l=a;continue}if(a<56320){n[s++]=239,n[s++]=191,n[s++]=189,l=a;continue}a=l-55296<<10|a-56320|65536,l=null}else l&&(n[s++]=239,n[s++]=191,n[s++]=189,l=null);a<128?n[s++]=a:(a<2048?n[s++]=a>>6|192:(a<65536?n[s++]=a>>12|224:(n[s++]=a>>18|240,n[s++]=a>>12&63|128),n[s++]=a>>6&63|128),n[s++]=63&a|128)}return s}(this.buf,e,this.pos);var r=this.pos-t;r>=128&&Tb(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r},writeFloat:function(e){this.realloc(4),Ff.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),Ff.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var r=0;r<t;r++)this.buf[this.pos++]=e[r]},writeRawMessage:function(e,t){this.pos++;var r=this.pos;e(t,this);var n=this.pos-r;n>=128&&Tb(r,n,this),this.pos=r-1,this.writeVarint(n),this.pos+=n},writeMessage:function(e,t,r){this.writeTag(e,Lr.Bytes),this.writeRawMessage(t,r)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,CM,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,MM,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,LM,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,AM,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,PM,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,DM,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,RM,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,OM,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,NM,t)},writeBytesField:function(e,t){this.writeTag(e,Lr.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,Lr.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,Lr.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,Lr.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,Lr.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,Lr.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,Lr.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,Lr.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,Lr.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,Lr.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,!!t)}};var Vf=Nt(bb);const zM=["tile","layer","source","sourceLayer","state"];class Sb{constructor(t,r,n,i,s){this.type="Feature",this._vectorTileFeature=t,this._z=r,this._x=n,this._y=i,this.properties=t.properties,this.id=s}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};this.id!==void 0&&(t.id=this.id);for(const r of zM)this[r]!==void 0&&(t[r]=this[r]);return t}}class kM{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,r,n){const i=String(r);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][i]=this.stateChanges[t][i]||{},Yt(this.stateChanges[t][i],n),this.deletedStates[t]===null){this.deletedStates[t]={};for(const s in this.state[t])s!==i&&(this.deletedStates[t][s]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][i]===null){this.deletedStates[t][i]={};for(const s in this.state[t][i])n[s]||(this.deletedStates[t][i][s]=null)}else for(const s in n)this.deletedStates[t]&&this.deletedStates[t][i]&&this.deletedStates[t][i][s]===null&&delete this.deletedStates[t][i][s]}removeFeatureState(t,r,n){if(this.deletedStates[t]===null)return;const i=String(r);if(this.deletedStates[t]=this.deletedStates[t]||{},n&&r!==void 0)this.deletedStates[t][i]!==null&&(this.deletedStates[t][i]=this.deletedStates[t][i]||{},this.deletedStates[t][i][n]=null);else if(r!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][i])for(n in this.deletedStates[t][i]={},this.stateChanges[t][i])this.deletedStates[t][i][n]=null;else this.deletedStates[t][i]=null;else this.deletedStates[t]=null}getState(t,r){const n=String(r),i=Yt({},(this.state[t]||{})[n],(this.stateChanges[t]||{})[n]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const s=this.deletedStates[t][r];if(s===null)return{};for(const a in s)delete i[a]}return i}initializeTileState(t,r){t.setFeatureState(this.state,r)}coalesceChanges(t,r){const n={};for(const i in this.stateChanges){this.state[i]=this.state[i]||{};const s={};for(const a in this.stateChanges[i])this.state[i][a]||(this.state[i][a]={}),Yt(this.state[i][a],this.stateChanges[i][a]),s[a]=this.state[i][a];n[i]=s}for(const i in this.deletedStates){this.state[i]=this.state[i]||{};const s={};if(this.deletedStates[i]===null)for(const a in this.state[i])s[a]={},this.state[i][a]={};else for(const a in this.deletedStates[i]){if(this.deletedStates[i][a]===null)this.state[i][a]={};else if(this.state[i][a])for(const l of Object.keys(this.deletedStates[i][a]))delete this.state[i][a][l];s[a]=this.state[i][a]}n[i]=n[i]||{},Yt(n[i],s)}if(this.stateChanges={},this.deletedStates={},Object.keys(n).length!==0)for(const i in t)t[i].setFeatureState(n,r)}}class Cb{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,r){const n=this.toIdx(t,r);return{min:this.minimums[n],max:this.maximums[n]}}isLeaf(t,r){return this.leaves[this.toIdx(t,r)]}toIdx(t,r){return r*this.size+t}}function Mb(e,t,r,n){let i=0,s=Number.MAX_VALUE;for(let a=0;a<3;a++)if(Math.abs(n[a])<1e-15){if(r[a]<e[a]||r[a]>t[a])return null}else{const l=1/n[a];let p=(e[a]-r[a])*l,f=(t[a]-r[a])*l;if(p>f){const m=p;p=f,f=m}if(p>i&&(i=p),f<s&&(s=f),i>s)return null}return i}function Ab(e,t,r,n,i,s,a,l,p,f,m){const _=n-e,y=i-t,v=s-r,b=a-e,w=l-t,E=p-r,T=m[1]*E-m[2]*w,C=m[2]*b-m[0]*E,M=m[0]*w-m[1]*b,A=_*T+y*C+v*M;if(Math.abs(A)<1e-15)return null;const P=1/A,L=f[0]-e,R=f[1]-t,N=f[2]-r,k=(L*T+R*C+N*M)*P;if(k<0||k>1)return null;const F=R*v-N*y,z=N*_-L*v,U=L*y-R*_,G=(m[0]*F+m[1]*z+m[2]*U)*P;return G<0||k+G>1?null:(b*F+w*z+E*U)*P}function Pb(e,t,r){return(e-t)/(r-t)}function Lb(e,t,r,n,i,s,a,l,p){const f=1<<r,m=s-n,_=a-i,y=(e+1)/f*m+n,v=(t+0)/f*_+i,b=(t+1)/f*_+i;l[0]=(e+0)/f*m+n,l[1]=v,p[0]=y,p[1]=b}class Db{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const r=function(s){const a=Math.ceil(Math.log2(s.dim/8)),l=[];let p=Math.ceil(Math.pow(2,a));const f=1/p,m=(v,b,w,E,T)=>{const C=E?1:0,M=(v+1)*w-C,A=b*w,P=(b+1)*w-C;T[0]=v*w,T[1]=A,T[2]=M,T[3]=P};let _=new Cb(p);const y=[];for(let v=0;v<p*p;v++){m(v%p,Math.floor(v/p),f,!1,y);const b=rl(y[0],y[1],s),w=rl(y[2],y[1],s),E=rl(y[2],y[3],s),T=rl(y[0],y[3],s);_.minimums.push(Math.min(b,w,E,T)),_.maximums.push(Math.max(b,w,E,T)),_.leaves.push(1)}for(l.push(_),p/=2;p>=1;p/=2){const v=l[l.length-1];_=new Cb(p);for(let b=0;b<p*p;b++){m(b%p,Math.floor(b/p),2,!0,y);const w=v.getElevation(y[0],y[1]),E=v.getElevation(y[2],y[1]),T=v.getElevation(y[2],y[3]),C=v.getElevation(y[0],y[3]),M=v.isLeaf(y[0],y[1]),A=v.isLeaf(y[2],y[1]),P=v.isLeaf(y[2],y[3]),L=v.isLeaf(y[0],y[3]),R=Math.min(w.min,E.min,T.min,C.min),N=Math.max(w.max,E.max,T.max,C.max),k=M&&A&&P&&L;_.maximums.push(N),_.minimums.push(R),_.leaves.push(N-R<=5&&k?1:0)}l.push(_)}return l}(this.dem),n=r.length-1,i=r[n];this._addNode(i.minimums[0],i.maximums[0],i.leaves[0]),this._construct(r,0,0,n,0)}raycastRoot(t,r,n,i,s,a,l=1){return Mb([t,r,-100],[n,i,this.maximums[0]*l],s,a)}raycast(t,r,n,i,s,a,l=1){if(!this.nodeCount)return null;const p=this.raycastRoot(t,r,n,i,s,a,l);if(p==null)return null;const f=[],m=[],_=[],y=[],v=[{idx:0,t:p,nodex:0,nodey:0,depth:0}];for(;v.length>0;){const{idx:b,t:w,nodex:E,nodey:T,depth:C}=v.pop();if(this.leaves[b]){Lb(E,T,C,t,r,n,i,_,y);const A=1<<C,P=(E+0)/A,L=(E+1)/A,R=(T+0)/A,N=(T+1)/A,k=rl(P,R,this.dem)*l,F=rl(L,R,this.dem)*l,z=rl(L,N,this.dem)*l,U=rl(P,N,this.dem)*l,G=Ab(_[0],_[1],k,y[0],_[1],F,y[0],y[1],z,s,a),V=Ab(y[0],y[1],z,_[0],y[1],U,_[0],_[1],k,s,a),K=Math.min(G!==null?G:Number.MAX_VALUE,V!==null?V:Number.MAX_VALUE);if(K!==Number.MAX_VALUE)return K;{const $=q.scaleAndAdd([],s,a,w);if(Rb(k,F,U,z,Pb($[0],_[0],y[0]),Pb($[1],_[1],y[1]))>=$[2])return w}continue}let M=0;for(let A=0;A<this._siblingOffset.length;A++){Lb((E<<1)+this._siblingOffset[A][0],(T<<1)+this._siblingOffset[A][1],C+1,t,r,n,i,_,y),_[2]=-100,y[2]=this.maximums[this.childOffsets[b]+A]*l;const P=Mb(_,y,s,a);if(P!=null){const L=P;f[A]=L;let R=!1;for(let N=0;N<M&&!R;N++)L>=f[m[N]]&&(m.splice(N,0,A),R=!0);R||(m[M]=A),M++}}for(let A=0;A<M;A++){const P=m[A];v.push({idx:this.childOffsets[b]+P,t:f[P],nodex:(E<<1)+this._siblingOffset[P][0],nodey:(T<<1)+this._siblingOffset[P][1],depth:C+1})}}return null}_addNode(t,r,n){return this.minimums.push(t),this.maximums.push(r),this.leaves.push(n),this.childOffsets.push(0),this.nodeCount++}_construct(t,r,n,i,s){if(t[i].isLeaf(r,n)===1)return;this.childOffsets[s]||(this.childOffsets[s]=this.nodeCount);const a=i-1,l=t[a];let p=0,f=0;for(let m=0;m<this._siblingOffset.length;m++){const _=2*r+this._siblingOffset[m][0],y=2*n+this._siblingOffset[m][1],v=l.getElevation(_,y),b=l.isLeaf(_,y),w=this._addNode(v.min,v.max,b);b&&(p|=1<<m),f||(f=w)}for(let m=0;m<this._siblingOffset.length;m++)p&1<<m||this._construct(t,2*r+this._siblingOffset[m][0],2*n+this._siblingOffset[m][1],a,f+m)}}function Rb(e,t,r,n,i,s){return ce(ce(e,r,s),ce(t,n,s),i)}function rl(e,t,r){const n=r.dim,i=Bt(e*n-.5,0,n-1),s=Bt(t*n-.5,0,n-1),a=Math.floor(i),l=Math.floor(s),p=Math.min(a+1,n-1),f=Math.min(l+1,n-1);return Rb(r.get(a,l),r.get(p,l),r.get(a,f),r.get(p,f),i-a,s-l)}const Ob={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function FM(e,t,r){return(256*e*256+256*t+r)/10-1e4}function BM(e,t,r){return 256*e+t+r/256-32768}class $u{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,r,n,i=!1,s=!1){if(this.uid=t,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(n&&n!=="mapbox"&&n!=="terrarium")return Y(`"${n}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=r.height;const a=this.dim=r.height-2,l=new Uint32Array(r.data.buffer);if(this.pixels=new Uint8Array(r.data.buffer),this.encoding=n||"mapbox",this.borderReady=i,!i){for(let p=0;p<a;p++)l[this._idx(-1,p)]=l[this._idx(0,p)],l[this._idx(a,p)]=l[this._idx(a-1,p)],l[this._idx(p,-1)]=l[this._idx(p,0)],l[this._idx(p,a)]=l[this._idx(p,a-1)];l[this._idx(-1,-1)]=l[this._idx(0,0)],l[this._idx(a,-1)]=l[this._idx(a-1,0)],l[this._idx(-1,a)]=l[this._idx(0,a-1)],l[this._idx(a,a)]=l[this._idx(a-1,a-1)],s&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new Db(this)}get(t,r,n=!1){n&&(t=Bt(t,-1,this.dim),r=Bt(r,-1,this.dim));const i=4*this._idx(t,r);return(this.encoding==="terrarium"?BM:FM)(this.pixels[i],this.pixels[i+1],this.pixels[i+2])}static getUnpackVector(t){return Ob[t]}get unpackVector(){return Ob[this.encoding]}_idx(t,r){if(t<-1||t>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError(`out of range source coordinates for DEM; coords = (${t}, ${r}), dim = ${this.dim}, stride = ${this.stride}`);return(r+1)*this.stride+(t+1)}static pack(t,r){const n=[0,0,0,0],i=$u.getUnpackVector(r);let s=Math.floor((t+i[3])/i[2]);return n[2]=s%256,s=Math.floor(s/256),n[1]=s%256,s=Math.floor(s/256),n[0]=s,n}getPixels(){return new Yr({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,r,n){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let i=r*this.dim,s=r*this.dim+this.dim,a=n*this.dim,l=n*this.dim+this.dim;switch(r){case-1:i=s-1;break;case 1:s=i+1}switch(n){case-1:a=l-1;break;case 1:l=a+1}const p=-r*this.dim,f=-n*this.dim;for(let m=a;m<l;m++)for(let _=i;_<s;_++){const y=4*this._idx(_,m),v=4*this._idx(_+p,m+f);this.pixels[y+0]=t.pixels[v+0],this.pixels[y+1]=t.pixels[v+1],this.pixels[y+2]=t.pixels[v+2],this.pixels[y+3]=t.pixels[v+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Ut($u,"DEMData"),Ut(Db,"DemMinMaxQuadTree",{omit:["dem"]});class VM{isDataAvailableAtPoint(t){const r=this._source();if(this.isUsingMockSource()||!r||t.y<0||t.y>1)return!1;const n=r.getSource().maxzoom,i=1<<n,s=Math.floor(t.x),a=Math.floor((t.x-s)*i),l=Math.floor(t.y*i),p=this.findDEMTileFor(new wr(n,s,n,a,l));return!(!p||!p.dem)}getAtPointOrZero(t,r=0){return this.getAtPoint(t,r)||0}getAtPoint(t,r,n=!0){if(this.isUsingMockSource())return null;r==null&&(r=null);const i=this._source();if(!i||t.y<0||t.y>1)return r;const s=i.getSource().maxzoom,a=1<<s,l=Math.floor(t.x),p=t.x-l,f=new wr(s,l,s,Math.floor(p*a),Math.floor(t.y*a)),m=this.findDEMTileFor(f);if(!m||!m.dem)return r;const _=m.dem,y=1<<m.tileID.canonical.z,v=(p*y-m.tileID.canonical.x)*_.dim,b=(t.y*y-m.tileID.canonical.y)*_.dim,w=Math.floor(v),E=Math.floor(b);return(n?this.exaggeration():1)*ce(ce(_.get(w,E),_.get(w,E+1),b-E),ce(_.get(w+1,E),_.get(w+1,E+1),b-E),v-w)}getAtTileOffset(t,r,n){const i=1<<t.canonical.z;return this.getAtPointOrZero(new Ue(t.wrap+(t.canonical.x+r/lt)/i,(t.canonical.y+n/lt)/i))}getAtTileOffsetFunc(t,r,n,i){return s=>{const a=this.getAtTileOffset(t,s.x,s.y),l=i.upVector(t.canonical,s.x,s.y),p=i.upVectorScale(t.canonical,r,n).metersToTile;return q.scale(l,l,a*p),l}}getForTilePoints(t,r,n,i){if(this.isUsingMockSource())return!1;const s=Ku.create(this,t,i);return!!s&&(r.forEach(a=>{a[2]=this.exaggeration()*s.getElevationAt(a[0],a[1],n)}),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const r=this.findDEMTileFor(t);if(!r||!r.dem)return null;const n=r.dem.tree,i=r.tileID,s=1<<t.canonical.z-i.canonical.z;let a=t.canonical.x/s-i.canonical.x,l=t.canonical.y/s-i.canonical.y,p=0;for(let f=0;f<t.canonical.z-i.canonical.z&&!n.leaves[p];f++){a*=2,l*=2;const m=2*Math.floor(l)+Math.floor(a);p=n.childOffsets[p]+m,a%=1,l%=1}return{min:this.exaggeration()*n.minimums[p],max:this.exaggeration()*n.maximums[p]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,r,n){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}}class Ku{constructor(t,r,n){this._demTile=t,this._dem=this._demTile.dem,this._scale=r,this._offset=n}static create(t,r,n){const i=n||t.findDEMTileFor(r);if(!i||!i.dem)return;const s=i.dem,a=i.tileID,l=1<<r.canonical.z-a.canonical.z;return new Ku(i,i.tileSize/lt/l,[(r.canonical.x/l-a.canonical.x)*s.dim,(r.canonical.y/l-a.canonical.y)*s.dim])}tileCoordToPixel(t,r){const n=r*this._scale+this._offset[1],i=Math.floor(t*this._scale+this._offset[0]),s=Math.floor(n);return new H(i,s)}getElevationAt(t,r,n,i){const s=t*this._scale+this._offset[0],a=r*this._scale+this._offset[1],l=Math.floor(s),p=Math.floor(a),f=this._dem;return i=!!i,n?ce(ce(f.get(l,p,i),f.get(l,p+1,i),a-p),ce(f.get(l+1,p,i),f.get(l+1,p+1,i),a-p),s-l):f.get(l,p,i)}getElevationAtPixel(t,r,n){return this._dem.get(t,r,!!n)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*cr(1,t)*this._dem.stride}}class N_{constructor(t,r){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Du(lt,16,0),this.featureIndexArray=new dx,this.promoteId=r}insert(t,r,n,i,s,a=0){const l=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(n,i,s,a);const p=this.grid;for(let f=0;f<r.length;f++){const m=r[f],_=[1/0,1/0,-1/0,-1/0];for(let y=0;y<m.length;y++){const v=m[y];_[0]=Math.min(_[0],v.x),_[1]=Math.min(_[1],v.y),_[2]=Math.max(_[2],v.x),_[3]=Math.max(_[3],v.y)}_[0]<lt&&_[1]<lt&&_[2]>=0&&_[3]>=0&&p.insert(l,_[0],_[1],_[2],_[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new R_(new Vf(this.rawTileData)).layers,this.sourceLayerCoder=new xb(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,r,n,i){this.loadVTLayers();const s=t.params||{},a=Jp(s.filter),l=t.tileResult,p=t.transform,f=l.bufferedTilespaceBounds,m=this.grid.query(f.min.x,f.min.y,f.max.x,f.max.y,(b,w,E,T)=>ob(l.bufferedTilespaceGeometry,b,w,E,T));m.sort(UM);let _=null;p.elevation&&m.length>0&&(_=Ku.create(p.elevation,this.tileID));const y={};let v;for(let b=0;b<m.length;b++){const w=m[b];if(w===v)continue;v=w;const E=this.featureIndexArray.get(w);let T=null;this.loadMatchingFeature(y,E,a,s.layers,s.availableImages,r,n,i,(C,M,A,P=0)=>(T||(T=zs(C,this.tileID.canonical,t.tileTransform)),M.queryIntersectsFeature(l,C,A,T,this.z,t.transform,t.pixelPosMatrix,_,P)))}return y}loadMatchingFeature(t,r,n,i,s,a,l,p,f){const{featureIndex:m,bucketIndex:_,sourceLayerIndex:y,layoutVertexArrayOffset:v}=r,b=this.bucketLayerIDs[_];if(i&&!function(C,M){for(let A=0;A<C.length;A++)if(M.indexOf(C[A])>=0)return!0;return!1}(i,b))return;const w=this.sourceLayerCoder.decode(y),E=this.vtLayers[w].feature(m);if(n.needGeometry){const C=tl(E,!0);if(!n.filter(new jr(this.tileID.overscaledZ),C,this.tileID.canonical))return}else if(!n.filter(new jr(this.tileID.overscaledZ),E))return;const T=this.getId(E,w);for(let C=0;C<b.length;C++){const M=b[C];if(i&&i.indexOf(M)<0)continue;const A=a[M];if(!A)continue;let P={};T!==void 0&&p&&(P=p.getState(A.sourceLayer||"_geojsonTileLayer",T));const L=Yt({},l[M]);L.paint=Nb(L.paint,A.paint,E,P,s),L.layout=Nb(L.layout,A.layout,E,P,s);const R=!f||f(E,A,P,v);if(!R)continue;const N=new Sb(E,this.z,this.x,this.y,T);N.layer=L;let k=t[M];k===void 0&&(k=t[M]=[]),k.push({featureIndex:m,feature:N,intersectionZ:R})}}lookupSymbolFeatures(t,r,n,i,s,a,l,p){const f={};this.loadVTLayers();const m=Jp(s);for(const _ of t)this.loadMatchingFeature(f,{bucketIndex:n,sourceLayerIndex:i,featureIndex:_,layoutVertexArrayOffset:0},m,a,l,p,r);return f}loadFeature(t){const{featureIndex:r,sourceLayerIndex:n}=t;this.loadVTLayers();const i=this.sourceLayerCoder.decode(n),s=this.vtFeatures[i];if(s[r])return s[r];const a=this.vtLayers[i].feature(r);return s[r]=a,a}hasLayer(t){for(const r of this.bucketLayerIDs)for(const n of r)if(t===n)return!0;return!1}getId(t,r){let n=t.id;if(this.promoteId){const i=typeof this.promoteId=="string"?this.promoteId:this.promoteId[r];i!=null&&(n=t.properties[i]),typeof n=="boolean"&&(n=Number(n))}return n}}function Nb(e,t,r,n,i){return yu(e,(s,a)=>{const l=t instanceof of?t.get(a):null;return l&&l.evaluate?l.evaluate(r,n,i):l})}function UM(e,t){return t-e}Ut(N_,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const GM=Je([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),jM=Je([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),qM=Je([{name:"a_projected_pos",components:4,type:"Float32"}],4);Je([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const ZM=Je([{name:"a_texb",components:2,type:"Uint16"}]),XM=Je([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),WM=Je([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);Je([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const zb=Je([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),HM=Je([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Je([{name:"triangle",components:3,type:"Uint16"}]),Je([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Je([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint8",name:"hasIconTextFit"}]),Je([{type:"Float32",name:"offsetX"}]),Je([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Nn=24;const ps=128;function z_(e,t){const{expression:r}=t;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new jr(e+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:n,interpolationType:i}=r;let s=0;for(;s<n.length&&n[s]<=e;)s++;s=Math.max(0,s-1);let a=s;for(;a<n.length&&n[a]<e+1;)a++;a=Math.min(n.length-1,a);const l=n[s],p=n[a];return r.kind==="composite"?{kind:"composite",minZoom:l,maxZoom:p,interpolationType:i}:{kind:"camera",minZoom:l,maxZoom:p,minSize:r.evaluate(new jr(l)),maxSize:r.evaluate(new jr(p)),interpolationType:i}}}function wh(e,{uSize:t,uSizeT:r},{lowerSize:n,upperSize:i}){return e.kind==="source"?n/ps:e.kind==="composite"?ce(n/ps,i/ps,r):t}function ks(e,t){let r=0,n=0;if(e.kind==="constant")n=e.layoutSize;else if(e.kind!=="source"){const{interpolationType:i,minZoom:s,maxZoom:a}=e,l=i?Bt(Ds.interpolationFactor(i,t,s,a),0,1):0;e.kind==="camera"?n=ce(e.minSize,e.maxSize,l):r=l}return{uSizeT:r,uSize:n}}var YM=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:ps,evaluateSizeForFeature:wh,evaluateSizeForZoom:ks,getSizeData:z_});function $M(e,t,r){return e.sections.forEach(n=>{n.text=function(i,s,a){const l=s.layout.get("text-transform").evaluate(a,{});return l==="uppercase"?i=i.toLocaleUpperCase():l==="lowercase"&&(i=i.toLocaleLowerCase()),ko.applyArabicShaping&&(i=ko.applyArabicShaping(i)),i}(n.text,t,r)}),e}const Eh={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function KM(e){return e==="︶"||e==="﹈"||e==="︸"||e==="﹄"||e==="﹂"||e==="︾"||e==="︼"||e==="︺"||e==="︘"||e==="﹀"||e==="︐"||e==="︓"||e==="︔"||e==="｀"||e==="￣"||e==="︑"||e==="︒"}function JM(e){return e==="︵"||e==="﹇"||e==="︷"||e==="﹃"||e==="﹁"||e==="︽"||e==="︻"||e==="︹"||e==="︗"||e==="︿"}const k_=3;function QM(e,t,r){t.glyphs=[],e===1&&r.readMessage(tA,t)}function tA(e,t,r){if(e===3){const{id:n,bitmap:i,width:s,height:a,left:l,top:p,advance:f}=r.readMessage(eA,{});t.glyphs.push({id:n,bitmap:new ma({width:s+2*k_,height:a+2*k_},i),metrics:{width:s,height:a,left:l,top:p,advance:f}})}else e===4?t.ascender=r.readSVarint():e===5&&(t.descender=r.readSVarint())}function eA(e,t,r){e===1?t.id=r.readVarint():e===2?t.bitmap=r.readBytes():e===3?t.width=r.readVarint():e===4?t.height=r.readVarint():e===5?t.left=r.readSVarint():e===6?t.top=r.readSVarint():e===7&&(t.advance=r.readVarint())}const kb=k_;function F_(e){let t=0,r=0;for(const a of e)t+=a.w*a.h,r=Math.max(r,a.w);e.sort((a,l)=>l.h-a.h);const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),r),h:1/0}];let i=0,s=0;for(const a of e)for(let l=n.length-1;l>=0;l--){const p=n[l];if(!(a.w>p.w||a.h>p.h)){if(a.x=p.x,a.y=p.y,s=Math.max(s,a.y+a.h),i=Math.max(i,a.x+a.w),a.w===p.w&&a.h===p.h){const f=n.pop();l<n.length&&(n[l]=f)}else a.h===p.h?(p.x+=a.w,p.w-=a.w):a.w===p.w?(p.y+=a.h,p.h-=a.h):(n.push({x:p.x+a.w,y:p.y,w:p.w-a.w,h:a.h}),p.y+=a.h,p.h-=a.h);break}}return{w:i,h:s,fill:t/(i*s)||0}}const Ni=1;class B_{constructor(t,{pixelRatio:r,version:n,stretchX:i,stretchY:s,content:a}){this.paddedRect=t,this.pixelRatio=r,this.stretchX=i,this.stretchY=s,this.content=a,this.version=n}get tl(){return[this.paddedRect.x+Ni,this.paddedRect.y+Ni]}get br(){return[this.paddedRect.x+this.paddedRect.w-Ni,this.paddedRect.y+this.paddedRect.h-Ni]}get displaySize(){return[(this.paddedRect.w-2*Ni)/this.pixelRatio,(this.paddedRect.h-2*Ni)/this.pixelRatio]}}class Fb{constructor(t,r){const n={},i={};this.haveRenderCallbacks=[];const s=[];this.addImages(t,n,s),this.addImages(r,i,s);const{w:a,h:l}=F_(s),p=new Yr({width:a||1,height:l||1});for(const f in t){const m=t[f],_=n[f].paddedRect;Yr.copy(m.data,p,{x:0,y:0},{x:_.x+Ni,y:_.y+Ni},m.data)}for(const f in r){const m=r[f],_=i[f].paddedRect,y=_.x+Ni,v=_.y+Ni,b=m.data.width,w=m.data.height;Yr.copy(m.data,p,{x:0,y:0},{x:y,y:v},m.data),Yr.copy(m.data,p,{x:0,y:w-1},{x:y,y:v-1},{width:b,height:1}),Yr.copy(m.data,p,{x:0,y:0},{x:y,y:v+w},{width:b,height:1}),Yr.copy(m.data,p,{x:b-1,y:0},{x:y-1,y:v},{width:1,height:w}),Yr.copy(m.data,p,{x:0,y:0},{x:y+b,y:v},{width:1,height:w})}this.image=p,this.iconPositions=n,this.patternPositions=i}addImages(t,r,n){for(const i in t){const s=t[i],a={x:0,y:0,w:s.data.width+2*Ni,h:s.data.height+2*Ni};n.push(a),r[i]=new B_(a,s),s.hasRenderCallback&&this.haveRenderCallbacks.push(i)}}patchUpdatedImages(t,r,n){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(i=>t.hasImage(i,n)),t.dispatchRenderCallbacks(this.haveRenderCallbacks,n);for(const i in t.getUpdatedImages(n))this.patchUpdatedImage(this.iconPositions[i],t.getImage(i,n),r),this.patchUpdatedImage(this.patternPositions[i],t.getImage(i,n),r)}patchUpdatedImage(t,r,n){if(!t||!r||t.version===r.version)return;t.version=r.version;const[i,s]=t.tl;n.update(r.data,void 0,{x:i,y:s})}}Ut(B_,"ImagePosition"),Ut(Fb,"ImageAtlas");const Dr={horizontal:1,vertical:2,horizontalOnly:3},Bb=-17;class Th{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,r){const n=new Th;return n.scale=t||1,n.fontStack=r,n}static forImage(t){const r=new Th;return r.imageName=t,r}}class Ju{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,r){const n=new Ju;for(let i=0;i<t.sections.length;i++){const s=t.sections[i];s.image?n.addImageSection(s):n.addTextSection(s,r)}return n}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCodePoint(t){return this.text.codePointAt(t)}verticalizePunctuation(t){this.text=function(r,n){let i="";for(let s=0;s<r.length;s++){const a=r.charCodeAt(s+1)||null,l=r.charCodeAt(s-1)||null;i+=!n&&(a&&J0(a)&&!Eh[r[s+1]]||l&&J0(l)&&!Eh[r[s-1]])||!Eh[r[s]]?r[s]:Eh[r[s]]}return i}(this.text,t)}trim(){let t=0;for(let n=0;n<this.text.length&&Uf[this.text.charCodeAt(n)];n++)t++;let r=this.text.length;for(let n=this.text.length-1;n>=0&&n>=t&&Uf[this.text.charCodeAt(n)];n--)r--;this.text=this.text.substring(t,r),this.sectionIndex=this.sectionIndex.slice(t,r)}substring(t,r){const n=new Ju;return n.text=this.text.substring(t,r),n.sectionIndex=this.sectionIndex.slice(t,r),n.sections=this.sections,n}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,r)=>Math.max(t,this.sections[r].scale),0)}addTextSection(t,r){this.text+=t.text,this.sections.push(Th.forText(t.scale,t.fontStack||r));const n=this.sections.length-1;for(let i=0;i<t.text.length;++i)this.sectionIndex.push(n)}addImageSection(t){const r=t.image?t.image.namePrimary:"";if(r.length===0)return void Y("Can't add FormattedSection with an empty image.");const n=this.getNextImageSectionCharCode();n?(this.text+=String.fromCodePoint(n),this.sections.push(Th.forImage(r)),this.sectionIndex.push(this.sections.length-1)):Y("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function V_(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b){const w=Ju.fromFeature(e,i);_===Dr.vertical&&w.verticalizePunctuation(y);let E=[];const T=function(L,R,N,k,F,z){if(!L)return[];const U=[],G=function(tt,X,J,nt,at,ot){let It=0;for(let xt=0;xt<tt.length();xt++){const dt=tt.getSection(xt);It+=Vb(tt.getCodePoint(xt),dt,nt,at,X,ot)}return It/Math.max(1,Math.ceil(It/J))}(L,R,N,k,F,z),V=L.text.indexOf("​")>=0;let K=0;for(let tt=0;tt<L.length();tt++){const X=L.getSection(tt),J=L.getCodePoint(tt);if(Uf[J]||(K+=Vb(J,X,k,F,R,z)),tt<L.length()-1){const nt=!(($=J)<11904||!(Ht["Bopomofo Extended"]($)||Ht.Bopomofo($)||Ht["CJK Compatibility Forms"]($)||Ht["CJK Compatibility Ideographs"]($)||Ht["CJK Compatibility"]($)||Ht["CJK Radicals Supplement"]($)||Ht["CJK Strokes"]($)||Ht["CJK Symbols and Punctuation"]($)||Ht["CJK Unified Ideographs Extension A"]($)||Ht["CJK Unified Ideographs"]($)||Ht["Enclosed CJK Letters and Months"]($)||Ht["Halfwidth and Fullwidth Forms"]($)||Ht.Hiragana($)||Ht["Ideographic Description Characters"]($)||Ht["Kangxi Radicals"]($)||Ht["Katakana Phonetic Extensions"]($)||Ht.Katakana($)||Ht["Vertical Forms"]($)||Ht["Yi Radicals"]($)||Ht["Yi Syllables"]($)));(rA[J]||nt||X.imageName)&&U.push(Gb(tt+1,K,G,U,nA(J,L.getCodePoint(tt+1),nt&&V),!1))}}var $;return jb(Gb(L.length(),K,G,U,0,!0))}(w,f,s,t,n,v),{processBidirectionalText:C,processStyledBidirectionalText:M}=ko;if(C&&w.sections.length===1){const L=C(w.toString(),T);for(const R of L){const N=new Ju;N.text=R,N.sections=w.sections;for(let k=0;k<R.length;k++)N.sectionIndex.push(0);E.push(N)}}else if(M){const L=M(w.text,w.sectionIndex,T);for(const R of L){const N=new Ju;N.text=R[0],N.sectionIndex=R[1],N.sections=w.sections,E.push(N)}}else E=function(L,R){const N=[],k=L.text;let F=0;for(const z of R)N.push(L.substring(F,z)),F=z;return F<k.length&&N.push(L.substring(F,k.length)),N}(w,T);const A=[],P={positionedLines:A,text:w.toString(),top:m[1],bottom:m[1],left:m[0],right:m[0],writingMode:_,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(L,R,N,k,F,z,U,G,V,K,$,tt){let X=0,J=0,nt=0;const at=G==="right"?1:G==="left"?0:.5;let ot=!1;for(const Jt of F){const Zt=Jt.getSections();for(const Gt of Zt){if(Gt.imageName)continue;const Qt=R[Gt.fontStack];if(Qt&&(ot=Qt.ascender!==void 0&&Qt.descender!==void 0,!ot))break}if(!ot)break}let It=0;for(const Jt of F){Jt.trim();const Zt=Jt.getMaxScale(),Gt=(Zt-1)*Nn,Qt={positionedGlyphs:[],lineOffset:0};L.positionedLines[It]=Qt;const Re=Qt.positionedGlyphs;let Le=0;if(!Jt.length()){J+=z,++It;continue}let er=0,De=0;for(let ae=0;ae<Jt.length();ae++){const Me=Jt.getSection(ae),rr=Jt.getSectionIndex(ae),Ae=Jt.getCodePoint(ae);let ar=Me.scale,tn=null,en=null,Br=null,Mr=Nn,mn=0;const zr=!(V===Dr.horizontal||!$&&!vg(Ae)||$&&(Uf[Ae]||(xt=Ae,Ht.Arabic(xt)||Ht["Arabic Supplement"](xt)||Ht["Arabic Extended-A"](xt)||Ht["Arabic Presentation Forms-A"](xt)||Ht["Arabic Presentation Forms-B"](xt))));if(Me.imageName){const wn=k[Me.imageName];if(!wn)continue;Br=Me.imageName,L.iconsInText=L.iconsInText||!0,en=wn.paddedRect;const lr=wn.displaySize;ar=ar*Nn/tt,tn={width:lr[0],height:lr[1],left:Ni,top:-kb,advance:zr?lr[1]:lr[0],localGlyph:!1},mn=ot?-tn.height*ar:Bb+Zt*Nn-lr[1]*ar,Mr=tn.advance;const zi=(zr?lr[0]:lr[1])*ar-Nn*Zt;zi>0&&zi>Le&&(Le=zi)}else{const wn=N[Me.fontStack];if(!wn)continue;wn[Ae]&&(en=wn[Ae]);const lr=R[Me.fontStack];if(!lr)continue;const zi=lr.glyphs[Ae];if(!zi)continue;if(tn=zi.metrics,Mr=Ae!==8203?Nn:0,ot){const mc=lr.ascender!==void 0?Math.abs(lr.ascender):0,xa=lr.descender!==void 0?Math.abs(lr.descender):0,ba=(mc+xa)*ar;er<ba&&(er=ba,De=(mc-xa)/2*ar),mn=-mc*ar}else mn=Bb+(Zt-ar)*Nn}zr?(L.verticalizable=!0,Re.push({glyph:Ae,imageName:Br,x:X,y:J+mn,vertical:zr,scale:ar,localGlyph:tn.localGlyph,fontStack:Me.fontStack,sectionIndex:rr,metrics:tn,rect:en}),X+=Mr*ar+K):(Re.push({glyph:Ae,imageName:Br,x:X,y:J+mn,vertical:zr,scale:ar,localGlyph:tn.localGlyph,fontStack:Me.fontStack,sectionIndex:rr,metrics:tn,rect:en}),X+=tn.advance*ar+K)}Re.length!==0&&(nt=Math.max(X-K,nt),ot?qb(Re,at,Le,De,z*Zt/2):qb(Re,at,Le,0,z/2)),X=0;const Oe=z*Zt+Le;Qt.lineOffset=Math.max(Le,Gt),J+=Oe,++It}var xt;const dt=J,{horizontalAlign:yt,verticalAlign:Ot}=Gf(U);(function(Jt,Zt,Gt,Qt,Re,Le){const er=(Zt-Gt)*Re,De=-Le*Qt;for(const Oe of Jt)for(const ae of Oe.positionedGlyphs)ae.x+=er,ae.y+=De})(L.positionedLines,at,yt,Ot,nt,dt),L.top+=-Ot*dt,L.bottom=L.top+dt,L.left+=-yt*nt,L.right=L.left+nt,L.hasBaseline=ot}(P,t,r,n,E,a,l,p,_,f,y,b),!function(L){for(const R of L)if(R.positionedGlyphs.length!==0)return!1;return!0}(A)&&P}const Uf={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},rA={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Vb(e,t,r,n,i,s){if(t.imageName){const a=n[t.imageName];return a?a.displaySize[0]*t.scale*Nn/s+i:0}{const a=r[t.fontStack],l=a&&a.glyphs[e];return l?l.metrics.advance*t.scale+i:0}}function Ub(e,t,r,n){const i=Math.pow(e-t,2);return n?e<t?i/2:2*i:i+Math.abs(r)*r}function nA(e,t,r){let n=0;return e===10&&(n-=1e4),r&&(n+=150),e!==40&&e!==65288||(n+=50),t!==41&&t!==65289||(n+=50),n}function Gb(e,t,r,n,i,s){let a=null,l=Ub(t,r,i,s);for(const p of n){const f=Ub(t-p.x,r,i,s)+p.badness;f<=l&&(a=p,l=f)}return{index:e,x:t,priorBreak:a,badness:l}}function jb(e){return e?jb(e.priorBreak).concat(e.index):[]}function Gf(e){let t=.5,r=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(e){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:t,verticalAlign:r}}function qb(e,t,r,n,i){if(!(t||r||n||i))return;const s=e.length-1,a=e[s],l=(a.x+a.metrics.advance*a.scale)*t;for(let p=0;p<=s;p++)e[p].x-=l,e[p].y+=r+n+i}function iA(e,t,r,n){const{horizontalAlign:i,verticalAlign:s}=Gf(n),a=r[0]-e.displaySize[0]*i,l=r[1]-e.displaySize[1]*s;return{imagePrimary:e,imageSecondary:t,top:l,bottom:l+e.displaySize[1],left:a,right:a+e.displaySize[0]}}function Zb(e,t,r,n,i,s){const a=e.imagePrimary;let l;if(a.content){const E=a.content,T=a.pixelRatio||1;l=[E[0]/T,E[1]/T,a.displaySize[0]-E[2]/T,a.displaySize[1]-E[3]/T]}const p=t.left*s,f=t.right*s;let m,_,y,v;r==="width"||r==="both"?(v=i[0]+p-n[3],_=i[0]+f+n[1]):(v=i[0]+(p+f-a.displaySize[0])/2,_=v+a.displaySize[0]);const b=t.top*s,w=t.bottom*s;return r==="height"||r==="both"?(m=i[1]+b-n[0],y=i[1]+w+n[2]):(m=i[1]+(b+w-a.displaySize[1])/2,y=m+a.displaySize[1]),{imagePrimary:a,imageSecondary:void 0,top:m,right:_,bottom:y,left:v,collisionPadding:l}}class _a extends H{constructor(t,r,n,i,s){super(t,r),this.angle=i,this.z=n,s!==void 0&&(this.segment=s)}clone(){return new _a(this.x,this.y,this.z,this.angle,this.segment)}}function Xb(e,t,r,n,i){if(t.segment===void 0)return!0;let s=t,a=t.segment+1,l=0;for(;l>-r/2;){if(a--,a<0)return!1;l-=e[a].dist(s),s=e[a]}l+=e[a].dist(e[a+1]),a++;const p=[];let f=0;for(;l<r/2;){const m=e[a],_=e[a+1];if(!_)return!1;let y=e[a-1].angleTo(m)-m.angleTo(_);for(y=Math.abs((y+3*Math.PI)%(2*Math.PI)-Math.PI),p.push({distance:l,angleDelta:y}),f+=y;l-p[0].distance>n;)f-=p.shift().angleDelta;if(f>i)return!1;a++,l+=m.dist(_)}return!0}function Wb(e){let t=0;for(let r=0;r<e.length-1;r++)t+=e[r].dist(e[r+1]);return t}function Hb(e,t,r){return e?.6*t*r:0}function Yb(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0)}function oA(e,t,r,n,i,s){const a=Hb(r,i,s),l=Yb(r,n)*s;let p=0;const f=Wb(e)/2;for(let m=0;m<e.length-1;m++){const _=e[m],y=e[m+1],v=_.dist(y);if(p+v>f){const b=(f-p)/v,w=ce(_.x,y.x,b),E=ce(_.y,y.y,b),T=new _a(w,E,0,y.angleTo(_),m);return!a||Xb(e,T,l,a,t)?T:void 0}p+=v}}function sA(e,t,r,n,i,s,a,l,p){const f=Hb(n,s,a),m=Yb(n,i),_=m*a,y=e[0].x===0||e[0].x===p||e[0].y===0||e[0].y===p;return t-_<t/4&&(t=_+t/4),$b(e,y?t/2*l%t:(m/2+2*s)*a*l%t,t,f,r,_,y,!1,p)}function $b(e,t,r,n,i,s,a,l,p){const f=s/2,m=Wb(e);let _=0,y=t-r,v=[];for(let b=0;b<e.length-1;b++){const w=e[b],E=e[b+1],T=w.dist(E),C=E.angleTo(w);for(;y+r<_+T;){y+=r;const M=(y-_)/T,A=ce(w.x,E.x,M),P=ce(w.y,E.y,M);if(A>=0&&A<p&&P>=0&&P<p&&y-f>=0&&y+f<=m){const L=new _a(A,P,0,C,b);L._round(),n&&!Xb(e,L,s,n,i)||v.push(L)}}_+=T}return l||v.length||a||(v=$b(e,_/2,r,n,i,s,a,!0,p)),v}function Kb(e,t,r,n,i){const s=[];for(let a=0;a<e.length;a++){const l=e[a];let p;for(let f=0;f<l.length-1;f++){let m=l[f],_=l[f+1];m.x<t&&_.x<t||(m.x<t?m=new H(t,m.y+(t-m.x)/(_.x-m.x)*(_.y-m.y))._round():_.x<t&&(_=new H(t,m.y+(t-m.x)/(_.x-m.x)*(_.y-m.y))._round()),m.y<r&&_.y<r||(m.y<r?m=new H(m.x+(r-m.y)/(_.y-m.y)*(_.x-m.x),r)._round():_.y<r&&(_=new H(m.x+(r-m.y)/(_.y-m.y)*(_.x-m.x),r)._round()),m.x>=n&&_.x>=n||(m.x>=n?m=new H(n,m.y+(n-m.x)/(_.x-m.x)*(_.y-m.y))._round():_.x>=n&&(_=new H(n,m.y+(n-m.x)/(_.x-m.x)*(_.y-m.y))._round()),m.y>=i&&_.y>=i||(m.y>=i?m=new H(m.x+(i-m.y)/(_.y-m.y)*(_.x-m.x),i)._round():_.y>=i&&(_=new H(m.x+(i-m.y)/(_.y-m.y)*(_.x-m.x),i)._round()),p&&m.equals(p[p.length-1])||(p=[m],s.push(p)),p.push(_)))))}}return s}Ut(_a,"Anchor");const Ih=1e20;function Jb(e,t,r,n,i,s,a,l,p){for(let f=t;f<t+n;f++)Qb(e,r*s+f,s,i,a,l,p);for(let f=r;f<r+i;f++)Qb(e,f*s+t,1,n,a,l,p)}function Qb(e,t,r,n,i,s,a){s[0]=0,a[0]=-Ih,a[1]=Ih,i[0]=e[t];for(let l=1,p=0,f=0;l<n;l++){i[l]=e[t+l*r];const m=l*l;do{const _=s[p];f=(i[l]-i[_]+m-_*_)/(l-_)/2}while(f<=a[p]&&--p>-1);p++,s[p]=l,a[p]=f,a[p+1]=Ih}for(let l=0,p=0;l<n;l++){for(;a[p+1]<l;)p++;const f=s[p],m=l-f;e[t+l*r]=i[f]+m*m}}const fs=2;class Qu{constructor(t,r,n){this.requestManager=t,this.localGlyphMode=r,this.localFontFamily=n,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t,r){this.urls[r]=t}getGlyphs(t,r,n){const i=[],s=this.urls[r];if(s){for(const a in t)for(const l of t[a])i.push({stack:a,id:l});Lo(i,({stack:a,id:l},p)=>{let f=this.entries[a];f||(f=this.entries[a]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let m=f.glyphs[l];if(m!==void 0)return void p(null,{stack:a,id:l,glyph:m});if(m=this._tinySDF(f,a,l),m)return f.glyphs[l]=m,void p(null,{stack:a,id:l,glyph:m});const _=Math.floor(l/256);if(256*_>65535)return void p(new Error("glyphs > 65535 not supported"));if(f.ranges[_])return void p(null,{stack:a,id:l,glyph:m});let y=f.requests[_];y||(y=f.requests[_]=[],Qu.loadGlyphRange(a,_,s,this.requestManager,(v,b)=>{if(b){f.ascender=b.ascender,f.descender=b.descender;for(const w in b.glyphs)this._doesCharSupportLocalGlyph(+w)||(f.glyphs[+w]=b.glyphs[+w]);f.ranges[_]=!0}for(const w of y)w(v,b);delete f.requests[_]})),y.push((v,b)=>{v?p(v):b&&p(null,{stack:a,id:l,glyph:b.glyphs[l]||null})})},(a,l)=>{if(a)n(a);else if(l){const p={};for(const{stack:f,id:m,glyph:_}of l)p[f]===void 0&&(p[f]={}),p[f].glyphs===void 0&&(p[f].glyphs={}),p[f].glyphs[m]=_&&{id:_.id,bitmap:_.bitmap.clone(),metrics:_.metrics},p[f].ascender=this.entries[f].ascender,p[f].descender=this.entries[f].descender;n(null,p)}})}else n(new Error("Missing glyph URL"))}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==0&&(this.localGlyphMode===2?!!this.localFontFamily:!!this.localFontFamily&&(Ht["CJK Unified Ideographs"](t)||Ht["Hangul Syllables"](t)||Ht.Hiragana(t)||Ht.Katakana(t)||Ht["CJK Symbols and Punctuation"](t)||Ht["CJK Unified Ideographs Extension A"](t)||Ht["CJK Unified Ideographs Extension B"](t)))}_tinySDF(t,r,n){const i=this.localFontFamily;if(!i||!this._doesCharSupportLocalGlyph(n))return;let s=t.tinySDF;if(!s){let w="400";/bold/i.test(r)?w="900":/medium/i.test(r)?w="500":/light/i.test(r)&&(w="200"),s=t.tinySDF=new Qu.TinySDF({fontFamily:i,fontWeight:w,fontSize:24*fs,buffer:3*fs,radius:8*fs}),s.fontWeight=w}if(this.localGlyphs[s.fontWeight][n])return this.localGlyphs[s.fontWeight][n];const a=String.fromCodePoint(n),{data:l,width:p,height:f,glyphWidth:m,glyphHeight:_,glyphLeft:y,glyphTop:v,glyphAdvance:b}=s.draw(a);return this.localGlyphs[s.fontWeight][n]={id:n,bitmap:new ma({width:p,height:f},l),metrics:{width:m/fs,height:_/fs,left:y/fs,top:v/fs-27,advance:b/fs,localGlyph:!0}}}}Qu.loadGlyphRange=function(e,t,r,n,i){const s=256*t,a=s+255,l=n.transformRequest(n.normalizeGlyphsURL(r).replace("{fontstack}",e).replace("{range}",`${s}-${a}`),ct.Glyphs);Dt(l,(p,f)=>{if(p)i(p);else if(f){const m={},_=function(y){return new Vf(y).readFields(QM,{})}(f);for(const y of _.glyphs)m[y.id]=y;i(null,{glyphs:m,ascender:_.ascender,descender:_.descender})}})},Qu.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:r=8,cutoff:n=.25,fontFamily:i="sans-serif",fontWeight:s="normal",fontStyle:a="normal"}={}){this.buffer=t,this.cutoff=n,this.radius=r;const l=this.size=e+4*t,p=this._createCanvas(l),f=this.ctx=p.getContext("2d",{willReadFrequently:!0});f.font=`${a} ${s} ${e}px ${i}`,f.textBaseline="alphabetic",f.textAlign="left",f.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:n,actualBoundingBoxLeft:i,actualBoundingBoxRight:s}=this.ctx.measureText(e),a=Math.ceil(r),l=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(s-i))),p=Math.min(this.size-this.buffer,a+Math.ceil(n)),f=l+2*this.buffer,m=p+2*this.buffer,_=Math.max(f*m,0),y=new Uint8ClampedArray(_),v={data:y,width:f,height:m,glyphWidth:l,glyphHeight:p,glyphTop:a,glyphLeft:0,glyphAdvance:t};if(l===0||p===0)return v;const{ctx:b,buffer:w,gridInner:E,gridOuter:T}=this;b.clearRect(w,w,l,p),b.fillText(e,w,w+a);const C=b.getImageData(w,w,l,p);T.fill(Ih,0,_),E.fill(0,0,_);for(let M=0;M<p;M++)for(let A=0;A<l;A++){const P=C.data[4*(M*l+A)+3]/255;if(P===0)continue;const L=(M+w)*f+A+w;if(P===1)T[L]=0,E[L]=Ih;else{const R=.5-P;T[L]=R>0?R*R:0,E[L]=R<0?R*R:0}}Jb(T,0,0,f,m,f,this.f,this.v,this.z),Jb(E,w,w,l,p,f,this.f,this.v,this.z);for(let M=0;M<_;M++){const A=Math.sqrt(T[M])-Math.sqrt(E[M]);y[M]=Math.round(255-255*(A/this.radius+this.cutoff))}return v}};const nl=Ni;function tw(e,t,r,n){const i=[],s=e.imagePrimary,a=s.pixelRatio,l=s.paddedRect.w-2*nl,p=s.paddedRect.h-2*nl,f=e.right-e.left,m=e.bottom-e.top,_=s.stretchX||[[0,l]],y=s.stretchY||[[0,p]],v=(z,U)=>z+U[1]-U[0],b=_.reduce(v,0),w=y.reduce(v,0),E=l-b,T=p-w;let C=0,M=b,A=0,P=w,L=0,R=E,N=0,k=T;if(s.content&&n){const z=s.content;C=jf(_,0,z[0]),A=jf(y,0,z[1]),M=jf(_,z[0],z[2]),P=jf(y,z[1],z[3]),L=z[0]-C,N=z[1]-A,R=z[2]-z[0]-M,k=z[3]-z[1]-P}const F=(z,U,G,V)=>{const K=qf(z.stretch-C,M,f,e.left),$=Zf(z.fixed-L,R,z.stretch,b),tt=qf(U.stretch-A,P,m,e.top),X=Zf(U.fixed-N,k,U.stretch,w),J=qf(G.stretch-C,M,f,e.left),nt=Zf(G.fixed-L,R,G.stretch,b),at=qf(V.stretch-A,P,m,e.top),ot=Zf(V.fixed-N,k,V.stretch,w),It=new H(K,tt),xt=new H(J,tt),dt=new H(J,at),yt=new H(K,at),Ot=new H($/a,X/a),Jt=new H(nt/a,ot/a),Zt=t*Math.PI/180;if(Zt){const De=Math.sin(Zt),Oe=Math.cos(Zt),ae=[Oe,-De,De,Oe];It._matMult(ae),xt._matMult(ae),yt._matMult(ae),dt._matMult(ae)}const Gt=z.stretch+z.fixed,Qt=G.stretch+G.fixed,Re=U.stretch+U.fixed,Le=V.stretch+V.fixed,er=e.imageSecondary;return{tl:It,tr:xt,bl:yt,br:dt,texPrimary:{x:s.paddedRect.x+nl+Gt,y:s.paddedRect.y+nl+Re,w:Qt-Gt,h:Le-Re},texSecondary:er?{x:er.paddedRect.x+nl+Gt,y:er.paddedRect.y+nl+Re,w:Qt-Gt,h:Le-Re}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Ot,pixelOffsetBR:Jt,minFontScaleX:R/a/f,minFontScaleY:k/a/m,isSDF:r}};if(n&&(s.stretchX||s.stretchY)){const z=ew(_,E,b),U=ew(y,T,w);for(let G=0;G<z.length-1;G++){const V=z[G],K=z[G+1];for(let $=0;$<U.length-1;$++)i.push(F(V,U[$],K,U[$+1]))}}else i.push(F({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:l+1},{fixed:0,stretch:p+1}));return i}function jf(e,t,r){let n=0;for(const i of e)n+=Math.max(t,Math.min(r,i[1]))-Math.max(t,Math.min(r,i[0]));return n}function ew(e,t,r){const n=[{fixed:-nl,stretch:0}];for(const[i,s]of e){const a=n[n.length-1];n.push({fixed:i-a.stretch,stretch:a.stretch}),n.push({fixed:i-a.stretch,stretch:a.stretch+(s-i)})}return n.push({fixed:t+nl,stretch:r}),n}function qf(e,t,r,n){return e/t*r+n}function Zf(e,t,r,n){return e-t*r/n}function aA(e,t,r,n){const i=t+e.positionedLines[n].lineOffset;return n===0?r+i/2:r+(i+(t+e.positionedLines[n-1].lineOffset))/2}function lA(e,t=1,r=!1){let n=1/0,i=1/0,s=-1/0,a=-1/0;const l=e[0];for(let v=0;v<l.length;v++){const b=l[v];(!v||b.x<n)&&(n=b.x),(!v||b.y<i)&&(i=b.y),(!v||b.x>s)&&(s=b.x),(!v||b.y>a)&&(a=b.y)}const p=Math.min(s-n,a-i);let f=p/2;const m=new Rm([],uA);if(p===0)return new H(n,i);for(let v=n;v<s;v+=p)for(let b=i;b<a;b+=p)m.push(new tc(v+f,b+f,f,e));let _=function(v){let b=0,w=0,E=0;const T=v[0];for(let C=0,M=T.length,A=M-1;C<M;A=C++){const P=T[C],L=T[A],R=P.x*L.y-L.x*P.y;w+=(P.x+L.x)*R,E+=(P.y+L.y)*R,b+=3*R}return new tc(w/b,E/b,0,v)}(e),y=m.length;for(;m.length;){const v=m.pop();(v.d>_.d||!_.d)&&(_=v,r&&console.log("found best %d after %d probes",Math.round(1e4*v.d)/1e4,y)),v.max-_.d<=t||(f=v.h/2,m.push(new tc(v.p.x-f,v.p.y-f,f,e)),m.push(new tc(v.p.x+f,v.p.y-f,f,e)),m.push(new tc(v.p.x-f,v.p.y+f,f,e)),m.push(new tc(v.p.x+f,v.p.y+f,f,e)),y+=4)}return r&&(console.log(`num probes: ${y}`),console.log(`best distance: ${_.d}`)),_.p}function uA(e,t){return t.max-e.max}class tc{constructor(t,r,n,i){this.p=new H(t,r),this.h=n,this.d=function(s,a){let l=!1,p=1/0;for(let f=0;f<a.length;f++){const m=a[f];for(let _=0,y=m.length,v=y-1;_<y;v=_++){const b=m[_],w=m[v];b.y>s.y!=w.y>s.y&&s.x<(w.x-b.x)*(s.y-b.y)/(w.y-b.y)+b.x&&(l=!l),p=Math.min(p,nb(s,b,w))}}return(l?1:-1)*Math.sqrt(p)}(this.p,i),this.max=this.d+this.h*Math.SQRT2}}const ec=7,U_=Number.POSITIVE_INFINITY,cA=Math.sqrt(2);function G_(e,[t,r]){let n=0,i=0;if(r===U_){t<0&&(t=0);const s=t/cA;switch(e){case"top-right":case"top-left":i=s-ec;break;case"bottom-right":case"bottom-left":i=-s+ec;break;case"bottom":i=-t+ec;break;case"top":i=t-ec}switch(e){case"top-right":case"bottom-right":n=-s;break;case"top-left":case"bottom-left":n=s;break;case"left":n=t;break;case"right":n=-t}}else{switch(t=Math.abs(t),r=Math.abs(r),e){case"top-right":case"top-left":case"top":i=r-ec;break;case"bottom-right":case"bottom-left":case"bottom":i=-r+ec}switch(e){case"top-right":case"bottom-right":case"right":n=-t;break;case"top-left":case"bottom-left":case"left":n=t}}return[n,i]}function hA(e,t,r,n,i,s,a,l,p,f,m){e.createArrays(),e.tilePixelRatio=lt/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;const _=e.layers[0].layout,y=e.layers[0]._unevaluatedLayout._values,v={};if(e.textSizeData.kind==="composite"){const{minZoom:T,maxZoom:C}=e.textSizeData;v.compositeTextSizes=[y["text-size"].possiblyEvaluate(new jr(T),l),y["text-size"].possiblyEvaluate(new jr(C),l)]}if(e.iconSizeData.kind==="composite"){const{minZoom:T,maxZoom:C}=e.iconSizeData;v.compositeIconSizes=[y["icon-size"].possiblyEvaluate(new jr(T),l),y["icon-size"].possiblyEvaluate(new jr(C),l)]}v.layoutTextSize=y["text-size"].possiblyEvaluate(new jr(p+1),l),v.layoutIconSize=y["icon-size"].possiblyEvaluate(new jr(p+1),l),v.textMaxSize=y["text-size"].possiblyEvaluate(new jr(18),l);const b=_.get("text-rotation-alignment")==="map"&&_.get("symbol-placement")!=="point",w=_.get("text-size");let E=!1;for(const T of e.features)if(T.icon&&T.icon.nameSecondary){E=!0;break}for(const T of e.features){const C=_.get("text-font").evaluate(T,{},l).join(","),M=w.evaluate(T,{},l),A=v.layoutTextSize.evaluate(T,{},l),P=(v.layoutIconSize.evaluate(T,{},l),{horizontal:{},vertical:void 0}),L=T.text;let R,N=[0,0];if(L){const z=L.toString(),U=_.get("text-letter-spacing").evaluate(T,{},l)*Nn,G=_.get("text-line-height").evaluate(T,{},l)*Nn,V=US(z)?U:0,K=_.get("text-anchor").evaluate(T,{},l),$=_.get("text-variable-anchor");if(!$){const at=_.get("text-radial-offset").evaluate(T,{},l);N=at?G_(K,[at*Nn,U_]):_.get("text-offset").evaluate(T,{},l).map(ot=>ot*Nn)}let tt=b?"center":_.get("text-justify").evaluate(T,{},l);const X=_.get("symbol-placement")==="point",J=X?_.get("text-max-width").evaluate(T,{},l)*Nn:1/0,nt=at=>{e.allowVerticalPlacement&&yg(z)&&(P.vertical=V_(L,t,r,i,C,J,G,K,at,V,N,Dr.vertical,!0,A,M))};if(!b&&$){const at=tt==="auto"?$.map(It=>j_(It)):[tt];let ot=!1;for(let It=0;It<at.length;It++){const xt=at[It];if(!P.horizontal[xt])if(ot)P.horizontal[xt]=P.horizontal[0];else{const dt=V_(L,t,r,i,C,J,G,"center",xt,V,N,Dr.horizontal,!1,A,M);dt&&(P.horizontal[xt]=dt,ot=dt.positionedLines.length===1)}}nt("left")}else{if(tt==="auto"&&(tt=j_(K)),X||_.get("text-writing-mode").indexOf("horizontal")>=0||!yg(z)){const at=V_(L,t,r,i,C,J,G,K,tt,V,N,Dr.horizontal,!1,A,M);at&&(P.horizontal[tt]=at)}nt(X?"left":tt)}}let k=!1;if(T.icon&&T.icon.namePrimary){const z=n[T.icon.namePrimary];z&&(R=iA(i[T.icon.namePrimary],T.icon.nameSecondary?i[T.icon.nameSecondary]:void 0,_.get("icon-offset").evaluate(T,{},l),_.get("icon-anchor").evaluate(T,{},l)),k=z.sdf,e.sdfIcons===void 0?e.sdfIcons=z.sdf:e.sdfIcons!==z.sdf&&Y("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(z.pixelRatio!==e.pixelRatio||_.get("icon-rotate").constantOr(1)!==0)&&(e.iconsNeedLinear=!0))}const F=nw(P.horizontal)||P.vertical;e.iconsInText||(e.iconsInText=!!F&&F.iconsInText),(F||R)&&pA(e,T,P,R,n,v,A,0,N,k,a,l,f,m,E)}s&&e.generateCollisionDebugBuffers(p,e.collisionBoxArray)}function j_(e){switch(e){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function pA(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b){let w=s.textMaxSize.evaluate(t,{},_);w===void 0&&(w=a);const E=e.layers[0].layout,T=E.get("icon-offset").evaluate(t,{},_),C=nw(r.horizontal)||r.vertical,M=y.name==="globe",A=Nn,P=a/A,L=e.tilePixelRatio*w/A,R=(K=e.overscaling,e.zoom>18&&K>2&&(K>>=1),Math.max(lt/(512*K),1)*E.get("symbol-spacing")),N=E.get("text-padding")*e.tilePixelRatio,k=E.get("icon-padding")*e.tilePixelRatio,F=re(E.get("text-max-angle")),z=E.get("text-rotation-alignment")==="map"&&E.get("symbol-placement")!=="point",U=E.get("icon-rotation-alignment")==="map"&&E.get("symbol-placement")!=="point",G=E.get("symbol-placement"),V=R/2;var K;const $=E.get("icon-text-fit").evaluate(t,{},_),tt=E.get("icon-text-fit-padding").evaluate(t,{},_),X=$!=="none";let J;e.hasAnyIconTextFit===!1&&X&&(e.hasAnyIconTextFit=!0),n&&X&&(e.allowVerticalPlacement&&r.vertical&&(J=Zb(n,r.vertical,$,tt,T,P)),C&&(n=Zb(n,C,$,tt,T,P)));const nt=(at,ot,It)=>{if(ot.x<0||ot.x>=lt||ot.y<0||ot.y>=lt)return;let xt=null;if(M){const{x:dt,y:yt,z:Ot}=y.projectTilePoint(ot.x,ot.y,It);xt={anchor:new _a(dt,yt,Ot,0,void 0),up:y.upVector(It,ot.x,ot.y)}}(function(dt,yt,Ot,Jt,Zt,Gt,Qt,Re,Le,er,De,Oe,ae,Me,rr,Ae,ar,tn,en,Br,Mr,mn,zr,wn,lr,zi,mc){const xa=dt.addToLineVertexArray(yt,Jt);let ba,Hh,Yh,Dd,nT,iT,oT,sT=0,aT=0,lT=0,uT=0,By=-1,Vy=-1;const Us={};let cT=Gg("");const Hl=Ot?Ot.anchor:yt,Uy=Le.layout.get("icon-text-fit").evaluate(Mr,{},lr)!=="none";let Gy=0,jy=0;if(Le._unevaluatedLayout.getValue("text-radial-offset")===void 0?[Gy,jy]=Le.layout.get("text-offset").evaluate(Mr,{},lr).map(to=>to*Nn):(Gy=Le.layout.get("text-radial-offset").evaluate(Mr,{},lr)*Nn,jy=U_),dt.allowVerticalPlacement&&Zt.vertical){const to=Zt.vertical;if(rr)iT=q_(to),Re&&(oT=q_(Re));else{const eo=Le.layout.get("text-rotate").evaluate(Mr,{},lr)+90;Yh=Xf(er,Hl,yt,De,Oe,ae,to,Me,eo,Ae),Re&&(Dd=Xf(er,Hl,yt,De,Oe,ae,Re,tn,eo))}}if(Gt){const to=Le.layout.get("icon-rotate").evaluate(Mr,{},lr),eo=tw(Gt,to,zr,Uy),gc=Re?tw(Re,to,zr,Uy):void 0;Hh=Xf(er,Hl,yt,De,Oe,ae,Gt,tn,to),sT=4*eo.length;const hT=dt.iconSizeData;let Yl=null;hT.kind==="source"?(Yl=[ps*Le.layout.get("icon-size").evaluate(Mr,{},lr)],Yl[0]>il&&Y(`${dt.layerIds[0]}: Value for "icon-size" is >= ${Sh}. Reduce your "icon-size".`)):hT.kind==="composite"&&(Yl=[ps*mn.compositeIconSizes[0].evaluate(Mr,{},lr),ps*mn.compositeIconSizes[1].evaluate(Mr,{},lr)],(Yl[0]>il||Yl[1]>il)&&Y(`${dt.layerIds[0]}: Value for "icon-size" is >= ${Sh}. Reduce your "icon-size".`)),dt.addSymbols(dt.icon,eo,Yl,Br,en,Mr,!1,Ot,yt,xa.lineStartIndex,xa.lineLength,-1,wn,lr,zi,mc),By=dt.icon.placedSymbolArray.length-1,gc&&(aT=4*gc.length,dt.addSymbols(dt.icon,gc,Yl,Br,en,Mr,Dr.vertical,Ot,yt,xa.lineStartIndex,xa.lineLength,-1,wn,lr,zi,mc),Vy=dt.icon.placedSymbolArray.length-1)}for(const to in Zt.horizontal){const eo=Zt.horizontal[to];ba||(cT=Gg(eo.text),rr?nT=q_(eo):ba=Xf(er,Hl,yt,De,Oe,ae,eo,Me,Le.layout.get("text-rotate").evaluate(Mr,{},lr),Ae));const gc=eo.positionedLines.length===1;if(lT+=rw(dt,Ot,yt,eo,Qt,Le,rr,Mr,Ae,xa,Zt.vertical?Dr.horizontal:Dr.horizontalOnly,gc?Object.keys(Zt.horizontal):[to],Us,By,mn,wn,lr,zi),gc)break}Zt.vertical&&(uT+=rw(dt,Ot,yt,Zt.vertical,Qt,Le,rr,Mr,Ae,xa,Dr.vertical,["vertical"],Us,Vy,mn,wn,lr,zi));let dl=-1;const qy=(to,eo)=>to?Math.max(to,eo):eo;dl=qy(nT,dl),dl=qy(iT,dl),dl=qy(oT,dl);const BR=dl>-1?1:0;dt.glyphOffsetArray.length>=Lh.MAX_GLYPHS&&Y("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Mr.sortKey!==void 0&&dt.addToSortKeyRanges(dt.symbolInstances.length,Mr.sortKey),dt.symbolInstances.emplaceBack(Hl.x,Hl.y,Hl.z,yt.x,yt.y,Us.right>=0?Us.right:-1,Us.center>=0?Us.center:-1,Us.left>=0?Us.left:-1,Us.vertical>=0?Us.vertical:-1,By,Vy,cT,ba!==void 0?ba:dt.collisionBoxArray.length,ba!==void 0?ba+1:dt.collisionBoxArray.length,Yh!==void 0?Yh:dt.collisionBoxArray.length,Yh!==void 0?Yh+1:dt.collisionBoxArray.length,Hh!==void 0?Hh:dt.collisionBoxArray.length,Hh!==void 0?Hh+1:dt.collisionBoxArray.length,Dd||dt.collisionBoxArray.length,Dd?Dd+1:dt.collisionBoxArray.length,De,lT,uT,sT,aT,BR,0,Gy,jy,dl,Uy?1:0)})(e,ot,xt,at,r,n,i,J,e.layers[0],e.collisionBoxArray,t.index,t.sourceLayerIndex,e.index,N,z,p,0,k,U,T,t,s,f,m,_,v,b)};if(G==="line")for(const at of Kb(t.geometry,0,0,lt,lt)){const ot=sA(at,R,F,r.vertical||C,n,A,L,e.overscaling,lt);for(const It of ot)C&&fA(e,C.text,V,It)||nt(at,It,_)}else if(G==="line-center"){for(const at of t.geometry)if(at.length>1){const ot=oA(at,F,r.vertical||C,n,A,L);ot&&nt(at,ot,_)}}else if(t.type==="Polygon")for(const at of P_(t.geometry,0)){const ot=lA(at,16);nt(at[0],new _a(ot.x,ot.y,0,0,void 0),_)}else if(t.type==="LineString")for(const at of t.geometry)nt(at,new _a(at[0].x,at[0].y,0,0,void 0),_);else if(t.type==="Point")for(const at of t.geometry)for(const ot of at)nt([ot],new _a(ot.x,ot.y,0,0,void 0),_)}const Sh=255,il=Sh*ps;function rw(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T){const C=function(P,L,R,N,k,F,z,U){const G=[];if(L.positionedLines.length===0)return G;const V=N.layout.get("text-rotate").evaluate(F,{})*Math.PI/180,K=function(nt){const at=nt[0],ot=nt[1],It=at*ot;return It>0?[at,-ot]:It<0?[-at,ot]:at===0?[ot,at]:[ot,-at]}(R);let $=Math.abs(L.top-L.bottom);for(const nt of L.positionedLines)$-=nt.lineOffset;const tt=L.positionedLines.length,X=$/tt;let J=L.top-R[1];for(let nt=0;nt<tt;++nt){const at=L.positionedLines[nt];J=aA(L,X,J,nt);for(const ot of at.positionedGlyphs){if(!ot.rect)continue;const It=ot.rect||{};let xt=kb+1,dt=!0,yt=1,Ot=0;if(ot.imageName){const Br=z[ot.imageName];if(!Br)continue;if(Br.sdf){Y("SDF images are not supported in formatted text and will be ignored.");continue}dt=!1,yt=Br.pixelRatio,xt=Ni/yt}const Jt=(k||U)&&ot.vertical,Zt=ot.metrics.advance*ot.scale/2,Gt=ot.metrics,Qt=ot.rect;if(Qt===null)continue;U&&L.verticalizable&&(Ot=ot.imageName?Zt-ot.metrics.width*ot.scale/2:0);const Re=k?[ot.x+Zt,ot.y]:[0,0];let Le=[0,0],er=[0,0],De=!1;k||(Jt?(er=[ot.x+Zt+K[0],ot.y+K[1]-Ot],De=!0):Le=[ot.x+Zt+R[0],ot.y+R[1]-Ot]);const Oe=Qt.w*ot.scale/(yt*(ot.localGlyph?fs:1)),ae=Qt.h*ot.scale/(yt*(ot.localGlyph?fs:1));let Me,rr,Ae,ar;if(Jt){const Br=ot.y-J,Mr=new H(-Zt,Zt-Br),mn=-Math.PI/2,zr=new H(...er);Me=new H(-Zt+Le[0],Le[1]),Me._rotateAround(mn,Mr)._add(zr),Me.x+=-Br+Zt,Me.y-=(Gt.left-xt)*ot.scale;const wn=ot.imageName?Gt.advance*ot.scale:Nn*ot.scale,lr=String.fromCodePoint(ot.glyph);KM(lr)?Me.x+=(1-xt)*ot.scale:JM(lr)?Me.x+=wn-Gt.height*ot.scale+(-xt-1)*ot.scale:Me.x+=ot.imageName||Gt.width+2*xt===Qt.w&&Gt.height+2*xt===Qt.h?(wn-ae)/2:(wn-(Gt.height+2*xt)*ot.scale)/2,rr=new H(Me.x,Me.y-Oe),Ae=new H(Me.x+ae,Me.y),ar=new H(Me.x+ae,Me.y-Oe)}else{const Br=(Gt.left-xt)*ot.scale-Zt+Le[0],Mr=(-Gt.top-xt)*ot.scale+Le[1],mn=Br+Oe,zr=Mr+ae;Me=new H(Br,Mr),rr=new H(mn,Mr),Ae=new H(Br,zr),ar=new H(mn,zr)}if(V){let Br;Br=k?new H(0,0):De?new H(K[0],K[1]):new H(R[0],R[1]),Me._rotateAround(V,Br),rr._rotateAround(V,Br),Ae._rotateAround(V,Br),ar._rotateAround(V,Br)}const tn=new H(0,0),en=new H(0,0);G.push({tl:Me,tr:rr,bl:Ae,br:ar,texPrimary:It,texSecondary:void 0,writingMode:L.writingMode,glyphOffset:Re,sectionIndex:ot.sectionIndex,isSDF:dt,pixelOffsetTL:tn,pixelOffsetBR:en,minFontScaleX:0,minFontScaleY:0})}}return G}(0,n,p,s,a,l,i,e.allowVerticalPlacement),M=e.textSizeData;let A=null;M.kind==="source"?(A=[ps*s.layout.get("text-size").evaluate(l,{},E)],A[0]>il&&Y(`${e.layerIds[0]}: Value for "text-size" is >= ${Sh}. Reduce your "text-size".`)):M.kind==="composite"&&(A=[ps*b.compositeTextSizes[0].evaluate(l,{},E),ps*b.compositeTextSizes[1].evaluate(l,{},E)],(A[0]>il||A[1]>il)&&Y(`${e.layerIds[0]}: Value for "text-size" is >= ${Sh}. Reduce your "text-size".`)),e.addSymbols(e.text,C,A,p,a,l,m,t,r,f.lineStartIndex,f.lineLength,v,w,E,T,!1);for(const P of _)y[P]=e.text.placedSymbolArray.length-1;return 4*C.length}function nw(e){for(const t in e)return e[t];return null}function Xf(e,t,r,n,i,s,a,l,p,f){let m=a.top,_=a.bottom,y=a.left,v=a.right;const b=a.collisionPadding;if(b&&(y-=b[0],m-=b[1],v+=b[2],_+=b[3]),p){const w=new H(y,m),E=new H(v,m),T=new H(y,_),C=new H(v,_),M=re(p);let A=new H(0,0);f&&(A=new H(f[0],f[1])),w._rotateAround(M,A),E._rotateAround(M,A),T._rotateAround(M,A),C._rotateAround(M,A),y=Math.min(w.x,E.x,T.x,C.x),v=Math.max(w.x,E.x,T.x,C.x),m=Math.min(w.y,E.y,T.y,C.y),_=Math.max(w.y,E.y,T.y,C.y)}return e.emplaceBack(t.x,t.y,t.z,r.x,r.y,y,m,v,_,l,n,i,s),e.length-1}function q_(e){e.collisionPadding&&(e.top-=e.collisionPadding[1],e.bottom+=e.collisionPadding[3]);const t=e.bottom-e.top;return t>0?Math.max(10,t):null}function fA(e,t,r,n){const i=e.compareText;if(t in i){const s=i[t];for(let a=s.length-1;a>=0;a--)if(n.dist(s[a])<r)return!0}else i[t]=[];return i[t].push(n),!1}function iw(e,t){const r=e.fovAboveCenter,n=e.elevation?e.elevation.getMinElevationBelowMSL()*t:0,i=(e._camera.position[2]*e.worldSize-n)/Math.cos(e._pitch),s=Math.sin(r)*i/Math.sin(Math.max(Math.PI/2-e._pitch-r,.01)),a=Math.sin(e._pitch)*s+i;return Math.min(1.01*a,i*(1/e._horizonShift))}function ql(e,t){if(!t.isReprojectedInTileSpace)return{scale:1<<e.z,x:e.x,y:e.y,x2:e.x+1,y2:e.y+1,projection:t};const r=Math.pow(2,-e.z),n=e.x*r,i=(e.x+1)*r,s=e.y*r,a=(e.y+1)*r,l=Ji(n),p=Ji(i),f=fn(s),m=fn(a),_=t.project(l,f),y=t.project(p,f),v=t.project(p,m),b=t.project(l,m);let w=Math.min(_.x,y.x,v.x,b.x),E=Math.min(_.y,y.y,v.y,b.y),T=Math.max(_.x,y.x,v.x,b.x),C=Math.max(_.y,y.y,v.y,b.y);const M=r/16;function A(L,R,N,k,F,z){const U=(N+F)/2,G=(k+z)/2,V=t.project(Ji(U),fn(G)),K=Math.max(0,w-V.x,E-V.y,V.x-T,V.y-C);w=Math.min(w,V.x),T=Math.max(T,V.x),E=Math.min(E,V.y),C=Math.max(C,V.y),K>M&&(A(L,V,N,k,U,G),A(V,R,U,G,F,z))}A(_,y,n,s,i,s),A(y,v,i,s,i,a),A(v,b,i,a,n,a),A(b,_,n,a,n,s),w-=M,E-=M,T+=M,C+=M;const P=1/Math.max(T-w,C-E);return{scale:P,x:w*P,y:E*P,x2:T*P,y2:C*P,projection:t}}function ow(e,t,r,n,i,s,a,l,p){if(p.name==="globe")return h_(e,t,new da(r,n,i),!1);const f=ql({z:r,x:n,y:i},p);return new Zr([(s+f.x/f.scale)*t,t*(f.y/f.scale),a],[(s+f.x2/f.scale)*t,t*(f.y2/f.scale),l])}function sw(e,{x:t,y:r},n=0){return new H(((t-n)*e.scale-e.x)*lt,(r*e.scale-e.y)*lt)}function aw(e,t,r=0){return q.fromValues(((t.x-r)*e.scale-e.x)*lt,(t.y*e.scale-e.y)*lt,K1(t.z,t.y))}const dA=Q.identity(new Float32Array(16));class ol{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,r){return{x:0,y:0,z:0}}unproject(t,r){return new se(0,0)}projectTilePoint(t,r,n){return{x:t,y:r,z:0}}locationPoint(t,r,n=!0){return t._coordinatePoint(t.locationCoordinate(r),n)}pixelsPerMeter(t,r){return cr(1,t)*r}pixelSpaceConversion(t,r,n){return 1}farthestPixelDistance(t){return iw(t,t.pixelsPerMeter)}pointCoordinate(t,r,n,i){const s=t.horizonLineFromTop(!1),a=new H(r,Math.max(s,n));return t.rayIntersectionCoordinate(t.pointRayIntersection(a,i))}pointCoordinate3D(t,r,n){const i=new H(r,n);if(t.elevation)return t.elevation.pointCoordinate(i);{const s=this.pointCoordinate(t,i.x,i.y,0);return[s.x,s.y,s.z]}}isPointAboveHorizon(t,r){if(t.elevation)return!this.pointCoordinate3D(t,r.x,r.y);const n=t.horizonLineFromTop();return r.y<n}createInversionMatrix(t,r){return dA}createTileMatrix(t,r,n){let i,s,a;const l=n.canonical,p=Q.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const f=ql(l,this);i=1,s=f.x+n.wrap*f.scale,a=f.y,Q.scale(p,p,[i/f.scale,i/f.scale,t.pixelsPerMeter/r])}else i=r/t.zoomScale(l.z),s=(l.x+Math.pow(2,l.z)*n.wrap)*i,a=l.y*i;return Q.translate(p,p,[s,a,0]),Q.scale(p,p,[i/lt,i/lt,1]),p}upVector(t,r,n){return[0,0,1]}upVectorScale(t,r,n){return{metersToTile:1}}}class mA extends ol{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[r,n]=this.parallels=t.parallels||[29.5,45.5],i=Math.sin(re(r));this.n=(i+Math.sin(re(n)))/2,this.c=1+i*(2*this.n-i),this.r0=Math.sqrt(this.c)/this.n}project(t,r){const{n,c:i,r0:s}=this,a=re(t-this.center[0]),l=re(r),p=Math.sqrt(i-2*n*Math.sin(l))/n;return{x:p*Math.sin(a*n),y:p*Math.cos(a*n)-s,z:0}}unproject(t,r){const{n,c:i,r0:s}=this,a=s+r;let l=Math.atan2(t,Math.abs(a))*Math.sign(a);a*n<0&&(l-=Math.PI*Math.sign(t)*Math.sign(a));const p=re(this.center[0])*n;l=Vn(l,-Math.PI-p,Math.PI-p);const f=Bt(qt(l/n)+this.center[0],-180,180),m=Math.asin(Bt((i-(t*t+a*a)*n*n)/(2*n),-1,1)),_=Bt(qt(m),-sn,sn);return new se(f,_)}}const Ch=1.340264,Mh=-.081106,Ah=893e-6,Ph=.003796,Wf=Math.sqrt(3)/2;class gA extends ol{project(t,r){r=r/180*Math.PI,t=t/180*Math.PI;const n=Math.asin(Wf*Math.sin(r)),i=n*n,s=i*i*i;return{x:.5*(t*Math.cos(n)/(Wf*(Ch+3*Mh*i+s*(7*Ah+9*Ph*i)))/Math.PI+.5),y:1-.5*(n*(Ch+Mh*i+s*(Ah+Ph*i))/Math.PI+1),z:0}}unproject(t,r){t=(2*t-.5)*Math.PI;let n=r=(2*(1-r)-1)*Math.PI,i=n*n,s=i*i*i;for(let m,_,y,v=0;v<12&&(_=n*(Ch+Mh*i+s*(Ah+Ph*i))-r,y=Ch+3*Mh*i+s*(7*Ah+9*Ph*i),m=_/y,n=Bt(n-m,-Math.PI/3,Math.PI/3),i=n*n,s=i*i*i,!(Math.abs(m)<1e-12));++v);const a=Wf*t*(Ch+3*Mh*i+s*(7*Ah+9*Ph*i))/Math.cos(n),l=Math.asin(Math.sin(n)/Wf),p=Bt(180*a/Math.PI,-180,180),f=Bt(180*l/Math.PI,-sn,sn);return new se(p,f)}}class _A extends ol{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,r){return{x:.5+t/360,y:.5-r/360,z:0}}unproject(t,r){const n=360*(t-.5),i=Bt(360*(.5-r),-sn,sn);return new se(n,i)}}const rc=Math.PI/2;function Hf(e){return Math.tan((rc+e)/2)}class yA extends ol{constructor(t){super(t),this.center=t.center||[0,30];const[r,n]=this.parallels=t.parallels||[30,30];let i=re(r),s=re(n);this.southernCenter=i+s<0,this.southernCenter&&(i=-i,s=-s);const a=Math.cos(i),l=Hf(i);this.n=i===s?Math.sin(i):Math.log(a/Math.cos(s))/Math.log(Hf(s)/l),this.f=a*Math.pow(Hf(i),this.n)/this.n}project(t,r){r=re(r),this.southernCenter&&(r=-r),t=re(t-this.center[0]);const n=1e-6,{n:i,f:s}=this;s>0?r<-rc+n&&(r=-rc+n):r>rc-n&&(r=rc-n);const a=s/Math.pow(Hf(r),i);let l=a*Math.sin(i*t),p=s-a*Math.cos(i*t);return l=.5*(l/Math.PI+.5),p=.5*(p/Math.PI+.5),{x:l,y:this.southernCenter?p:1-p,z:0}}unproject(t,r){t=(2*t-.5)*Math.PI,this.southernCenter&&(r=1-r),r=(2*(1-r)-.5)*Math.PI;const{n,f:i}=this,s=i-r,a=Math.sign(s),l=Math.sign(n)*Math.sqrt(t*t+s*s);let p=Math.atan2(t,Math.abs(s))*a;s*n<0&&(p-=Math.PI*Math.sign(t)*a);const f=Bt(qt(p/n)+this.center[0],-180,180),m=Bt(qt(2*Math.atan(Math.pow(i/l,1/n))-rc),-sn,sn);return new se(f,this.southernCenter?-m:m)}}class lw extends ol{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,r){return{x:Xn(t),y:ri(r),z:0}}unproject(t,r){const n=Ji(t),i=fn(r);return new se(n,i)}}const uw=re(sn);class vA extends ol{project(t,r){const n=(r=re(r))*r,i=n*n;return{x:.5*((t=re(t))*(.8707-.131979*n+i*(i*(.003971*n-.001529*i)-.013791))/Math.PI+.5),y:1-.5*(r*(1.007226+n*(.015085+i*(.028874*n-.044475-.005916*i)))/Math.PI+1),z:0}}unproject(t,r){t=(2*t-.5)*Math.PI;let n=r=(2*(1-r)-1)*Math.PI,i=25,s=0,a=n*n;do{a=n*n;const f=a*a;s=(n*(1.007226+a*(.015085+f*(.028874*a-.044475-.005916*f)))-r)/(1.007226+a*(.045255+f*(.259866*a-.311325-.005916*11*f))),n=Bt(n-s,-uw,uw)}while(Math.abs(s)>1e-6&&--i>0);a=n*n;const l=Bt(qt(t/(.8707+a*(a*(a*a*a*(.003971-.001529*a)-.013791)-.131979))),-180,180),p=qt(n);return new se(l,p)}}const cw=re(sn);class xA extends ol{project(t,r){r=re(r),t=re(t);const n=Math.cos(r),i=2/Math.PI,s=Math.acos(n*Math.cos(t/2)),a=Math.sin(s)/s,l=.5*(t*i+2*n*Math.sin(t/2)/a)||0,p=.5*(r+Math.sin(r)/a)||0;return{x:.5*(l/Math.PI+.5),y:1-.5*(p/Math.PI+1),z:0}}unproject(t,r){let n=t=(2*t-.5)*Math.PI,i=r=(2*(1-r)-1)*Math.PI,s=25;const a=1e-6;let l=0,p=0;do{const f=Math.cos(i),m=Math.sin(i),_=2*m*f,y=m*m,v=f*f,b=Math.cos(n/2),w=Math.sin(n/2),E=2*b*w,T=w*w,C=1-v*b*b,M=C?1/C:0,A=C?Math.acos(f*b)*Math.sqrt(1/C):0,P=.5*(2*A*f*w+2*n/Math.PI)-t,L=.5*(A*m+i)-r,R=.5*M*(v*T+A*f*b*y)+1/Math.PI,N=M*(E*_/4-A*m*w),k=.125*M*(_*w-A*m*v*E),F=.5*M*(y*b+A*T*f)+.5,z=N*k-F*R;l=(L*N-P*F)/z,p=(P*k-L*R)/z,n=Bt(n-l,-Math.PI,Math.PI),i=Bt(i-p,-cw,cw)}while((Math.abs(l)>a||Math.abs(p)>a)&&--s>0);return new se(qt(n),qt(i))}}class hw extends ol{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(re(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,r){const{scale:n,cosPhi:i}=this;return{x:re(t)*i*n+.5,y:-Math.sin(re(r))/i*n+.5,z:0}}unproject(t,r){const{scale:n,cosPhi:i}=this,s=-(r-.5)/n,a=Bt(qt((t-.5)/n)/i,-180,180),l=Math.asin(Bt(s*i,-1,1)),p=Bt(qt(l),-sn,sn);return new se(a,p)}}class bA extends lw{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,r,n){const i=gh(t,r,n),s=Gu(hs(n));return q.transformMat4(i,i,s),{x:i[0],y:i[1],z:i[2]}}locationPoint(t,r){const n=Oi(r.lat,r.lng),i=q.normalize([],n),s=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(r),t._centerAltitude):t._centerAltitude,a=cr(1,0)*lt*s;q.scaleAndAdd(n,n,i,a);const l=Q.identity(new Float64Array(16));return Q.multiply(l,t.pixelMatrix,t.globeMatrix),q.transformMat4(n,n,l),new H(n[0],n[1])}pixelsPerMeter(t,r){return cr(1,0)*r}pixelSpaceConversion(t,r,n){const i=cr(1,t)*r,s=ce(cr(1,45)*r,i,n);return this.pixelsPerMeter(t,r)/s}createTileMatrix(t,r,n){const i=f_(hs(n.canonical));return Q.multiply(new Float64Array(16),t.globeMatrix,i)}createInversionMatrix(t,r){const{center:n}=t,i=Gu(hs(r));return Q.rotateY(i,i,re(n.lng)),Q.rotateX(i,i,re(n.lat)),Q.scale(i,i,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(i)}pointCoordinate(t,r,n,i){return V1(t,r,n,!0)||new Ue(0,0)}pointCoordinate3D(t,r,n){const i=this.pointCoordinate(t,r,n,0);return[i.x,i.y,i.z]}isPointAboveHorizon(t,r){return!V1(t,r.x,r.y,!1)}farthestPixelDistance(t){const r=function(i,s){const a=i.cameraToCenterDistance,l=i._centerAltitude*s,p=i._camera,f=i._camera.forward(),m=q.add([],q.scale([],f,-a),[0,0,l]),_=i.worldSize/(2*Math.PI),y=[0,0,-_],v=i.width/i.height,b=Math.tan(i.fovAboveCenter),w=q.scale([],p.up(),b),E=q.scale([],p.right(),b*v),T=q.normalize([],q.add([],q.add([],f,w),E)),C=[];let M;if(new vf(m,T).closestPointOnSphere(y,_,C)){const A=q.add([],C,y),P=q.sub([],A,m);M=Math.cos(i.fovAboveCenter)*q.length(P)}else{const A=q.sub([],m,y),P=q.sub([],y,m);q.normalize(P,P);const L=q.length(A)-_;M=Math.sqrt(L*(L+2*_));const R=Math.acos(M/(_+L))-Math.acos(q.dot(f,P));M*=Math.cos(R)}return 1.01*M}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),n=Zn(t.zoom);if(n>0){const i=iw(t,cr(1,t.center.lat)*t.worldSize),s=t.worldSize/(2*Math.PI),a=Math.max(t.width,t.height)/t.worldSize*Math.PI;return ce(r,i+s*(1-Math.cos(a)),Math.pow(n,10))}return r}upVector(t,r,n){return gh(r,n,t,1)}upVectorScale(t){return{metersToTile:xf(wf(hs(t)))}}}function Yf(e){const t=e.parallels,r=!!t&&Math.abs(t[0]+t[1])<.01;switch(e.name){case"mercator":return new lw(e);case"equirectangular":return new _A(e);case"naturalEarth":return new vA(e);case"equalEarth":return new gA(e);case"winkelTripel":return new xA(e);case"albers":return r?new hw(e):new mA(e);case"lambertConformalConic":return r?new hw(e):new yA(e);case"globe":return new bA(e)}throw new Error(`Invalid projection name: ${e.name}`)}const wA=new qr({"symbol-placement":new Tt(rt.layout_symbol["symbol-placement"]),"symbol-spacing":new Tt(rt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Tt(rt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new te(rt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Tt(rt.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Tt(rt.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Tt(rt.layout_symbol["icon-ignore-placement"]),"icon-optional":new Tt(rt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Tt(rt.layout_symbol["icon-rotation-alignment"]),"icon-size":new te(rt.layout_symbol["icon-size"]),"icon-text-fit":new te(rt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new te(rt.layout_symbol["icon-text-fit-padding"]),"icon-image":new te(rt.layout_symbol["icon-image"]),"icon-rotate":new te(rt.layout_symbol["icon-rotate"]),"icon-padding":new Tt(rt.layout_symbol["icon-padding"]),"icon-keep-upright":new Tt(rt.layout_symbol["icon-keep-upright"]),"icon-offset":new te(rt.layout_symbol["icon-offset"]),"icon-anchor":new te(rt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Tt(rt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Tt(rt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Tt(rt.layout_symbol["text-rotation-alignment"]),"text-field":new te(rt.layout_symbol["text-field"]),"text-font":new te(rt.layout_symbol["text-font"]),"text-size":new te(rt.layout_symbol["text-size"]),"text-max-width":new te(rt.layout_symbol["text-max-width"]),"text-line-height":new te(rt.layout_symbol["text-line-height"]),"text-letter-spacing":new te(rt.layout_symbol["text-letter-spacing"]),"text-justify":new te(rt.layout_symbol["text-justify"]),"text-radial-offset":new te(rt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Tt(rt.layout_symbol["text-variable-anchor"]),"text-anchor":new te(rt.layout_symbol["text-anchor"]),"text-max-angle":new Tt(rt.layout_symbol["text-max-angle"]),"text-writing-mode":new Tt(rt.layout_symbol["text-writing-mode"]),"text-rotate":new te(rt.layout_symbol["text-rotate"]),"text-padding":new Tt(rt.layout_symbol["text-padding"]),"text-keep-upright":new Tt(rt.layout_symbol["text-keep-upright"]),"text-transform":new te(rt.layout_symbol["text-transform"]),"text-offset":new te(rt.layout_symbol["text-offset"]),"text-allow-overlap":new Tt(rt.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Tt(rt.layout_symbol["text-ignore-placement"]),"text-optional":new Tt(rt.layout_symbol["text-optional"]),visibility:new Tt(rt.layout_symbol.visibility)});var Z_={paint:new qr({"icon-opacity":new te(rt.paint_symbol["icon-opacity"]),"icon-emissive-strength":new te(rt.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new te(rt.paint_symbol["text-emissive-strength"]),"icon-color":new te(rt.paint_symbol["icon-color"]),"icon-halo-color":new te(rt.paint_symbol["icon-halo-color"]),"icon-halo-width":new te(rt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new te(rt.paint_symbol["icon-halo-blur"]),"icon-translate":new Tt(rt.paint_symbol["icon-translate"]),"icon-translate-anchor":new Tt(rt.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new te(rt.paint_symbol["icon-image-cross-fade"]),"text-opacity":new te(rt.paint_symbol["text-opacity"]),"text-color":new te(rt.paint_symbol["text-color"],{runtimeType:Oo,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new te(rt.paint_symbol["text-halo-color"]),"text-halo-width":new te(rt.paint_symbol["text-halo-width"]),"text-halo-blur":new te(rt.paint_symbol["text-halo-blur"]),"text-translate":new Tt(rt.paint_symbol["text-translate"]),"text-translate-anchor":new Tt(rt.paint_symbol["text-translate-anchor"])}),layout:wA};class pw{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:bu,this.defaultValue=t}evaluate(t){if(t.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(t.formattedSection))return r.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ut(pw,"FormatSectionOverride",{omit:["defaultValue"]});class $f extends mo{constructor(t,r){super(t,Z_,r)}recalculate(t,r){super.recalculate(t,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const n=this.layout.get("text-writing-mode");if(n){const i=[];for(const s of n)i.indexOf(s)<0&&i.push(s);this.layout._values["text-writing-mode"]=i}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,r,n,i){const s=this.layout.get(t).evaluate(r,{},n,i),a=this._unevaluatedLayout._values[t];return a.isDataDriven()||Wp(a.value)||!s?s:function(l,p){return p.replace(/{([^{}]+)}/g,(f,m)=>m in l?String(l[m]):"")}(r.properties,s)}createBucket(t){return new Lh(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of Z_.paint.overridableProperties){if(!$f.hasPaintOverride(this.layout,t))continue;const r=this.paint.get(t),n=new pw(r),i=new hg(n,r.property.specification);let s=null;s=r.value.kind==="constant"||r.value.kind==="source"?new pg("source",i):new Hp("composite",i,r.value.zoomStops,r.value._interpolationType),this.paint._values[t]=new Nu(r.property,s,r.parameters)}}_handleOverridablePaintPropertyUpdate(t,r,n){return!(!this.layout||r.isDataDriven()||n.isDataDriven())&&$f.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,r){const n=t.get("text-field"),i=Z_.paint.properties[r];let s=!1;const a=l=>{for(const p of l)if(i.overrides&&i.overrides.hasOverride(p))return void(s=!0)};if(n.value.kind==="constant"&&n.value.value instanceof Hi)a(n.value.value.sections);else if(n.value.kind==="source"){const l=f=>{s||(f instanceof Kc&&Dn(f.value)===Xc?a(f.value.sections):f instanceof Jc?a(f.sections):f.eachChild(l))},p=n.value;p._styleExpression&&l(p._styleExpression.expression)}return s}getProgramConfiguration(t){return new Wa(this,t)}}const EA=zf.types,TA=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Kf(e,t,r,n,i,s,a,l,p,f,m,_,y){const v=l?Math.min(il,Math.round(l[0])):0,b=l?Math.min(il,Math.round(l[1])):0;e.emplaceBack(t,r,Math.round(32*n),Math.round(32*i),s,a,(v<<1)+(p?1:0),b,16*f,16*m,256*_,256*y)}function Jf(e,t,r){e.emplaceBack(t,r)}function Qf(e,t,r,n,i,s,a){e.emplaceBack(t,r,n,i,s,a)}function td(e,t,r,n,i){const s=5*t+2;e.float32[s+0]=r,e.float32[s+1]=n,e.float32[s+2]=i}function nc(e,t,r,n,i){e.emplaceBack(t,r,n,i),e.emplaceBack(t,r,n,i),e.emplaceBack(t,r,n,i),e.emplaceBack(t,r,n,i)}function IA(e){for(const t of e.sections)if(qS(t.text))return!0;return!1}class X_{constructor(t){this.layoutVertexArray=new Ag,this.indexArray=new xn,this.programConfigurations=t,this.segments=new mr,this.dynamicLayoutVertexArray=new Ga,this.opacityVertexArray=new Lg,this.placedSymbolArray=new lx,this.iconTransitioningVertexArray=new qa,this.globeExtVertexArray=new Pg}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(t,r,n,i){this.isEmpty()||(n&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,GM.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,qM.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,TA,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=t.createVertexBuffer(this.iconTransitioningVertexArray,ZM.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,jM.members,!0)),this.opacityVertexBuffer.itemSize=1),(n||i)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}}Ut(X_,"SymbolBuffers");class W_{constructor(t,r,n){this.layoutVertexArray=new t,this.layoutAttributes=r,this.indexArray=new n,this.segments=new mr,this.collisionVertexArray=new Og,this.collisionVertexArrayExt=new Za}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,XM.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,WM.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ut(W_,"CollisionBuffers");class ed{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(a=>a.id),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Q.identity([]),this.placementViewportMatrix=Q.identity([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=z_(this.zoom,r["text-size"]),this.iconSizeData=z_(this.zoom,r["icon-size"]);const n=this.layers[0].layout,i=n.get("symbol-sort-key"),s=n.get("symbol-z-order");this.canOverlap=n.get("text-allow-overlap")||n.get("icon-allow-overlap")||n.get("text-ignore-placement")||n.get("icon-ignore-placement"),this.sortFeaturesByKey=s!=="viewport-y"&&i.constantOr(1)!==void 0,this.sortFeaturesByY=(s==="viewport-y"||s==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=n.get("text-writing-mode").map(a=>Dr[a]),this.stateDependentLayerIds=this.layers.filter(a=>a.isStateDependent()).map(a=>a.id),this.sourceID=t.sourceID,this.projection=t.projection}createArrays(){this.text=new X_(new Ha(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new X_(new Ha(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new hx,this.lineVertexArray=new px,this.symbolInstances=new cx}calculateGlyphDependencies(t,r,n,i,s){for(let a=0;a<t.length;a++){const l=t.codePointAt(a);if(l===void 0)break;if(r[l]=!0,i&&s&&l<=65535){const p=Eh[t.charAt(a)];p&&(r[p.charCodeAt(0)]=!0)}}}populate(t,r,n,i){const s=this.layers[0],a=s.layout,l=this.projection.name==="globe",p=a.get("text-font"),f=a.get("text-field"),m=a.get("icon-image"),_=(f.value.kind!=="constant"||f.value.value instanceof Hi&&!f.value.value.isEmpty()||f.value.value.toString().length>0)&&(p.value.kind!=="constant"||p.value.value.length>0),y=m.value.kind!=="constant"||!!m.value.value||Object.keys(m.parameters).length>0,v=a.get("symbol-sort-key");if(this.features=[],!_&&!y)return;const b=r.iconDependencies,w=r.glyphDependencies,E=r.availableImages,T=new jr(this.zoom);for(const{feature:C,id:M,index:A,sourceLayerIndex:P}of t){const L=s._featureFilter.needGeometry,R=tl(C,L);if(!s._featureFilter.filter(T,R,n))continue;if(L||(R.geometry=zs(C,n,i)),l&&C.type!==1&&n.z<=5){const z=R.geometry,U=.98078528056,G=(V,K)=>{const $=gh(V.x,V.y,n,1),tt=gh(K.x,K.y,n,1);return q.dot($,tt)<U};for(let V=0;V<z.length;V++)z[V]=FC(z[V],G)}let N,k;if(_){const z=s.getValueAndResolveTokens("text-field",R,n,E),U=Hi.factory(z);IA(U)&&(this.hasRTLText=!0),(!this.hasRTLText||Sg()==="unavailable"||this.hasRTLText&&ko.isParsed())&&(N=$M(U,s,R))}if(y){const z=s.getValueAndResolveTokens("icon-image",R,n,E);k=z instanceof No?z:No.fromString(z)}if(!N&&!k)continue;const F=this.sortFeaturesByKey?v.evaluate(R,{},n):void 0;if(this.features.push({id:M,text:N,icon:k,index:A,sourceLayerIndex:P,geometry:R.geometry,properties:C.properties,type:EA[C.type],sortKey:F}),k&&(b[k.namePrimary]=!0,k.nameSecondary&&(b[k.nameSecondary]=!0)),N){const z=p.evaluate(R,{},n).join(","),U=a.get("text-rotation-alignment")==="map"&&a.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Dr.vertical)>=0;for(const G of N.sections)if(G.image)b[G.image.namePrimary]=!0;else{const V=yg(N.toString()),K=G.fontStack||z,$=w[K]=w[K]||{};this.calculateGlyphDependencies(G.text,$,U,this.allowVerticalPlacement,V)}}}a.get("symbol-placement")==="line"&&(this.features=function(C){const M={},A={},P=[];let L=0;function R(z){P.push(C[z]),L++}function N(z,U,G){const V=A[z];return delete A[z],A[U]=V,P[V].geometry[0].pop(),P[V].geometry[0]=P[V].geometry[0].concat(G[0]),V}function k(z,U,G){const V=M[U];return delete M[U],M[z]=V,P[V].geometry[0].shift(),P[V].geometry[0]=G[0].concat(P[V].geometry[0]),V}function F(z,U,G){const V=G?U[0][U[0].length-1]:U[0][0];return`${z}:${V.x}:${V.y}`}for(let z=0;z<C.length;z++){const U=C[z],G=U.geometry,V=U.text?U.text.toString():null;if(!V){R(z);continue}const K=F(V,G),$=F(V,G,!0);if(K in A&&$ in M&&A[K]!==M[$]){const tt=k(K,$,G),X=N(K,$,P[tt].geometry);delete M[K],delete A[$],A[F(V,P[X].geometry,!0)]=X,P[tt].geometry=null}else K in A?N(K,$,G):$ in M?k(K,$,G):(R(z),M[K]=L-1,A[$]=L-1)}return P.filter(z=>z.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((C,M)=>C.sortKey-M.sortKey)}update(t,r,n,i,s){const a=Object.keys(t).length!==0;if(a&&!this.stateDependentLayers.length)return;const l=a?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(t,r,l,n,i,s),this.icon.programConfigurations.updatePaintArrays(t,r,l,n,i,s)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Yf(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,r){const n=this.lineVertexArray.length;if(t.segment!==void 0)for(const{x:i,y:s}of r)this.lineVertexArray.emplaceBack(i,s);return{lineStartIndex:n,lineLength:this.lineVertexArray.length-n}}addSymbols(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E){const T=t.indexArray,C=t.layoutVertexArray,M=t.globeExtVertexArray,A=t.segments.prepareSegment(4*r.length,C,T,this.canOverlap?a.sortKey:void 0),P=this.glyphOffsetArray.length,L=A.vertexLength,R=this.allowVerticalPlacement&&l===Dr.vertical?Math.PI/2:0,N=a.text&&a.text.sections;for(let F=0;F<r.length;F++){const{tl:z,tr:U,bl:G,br:V,texPrimary:K,texSecondary:$,pixelOffsetTL:tt,pixelOffsetBR:X,minFontScaleX:J,minFontScaleY:nt,glyphOffset:at,isSDF:ot,sectionIndex:It}=r[F],xt=A.vertexLength,dt=at[1];if(Kf(C,f.x,f.y,z.x,dt+z.y,K.x,K.y,n,ot,tt.x,tt.y,J,nt),Kf(C,f.x,f.y,U.x,dt+U.y,K.x+K.w,K.y,n,ot,X.x,tt.y,J,nt),Kf(C,f.x,f.y,G.x,dt+G.y,K.x,K.y+K.h,n,ot,tt.x,X.y,J,nt),Kf(C,f.x,f.y,V.x,dt+V.y,K.x+K.w,K.y+K.h,n,ot,X.x,X.y,J,nt),p){const{x:yt,y:Ot,z:Jt}=p.anchor,[Zt,Gt,Qt]=p.up;Qf(M,yt,Ot,Jt,Zt,Gt,Qt),Qf(M,yt,Ot,Jt,Zt,Gt,Qt),Qf(M,yt,Ot,Jt,Zt,Gt,Qt),Qf(M,yt,Ot,Jt,Zt,Gt,Qt),nc(t.dynamicLayoutVertexArray,yt,Ot,Jt,R)}else nc(t.dynamicLayoutVertexArray,f.x,f.y,f.z,R);if(E){const yt=$||K;Jf(t.iconTransitioningVertexArray,yt.x,yt.y),Jf(t.iconTransitioningVertexArray,yt.x+yt.w,yt.y),Jf(t.iconTransitioningVertexArray,yt.x,yt.y+yt.h),Jf(t.iconTransitioningVertexArray,yt.x+yt.w,yt.y+yt.h)}T.emplaceBack(xt,xt+1,xt+2),T.emplaceBack(xt+1,xt+2,xt+3),A.vertexLength+=4,A.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(at[0]),F!==r.length-1&&It===r[F+1].sectionIndex||t.programConfigurations.populatePaintArrays(C.length,a,a.index,{},v,b,w,N&&N[It])}const k=p?p.anchor:f;t.placedSymbolArray.emplaceBack(k.x,k.y,k.z,f.x,f.y,P,this.glyphOffsetArray.length-P,L,m,_,f.segment,n?n[0]:0,n?n[1]:0,i[0],i[1],l,0,!1,0,y,0)}_commitLayoutVertex(t,r,n,i,s,a,l){t.emplaceBack(r,n,i,s,a,Math.round(l.x),Math.round(l.y))}_addCollisionDebugVertices(t,r,n,i,s,a,l){const p=n.segments.prepareSegment(4,n.layoutVertexArray,n.indexArray),f=p.vertexLength,m=l.tileAnchorX,_=l.tileAnchorY;for(let v=0;v<4;v++)n.collisionVertexArray.emplaceBack(0,0,0,0);n.collisionVertexArrayExt.emplaceBack(r,-t.padding,-t.padding),n.collisionVertexArrayExt.emplaceBack(r,t.padding,-t.padding),n.collisionVertexArrayExt.emplaceBack(r,t.padding,t.padding),n.collisionVertexArrayExt.emplaceBack(r,-t.padding,t.padding),this._commitLayoutVertex(n.layoutVertexArray,i,s,a,m,_,new H(t.x1,t.y1)),this._commitLayoutVertex(n.layoutVertexArray,i,s,a,m,_,new H(t.x2,t.y1)),this._commitLayoutVertex(n.layoutVertexArray,i,s,a,m,_,new H(t.x2,t.y2)),this._commitLayoutVertex(n.layoutVertexArray,i,s,a,m,_,new H(t.x1,t.y2)),p.vertexLength+=4;const y=n.indexArray;y.emplaceBack(f,f+1),y.emplaceBack(f+1,f+2),y.emplaceBack(f+2,f+3),y.emplaceBack(f+3,f),p.primitiveLength+=4}_addTextDebugCollisionBoxes(t,r,n,i,s,a){for(let l=i;l<s;l++){const p=n.get(l),f=this.getSymbolInstanceTextSize(t,a,r,l);this._addCollisionDebugVertices(p,f,this.textCollisionBox,p.projectedAnchorX,p.projectedAnchorY,p.projectedAnchorZ,a)}}_addIconDebugCollisionBoxes(t,r,n,i,s,a){for(let l=i;l<s;l++){const p=n.get(l),f=this.getSymbolInstanceIconSize(t,r,a.placedIconSymbolIndex);this._addCollisionDebugVertices(p,f,this.iconCollisionBox,p.projectedAnchorX,p.projectedAnchorY,p.projectedAnchorZ,a)}}generateCollisionDebugBuffers(t,r){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new W_(cf,zb.members,qa),this.iconCollisionBox=new W_(cf,zb.members,qa);const n=ks(this.iconSizeData,t),i=ks(this.textSizeData,t);for(let s=0;s<this.symbolInstances.length;s++){const a=this.symbolInstances.get(s);this._addTextDebugCollisionBoxes(i,t,r,a.textBoxStartIndex,a.textBoxEndIndex,a),this._addTextDebugCollisionBoxes(i,t,r,a.verticalTextBoxStartIndex,a.verticalTextBoxEndIndex,a),this._addIconDebugCollisionBoxes(n,t,r,a.iconBoxStartIndex,a.iconBoxEndIndex,a),this._addIconDebugCollisionBoxes(n,t,r,a.verticalIconBoxStartIndex,a.verticalIconBoxEndIndex,a)}}getSymbolInstanceTextSize(t,r,n,i){const s=this.text.placedSymbolArray.get(r.rightJustifiedTextSymbolIndex>=0?r.rightJustifiedTextSymbolIndex:r.centerJustifiedTextSymbolIndex>=0?r.centerJustifiedTextSymbolIndex:r.leftJustifiedTextSymbolIndex>=0?r.leftJustifiedTextSymbolIndex:r.verticalPlacedTextSymbolIndex>=0?r.verticalPlacedTextSymbolIndex:i),a=wh(this.textSizeData,t,s)/Nn;return this.tilePixelRatio*a}getSymbolInstanceIconSize(t,r,n){const i=this.icon.placedSymbolArray.get(n),s=wh(this.iconSizeData,t,i);return this.tilePixelRatio*s}_commitDebugCollisionVertexUpdate(t,r,n){t.emplaceBack(r,-n,-n),t.emplaceBack(r,n,-n),t.emplaceBack(r,n,n),t.emplaceBack(r,-n,n)}_updateTextDebugCollisionBoxes(t,r,n,i,s,a){for(let l=i;l<s;l++){const p=n.get(l),f=this.getSymbolInstanceTextSize(t,a,r,l);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,f,p.padding)}}_updateIconDebugCollisionBoxes(t,r,n,i,s,a){for(let l=i;l<s;l++){const p=n.get(l),f=this.getSymbolInstanceIconSize(t,r,a);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,f,p.padding)}}updateCollisionDebugBuffers(t,r){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const n=ks(this.iconSizeData,t),i=ks(this.textSizeData,t);for(let s=0;s<this.symbolInstances.length;s++){const a=this.symbolInstances.get(s);this._updateTextDebugCollisionBoxes(i,t,r,a.textBoxStartIndex,a.textBoxEndIndex,a),this._updateTextDebugCollisionBoxes(i,t,r,a.verticalTextBoxStartIndex,a.verticalTextBoxEndIndex,a),this._updateIconDebugCollisionBoxes(n,t,r,a.iconBoxStartIndex,a.iconBoxEndIndex,a.placedIconSymbolIndex),this._updateIconDebugCollisionBoxes(n,t,r,a.verticalIconBoxStartIndex,a.verticalIconBoxEndIndex,a.placedIconSymbolIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,r,n,i,s,a,l,p,f){const m={};if(r<n){const{x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A,featureIndex:P}=t.get(r);m.textBox={x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A},m.textFeatureIndex=P}if(i<s){const{x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A,featureIndex:P}=t.get(i);m.verticalTextBox={x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A},m.verticalTextFeatureIndex=P}if(a<l){const{x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A,featureIndex:P}=t.get(a);m.iconBox={x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A},m.iconFeatureIndex=P}if(p<f){const{x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A,featureIndex:P}=t.get(p);m.verticalIconBox={x1:_,y1:y,x2:v,y2:b,padding:w,projectedAnchorX:E,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:M,tileAnchorY:A},m.verticalIconFeatureIndex=P}return m}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const n=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,n.textBoxStartIndex,n.textBoxEndIndex,n.verticalTextBoxStartIndex,n.verticalTextBoxEndIndex,n.iconBoxStartIndex,n.iconBoxEndIndex,n.verticalIconBoxStartIndex,n.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(t,r){const n=t.placedSymbolArray.get(r),i=n.vertexStartIndex+4*n.numGlyphs;for(let s=n.vertexStartIndex;s<i;s+=4)t.indexArray.emplaceBack(s,s+1,s+2),t.indexArray.emplaceBack(s+1,s+2,s+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(t),n=Math.cos(t),i=[],s=[],a=[];for(let l=0;l<this.symbolInstances.length;++l){a.push(l);const p=this.symbolInstances.get(l);i.push(0|Math.round(r*p.tileAnchorX+n*p.tileAnchorY)),s.push(p.featureIndex)}return a.sort((l,p)=>i[l]-i[p]||s[p]-s[l]),a}addToSortKeyRanges(t,r){const n=this.sortKeyRanges[this.sortKeyRanges.length-1];n&&n.sortKey===r?n.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const n=this.symbolInstances.get(r);this.featureSortOrder.push(n.featureIndex);const{rightJustifiedTextSymbolIndex:i,centerJustifiedTextSymbolIndex:s,leftJustifiedTextSymbolIndex:a,verticalPlacedTextSymbolIndex:l,placedIconSymbolIndex:p,verticalPlacedIconSymbolIndex:f}=n;i>=0&&this.addIndicesForPlacedSymbol(this.text,i),s>=0&&s!==i&&this.addIndicesForPlacedSymbol(this.text,s),a>=0&&a!==s&&a!==i&&this.addIndicesForPlacedSymbol(this.text,a),l>=0&&this.addIndicesForPlacedSymbol(this.text,l),p>=0&&this.addIndicesForPlacedSymbol(this.icon,p),f>=0&&this.addIndicesForPlacedSymbol(this.icon,f)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Ut(ed,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),ed.MAX_GLYPHS=65535,ed.addDynamicAttributes=nc;var Lh=ed;const SA=Je([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:CA}=SA,MA=Je([{name:"a_packed",components:4,type:"Float32"}]),{members:AA}=MA,PA=zf.types,LA=Math.cos(Math.PI/180*37.5);class rd{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new Mg,this.layoutVertexArray2=new Ga,this.indexArray=new xn,this.programConfigurations=new Ha(t.layers,t.zoom),this.segments=new mr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,n,i){this.hasPattern=L_("line",this.layers,r);const s=this.layers[0].layout.get("line-sort-key"),a=[];for(const{feature:m,id:_,index:y,sourceLayerIndex:v}of t){const b=this.layers[0]._featureFilter.needGeometry,w=tl(m,b);if(!this.layers[0]._featureFilter.filter(new jr(this.zoom),w,n))continue;const E=s?s.evaluate(w,{},n):void 0,T={id:_,properties:m.properties,type:m.type,sourceLayerIndex:v,index:y,geometry:b?w.geometry:zs(m,n,i),patterns:{},sortKey:E};a.push(T)}s&&a.sort((m,_)=>m.sortKey-_.sortKey);const{lineAtlas:l,featureIndex:p}=r,f=this.addConstantDashes(l);for(const m of a){const{geometry:_,index:y,sourceLayerIndex:v}=m;if(f&&this.addFeatureDashes(m,l),this.hasPattern){const b=D_("line",this.layers,m,this.zoom,r);this.patternFeatures.push(b)}else this.addFeature(m,_,y,n,l.positions,r.availableImages,r.brightness);p.insert(t[y].feature,_,y,v,this.index)}}addConstantDashes(t){let r=!1;for(const n of this.layers){const i=n.paint.get("line-dasharray").value,s=n.layout.get("line-cap").value;if(i.kind!=="constant"||s.kind!=="constant")r=!0;else{const a=s.value,l=i.value;if(!l)continue;t.addDash(l,a)}}return r}addFeatureDashes(t,r){const n=this.zoom;for(const i of this.layers){const s=i.paint.get("line-dasharray").value,a=i.layout.get("line-cap").value;if(s.kind==="constant"&&a.kind==="constant")continue;let l,p;if(s.kind==="constant"){if(l=s.value,!l)continue}else l=s.evaluate({zoom:n},t);p=a.kind==="constant"?a.value:a.evaluate({zoom:n},t),r.addDash(l,p),t.patterns[i.id]=r.getKey(l,p)}}update(t,r,n,i,s){const a=Object.keys(t).length!==0;a&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,r,a?this.stateDependentLayers:this.layers,n,i,s)}addFeatures(t,r,n,i,s,a){for(const l of this.patternFeatures)this.addFeature(l,l.geometry,l.index,r,n,i,a)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,AA)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,CA),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,r,n,i,s,a,l){const p=this.layers[0].layout,f=p.get("line-join").evaluate(t,{}),m=p.get("line-cap").evaluate(t,{}),_=p.get("line-miter-limit"),y=p.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const v of r)this.addLine(v,t,f,m,_,y);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,s,a,i,l)}addLine(t,r,n,i,s,a){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let T=0;T<t.length-1;T++)this.totalDistance+=t[T].dist(t[T+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const l=PA[r.type]==="Polygon";let p=t.length;for(;p>=2&&t[p-1].equals(t[p-2]);)p--;let f=0;for(;f<p-1&&t[f].equals(t[f+1]);)f++;if(p<(l?3:2))return;n==="bevel"&&(s=1.05);const m=this.overscaling<=16?15*lt/(512*this.overscaling):0,_=this.segments.prepareSegment(10*p,this.layoutVertexArray,this.indexArray);let y,v,b,w,E;this.e1=this.e2=-1,l&&(y=t[p-2],E=t[f].sub(y)._unit()._perp());for(let T=f;T<p;T++){if(b=T===p-1?l?t[f+1]:void 0:t[T+1],b&&t[T].equals(b))continue;E&&(w=E),y&&(v=y),y=t[T],E=b?b.sub(y)._unit()._perp():w,w=w||E;let C=w.add(E);C.x===0&&C.y===0||C._unit();const M=w.x*E.x+w.y*E.y,A=C.x*E.x+C.y*E.y,P=A!==0?1/A:1/0,L=2*Math.sqrt(2-2*A),R=A<LA&&v&&b,N=w.x*E.y-w.y*E.x>0;if(R&&T>f){const z=y.dist(v);if(z>2*m){const U=y.sub(y.sub(v)._mult(m/z)._round());this.updateDistance(v,U),this.addCurrentVertex(U,w,0,0,_),v=U}}const k=v&&b;let F=k?n:l?"butt":i;if(k&&F==="round"&&(P<a?F="miter":P<=2&&(F="fakeround")),F==="miter"&&P>s&&(F="bevel"),F==="bevel"&&(P>2&&(F="flipbevel"),P<s&&(F="miter")),v&&this.updateDistance(v,y),F==="miter")C._mult(P),this.addCurrentVertex(y,C,0,0,_);else if(F==="flipbevel"){if(P>100)C=E.mult(-1);else{const z=P*w.add(E).mag()/w.sub(E).mag();C._perp()._mult(z*(N?-1:1))}this.addCurrentVertex(y,C,0,0,_),this.addCurrentVertex(y,C.mult(-1),0,0,_)}else if(F==="bevel"||F==="fakeround"){const z=-Math.sqrt(P*P-1),U=N?z:0,G=N?0:z;if(v&&this.addCurrentVertex(y,w,U,G,_),F==="fakeround"){const V=Math.round(180*L/Math.PI/20);for(let K=1;K<V;K++){let $=K/V;if($!==.5){const X=$-.5;$+=$*X*($-1)*((1.0904+M*(M*(3.55645-1.43519*M)-3.2452))*X*X+(.848013+M*(.215638*M-1.06021)))}const tt=E.sub(w)._mult($)._add(w)._unit()._mult(N?-1:1);this.addHalfVertex(y,tt.x,tt.y,!1,N,0,_)}}b&&this.addCurrentVertex(y,E,-U,-G,_)}else if(F==="butt")this.addCurrentVertex(y,C,0,0,_);else if(F==="square"){const z=v?1:-1;v||this.addCurrentVertex(y,C,z,z,_),this.addCurrentVertex(y,C,0,0,_),v&&this.addCurrentVertex(y,C,z,z,_)}else F==="round"&&(v&&(this.addCurrentVertex(y,w,0,0,_),this.addCurrentVertex(y,w,1,1,_,!0)),b&&(this.addCurrentVertex(y,E,-1,-1,_,!0),this.addCurrentVertex(y,E,0,0,_)));if(R&&T<p-1){const z=y.dist(b);if(z>2*m){const U=y.add(b.sub(y)._mult(m/z)._round());this.updateDistance(y,U),this.addCurrentVertex(U,E,0,0,_),y=U}}}}addCurrentVertex(t,r,n,i,s,a=!1){const l=r.y*i-r.x,p=-r.y-r.x*i;this.addHalfVertex(t,r.x+r.y*n,r.y-r.x*n,a,!1,n,s),this.addHalfVertex(t,l,p,a,!0,-i,s)}addHalfVertex({x:t,y:r},n,i,s,a,l,p){this.layoutVertexArray.emplaceBack((t<<1)+(s?1:0),(r<<1)+(a?1:0),Math.round(63*n)+128,Math.round(63*i)+128,1+(l===0?0:l<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const f=p.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,f),p.primitiveLength++),a?this.e2=f:this.e1=f}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,r){this.distance+=t.dist(r),this.updateScaledDistance()}}Ut(rd,"LineBucket",{omit:["layers","patternFeatures"]});class dn{constructor(t,r,n,i){this.context=t,this.format=n,this.texture=t.gl.createTexture(),this.update(r,i)}update(t,r,n){const{width:i,height:s}=t,{context:a}=this,{gl:l}=a,{HTMLImageElement:p,HTMLCanvasElement:f,HTMLVideoElement:m,ImageData:_,ImageBitmap:y}=S;if(l.bindTexture(l.TEXTURE_2D,this.texture),a.pixelStoreUnpackFlipY.set(!1),a.pixelStoreUnpack.set(1),a.pixelStoreUnpackPremultiplyAlpha.set(this.format===l.RGBA&&(!r||r.premultiply!==!1)),n||this.size&&this.size[0]===i&&this.size[1]===s){const{x:v,y:b}=n||{x:0,y:0};t instanceof p||t instanceof f||t instanceof m||t instanceof _||y&&t instanceof y?l.texSubImage2D(l.TEXTURE_2D,0,v,b,l.RGBA,l.UNSIGNED_BYTE,t):l.texSubImage2D(l.TEXTURE_2D,0,v,b,i,s,l.RGBA,l.UNSIGNED_BYTE,t.data)}else if(this.size=[i,s],t instanceof p||t instanceof f||t instanceof m||t instanceof _||y&&t instanceof y){let v=this.format;a.isWebGL2&&this.format===l.R8&&(v=l.RED),l.texImage2D(l.TEXTURE_2D,0,this.format,v,l.UNSIGNED_BYTE,t)}else{let v=this.format,b=l.UNSIGNED_BYTE;this.format===l.DEPTH_COMPONENT&&(v=l.DEPTH_COMPONENT16,b=l.UNSIGNED_SHORT),l.texImage2D(l.TEXTURE_2D,0,v,i,s,0,this.format,b,t.data)}this.useMipmap=!!(r&&r.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&l.generateMipmap(l.TEXTURE_2D)}bind(t,r){const{context:n}=this,{gl:i}=n;i.bindTexture(i.TEXTURE_2D,this.texture),t!==this.minFilter&&(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,this.useMipmap?t===i.NEAREST?i.NEAREST_MIPMAP_NEAREST:i.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),r!==this.wrapS&&(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,r),this.wrapS=r)}bindExtraParam(t,r,n,i){const{context:s}=this,{gl:a}=s;a.bindTexture(a.TEXTURE_2D,this.texture),r!==this.magFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,r),this.magFilter=r),t!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.useMipmap?t===a.NEAREST?a.NEAREST_MIPMAP_NEAREST:a.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),n!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n),this.wrapS=n),i!==this.wrapT&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapT=i)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}const Uo=32,Fs=33,sl=new Uint16Array(8184);for(let e=0;e<2046;e++){let t=e+2,r=0,n=0,i=0,s=0,a=0,l=0;for(1&t?i=s=a=Uo:r=n=l=Uo;(t>>=1)>1;){const f=r+i>>1,m=n+s>>1;1&t?(i=r,s=n,r=a,n=l):(r=i,n=s,i=a,s=l),a=f,l=m}const p=4*e;sl[p+0]=r,sl[p+1]=n,sl[p+2]=i,sl[p+3]=s}const Bs=new Uint16Array(2178),al=new Uint8Array(1089),nd=new Uint16Array(1089);function fw(e){return e===0?-.03125:e===32?.03125:0}var H_=Je([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const dw={type:2,extent:lt,loadGeometry:()=>[[new H(0,0),new H(lt+1,0),new H(lt+1,lt+1),new H(0,lt+1),new H(0,0)]]};class Dh{constructor(t,r,n,i,s){this.tileID=t,this.uid=gu(),this.uses=0,this.tileSize=r,this.tileZoom=n,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=s,i&&i.style&&(this._lastUpdatedBrightness=i.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",i&&i.transform&&(this.projection=i.transform.projection)}registerFadeDuration(t){const r=t+this.timeAdded;r<ge.now()||this.fadeEndTime&&r<this.fadeEndTime||(this.fadeEndTime=r)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=ql(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,r,n){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(i,s){const a={};if(!s)return a;for(const l of i){const p=l.layerIds.map(f=>s.getLayer(f)).filter(Boolean);if(p.length!==0){l.layers=p,l.stateDependentLayerIds&&(l.stateDependentLayers=l.stateDependentLayerIds.map(f=>p.filter(m=>m.id===f)[0]));for(const f of p)a[f.id]=l}}return a}(t.buckets,r.style),this.hasSymbolBuckets=!1;for(const i in this.buckets){const s=this.buckets[i];if(s instanceof Lh){if(this.hasSymbolBuckets=!0,!n)break;s.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const i in this.buckets){const s=this.buckets[i];if(s instanceof Lh&&s.hasRTLText){this.hasRTLText=!0,ko.isLoading()||ko.isLoaded()||Sg()!=="deferred"||ex();break}}this.queryPadding=0;for(const i in this.buckets){const s=this.buckets[i];this.queryPadding=Math.max(this.queryPadding,r.style.getLayer(i).queryRadius(s))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new Ug}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.id]}upload(t){for(const n in this.buckets){const i=this.buckets[n];i.uploadPending()&&i.upload(t)}const r=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new dn(t,this.imageAtlas.image,r.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new dn(t,this.glyphAtlasImage,r.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new dn(t,this.lineAtlas.image,r.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t,r,n){if(this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,n),!r||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const i=r.style.getBrightness();(this._lastUpdatedBrightness||i)&&(this._lastUpdatedBrightness&&i&&Math.abs(this._lastUpdatedBrightness-i)<.001||(this._lastUpdatedBrightness=i,this.updateBuckets(void 0,r)))}queryRenderedFeatures(t,r,n,i,s,a,l,p){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:i,pixelPosMatrix:l,transform:a,params:s,tileTransform:this.tileTransform},t,r,n):{}}querySourceFeatures(t,r){const n=this.latestFeatureIndex;if(!n||!n.rawTileData)return;const i=n.loadVTLayers(),s=r?r.sourceLayer:"",a=i._geojsonTileLayer||i[s];if(!a)return;const l=Jp(r&&r.filter),{z:p,x:f,y:m}=this.tileID.canonical,_={z:p,x:f,y:m};for(let y=0;y<a.length;y++){const v=a.feature(y);if(l.needGeometry){const E=tl(v,!0);if(!l.filter(new jr(this.tileID.overscaledZ),E,this.tileID.canonical))continue}else if(!l.filter(new jr(this.tileID.overscaledZ),v))continue;const b=n.getId(v,s),w=new Sb(v,p,f,m,b);w.tile=_,t.push(w)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}bucketsLoaded(){for(const t in this.buckets)if(this.buckets[t].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const r=this.expirationTime;if(t.cacheControl){const n=ie(t.cacheControl);n["max-age"]&&(this.expirationTime=Date.now()+1e3*n["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const n=Date.now();let i=!1;if(this.expirationTime>n)i=!1;else if(r)if(this.expirationTime<r)i=!0;else{const s=this.expirationTime-r;s?this.expirationTime=n+Math.max(s,3e4):i=!0}else i=!0;i?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,r){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&Object.keys(t).length!==0&&r&&this.updateBuckets(t,r)}updateBuckets(t,r){if(!this.latestFeatureIndex)return;const n=this.latestFeatureIndex.loadVTLayers(),i=r.style.listImages(),s=r.style.getBrightness();for(const a in this.buckets){if(!r.style.hasLayer(a))continue;const l=this.buckets[a],p=l.layers[0].sourceLayer||"_geojsonTileLayer",f=n[p];let m={};if(t&&(m=t[p],!f||!m||Object.keys(m).length===0))continue;if(l.update(m,f,i,this.imageAtlas&&this.imageAtlas.patternPositions||{},s),l instanceof rd||l instanceof Of){const y=r.style._getSourceCache(l.layers[0].source);r._terrain&&r._terrain.enabled&&y&&l.programConfigurations.needsUpload&&r._terrain._clearRenderCacheForTile(y.id,this.tileID)}const _=r&&r.style&&r.style.getLayer(a);_&&(this.queryPadding=Math.max(this.queryPadding,_.queryRadius(l)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ge.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=ge.now()+t}setTexture(t,r){const n=r.context,i=n.gl;this.texture=this.texture||r.getTileTexture(t.width),this.texture?this.texture.update(t,{useMipmap:!0}):(this.texture=new dn(n,t,i.RGBA,{useMipmap:!0}),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE))}setDependencies(t,r){const n={};for(const i of r)n[i]=!0;this.dependencies[t]=n}hasDependency(t,r){for(const n of t){const i=this.dependencies[n];if(i){for(const s of r)if(i[s])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,r){if(!r||r.name==="mercator"||this._tileDebugBuffer)return;const n=zs(dw,this.tileID.canonical,this.tileTransform)[0],i=new $i,s=new ph;for(let a=0;a<n.length;a++){const{x:l,y:p}=n[a];i.emplaceBack(l,p),s.emplaceBack(a)}s.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(s),this._tileDebugBuffer=t.createVertexBuffer(i,$a.members),this._tileDebugSegments=mr.simpleSegment(0,0,i.length,s.length)}_makeTileBoundsBuffers(t,r){if(this._tileBoundsBuffer||!r||r.name==="mercator")return;const n=zs(dw,this.tileID.canonical,this.tileTransform)[0];let i,s;if(this.isRaster){const a=function(l,p){const f=ql(l,p),m=Math.pow(2,l.z);for(let E=0;E<Fs;E++)for(let T=0;T<Fs;T++){const C=Ji((l.x+(T+fw(T))/Uo)/m),M=fn((l.y+(E+fw(E))/Uo)/m),A=p.project(C,M),P=E*Fs+T;Bs[2*P+0]=Math.round((A.x*f.scale-f.x)*lt),Bs[2*P+1]=Math.round((A.y*f.scale-f.y)*lt)}al.fill(0),nd.fill(0);for(let E=2045;E>=0;E--){const T=4*E,C=sl[T+0],M=sl[T+1],A=sl[T+2],P=sl[T+3],L=C+A>>1,R=M+P>>1,N=L+R-M,k=R+C-L,F=M*Fs+C,z=P*Fs+A,U=R*Fs+L,G=Math.hypot((Bs[2*F+0]+Bs[2*z+0])/2-Bs[2*U+0],(Bs[2*F+1]+Bs[2*z+1])/2-Bs[2*U+1])>=16;al[U]=al[U]||(G?1:0),E<1022&&(al[U]=al[U]||al[(M+k>>1)*Fs+(C+N>>1)]||al[(P+k>>1)*Fs+(A+N>>1)])}const _=new Ua,y=new xn;let v=0;function b(E,T){const C=T*Fs+E;return nd[C]===0&&(_.emplaceBack(Bs[2*C+0],Bs[2*C+1],E*lt/Uo,T*lt/Uo),nd[C]=++v),nd[C]-1}function w(E,T,C,M,A,P){const L=E+C>>1,R=T+M>>1;if(Math.abs(E-A)+Math.abs(T-P)>1&&al[R*Fs+L])w(A,P,E,T,L,R),w(C,M,A,P,L,R);else{const N=b(E,T),k=b(C,M),F=b(A,P);y.emplaceBack(N,k,F)}}return w(0,0,Uo,Uo,Uo,0),w(Uo,Uo,0,0,0,Uo),{vertices:_,indices:y}}(this.tileID.canonical,r);i=a.vertices,s=a.indices}else{i=new Ua,s=new xn;for(const{x:l,y:p}of n)i.emplaceBack(l,p,0,0);const a=Rf(i.int16,void 0,4);for(let l=0;l<a.length;l+=3)s.emplaceBack(a[l],a[l+1],a[l+2])}this._tileBoundsBuffer=t.createVertexBuffer(i,H_.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(s),this._tileBoundsSegments=mr.simpleSegment(0,0,i.length,s.length)}_makeGlobeTileDebugBuffers(t,r){const n=r.projection;if(!n||n.name!=="globe"||r.freezeTileCoverage)return;const i=this.tileID.canonical,s=Gu(U1(i,r)),a=Zn(r.zoom);let l;a>0&&(l=Q.invert(new Float64Array(16),r.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,i,r,s,l,a),this._makeGlobeTileDebugTextBuffer(t,i,r,s,l,a)}_globePoint(t,r,n,i,s,a,l){let p=gh(t,r,n);if(a){const f=1<<n.z,m=Xn(i.center.lng),_=ri(i.center.lat),y=(n.x+.5)/f-m;let v=0;y>.5?v=-1:y<-.5&&(v=1);let b=(t/lt+n.x)/f+v,w=(r/lt+n.y)/f;b=(b-m)*i._pixelsPerMercatorPixel+m,w=(w-_)*i._pixelsPerMercatorPixel+_;const E=[b*i.worldSize,w*i.worldSize,0];q.transformMat4(E,E,a),p=fa(p,E,l)}return q.transformMat4(p,p,s)}_makeGlobeTileDebugBorderBuffer(t,r,n,i,s,a){const l=new $i,p=new ph,f=new af,m=(y,v,b,w,E)=>{const T=(b-y)/(E-1),C=(w-v)/(E-1),M=l.length;for(let A=0;A<E;A++){const P=y+A*T,L=v+A*C;l.emplaceBack(P,L);const R=this._globePoint(P,L,r,n,i,s,a);f.emplaceBack(R[0],R[1],R[2]),p.emplaceBack(M+A)}},_=lt;m(0,0,_,0,16),m(_,0,_,_,16),m(_,_,0,_,16),m(0,_,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(p),this._tileDebugBuffer=t.createVertexBuffer(l,$a.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(f,k1.members),this._tileDebugSegments=mr.simpleSegment(0,0,l.length,p.length)}_makeGlobeTileDebugTextBuffer(t,r,n,i,s,a){const l=lt/4,p=new $i,f=new xn,m=new af,_=25;f.reserve(32),p.reserve(_),m.reserve(_);const y=(v,b)=>_*v+b;for(let v=0;v<_;v++){const b=v*l;for(let w=0;w<_;w++){const E=w*l;p.emplaceBack(E,b);const T=this._globePoint(E,b,r,n,i,s,a);m.emplaceBack(T[0],T[1],T[2])}}for(let v=0;v<4;v++)for(let b=0;b<4;b++){const w=y(v,b),E=y(v,b+1),T=y(v+1,b),C=y(v+1,b+1);f.emplaceBack(w,E,T),f.emplaceBack(T,E,C)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(f),this._tileDebugTextBuffer=t.createVertexBuffer(p,$a.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(m,k1.members),this._tileDebugTextSegments=mr.simpleSegment(0,0,_,32)}}class DA{constructor(t,r){this.max=t,this.onRemove=r,this.reset()}reset(){for(const t in this.data)for(const r of this.data[t])r.timeout&&clearTimeout(r.timeout),this.onRemove(r.value);return this.data={},this.order=[],this}add(t,r,n){const i=t.wrapped().key;this.data[i]===void 0&&(this.data[i]=[]);const s={value:r,timeout:void 0};if(n!==void 0&&(s.timeout=setTimeout(()=>{this.remove(t,s)},n)),this.data[i].push(s),this.order.push(i),this.order.length>this.max){const a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const r=this.data[t].shift();return r.timeout&&clearTimeout(r.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),r.value}getByKey(t){const r=this.data[t];return r?r[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,r){if(!this.has(t))return this;const n=t.wrapped().key,i=r===void 0?0:this.data[n].indexOf(r),s=this.data[n][i];return this.data[n].splice(i,1),s.timeout&&clearTimeout(s.timeout),this.data[n].length===0&&delete this.data[n],this.onRemove(s.value),this.order.splice(this.order.indexOf(n),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const r=this._getAndRemoveByKey(this.order[0]);r&&this.onRemove(r)}return this}filter(t){const r=[];for(const n in this.data)for(const i of this.data[n])t(i.value)||r.push(i);for(const n of r)this.remove(n.value.tileID,n)}}class ll{constructor(t,r,n,i){this.id=ll.uniqueIdxCounter,ll.uniqueIdxCounter++,this.context=t;const s=t.gl;this.buffer=s.createBuffer(),this.dynamicDraw=!!n,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?s.DYNAMIC_DRAW:s.STATIC_DRAW),this.dynamicDraw||i||r.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=ll.uniqueIdxCounter,ll.uniqueIdxCounter++;const r=this.context.gl;this.context.unbindVAO(),this.bind(),r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}ll.uniqueIdxCounter=0;const RA={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class OA{constructor(t,r,n,i,s){this.length=r.length,this.attributes=n,this.itemSize=r.bytesPerElement,this.dynamicDraw=i,this.context=t;const a=t.gl;this.buffer=a.createBuffer(),t.bindVertexBuffer.set(this.buffer),a.bufferData(a.ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.dynamicDraw||s||r.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const r=this.context.gl;this.bind(),r.bufferSubData(r.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,r){for(let n=0;n<this.attributes.length;n++){const i=r.attributes[this.attributes[n].name];i!==void 0&&t.enableVertexAttribArray(i)}}setVertexAttribPointers(t,r,n){for(let i=0;i<this.attributes.length;i++){const s=this.attributes[i],a=r.attributes[s.name];a!==void 0&&t.vertexAttribPointer(a,s.components,t[RA[s.type]],!1,this.itemSize,s.offset+this.itemSize*(n||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Cr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class NA extends Cr{getDefault(){return Se.transparent}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class zA extends Cr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class kA extends Cr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class FA extends Cr{getDefault(){return[!0,!0,!0,!0]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class BA extends Cr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class VA extends Cr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class UA extends Cr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const r=this.current;(t.func!==r.func||t.ref!==r.ref||t.mask!==r.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class GA extends Cr{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class jA extends Cr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),this.current=t,this.dirty=!1}}class qA extends Cr{getDefault(){return[0,1]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class ZA extends Cr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),this.current=t,this.dirty=!1}}class XA extends Cr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class WA extends Cr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.BLEND):r.disable(r.BLEND),this.current=t,this.dirty=!1}}class HA extends Cr{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class YA extends Cr{getDefault(){return Se.transparent}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class $A extends Cr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class KA extends Cr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),this.current=t,this.dirty=!1}}class JA extends Cr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class QA extends Cr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let tP=class extends Cr{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}};class eP extends Cr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class rP extends Cr{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class nP extends Cr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class iP extends Cr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindRenderbuffer(r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class oP extends Cr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindTexture(r.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class sP extends Cr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindBuffer(r.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class aP extends Cr{getDefault(){return null}set(t){const r=this.gl;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class lP extends Cr{constructor(t){super(t),this.vao=t.extVertexArrayObject}getDefault(){return null}set(t){this.vao&&(t!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(t),this.current=t,this.dirty=!1)}}class uP extends Cr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class cP extends Cr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class hP extends Cr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Y_ extends Cr{constructor(t,r){super(t),this.context=t,this.parent=r}getDefault(){return null}}class pP extends Y_{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class mw extends Y_{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,this.attachment(),r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class fP extends Y_{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,this.attachment(),r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class dP extends mw{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class mP{constructor(t,r,n,i,s){this.context=t,this.width=r,this.height=n;const a=this.framebuffer=t.gl.createFramebuffer();i&&(this.colorAttachment=new pP(t,a)),s&&(this.depthAttachmentType=s,this.depthAttachment=s==="renderbuffer"?new mw(t,a):new fP(t,a))}destroy(){const t=this.context.gl;if(this.colorAttachment){const r=this.colorAttachment.get();r&&t.deleteTexture(r)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const r=this.depthAttachment.get();r&&t.deleteRenderbuffer(r)}else{const r=this.depthAttachment.get();r&&t.deleteTexture(r)}t.deleteFramebuffer(this.framebuffer)}}class de{constructor(t,r,n){this.func=t,this.mask=r,this.range=n}}de.ReadOnly=!1,de.ReadWrite=!0,de.disabled=new de(519,de.ReadOnly,[0,1]);const $_=7680;class Be{constructor(t,r,n,i,s,a){this.test=t,this.ref=r,this.mask=n,this.fail=i,this.depthFail=s,this.pass=a}}Be.disabled=new Be({func:519,mask:0},0,0,$_,$_,$_);const id=771;class sr{constructor(t,r,n,i){this.blendFunction=t,this.blendColor=r,this.mask=n,this.blendEquation=i}}sr.Replace=[1,0,1,0],sr.disabled=new sr(sr.Replace,Se.transparent,[!1,!1,!1,!1]),sr.unblended=new sr(sr.Replace,Se.transparent,[!0,!0,!0,!0]),sr.alphaBlended=new sr([1,id,1,id],Se.transparent,[!0,!0,!0,!0]),sr.multiply=new sr([774,0,774,0],Se.transparent,[!0,!0,!0,!0]);const K_=1029,J_=2305;class Ge{constructor(t,r,n){this.enable=t,this.mode=r,this.frontFace=n}}Ge.disabled=new Ge(!1,K_,J_),Ge.backCCW=new Ge(!0,K_,J_),Ge.backCW=new Ge(!0,K_,2304),Ge.frontCW=new Ge(!0,1028,2304),Ge.frontCCW=new Ge(!0,1028,J_);class gP{constructor(t,r=!1){if(this.gl=t,this.isWebGL2=r,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),r){const n=t;this.extVertexArrayObject={createVertexArrayOES:n.createVertexArray.bind(t),deleteVertexArrayOES:n.deleteVertexArray.bind(t),bindVertexArrayOES:n.bindVertexArray.bind(t)}}this.clearColor=new NA(this),this.clearDepth=new zA(this),this.clearStencil=new kA(this),this.colorMask=new FA(this),this.depthMask=new BA(this),this.stencilMask=new VA(this),this.stencilFunc=new UA(this),this.stencilOp=new GA(this),this.stencilTest=new jA(this),this.depthRange=new qA(this),this.depthTest=new ZA(this),this.depthFunc=new XA(this),this.blend=new WA(this),this.blendFunc=new HA(this),this.blendColor=new YA(this),this.blendEquation=new $A(this),this.cullFace=new KA(this),this.cullFaceSide=new JA(this),this.frontFace=new QA(this),this.program=new tP(this),this.activeTexture=new eP(this),this.viewport=new rP(this),this.bindFramebuffer=new nP(this),this.bindRenderbuffer=new iP(this),this.bindTexture=new oP(this),this.bindVertexBuffer=new sP(this),this.bindElementBuffer=new aP(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new lP(this),this.pixelStoreUnpack=new uP(this),this.pixelStoreUnpackPremultiplyAlpha=new cP(this),this.pixelStoreUnpackFlipY=new hP(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extStandardDerivativesForceOff=!1,this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),r||(this.extTextureHalfFloat=t.getExtension("OES_texture_half_float")),(r||this.extTextureHalfFloat&&t.getExtension("OES_texture_half_float_linear"))&&(this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float")),this.extStandardDerivatives=r||t.getExtension("OES_standard_derivatives"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,r,n){return new ll(this,t,r,n)}createVertexBuffer(t,r,n,i){return new OA(this,t,r,n,i)}createRenderbuffer(t,r,n){const i=this.gl,s=i.createRenderbuffer();return this.bindRenderbuffer.set(s),i.renderbufferStorage(i.RENDERBUFFER,t,r,n),this.bindRenderbuffer.set(null),s}createFramebuffer(t,r,n,i){return new mP(this,t,r,n,i)}clear({color:t,depth:r,stencil:n,colorMask:i}){const s=this.gl;let a=0;t&&(a|=s.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(i||[!0,!0,!0,!0])),r!==void 0&&(a|=s.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(r),this.depthMask.set(!0)),n!==void 0&&(a|=s.STENCIL_BUFFER_BIT,this.clearStencil.set(n),this.stencilMask.set(255)),s.clear(a)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){ue(t.blendFunction,sr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class ds extends hn{constructor(t,r,n){super(),this.id=t,this._onlySymbols=n,r.on("data",i=>{i.dataType==="source"&&i.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&i.dataType==="source"&&i.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),r.on("error",()=>{this._sourceErrored=!0}),this._source=r,this._tiles={},this._cache=new DA(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=r.minTileCacheSize,this._maxTileCacheSize=r.maxTileCacheSize,this._loadedParentTiles={},this._coveredTiles={},this._state=new kM,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const r=this._tiles[t];if(r.state!=="errored"&&(r.state!=="loaded"||!r.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,r){return t.isSymbolTile=this._onlySymbols,this._source.loadTile(t,r)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,()=>{})}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const r in this._tiles){const n=this._tiles[r];n.upload(t),n.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return ho(this._tiles).map(t=>t.tileID).sort(gw).map(t=>t.key)}getRenderableIds(t){const r=[];for(const n in this._tiles)this._isIdRenderable(+n,t)&&r.push(this._tiles[n]);return t?r.sort((n,i)=>{const s=n.tileID,a=i.tileID,l=new H(s.canonical.x,s.canonical.y)._rotate(this.transform.angle),p=new H(a.canonical.x,a.canonical.y)._rotate(this.transform.angle);return s.overscaledZ-a.overscaledZ||p.y-l.y||p.x-l.x}).map(n=>n.tileID.key):r.map(n=>n.tileID).sort(gw).map(n=>n.key)}hasRenderableParent(t){const r=this.findLoadedParent(t,0);return!!r&&this._isIdRenderable(r.tileID.key)}_isIdRenderable(t,r){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(r||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,r){const n=this._tiles[t];n&&(n.state!=="loading"&&(n.state=r),this._loadTile(n,this._tileLoaded.bind(this,n,t,r)))}_tileLoaded(t,r,n,i){if(i)if(t.state="errored",i.status!==404)this._source.fire(new fe(i,{tile:t}));else if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const s=this.map.painter.terrain;this.update(this.transform,s.getScaledDemTileSize(),!0),s.resetTileLookupCache(this.id)}else this.update(this.transform);else t.timeAdded=ge.now(),n==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(r,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new wt("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const r=this.getRenderableIds();for(let i=0;i<r.length;i++){const s=r[i];if(t.neighboringTiles&&t.neighboringTiles[s]){const a=this.getTileByID(s);n(t,a),n(a,t)}}function n(i,s){if(!i.dem||i.dem.borderReady)return;i.needsHillshadePrepare=!0,i.needsDEMTextureUpload=!0;let a=s.tileID.canonical.x-i.tileID.canonical.x;const l=s.tileID.canonical.y-i.tileID.canonical.y,p=Math.pow(2,i.tileID.canonical.z),f=s.tileID.key;a===0&&l===0||Math.abs(l)>1||(Math.abs(a)>1&&(Math.abs(a+p)===1?a+=p:Math.abs(a-p)===1&&(a-=p)),s.dem&&i.dem&&(i.dem.backfillBorder(s.dem,a,l),i.neighboringTiles&&i.neighboringTiles[f]&&(i.neighboringTiles[f].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,r,n,i){for(const s in this._tiles){let a=this._tiles[s];if(i[s]||!a.hasData()||a.tileID.overscaledZ<=r||a.tileID.overscaledZ>n)continue;let l=a.tileID;for(;a&&a.tileID.overscaledZ>r+1;){const f=a.tileID.scaledTo(a.tileID.overscaledZ-1);a=this._tiles[f.key],a&&a.hasData()&&(l=f)}let p=l;for(;p.overscaledZ>r;)if(p=p.scaledTo(p.overscaledZ-1),t[p.key]){i[l.key]=l;break}}}findLoadedParent(t,r){if(t.key in this._loadedParentTiles){const n=this._loadedParentTiles[t.key];return n&&n.tileID.overscaledZ>=r?n:null}for(let n=t.overscaledZ-1;n>=r;n--){const i=t.scaledTo(n),s=this._getLoadedTile(i);if(s)return s}}_getLoadedTile(t){const r=this._tiles[t.key];return r&&r.hasData()?r:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,r){r=r||this._source.tileSize;const n=Math.ceil(t.width/r)+1,i=Math.ceil(t.height/r)+1,s=Math.floor(n*i*5),a=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,s):s,l=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,a):a;this._cache.setMaxSize(l)}handleWrapJump(t){const r=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,r){const n={};for(const i in this._tiles){const s=this._tiles[i];s.tileID=s.tileID.unwrapTo(s.tileID.wrap+r),n[s.tileID.key]=s}this._tiles=n;for(const i in this._timers)clearTimeout(this._timers[i]),delete this._timers[i];for(const i in this._tiles)this._setTileReloadTimer(+i,this._tiles[i])}}update(t,r,n){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!n)return;let i;this.updateCacheSize(t,r),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?i=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(l=>new wr(l.canonical.z,l.wrap,l.canonical.z,l.canonical.x,l.canonical.y)):(i=t.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!n,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(i=i.filter(l=>this._source.hasTile(l)))):i=[];const s=this._updateRetainedTiles(i);if(_w(this._source.type)&&i.length!==0){const l={},p={},f=Object.keys(s);for(const _ of f){const y=s[_],v=this._tiles[_];if(!v||v.fadeEndTime&&v.fadeEndTime<=ge.now())continue;const b=this.findLoadedParent(y,Math.max(y.overscaledZ-ds.maxOverzooming,this._source.minzoom));b&&(this._addTile(b.tileID),l[b.tileID.key]=b.tileID),p[_]=y}const m=i[i.length-1].overscaledZ;for(const _ in this._tiles){const y=this._tiles[_];if(s[_]||!y.hasData())continue;let v=y.tileID;for(;v.overscaledZ>m;){v=v.scaledTo(v.overscaledZ-1);const b=this._tiles[v.key];if(b&&b.hasData()&&p[v.key]){s[_]=y.tileID;break}}}for(const _ in l)s[_]||(this._coveredTiles[_]=!0,s[_]=l[_])}for(const l in s)this._tiles[l].clearFadeHold();const a=function(l,p){const f=[];for(const m in l)m in p||f.push(m);return f}(this._tiles,s);for(const l of a){const p=this._tiles[l];p.hasSymbolBuckets&&!p.holdingForFade()?p.setHoldDuration(this.map._fadeDuration):p.hasSymbolBuckets&&!p.symbolFadeFinished()||this._removeTile(+l)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const r={};if(t.length===0)return r;const n={},i=t.reduce((f,m)=>Math.min(f,m.overscaledZ),1/0),s=t[0].overscaledZ,a=Math.max(s-ds.maxOverzooming,this._source.minzoom),l=Math.max(s+ds.maxUnderzooming,this._source.minzoom),p={};for(const f of t){const m=this._addTile(f);r[f.key]=f,m.hasData()||i<this._source.maxzoom&&(p[f.key]=f)}this._retainLoadedChildren(p,i,l,r);for(const f of t){let m=this._tiles[f.key];if(m.hasData())continue;if(f.canonical.z>=this._source.maxzoom){const y=f.children(this._source.maxzoom)[0],v=this.getTile(y);if(v&&v.hasData()){r[y.key]=y;continue}}else{const y=f.children(this._source.maxzoom);if(r[y[0].key]&&r[y[1].key]&&r[y[2].key]&&r[y[3].key])continue}let _=m.wasRequested();for(let y=f.overscaledZ-1;y>=a;--y){const v=f.scaledTo(y);if(n[v.key]||(n[v.key]=!0,m=this.getTile(v),!m&&_&&(m=this._addTile(v)),m&&(r[v.key]=v,_=m.wasRequested(),m.hasData())))break}}return r}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const r=[];let n,i=this._tiles[t].tileID;for(;i.overscaledZ>0;){if(i.key in this._loadedParentTiles){n=this._loadedParentTiles[i.key];break}r.push(i.key);const s=i.scaledTo(i.overscaledZ-1);if(n=this._getLoadedTile(s),n)break;i=s}for(const s of r)this._loadedParentTiles[s]=n}}_addTile(t){let r=this._tiles[t.key];if(r)return r;r=this._cache.getAndRemove(t),r&&(this._setTileReloadTimer(t.key,r),r.tileID=t,this._state.initializeTileState(r,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,r)));const n=!!r;if(!n){const i=this.map?this.map.painter:null;r=new Dh(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,i,this._isRaster),this._loadTile(r,this._tileLoaded.bind(this,r,t.key,r.state))}return r?(r.uses++,this._tiles[t.key]=r,n||this._source.fire(new wt("dataloading",{tile:r,coord:r.tileID,dataType:"source"})),r):null}_setTileReloadTimer(t,r){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const n=r.getExpiryTimeout();n&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},n))}_removeTile(t){const r=this._tiles[t];r&&(r.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),r.uses>0||(r.hasData()&&r.state!=="reloading"?this._cache.add(r.tileID,r,r.getExpiryTimeout()):(r.aborted=!0,this._abortTile(r),this._unloadTile(r))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,r,n){const i=[],s=this.transform;if(!s)return i;const a=s.projection.name==="globe",l=Xn(s.center.lng);for(const p in this._tiles){const f=this._tiles[p];if(n&&f.clearQueryDebugViz(),f.holdingForFade())continue;let m;if(a){const _=f.tileID.canonical;if(_.z===0){const y=[Math.abs(Bt(l,...Rh(_,-1))-l),Math.abs(Bt(l,...Rh(_,1))-l)];m=[0,2*y.indexOf(Math.min(...y))-1]}else{const y=[Math.abs(Bt(l,...Rh(_,-1))-l),Math.abs(Bt(l,...Rh(_,0))-l),Math.abs(Bt(l,...Rh(_,1))-l)];m=[y.indexOf(Math.min(...y))-1]}}else m=[0];for(const _ of m){const y=t.containsTile(f,s,r,_);y&&i.push(y)}}return i}getVisibleCoordinates(t){const r=this.getRenderableIds(t).map(n=>this._tiles[n].tileID);for(const n of r)n.projMatrix=this.transform.calculateProjMatrix(n.toUnwrapped());return r}hasTransition(){if(this._source.hasTransition())return!0;if(_w(this._source.type))for(const t in this._tiles){const r=this._tiles[t];if(r.fadeEndTime!==void 0&&r.fadeEndTime>=ge.now())return!0}return!1}setFeatureState(t,r,n){this._state.updateState(t=t||"_geojsonTileLayer",r,n)}removeFeatureState(t,r,n){this._state.removeFeatureState(t=t||"_geojsonTileLayer",r,n)}getFeatureState(t,r){return this._state.getState(t=t||"_geojsonTileLayer",r)}setDependencies(t,r,n){const i=this._tiles[t];i&&i.setDependencies(r,n)}reloadTilesForDependencies(t,r){for(const n in this._tiles)this._tiles[n].hasDependency(t,r)&&this._reloadTile(+n,"reloading");this._cache.filter(n=>!n.hasDependency(t,r))}_preloadTiles(t,r){if(!this._sourceLoaded){const l=()=>{this._sourceLoaded&&(this._source.off("data",l),this._preloadTiles(t,r))};return void this._source.on("data",l)}const n=new Map,i=Array.isArray(t)?t:[t],s=this.map.painter.terrain,a=this.usedForTerrain&&s?s.getScaledDemTileSize():this._source.tileSize;for(const l of i){const p=l.coveringTiles({tileSize:a,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const f of p)n.set(f.key,f);this.usedForTerrain&&l.updateElevation(!1)}Lo(Array.from(n.values()),(l,p)=>{const f=new Dh(l,this._source.tileSize*l.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(f,m=>{this._source.type==="raster-dem"&&f.dem&&this._backfillDEM(f),p(m,f)})},r)}}function gw(e,t){const r=Math.abs(2*e.wrap)-+(e.wrap<0),n=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||n-r||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x}function _w(e){return e==="raster"||e==="image"||e==="video"||e==="custom"}function Rh(e,t){const r=1<<e.z;return[e.x/r+t,(e.x+1)/r+t]}ds.maxOverzooming=10,ds.maxUnderzooming=3;const _P=Je([{name:"a_pos_3f",components:3,type:"Float32"}]),yP=Je([{name:"a_color_3f",components:3,type:"Float32"}]),vP=Je([{name:"a_color_4f",components:4,type:"Float32"}]),xP=Je([{name:"a_uv_2f",components:2,type:"Float32"}]),bP=Je([{name:"a_normal_3f",components:3,type:"Float32"}]);Je([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]);const wP=Je([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class Q_{constructor(t=0,r=0,n=0,i=0){if(isNaN(t)||t<0||isNaN(r)||r<0||isNaN(n)||n<0||isNaN(i)||i<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=r,this.left=n,this.right=i}interpolate(t,r,n){return r.top!=null&&t.top!=null&&(this.top=ce(t.top,r.top,n)),r.bottom!=null&&t.bottom!=null&&(this.bottom=ce(t.bottom,r.bottom,n)),r.left!=null&&t.left!=null&&(this.left=ce(t.left,r.left,n)),r.right!=null&&t.right!=null&&(this.right=ce(t.right,r.right,n)),this}getCenter(t,r){const n=Bt((this.left+t-this.right)/2,0,t),i=Bt((this.top+r-this.bottom)/2,0,r);return new H(n,i)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Q_(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function yw(e,t){const r=Jr(e,3);Q.fromQuat(e,t),Wr(e,3,r)}function ty(e,t){const r=ei.identity([]);return ei.rotateZ(r,r,-t),ei.rotateX(r,r,-e),r}function vw(e,t){const r=[e[0],e[1],0],n=[t[0],t[1],0];if(q.length(r)>=1e-15){const a=q.normalize([],r);q.scale(n,a,q.dot(n,a)),t[0]=n[0],t[1]=n[1]}const i=q.cross([],t,e);if(q.len(i)<1e-15)return null;const s=Math.atan2(-i[1],i[0]);return ty(Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2]),s)}class xw{constructor(t,r){this.position=t,this.orientation=r}get position(){return this._position}set position(t){if(t){const r=t instanceof Ue?t:new Ue(t[0],t[1],t[2]);this._renderWorldCopies&&(r.x=Vn(r.x,0,1)),this._position=r}else this._position=null}lookAtPoint(t,r){if(this.orientation=null,!this.position)return;const n=this.position,i=this._elevation?this._elevation.getAtPointOrZero(Ue.fromLngLat(t)):0,s=Ue.fromLngLat(t,i),a=[s.x-n.x,s.y-n.y,s.z-n.z];r||(r=[0,0,1]),r[2]=Math.abs(r[2]),this.orientation=vw(a,r)}setPitchBearing(t,r){this.orientation=ty(re(t),re(-r))}}class od{constructor(t,r){this._transform=Q.identity([]),this.orientation=r,this.position=t}get mercatorPosition(){const t=this.position;return new Ue(t[0],t[1],t[2])}get position(){const t=Jr(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var r;t&&Wr(this._transform,3,[(r=t)[0],r[1],r[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||ei.identity([]),t&&yw(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),r=this.right();return{bearing:Math.atan2(-r[1],r[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,r){this._orientation=ty(t,r),yw(this._transform,this._orientation)}forward(){const t=Jr(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=Jr(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=Jr(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,r){const n=new Float64Array(16);return Q.invert(n,this.getWorldToCamera(t,r)),n}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,r,n){const i=this.position;q.scale(i,i,-t);const s=new Float64Array(16);return Q.fromScaling(s,[n,n,n]),Q.translate(s,s,i),s[10]*=r,s}getWorldToCamera(t,r){const n=new Float64Array(16),i=new Float64Array(4),s=this.position;return ei.conjugate(i,this._orientation),q.scale(s,s,-t),Q.fromQuat(n,i),Q.translate(n,n,s),n[1]*=-1,n[5]*=-1,n[9]*=-1,n[13]*=-1,n[8]*=r,n[9]*=r,n[10]*=r,n[11]*=r,n}getCameraToClipPerspective(t,r,n,i){const s=new Float64Array(16);return Q.perspective(s,t,r,n,i),s}getCameraToClipOrthographic(t,r,n,i,s,a){const l=new Float64Array(16);return Q.ortho(l,t,r,n,i,s,a),l}getDistanceToElevation(t,r=!1){const n=t===0?0:cr(t,r?fn(this.position[1]):this.position[1]),i=this.forward();return(n-this.position[2])/i[2]}clone(){return new od([...this.position],[...this.orientation])}}function bw(e,t){const r=Oh(e.projection,e.zoom,e.width,e.height),n=function(s,a,l,p,f){const m=new se(l.lng-180*ul,l.lat),_=new se(l.lng+180*ul,l.lat),y=s.project(m.lng,m.lat),v=s.project(_.lng,_.lat),b=-Math.atan2(v.y-y.y,v.x-y.x),w=Ue.fromLngLat(l);w.y=Bt(w.y,-1+ul,1-ul);const E=w.toLngLat(),T=s.project(E.lng,E.lat),C=Ue.fromLngLat(E);C.x+=ul;const M=C.toLngLat(),A=s.project(M.lng,M.lat),P=Tw(A.x-T.x,A.y-T.y,b),L=Ue.fromLngLat(E);L.y+=ul;const R=L.toLngLat(),N=s.project(R.lng,R.lat),k=Tw(N.x-T.x,N.y-T.y,b),F=Math.abs(P.x)/Math.abs(k.y),z=Q.identity([]);Q.rotateZ(z,z,-b*(1-(f?0:p)));const U=Q.identity([]);return Q.scale(U,U,[1,1-(1-F)*p,1]),U[4]=-k.x/k.y*p,Q.rotateZ(U,U,b),Q.multiply(U,z,U),U}(e.projection,0,e.center,r,t),i=ww(e);return Q.scale(n,n,[i,i,1]),n}function ww(e){const t=e.projection,r=Oh(e.projection,e.zoom,e.width,e.height),n=Ew(t,e.center),i=Ew(t,se.convert(t.center));return Math.pow(2,n*r+(1-r)*i)}function Oh(e,t,r,n,i=1/0){const s=e.range;if(!s)return 0;const a=Math.min(i,Math.max(r,n)),l=Math.log(a/1024)/Math.LN2;return Ti(s[0]+l,s[1]+l,t)}const ul=1/4e4;function Ew(e,t){const r=Bt(t.lat,-sn,sn),n=new se(t.lng-180*ul,r),i=new se(t.lng+180*ul,r),s=e.project(n.lng,r),a=e.project(i.lng,r),l=Ue.fromLngLat(n),p=Ue.fromLngLat(i),f=a.x-s.x,m=a.y-s.y,_=p.x-l.x,y=p.y-l.y,v=Math.sqrt((_*_+y*y)/(f*f+m*m));return Math.log(v)/Math.LN2}function Tw(e,t,r){const n=Math.cos(r),i=Math.sin(r);return{x:e*n-t*i,y:e*i+t*n}}function Zl(e,t,r){return t*(lt/(e.tileSize*Math.pow(2,r-e.tileID.overscaledZ)))}const ic={unknown:0,flipRequired:1,flipNotRequired:2},EP=Math.tan(85*Math.PI/180);function sd(e,t,r,n,i,s,a){const l=Q.create();if(r)if(s.name==="globe"){const p=function(f,m){const{x:_,y}=f.point,v=Z1(_,y,f.worldSize/f._pixelsPerMercatorPixel,0,0);return Q.multiply(v,v,f_(hs(m)))}(i,t);Q.multiply(l,l,p)}else{const p=Fu.invert([],a);l[0]=p[0],l[1]=p[1],l[4]=p[2],l[5]=p[3],n||Q.rotateZ(l,l,i.angle)}else Q.multiply(l,i.labelPlaneMatrix,e);return l}function Iw(e,t,r,n,i,s,a){const l=sd(e,t,r,n,i,s,a);return s.name==="globe"&&r||(l[2]=l[6]=l[10]=l[14]=0),l}function Sw(e,t,r,n,i,s,a){if(r){if(s.name==="globe"){const l=sd(e,t,r,n,i,s,a);return Q.invert(l,l),Q.multiply(l,e,l),l}{const l=Q.clone(e),p=Q.identity([]);return p[0]=a[0],p[1]=a[1],p[4]=a[2],p[5]=a[3],Q.multiply(l,l,p),n||Q.rotateZ(l,l,-i.angle),l}}return i.glCoordMatrix}function ms(e,t,r,n){const i=[e,t,r,1];r?gr.transformMat4(i,i,n):Rw(i,i,n);const s=i[3];return i[0]/=s,i[1]/=s,i[2]/=s,i}function Cw(e,t){return Math.min(.5+e/t*.5,1.5)}function TP(e,t){const r=e[0]/e[3],n=e[1]/e[3];return r>=-t[0]&&r<=t[0]&&n>=-t[1]&&n<=t[1]}function IP(e,t,r,n,i,s,a,l,p,f){const m=r.transform,_=n?e.textSizeData:e.iconSizeData,y=ks(_,r.transform.zoom),v=m.projection.name==="globe",b=[256/r.width*2+1,256/r.height*2+1],w=n?e.text.dynamicLayoutVertexArray:e.icon.dynamicLayoutVertexArray;w.clear();let E=null;v&&(E=n?e.text.globeExtVertexArray:e.icon.globeExtVertexArray);const T=e.lineVertexArray,C=n?e.text.placedSymbolArray:e.icon.placedSymbolArray,M=r.transform.width/r.transform.height;let A,P=!1;for(let L=0;L<C.length;L++){const R=C.get(L),{numGlyphs:N,writingMode:k}=R;if(k!==Dr.vertical||P||A===Dr.horizontal||(P=!0),A=k,(R.hidden||k===Dr.vertical)&&!P){oc(N,w);continue}P=!1;const F=new H(R.tileAnchorX,R.tileAnchorY);let{x:z,y:U,z:G}=m.projection.projectTilePoint(F.x,F.y,f.canonical);if(p){const[It,xt,dt]=p(F);z+=It,U+=xt,G+=dt}const V=[z,U,G,1];if(gr.transformMat4(V,V,t),!TP(V,b)){oc(N,w);continue}const K=V[3],$=Cw(r.transform.getCameraToCenterDistance(m.projection),K),tt=wh(_,y,R),X=a?tt/$:tt*$,J=ms(z,U,G,i);if(J[3]<=0){oc(N,w);continue}let nt={};const at=a?null:p,ot=Pw(R,X,!1,l,t,i,s,e.glyphOffsetArray,T,w,E,J,F,nt,M,at,m.projection,f,a);P=ot.useVertical,at&&ot.needsFlipping&&(nt={}),(ot.notEnoughRoom||P||ot.needsFlipping&&Pw(R,X,!0,l,t,i,s,e.glyphOffsetArray,T,w,E,J,F,nt,M,at,m.projection,f,a).notEnoughRoom)&&oc(N,w)}n?(e.text.dynamicLayoutVertexBuffer.updateData(w),E&&e.text.globeExtVertexBuffer&&e.text.globeExtVertexBuffer.updateData(E)):(e.icon.dynamicLayoutVertexBuffer.updateData(w),E&&e.icon.globeExtVertexBuffer&&e.icon.globeExtVertexBuffer.updateData(E))}function Mw(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w){const{lineStartIndex:E,glyphStartIndex:T,segment:C}=l,M=T+l.numGlyphs,A=E+l.lineLength,P=t.getoffsetX(T),L=t.getoffsetX(M-1),R=ad(e*P,r,n,i,s,a,C,E,A,p,f,m,_,y,!0,v,b,w);if(!R)return null;const N=ad(e*L,r,n,i,s,a,C,E,A,p,f,m,_,y,!0,v,b,w);return N?{first:R,last:N}:null}function Aw(e,t,r,n){return e===Dr.horizontal&&Math.abs(n)>Math.abs(r)?{useVertical:!0}:e===Dr.vertical?n>0?{needsFlipping:!0}:null:t!==ic.unknown&&function(i,s){return i===0||Math.abs(s/i)>EP}(r,n)?t===ic.flipRequired?{needsFlipping:!0}:null:r<0?{needsFlipping:!0}:null}function Pw(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C){const M=t/24,A=e.lineOffsetX*M,P=e.lineOffsetY*M,{lineStartIndex:L,glyphStartIndex:R,numGlyphs:N,segment:k,writingMode:F,flipState:z}=e,U=L+e.lineLength,G=V=>{if(m){const[X,J,nt]=V.up,at=f.length;td(m,at+0,X,J,nt),td(m,at+1,X,J,nt),td(m,at+2,X,J,nt),td(m,at+3,X,J,nt)}const[K,$,tt]=V.point;nc(f,K,$,tt,V.angle)};if(N>1){const V=Mw(M,l,A,P,r,_,y,e,p,s,v,w,!1,E,T,C);if(!V)return{notEnoughRoom:!0};if(n&&!r){let[K,$,tt]=V.first.point,[X,J,nt]=V.last.point;[K,$]=ms(K,$,tt,a),[X,J]=ms(X,J,nt,a);const at=Aw(F,z,(X-K)*b,J-$);if(e.flipState=at&&at.needsFlipping?ic.flipRequired:ic.flipNotRequired,at)return at}G(V.first);for(let K=R+1;K<R+N-1;K++){const $=ad(M*l.getoffsetX(K),A,P,r,_,y,k,L,U,p,s,v,w,!1,!1,E,T,C);if(!$)return f.length-=4*(K-R),{notEnoughRoom:!0};G($)}G(V.last)}else{if(n&&!r){const K=ms(y.x,y.y,0,i),$=L+k+1,tt=new H(p.getx($),p.gety($)),X=ms(tt.x,tt.y,0,i),J=X[3]>0?X:Dw(y,tt,K,1,i,void 0,E,T.canonical),nt=Aw(F,z,(J[0]-K[0])*b,J[1]-K[1]);if(e.flipState=nt&&nt.needsFlipping?ic.flipRequired:ic.flipNotRequired,nt)return nt}const V=ad(M*l.getoffsetX(R),A,P,r,_,y,k,L,U,p,s,v,w,!1,!1,E,T,C);if(!V)return{notEnoughRoom:!0};G(V)}return{}}function Lw(e,t,r,n,i){const{x:s,y:a,z:l}=n.projectTilePoint(e.x,e.y,t);if(!i)return ms(s,a,l,r);const[p,f,m]=i(e);return ms(s+p,a+f,l+m,r)}function Dw(e,t,r,n,i,s,a,l){const p=Lw(e.sub(t)._unit()._add(e),l,i,a,s);return q.sub(p,r,p),q.normalize(p,p),q.scaleAndAdd(p,r,p,n)}function ad(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T){const C=n?e-t:e+t;let M=C>0?1:-1,A=0;n&&(M*=-1,A=Math.PI),M<0&&(A+=Math.PI);let P=l+a+(M>0?0:1)|0,L=i,R=i,N=0,k=0;const F=Math.abs(C),z=[],U=[];let G=s,V=G;const K=()=>Dw(V,G,R,F-N+1,m,y,w,E.canonical);for(;N+k<=F;){if(P+=M,P<l||P>=p)return null;if(R=L,V=G,z.push(R),v&&U.push(V),G=new H(f.getx(P),f.gety(P)),L=_[P],!L){const xt=Lw(G,E.canonical,m,w,y);L=xt[3]>0?_[P]=xt:K()}N+=k,k=q.distance(R,L)}b&&y&&(_[P]&&(L=K(),k=q.distance(R,L)),_[P]=L);const $=(F-N)/k,tt=G.sub(V)._mult($)._add(V),X=q.sub([],L,R),J=q.scaleAndAdd([],R,X,$);let nt=[0,0,1],at=X[0],ot=X[1];if(T&&(nt=w.upVector(E.canonical,tt.x,tt.y),nt[0]!==0||nt[1]!==0||nt[2]!==1)){const xt=[nt[2],0,-nt[0]],dt=q.cross([],nt,xt);q.normalize(xt,xt),q.normalize(dt,dt),at=q.dot(X,xt),ot=q.dot(X,dt)}if(r){const xt=q.cross([],nt,X);q.normalize(xt,xt),q.scaleAndAdd(J,J,xt,r*M)}const It=A+Math.atan2(ot,at);return z.push(J),v&&U.push(tt),{point:J,angle:It,path:z,tilePath:U,up:nt}}function oc(e,t){const r=t.length,n=r+4*e;t.resize(n),t.float32.fill(-1/0,4*r,4*n)}function Rw(e,t,r){const n=t[0],i=t[1];return e[0]=r[0]*n+r[4]*i+r[12],e[1]=r[1]*n+r[5]*i+r[13],e[3]=r[3]*n+r[7]*i+r[15],e}const sc=15,Ow=(e,t,r)=>(1-r)*e+r*t,Nw=e=>e*e*e*e*e;class ey{constructor(t,r,n,i,s,a,l){this.tileSize=512,this._renderWorldCopies=s===void 0||s,this._minZoom=t||0,this._maxZoom=r||22,this._minPitch=n??0,this._maxPitch=i??60,this.setProjection(a),this.setMaxBounds(l),this.width=0,this.height=0,this._center=new se(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Q_,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new od,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const t=new ey(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}updateElevation(t,r=!1){const n=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||n)&&this._updateCameraOnTerrain(),(t||n)&&this._constrainCamera(r),this._calcMatrices()}getProjection(){return Zi(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const r=this.projection?this.getProjection():void 0;this.projection=Yf(this.projectionOptions);const n=!ue(r,this.getProjection());return n&&this._calcMatrices(),this.mercatorFromTransition=!1,n}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=Yf({name:"mercator"});const r=t!==this.projection.name;return r&&this._calcMatrices(),r}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return cr(this.center.lat,this.cameraWorldSizeForFog)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new H(this.width,this.height)}get bearing(){return Vn(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const r=-t*Math.PI/180;this.angle!==r&&(this._unmodified=!1,this.angle=r,this._calcMatrices(),this.rotationMatrix=Fu.create(),Fu.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const r=Bt(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==r&&(this._unmodified=!1,this._pitch=r,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=re(t),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const r=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==r&&(this._unmodified=!1,this._setZoom(r),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}_updateCameraOnTerrain(){if(!this._elevation||!this._elevation.isDataAvailableAtPoint(this.locationCoordinate(this.center)))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const t=this._elevation;this._centerAltitude=t.getAtPointOrZero(this.locationCoordinate(this.center)),this._centerAltitudeValidForExaggeration=t.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,r=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],n=this.horizonLineFromTop();let i=0,s=0;for(let a=0;a<r.length;a++){const l=new H(r[a][0]*this.width,n+r[a][1]*(this.height-n)),p=t.pointCoordinate(l);if(!p)continue;const f=1/Math.hypot(p[0]-this._camera.position[0],p[1]-this._camera.position[1]);i+=p[3]*f,s+=f}return s===0?NaN:i/s}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,r=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),n=this.pixelsPerMeter/this.worldSize*r,i=this._mercatorZfromZoom(t),s=this._mercatorZfromZoom(this._maxZoom),a=Math.max(i-n,s);this._setZoom(this._zoomFromMercatorZ(a))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const r=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let n;n=t.z<this._camera.position[2]?[r.x,r.y,r.z]:[t.x,t.y,t.z];const i=q.length(q.sub([],this._camera.position,n));return Bt(this._zoomFromMercatorZ(i),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let r=!1;if(t.orientation&&!ei.exactEquals(t.orientation,this._camera.orientation)&&(r=this._setCameraOrientation(t.orientation)),t.position){const n=[t.position.x,t.position.y,t.position.z];q.exactEquals(n,this._camera.position)||(this._setCameraPosition(n),r=!0)}r&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,r=new xw;return r.position=new Ue(t[0],t[1],t[2]),r.orientation=this._camera.orientation,r._elevation=this.elevation,r._renderWorldCopies=this.renderWorldCopies,r}_setCameraOrientation(t){if(!ei.length(t))return!1;ei.normalize(t,t);const r=q.transformQuat([],[0,0,-1],t),n=q.transformQuat([],[0,-1,0],t);if(n[2]<0)return!1;const i=vw(r,n);return!!i&&(this._camera.orientation=i,!0)}_setCameraPosition(t){const r=this.zoomScale(this.minZoom)*this.tileSize,n=this.zoomScale(this.maxZoom)*this.tileSize,i=this.cameraToCenterDistance;t[2]=Bt(t[2],i/n,i/r),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,r,n){this._unmodified=!1,this._edgeInsets.interpolate(t,r,n),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const r=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,r)}getVisibleUnwrappedCoordinates(t){const r=[new g_(0,t)];if(this.renderWorldCopies){const n=this.pointCoordinate(new H(0,0)),i=this.pointCoordinate(new H(this.width,0)),s=this.pointCoordinate(new H(this.width,this.height)),a=this.pointCoordinate(new H(0,this.height)),l=Math.floor(Math.min(n.x,i.x,s.x,a.x)),p=Math.floor(Math.max(n.x,i.x,s.x,a.x)),f=1;for(let m=l-f;m<=p+f;m++)m!==0&&r.push(new g_(m,t))}return r}coveringTiles(t){let r=this.coveringZoomLevel(t);const n=r,i=this.elevation&&this.elevation.exaggeration(),s=i&&!t.isTerrainDEM,a=this.projection.name==="mercator";if(t.minzoom!==void 0&&r<t.minzoom)return[];t.maxzoom!==void 0&&r>t.maxzoom&&(r=t.maxzoom);const l=this.locationCoordinate(this.center),p=this.center.lat,f=1<<r,m=[f*l.x,f*l.y,0],_=this.projection.name==="globe",y=!_,v=Bu.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,y),b=_?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),w=f*cr(1,this.center.lat),E=this._camera.position[2]/cr(1,this.center.lat),T=[f*b.x,f*b.y,E*(y?1:w)],C=_||i,M=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),A=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?r:0,P=t.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,L=t.isTerrainDEM?-P:this._elevation?this._elevation.getMinElevationBelowMSL():0,R=this.projection.isReprojectedInTileSpace?ww(this):1,N=X=>{const nt=new Ue(X.x+25e-6,X.y,X.z),at=new Ue(X.x,X.y+25e-6,X.z),ot=X.toLngLat(),It=nt.toLngLat(),xt=at.toLngLat(),dt=this.locationCoordinate(ot),yt=this.locationCoordinate(It),Ot=this.locationCoordinate(xt),Jt=Math.hypot(yt.x-dt.x,yt.y-dt.y),Zt=Math.hypot(Ot.x-dt.x,Ot.y-dt.y);return Math.sqrt(Jt*Zt)*R/25e-6},k=X=>{const J=P,nt=L;return{aabb:ow(this,f,0,0,0,X,nt,J,this.projection),zoom:0,x:0,y:0,minZ:nt,maxZ:J,wrap:X,fullyVisible:!1}},F=[];let z=[];const U=r,G=t.reparseOverscaled?n:r,V=X=>X*X,K=V((E-this._centerAltitude)*w),$=X=>{if(!this._elevation||!X.tileID||!a)return;const J=this._elevation.getMinMaxForTile(X.tileID),nt=X.aabb;J?(nt.min[2]=J.min,nt.max[2]=J.max,nt.center[2]=(nt.min[2]+nt.max[2])/2):(X.shouldSplit=tt(X),X.shouldSplit||(nt.min[2]=nt.max[2]=nt.center[2]=this._centerAltitude))},tt=X=>{if(X.zoom<A)return!0;if(X.zoom===U)return!1;if(X.shouldSplit!=null)return X.shouldSplit;const J=X.aabb.distanceX(T),nt=X.aabb.distanceY(T);let at=K,ot=1;if(_){at=V(X.aabb.distanceZ(T));const dt=Math.pow(2,X.zoom),yt=fn((X.y+1)/dt),Ot=fn(X.y/dt),Jt=Math.min(Math.max(p,yt),Ot),Zt=Tf(Jt)/Tf(p);if(ot=Jt===p?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Zt/this._mercatorScaleRatio),this.zoom<=mh&&X.zoom===U-1&&Zt>=.9)return!0}else if(s&&(at=V(X.aabb.distanceZ(T)*w)),this.projection.isReprojectedInTileSpace&&n<=5){const dt=Math.pow(2,X.zoom),yt=N(new Ue((X.x+.5)/dt,(X.y+.5)/dt));ot=yt>.85?1:yt}const It=J*J+nt*nt+at,xt=V((1<<U-X.zoom)*M*ot*((dt,yt)=>{if(yt*V(.707)<dt)return 1;const Ot=Math.sqrt(yt/dt);return Ot/(1.4144271570014144+(Math.pow(1.1,Ot-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(at,K),It));return It<xt};if(this.renderWorldCopies)for(let X=1;X<=3;X++)F.push(k(-X)),F.push(k(X));for(F.push(k(0));F.length>0;){const X=F.pop(),J=X.x,nt=X.y;let at=X.fullyVisible;const ot=()=>this.projection.name==="globe"&&(X.y===0||X.y===(1<<X.zoom)-1);if(!at){let It=C?X.aabb.intersects(v):X.aabb.intersectsFlat(v);if(It===0&&ot()){const xt=new da(X.zoom,J,nt);It=h_(this,f,xt,!0).intersects(v)}if(It===0)continue;at=It===2}if(X.zoom!==U&&tt(X))for(let It=0;It<4;It++){const xt=(J<<1)+It%2,dt=(nt<<1)+(It>>1),yt={aabb:a?X.aabb.quadrant(It):ow(this,f,X.zoom+1,xt,dt,X.wrap,X.minZ,X.maxZ,this.projection),zoom:X.zoom+1,x:xt,y:dt,wrap:X.wrap,fullyVisible:at,tileID:void 0,shouldSplit:void 0,minZ:X.minZ,maxZ:X.maxZ};s&&!_&&(yt.tileID=new wr(X.zoom+1===U?G:X.zoom+1,X.wrap,X.zoom+1,xt,dt),$(yt)),F.push(yt)}else{const It=X.zoom===U?G:X.zoom;if(t.minzoom&&t.minzoom>It)continue;if(!at){let Ot=C?X.aabb.intersectsPrecise(v):X.aabb.intersectsPreciseFlat(v);if(Ot===0&&ot()){const Jt=new da(X.zoom,J,nt);Ot=h_(this,f,Jt,!0).intersectsPrecise(v)}if(Ot===0)continue}const xt=m[0]-(.5+J+(X.wrap<<X.zoom))*(1<<r-X.zoom),dt=m[1]-.5-nt,yt=X.tileID?X.tileID:new wr(It,X.wrap,X.zoom,J,nt);z.push({tileID:yt,distanceSq:xt*xt+dt*dt})}}if(this.fogCullDistSq){const X=this.fogCullDistSq,J=this.horizonLineFromTop();z=z.filter(nt=>{const at=[0,0,0,1],ot=[lt,lt,0,1],It=this.calculateFogTileMatrix(nt.tileID.toUnwrapped());gr.transformMat4(at,at,It),gr.transformMat4(ot,ot,It);const xt=function(Ot,Jt,Zt){let Gt=0;for(let Qt=0;Qt<2;++Qt)Ot[Qt]>0&&(Gt+=(Ot[Qt]-0)*(Ot[Qt]-0)),Jt[Qt]<0&&(Gt+=(0-Jt[Qt])*(0-Jt[Qt]));return Gt}(at,ot);if(xt===0)return!0;let dt=!1;const yt=this._elevation;if(yt&&xt>X&&J!==0){const Ot=this.calculateProjMatrix(nt.tileID.toUnwrapped());let Jt;t.isTerrainDEM||(Jt=yt.getMinMaxForTile(nt.tileID)),Jt||(Jt={min:L,max:P});const Zt=function(Qt){const Re=Math.round((Qt+45+360)%360/90)%4;return ir[Re]}(this.rotation),Gt=[Zt[0]*lt,Zt[1]*lt,Jt.max];q.transformMat4(Gt,Gt,Ot),dt=(1-Gt[1])*this.height*.5<J}return xt<X||dt})}return z.sort((X,J)=>X.distanceSq-J.distanceSq).map(X=>X.tileID)}resize(t,r){this.width=t,this.height=r,this.pixelsToGLUnits=[2/t,-2/r],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const r=Bt(t.lat,-sn,sn),n=this.projection.project(t.lng,r);return new H(n.x*this.worldSize,n.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/cr(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,r){let n,i;const s=this.centerPoint;if(this.projection.name==="globe"){const l=this.worldSize;n=(r.x-s.x)/l,i=(r.y-s.y)/l}else{const l=this.pointCoordinate(r),p=this.pointCoordinate(s);n=l.x-p.x,i=l.y-p.y}const a=this.locationCoordinate(t);this.setLocation(new Ue(a.x-n,a.y-i))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this.projection.locationPoint(this,t,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(t,r){const n=r?cr(r,t.lat):void 0,i=this.projection.project(t.lng,t.lat);return new Ue(i.x,i.y,n)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,r){const n=r??this._centerAltitude,i=[t.x,t.y,0,1],s=[t.x,t.y,1,1];gr.transformMat4(i,i,this.pixelMatrixInverse),gr.transformMat4(s,s,this.pixelMatrixInverse);const a=s[3];gr.scale(i,i,1/i[3]),gr.scale(s,s,1/a);const l=i[2],p=s[2];return{p0:i,p1:s,t:l===p?0:(n-l)/(p-l)}}screenPointToMercatorRay(t){const r=[t.x,t.y,0,1],n=[t.x,t.y,1,1];return gr.transformMat4(r,r,this.pixelMatrixInverse),gr.transformMat4(n,n,this.pixelMatrixInverse),gr.scale(r,r,1/r[3]),gr.scale(n,n,1/n[3]),r[2]=cr(r[2],this._center.lat)*this.worldSize,n[2]=cr(n[2],this._center.lat)*this.worldSize,gr.scale(r,r,1/this.worldSize),gr.scale(n,n,1/this.worldSize),new vf([r[0],r[1],r[2]],q.normalize([],q.sub([],n,r)))}rayIntersectionCoordinate(t){const{p0:r,p1:n,t:i}=t,s=cr(r[2],this._center.lat),a=cr(n[2],this._center.lat);return new Ue(ce(r[0],n[0],i)/this.worldSize,ce(r[1],n[1],i)/this.worldSize,ce(s,a,i))}pointCoordinate(t,r=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,r)}pointCoordinate3D(t){if(!this.elevation)return this.pointCoordinate(t);let r=this.projection.pointCoordinate3D(this,t.x,t.y);if(r)return new Ue(r[0],r[1],r[2]);let n=0,i=this.horizonLineFromTop();if(t.y>i)return this.pointCoordinate(t);const s=.02*i,a=t.clone();for(let l=0;l<10&&i-n>s;l++){a.y=ce(n,i,.66);const p=this.projection.pointCoordinate3D(this,a.x,a.y);p?(i=a.y,r=p):n=a.y}return r?new Ue(r[0],r[1],r[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=Ka)return!this.isPointAboveHorizon(t);const r=this.pointCoordinate(t);return r.y>=0&&r.y<=1}_coordinatePoint(t,r){const n=r&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,i=[t.x*this.worldSize,t.y*this.worldSize,n+t.toAltitude(),1];return gr.transformMat4(i,i,this.pixelMatrix),i[3]>0?new H(i[0]/i[3],i[1]/i[3]):new H(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:r}=this._edgeInsets,n=this.height-this._edgeInsets.bottom,i=this.width-this._edgeInsets.right,s=this.pointLocation3D(new H(r,t)),a=this.pointLocation3D(new H(i,t)),l=this.pointLocation3D(new H(i,n)),p=this.pointLocation3D(new H(r,n));let f=Math.min(s.lng,a.lng,l.lng,p.lng),m=Math.max(s.lng,a.lng,l.lng,p.lng),_=Math.min(s.lat,a.lat,l.lat,p.lat),y=Math.max(s.lat,a.lat,l.lat,p.lat);const v=Math.pow(2,-this.zoom)/16*270,b=this.projection.name==="globe"?1:4,w=(E,T,C,M,A)=>{const P=(E+C)/2,L=(T+M)/2,R=new H(P,L),{lng:N,lat:k}=this.pointLocation3D(R),F=Math.max(0,f-N,_-k,N-m,k-y);f=Math.min(f,N),m=Math.max(m,N),_=Math.min(_,k),y=Math.max(y,k),(A<b||F>v)&&(w(E,T,P,L,A+1),w(P,L,C,M,A+1))};if(w(r,t,i,t,1),w(i,t,i,n,1),w(i,n,r,n,1),w(r,n,r,t,1),this.projection.name==="globe"){const[E,T]=function(C){const M=Q.identity(new Float64Array(16));Q.multiply(M,C.pixelMatrix,C.globeMatrix);const A=[0,Bo,0],P=[0,Vo,0];return q.transformMat4(A,A,M),q.transformMat4(P,P,M),[A[0]>0&&A[0]<=C.width&&A[1]>0&&A[1]<=C.height&&!Ef(C,new se(C.center.lat,90)),P[0]>0&&P[0]<=C.width&&P[1]>0&&P[1]<=C.height&&!Ef(C,new se(C.center.lat,-90))]}(this);E?(y=90,m=180,f=-180):T&&(_=-90,m=180,f=-180)}return new go(new se(f,_),new se(m,y))}_getBoundsRectangular(t,r){const{top:n,left:i}=this._edgeInsets,s=this.height-this._edgeInsets.bottom,a=this.width-this._edgeInsets.right,l=new H(i,n),p=new H(a,n),f=new H(a,s),m=new H(i,s);let _=this.pointCoordinate(l,t),y=this.pointCoordinate(p,t);const v=this.pointCoordinate(f,r),b=this.pointCoordinate(m,r),w=(E,T)=>(T.y-E.y)/(T.x-E.x);return _.y>1&&y.y>=0?_=new Ue((1-b.y)/w(b,_)+b.x,1):_.y<0&&y.y<=1&&(_=new Ue(-b.y/w(b,_)+b.x,0)),y.y>1&&_.y>=0?y=new Ue((1-v.y)/w(v,y)+v.x,1):y.y<0&&_.y<=1&&(y=new Ue(-v.y/w(v,y)+v.x,0)),new go().extend(this.coordinateLocation(_)).extend(this.coordinateLocation(y)).extend(this.coordinateLocation(b)).extend(this.coordinateLocation(v))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const r=t.visibleDemTiles.reduce((n,i)=>{if(i.dem){const s=i.dem.tree;n.min=Math.min(n.min,s.minimums[0]),n.max=Math.max(n.max,s.maximums[0])}return n},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(r.min*t.exaggeration(),r.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const r=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,n=this.height/2-r*(1-this._horizonShift);return t?Math.max(0,n):n}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-sn,this.maxLat=sn,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=Xn(this.minLng)*this.tileSize,this.worldMaxX=Xn(this.maxLng)*this.tileSize,this.worldMinY=ri(this.maxLat)*this.tileSize,this.worldMaxY=ri(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,r){return this.projection.createTileMatrix(this,r,t)}calculateDistanceTileData(t){const r=t.key,n=this._distanceTileDataCache;if(n[r])return n[r];const i=t.canonical,s=1/this.height,a=this.cameraWorldSize,l=a/this.zoomScale(i.z),p=(i.x+Math.pow(2,i.z)*t.wrap)*l,f=i.y*l,m=this.point;m.x*=a/this.worldSize,m.y*=a/this.worldSize;const _=this.angle,y=Math.sin(-_),v=-Math.cos(-_);return n[r]={bearing:[y,v],center:[(m.x-p)*s,(m.y-f)*s],scale:l/lt*s},n[r]}calculateFogTileMatrix(t){const r=t.key,n=this._fogTileMatrixCache;if(n[r])return n[r];const i=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return Q.multiply(i,this.worldToFogMatrix,i),n[r]=new Float32Array(i),n[r]}calculateProjMatrix(t,r=!1){const n=t.key,i=r?this._alignedProjMatrixCache:this._projMatrixCache;if(i[n])return i[n];const s=this.calculatePosMatrix(t,this.worldSize);return Q.multiply(s,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:r?this.alignedProjMatrix:this.projMatrix,s),i[n]=new Float32Array(s),i[n]}calculatePixelsToTileUnitsMatrix(t){const r=t.tileID.key,n=this._pixelsToTileUnitsCache;if(n[r])return n[r];const i=function(s,a){const{scale:l}=s.tileTransform,p=l*lt/(s.tileSize*Math.pow(2,a.zoom-s.tileID.overscaledZ+s.tileID.canonical.z));return Fu.scale(new Float32Array(4),a.inverseAdjustmentMatrix,[p,p])}(t,this);return n[r]=i,n[r]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,r=Q.fromScaling([],[t,t,t]);return Q.multiply(r,r,this.globeMatrix),r}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const r=cr(1,this._center.lat)*this.worldSize,n=this._computeCameraPosition(r),i=this._camera.forward(),s=cr(1,this._center.lat);n[2]/=s,i[2]/=s,q.normalize(i,i);const a=t.raycast(n,i,t.exaggeration());if(a){const l=q.scaleAndAdd([],n,i,a),p=new Ue(l[0],l[1],cr(l[2],fn(l[1]))),f=(p.z+q.length([p.x-n[0],p.y-n[1],p.z-n[2]*s]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(f),this._centerAltitude=p.toAltitude(),this._center=this.coordinateLocation(p),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const r=this._elevation,n=cr(1,this._center.lat)*this.worldSize,i=this._computeCameraPosition(n),s=r.getAtPointOrZero(new Ue(...i)),a=this.pixelsPerMeter/this.worldSize*s,l=this._minimumHeightOverTerrain(),p=i[2]-a;if(p<=l)if(p<0||t){const f=this.locationCoordinate(this._center,this._centerAltitude),m=[i[0],i[1],f.z-i[2]],_=q.length(m);m[2]-=(l-p)/this._pixelsPerMercatorPixel;const y=q.length(m);if(y===0)return;q.scale(m,m,_/y*this._pixelsPerMercatorPixel),this._camera.position=[i[0],i[1],f.z*this._pixelsPerMercatorPixel-m[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const y=this.center;return y.lat=Bt(y.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(y.lng=Bt(y.lng,this.minLng,this.maxLng)),this.center=y,void(this._constraining=!1)}const r=this._unmodified,{x:n,y:i}=this.point;let s=0,a=n,l=i;const p=this.width/2,f=this.height/2,m=this.worldMinY*this.scale,_=this.worldMaxY*this.scale;if(i-f<m&&(l=m+f),i+f>_&&(l=_-f),_-m<this.height&&(s=Math.max(s,this.height/(_-m)),l=(_+m)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const y=this.worldMinX*this.scale,v=this.worldMaxX*this.scale,b=this.worldSize/2-(y+v)/2;a=(n+b+this.worldSize)%this.worldSize-b,a-p<y&&(a=y+p),a+p>v&&(a=v-p),v-y<this.width&&(s=Math.max(s,this.width/(v-y)),a=(v+y)/2)}a===n&&l===i||(this.center=this.unproject(new H(a,l))),s&&(this.zoom+=this.scaleZoom(s)),this._constrainCamera(),this._unmodified=r,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,r=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=cr(1,this.center.lat)/cr(1,45));const n=Oh(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,n),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const i=this.projection.zAxisUnit==="meters"?r:1,s=this._camera.getWorldToCamera(this.worldSize,i);let a;const l=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(l[8]=2*-t.x/this.width,l[9]=2*t.y/this.height,this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<sc){let N=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),k=N*this.aspect,F=-k,z=-N;k-=t.x,F-=t.x,N+=t.y,z+=t.y,a=this._camera.getCameraToClipOrthographic(F,k,z,N,this._nearZ,this._farZ),((U,G,V,K)=>{for(let $=0;$<16;$++)U[$]=Ow(G[$],V[$],K)})(a,a,l,Nw(this.pitch>=sc?1:this.pitch/sc))}else a=l;const p=Q.mul([],l,s);let f=Q.mul([],a,s);if(this.projection.isReprojectedInTileSpace){const N=this.locationCoordinate(this.center),k=Q.identity([]);Q.translate(k,k,[N.x*this.worldSize,N.y*this.worldSize,0]),Q.multiply(k,k,bw(this)),Q.translate(k,k,[-N.x*this.worldSize,-N.y*this.worldSize,0]),Q.multiply(f,f,k),Q.multiply(p,p,k),this.inverseAdjustmentMatrix=function(F){const z=bw(F,!0);return Fu.invert([],[z[0],z[1],z[4],z[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=Q.scale([],f,[this.worldSize,this.worldSize,this.worldSize/i,1]),this.projMatrix=f,this.invProjMatrix=Q.invert(new Float64Array(16),this.projMatrix);const m=Q.invert([],a);this.frustumCorners=a_.fromInvProjectionMatrix(m,this.horizonLineFromTop(),this.height);const _=new Float32Array(16);Q.identity(_),Q.scale(_,_,[1,-1,1]),Q.rotateX(_,_,this._pitch),Q.rotateZ(_,_,this.angle);const y=Q.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=Q.clone(y);const v=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;y[8]=2*-t.x/this.width,y[9]=2*(t.y+v)/this.height,this.skyboxMatrix=Q.multiply(_,y,_);const b=this.point,w=b.x,E=b.y,T=this.width%2/2,C=this.height%2/2,M=Math.cos(this.angle),A=Math.sin(this.angle),P=w-Math.round(w)+M*T+A*C,L=E-Math.round(E)+M*C+A*T,R=new Float64Array(f);if(Q.translate(R,R,[P>.5?P-1:P,L>.5?L-1:L,0]),this.alignedProjMatrix=R,f=Q.create(),Q.scale(f,f,[this.width/2,-this.height/2,1]),Q.translate(f,f,[1,-1,0]),this.labelPlaneMatrix=f,f=Q.create(),Q.scale(f,f,[1,-1,1]),Q.translate(f,f,[-1,-1,0]),Q.scale(f,f,[2/this.width,2/this.height,1]),this.glCoordMatrix=f,this.pixelMatrix=Q.multiply(new Float64Array(16),this.labelPlaneMatrix,p),this._calcFogMatrices(),this._distanceTileDataCache={},f=Q.invert(new Float64Array(16),this.pixelMatrix),!f)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=f,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=function(k){const{x:F,y:z}=k.point,{lng:U,lat:G}=k._center;return Z1(F,z,k.worldSize,U,G)}(this);const N=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=q.transformMat4(N,N,s),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=f;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,r=this.cameraPixelsPerMeter,n=this._camera.position,i=1/this.height/this._pixelsPerMercatorPixel,s=[t,t,r];q.scale(s,s,i),q.scale(n,n,-1),q.multiply(n,n,s);const a=Q.create();Q.translate(a,a,n),Q.scale(a,a,s),this.mercatorFogMatrix=a,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,r,i)}_computeCameraPosition(t){const r=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,n=this._camera.forward(),i=this.point,s=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*r-t/this.worldSize*this._centerAltitude;return[i.x/this.worldSize-n[0]*s,i.y/this.worldSize-n[1]*s,t/this.worldSize*this._centerAltitude-n[2]*s]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const r=this._maxCameraBoundsDistance()*Math.cos(this._pitch),n=this._camera.position[2],i=t[2];let s=1;this.projection.wrap&&(this.center=this.center.wrap()),i>0&&(s=Math.min((r-n)/i,1)),this._camera.position=q.scaleAndAdd([],this._camera.position,t,s),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,r=this._camera.forward(),{pitch:n,bearing:i}=this._camera.getPitchBearing(),s=cr(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,a=this._mercatorZfromZoom(this._maxZoom)*Math.cos(re(this._maxPitch)),l=Math.max((t[2]-s)/Math.cos(n),a),p=this._zoomFromMercatorZ(l);q.scaleAndAdd(t,t,r,l),this._pitch=Bt(n,re(this.minPitch),re(this.maxPitch)),this.angle=Vn(i,-Math.PI,Math.PI),this._setZoom(Bt(p,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new Ue(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min((this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let r=0,n=Ka,i=0,s=1/0;for(;n-r>1e-6&&n>r;){const a=r+.5*(n-r),l=this.tileSize*Math.pow(2,a),p=this.getCameraToCenterDistance(this.projection,a,l),f=this.scaleZoom(p/(t*this.tileSize)),m=Math.abs(a-f);m<s&&(s=m,i=a),a<f?r=a:n=a}return i}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(Y("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,r){const n=Math.min(t.x,r.x),i=Math.max(t.x,r.x),s=Math.min(t.y,r.y),a=Math.max(t.y,r.y);if(s<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const l=[new H(n,s),new H(i,a),new H(n,a),new H(i,s)],p=this.renderWorldCopies?-3:0,f=this.renderWorldCopies?4:1;for(const m of l){const _=this.pointRayIntersection(m);if(_.t<0)return!0;const y=this.rayIntersectionCoordinate(_);if(y.x<p||y.y<0||y.x>f||y.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+qt(this.fovAboveCenter)>88||this.anyCornerOffEdge(new H(0,0),new H(this.width,this.height))}zoomDeltaToMovement(t,r){const n=q.length(q.sub([],this._camera.position,t)),i=this._zoomFromMercatorZ(n)+r;return n-this._mercatorZfromZoom(i)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([r,n,i],s){const a=[r,n,i,1];gr.transformMat4(a,a,s);const l=a[3]=Math.max(a[3],1e-6);return a[0]/=l,a[1]/=l,a[2]/=l,a}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new H(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new H(0,t))}}getCameraToCenterDistance(t,r=this.zoom,n=this.worldSize){const i=Oh(t,r,this.width,this.height,1024),s=t.pixelSpaceConversion(this.center.lat,n,i);let a=.5/Math.tan(.5*this._fov)*this.height*s;return this._orthographicProjectionAtLowPitch&&this.projection.name!=="globe"&&this.pitch<sc&&(a=Ow(1,a,Nw(this.pitch>=sc?1:this.pitch/sc))),a}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&Q.multiply(t,t,this.globeMatrix),t}}function zw(e,t,r){Q.identity(e),Q.rotateZ(e,e,re(t[2])),Q.rotateX(e,e,re(t[0])),Q.rotateY(e,e,re(t[1])),Q.scale(e,e,r),Q.multiply(e,e,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function ld(e,t,r,n,i,s,a,l){const p=[r[0]-t[0],r[1]-t[1],0],f=[n[0]-t[0],n[1]-t[1],0];if(q.length(p)<1e-12||q.length(f)<1e-12)return ei.identity(e);const m=q.cross([],p,f);q.normalize(m,m),q.subtract(f,n,t),p[2]=(s-i)*l,f[2]=(a-i)*l;const _=p;return q.cross(_,p,f),q.normalize(_,_),ei.rotationTo(e,m,_)}function kw(e,t,r=!1){const n=Zn(t.zoom),i=function(s,a,l){const p=a.worldSize,f=[s[12],s[13],s[14]],m=fn(f[1]/p),_=Ji(f[0]/p),y=Q.identity([]),v=cr(1,m)*p,b=cr(1,0)*p*Qa(m,a.zoom),w=1/d_(p);let E=b*w;if(l){const A=Oh(a.projection,a.zoom,a.width,a.height,1024);E=w*a.projection.pixelSpaceConversion(a.center.lat,p,A)}const T=Oi(m,_);q.add(T,T,q.scale([],q.normalize([],T),v*E*f[2]));const C=function(A){const P=[A[0],A[1],A[2]];let L=[0,1,0];const R=q.cross([],L,P);return q.cross(L,P,R),q.squaredLength(L)===0&&(L=[0,1,0],q.cross(R,P,L)),q.normalize(R,R),q.normalize(L,L),q.normalize(P,P),[R[0],R[1],R[2],0,L[0],L[1],L[2],0,P[0],P[1],P[2],0,A[0],A[1],A[2],1]}(T);Q.scale(y,y,[E,E,E*v]),Q.translate(y,y,[-f[0],-f[1],-f[2]]);const M=Q.multiply([],a.globeMatrix,C);return Q.multiply(M,M,y),Q.multiply(M,M,s),M}(e,t,r);if(n>0){const s=function(a,l){const p=l.worldSize,f=cr(1,0)*p*Qa(l.center.lat,l.zoom)/d_(p),m=cr(1,l.center.lat)*p,_=Q.identity([]);return Q.rotateY(_,_,re(l.center.lng)),Q.rotateX(_,_,re(l.center.lat)),Q.translate(_,_,[0,0,Ki]),Q.scale(_,_,[f,f,f*m]),Q.translate(_,_,[l.point.x-.5*p,l.point.y-.5*p,0]),Q.multiply(_,_,a),Q.multiply(_,l.globeMatrix,_)}(e,t);return function(a,l,p){const f=(b,w,E)=>{const T=q.length(b),C=q.length(w),M=fa(b,w,E);return q.scale(M,M,1/q.length(M)*ce(T,C,E))},m=f([a[0],a[1],a[2]],[l[0],l[1],l[2]],p),_=f([a[4],a[5],a[6]],[l[4],l[5],l[6]],p),y=f([a[8],a[9],a[10]],[l[8],l[9],l[10]],p),v=fa([a[12],a[13],a[14]],[l[12],l[13],l[14]],p);return[m[0],m[1],m[2],0,_[0],_[1],_[2],0,y[0],y[1],y[2],0,v[0],v[1],v[2],1]}(i,s,n)}return i}const SP=[1,1,1];class Fw{constructor(t,r,n,i,s){this.id=t,this.uri=r,this.position=n!=null?new se(n[0],n[1]):new se(0,0),this.orientation=i??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new Zr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,r){if(Q.multiply(t.matrix,r,t.matrix),t.meshes)for(const n of t.meshes){const i=Zr.applyTransform(n.aabb,t.matrix);this.aabb.encapsulate(i)}if(t.children)for(const n of t.children)this._applyTransformations(n,t.matrix)}computeBoundsAndApplyParent(){const t=Q.identity([]);for(const r of this.nodes)this._applyTransformations(r,t)}_positionModelOnTerrain(t,r){const n=t.elevation;if(!n)return 0;const i=Zr.projectAabbCorners(this.aabb,this.matrix),s=cr(1,this.position.lat)*t.worldSize,a=function(T,C){const M=[0,0,1],A=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const P of A){const L=T[P.corners[0]],R=T[P.corners[1]],N=T[P.corners[2]],k=[R[0]-L[0],R[1]-L[1],C*(R[2]-L[2])],F=q.cross(k,k,[N[0]-L[0],N[1]-L[1],C*(N[2]-L[2])]);q.normalize(F,F),P.dotProductWithUp=q.dot(F,M)}return A.sort((P,L)=>P.dotProductWithUp-L.dotProductWithUp),A[0].corners}(i,s),l=i[a[0]],p=i[a[1]],f=i[a[2]],m=i[a[3]],_=n.getAtPointOrZero(new Ue(l[0]/t.worldSize,l[1]/t.worldSize),0),y=n.getAtPointOrZero(new Ue(p[0]/t.worldSize,p[1]/t.worldSize),0),v=n.getAtPointOrZero(new Ue(f[0]/t.worldSize,f[1]/t.worldSize),0),b=n.getAtPointOrZero(new Ue(m[0]/t.worldSize,m[1]/t.worldSize),0),w=(_+b)/2,E=(y+v)/2;return w>E?y<v?ld(r,p,m,l,y,b,_,s):ld(r,f,l,m,v,_,b,s):_<b?ld(r,l,p,f,_,y,v,s):ld(r,m,f,p,b,v,y,s),Math.max(w,E)}computeModelMatrix(t,r,n,i,s,a,l=!1){const p=t.transform,f=p.zoom,m=p.project(this.position),_=Qa(this.position.lat,f),y=1/_;Q.identity(this.matrix),Q.translate(this.matrix,this.matrix,[m.x+i[0]*y,m.y+i[1]*y,i[2]]);let v=1,b=1;const w=p.worldSize;if(l){if(p.projection.name==="mercator"){let M=0;p.elevation&&(M=p.elevation.getAtPointOrZero(new Ue(m.x/w,m.y/w),0));const A=gr.transformMat4([],[m.x,m.y,M,1],p.projMatrix)[3]/p.cameraToCenterDistance;v=A,b=A*Qa(p.center.lat,f)}else if(p.projection.name==="globe"){const M=kw(this.matrix,p),A=Q.multiply([],p.projMatrix,M),P=[0,0,0,1];gr.transformMat4(P,P,A);const L=P[3]/p.cameraToCenterDistance,R=Zn(f),N=p.projection.pixelsPerMeter(this.position.lat,w)*Qa(this.position.lat,f),k=p.projection.pixelsPerMeter(p.center.lat,w)*Qa(p.center.lat,f);v=L/ce(N,J1(p.center.lat),R),b=L*_/N,v*=k,b*=k}}else v=y;Q.scale(this.matrix,this.matrix,[v,v,b]);const E=[...this.matrix],T=this.orientation,C=[];if(zw(C,[T[0]+r[0],T[1]+r[1],T[2]+r[2]],n),Q.multiply(this.matrix,E,C),s&&p.elevation){let M=0;const A=[];if(a&&p.elevation){M=this._positionModelOnTerrain(p,A);const P=Q.fromQuat([],A),L=Q.multiply([],P,C);Q.multiply(this.matrix,E,L)}else M=p.elevation.getAtPointOrZero(new Ue(m.x/w,m.y/w),0);M!==0&&(this.matrix[14]+=M)}}upload(t){if(!this.uploaded){for(const r of this.nodes)ry(r,t);for(const r of this.nodes)ud(r);this.uploaded=!0}}destroy(){for(const t of this.nodes)cd(t)}}function Nh(e,t,r=!1){e.uploaded||(e.gfxTexture=new dn(t,e.image,r?t.gl.R8:t.gl.RGBA,{useMipmap:e.sampler.mipmaps}),e.uploaded=!0,e.image=null)}function CP(e,t,r){e.indexBuffer=t.createIndexBuffer(e.indexArray,!1,!0),e.vertexBuffer=t.createVertexBuffer(e.vertexArray,_P.members,!1,!0),e.normalArray&&(e.normalBuffer=t.createVertexBuffer(e.normalArray,bP.members,!1,!0)),e.texcoordArray&&(e.texcoordBuffer=t.createVertexBuffer(e.texcoordArray,xP.members,!1,!0)),e.colorArray&&(e.colorBuffer=t.createVertexBuffer(e.colorArray,(e.colorArray.bytesPerElement===12?yP:vP).members,!1,!0)),e.featureArray&&(e.pbrBuffer=t.createVertexBuffer(e.featureArray,wP.members,!0)),e.segments=mr.simpleSegment(0,0,e.vertexArray.length,e.indexArray.length);const n=e.material;n.pbrMetallicRoughness.baseColorTexture&&Nh(n.pbrMetallicRoughness.baseColorTexture,t),n.pbrMetallicRoughness.metallicRoughnessTexture&&Nh(n.pbrMetallicRoughness.metallicRoughnessTexture,t),n.normalTexture&&Nh(n.normalTexture,t),n.occlusionTexture&&Nh(n.occlusionTexture,t,r),n.emissionTexture&&Nh(n.emissionTexture,t)}function ry(e,t,r){if(e.meshes)for(const n of e.meshes)CP(n,t,r);if(e.children)for(const n of e.children)ry(n,t,r)}function ud(e){if(e.meshes)for(const t of e.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(e.children)for(const t of e.children)ud(t)}function cd(e){if(e.meshes)for(const r of e.meshes)r.vertexBuffer&&(r.vertexBuffer.destroy(),r.indexBuffer.destroy(),r.normalBuffer&&r.normalBuffer.destroy(),r.texcoordBuffer&&r.texcoordBuffer.destroy(),r.colorBuffer&&r.colorBuffer.destroy(),r.pbrBuffer&&r.pbrBuffer.destroy(),r.segments.destroy(),r.material&&((t=r.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(e.children)for(const r of e.children)cd(r)}class Bw{constructor(t,r){this.feature=t,this.instancedDataOffset=r,this.instancedDataCount=0}}class Vw{constructor(){this.instancedDataArray=new Bg,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Uw{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.projection=t.projection,this.index=t.index,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0}populate(t,r,n,i){this.tileToMeter=yh(n);const s=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:a,id:l,index:p,sourceLayerIndex:f}of t){const m=tl(a,s);if(!this.layers[0]._featureFilter.filter(new jr(this.zoom),m,n))continue;const _={id:l,sourceLayerIndex:f,index:p,geometry:s?m.geometry:zs(a,n,i),properties:a.properties,type:a.type,patterns:{}},y=this.addFeature(_,_.geometry,m);y&&r.featureIndex.insert(a,_.geometry,p,f,this.index,this.instancesPerModel[y].instancedDataArray.length)}this.lookup=null}update(t,r,n,i){for(const s in this.instancesPerModel){const a=this.instancesPerModel[s];for(const l in t)a.idToFeaturesIndex.hasOwnProperty(l)&&this.evaluate(a.features[a.idToFeaturesIndex[l]],t[l],a,!0)}this.maxHeight=0}isEmpty(){for(const t in this.instancesPerModel)if(this.instancesPerModel[t].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(t){const r=Number.MAX_SAFE_INTEGER;if(!this.uploaded)for(const n in this.instancesPerModel){const i=this.instancesPerModel[n];i.instancedDataArray.length<r||i.instancedDataArray.length===0||(i.instancedDataBuffer?i.instancedDataBuffer.updateData(i.instancedDataArray):i.instancedDataBuffer=t.createVertexBuffer(i.instancedDataArray,i.instancedDataArray.members,!0))}this.uploaded=!0}destroy(){for(const t in this.instancesPerModel){const r=this.instancesPerModel[t];r.instancedDataArray.length!==0&&r.instancedDataBuffer&&r.instancedDataBuffer.destroy()}}addFeature(t,r,n){const i=this.layers[0],s=i.layout.get("model-id").evaluate(n,{},this.canonical);if(!s)return Y(`modelId is not evaluated for layer ${i.id} and it is not going to get rendered.`),s;this.instancesPerModel[s]||(this.instancesPerModel[s]=new Vw);const a=this.instancesPerModel[s],l=a.instancedDataArray,p=new Bw(n,l.length);for(const f of r)for(const m of f){if(m.x<0||m.x>=lt||m.y<0||m.y>=lt)continue;const _=(this.lookupDim-1)/lt,y=this.lookupDim*(m.y*_|0)+m.x*_|0;if(this.lookup){if(this.lookup[y]!==0)continue;this.lookup[y]=1}this.instanceCount++;const v=l.length;l.resize(v+1),a.instancesEvaluatedElevation.push(0),l.float32[16*v]=m.x,l.float32[16*v+1]=m.y}return p.instancedDataCount=a.instancedDataArray.length-p.instancedDataOffset,p.instancedDataCount>0&&(t.id&&(a.idToFeaturesIndex[t.id]=a.features.length),a.features.push(p),this.evaluate(p,{},a,!1)),s}evaluate(t,r,n,i){const s=this.layers[0],a=t.feature,l=this.canonical,p=s.paint.get("model-rotation").evaluate(a,r,l),f=s.paint.get("model-scale").evaluate(a,r,l),m=s.paint.get("model-translation").evaluate(a,r,l),_=s.paint.get("model-color").evaluate(a,r,l);_.a=s.paint.get("model-color-mix-intensity").evaluate(a,r,l);const y=[];this.maxVerticalOffset<m[2]&&(this.maxVerticalOffset=m[2]),this.maxScale=Math.max(Math.max(this.maxScale,f[0]),Math.max(f[1],f[2])),zw(y,p,f);const v=Math.round(100*_.a)+_.b/1.05;for(let b=0;b<t.instancedDataCount;++b){const w=t.instancedDataOffset+b,E=16*w,T=n.instancedDataArray.float32;let C=0;i&&(C=T[E+6]-n.instancesEvaluatedElevation[w]);const M=0|T[E+1];T[E]=(0|T[E])+_.r/1.05,T[E+1]=M+_.g/1.05,T[E+2]=v,T[E+3]=1/(l.z>10?this.tileToMeter:yh(l,M)),T[E+4]=m[0],T[E+5]=m[1],T[E+6]=m[2]+C,T[E+7]=y[0],T[E+8]=y[1],T[E+9]=y[2],T[E+10]=y[4],T[E+11]=y[5],T[E+12]=y[6],T[E+13]=y[8],T[E+14]=y[9],T[E+15]=y[10],n.instancesEvaluatedElevation[w]=m[2]}}}Ut(Uw,"ModelBucket",{omit:["layers"]}),Ut(Vw,"PerModelAttributes"),Ut(Bw,"ModelFeature");const MP=new qr({visibility:new Tt(rt.layout_model.visibility),"model-id":new te(rt.layout_model["model-id"])});var AP={paint:new qr({"model-opacity":new Tt(rt.paint_model["model-opacity"]),"model-rotation":new te(rt.paint_model["model-rotation"]),"model-scale":new te(rt.paint_model["model-scale"]),"model-translation":new te(rt.paint_model["model-translation"]),"model-color":new te(rt.paint_model["model-color"]),"model-color-mix-intensity":new te(rt.paint_model["model-color-mix-intensity"]),"model-type":new Tt(rt.paint_model["model-type"]),"model-cast-shadows":new Tt(rt.paint_model["model-cast-shadows"]),"model-receive-shadows":new Tt(rt.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Tt(rt.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new te(rt.paint_model["model-emissive-strength"]),"model-roughness":new te(rt.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new te(rt.paint_model["model-height-based-emissive-strength-multiplier"])}),layout:MP};function Gw(e){let t=0;if(e.meshes)for(const r of e.meshes)t=Math.max(t,r.aabb.max[2]);if(e.children)for(const r of e.children)t=Math.max(t,Gw(r));return t}const jw=["","wall","door","roof","window","lamp","logo"];class qw{constructor(t){this.node=t,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:t.id,geometry:[],properties:{height:Gw(t)}}}}class Zw{constructor(t,r,n,i){this.nodes=t,this.id=r,this.modelTraits|=1,this.uploaded=!1,this.hasPattern=!1,n&&(this.modelTraits|=4),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=i,this.dirty=!0,this.needsUpload=!1}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(t){if(!this.needsUpload)return;const r=this.getNodesInfo();for(const n of r){const i=n.node;this.uploaded?this.updatePbrBuffer(i):ry(i,t,!0)}for(const n of r)ud(n.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(t){let r=!1;if(!t.meshes)return r;for(const n of t.meshes)n.pbrBuffer&&(n.pbrBuffer.updateData(n.featureArray),r=!0);return r}needsReEvaluation(t,r,n){const i=t.transform.projectionOptions,s=t.style.calculateLightsBrightness(),a=this.brightness!==s;return!!(!this.uploaded||this.dirty||i.name!==this.projection.name||hd(n.paint.get("model-color-mix-intensity").value,a)||hd(n.paint.get("model-roughness").value,a)||hd(n.paint.get("model-emissive-strength").value,a)||hd(n.paint.get("model-height-based-emissive-strength-multiplier").value,a))&&(this.dirty=!1,this.projection=i,this.brightness=s,!0)}evaluateScale(t,r){if(t.transform.zoom===this.zoom)return;this.zoom=t.transform.zoom;const n=this.getNodesInfo(),i=this.id.canonical;for(const s of n){const a=s.feature;s.evaluatedScale=r.paint.get("model-scale").evaluate(a,{},i)}}evaluate(t){const r=this.getNodesInfo();for(const n of r){if(!n.node.meshes)continue;const i=n.feature,s=n.evaluatedColor[2],a=n.evaluatedRMEA[2],l=this.id.canonical;if(n.node.meshes&&n.node.meshes[0].featureData){for(let p=0;p<jw.length;p++){const f=jw[p];f.length&&(i.properties.part=f);const m=t.paint.get("model-color").evaluate(i,{},l),_=t.paint.get("model-color-mix-intensity").evaluate(i,{},l);n.evaluatedColor[p]=[m.r,m.g,m.b,_],n.evaluatedRMEA[p][0]=t.paint.get("model-roughness").evaluate(i,{},l),n.evaluatedRMEA[p][2]=t.paint.get("model-emissive-strength").evaluate(i,{},l),n.evaluatedRMEA[p][3]=m.a,n.emissionHeightBasedParams[p]=t.paint.get("model-height-based-emissive-strength-multiplier").evaluate(i,{},l)}delete i.properties.part,LP(n,s!==n.evaluatedColor[2]||a!==n.evaluatedRMEA[2])}n.evaluatedScale=t.paint.get("model-scale").evaluate(i,{},l),this.updatePbrBuffer(n.node)||(this.needsUpload=!0)}}elevationUpdate(t,r,n){const i=t.findDEMTileFor(n);if((i!==this.terrainTile||r!==this.terrainExaggeration)&&t&&i&&i.dem&&i.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=i.tileID.overscaledZ;const s=Ku.create(t,this.id,i);if(!s)return;for(const a of this.getNodesInfo()){const l=a.node;if(!l.footprint||!l.footprint.vertices||!l.footprint.vertices.length)continue;const p=l.footprint.vertices;let f=s.getElevationAt(p[0].x,p[0].y,!0,!0);for(let m=1;m<p.length;m++)f=Math.min(f,s.getElevationAt(p[m].x,p[m].y,!0,!0));l.elevation=f}}}getNodesInfo(){if(!this.nodesInfo){this.nodesInfo=[];for(const t of this.nodes)this.nodesInfo.push(new qw(t));this.freeNodes()}return this.nodesInfo}freeNodes(){if(this.nodes){for(const t of this.nodes)cd(t);this.nodes.splice(0,this.nodes.length)}}destroy(){this.freeNodes();const t=this.getNodesInfo();for(const r of t)ud(r.node),cd(r.node)}isEmpty(){return!this.nodes.length}updateReplacement(t,r){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const n=r.getReplacementRegionsForTile(t.toUnwrapped()),i=this.getNodesInfo();for(let s=0;s<this.nodesInfo.length;s++){const a=i[s].node;i[s].hiddenByReplacement=!!a.footprint&&!n.find(l=>l.footprint===a.footprint)}}}function hd(e,t){return!e.isLightConstant&&t}function PP(e,t,r,n,i,s,a,l){let p=(61440&t|(61440&t)>>4)>>8,f=(3840&t|(3840&t)>>4)>>4,m=240&t|(240&t)>>4;r[3]>0&&(p=ce(p,255*r[0],r[3]),f=ce(f,255*r[1],r[3]),m=ce(m,255*r[2],r[3]));const _=p<<8|f,y=m<<8|Math.floor(255*n[3]),v=function(L){const R=Bt(L,0,2);return Math.min(Math.round(.5*R*255),255)}(n[2])<<8|15*n[0]<<4|15*n[1],b=Bt(i[0],0,1),w=Bt(i[1],0,1),E=Bt(i[2],0,1),T=Bt(i[3],0,1);let C,M,A,P;if(b!==w&&a!==s&&w!==b){const L=a-s;M=1/(L*(w-b)),A=-(s+L*b)/(L*(w-b));const R=Bt(i[4],-1,1);P=Math.pow(10,R),C=255*E<<8|255*T}else C=65535,M=0,A=1,P=1;if(e.emplaceBack(_,y,v,C,M,A,P),l){const L=l.length;l.clear();for(let R=0;R<L;R++)l.emplaceBack(_,y,v,C,M,A,P)}}function LP(e,t){const r=e.node;let n=0;for(const i of r.meshes){if(r.lights&&r.lightMeshIndex===n||!i.featureData)continue;i.featureArray=new pf,i.featureArray.reserve(i.featureData.length);let s=t;for(const a of i.featureData){let l;const p=65535&a,f=(15&p)<8?15&p:0,m=a>>16&65535,_=e.evaluatedRMEA[f],y=e.evaluatedColor[f],v=e.emissionHeightBasedParams[f];if(s&&f===2&&r.lights&&(l=new pf,l.resize(10*r.lights.length)),PP(i.featureArray,m,y,_,v,i.aabb.min[2],i.aabb.max[2],l),l&&s){s=!1;const b=r.meshes[r.lightMeshIndex];b.featureArray=l,b.featureArray._trim()}}i.featureArray._trim(),n++}}Ut(Zw,"Tiled3dModelBucket",{omit:["layers"]}),Ut(qw,"Tiled3dModelFeature");class DP{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(t){const r=Hw(new H(0,0),new H(lt,lt),t),n=[];for(const i of this._activeRegions){if(i.hiddenByOverlap||!Ww(r,i))continue;const s=RP(i.min,i.max,t);n.push({min:s.min,max:s.max,sourceId:this._sourceIds[i.priority],footprint:i.footprint,footprintTileId:i.tileId})}return n}setSources(t){this._setSources(t.map(r=>({getSourceId:()=>r.cache.id,getFootprints:()=>{const n=[];for(const i of r.cache.getVisibleCoordinates()){const s=r.cache.getTile(i).buckets[r.layer];if(s)for(const a of s.getNodesInfo()){const l=a.node;l.footprint&&n.push({footprint:l.footprint,id:i.toUnwrapped()})}}return n}})))}_addSource(t){const r=t.getFootprints();if(r.length!==0){for(const n of r){if(!n.footprint)continue;const i=Hw(n.footprint.min,n.footprint.max,n.id);this._activeRegions.push({min:i.min,max:i.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:n.id,footprint:n.footprint})}this._sourceIds.push(t.getSourceId())}}_computeReplacement(){this._activeRegions.sort((r,n)=>r.priority-n.priority||pd(r.min,n.min)||pd(r.max,n.max));let t=this._activeRegions.length!==this._prevRegions.length;if(!t){let r=0,n=0;for(;!t&&r!==this._activeRegions.length;){const i=this._activeRegions[r],s=this._prevRegions[n];t=i.priority!==s.priority||!Xw(i,s),++r,++n}}if(t){++this._updateTime;const r=n=>{const i=this._activeRegions;if(n>=i.length)return n;const s=i[n].priority;for(;n<i.length&&i[n].priority===s;)++n;return n};if(this._sourceIds.length>1){let n=0,i=r(n);for(;n!==i;){let s=n;const a=n;for(;s!==i;){const l=this._activeRegions[s];l.hiddenByOverlap=!1;for(let p=0;p<a;p++){const f=this._activeRegions[p];if(!f.hiddenByOverlap&&Ww(l,f)&&(l.hiddenByOverlap=$w(l.footprint,l.tileId,f.footprint,f.tileId),l.hiddenByOverlap))break}++s}n=i,i=r(n)}}}}_setSources(t){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let r=t.length-1;r>=0;r--)this._addSource(t[r]);this._computeReplacement()}}function pd(e,t){return e.x-t.x||e.y-t.y}function Xw(e,t){return pd(e.min,t.min)===0&&pd(e.max,t.max)===0}function Ww(e,t){return!(e.min.x>t.max.x||e.max.x<t.min.x||e.min.y>t.max.y||e.max.y<t.min.y)}function Hw(e,t,r){const n=1/lt,i=1/(1<<r.canonical.z),s=(t.x*n+r.canonical.x)*i+r.wrap,a=(t.y*n+r.canonical.y)*i;return{min:new H((e.x*n+r.canonical.x)*i+r.wrap,(e.y*n+r.canonical.y)*i),max:new H(s,a)}}function RP(e,t,r){const n=1<<r.canonical.z,i=((t.x-r.wrap)*n-r.canonical.x)*lt,s=(t.y*n-r.canonical.y)*lt;return{min:new H(((e.x-r.wrap)*n-r.canonical.x)*lt,(e.y*n-r.canonical.y)*lt),max:new H(i,s)}}function Yw(e,t,r,n,i,s,a){const l=e.indices,p=e.vertices,f=[];for(let m=n;m<n+i;m+=3){const _=t[r[m+0]+s],y=t[r[m+1]+s],v=t[r[m+2]+s],b=Math.min(_.x,y.x,v.x),w=Math.max(_.x,y.x,v.x),E=Math.min(_.y,y.y,v.y),T=Math.max(_.y,y.y,v.y);f.length=0,e.grid.query(new H(b,E),new H(w,T),f);for(let C=0;C<f.length;C++){const M=f[C];if(T_(p[l[3*M+0]],p[l[3*M+1]],p[l[3*M+2]],_,y,v,a))return!0}}return!1}function $w(e,t,r,n){if(!e||!r)return!1;let i=e.vertices;if(!t.canonical.equals(n.canonical)||t.wrap!==n.wrap){if(r.vertices.length<e.vertices.length)return $w(r,n,e,t);const s=t.canonical,a=n.canonical,l=Math.pow(2,a.z-s.z);i=e.vertices.map(p=>new H(p.x*s.x*lt*l-a.x*lt,p.y*s.y*lt*l-a.y*lt))}return Yw(r,i,e.indices,0,e.indices.length,0,0)}const OP=zf.types,NP=Math.pow(2,13),Kw=new H(0,1),cl=2147483648;function zh(e,t,r,n,i,s,a,l){e.emplaceBack((t<<1)+a,(r<<1)+s,(Math.floor(n*NP)<<1)+i,Math.round(l))}function fd(e,t,r,n,i){e.emplaceBack(t.x,t.y,(r.x<<1)+n,(r.y<<1)+i)}function kh(e,t,r){e.emplaceBack(t.x,t.y,t.z,r[0]*16384,r[1]*16384,r[2]*16384)}class Jw{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Qw{constructor(){this.centroidXY=new H(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.min=new H(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new H(-Number.MAX_VALUE,-Number.MAX_VALUE)}span(){return new H(this.max.x-this.min.x,this.max.y-this.min.y)}}class tE{constructor(){this.acc=new H(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(t,r){t.min.x===Number.MAX_VALUE&&(t.min.x=t.max.x=r.x,t.min.y=t.max.y=r.y)}appendEdge(t,r,n){this.accCount++,this.acc._add(r);let i=!!this.borders;r.x<t.min.x?(t.min.x=r.x,i=!0):r.x>t.max.x&&(t.max.x=r.x,i=!0),r.y<t.min.y?(t.min.y=r.y,i=!0):r.y>t.max.y&&(t.max.y=r.y,i=!0),((r.x===0||r.x===lt)&&r.x===n.x)!=((r.y===0||r.y===lt)&&r.y===n.y)&&this.processBorderOverlap(r,n),i&&this.checkBorderIntersection(r,n)}checkBorderIntersection(t,r){r.x<0!=t.x<0&&this.addBorderIntersection(0,ce(r.y,t.y,(0-r.x)/(t.x-r.x))),r.x>lt!=t.x>lt&&this.addBorderIntersection(1,ce(r.y,t.y,(lt-r.x)/(t.x-r.x))),r.y<0!=t.y<0&&this.addBorderIntersection(2,ce(r.x,t.x,(0-r.y)/(t.y-r.y))),r.y>lt!=t.y>lt&&this.addBorderIntersection(3,ce(r.x,t.x,(lt-r.y)/(t.y-r.y)))}addBorderIntersection(t,r){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const n=this.borders[t];r<n[0]&&(n[0]=r),r>n[1]&&(n[1]=r)}processBorderOverlap(t,r){if(t.x===r.x){if(t.y===r.y)return;const n=t.x===0?0:1;this.addBorderIntersection(n,r.y),this.addBorderIntersection(n,t.y)}else{const n=t.y===0?2:3;this.addBorderIntersection(n,r.x),this.addBorderIntersection(n,t.x)}}centroid(){return this.accCount===0?new H(0,0):new H(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((t,r)=>t+ +(r[0]!==Number.MAX_VALUE),0):0}}class eE{constructor(t){this.vertexArray=new Ua,this.indexArray=new xn,this.programConfigurations=new Ha(t.layers,t.zoom),this.segments=new mr,this.hiddenByLandmarkVertexArray=new Vg}hasData(){return this.vertexArray.length!==0}addData(t,r){const n=t.length;if(n>2){const i=this.segments.prepareSegment(4*n,this.vertexArray,this.indexArray);for(let s=0;s<n;s++){const a=t[s],l=t[s===n-1?0:s+1];if(ny(a,l,r)||iE(a,r)&&iE(l,r))continue;const p=i.vertexLength;fd(this.vertexArray,a,l,1,1),fd(this.vertexArray,a,l,1,0),fd(this.vertexArray,a,l,0,1),fd(this.vertexArray,a,l,0,0),i.vertexLength+=4,this.indexArray.emplaceBack(p,p+1,p+3),this.indexArray.emplaceBack(p,p+3,p+2),i.primitiveLength+=2}}}addPaintPropertiesData(t,r,n,i,s,a){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,t,r,n,i,s,a)}upload(t){this.hasData()&&(this.vertexBuffer=t.createVertexBuffer(this.vertexArray,dM.members),this.indexBuffer=t.createIndexBuffer(this.indexArray))}uploadPaintProperties(t){this.hasData()&&this.programConfigurations.upload(t)}update(t,r,n,i,s,a){this.hasData()&&this.programConfigurations.updatePaintArrays(t,r,n,i,s,a)}updateHiddenByLandmark(t){if(!this.hasData())return;const r=t.groundVertexCount+t.groundVertexArrayOffset;if(t.groundVertexCount===0)return;const n=t.flags&cl?1:0;for(let i=t.groundVertexArrayOffset;i<r;++i)this.hiddenByLandmarkVertexArray.emplace(i,n);this.needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(t){this.hasData()&&this.needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=t.createVertexBuffer(this.hiddenByLandmarkVertexArray,gM.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this.needsHiddenByLandmarkUpdate=!1)}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.segments.destroy(),this.programConfigurations.destroy())}}class Fh{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new xn,this.footprintVertices=new $i,this.footprintSegments=[],this.layoutVertexArray=new Ua,this.centroidVertexArray=new mx,this.indexArray=new xn,this.programConfigurations=new Ha(t.layers,t.zoom),this.segments=new mr,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.groundEffect=new eE(t)}populate(t,r,n,i){this.features=[],this.hasPattern=L_("fill-extrusion",this.layers,r),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=yh(n),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:s,id:a,index:l,sourceLayerIndex:p}of t){const f=this.layers[0]._featureFilter.needGeometry,m=tl(s,f);if(!this.layers[0]._featureFilter.filter(new jr(this.zoom),m,n))continue;const _={id:a,sourceLayerIndex:p,index:l,geometry:f?m.geometry:zs(s,n,i),properties:s.properties,type:s.type,patterns:{}},y=this.layoutVertexArray.length;this.hasPattern?this.features.push(D_("fill-extrusion",this.layers,_,this.zoom,r)):this.addFeature(_,_.geometry,l,n,{},r.availableImages,i,r.brightness),r.featureIndex.insert(s,_.geometry,l,p,this.index,y)}this.sortBorders()}addFeatures(t,r,n,i,s,a){for(const l of this.features){const{geometry:p}=l;this.addFeature(l,p,l.index,r,n,i,s,a)}this.sortBorders()}update(t,r,n,i,s){const a=Object.keys(t).length!==0;if(a&&!this.stateDependentLayers.length)return;const l=a?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(t,r,l,n,i,s),this.groundEffect.update(t,r,l,n,i,s)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,yM),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,_M.members,!0)),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.groundEffect.uploadHiddenByLandmark(t),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,mM.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,r,n,i,s,a,l,p){const f=[new H(0,0),new H(lt,lt)],m=l.projection,_=m.name==="globe",y=OP[t.type]==="Polygon",v=new tE;v.centroidDataIndex=this.centroidData.length;const b=new Qw;b.vertexArrayOffset=this.layoutVertexArray.length,b.groundVertexArrayOffset=this.groundEffect.vertexArray.length,_&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new uf);const w=P_(r,500);for(let M=w.length-1;M>=0;M--){const A=w[M];(A.length===0||(E=A[0]).every(P=>P.x<=0)||E.every(P=>P.x>=lt)||E.every(P=>P.y<=0)||E.every(P=>P.y>=lt))&&w.splice(M,1)}var E;let T;if(_)T=lE(w,f,i);else{T=[];for(const M of w)T.push({polygon:M,bounds:f})}const C=y?this.edgeRadius:0;for(const{polygon:M,bounds:A}of T){let P=0,L=0;for(const k of M)y&&!k[0].equals(k[k.length-1])&&k.push(k[0]),L+=y?k.length-1:k.length;const R=this.segments.prepareSegment((y?5:4)*L,this.layoutVertexArray,this.indexArray);b.footprintSegIdx<0&&(b.footprintSegIdx=this.footprintSegments.length);const N=new Jw;if(N.vertexOffset=this.footprintVertices.length,N.indexOffset=3*this.footprintIndices.length,y){const k=[],F=[];P=R.vertexLength;for(let U=0;U<M.length;U++){const G=M[U];G.length&&U!==0&&F.push(k.length/2);const V=[];let K,$;K=G[1].sub(G[0])._perp()._unit();for(let tt=1;tt<G.length;tt++){const X=G[tt],J=G[tt===G.length-1?1:tt+1];let{x:nt,y:at}=X;if(C===0&&V.push(X),C){$=J.sub(X)._perp()._unit();const ot=K.add($)._unit(),It=C*Math.min(4,1/(K.x*ot.x+K.y*ot.y));nt+=It*ot.x,at+=It*ot.y,K=$}zh(this.layoutVertexArray,nt,at,0,0,1,1,0),R.vertexLength++,this.footprintVertices.emplaceBack(X.x,X.y),k.push(X.x,X.y),_&&kh(this.layoutVertexExtArray,m.projectTilePoint(nt,at,i),m.upVector(i,nt,at))}C===0&&this.groundEffect.addData(V,A)}const z=Rf(k,F);for(let U=0;U<z.length;U+=3)this.footprintIndices.emplaceBack(N.vertexOffset+z[U+0],N.vertexOffset+z[U+1],N.vertexOffset+z[U+2]),this.indexArray.emplaceBack(P+z[U],P+z[U+2],P+z[U+1]),R.primitiveLength++;N.indexCount+=z.length,N.vertexCount+=this.footprintVertices.length-N.vertexOffset}for(let k=0;k<M.length;k++){const F=M[k];v.startRing(b,F[0]);let z=F.length>4&&oE(F[F.length-2],F[0],F[1]),U=C?zP(F[F.length-2],F[0],F[1],C):0;const G=[];let V,K,$;K=F[1].sub(F[0])._perp()._unit();let tt=!0;for(let X=1,J=0;X<F.length;X++){let nt=F[X-1],at=F[X];const ot=F[X===F.length-1?1:X+1];if(v.appendEdge(b,at,nt),ny(at,nt,A)){C&&(K=ot.sub(at)._perp()._unit(),tt=!tt);continue}const It=at.sub(nt)._perp(),xt=It.x/(Math.abs(It.x)+Math.abs(It.y)),dt=It.y>0?1:0,yt=nt.dist(at);if(J+yt>32768&&(J=0),C){$=ot.sub(at)._perp()._unit();let Gt=nE(nt,at,ot,rE(K,$),C);isNaN(Gt)&&(Gt=0);const Qt=at.sub(nt)._unit();nt=nt.add(Qt.mult(U))._round(),at=at.add(Qt.mult(-Gt))._round(),U=Gt,K=$,G.push(nt),G.push(at)}const Ot=R.vertexLength,Jt=F.length>4&&oE(nt,at,ot);let Zt=sE(J,z,tt);if(zh(this.layoutVertexArray,nt.x,nt.y,xt,dt,0,0,Zt),zh(this.layoutVertexArray,nt.x,nt.y,xt,dt,0,1,Zt),J+=yt,Zt=sE(J,Jt,!tt),z=Jt,zh(this.layoutVertexArray,at.x,at.y,xt,dt,0,0,Zt),zh(this.layoutVertexArray,at.x,at.y,xt,dt,0,1,Zt),R.vertexLength+=4,this.indexArray.emplaceBack(Ot+0,Ot+1,Ot+2),this.indexArray.emplaceBack(Ot+1,Ot+3,Ot+2),R.primitiveLength+=2,C){const Gt=P+(X===1?F.length-2:X-2),Qt=X===1?P:Gt+1;if(this.indexArray.emplaceBack(Ot+1,Gt,Ot+3),this.indexArray.emplaceBack(Gt,Qt,Ot+3),R.primitiveLength+=2,V===void 0&&(V=Ot),!ny(ot,F[X],A)){const Re=X===F.length-1?V:R.vertexLength;this.indexArray.emplaceBack(Ot+2,Ot+3,Re),this.indexArray.emplaceBack(Ot+3,Re+1,Re),this.indexArray.emplaceBack(Ot+3,Qt,Re+1),R.primitiveLength+=3}tt=!tt}if(_){const Gt=this.layoutVertexExtArray,Qt=m.projectTilePoint(nt.x,nt.y,i),Re=m.projectTilePoint(at.x,at.y,i),Le=m.upVector(i,nt.x,nt.y),er=m.upVector(i,at.x,at.y);kh(Gt,Qt,Le),kh(Gt,Qt,Le),kh(Gt,Re,er),kh(Gt,Re,er)}}y&&(P+=F.length-1),C&&this.groundEffect.addData(G,A)}this.footprintSegments.push(N),++b.footprintSegLen}if(b.vertexCount=this.layoutVertexArray.length-b.vertexArrayOffset,b.groundVertexCount=this.groundEffect.vertexArray.length-b.groundVertexArrayOffset,b.vertexCount!==0){if(b.centroidXY=v.borders?Kw:this.encodeCentroid(v,b),this.centroidData.push(b),v.borders){this.featuresOnBorder.push(v);const M=this.featuresOnBorder.length-1;for(let A=0;A<v.borders.length;A++)v.borders[A][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[A].push(M)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,s,a,i,p),this.groundEffect.addPaintPropertiesData(t,n,s,a,i,p)}}sortBorders(){for(let t=0;t<this.borderFeatureIndices.length;t++)this.borderFeatureIndices[t].sort((r,n)=>this.featuresOnBorder[r].borders[t][0]-this.featuresOnBorder[n].borders[t][0])}encodeCentroid(t,r){const n=t.centroid(),i=r.span(),s=Math.min(7,Math.round(i.x*this.tileToMeter/10)),a=Math.min(7,Math.round(i.y*this.tileToMeter/10));return new H(Bt(n.x,1,lt-1)<<3|s,Bt(n.y,1,lt-1)<<3|a)}showCentroid(t){const r=this.centroidData[t.centroidDataIndex];r.flags&=cl,r.centroidXY.x=0,r.centroidXY.y=0,this.writeCentroidToBuffer(r)}writeCentroidToBuffer(t){this.groundEffect.updateHiddenByLandmark(t);const r=t.vertexArrayOffset,n=t.vertexCount+t.vertexArrayOffset,i=t.flags&cl?Kw:t.centroidXY,s=this.centroidVertexArray.geta_centroid_pos0(r);if(this.centroidVertexArray.geta_centroid_pos1(r)!==i.y||s!==i.x){for(let a=r;a<n;++a)this.centroidVertexArray.emplace(a,i.x,i.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of this.centroidData)this.writeCentroidToBuffer(t)}updateReplacement(t,r){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const n=r.getReplacementRegionsForTile(t.toUnwrapped());if(function(s,a){if(s.length!==a.length)return!1;for(let l=0;l<s.length;l++)if(s[l].sourceId!==a[l].sourceId||!Xw(s[l],a[l]))return!1;return!0}(this.activeReplacements,n))return;if(this.activeReplacements=n,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const s of this.centroidData)s.flags&=2147483647;const i=[];for(const s of this.activeReplacements){const a=Math.pow(2,s.footprintTileId.canonical.z-t.canonical.z);for(const l of this.centroidData)if(!(l.flags&cl||s.min.x>l.max.x||l.min.x>s.max.x||s.min.y>l.max.y||l.min.y>s.max.y))for(let p=0;p<l.footprintSegLen;p++){const f=this.footprintSegments[l.footprintSegIdx+p];if(i.length=0,kP(this.footprintVertices,f.vertexOffset,f.vertexCount,s.footprintTileId.canonical,t.canonical,i),Yw(s.footprint,i,this.footprintIndices.uint16,f.indexOffset,f.indexCount,-f.vertexOffset,-a)){l.flags|=cl;break}}}for(const s of this.centroidData)this.writeCentroidToBuffer(s);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}}function rE(e,t){const r=e.add(t)._unit();return e.x*r.x+e.y*r.y}function zP(e,t,r,n){const i=t.sub(e)._perp()._unit(),s=r.sub(t)._perp()._unit();return nE(e,t,r,rE(i,s),n)}function nE(e,t,r,n,i){const s=Math.sqrt(1-n*n);return Math.min(e.dist(t)/3,t.dist(r)/3,i*s/n)}function ny(e,t,r){return e.x<r[0].x&&t.x<r[0].x||e.x>r[1].x&&t.x>r[1].x||e.y<r[0].y&&t.y<r[0].y||e.y>r[1].y&&t.y>r[1].y}function iE(e,t){return e.x<t[0].x||e.x>t[1].x||e.y<t[0].y||e.y>t[1].y}function oE(e,t,r){if(e.x<0||e.x>=lt||t.x<0||t.x>=lt||r.x<0||r.x>=lt)return!1;const n=r.sub(t),i=n.perp(),s=e.sub(t);return(n.x*s.x+n.y*s.y)/Math.sqrt((n.x*n.x+n.y*n.y)*(s.x*s.x+s.y*s.y))>-.866&&i.x*s.x+i.y*s.y<0}function sE(e,t,r){const n=t?2|e:-3&e;return r?1|n:-2&n}function aE(){const e=Math.PI/32,t=Math.tan(e),r=ju;return r*Math.sqrt(1+2*t*t)-r}function lE(e,t,r){const n=1<<r.z,i=Ji(r.x/n),s=Ji((r.x+1)/n),a=fn(r.y/n),l=fn((r.y+1)/n);return function(p,f,m,_,y=0,v){const b=[];if(!p.length||!m||!_)return b;const w=(L,R)=>{for(const N of L)b.push({polygon:N,bounds:R})},E=Math.ceil(Math.log2(m)),T=Math.ceil(Math.log2(_)),C=E-T,M=[];for(let L=0;L<Math.abs(C);L++)M.push(C>0?0:1);for(let L=0;L<Math.min(E,T);L++)M.push(0),M.push(1);let A=p;if(A=kf(A,f[0].y-y,f[1].y+y,1),A=kf(A,f[0].x-y,f[1].x+y,0),!A.length)return b;const P=[];for(M.length?P.push({polygons:A,bounds:f,depth:0}):w(A,f);P.length;){const L=P.pop(),R=L.depth,N=M[R],k=L.bounds[0],F=L.bounds[1],z=N===0?k.x:k.y,U=N===0?F.x:F.y,G=v?v(N,z,U):.5*(z+U),V=kf(L.polygons,z-y,G+y,N),K=kf(L.polygons,G-y,U+y,N);if(V.length){const $=[k,new H(N===0?G:F.x,N===1?G:F.y)];M.length>R+1?P.push({polygons:V,bounds:$,depth:R+1}):w(V,$)}if(K.length){const $=[new H(N===0?G:k.x,N===1?G:k.y),F];M.length>R+1?P.push({polygons:K,bounds:$,depth:R+1}):w(K,$)}}return b}(e,t,Math.ceil((s-i)/11.25),Math.ceil((a-l)/11.25),1,(p,f,m)=>{if(p===0)return .5*(f+m);{const _=fn((r.y+f/lt)/n);return(ri(.5*(fn((r.y+m/lt)/n)+_))*n-r.y)*lt}})}function kP(e,t,r,n,i,s){const a=Math.pow(2,n.z-i.z);for(let l=0;l<r;l++){let p=e.int16[2*(l+t)+0],f=e.int16[2*(l+t)+1];p=(p+i.x*lt)*a-n.x*lt,f=(f+i.y*lt)*a-n.y*lt,s.push(new H(p,f))}}Ut(Fh,"FillExtrusionBucket",{omit:["layers","features"]}),Ut(Qw,"PartData"),Ut(Jw,"FootprintSegment"),Ut(tE,"BorderCentroidData"),Ut(eE,"GroundEffect");const FP=new qr({visibility:new Tt(rt["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Tt(rt["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var BP={paint:new qr({"fill-extrusion-opacity":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new te(rt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new te(rt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new te(rt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new te(rt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new te(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new te(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Tt(rt["paint_fill-extrusion"]["fill-extrusion-rounded-roof"])}),layout:FP};class ac extends H{constructor(t,r,n){super(t,r),this.z=n}}function Bh(e,t){return e.x*t.x+e.y*t.y}function uE(e,t){if(e.length===1){let r=0;const n=t[r++];let i;for(;!i||n.equals(i);)if(i=t[r++],!i)return 1/0;for(;r<t.length;r++){const s=t[r],a=e[0],l=i.sub(n),p=s.sub(n),f=a.sub(n),m=Bh(l,l),_=Bh(l,p),y=Bh(p,p),v=Bh(f,l),b=Bh(f,p),w=m*y-_*_,E=(y*v-_*b)/w,T=(m*b-_*v)/w,C=n.z*(1-E-T)+i.z*E+s.z*T;if(isFinite(C))return C}return 1/0}{let r=1/0;for(const n of t)r=Math.min(r,n.z);return r}}function cE(e,t,r,n,i,s,a,l){const p=a*i.getElevationAt(e,t,!0,!0),f=s[0]!==0,m=f?s[1]===0?a*(s[0]/7-450):a*function(_,y,v){const b=Math.floor(y[0]/8),w=Math.floor(y[1]/8),E=10*(y[0]-8*b),T=10*(y[1]-8*w),C=_.getElevationAt(b,w,!0,!0),M=_.getMeterToDEM(v),A=Math.floor(.5*(E*M-1)),P=Math.floor(.5*(T*M-1)),L=_.tileCoordToPixel(b,w),R=2*A+1,N=2*P+1,k=function(K,$,tt,X,J){return[K.getElevationAtPixel($,tt,!0),K.getElevationAtPixel($+J,tt,!0),K.getElevationAtPixel($,tt+J,!0),K.getElevationAtPixel($+X,tt+J,!0)]}(_,L.x-A,L.y-P,R,N),F=Math.abs(k[0]-k[1]),z=Math.abs(k[2]-k[3]),U=Math.abs(k[0]-k[2])+Math.abs(k[1]-k[3]),G=Math.min(.25,.5*M*(F+z)/R),V=Math.min(.25,.5*M*U/N);return C+Math.max(G*E,V*T)}(i,s,l):p;return{base:p+(r===0)?-1:r,top:f?Math.max(m+n,p+r+2):p+n}}const VP=new qr({"line-cap":new te(rt.layout_line["line-cap"]),"line-join":new te(rt.layout_line["line-join"]),"line-miter-limit":new Tt(rt.layout_line["line-miter-limit"]),"line-round-limit":new Tt(rt.layout_line["line-round-limit"]),"line-sort-key":new te(rt.layout_line["line-sort-key"]),visibility:new Tt(rt.layout_line.visibility)});var hE={paint:new qr({"line-opacity":new te(rt.paint_line["line-opacity"]),"line-color":new te(rt.paint_line["line-color"]),"line-translate":new Tt(rt.paint_line["line-translate"]),"line-translate-anchor":new Tt(rt.paint_line["line-translate-anchor"]),"line-width":new te(rt.paint_line["line-width"]),"line-gap-width":new te(rt.paint_line["line-gap-width"]),"line-offset":new te(rt.paint_line["line-offset"]),"line-blur":new te(rt.paint_line["line-blur"]),"line-dasharray":new te(rt.paint_line["line-dasharray"]),"line-pattern":new te(rt.paint_line["line-pattern"]),"line-gradient":new ch(rt.paint_line["line-gradient"]),"line-trim-offset":new Tt(rt.paint_line["line-trim-offset"]),"line-emissive-strength":new Tt(rt.paint_line["line-emissive-strength"]),"line-border-width":new te(rt.paint_line["line-border-width"]),"line-border-color":new te(rt.paint_line["line-border-color"])}),layout:VP};const pE=new class extends te{possiblyEvaluate(e,t){return t=new jr(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,transition:t.transition}),super.possiblyEvaluate(e,t)}evaluate(e,t,r,n){return t=Yt({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,r,n)}}(hE.paint.properties["line-width"].specification);function fE(e,t){return t>0?t+2*e:e}pE.useIntegerZoom=!0;const UP=new qr({visibility:new Tt(rt.layout_background.visibility)});var GP={paint:new qr({"background-color":new Tt(rt.paint_background["background-color"]),"background-pattern":new Tt(rt.paint_background["background-pattern"]),"background-opacity":new Tt(rt.paint_background["background-opacity"]),"background-emissive-strength":new Tt(rt.paint_background["background-emissive-strength"])}),layout:UP};const jP=new qr({visibility:new Tt(rt.layout_raster.visibility)});var qP={paint:new qr({"raster-opacity":new Tt(rt.paint_raster["raster-opacity"]),"raster-color":new ch(rt.paint_raster["raster-color"]),"raster-color-mix":new Tt(rt.paint_raster["raster-color-mix"]),"raster-color-range":new Tt(rt.paint_raster["raster-color-range"]),"raster-hue-rotate":new Tt(rt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Tt(rt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Tt(rt.paint_raster["raster-brightness-max"]),"raster-saturation":new Tt(rt.paint_raster["raster-saturation"]),"raster-contrast":new Tt(rt.paint_raster["raster-contrast"]),"raster-resampling":new Tt(rt.paint_raster["raster-resampling"]),"raster-fade-duration":new Tt(rt.paint_raster["raster-fade-duration"])}),layout:jP};class ZP extends mo{constructor(t){super(t,{}),this.implementation=t}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isLayerDraped(){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}const XP=new qr({visibility:new Tt(rt.layout_sky.visibility)});var WP={paint:new qr({"sky-type":new Tt(rt.paint_sky["sky-type"]),"sky-atmosphere-sun":new Tt(rt.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Tt(rt.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Tt(rt.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Tt(rt.paint_sky["sky-gradient-radius"]),"sky-gradient":new ch(rt.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Tt(rt.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Tt(rt.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Tt(rt.paint_sky["sky-opacity"])}),layout:XP};function iy(e,t,r){const n=[0,0,1],i=ei.identity([]);return ei.rotateY(i,i,r?-re(e)+Math.PI:re(e)),ei.rotateX(i,i,-re(t)),q.transformQuat(n,n,i),q.normalize(n,n)}var HP={paint:new qr({})};const YP={circle:class extends mo{constructor(e,t){super(e,ZC,t)}createBucket(e){return new b_(e)}queryRadius(e){const t=e;return Zu("circle-radius",this,t)+Zu("circle-stroke-width",this,t)+Cf(this.paint.get("circle-translate"))}queryIntersectsFeature(e,t,r,n,i,s,a,l){const p=ab(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),f=this.paint.get("circle-radius").evaluate(t,r)+this.paint.get("circle-stroke-width").evaluate(t,r);return lb(e,n,s,a,l,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",p,f)}getProgramIds(){return["circle"]}getProgramConfiguration(e){return new Wa(this,e)}},heatmap:class extends mo{createBucket(e){return new cb(e)}constructor(e,t){super(e,$C,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Mf({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(e){return Zu("heatmap-radius",this,e)}queryIntersectsFeature(e,t,r,n,i,s,a,l){const p=this.paint.get("heatmap-radius").evaluate(t,r);return lb(e,n,s,a,l,!0,!0,new H(0,0),p)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(e){return new Wa(this,e)}},hillshade:class extends mo{constructor(e,t){super(e,JC,t)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}},fill:class extends mo{constructor(e,t){super(e,pM,t)}getProgramIds(){const e=this.paint.get("fill-pattern"),t=e&&e.constantOr(1),r=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&r.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),r}getProgramConfiguration(e){return new Wa(this,e)}recalculate(e,t){super.recalculate(e,t);const r=this.paint._values["fill-outline-color"];r.value.kind==="constant"&&r.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new Of(e)}queryRadius(){return Cf(this.paint.get("fill-translate"))}queryIntersectsFeature(e,t,r,n,i,s){return!e.queryGeometry.isAboveHorizon&&rb(sb(e.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),n)}isTileClipped(){return!0}},"fill-extrusion":class extends mo{constructor(e,t){super(e,BP,t)}createBucket(e){return new Fh(e)}queryRadius(){return Cf(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(e){return new Wa(this,e)}queryIntersectsFeature(e,t,r,n,i,s,a,l,p){const f=ab(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),m=this.paint.get("fill-extrusion-height").evaluate(t,r),_=this.paint.get("fill-extrusion-base").evaluate(t,r),y=[0,0],v=l&&s.elevation,b=s.elevation?s.elevation.exaggeration():1,w=e.tile.getBucket(this);if(v&&w instanceof Fh){const A=w.centroidVertexArray,P=p+1;P<A.length&&(y[0]=A.geta_centroid_pos0(P),y[1]=A.geta_centroid_pos1(P))}if(y[0]===0&&y[1]===1)return!1;s.projection.name==="globe"&&(n=lE([n],[new H(0,0),new H(lt,lt)],e.tileID.canonical).map(A=>A.polygon).flat());const E=v?l:null,[T,C]=function(A,P,L,R,N,k,F,z,U,G,V){return A.projection.name==="globe"?function(K,$,tt,X,J,nt,at,ot,It,xt,dt){const yt=[],Ot=[],Jt=K.projection.upVectorScale(dt,K.center.lat,K.worldSize).metersToTile,Zt=[0,0,0,1],Gt=[0,0,0,1],Qt=(Le,er,De,Oe)=>{Le[0]=er,Le[1]=De,Le[2]=Oe,Le[3]=1},Re=aE();tt>0&&(tt+=Re),X+=Re;for(const Le of $){const er=[],De=[];for(const Oe of Le){const ae=Oe.x+J.x,Me=Oe.y+J.y,rr=K.projection.projectTilePoint(ae,Me,dt),Ae=K.projection.upVector(dt,Oe.x,Oe.y);let ar=tt,tn=X;if(at){const en=cE(ae,Me,tt,X,at,ot,It,xt);ar+=en.base,tn+=en.top}tt!==0?Qt(Zt,rr.x+Ae[0]*Jt*ar,rr.y+Ae[1]*Jt*ar,rr.z+Ae[2]*Jt*ar):Qt(Zt,rr.x,rr.y,rr.z),Qt(Gt,rr.x+Ae[0]*Jt*tn,rr.y+Ae[1]*Jt*tn,rr.z+Ae[2]*Jt*tn),q.transformMat4(Zt,Zt,nt),q.transformMat4(Gt,Gt,nt),er.push(new ac(Zt[0],Zt[1],Zt[2])),De.push(new ac(Gt[0],Gt[1],Gt[2]))}yt.push(er),Ot.push(De)}return[yt,Ot]}(A,P,L,R,N,k,F,z,U,G,V):F?function(K,$,tt,X,J,nt,at,ot,It){const xt=[],dt=[],yt=[0,0,0,1];for(const Ot of K){const Jt=[],Zt=[];for(const Gt of Ot){const Qt=Gt.x+X.x,Re=Gt.y+X.y,Le=cE(Qt,Re,$,tt,nt,at,ot,It);yt[0]=Qt,yt[1]=Re,yt[2]=Le.base,yt[3]=1,gr.transformMat4(yt,yt,J),yt[3]=Math.max(yt[3],1e-5);const er=new ac(yt[0]/yt[3],yt[1]/yt[3],yt[2]/yt[3]);yt[0]=Qt,yt[1]=Re,yt[2]=Le.top,yt[3]=1,gr.transformMat4(yt,yt,J),yt[3]=Math.max(yt[3],1e-5);const De=new ac(yt[0]/yt[3],yt[1]/yt[3],yt[2]/yt[3]);Jt.push(er),Zt.push(De)}xt.push(Jt),dt.push(Zt)}return[xt,dt]}(P,L,R,N,k,F,z,U,G):function(K,$,tt,X,J){const nt=[],at=[],ot=J[8]*$,It=J[9]*$,xt=J[10]*$,dt=J[11]*$,yt=J[8]*tt,Ot=J[9]*tt,Jt=J[10]*tt,Zt=J[11]*tt;for(const Gt of K){const Qt=[],Re=[];for(const Le of Gt){const er=Le.x+X.x,De=Le.y+X.y,Oe=J[0]*er+J[4]*De+J[12],ae=J[1]*er+J[5]*De+J[13],Me=J[2]*er+J[6]*De+J[14],rr=J[3]*er+J[7]*De+J[15],Ae=Oe+ot,ar=ae+It,tn=Me+xt,en=Math.max(rr+dt,1e-5),Br=Oe+yt,Mr=ae+Ot,mn=Me+Jt,zr=Math.max(rr+Zt,1e-5);Qt.push(new ac(Ae/en,ar/en,tn/en)),Re.push(new ac(Br/zr,Mr/zr,mn/zr))}nt.push(Qt),at.push(Re)}return[nt,at]}(P,L,R,N,k)}(s,n,_,m,f,a,E,y,b,s.center.lat,e.tileID.canonical),M=e.queryGeometry;return function(A,P,L){let R=1/0;rb(L,P)&&(R=uE(L,P[0]));for(let N=0;N<P.length;N++){const k=P[N],F=A[N];for(let z=0;z<k.length-1;z++){const U=k[z],G=[U,k[z+1],F[z+1],F[z],U];eb(L,G)&&(R=Math.min(R,uE(L,G)))}}return R!==1/0&&R}(T,C,M.isPointQuery()?M.screenBounds:M.screenGeometry)}},line:class extends mo{constructor(e,t){super(e,hE,t),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(e){if(e==="line-gradient"){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof Wm,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=pE.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new rd(e)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(e){return new Wa(this,e)}queryRadius(e){const t=e,r=fE(Zu("line-width",this,t),Zu("line-gap-width",this,t)),n=Zu("line-offset",this,t);return r/2+Math.abs(n)+Cf(this.paint.get("line-translate"))}queryIntersectsFeature(e,t,r,n,i,s){if(e.queryGeometry.isAboveHorizon)return!1;const a=sb(e.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),l=e.pixelToTileUnitsFactor/2*fE(this.paint.get("line-width").evaluate(t,r),this.paint.get("line-gap-width").evaluate(t,r)),p=this.paint.get("line-offset").evaluate(t,r);return p&&(n=function(f,m){const _=[],y=new H(0,0);for(let v=0;v<f.length;v++){const b=f[v],w=[];for(let E=0;E<b.length;E++){const T=b[E],C=b[E+1],M=E===0?y:T.sub(b[E-1])._unit()._perp(),A=E===b.length-1?y:C.sub(T)._unit()._perp(),P=M._add(A)._unit();P._mult(1/(P.x*A.x+P.y*A.y)),w.push(P._mult(m)._add(T))}_.push(w)}return _}(n,p*e.pixelToTileUnitsFactor)),function(f,m,_){for(let y=0;y<m.length;y++){const v=m[y];if(f.length>=3){for(let b=0;b<v.length;b++)if(el(f,v[b]))return!0}if(UC(f,v,_))return!0}return!1}(a,n,l)}isTileClipped(){return!0}},symbol:$f,background:class extends mo{constructor(e,t){super(e,GP,t)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends mo{constructor(e,t){super(e,qP,t),this._updateColorRamp()}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||this._updateColorRamp()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-color"].value.expression,[t,r]=this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0});this.colorRamp=Mf({expression:e,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:t,end:r}]}),this.colorRampTexture=null}},sky:class extends mo{constructor(e,t){super(e,WP,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="sky-gradient"?this._updateColorRamp():e!=="sky-atmosphere-sun"&&e!=="sky-atmosphere-halo-color"&&e!=="sky-atmosphere-color"&&e!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Mf({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(e){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=e.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(e,t){if(this.paint.get("sky-type")==="atmosphere"){const n=this.paint.get("sky-atmosphere-sun"),i=!n,s=e.style.light,a=s.properties.get("position");return i&&s.properties.get("anchor")==="viewport"&&Y("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),i?iy(a.azimuthal,90-a.polar,t):iy(n[0],90-n[1],t)}const r=this.paint.get("sky-gradient-center");return iy(r[0],90-r[1],t)}isSky(){return!0}markSkyboxValid(e){this._skyboxInvalidated=!1,this._lightPosition=e.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const e=this.paint.get("sky-type");return e==="atmosphere"?["skyboxCapture","skybox"]:e==="gradient"?["skyboxGradient"]:null}},slot:class extends mo{constructor(e,t){super(e,HP)}},model:class extends mo{constructor(e,t){super(e,AP,t)}createBucket(e){return new Uw(e)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}hasLightBeamPass(){return!0}queryRadius(){return 0}_handleOverridablePaintPropertyUpdate(e,t,r){return!(!this.layout||t.isDataDriven()||r.isDataDriven()||e!=="model-color"&&e!=="model-color-mix-intensity"&&e!=="model-rotation"&&e!=="model-scale"&&e!=="model-translation"&&e!=="model-emissive-strength")}}};function dd(e,t){return e.type==="custom"?new ZP(e):new YP[e.type](e,t)}function $P(e){const{userImage:t}=e;return!!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0)}class KP extends hn{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(t){this.images[t]={},this.loaded[t]=!1,this.updatedImages[t]={},this.patterns[t]={},this.callbackDispatchedThisFrame[t]={},this.atlasImage[t]=new Yr({width:1,height:1})}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}setLoaded(t,r){if(this.loaded[r]!==t&&(this.loaded[r]=t,t)){for(const{ids:n,callback:i}of this.requestors)this._notify(n,r,i);this.requestors=[]}}hasImage(t,r){return!!this.getImage(t,r)}getImage(t,r){return this.images[r][t]}addImage(t,r,n){this._validate(t,n)&&(this.images[r][t]=n)}_validate(t,r){let n=!0;return this._validateStretch(r.stretchX,r.data&&r.data.width)||(this.fire(new fe(new Error(`Image "${t}" has invalid "stretchX" value`))),n=!1),this._validateStretch(r.stretchY,r.data&&r.data.height)||(this.fire(new fe(new Error(`Image "${t}" has invalid "stretchY" value`))),n=!1),this._validateContent(r.content,r)||(this.fire(new fe(new Error(`Image "${t}" has invalid "content" value`))),n=!1),n}_validateStretch(t,r){if(!t)return!0;let n=0;for(const i of t){if(i[0]<n||i[1]<i[0]||r<i[1])return!1;n=i[1]}return!0}_validateContent(t,r){return!(t&&(t.length!==4||t[0]<0||r.data.width<t[0]||t[1]<0||r.data.height<t[1]||t[2]<0||r.data.width<t[2]||t[3]<0||r.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))}updateImage(t,r,n){n.version=this.images[r][t].version+1,this.images[r][t]=n,this.updatedImages[r][t]=!0}removeImage(t,r){const n=this.images[r][t];delete this.images[r][t],delete this.patterns[r][t],n.userImage&&n.userImage.onRemove&&n.userImage.onRemove()}listImages(t){return Object.keys(this.images[t])}getImages(t,r,n){let i=!0;const s=!!this.loaded[r];if(!s)for(const a of t)this.images[r][a]||(i=!1);s||i?this._notify(t,r,n):this.requestors.push({ids:t,scope:r,callback:n})}getUpdatedImages(t){return this.updatedImages[t]}_notify(t,r,n){const i={};for(const s of t){this.images[r][s]||this.fire(new wt("styleimagemissing",{id:s}));const a=this.images[r][s];a?i[s]={data:a.data.clone(),pixelRatio:a.pixelRatio,sdf:a.sdf,version:a.version,stretchX:a.stretchX,stretchY:a.stretchY,content:a.content,hasRenderCallback:!!(a.userImage&&a.userImage.render)}:Y(`Image "${s}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}n(null,i)}getPixelSize(t){const{width:r,height:n}=this.atlasImage[t];return{width:r,height:n}}getPattern(t,r){const n=this.patterns[r][t],i=this.getImage(t,r);if(!i)return null;if(n&&n.position.version===i.version)return n.position;if(n)n.position.version=i.version;else{const s={w:i.data.width+2,h:i.data.height+2,x:0,y:0},a=new B_(s,i);this.patterns[r][t]={bin:s,position:a}}return this._updatePatternAtlas(r),this.patterns[r][t].position}bind(t,r){const n=t.gl;let i=this.atlasTexture[r];i?this.dirty&&(i.update(this.atlasImage[r]),this.dirty=!1):(i=new dn(t,this.atlasImage[r],n.RGBA),this.atlasTexture[r]=i),i.bind(n.LINEAR,n.CLAMP_TO_EDGE)}_updatePatternAtlas(t){const r=[];for(const a in this.patterns[t])r.push(this.patterns[t][a].bin);const{w:n,h:i}=F_(r),s=this.atlasImage[t];s.resize({width:n||1,height:i||1});for(const a in this.patterns[t]){const{bin:l}=this.patterns[t][a],p=l.x+1,f=l.y+1,m=this.images[t][a].data,_=m.width,y=m.height;Yr.copy(m,s,{x:0,y:0},{x:p,y:f},{width:_,height:y}),Yr.copy(m,s,{x:0,y:y-1},{x:p,y:f-1},{width:_,height:1}),Yr.copy(m,s,{x:0,y:0},{x:p,y:f+y},{width:_,height:1}),Yr.copy(m,s,{x:_-1,y:0},{x:p-1,y:f},{width:1,height:y}),Yr.copy(m,s,{x:0,y:0},{x:p+_,y:f},{width:1,height:y})}this.dirty=!0}beginFrame(){for(const t in this.images)this.callbackDispatchedThisFrame[t]={}}dispatchRenderCallbacks(t,r){for(const n of t){if(this.callbackDispatchedThisFrame[r][n])continue;this.callbackDispatchedThisFrame[r][n]=!0;const i=this.images[r][n];$P(i)&&this.updateImage(n,r,i)}}}const JP=new qr({anchor:new Tt(rt.light.anchor),position:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return Xt(e.expression.evaluate(t))}interpolate(e,t,r){return{x:ce(e.x,t.x,r),y:ce(e.y,t.y,r),z:ce(e.z,t.z,r),azimuthal:ce(e.azimuthal,t.azimuthal,r),polar:ce(e.polar,t.polar,r)}}}(rt.light.position),color:new Tt(rt.light.color),intensity:new Tt(rt.light.intensity)});class dE extends hn{constructor(t,r="flat"){super(),this._transitionable=new uh(JP),this.setLight(t,r),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,r,n={}){this._validate(DS,t,n)||(this._transitionable.setTransitionOrValue(t),this.id=r)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,n){return(!n||n.validate!==!1)&&ef(this,t.call(Lu,Yt({value:r,style:{glyphs:!0,sprite:!0},styleSpec:rt})))}}const QP=new qr({source:new Tt(rt.terrain.source),exaggeration:new Tt(rt.terrain.exaggeration)});let tL=class extends hn{constructor(e,t){super(),this._transitionable=new uh(QP),this.set(e),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}get(){return this._transitionable.serialize()}set(e){this._transitionable.setTransitionOrValue(e)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}};function mE(e,t,r,n){const i=Ti(45,65,r),[s,a]=gE(e,n),l=q.length(t);let p=1-Math.min(1,Math.exp((l-s)/(a-s)*-6));return p*=p*p,p=Math.min(1,1.00747*p),p*i*e.alpha}function gE(e,t){const r=.5/Math.tan(.5*t);return[e.range[0]+r,e.range[1]+r]}const eL=new qr({range:new Tt(rt.fog.range),color:new Tt(rt.fog.color),"high-color":new Tt(rt.fog["high-color"]),"space-color":new Tt(rt.fog["space-color"]),"horizon-blend":new Tt(rt.fog["horizon-blend"]),"star-intensity":new Tt(rt.fog["star-intensity"])});class rL extends hn{constructor(t,r){super(),this._transitionable=new uh(eL),this.set(t),this._transitioning=this._transitionable.untransitioned(),this._transform=r}get state(){const t=this._transform,r=t.projection.name==="globe",n=Zn(t.zoom),i=this.properties.get("range"),s=[.5,3];return{range:r?[ce(s[0],i[0],n),ce(s[1],i[1],n)]:i,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,r={}){if(!this._validate(NS,t,r)){for(const n of Object.keys(rt.fog))t&&t[n]===void 0&&(t[n]=rt.fog[n].default);this._transitionable.setTransitionOrValue(t)}}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const r=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:Ti(45,65,t))*r.a}getOpacityAtLatLng(t,r){return this._transform.projection.supportsFog?function(n,i,s){const a=Ue.fromLngLat(i),l=s.elevation?s.elevation.getAtPointOrZero(a):0,p=[a.x,a.y,l];return q.transformMat4(p,p,s.mercatorFogMatrix),mE(n,p,s.pitch,s._fov)}(this.state,t,r):0}getFovAdjustedRange(t){return this._transform.projection.supportsFog?gE(this.state,t):[0,1]}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,n){return(!n||n.validate!==!1)&&ef(this,t.call(Lu,Yt({value:r,style:{glyphs:!0,sprite:!0},styleSpec:rt})))}}class nL{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class iL{constructor(){this.tasks={},this.taskQueue=[],Ln(["process"],this),this.invoker=new nL(this.process),this.nextId=0}add(t,r){const n=this.nextId++,i=function({type:s,isSymbolTile:a,zoom:l}){return l=l||0,s==="message"?0:s!=="maybePrepare"||a?s!=="parseTile"||a?s==="parseTile"&&a?300-l:s==="maybePrepare"&&a?400-l:500:200-l:100-l}(r);if(i===0){gt();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[n]={fn:t,metadata:r,priority:i,id:n},this.taskQueue.push(n),this.invoker.trigger(),{cancel:()=>{delete this.tasks[n]}}}process(){gt();try{if(this.taskQueue=this.taskQueue.filter(n=>!!this.tasks[n]),!this.taskQueue.length)return;const t=this.pick();if(t===null)return;const r=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!r)return;r.fn()}finally{}}pick(){let t=null,r=1/0;for(let i=0;i<this.taskQueue.length;i++){const s=this.tasks[this.taskQueue[i]];s.priority<r&&(r=s.priority,t=i)}if(t===null)return null;const n=this.taskQueue[t];return this.taskQueue.splice(t,1),n}remove(){this.invoker.remove()}}class _E{constructor(t,r,n){this.target=t,this.parent=r,this.mapId=n,this.callbacks={},this.cancelCallbacks={},Ln(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=gt()?t:S,this.scheduler=new iL}send(t,r,n,i,s=!1,a){const l=Math.round(1e18*Math.random()).toString(36).substring(0,10);n&&(n.metadata=a,this.callbacks[l]=n);const p=pe(this.globalScope)?void 0:[];return this.target.postMessage({id:l,type:t,hasCallback:!!n,targetMapId:i,mustQueue:s,sourceMapId:this.mapId,data:Ru(r,p)},p),{cancel:()=>{n&&delete this.callbacks[l],this.target.postMessage({id:l,type:"<cancel>",targetMapId:i,sourceMapId:this.mapId})}}}receive(t){const r=t.data,n=r.id;if(n&&(!r.targetMapId||this.mapId===r.targetMapId))if(r.type==="<cancel>"){const i=this.cancelCallbacks[n];delete this.cancelCallbacks[n],i&&i.cancel()}else if(r.mustQueue||gt()){const i=this.callbacks[n];this.cancelCallbacks[n]=this.scheduler.add(()=>this.processTask(n,r),i&&i.metadata||{type:"message"})}else this.processTask(n,r)}processTask(t,r){if(r.type==="<response>"){const n=this.callbacks[t];delete this.callbacks[t],n&&(r.error?n(Ou(r.error)):n(null,Ou(r.data)))}else{const n=pe(this.globalScope)?void 0:[],i=r.hasCallback?(a,l)=>{delete this.cancelCallbacks[t],this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:a?Ru(a):null,data:Ru(l,n)},n)}:a=>{},s=Ou(r.data);if(this.parent[r.type])this.parent[r.type](r.sourceMapId,s,i);else if(this.parent.getWorkerSource){const a=r.type.split(".");this.parent.getWorkerSource(r.sourceMapId,a[0],s.source,s.scope)[a[1]](s,i)}else i(new Error(`Could not find function ${r.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class Xl{constructor(t,r){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=gu();const n=this.workerPool.acquire(this.id);for(let i=0;i<n.length;i++){const s=new Xl.Actor(n[i],r,this.id);s.name=`Worker ${i}`,this.actors.push(s)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(t,r,n){Lo(this.actors,(i,s)=>{i.send(t,r,s)},n=n||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(t=>{t.remove()}),this.actors=[],this.workerPool.release(this.id)}}Xl.Actor=_E;class yE extends hn{constructor(t,r,n){super(),this._options=t,this._transitionable=new uh(r,n),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}}const oL=new qr({color:new Tt(rt.properties_light_ambient.color),intensity:new Tt(rt.properties_light_ambient.intensity)}),sL=new qr({direction:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return function([r,n]){const i=Xt([1,r,n]);return{x:i.x,y:i.y,z:i.z}}(e.expression.evaluate(t))}interpolate(e,t,r){return{x:ce(e.x,t.x,r),y:ce(e.y,t.y,r),z:ce(e.z,t.z,r)}}}(rt.properties_light_directional.direction),color:new Tt(rt.properties_light_directional.color),intensity:new Tt(rt.properties_light_directional.intensity),"cast-shadows":new Tt(rt.properties_light_directional["cast-shadows"]),"shadow-intensity":new Tt(rt.properties_light_directional["shadow-intensity"])});class oy{constructor(t,r,n,i){this.screenBounds=t,this.cameraPoint=r,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=n,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,i)}static createFromScreenPoints(t,r){let n,i;if(t instanceof H||typeof t[0]=="number"){const s=H.convert(t);n=[s],i=r.isPointAboveHorizon(s)}else{const s=H.convert(t[0]),a=H.convert(t[1]);n=[s,a],i=An(s,a).every(l=>r.isPointAboveHorizon(l))}return new oy(n,r.getCameraPoint(),i,r)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return An(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const r=this.screenBounds[0],n=this.screenBounds.length===1?this.screenBounds[0].add(new H(1,1)):this.screenBounds[1],i=An(r,n,0,!1);return this.cameraPoint.y>n.y&&(this.cameraPoint.x>r.x&&this.cameraPoint.x<n.x?i.splice(3,0,this.cameraPoint):this.cameraPoint.x>=n.x?i[2]=this.cameraPoint:this.cameraPoint.x<=r.x&&(i[3]=this.cameraPoint)),function(s,a){const l=[];for(let p=0;p<s.length;p++){const f=Vn(p-1,-1,s.length-1),m=Vn(p+1,-1,s.length-1),_=s[p],y=s[m],v=s[f].sub(_).unit(),b=y.sub(_).unit(),w=b.angleWithSep(v.x,v.y),E=v.add(b).unit().mult(-1*a/Math.sin(w/2));l.push(_.add(E))}return l}(i,t)}bufferedCameraGeometryGlobe(t){const r=this.screenBounds[0],n=this.screenBounds.length===1?this.screenBounds[0].add(new H(1,1)):this.screenBounds[1],i=An(r,n,t),s=this.cameraPoint.clone();switch(3*((s.y>r.y)+(s.y>n.y))+((s.x>r.x)+(s.x>n.x))){case 0:i[0]=s,i[4]=s.clone();break;case 1:i.splice(1,0,s);break;case 2:i[1]=s;break;case 3:i.splice(4,0,s);break;case 5:i.splice(2,0,s);break;case 6:i[3]=s;break;case 7:i.splice(3,0,s);break;case 8:i[2]=s}return i}containsTile(t,r,n,i=0){const s=t.queryPadding/r._pixelsPerMercatorPixel+1,a=n?this._bufferedCameraMercator(s,r):this._bufferedScreenMercator(s,r);let l=t.tileID.wrap+(a.unwrapped?i:0);const p=a.polygon.map(E=>sw(t.tileTransform,E,l));if(!ob(p,0,0,lt,lt))return;l=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?i:0);const f=this.screenGeometryMercator.polygon.map(E=>aw(t.tileTransform,E,l)),m=f.map(E=>new H(E[0],E[1])),_=r.getFreeCameraOptions().position||new Ue(0,0,0),y=aw(t.tileTransform,_,l),v=f.map(E=>{const T=q.sub(E,E,y);return q.normalize(T,T),new vf(y,T)}),b=Zl(t,1,r.zoom)*r._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:m,tilespaceRays:v,bufferedTilespaceGeometry:p,bufferedTilespaceBounds:(w=Mn(p),w.min.x=Bt(w.min.x,0,lt),w.min.y=Bt(w.min.y,0,lt),w.max.x=Bt(w.max.x,0,lt),w.max.y=Bt(w.max.y,0,lt),w),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:b};var w}_bufferedScreenMercator(t,r){const n=vE(t);if(this._screenRaycastCache[n])return this._screenRaycastCache[n];{let i;return i=r.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),r):{polygon:this.bufferedScreenGeometry(t).map(s=>r.pointCoordinate3D(s)),unwrapped:!0},this._screenRaycastCache[n]=i,i}}_bufferedCameraMercator(t,r){const n=vE(t);if(this._cameraRaycastCache[n])return this._cameraRaycastCache[n];{let i;return i=r.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),r):{polygon:this.bufferedCameraGeometry(t).map(s=>r.pointCoordinate3D(s)),unwrapped:!0},this._cameraRaycastCache[n]=i,i}}_projectAndResample(t,r){const n=function(s,a){const l=Q.multiply([],a.pixelMatrix,a.globeMatrix),p=[0,-Ki,0,1],f=[0,Ki,0,1],m=[0,0,0,1];gr.transformMat4(p,p,l),gr.transformMat4(f,f,l),gr.transformMat4(m,m,l);const _=new H(p[0]/p[3],p[1]/p[3]),y=new H(f[0]/f[3],f[1]/f[3]),v=el(s,_)&&p[3]<m[3],b=el(s,y)&&f[3]<m[3];if(!v&&!b)return null;const w=function(R,N,k){for(let F=1;F<R.length;F++){const z=Vh(N.pointCoordinate3D(R[F-1]).x),U=Vh(N.pointCoordinate3D(R[F]).x);if(k<0){if(z<U)return{idx:F,t:-z/(U-1-z)}}else if(U<z)return{idx:F,t:(1-z)/(U+1-z)}}return null}(s,a,v?-1:1);if(!w)return null;const{idx:E,t:T}=w;let C=E>1?sy(s.slice(0,E),a):[],M=E<s.length?sy(s.slice(E),a):[];C=C.map(R=>new H(Vh(R.x),R.y)),M=M.map(R=>new H(Vh(R.x),R.y));const A=[...C];A.length===0&&A.push(M[M.length-1]);const P=ce(A[A.length-1].y,(M.length===0?C[0]:M[0]).y,T);let L;return L=v?[new H(0,P),new H(0,0),new H(1,0),new H(1,P)]:[new H(1,P),new H(1,1),new H(0,1),new H(0,P)],A.push(...L),M.length===0?A.push(C[0]):A.push(...M),{polygon:A.map(R=>new Ue(R.x,R.y)),unwrapped:!1}}(t,r);if(n)return n;const i=function(s,a){let l=!1,p=-1/0,f=0;for(let _=0;_<s.length-1;_++)s[_].x>p&&(p=s[_].x,f=_);for(let _=0;_<s.length-1;_++){const y=(f+_)%(s.length-1),v=s[y],b=s[y+1];Math.abs(v.x-b.x)>.5&&(v.x<b.x?(v.x+=1,y===0&&(s[s.length-1].x+=1)):(b.x+=1,y+1===s.length-1&&(s[0].x+=1)),l=!0)}const m=Xn(a.center.lng);return l&&m<Math.abs(m-1)&&s.forEach(_=>{_.x-=1}),{polygon:s,unwrapped:l}}(sy(t,r).map(s=>new H(Vh(s.x),s.y)),r);return{polygon:i.polygon.map(s=>new Ue(s.x,s.y)),unwrapped:i.unwrapped}}}function sy(e,t){return Q1(e,r=>{const n=t.pointCoordinate3D(r);r.x=n.x,r.y=n.y},1/256)}function Vh(e){return e<0?1+e%1:e%1}function vE(e){return 100*e|0}function ay(e,t,r,n,i){const s=function(a,l){if(a)return i(a);if(l){e.url&&l.tiles&&e.tiles&&delete e.tiles;const p=Zi(Yt(l,e),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);l.vector_layers&&(p.vectorLayers=l.vector_layers,p.vectorLayerIds=p.vectorLayers.map(f=>f.id)),p.tiles=t.canonicalizeTileset(p,e.url),i(null,p)}};return e.url?Lt(t.transformRequest(t.normalizeSourceURL(e.url,null,r,n),ct.Source),s):ge.frame(()=>s(null,e))}class md{constructor(t,r,n){this.bounds=go.convert(this.validateBounds(t)),this.minzoom=r||0,this.maxzoom=n||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const r=Math.pow(2,t.z),n=Math.floor(Xn(this.bounds.getWest())*r),i=Math.floor(ri(this.bounds.getNorth())*r),s=Math.ceil(Xn(this.bounds.getEast())*r),a=Math.ceil(ri(this.bounds.getSouth())*r);return t.x>=n&&t.x<s&&t.y>=i&&t.y<a}}class xE{constructor(t,r){this.width=t,this.height=r,this.nextRow=0,this.image=new ma({width:t,height:r}),this.positions={},this.uploaded=!1}getDash(t,r){const n=this.getKey(t,r);return this.positions[n]}trim(){const t=this.width,r=this.height=Tp(this.nextRow);this.image.resize({width:t,height:r})}getKey(t,r){return t.join(",")+r}getDashRanges(t,r,n){const i=[];let s=t.length%2==1?-t[t.length-1]*n:0,a=t[0]*n,l=!0;i.push({left:s,right:a,isDash:l,zeroLength:t[0]===0});let p=t[0];for(let f=1;f<t.length;f++){l=!l;const m=t[f];s=p*n,p+=m,a=p*n,i.push({left:s,right:a,isDash:l,zeroLength:m===0})}return i}addRoundDash(t,r,n){const i=r/2;for(let s=-n;s<=n;s++){const a=this.width*(this.nextRow+n+s);let l=0,p=t[l];for(let f=0;f<this.width;f++){f/p.right>1&&(p=t[++l]);const m=Math.abs(f-p.left),_=Math.abs(f-p.right),y=Math.min(m,_);let v;const b=s/n*(i+1);if(p.isDash){const w=i-Math.abs(b);v=Math.sqrt(y*y+w*w)}else v=i-Math.sqrt(y*y+b*b);this.image.data[a+f]=Math.max(0,Math.min(255,v+128))}}}addRegularDash(t,r){for(let p=t.length-1;p>=0;--p){const f=t[p],m=t[p+1];f.zeroLength?t.splice(p,1):m&&m.isDash===f.isDash&&(m.left=f.left,t.splice(p,1))}const n=t[0],i=t[t.length-1];n.isDash===i.isDash&&(n.left=i.left-this.width,i.right=n.right+this.width);const s=this.width*this.nextRow;let a=0,l=t[a];for(let p=0;p<this.width;p++){p/l.right>1&&(l=t[++a]);const f=Math.abs(p-l.left),m=Math.abs(p-l.right),_=Math.min(f,m);this.image.data[s+p]=Math.max(0,Math.min(255,(l.isDash?_:-_)+r+128))}}addDash(t,r){const n=this.getKey(t,r);if(this.positions[n])return this.positions[n];const i=r==="round",s=i?7:0,a=2*s+1;if(this.nextRow+a>this.height)return Y("LineAtlas out of space"),null;t.length===0&&t.push(1);let l=0;for(let m=0;m<t.length;m++)t[m]<0&&(Y("Negative value is found in line dasharray, replacing values with 0"),t[m]=0),l+=t[m];if(l!==0){const m=this.width/l,_=this.getDashRanges(t,this.width,m);i?this.addRoundDash(_,m,s):this.addRegularDash(_,r==="square"?.5*m:0)}const p=this.nextRow+s;this.nextRow+=a;const f={tl:[p,s],br:[l,0]};return this.positions[n]=f,f}}Ut(xE,"LineAtlas");const bE=1*fs;class wE{constructor(t){const r={},n=[];for(const l in t){const p=t[l],f=r[l]={};for(const m in p.glyphs){const _=p.glyphs[+m];if(!_||_.bitmap.width===0||_.bitmap.height===0)continue;const y=_.metrics.localGlyph?bE:1,v={x:0,y:0,w:_.bitmap.width+2*y,h:_.bitmap.height+2*y};n.push(v),f[m]=v}}const{w:i,h:s}=F_(n),a=new ma({width:i||1,height:s||1});for(const l in t){const p=t[l];for(const f in p.glyphs){const m=p.glyphs[+f];if(!m||m.bitmap.width===0||m.bitmap.height===0)continue;const _=r[l][f],y=m.metrics.localGlyph?bE:1;ma.copy(m.bitmap,a,{x:0,y:0},{x:_.x+y,y:_.y+y},m.bitmap)}}this.image=a,this.positions=r}}Ut(wE,"GlyphAtlas");class aL{constructor(t){this.tileID=new wr(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.scope=t.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.returnDependencies=!!t.returnDependencies,this.promoteId=t.promoteId,this.enableTerrain=!!t.enableTerrain,this.isSymbolTile=t.isSymbolTile,this.tileTransform=ql(t.tileID.canonical,t.projection),this.projection=t.projection,this.brightness=t.brightness}parse(t,r,n,i,s){this.status="parsing",this.data=t,this.collisionBoxArray=new Ug;const a=new xb(Object.keys(t.layers).sort()),l=new N_(this.tileID,this.promoteId);l.bucketLayerIDs=[];const p={},f=new xE(256,256),m={featureIndex:l,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:f,availableImages:n,brightness:this.brightness},_=r.familiesBySource[this.source];for(const P in _){const L=t.layers[P];if(!L)continue;let R=!1,N=!1;for(const z of _[P])z[0].type==="symbol"?R=!0:N=!0;if(this.isSymbolTile===!0&&!R||this.isSymbolTile===!1&&!N)continue;L.version===1&&Y(`Vector tile source "${this.source}" layer "${P}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const k=a.encode(P),F=[];for(let z=0;z<L.length;z++){const U=L.feature(z),G=l.getId(U,P);F.push({feature:U,id:G,index:z,sourceLayerIndex:k})}for(const z of _[P]){const U=z[0];this.isSymbolTile!==void 0&&U.type==="symbol"!==this.isSymbolTile||U.minzoom&&this.zoom<Math.floor(U.minzoom)||U.maxzoom&&this.zoom>=U.maxzoom||U.visibility!=="none"&&(ly(z,this.zoom,m.brightness,n),(p[U.id]=U.createBucket({index:l.bucketLayerIDs.length,layers:z,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:k,sourceID:this.source,enableTerrain:this.enableTerrain,projection:this.projection.spec})).populate(F,m,this.tileID.canonical,this.tileTransform),l.bucketLayerIDs.push(z.map(G=>G.id)))}}let y,v,b,w;f.trim();const E={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},T=()=>{if(y)return s(y);if(v&&b&&w){const P=new wE(v),L=new Fb(b,w);for(const R in p){const N=p[R];N instanceof Lh?(ly(N.layers,this.zoom,m.brightness,n),hA(N,v,P.positions,b,L.iconPositions,this.showCollisionBoxes,n,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):N.hasPattern&&(N instanceof rd||N instanceof Of||N instanceof Fh)&&(ly(N.layers,this.zoom,m.brightness,n),N.addFeatures(m,this.tileID.canonical,L.patternPositions,n,this.tileTransform,this.brightness))}this.status="done",s(null,{buckets:ho(p).filter(R=>!R.isEmpty()),featureIndex:l,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:P.image,lineAtlas:f,imageAtlas:L,brightness:m.brightness,glyphMap:this.returnDependencies?v:null,iconMap:this.returnDependencies?b:null,glyphPositions:this.returnDependencies?P.positions:null})}},C=yu(m.glyphDependencies,P=>Object.keys(P).map(Number));Object.keys(C).length?i.send("getGlyphs",{uid:this.uid,stacks:C,scope:this.scope},(P,L)=>{y||(y=P,v=L,T())},void 0,!1,E):v={};const M=Object.keys(m.iconDependencies);M.length?i.send("getImages",{icons:M,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(P,L)=>{y||(y=P,b=L,T())},void 0,!1,E):b={};const A=Object.keys(m.patternDependencies);A.length?i.send("getImages",{icons:A,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(P,L)=>{y||(y=P,w=L,T())},void 0,!1,E):w={},T()}}function ly(e,t,r,n){const i=new jr(t,{brightness:r});for(const s of e)s.recalculate(i,n)}class EE{constructor(t){this.entries={},this.scheduler=t}request(t,r,n,i){const s=this.entries[t]=this.entries[t]||{callbacks:[]};if(s.result){const[a,l]=s.result;return this.scheduler?this.scheduler.add(()=>{i(a,l)},r):i(a,l),()=>{}}return s.callbacks.push(i),s.cancel||(s.cancel=n((a,l)=>{s.result=[a,l];for(const p of s.callbacks)this.scheduler?this.scheduler.add(()=>{p(a,l)},r):p(a,l);setTimeout(()=>delete this.entries[t],3e3)})),()=>{s.result||(s.callbacks=s.callbacks.filter(a=>a!==i),s.callbacks.length||(s.cancel(),delete this.entries[t]))}}}function TE(e,t,r){const n=JSON.stringify(e.request);return e.data&&(this.deduped.entries[n]={result:[null,e.data]}),this.deduped.request(n,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom},i=>{const s=Dt(e.request,(a,l,p,f)=>{a?i(a):l&&i(null,{vectorTile:r?void 0:new R_(new Vf(l)),rawData:l,cacheControl:p,expires:f})});return()=>{s.cancel(),i()}},t)}class IE extends hn{constructor(t,r,n,i){if(super(),this.id=t,this.dispatcher=n,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Yt(this,Zi(r,["url","scheme","tileSize","promoteId"])),this._options=Yt({type:"vector"},r),this._collectResourceTiming=!!r.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(i),this._tileWorkers={},this._deduped=new EE}load(t){this._loaded=!1,this.fire(new wt("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map._worldview;this._tileJSONRequest=ay(this._options,this.map._requestManager,r,n,(i,s)=>{this._tileJSONRequest=null,this._loaded=!0,i?(r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),n&&n.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new fe(i))):s&&(Yt(this,s),s.bounds&&(this.tileBounds=new md(s.bounds,this.minzoom,this.maxzoom)),pm(s.tiles,this.map._requestManager._customAccessToken),this.fire(new wt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new wt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(i)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest(),this.load(()=>this.map.style._clearSource(this.id))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Yt({},this._options)}loadTile(t,r){const n=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),i={request:this.map._requestManager.transformRequest(n,ct.Tile),data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:ge.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(i.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=r:t.request=t.actor.send("reloadTile",i,s.bind(this));else if(t.actor=this._tileWorkers[n]=this._tileWorkers[n]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",i,s.bind(this),void 0,!0);else{const a=TE.call({deduped:this._deduped},i,(l,p)=>{l||!p?s.call(this,l):(i.data={cacheControl:p.cacheControl,expires:p.expires,rawData:p.rawData.slice(0)},t.actor&&t.actor.send("loadTile",i,s.bind(this),void 0,!0))},!0);t.request={cancel:a}}function s(a,l){return delete t.request,t.aborted?r(null):a&&a.status!==404?r(a):(l&&l.resourceTiming&&(t.resourceTiming=l.resourceTiming),this.map._refreshExpiredTiles&&l&&t.setExpiryData(l),t.loadVectorData(l,this.map.painter),ht(this.dispatcher),r(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t){t.unloadVectorData(),t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Uh extends hn{constructor(t,r,n,i){super(),this.id=t,this.dispatcher=n,this.setEventedParent(i),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Yt({type:"raster"},r),Yt(this,Zi(r,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new wt("dataloading",{dataType:"source"})),this._tileJSONRequest=ay(this._options,this.map._requestManager,null,null,(r,n)=>{this._tileJSONRequest=null,this._loaded=!0,r?this.fire(new fe(r)):n&&(Yt(this,n),n.bounds&&(this.tileBounds=new md(n.bounds,this.minzoom,this.maxzoom)),pm(n.tiles),this.fire(new wt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new wt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(r)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest(),this.load(()=>this.map.style._clearSource(this.id))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Yt({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,r){const n=ge.devicePixelRatio>=2,i=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),n,this.tileSize);t.request=Ke(this.map._requestManager.transformRequest(i,ct.Tile),(s,a,l,p)=>(delete t.request,t.aborted?(t.state="unloaded",r(null)):s?(t.state="errored",r(s)):a?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:l,expires:p}),t.setTexture(a,this.map.painter),t.state="loaded",ht(this.dispatcher),void r(null)):r(null)))}static loadTileData(t,r,n){t.setTexture(r,n)}static unloadTileData(t,r){t.texture&&r.saveTileTexture(t.texture)}abortTile(t,r){t.request&&(t.request.cancel(),delete t.request),r()}unloadTile(t,r){t.texture&&this.map.painter.saveTileTexture(t.texture),r()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}let uy;function SE(e,t,r,n,i,s,a,l){const p=[e,r,i,t,n,s,1,1,1],f=[a,l,1],m=Ri.adjoint([],p),[_,y,v]=q.transformMat3(f,f,Ri.transpose(m,m));return Ri.multiply(p,[_,0,0,0,y,0,0,0,v],p)}class Wl extends hn{constructor(t,r,n,i){super(),this.id=t,this.dispatcher=n,this.coordinates=r.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(i),this.options=r,this._dirty=!1}load(t,r){this._loaded=r||!1,this.fire(new wt("dataloading",{dataType:"source"})),this.url=this.options.url,this._imageRequest=Ke(this.map._requestManager.transformRequest(this.url,ct.Image),(n,i)=>{if(this._imageRequest=null,this._loaded=!0,n)this.fire(new fe(n));else if(i){const{HTMLImageElement:s}=S;this.image=i instanceof s?ge.getImageData(i):i,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),this._finishLoading()}})}loaded(){return this._loaded}updateImage(t){return this.image&&t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new wt("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),this.texture&&this.texture.destroy()}setCoordinates(t){this.coordinates=t,this._boundsArray=void 0;const r=t.map(Ue.fromLngLat);return this.tileID=function(n){let i=1/0,s=1/0,a=-1/0,l=-1/0;for(const _ of n)i=Math.min(i,_.x),s=Math.min(s,_.y),a=Math.max(a,_.x),l=Math.max(l,_.y);const p=Math.max(a-i,l-s),f=Math.max(0,Math.floor(-Math.log(p)/Math.LN2)),m=Math.pow(2,f);return new da(f,Math.floor((i+a)/2*m),Math.floor((s+l)/2*m))}(r),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new wt("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(t){for(const p in this.tiles){const f=this.tiles[p];f.state!=="loaded"&&(f.state="loaded",f.texture=this.texture)}if(this._boundsArray)return;const r=ql(this.tileID,this.map.transform.projection),[n,i,s,a]=this.coordinates.map(p=>{const f=r.projection.project(p[0],p[1]);return sw(r,f)._round()});this.perspectiveTransform=function(p,f,m,_,y,v,b,w,E,T){const C=SE(0,0,p,0,0,f,p,f),M=SE(m,_,y,v,b,w,E,T);return Ri.multiply(M,Ri.adjoint(C,C),M),[M[6]/M[8]*p/lt,M[7]/M[8]*f/lt]}(this.width,this.height,n.x,n.y,i.x,i.y,a.x,a.y,s.x,s.y);const l=this._boundsArray=new Ua;l.emplaceBack(n.x,n.y,0,0),l.emplaceBack(i.x,i.y,lt,0),l.emplaceBack(a.x,a.y,0,lt),l.emplaceBack(s.x,s.y,lt,lt),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=t.createVertexBuffer(l,H_.members),this.boundsSegments=mr.simpleSegment(0,0,4,2)}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const t=this.map.painter.context,r=t.gl;this._dirty&&(this.texture?this.texture.update(this.image):(this.texture=new dn(t,this.image,r.RGBA),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE)),this._dirty=!1),this._prepareData(t)}loadTile(t,r){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},r(null)):(t.state="errored",r(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class CE{constructor(t,r,n){if(this.triangleCount=r.length/3,this.min=new H(0,0),this.max=new H(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||t.length===0||n===0)return;const i=t.map(m=>m.x),s=t.map(m=>m.y);this.min=new H(Math.min(...i),Math.min(...s)),this.max=new H(Math.max(...i),Math.max(...s));const a=this.max.sub(this.min);a.x=Math.max(a.x,1),a.y=Math.max(a.y,1);const l=Math.max(a.x,a.y)/n;this.cellsX=Math.max(1,Math.ceil(a.x/l)),this.cellsY=Math.max(1,Math.ceil(a.y/l)),this.xScale=this.cellsX/a.x,this.yScale=this.cellsY/a.y;const p=[];for(let m=0;m<this.triangleCount;m++){const _=t[r[3*m+0]].sub(this.min),y=t[r[3*m+1]].sub(this.min),v=t[r[3*m+2]].sub(this.min),b=hl(Math.floor(Math.min(_.x,y.x,v.x)),this.xScale,this.cellsX),w=hl(Math.floor(Math.max(_.x,y.x,v.x)),this.xScale,this.cellsX),E=hl(Math.floor(Math.min(_.y,y.y,v.y)),this.yScale,this.cellsY),T=hl(Math.floor(Math.max(_.y,y.y,v.y)),this.yScale,this.cellsY),C=new H(0,0),M=new H(0,0),A=new H(0,0),P=new H(0,0);for(let L=E;L<=T;++L){C.y=M.y=L*l,A.y=P.y=(L+1)*l;for(let R=b;R<=w;++R)C.x=A.x=R*l,M.x=P.x=(R+1)*l,(T_(_,y,v,C,M,P)||T_(_,y,v,C,P,A))&&p.push({cellIdx:L*this.cellsX+R,triIdx:m})}}if(p.length===0)return;p.sort((m,_)=>m.cellIdx-_.cellIdx||m.triIdx-_.triIdx);let f=0;for(;f<p.length;){const m=p[f].cellIdx,_={start:this.payload.length,len:0};for(;f<p.length&&p[f].cellIdx===m;)++_.len,this.payload.push(p[f++].triIdx);this.cells[m]=_}}query(t,r,n){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>r.x||t.y>this.max.y||this.min.y>r.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let p=0;p<this.lookup.length;p++)this.lookup[p]=0;const i=hl(t.x-this.min.x,this.xScale,this.cellsX),s=hl(r.x-this.min.x,this.xScale,this.cellsX),a=hl(t.y-this.min.y,this.yScale,this.cellsY),l=hl(r.y-this.min.y,this.yScale,this.cellsY);for(let p=a;p<=l;p++)for(let f=i;f<=s;f++){const m=this.cells[p*this.cellsX+f];if(m)for(let _=0;_<m.len;_++){const y=this.payload[m.start+_],v=Math.floor(y/8),b=1<<y%8;if(!(this.lookup[v]&b)&&(this.lookup[v]|=b,n.push(y),n.length===this.triangleCount))return}}}}function hl(e,t,r){return Math.max(0,Math.min(r-1,Math.floor(e*t)))}Ut(CE,"TriangleGridIndex");const lL=5123,uL=5126,cL={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ME={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function lc(e,t){if(t.value&&t.value.length)return t.value;const r=e.json.bufferViews[t.bufferView],n=e.buffers[r.buffer];return new cL[t.componentType](n.arrayBuffer,n.byteOffset+(t.byteOffset||0)+(r.byteOffset||0),t.count*ME[t.type])}function hL(e,t,r){const n=e.indices,i=e.attributes,s={};s.indexArray=new xn;const a=typeof n=="object"?n:t.json.accessors[n],l=a.count/3;s.indexArray.reserve(l);const p=lc(t,a);for(let y=0;y<l;y++)s.indexArray.emplaceBack(p[3*y],p[3*y+1],p[3*y+2]);s.indexArray._trim(),s.vertexArray=new Za;const f=typeof i.POSITION=="object"?i.POSITION:t.json.accessors[i.POSITION];s.vertexArray.reserve(f.count);const m=lc(t,f);for(let y=0;y<f.count;y++)s.vertexArray.emplaceBack(m[3*y],m[3*y+1],m[3*y+2]);if(s.vertexArray._trim(),s.aabb=new Zr(f.min,f.max),s.centroid=function(y,v){const b=[0,0,0],w=y.length;if(w>0){for(let E=0;E<w;E++){const T=3*y[E];b[0]+=v[T],b[1]+=v[T+1],b[2]+=v[T+2]}b[0]/=w,b[1]/=w,b[2]/=w}return b}(p,m),i.COLOR_0!==void 0){const y=typeof i.COLOR_0=="object"?i.COLOR_0:t.json.accessors[i.COLOR_0],v=ME[y.type];if(y.componentType===uL){s.colorArray=v===3?new Za:new Ga,s.colorArray.reserve(y.count);const b=lc(t,y);if(v===3)for(let w=0;w<y.count;w++)s.colorArray.emplaceBack(b[3*w],b[3*w+1],b[3*w+2]);else for(let w=0;w<y.count;w++)s.colorArray.emplaceBack(b[4*w],b[4*w+1],b[4*w+2],b[4*w+3]);s.colorArray._trim()}else if(y.componentType===lL&&v===4){s.colorArray=new Ga,s.colorArray.resize(y.count);const b=lc(t,y),w=1/65535,E=s.colorArray.float32;for(let T=0;T<4*b.length;++T)E[T]=b[T]*w}else Y(`glTF color buffer parsing for accessor ${JSON.stringify(y)} is not supported`)}if(i.NORMAL!==void 0){s.normalArray=new Za;const y=typeof i.NORMAL=="object"?i.NORMAL:t.json.accessors[i.NORMAL];s.normalArray.reserve(y.count);const v=lc(t,y);for(let b=0;b<y.count;b++)s.normalArray.emplaceBack(v[3*b],v[3*b+1],v[3*b+2]);s.normalArray._trim()}if(i.TEXCOORD_0!==void 0&&r.length>0){s.texcoordArray=new fh;const y=typeof i.TEXCOORD_0=="object"?i.TEXCOORD_0:t.json.accessors[i.TEXCOORD_0];s.texcoordArray.reserve(y.count);const v=lc(t,y);for(let b=0;b<y.count;b++)s.texcoordArray.emplaceBack(v[2*b],v[2*b+1]);s.texcoordArray._trim()}const _=e.material;return s.material=function(y,v){const b=y.pbrMetallicRoughness?y.pbrMetallicRoughness:{},w={},E={},T=b.baseColorFactor?new Se(b.baseColorFactor[0],b.baseColorFactor[1],b.baseColorFactor[2],b.baseColorFactor[3]):Se.white;return E.baseColorFactor=T,E.metallicFactor=b.metallicFactor!==void 0?b.metallicFactor:1,E.roughnessFactor=b.roughnessFactor!==void 0?b.roughnessFactor:1,w.emissiveFactor=y.emissiveFactor?[y.emissiveFactor[0],y.emissiveFactor[1],y.emissiveFactor[2]]:[0,0,0],w.alphaMode=y.alphaMode?y.alphaMode:"OPAQUE",w.alphaCutoff=y.alphaCutoff!==void 0?y.alphaCutoff:.5,b.baseColorTexture&&(E.baseColorTexture=v[b.baseColorTexture.index]),b.metallicRoughnessTexture&&(E.metallicRoughnessTexture=v[b.metallicRoughnessTexture.index]),y.normalTexture&&(w.normalTexture=v[y.normalTexture.index]),y.occlusionTexture&&(w.occlusionTexture=v[y.occlusionTexture.index]),y.emissiveTexture&&(w.emissionTexture=v[y.emissiveTexture.index]),w.pbrMetallicRoughness=E,y.defined===void 0&&(w.defined=!0),w}(_!==void 0?t.json.materials[_]:{defined:!1},r),i.CUSTOM_ATTRIBUTE_3!==void 0&&(s.featureData=new Uint32Array(i.CUSTOM_ATTRIBUTE_3.value.buffer)),s}function AE(e,t,r){const n={};if(n.matrix=e.matrix?e.matrix:Q.identity([]),e.translation&&Q.translate(n.matrix,n.matrix,[e.translation[0],e.translation[1],e.translation[2]]),e.rotation){const i=Q.fromQuat([],[e.rotation[0],e.rotation[1],e.rotation[2],e.rotation[3]]);Q.multiply(n.matrix,n.matrix,i)}if(e.scale&&Q.scale(n.matrix,n.matrix,[e.scale[0],e.scale[1],e.scale[2]]),e.mesh!==void 0&&(n.meshes=r[e.mesh]),e.extras&&(e.extras.id&&(n.id=e.extras.id),e.extras.lights&&(n.lights=function(i){if(!i.length)return[];const s=function(m,_){const y=m.replace(/[^A-Za-z0-9+/]/g,""),v=y.length,b=3*v+1>>2,w=new Uint8Array(b);let E,T,C=0,M=0;for(let P=0;P<v;P++)if(T=3&P,C|=((A=y.charCodeAt(P))>64&&A<91?A-65:A>96&&A<123?A-71:A>47&&A<58?A+4:A===43?62:A===47?63:0)<<6*(3-T),T===3||v-P==1){for(E=0;E<3&&M<b;)w[M]=C>>>(16>>>E&24)&255,E++,M++;C=0}var A;return w}(i),a=[],l=s.length/24,p=new Uint16Array(s.buffer),f=new Float32Array(s.buffer);for(let m=0;m<l;m++){const _=p[2*m*6]/30,y=p[2*m*6+1]/30,v=[f[6*m+1],f[6*m+2],y],b=[f[6*m+3],f[6*m+4],y],w=q.sub([],b,v),E=q.length(w);w[2]=-w[0],w[0]=w[1],w[1]=w[2],w[2]=0,q.scale(w,w,1/E);const T=p[2*m*6+10]/100,C=q.add([],v,b);q.scale(C,C,.5),a.push({pos:C,normal:w,width:E,height:_,depth:T,points:[v[0],v[1],b[0],b[1]]})}return a}(e.extras.lights)),n.meshes)){const i=[0,0];for(const s of n.meshes){const a=s.aabb;i[0]+=a.min[0]+a.max[0],i[1]+=a.min[1]+a.max[1]}i[0]=Math.floor(i[0]/n.meshes.length/2),i[1]=Math.floor(i[1]/n.meshes.length/2),n.anchor=i}if(e.children){const i=[];for(const s of e.children)i.push(AE(t.json.nodes[s],t,r));n.children=i}return n}function pL(e){if(e.vertices.length===0||e.indices.length===0)return null;const[t,r]=[e.vertices[0].clone(),e.vertices[0].clone()];for(let a=1;a<e.vertices.length;++a){const l=e.vertices[a];t.x=Math.min(t.x,l.x),t.y=Math.min(t.y,l.y),r.x=Math.max(r.x,l.x),r.y=Math.max(r.y,l.y)}const n=Math.ceil(Math.max(r.x-t.x,r.y-t.y)/256),i=Math.max(8,n),s=new CE(e.vertices,e.indices,i);return{vertices:e.vertices,indices:e.indices,grid:s,min:t,max:r}}function fL(e){if(!e.extras||!e.extras.ground)return null;const t=e.extras.ground;if(!t||!Array.isArray(t)||t.length===0)return null;const r=t[0];if(!r||!Array.isArray(r)||r.length===0)return null;const n=[];for(const a of r){if(!Array.isArray(a)||a.length!==2)continue;const l=a[0],p=a[1];typeof l=="number"&&typeof p=="number"&&n.push(new H(l,p))}if(n.length<3)return null;n.length>1&&n[n.length-1].equals(n[0])&&n.pop();let i=0;for(let a=0;a<n.length;a++){const l=n[a],p=n[(a+1)%n.length],f=n[(a+2)%n.length];i+=(l.x-p.x)*(f.y-p.y)-(f.x-p.x)*(l.y-p.y)}i>0&&n.reverse();const s=Rf(n.flatMap(a=>[a.x,a.y]),[]);return s.length===0?null:{vertices:n,indices:s}}function dL(e){const t=[],r=[];let n=0;for(const i of e){n=t.length;const s=i.vertexArray.float32,a=i.indexArray.uint16;for(let l=0;l<i.vertexArray.length;l++)t.push(new H(s[3*l+0],s[3*l+1]));for(let l=0;l<3*i.indexArray.length;l++)r.push(a[l]+n)}if(r.length%3!=0)return null;for(let i=0;i<r.length;i+=3){const s=t[r[i+0]],a=t[r[i+1]],l=t[r[i+2]];(s.x-a.x)*(l.y-a.y)-(l.x-a.x)*(s.y-a.y)>0&&([r[i+1],r[i+2]]=[r[i+2],r[i+1]])}return{vertices:t,indices:r}}function cy(e){const t=function(l){const p=[];for(const f of l.images)p.push(f);return p}(e),r=function(l,p){const f=[],m=S.WebGLRenderingContext,_=l.json.samplers;if(l.json.textures)for(const y of l.json.textures){const v={magFilter:m.LINEAR,minFilter:m.NEAREST,wrapS:m.REPEAT,wrapT:m.REPEAT,mipmaps:!1};y.sampler!==void 0&&(_[y.sampler].magFilter&&(v.magFilter=_[y.sampler].magFilter),_[y.sampler].minFilter&&(v.minFilter=_[y.sampler].minFilter),v.minFilter>=m.NEAREST_MIPMAP_NEAREST&&(v.mipmaps=!0),_[y.sampler].wrapS&&(v.wrapS=_[y.sampler].wrapS),_[y.sampler].wrapT&&(v.wrapT=_[y.sampler].wrapT)),f.push({image:p[y.source],sampler:v,uploaded:!1})}return f}(e,t),n=function(l,p){const f=[];for(const m of l.json.meshes){const _=[];for(const y of m.primitives){const v=hL(y,l,p);_.push(v)}f.push(_)}return f}(e,r),i=[],s=e.json.scene?e.json.scenes[e.json.scene]:e.json.scenes?e.json.scenes[0]:void 0,a=s?s.nodes:e.json.nodes;for(const l of a)i.push(AE(e.json.nodes[l],e,n));return function(l,p,f){const m={},_=new Set;for(let y=0;y<l.length;y++){const v=f[p[y]];if(!v.extras)continue;const b=v.extras["mapbox:footprint:version"],w=v.extras["mapbox:footprint:id"];(b||w)&&_.add(y),b==="1.0.0"&&w&&(m[w]=y)}for(let y=0;y<l.length;y++){if(_.has(y))continue;const v=l[y],b=f[p[y]];if(!b.extras)continue;let w=null;v.id in m&&(w=dL(l[m[v.id]].meshes)),w||(w=fL(b)),w&&(v.footprint=pL(w))}if(_.size>0){const y=Array.from(_.values()).sort((v,b)=>v-b);for(let v=y.length-1;v>=0;v--)l.splice(y[v],1)}}(i,a,e.json.nodes),i}function mL(e,t){const r={};r.indexArray=new xn,r.indexArray.reserve(4*e.length),r.vertexArray=new Za,r.vertexArray.reserve(10*e.length),r.colorArray=new Ga,r.vertexArray.reserve(10*e.length);let n=0;for(const a of e){const l=Math.min(10,Math.max(4,1.3*a.height))*t,p=[-a.normal[1],a.normal[0],0],f=Math.min(.29,.1*a.width/a.depth),m=a.width-2*a.depth*t*(f+.01),_=q.scaleAndAdd([],a.pos,p,m/2),y=q.scaleAndAdd([],a.pos,p,-m/2),v=[_[0],_[1],_[2]+a.height],b=[y[0],y[1],y[2]+a.height],w=q.scaleAndAdd([],a.normal,p,f);q.scale(w,w,l);const E=q.scaleAndAdd([],a.normal,p,-f);q.scale(E,E,l),q.add(w,_,w),q.add(E,y,E),_[2]+=.1,y[2]+=.1,r.vertexArray.emplaceBack(w[0],w[1],w[2]),r.vertexArray.emplaceBack(E[0],E[1],E[2]),r.vertexArray.emplaceBack(_[0],_[1],_[2]),r.vertexArray.emplaceBack(y[0],y[1],y[2]),r.vertexArray.emplaceBack(v[0],v[1],v[2]),r.vertexArray.emplaceBack(b[0],b[1],b[2]),r.vertexArray.emplaceBack(_[0],_[1],_[2]),r.vertexArray.emplaceBack(y[0],y[1],y[2]),r.vertexArray.emplaceBack(w[0],w[1],w[2]),r.vertexArray.emplaceBack(E[0],E[1],E[2]);const T=m/l/2;r.colorArray.emplaceBack(-T-f,-1,T,.8),r.colorArray.emplaceBack(T+f,-1,T,.8),r.colorArray.emplaceBack(-T,0,T,1.3),r.colorArray.emplaceBack(T,0,T,1.3),r.colorArray.emplaceBack(T+f,-.8,T,.7),r.colorArray.emplaceBack(T+f,-.8,T,.7),r.colorArray.emplaceBack(0,0,T,1.3),r.colorArray.emplaceBack(0,0,T,1.3),r.colorArray.emplaceBack(T+f,-1.2,T,.8),r.colorArray.emplaceBack(T+f,-1.2,T,.8),r.indexArray.emplaceBack(6+n,4+n,8+n),r.indexArray.emplaceBack(7+n,9+n,5+n),r.indexArray.emplaceBack(0+n,1+n,2+n),r.indexArray.emplaceBack(1+n,3+n,2+n),n+=10}const i={defined:!0,emissiveFactor:[0,0,0]},s={};return s.baseColorFactor=Se.white,i.pbrMetallicRoughness=s,r.material=i,r.aabb=new Zr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),r}function gL(){return Ld.workerClass!=null?new Ld.workerClass:new S.Worker(Ld.workerUrl)}const hy="mapboxgl_preloaded_worker_pool";class uc{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<uc.workerCount;)this.workers.push(new gL);return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.numActive()===0&&(this.workers.forEach(r=>{r.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[hy]}numActive(){return Object.keys(this.active).length}}let Gh;function jh(){return Gh||(Gh=new uc),Gh}uc.workerCount=2;let qh,py,fy=null;const _L=B.LOADERS_URL;function PE(){return gt()&&self.worker&&self.worker.loadersUrl?self.worker.loadersUrl:py||_L}async function LE(){if(qh&&await qh,typeof mapboxglLoaders>"u"){const t=PE();try{e=t,qh=gt()?(importScripts(e),new Promise(r=>r())):new Promise((r,n)=>{const i=document.createElement("script");i.src=e,i.onload=r,i.onerror=n,document.head.appendChild(i),i.src=e}),await qh}catch{Y(`Could not load bundle from ${t}.`)}}var e;qh=void 0}async function DE(e){return await LE(),mapboxglLoaders.load(e,mapboxglLoaders.GLTFLoader,{gltf:{postProcess:!1,loadBuffers:!0,loadImages:!0}})}const dy={vector:IE,raster:Uh,"raster-dem":class extends Uh{constructor(e,t,r,n){super(e,t,r,n),this.type="raster-dem",this.maxzoom=22,this._options=Yt({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(e,t){const r=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function n(i,s){i&&(e.state="errored",t(i)),s&&(e.dem=s,e.dem.onDeserialize(),e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0,e.state="loaded",t(null))}e.request=Ke(this.map._requestManager.transformRequest(r,ct.Tile),(function(i,s,a,l){if(delete e.request,e.aborted)e.state="unloaded",t(null);else if(i)e.state="errored",t(i);else if(s){this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:a,expires:l});const f=S.ImageBitmap&&s instanceof S.ImageBitmap&&(uy==null&&(uy=S.OffscreenCanvas&&new S.OffscreenCanvas(1,1).getContext("2d")&&typeof S.createImageBitmap=="function"),uy),m=1-(s.width-((p=s.width)<=1?1:Math.pow(2,Math.floor(Math.log(p)/Math.LN2))))/2;m<1||e.neighboringTiles||(e.neighboringTiles=this._getNeighboringTiles(e.tileID));const _=f?s:ge.getImageData(s,m),y={uid:e.uid,coord:e.tileID,source:this.id,scope:this.scope,rawImageData:_,encoding:this.encoding,padding:m};e.actor&&e.state!=="expired"||(e.actor=this.dispatcher.getActor(),e.actor.send("loadDEMTile",y,n.bind(this),void 0,!0))}var p}).bind(this))}_getNeighboringTiles(e){const t=e.canonical,r=Math.pow(2,t.z),n=(t.x-1+r)%r,i=t.x===0?e.wrap-1:e.wrap,s=(t.x+1+r)%r,a=t.x+1===r?e.wrap+1:e.wrap,l={};return l[new wr(e.overscaledZ,i,t.z,n,t.y).key]={backfilled:!1},l[new wr(e.overscaledZ,a,t.z,s,t.y).key]={backfilled:!1},t.y>0&&(l[new wr(e.overscaledZ,i,t.z,n,t.y-1).key]={backfilled:!1},l[new wr(e.overscaledZ,e.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},l[new wr(e.overscaledZ,a,t.z,s,t.y-1).key]={backfilled:!1}),t.y+1<r&&(l[new wr(e.overscaledZ,i,t.z,n,t.y+1).key]={backfilled:!1},l[new wr(e.overscaledZ,e.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},l[new wr(e.overscaledZ,a,t.z,s,t.y+1).key]={backfilled:!1}),l}unloadTile(e){e.demTexture&&this.map.painter.saveTileTexture(e.demTexture),e.fbo&&(e.fbo.destroy(),delete e.fbo),e.dem&&delete e.dem,delete e.neighboringTiles,e.state="unloaded"}},geojson:class extends hn{constructor(e,t,r,n){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=r.getActor(),this.setEventedParent(n),this._data=t.data,this._options=Yt({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const i=lt/this.tileSize;this.workerOptions=Yt({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*i,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*i,extent:lt,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:lt,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*i,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter},t.workerOptions)}onAdd(e){this.map=e,this.setData(this._data)}setData(e){return this._data=e,this._updateWorkerData(),this}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterLeaves(e,t,r,n){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:e,limit:t,offset:r},n),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new wt("dataloading",{dataType:"source"})),this._loaded=!1;const e=Yt({},this.workerOptions);e.scope=this.scope;const t=this._data;typeof t=="string"?(e.request=this.map._requestManager.transformRequest(ge.resolveURL(t),ct.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(t),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,(r,n)=>{if(this._loaded=!0,this._pendingLoad=null,r)this.fire(new fe(r));else{const i={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&n&&n.resourceTiming&&n.resourceTiming[this.id]&&(i.resourceTiming=n.resourceTiming[this.id]),this.fire(new wt("data",i)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(e,t){const r=e.actor?"reloadTile":"loadTile";e.actor=this.actor;const n={type:this.type,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:ge.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};e.request=this.actor.send(r,n,(i,s)=>(delete e.request,e.unloadVectorData(),e.aborted?t(null):i?t(i):(e.loadVectorData(s,this.map.painter,r==="reloadTile"),t(null))),void 0,r==="loadTile")}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0}unloadTile(e){e.unloadVectorData(),this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Yt({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Wl{constructor(e,t,r,n){super(e,t,r,n),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const e=this.options;this.urls=[];for(const t of e.urls)this.urls.push(this.map._requestManager.transformRequest(t,ct.Source).url);(function(t,r){const n=S.document.createElement("video");n.muted=!0,n.onloadstart=function(){r(null,n)};for(let i=0;i<t.length;i++){const s=S.document.createElement("source");At(t[i])||(n.crossOrigin="Anonymous"),s.src=t[i],n.appendChild(s)}})(this.urls,(t,r)=>{this._loaded=!0,t?this.fire(new fe(t)):r&&(this.video=r,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const t=this.video.seekable;e<t.start(0)||e>t.end(0)?this.fire(new fe(new Vt(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const e=this.map.painter.context,t=e.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new dn(e,this.video,t.RGBA),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(e)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Wl,model:class extends hn{constructor(e,t,r,n){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=t}async load(){for(const e in this._options.models){const t=this._options.models[e],r=cy(await DE(t.uri)),n=new Fw(e,t.uri,t.position,t.orientation,r);n.computeBoundsAndApplyParent(),this.models.push(n)}this._loaded=!0,this.fire(new wt("data",{dataType:"source",sourceDataType:"metadata"}))}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,t){}serialize(){return{type:"model"}}},"batched-model":class extends hn{constructor(e,t,r,n){super(),this.type="batched-model",this.id=e,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=r,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(n)}onAdd(e){this.map=e,this.load()}load(e){this._loaded=!1,this.fire(new wt("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,r=this.map._worldview;this._tileJSONRequest=ay(this._options,this.map._requestManager,t,r,(n,i)=>{this._tileJSONRequest=null,this._loaded=!0,n?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),r&&r.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${r}`),this.fire(new fe(n))):i&&(Yt(this,i),i.bounds&&(this.tileBounds=new md(i.bounds,this.minzoom,this.maxzoom)),pm(i.tiles,this.map._requestManager._customAccessToken),this.fire(new wt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new wt("data",{dataType:"source",sourceDataType:"content"}))),e&&e(n)})}hasTransition(){return!1}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loaded(){return this._loaded}loadTile(e,t){const r=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),n={request:this.map._requestManager.transformRequest(r,ct.Tile),data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:e.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(e.actor&&e.state!=="expired")if(e.state==="loading")e.reloadCallback=t;else{if(e.buckets){const s=Object.values(e.buckets);for(const a of s)a.dirty=!0;return void(e.state="loaded")}e.request=e.actor.send("reloadTile",n,i.bind(this))}else e.actor=this.dispatcher.getActor(),e.request=e.actor.send("loadTile",n,i.bind(this),void 0,!0);function i(s,a){return e.aborted?t(null):s?t(s):(a&&(a.resourceTiming&&(e.resourceTiming=a.resourceTiming),this.map._refreshExpiredTiles&&e.setExpiryData(a),e.buckets={...e.buckets,...a.buckets}),e.state="loaded",void t(null))}}serialize(){return{type:"batched-model"}}},canvas:class extends Wl{constructor(e,t,r,n){super(e,t,r,n),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(i=>!Array.isArray(i)||i.length!==2||i.some(s=>typeof s!="number"))||this.fire(new fe(new Vt(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new fe(new Vt(`sources.${e}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new fe(new Vt(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof S.HTMLCanvasElement||this.fire(new fe(new Vt(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new fe(new Vt(`sources.${e}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof S.HTMLCanvasElement?this.options.canvas:S.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new fe(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?(e||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new dn(t,this.canvas,t.gl.RGBA,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}},custom:class extends hn{constructor(e,t,r,n){super(),this.id=e,this.type="custom",this._dataType="raster",this._dispatcher=r,this._implementation=t,this.setEventedParent(n),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new fe(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new fe(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new md(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Yt(this,Zi(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return Zi(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new wt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new wt("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(e){this._map=e,this._loaded=!1,this.fire(new wt("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(e),this.load()}onRemove(e){this._implementation.onRemove&&this._implementation.onRemove(e)}hasTile(e){if(this._implementation.hasTile){const{x:t,y:r,z:n}=e.canonical;return this._implementation.hasTile({x:t,y:r,z:n})}return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,t){const{x:r,y:n,z:i}=e.tileID.canonical,s=new S.AbortController;e.request=Promise.resolve(this._implementation.loadTile({x:r,y:n,z:i},{signal:s.signal})).then((function(a){return delete e.request,e.aborted?(e.state="unloaded",t(null)):a===void 0?(e.state="errored",t(null)):a===null?(this.loadTileData(e,{width:this.tileSize,height:this.tileSize,data:null}),e.state="loaded",t(null)):function(l){return l instanceof S.ImageData||l instanceof S.HTMLCanvasElement||l instanceof S.ImageBitmap||l instanceof S.HTMLImageElement}(a)?(this.loadTileData(e,a),e.state="loaded",void t(null)):(e.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(a=>{a.code!==20&&(e.state="errored",t(a))}),e.request.cancel=()=>s.abort()}loadTileData(e,t){Uh.loadTileData(e,t,this._map.painter)}unloadTileData(e){Uh.unloadTileData(e,this._map.painter)}unloadTile(e,t){if(this.unloadTileData(e),this._implementation.unloadTile){const{x:r,y:n,z:i}=e.tileID.canonical;this._implementation.unloadTile({x:r,y:n,z:i})}t()}abortTile(e,t){e.request&&e.request.cancel&&(e.request.cancel(),delete e.request),t()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(e=>({x:e.canonical.x,y:e.canonical.y,z:e.canonical.z}))}_clearTiles(){this._map.style._clearSource(this.id)}_update(){this.fire(new wt("data",{dataType:"source",sourceDataType:"content"}))}}},my=function(e,t,r,n){const i=new dy[t.type](e,t,r,n);if(i.id!==e)throw new Error(`Expected Source id to be ${e} instead of ${i.id}`);return Ln(["load","abort","unload","serialize","prepare"],i),i};function yL(e,t){const r=Q.identity([]);return Q.scale(r,r,[.5*e.width,.5*-e.height,1]),Q.translate(r,r,[1,-1,0]),Q.multiply(r,r,e.calculateProjMatrix(t.toUnwrapped())),Float32Array.from(r)}function vL(e,t,r,n,i,s,a,l=!1){const p=e.tilesIn(n,a,l);p.sort(RE);const f=[];for(const _ of p)f.push({wrappedTileID:_.tile.tileID.wrapped().key,queryResults:_.tile.queryRenderedFeatures(t,r,e._state,_,i,s,yL(e.transform,_.tile.tileID),l)});const m=function(_){const y={},v={};for(const b of _){const w=b.queryResults,E=b.wrappedTileID,T=v[E]=v[E]||{};for(const C in w){const M=w[C],A=T[C]=T[C]||{},P=y[C]=y[C]||[];for(const L of M)A[L.featureIndex]||(A[L.featureIndex]=!0,P.push(L))}}return y}(f);for(const _ in m)m[_].forEach(y=>{const v=y.feature,b=v.layer;b&&b.type!=="background"&&b.type!=="sky"&&b.type!=="slot"&&(v.source=b.source,b["source-layer"]&&(v.sourceLayer=b["source-layer"]),v.state=v.id!==void 0?e.getFeatureState(b["source-layer"],v.id):{})});return m}function xL(e,t){const r=e.getRenderableIds().map(s=>e.getTileByID(s)),n=[],i={};for(let s=0;s<r.length;s++){const a=r[s],l=a.tileID.canonical.key;i[l]||(i[l]=!0,a.querySourceFeatures(n,t))}return n}function RE(e,t){const r=e.tileID,n=t.tileID;return r.overscaledZ-n.overscaledZ||r.canonical.y-n.canonical.y||r.wrap-n.wrap||r.canonical.x-n.canonical.x}var OE=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function bL(e,t){const r={};for(const n in e)n!=="ref"&&(r[n]=e[n]);return OE.forEach(n=>{n in t&&(r[n]=t[n])}),r}function NE(e){e=e.slice();const t=Object.create(null);for(let r=0;r<e.length;r++)t[e[r].id]=e[r];for(let r=0;r<e.length;r++)"ref"in e[r]&&(e[r]=bL(e[r],t[e[r].ref]));return e}const _r={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection"};function zE(e,t,r){r.push({command:_r.addSource,args:[e,t[e]]})}function kE(e,t,r){t.push({command:_r.removeSource,args:[e]}),r[e]=!0}function wL(e,t,r,n){kE(e,r,n),zE(e,t,r)}function EL(e,t,r){let n;for(n in e[r])if(e[r].hasOwnProperty(n)&&n!=="data"&&!ue(e[r][n],t[r][n]))return!1;for(n in t[r])if(t[r].hasOwnProperty(n)&&n!=="data"&&!ue(e[r][n],t[r][n]))return!1;return!0}function gd(e,t,r,n,i,s){let a;for(a in t=t||{},e=e||{})e.hasOwnProperty(a)&&(ue(e[a],t[a])||r.push({command:s,args:[n,a,t[a],i]}));for(a in t)t.hasOwnProperty(a)&&!e.hasOwnProperty(a)&&(ue(e[a],t[a])||r.push({command:s,args:[n,a,t[a],i]}))}function FE(e){return e.id}function BE(e,t){return e[t.id]=t,e}class TL{constructor(t,r){this.reset(t,r)}reset(t,r){this.points=t||[],this._distances=[0];for(let n=1;n<this.points.length;n++)this._distances[n]=this._distances[n-1]+this.points[n].dist(this.points[n-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(r||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=Bt(t,0,1);let r=1,n=this._distances[r];const i=t*this.paddedLength+this.padding;for(;n<i&&r<this._distances.length;)n=this._distances[++r];const s=r-1,a=this._distances[s],l=n-a,p=l>0?(i-a)/l:0;return this.points[s].mult(1-p).add(this.points[r].mult(p))}}class VE{constructor(t,r,n){const i=this.boxCells=[],s=this.circleCells=[];this.xCellCount=Math.ceil(t/n),this.yCellCount=Math.ceil(r/n);for(let a=0;a<this.xCellCount*this.yCellCount;a++)i.push([]),s.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=r,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/r,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,r,n,i,s){this._forEachCell(r,n,i,s,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(r),this.bboxes.push(n),this.bboxes.push(i),this.bboxes.push(s)}insertCircle(t,r,n,i){this._forEachCell(r-i,n-i,r+i,n+i,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(r),this.circles.push(n),this.circles.push(i)}_insertBoxCell(t,r,n,i,s,a){this.boxCells[s].push(a)}_insertCircleCell(t,r,n,i,s,a){this.circleCells[s].push(a)}_query(t,r,n,i,s,a){if(n<0||t>this.width||i<0||r>this.height)return!s&&[];const l=[];if(t<=0&&r<=0&&this.width<=n&&this.height<=i){if(s)return!0;for(let p=0;p<this.boxKeys.length;p++)l.push({key:this.boxKeys[p],x1:this.bboxes[4*p],y1:this.bboxes[4*p+1],x2:this.bboxes[4*p+2],y2:this.bboxes[4*p+3]});for(let p=0;p<this.circleKeys.length;p++){const f=this.circles[3*p],m=this.circles[3*p+1],_=this.circles[3*p+2];l.push({key:this.circleKeys[p],x1:f-_,y1:m-_,x2:f+_,y2:m+_})}return a?l.filter(a):l}return this._forEachCell(t,r,n,i,this._queryCell,l,{hitTest:s,seenUids:{box:{},circle:{}}},a),s?l.length>0:l}_queryCircle(t,r,n,i,s){const a=t-n,l=t+n,p=r-n,f=r+n;if(l<0||a>this.width||f<0||p>this.height)return!i&&[];const m=[];return this._forEachCell(a,p,l,f,this._queryCellCircle,m,{hitTest:i,circle:{x:t,y:r,radius:n},seenUids:{box:{},circle:{}}},s),i?m.length>0:m}query(t,r,n,i,s){return this._query(t,r,n,i,!1,s)}hitTest(t,r,n,i,s){return this._query(t,r,n,i,!0,s)}hitTestCircle(t,r,n,i){return this._queryCircle(t,r,n,!0,i)}_queryCell(t,r,n,i,s,a,l,p){const f=l.seenUids,m=this.boxCells[s];if(m!==null){const y=this.bboxes;for(const v of m)if(!f.box[v]){f.box[v]=!0;const b=4*v;if(t<=y[b+2]&&r<=y[b+3]&&n>=y[b+0]&&i>=y[b+1]&&(!p||p(this.boxKeys[v]))){if(l.hitTest)return a.push(!0),!0;a.push({key:this.boxKeys[v],x1:y[b],y1:y[b+1],x2:y[b+2],y2:y[b+3]})}}}const _=this.circleCells[s];if(_!==null){const y=this.circles;for(const v of _)if(!f.circle[v]){f.circle[v]=!0;const b=3*v;if(this._circleAndRectCollide(y[b],y[b+1],y[b+2],t,r,n,i)&&(!p||p(this.circleKeys[v]))){if(l.hitTest)return a.push(!0),!0;{const w=y[b],E=y[b+1],T=y[b+2];a.push({key:this.circleKeys[v],x1:w-T,y1:E-T,x2:w+T,y2:E+T})}}}}}_queryCellCircle(t,r,n,i,s,a,l,p){const f=l.circle,m=l.seenUids,_=this.boxCells[s];if(_!==null){const v=this.bboxes;for(const b of _)if(!m.box[b]){m.box[b]=!0;const w=4*b;if(this._circleAndRectCollide(f.x,f.y,f.radius,v[w+0],v[w+1],v[w+2],v[w+3])&&(!p||p(this.boxKeys[b])))return a.push(!0),!0}}const y=this.circleCells[s];if(y!==null){const v=this.circles;for(const b of y)if(!m.circle[b]){m.circle[b]=!0;const w=3*b;if(this._circlesCollide(v[w],v[w+1],v[w+2],f.x,f.y,f.radius)&&(!p||p(this.circleKeys[b])))return a.push(!0),!0}}}_forEachCell(t,r,n,i,s,a,l,p){const f=this._convertToXCellCoord(t),m=this._convertToYCellCoord(r),_=this._convertToXCellCoord(n),y=this._convertToYCellCoord(i);for(let v=f;v<=_;v++)for(let b=m;b<=y;b++)if(s.call(this,t,r,n,i,this.xCellCount*b+v,a,l,p))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,r,n,i,s,a){const l=i-t,p=s-r,f=n+a;return f*f>l*l+p*p}_circleAndRectCollide(t,r,n,i,s,a,l){const p=(a-i)/2,f=Math.abs(t-(i+p));if(f>p+n)return!1;const m=(l-s)/2,_=Math.abs(r-(s+m));if(_>m+n)return!1;if(f<=p||_<=m)return!0;const y=f-p,v=_-m;return y*y+v*v<=n*n}}const Vs=100;class IL{constructor(t,r,n=new VE(t.width+200,t.height+200,25),i=new VE(t.width+200,t.height+200,25)){this.transform=t,this.grid=n,this.ignoredGrid=i,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Vs,this.screenBottomBoundary=t.height+Vs,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=r}placeCollisionBox(t,r,n,i,s,a,l,p){let f=n.projectedAnchorX,m=n.projectedAnchorY,_=n.projectedAnchorZ;const y=n.elevation,v=n.tileID,b=t.getProjection();if(y&&v){const[L,R,N]=b.upVector(v.canonical,n.tileAnchorX,n.tileAnchorY),k=b.upVectorScale(v.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;f+=L*y*k,m+=R*y*k,_+=N*y*k}const w=this.projectAndGetPerspectiveRatio(l,f,m,_,n.tileID,b.name==="globe"||!!y||this.transform.pitch>0,b),E=a*w.perspectiveRatio,T=(n.x1*r+i.x-n.padding)*E+w.point.x,C=(n.y1*r+i.y-n.padding)*E+w.point.y,M=(n.x2*r+i.x+n.padding)*E+w.point.x,A=(n.y2*r+i.y+n.padding)*E+w.point.y,P=w.perspectiveRatio<=.55||w.occluded;return!this.isInsideGrid(T,C,M,A)||!s&&this.grid.hitTest(T,C,M,A,p)||P?{box:[],offscreen:!1,occluded:w.occluded}:{box:[T,C,M,A],offscreen:this.isOffscreen(T,C,M,A),occluded:!1}}placeCollisionCircles(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w){const E=[],T=this.transform.elevation,C=t.getProjection(),M=T?T.getAtTileOffsetFunc(w,this.transform.center.lat,this.transform.worldSize,C):null,A=new H(n.tileAnchorX,n.tileAnchorY);let{x:P,y:L,z:R}=C.projectTilePoint(A.x,A.y,w.canonical);if(M){const[tt,X,J]=M(A);P+=tt,L+=X,R+=J}const N=C.name==="globe",k=this.projectAndGetPerspectiveRatio(l,P,L,R,w,N||!!T||this.transform.pitch>0,C),{perspectiveRatio:F}=k,z=(_?a/F:a*F)/Nn,U=ms(P,L,R,p),G=k.signedDistanceFromCamera>0?Mw(z,s,n.lineOffsetX*z,n.lineOffsetY*z,!1,U,A,n,i,p,{},T&&!_?M:null,_&&!!T,C,w,_):null;let V=!1,K=!1,$=!0;if(G&&!k.occluded){const tt=.5*v*F+b,X=new H(-100,-100),J=new H(this.screenRightBoundary,this.screenBottomBoundary),nt=new TL,{first:at,last:ot}=G,It=at.path.length;let xt=[];for(let Ot=It-1;Ot>=1;Ot--)xt.push(at.path[Ot]);for(let Ot=1;Ot<ot.path.length;Ot++)xt.push(ot.path[Ot]);const dt=2.5*tt;f&&(xt=xt.map(([Ot,Jt,Zt],Gt)=>(M&&!N&&(Zt=M(Gt<It-1?at.tilePath[It-1-Gt]:ot.tilePath[Gt-It+2])[2]),ms(Ot,Jt,Zt,f))),xt.some(Ot=>Ot[3]<=0)&&(xt=[]));let yt=[];if(xt.length>0){let Ot=1/0,Jt=-1/0,Zt=1/0,Gt=-1/0;for(const Qt of xt)Ot=Math.min(Ot,Qt[0]),Zt=Math.min(Zt,Qt[1]),Jt=Math.max(Jt,Qt[0]),Gt=Math.max(Gt,Qt[1]);Jt>=X.x&&Ot<=J.x&&Gt>=X.y&&Zt<=J.y&&(yt=[xt.map(Qt=>new H(Qt[0],Qt[1]))],(Ot<X.x||Jt>J.x||Zt<X.y||Gt>J.y)&&(yt=Kb(yt,X.x,X.y,J.x,J.y)))}for(const Ot of yt){nt.reset(Ot,.25*tt);let Jt=0;Jt=nt.length<=.5*tt?1:Math.ceil(nt.paddedLength/dt)+1;for(let Zt=0;Zt<Jt;Zt++){const Gt=Zt/Math.max(Jt-1,1),Qt=nt.lerp(Gt),Re=Qt.x+Vs,Le=Qt.y+Vs;E.push(Re,Le,tt,0);const er=Re-tt,De=Le-tt,Oe=Re+tt,ae=Le+tt;if($=$&&this.isOffscreen(er,De,Oe,ae),K=K||this.isInsideGrid(er,De,Oe,ae),!r&&this.grid.hitTestCircle(Re,Le,tt,y)&&(V=!0,!m))return{circles:[],offscreen:!1,collisionDetected:V,occluded:!1}}}}return{circles:!m&&V||!K?[]:E,offscreen:$,collisionDetected:V,occluded:k.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const r=[];let n=1/0,i=1/0,s=-1/0,a=-1/0;for(const m of t){const _=new H(m.x+Vs,m.y+Vs);n=Math.min(n,_.x),i=Math.min(i,_.y),s=Math.max(s,_.x),a=Math.max(a,_.y),r.push(_)}const l=this.grid.query(n,i,s,a).concat(this.ignoredGrid.query(n,i,s,a)),p={},f={};for(const m of l){const _=m.key;p[_.bucketInstanceId]===void 0&&(p[_.bucketInstanceId]={}),p[_.bucketInstanceId][_.featureIndex]||eb(r,[new H(m.x1,m.y1),new H(m.x2,m.y1),new H(m.x2,m.y2),new H(m.x1,m.y2)])&&(p[_.bucketInstanceId][_.featureIndex]=!0,f[_.bucketInstanceId]===void 0&&(f[_.bucketInstanceId]=[]),f[_.bucketInstanceId].push(_.featureIndex))}return f}insertCollisionBox(t,r,n,i,s){(r?this.ignoredGrid:this.grid).insert({bucketInstanceId:n,featureIndex:i,collisionGroupID:s},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,r,n,i,s){const a=r?this.ignoredGrid:this.grid,l={bucketInstanceId:n,featureIndex:i,collisionGroupID:s};for(let p=0;p<t.length;p+=4)a.insertCircle(l,t[p],t[p+1],t[p+2])}projectAndGetPerspectiveRatio(t,r,n,i,s,a,l){const p=[r,n,i,1];let f=!1;i||this.transform.pitch>0?(gr.transformMat4(p,p,t),this.fogState&&s&&l.name!=="globe"&&(f=function(y,v,b,w,E,T){const C=T.calculateFogTileMatrix(E),M=[v,b,w];return q.transformMat4(M,M,C),mE(y,M,T.pitch,T._fov)}(this.fogState,r,n,i,s.toUnwrapped(),this.transform)>.9)):Rw(p,p,t);const m=p[3];return{point:new H((p[0]/m+1)/2*this.transform.width+Vs,(-p[1]/m+1)/2*this.transform.height+Vs),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(l)/m*.5,1.5),signedDistanceFromCamera:m,occluded:a&&p[2]>m||f}}isOffscreen(t,r,n,i){return n<Vs||t>=this.screenRightBoundary||i<Vs||r>this.screenBottomBoundary}isInsideGrid(t,r,n,i){return n>=0&&t<this.gridRightBoundary&&i>=0&&r<this.gridBottomBoundary}getViewportMatrix(){const t=Q.identity([]);return Q.translate(t,t,[-100,-100,0]),t}}function gy(e,t,r){const n=t.createTileMatrix(e,e.worldSize,r.toUnwrapped());return Q.multiply(new Float32Array(16),e.projMatrix,n)}function SL(e,t,r){if(t.projection.name===r.projection.name)return e.projMatrix;const n=r.clone();return n.setProjection(t.projection),gy(n,t.getProjection(),e)}function _y(e,t,r){return t.name===r.projection.name?e.projMatrix:gy(r,t,e)}class UE{constructor(t,r,n,i){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?r:-r))):i&&n?1:0,this.placed=n}isHidden(){return this.opacity===0&&!this.placed}}class Zh{constructor(t,r,n,i,s,a=!1){this.text=new UE(t?t.text:null,r,n,s),this.icon=new UE(t?t.icon:null,r,i,s),this.clipped=a}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class yy{constructor(t,r,n,i=!1){this.text=t,this.icon=r,this.skipFade=n,this.clipped=i}}class CL{constructor(){this.invProjMatrix=Q.create(),this.viewportMatrix=Q.create(),this.circles=[]}}class ML{constructor(t,r,n,i,s){this.bucketInstanceId=t,this.featureIndex=r,this.sourceLayerIndex=n,this.bucketIndex=i,this.tileID=s}}class AL{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const r=++this.maxGroupID;this.collisionGroups[t]={ID:r,predicate:n=>n.collisionGroupID===r}}return this.collisionGroups[t]}}function GE(e,t,r,n,i){const{horizontalAlign:s,verticalAlign:a}=Gf(e),l=-(s-.5)*t,p=-(a-.5)*r,f=G_(e,n);return new H(l+f[0]*i,p+f[1]*i)}function vy(e,t,r,n,i){const s=new H(e,t);return r&&s._rotate(n?i:-i),s}class PL{constructor(t,r,n,i,s){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new IL(this.transform,s),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=r,this.retainedQueryData={},this.collisionGroups=new AL(n),this.collisionCircleArrays={},this.prevPlacement=i,i&&(i.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,r,n,i){const s=n.getBucket(r),a=n.latestFeatureIndex;if(!s||!a||r.id!==s.layerIds[0])return;const l=s.layers[0].layout,p=n.collisionBoxArray,f=Math.pow(2,this.transform.zoom-n.tileID.overscaledZ),m=n.tileSize/lt,_=n.tileID.toUnwrapped();this.transform.setProjection(s.projection);const y=(v=n.tileID,b=s.getProjection(),w=this.transform,b.name===this.projection?w.calculateProjMatrix(v.toUnwrapped()):gy(w,b,v));var v,b,w;const E=l.get("text-pitch-alignment")==="map",T=l.get("text-rotation-alignment")==="map";r.compileFilter();const C=r.dynamicFilter(),M=r.dynamicFilterNeedsFeature(),A=this.transform.calculatePixelsToTileUnitsMatrix(n),P=Iw(y,n.tileID.canonical,E,T,this.transform,s.getProjection(),A);let L=null;if(E){const k=Sw(y,n.tileID.canonical,E,T,this.transform,s.getProjection(),A);L=Q.multiply([],this.transform.labelPlaneMatrix,k)}let R=null;C&&n.latestFeatureIndex&&(R={unwrappedTileID:_,dynamicFilter:C,dynamicFilterNeedsFeature:M,featureIndex:n.latestFeatureIndex}),this.retainedQueryData[s.bucketInstanceId]=new ML(s.bucketInstanceId,a,s.sourceLayerIndex,s.index,n.tileID);const N={bucket:s,layout:l,posMatrix:y,textLabelPlaneMatrix:P,labelToScreenMatrix:L,clippingData:R,scale:f,textPixelRatio:m,holdingForFade:n.holdingForFade(),collisionBoxArray:p,partiallyEvaluatedTextSize:ks(s.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:ks(s.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(s.sourceID)};if(i)for(const k of s.sortKeyRanges){const{sortKey:F,symbolInstanceStart:z,symbolInstanceEnd:U}=k;t.push({sortKey:F,symbolInstanceStart:z,symbolInstanceEnd:U,parameters:N})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:s.symbolInstances.length,parameters:N})}attemptAnchorPlacement(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T,C){const{textOffset0:M,textOffset1:A,crossTileID:P}=y,L=[M,A],R=GE(t,n,i,L,s),N=this.collisionIndex.placeCollisionBox(b,s,r,vy(R.x,R.y,a,l,this.transform.angle),_,p,f,m.predicate);if(E){const k=b.getSymbolInstanceIconSize(C,this.transform.zoom,y.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(b,k,E,vy(R.x,R.y,a,l,this.transform.angle),_,p,f,m.predicate).box.length===0)return}if(N.box.length>0){let k;return this.prevPlacement&&this.prevPlacement.variableOffsets[P]&&this.prevPlacement.placements[P]&&this.prevPlacement.placements[P].text&&(k=this.prevPlacement.variableOffsets[P].anchor),this.variableOffsets[P]={textOffset:L,width:n,height:i,anchor:t,textScale:s,prevAnchor:k},this.markUsedJustification(b,t,y,w),b.allowVerticalPlacement&&(this.markUsedOrientation(b,w,y),this.placedOrientations[P]=w),{shift:R,placedGlyphBoxes:N}}}placeLayerBucketPart(t,r,n,i){const{bucket:s,layout:a,posMatrix:l,textLabelPlaneMatrix:p,labelToScreenMatrix:f,clippingData:m,textPixelRatio:_,holdingForFade:y,collisionBoxArray:v,partiallyEvaluatedTextSize:b,partiallyEvaluatedIconSize:w,collisionGroup:E}=t.parameters,T=a.get("text-optional"),C=a.get("icon-optional"),M=a.get("text-allow-overlap"),A=a.get("icon-allow-overlap"),P=a.get("text-rotation-alignment")==="map",L=a.get("text-pitch-alignment")==="map",R=a.get("symbol-z-order")==="viewport-y";this.transform.setProjection(s.projection);let N=M&&(A||!s.hasIconData()||C),k=A&&(M||!s.hasTextData()||T);!s.collisionArrays&&v&&s.deserializeCollisionBoxes(v),n&&i&&s.updateCollisionDebugBuffers(this.transform.zoom,v);const F=(z,U,G)=>{const{crossTileID:V,numVerticalGlyphVertices:K}=z;if(m){const De={zoom:this.transform.zoom,pitch:this.transform.pitch};let Oe=null;if(m.dynamicFilterNeedsFeature){const ae=this.retainedQueryData[s.bucketInstanceId];Oe=m.featureIndex.loadFeature({featureIndex:z.featureIndex,bucketIndex:ae.bucketIndex,sourceLayerIndex:ae.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,m.dynamicFilter)(De,Oe,this.retainedQueryData[s.bucketInstanceId].tileID.canonical,new H(z.tileAnchorX,z.tileAnchorY),this.transform.calculateDistanceTileData(m.unwrappedTileID)))return this.placements[V]=new yy(!1,!1,!1,!0),void r.add(V)}if(r.has(V))return;if(y)return void(this.placements[V]=new yy(!1,!1,!1));let $=!1,tt=!1,X=!0,J=!1,nt=!1,at=null,ot={box:null,offscreen:null,occluded:null},It={box:null,offscreen:null,occluded:null},xt=null,dt=null,yt=null,Ot=0,Jt=0,Zt=0;G.textFeatureIndex?Ot=G.textFeatureIndex:z.useRuntimeCollisionCircles&&(Ot=z.featureIndex),G.verticalTextFeatureIndex&&(Jt=G.verticalTextFeatureIndex);const Gt=De=>{De.tileID=this.retainedQueryData[s.bucketInstanceId].tileID;const Oe=this.transform.elevation;(Oe||De.elevation)&&(De.elevation=Oe?Oe.getAtTileOffset(De.tileID,De.tileAnchorX,De.tileAnchorY):0)},Qt=G.textBox;if(Qt){Gt(Qt);const De=ae=>{let Me=Dr.horizontal;if(s.allowVerticalPlacement&&!ae&&this.prevPlacement){const rr=this.prevPlacement.placedOrientations[V];rr&&(this.placedOrientations[V]=rr,Me=rr,this.markUsedOrientation(s,Me,z))}return Me},Oe=(ae,Me)=>{if(s.allowVerticalPlacement&&K>0&&G.verticalTextBox){for(const rr of s.writingModes)if(rr===Dr.vertical?(ot=Me(),It=ot):ot=ae(),ot&&ot.box&&ot.box.length)break}else ot=ae()};if(a.get("text-variable-anchor")){let ae=a.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[V]){const Ae=this.prevPlacement.variableOffsets[V];ae.indexOf(Ae.anchor)>0&&(ae=ae.filter(ar=>ar!==Ae.anchor),ae.unshift(Ae.anchor))}const Me=(Ae,ar,tn)=>{const en=s.getSymbolInstanceTextSize(b,z,this.transform.zoom,U),Br=(Ae.x2-Ae.x1)*en+2*Ae.padding,Mr=(Ae.y2-Ae.y1)*en+2*Ae.padding,mn=z.hasIconTextFit&&!A?ar:null;mn&&Gt(mn);let zr={box:[],offscreen:!1,occluded:!1};const wn=M?2*ae.length:ae.length;for(let lr=0;lr<wn;++lr){const zi=this.attemptAnchorPlacement(ae[lr%ae.length],Ae,Br,Mr,en,P,L,_,l,E,lr>=ae.length,z,U,s,tn,mn,b,w);if(zi&&(zr=zi.placedGlyphBoxes,zr&&zr.box&&zr.box.length)){$=!0,at=zi.shift;break}}return zr};Oe(()=>Me(Qt,G.iconBox,Dr.horizontal),()=>{const Ae=G.verticalTextBox;return Ae&&Gt(Ae),s.allowVerticalPlacement&&!(ot&&ot.box&&ot.box.length)&&K>0&&Ae?Me(Ae,G.verticalIconBox,Dr.vertical):{box:null,offscreen:null,occluded:null}}),ot&&($=ot.box,X=ot.offscreen,J=ot.occluded);const rr=De(!(!ot||!ot.box));if(!$&&this.prevPlacement){const Ae=this.prevPlacement.variableOffsets[V];Ae&&(this.variableOffsets[V]=Ae,this.markUsedJustification(s,Ae.anchor,z,rr))}}else{const ae=(Me,rr)=>{const Ae=s.getSymbolInstanceTextSize(b,z,this.transform.zoom,U),ar=this.collisionIndex.placeCollisionBox(s,Ae,Me,new H(0,0),M,_,l,E.predicate);return ar&&ar.box&&ar.box.length&&(this.markUsedOrientation(s,rr,z),this.placedOrientations[V]=rr),ar};Oe(()=>ae(Qt,Dr.horizontal),()=>{const Me=G.verticalTextBox;return s.allowVerticalPlacement&&K>0&&Me?(Gt(Me),ae(Me,Dr.vertical)):{box:null,offscreen:null,occluded:null}}),De(!!(ot&&ot.box&&ot.box.length))}}if(xt=ot,$=xt&&xt.box&&xt.box.length>0,X=xt&&xt.offscreen,J=xt&&xt.occluded,z.useRuntimeCollisionCircles){const De=s.text.placedSymbolArray.get(z.centerJustifiedTextSymbolIndex>=0?z.centerJustifiedTextSymbolIndex:z.verticalPlacedTextSymbolIndex),Oe=wh(s.textSizeData,b,De),ae=a.get("text-padding");dt=this.collisionIndex.placeCollisionCircles(s,M,De,s.lineVertexArray,s.glyphOffsetArray,Oe,l,p,f,n,L,E.predicate,z.collisionCircleDiameter*Oe/Nn,ae,this.retainedQueryData[s.bucketInstanceId].tileID),$=M||dt.circles.length>0&&!dt.collisionDetected,X=X&&dt.offscreen,J=dt.occluded}if(G.iconFeatureIndex&&(Zt=G.iconFeatureIndex),G.iconBox){const De=Oe=>{Gt(Oe);const ae=z.hasIconTextFit&&at?vy(at.x,at.y,P,L,this.transform.angle):new H(0,0),Me=s.getSymbolInstanceIconSize(w,this.transform.zoom,z.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(s,Me,Oe,ae,A,_,l,E.predicate)};It&&It.box&&It.box.length&&G.verticalIconBox?(yt=De(G.verticalIconBox),tt=yt.box.length>0):(yt=De(G.iconBox),tt=yt.box.length>0),X=X&&yt.offscreen,nt=yt.occluded}const Re=T||z.numHorizontalGlyphVertices===0&&K===0,Le=C||z.numIconVertices===0;if(Re||Le?Le?Re||(tt=tt&&$):$=tt&&$:tt=$=tt&&$,$&&xt&&xt.box&&this.collisionIndex.insertCollisionBox(xt.box,a.get("text-ignore-placement"),s.bucketInstanceId,It&&It.box&&Jt?Jt:Ot,E.ID),tt&&yt&&this.collisionIndex.insertCollisionBox(yt.box,a.get("icon-ignore-placement"),s.bucketInstanceId,Zt,E.ID),dt&&($&&this.collisionIndex.insertCollisionCircles(dt.circles,a.get("text-ignore-placement"),s.bucketInstanceId,Ot,E.ID),n)){const De=s.bucketInstanceId;let Oe=this.collisionCircleArrays[De];Oe===void 0&&(Oe=this.collisionCircleArrays[De]=new CL);for(let ae=0;ae<dt.circles.length;ae+=4)Oe.circles.push(dt.circles[ae+0]),Oe.circles.push(dt.circles[ae+1]),Oe.circles.push(dt.circles[ae+2]),Oe.circles.push(dt.collisionDetected?1:0)}const er=s.projection.name!=="globe";N=N&&(er||!J),k=k&&(er||!nt),this.placements[V]=new yy($||N,tt||k,X||s.justReloaded),r.add(V)};if(R){const z=s.getSortedSymbolIndexes(this.transform.angle);for(let U=z.length-1;U>=0;--U){const G=z[U];F(s.symbolInstances.get(G),G,s.collisionArrays[G])}}else for(let z=t.symbolInstanceStart;z<t.symbolInstanceEnd;z++)F(s.symbolInstances.get(z),z,s.collisionArrays[z]);if(n&&s.bucketInstanceId in this.collisionCircleArrays){const z=this.collisionCircleArrays[s.bucketInstanceId];Q.invert(z.invProjMatrix,l),z.viewportMatrix=this.collisionIndex.getViewportMatrix()}s.justReloaded=!1}markUsedJustification(t,r,n,i){const{leftJustifiedTextSymbolIndex:s,centerJustifiedTextSymbolIndex:a,rightJustifiedTextSymbolIndex:l,verticalPlacedTextSymbolIndex:p,crossTileID:f}=n,m=j_(r),_=i===Dr.vertical?p:m==="left"?s:m==="center"?a:m==="right"?l:-1;s>=0&&(t.text.placedSymbolArray.get(s).crossTileID=_>=0&&s!==_?0:f),a>=0&&(t.text.placedSymbolArray.get(a).crossTileID=_>=0&&a!==_?0:f),l>=0&&(t.text.placedSymbolArray.get(l).crossTileID=_>=0&&l!==_?0:f),p>=0&&(t.text.placedSymbolArray.get(p).crossTileID=_>=0&&p!==_?0:f)}markUsedOrientation(t,r,n){const i=r===Dr.horizontal||r===Dr.horizontalOnly?r:0,s=r===Dr.vertical?r:0,{leftJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:l,rightJustifiedTextSymbolIndex:p,verticalPlacedTextSymbolIndex:f}=n,m=t.text.placedSymbolArray;a>=0&&(m.get(a).placedOrientation=i),l>=0&&(m.get(l).placedOrientation=i),p>=0&&(m.get(p).placedOrientation=i),f>=0&&(m.get(f).placedOrientation=s)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const r=this.prevPlacement;let n=!1;this.prevZoomAdjustment=r?r.zoomAdjustment(this.transform.zoom):0;const i=r?r.symbolFadeChange(t):1,s=r?r.opacities:{},a=r?r.variableOffsets:{},l=r?r.placedOrientations:{};for(const p in this.placements){const f=this.placements[p],m=s[p];m?(this.opacities[p]=new Zh(m,i,f.text,f.icon,null,f.clipped),n=n||f.text!==m.text.placed||f.icon!==m.icon.placed):(this.opacities[p]=new Zh(null,i,f.text,f.icon,f.skipFade,f.clipped),n=n||f.text||f.icon)}for(const p in s){const f=s[p];if(!this.opacities[p]){const m=new Zh(f,i,!1,!1);m.isHidden()||(this.opacities[p]=m,n=n||f.text.placed||f.icon.placed)}}for(const p in a)this.variableOffsets[p]||!this.opacities[p]||this.opacities[p].isHidden()||(this.variableOffsets[p]=a[p]);for(const p in l)this.placedOrientations[p]||!this.opacities[p]||this.opacities[p].isHidden()||(this.placedOrientations[p]=l[p]);n?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=r?r.lastPlacementChangeTime:t)}updateLayerOpacities(t,r){const n=new Set;for(const i of r){const s=i.getBucket(t);s&&i.latestFeatureIndex&&t.id===s.layerIds[0]&&this.updateBucketOpacities(s,n,i.collisionBoxArray)}}updateBucketOpacities(t,r,n){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const i=t.layers[0].layout,s=!!t.layers[0].dynamicFilter(),a=new Zh(null,0,!1,!1,!0),l=i.get("text-allow-overlap"),p=i.get("icon-allow-overlap"),f=i.get("text-variable-anchor"),m=i.get("text-rotation-alignment")==="map",_=i.get("text-pitch-alignment")==="map",y=new Zh(null,0,l&&(p||!t.hasIconData()||i.get("icon-optional")),p&&(l||!t.hasTextData()||i.get("text-optional")),!0);!t.collisionArrays&&n&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(n);const v=(w,E,T)=>{for(let C=0;C<E/4;C++)w.opacityVertexArray.emplaceBack(T)};let b=0;for(let w=0;w<t.symbolInstances.length;w++){const E=t.symbolInstances.get(w),{numHorizontalGlyphVertices:T,numVerticalGlyphVertices:C,crossTileID:M,numIconVertices:A}=E,P=r.has(M);let L=this.opacities[M];P?L=a:L||(L=y,this.opacities[M]=L),r.add(M);const R=T>0||C>0,N=A>0,k=this.placedOrientations[M],F=k===Dr.vertical,z=k===Dr.horizontal||k===Dr.horizontalOnly;if(!R&&!N||L.isHidden()||b++,R){const U=jE(L.text);v(t.text,T,F?yd:U),v(t.text,C,z?yd:U);const G=L.text.isHidden(),{leftJustifiedTextSymbolIndex:V,centerJustifiedTextSymbolIndex:K,rightJustifiedTextSymbolIndex:$,verticalPlacedTextSymbolIndex:tt}=E,X=t.text.placedSymbolArray,J=G||F?1:0;V>=0&&(X.get(V).hidden=J),K>=0&&(X.get(K).hidden=J),$>=0&&(X.get($).hidden=J),tt>=0&&(X.get(tt).hidden=G||z?1:0);const nt=this.variableOffsets[M];nt&&this.markUsedJustification(t,nt.anchor,E,k);const at=this.placedOrientations[M];at&&(this.markUsedJustification(t,"left",E,at),this.markUsedOrientation(t,at,E))}if(N){const U=jE(L.icon),{placedIconSymbolIndex:G,verticalPlacedIconSymbolIndex:V}=E,K=t.icon.placedSymbolArray,$=L.icon.isHidden()?1:0;G>=0&&(v(t.icon,A,F?yd:U),K.get(G).hidden=$),V>=0&&(v(t.icon,E.numVerticalIconVertices,z?yd:U),K.get(V).hidden=$)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const U=t.collisionArrays[w];if(U){let G=new H(0,0),V=!0;if(U.textBox||U.verticalTextBox){if(f){const $=this.variableOffsets[M];$?(G=GE($.anchor,$.width,$.height,$.textOffset,$.textScale),m&&G._rotate(_?this.transform.angle:-this.transform.angle)):V=!1}s&&(V=!L.clipped),U.textBox&&_d(t.textCollisionBox.collisionVertexArray,L.text.placed,!V||F,G.x,G.y),U.verticalTextBox&&_d(t.textCollisionBox.collisionVertexArray,L.text.placed,!V||z,G.x,G.y)}const K=V&&!!(!z&&U.verticalIconBox);U.iconBox&&_d(t.iconCollisionBox.collisionVertexArray,L.icon.placed,K,E.hasIconTextFit?G.x:0,E.hasIconTextFit?G.y:0),U.verticalIconBox&&_d(t.iconCollisionBox.collisionVertexArray,L.icon.placed,!K,E.hasIconTextFit?G.x:0,E.hasIconTextFit?G.y:0)}}}if(t.fullyClipped=b===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const w=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=w.invProjMatrix,t.placementViewportMatrix=w.viewportMatrix,t.collisionCircleArray=w.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,r){const n=this.zoomAtLastRecencyCheck===r?1-this.zoomAdjustment(r):1;return this.zoomAtLastRecencyCheck=r,this.commitTime+this.fadeDuration*n>t}setStale(){this.stale=!0}}function _d(e,t,r,n,i){e.emplaceBack(t?1:0,r?1:0,n||0,i||0),e.emplaceBack(t?1:0,r?1:0,n||0,i||0),e.emplaceBack(t?1:0,r?1:0,n||0,i||0),e.emplaceBack(t?1:0,r?1:0,n||0,i||0)}const LL=Math.pow(2,25),DL=Math.pow(2,24),RL=Math.pow(2,17),OL=Math.pow(2,16),NL=Math.pow(2,9),zL=Math.pow(2,8),kL=Math.pow(2,1);function jE(e){if(e.opacity===0&&!e.placed)return 0;if(e.opacity===1&&e.placed)return 4294967295;const t=e.placed?1:0,r=Math.floor(127*e.opacity);return r*LL+t*DL+r*RL+t*OL+r*NL+t*zL+r*kL+t}const yd=0;class FL{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,r,n,i,s){const a=this._bucketParts;for(;this._currentTileIndex<t.length;)if(r.getBucketParts(a,i,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,s())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,a.sort((l,p)=>l.sortKey-p.sortKey));this._currentPartIndex<a.length;){const l=a[this._currentPartIndex];if(r.placeLayerBucketPart(l,this._seenCrossTileIDs,n,l.symbolInstanceStart===0),this._currentPartIndex++,s())return!0}return!1}}class BL{constructor(t,r,n,i,s,a,l,p){this.placement=new PL(t,s,a,l,p),this._currentPlacementIndex=r.length-1,this._forceFullPlacement=n,this._showCollisionBoxes=i,this._done=!1}isDone(){return this._done}continuePlacement(t,r,n){const i=ge.now(),s=()=>{const a=ge.now()-i;return!this._forceFullPlacement&&a>2};for(;this._currentPlacementIndex>=0;){const a=r[t[this._currentPlacementIndex]],l=this.placement.collisionIndex.transform.zoom;if(a.type==="symbol"&&(!a.minzoom||a.minzoom<=l)&&(!a.maxzoom||a.maxzoom>l)){if(this._inProgressLayer||(this._inProgressLayer=new FL(a)),this._inProgressLayer.continuePlacement(n[a.source],this.placement,this._showCollisionBoxes,a,s))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const qE=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class vd{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,n]=new Uint8Array(t,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const i=n>>4;if(i!==1)throw new Error(`Got v${i} data when expected v1.`);const s=qE[15&n];if(!s)throw new Error("Unrecognized array type.");const[a]=new Uint16Array(t,2,1),[l]=new Uint32Array(t,4,1);return new vd(l,a,s,t)}constructor(t,r=64,n=Float64Array,i){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=n,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const s=qE.indexOf(this.ArrayType),a=2*t*this.ArrayType.BYTES_PER_ELEMENT,l=t*this.IndexArrayType.BYTES_PER_ELEMENT,p=(8-l%8)%8;if(s<0)throw new Error(`Unexpected typed array class: ${n}.`);i&&i instanceof ArrayBuffer?(this.data=i,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+l+p,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+a+l+p),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+l+p,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+s]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=t)}add(t,r){const n=this._pos>>1;return this.ids[n]=n,this.coords[this._pos++]=t,this.coords[this._pos++]=r,n}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return xy(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,r,n,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:a,nodeSize:l}=this,p=[0,s.length-1,0],f=[];for(;p.length;){const m=p.pop()||0,_=p.pop()||0,y=p.pop()||0;if(_-y<=l){for(let E=y;E<=_;E++){const T=a[2*E],C=a[2*E+1];T>=t&&T<=n&&C>=r&&C<=i&&f.push(s[E])}continue}const v=y+_>>1,b=a[2*v],w=a[2*v+1];b>=t&&b<=n&&w>=r&&w<=i&&f.push(s[v]),(m===0?t<=b:r<=w)&&(p.push(y),p.push(v-1),p.push(1-m)),(m===0?n>=b:i>=w)&&(p.push(v+1),p.push(_),p.push(1-m))}return f}within(t,r,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:i,coords:s,nodeSize:a}=this,l=[0,i.length-1,0],p=[],f=n*n;for(;l.length;){const m=l.pop()||0,_=l.pop()||0,y=l.pop()||0;if(_-y<=a){for(let E=y;E<=_;E++)XE(s[2*E],s[2*E+1],t,r)<=f&&p.push(i[E]);continue}const v=y+_>>1,b=s[2*v],w=s[2*v+1];XE(b,w,t,r)<=f&&p.push(i[v]),(m===0?t-n<=b:r-n<=w)&&(l.push(y),l.push(v-1),l.push(1-m)),(m===0?t+n>=b:r+n>=w)&&(l.push(v+1),l.push(_),l.push(1-m))}return p}}function xy(e,t,r,n,i,s){if(i-n<=r)return;const a=n+i>>1;ZE(e,t,a,n,i,s),xy(e,t,r,n,a-1,1-s),xy(e,t,r,a+1,i,1-s)}function ZE(e,t,r,n,i,s){for(;i>n;){if(i-n>600){const f=i-n+1,m=r-n+1,_=Math.log(f),y=.5*Math.exp(2*_/3),v=.5*Math.sqrt(_*y*(f-y)/f)*(m-f/2<0?-1:1);ZE(e,t,r,Math.max(n,Math.floor(r-m*y/f+v)),Math.min(i,Math.floor(r+(f-m)*y/f+v)),s)}const a=t[2*r+s];let l=n,p=i;for(Xh(e,t,n,r),t[2*i+s]>a&&Xh(e,t,n,i);l<p;){for(Xh(e,t,l,p),l++,p--;t[2*l+s]<a;)l++;for(;t[2*p+s]>a;)p--}t[2*n+s]===a?Xh(e,t,n,p):(p++,Xh(e,t,p,i)),p<=r&&(n=p+1),r<=p&&(i=p-1)}}function Xh(e,t,r,n){by(e,r,n),by(t,2*r,2*n),by(t,2*r+1,2*n+1)}function by(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function XE(e,t,r,n){const i=e-r,s=t-n;return i*i+s*s}const wy=512/lt/2;class VL{constructor(t,r,n){this.tileID=t,this.bucketInstanceId=n,this.index=new vd(r.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const i=t.canonical.x*lt,s=t.canonical.y*lt;for(let a=0;a<r.length;a++){const{key:l,crossTileID:p,tileAnchorX:f,tileAnchorY:m}=r.get(a),_=Math.floor((i+f)*wy),y=Math.floor((s+m)*wy);this.index.add(_,y),this.keys.push(l),this.crossTileIDs.push(p)}this.index.finish()}findMatches(t,r,n){const i=this.tileID.canonical.z<r.canonical.z?1:Math.pow(2,this.tileID.canonical.z-r.canonical.z),s=wy/Math.pow(2,r.canonical.z-this.tileID.canonical.z),a=r.canonical.x*lt,l=r.canonical.y*lt;for(let p=0;p<t.length;p++){const f=t.get(p);if(f.crossTileID)continue;const{key:m,tileAnchorX:_,tileAnchorY:y}=f,v=Math.floor((a+_)*s),b=Math.floor((l+y)*s),w=this.index.range(v-i,b-i,v+i,b+i);for(const E of w){const T=this.crossTileIDs[E];if(this.keys[E]===m&&!n.has(T)){n.add(T),f.crossTileID=T;break}}}}}class UL{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class GL{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const r=Math.round((t-this.lng)/360);if(r!==0)for(const n in this.indexes){const i=this.indexes[n],s={};for(const a in i){const l=i[a];l.tileID=l.tileID.unwrapTo(l.tileID.wrap+r),s[l.tileID.key]=l}this.indexes[n]=s}this.lng=t}addBucket(t,r,n){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===r.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let s=0;s<r.symbolInstances.length;s++)r.symbolInstances.get(s).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const i=this.usedCrossTileIDs[t.overscaledZ];for(const s in this.indexes){const a=this.indexes[s];if(Number(s)>t.overscaledZ)for(const l in a){const p=a[l];p.tileID.isChildOf(t)&&p.findMatches(r.symbolInstances,t,i)}else{const l=a[t.scaledTo(Number(s)).key];l&&l.findMatches(r.symbolInstances,t,i)}}for(let s=0;s<r.symbolInstances.length;s++){const a=r.symbolInstances.get(s);a.crossTileID||(a.crossTileID=n.generate(),i.add(a.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new VL(t,r.symbolInstances,r.bucketInstanceId),!0}removeBucketCrossTileIDs(t,r){for(const n of r.crossTileIDs)this.usedCrossTileIDs[t].delete(n)}removeStaleBuckets(t){let r=!1;for(const n in this.indexes){const i=this.indexes[n];for(const s in i)t[i[s].bucketInstanceId]||(this.removeBucketCrossTileIDs(n,i[s]),delete i[s],r=!0)}return r}}class jL{constructor(){this.layerIndexes={},this.crossTileIDs=new UL,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,r,n,i){let s=this.layerIndexes[t.id];s===void 0&&(s=this.layerIndexes[t.id]=new GL);let a=!1;const l={};i.name!=="globe"&&s.handleWrapJump(n);for(const p of r){const f=p.getBucket(t);f&&t.id===f.layerIds[0]&&(f.bucketInstanceId||(f.bucketInstanceId=++this.maxBucketInstanceId),s.addBucket(p.tileID,f,this.crossTileIDs)&&(a=!0),l[f.bucketInstanceId]=!0)}return s.removeStaleBuckets(l)&&(a=!0),a}pruneUnusedLayers(t){const r={};t.forEach(n=>{r[n]=!0});for(const n in this.layerIndexes)r[n]||delete this.layerIndexes[n]}}function cc(e,t){return t?`${e}${t}`:e}function WE(e){const t=e.indexOf("");return t>=0?e.slice(0,t):e}function HE(e){const t=e.indexOf("");return t>=0?e.slice(t+1):""}var YE=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#define EXTENT 8192.0
#define HALF_PI PI/2.0
#define QUARTER_PI PI/4.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
vec3 linearTosRGB(vec3 color)
{return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn)
{return pow(srgbIn,vec3(2.2));}vec3 linearProduct(vec3 srgbIn,vec3 k)
{return srgbIn*pow(k,vec3(1./2.2));}
#if __VERSION__ >=300
#define _HANDLE_WIREFRAME_DEPTH gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define _HANDLE_WIREFRAME_DEPTH
#endif
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
gl_FragColor=vec4(0.7,0.0,0.0,0.7); \\
_HANDLE_WIREFRAME_DEPTH;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif`,$E="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",KE=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifdef TERRAIN
#ifdef TERRAIN_DEM_FLOAT_FORMAT
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#else
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;
#endif
uniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));
#ifdef TERRAIN_DEM_NEAREST_FILTER
return u_exaggeration*tl;
#endif
float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
float tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;
#else
vec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);
#endif
return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,JE=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,QE=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump float u_fog_temporal_offset;varying vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {
#ifdef FOG_DITHERING
vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);
#else
return color;
#endif
}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,t2=`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,asin(clamp(normal.z,-1.0,1.0))/PI+0.5);return vertical_factor*ambient_directional_factor;}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,e2=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,r2=`#ifdef RENDER_SHADOWS
#if defined(NATIVE) && __VERSION__ >=300
#define TEXTURE_GATHER
#endif
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture2D(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture2D(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture2D(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture2D(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp float compare1=pos.z-bias;highp vec2 texel=pos.xy/u_texel_size-vec2(0.5);highp vec2 f=fract(texel);highp float s=u_texel_size;
#ifdef TEXTURE_GATHER
vec2 uv00=(texel-f+0.5)*s;highp vec4 d00=textureGather(u_shadowmap_1,uv00,0);highp vec4 c00=step(d00,vec4(compare1));highp float o00=c00.a;highp float o10=c00.b;highp float o01=c00.r;highp float o11=c00.g;
#else
highp vec2 uv00=(texel-f+0.5)*s;highp vec2 uv10=uv00+vec2(1.0*s,0.0);highp vec2 uv01=uv00+vec2(0.0,1.0*s);highp vec2 uv11=uv01+vec2(1.0*s,0.0);highp float o00=shadow_sample_1(uv00,compare1);highp float o10=shadow_sample_1(uv10,compare1);highp float o01=shadow_sample_1(uv01,compare1);highp float o11=shadow_sample_1(uv11,compare1);
#endif
highp float value=
(1.0-f.x)*(1.0-f.y)*o00+f.x*(1.0-f.y)*o10+(1.0-f.x)*f.y*o01+f.x*f.y*o11;return clamp(value,0.0,1.0);}highp float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;highp vec2 texel=pos.xy/u_texel_size-vec2(1.5);highp vec2 f=fract(texel);highp float s=u_texel_size;
#ifdef TEXTURE_GATHER
highp vec2 uv00=(texel-f+0.5)*s;highp vec2 uv10=uv00+vec2(2.0*s,0);highp vec2 uv01=uv00+vec2(0,2.0*s);highp vec2 uv11=uv10+vec2(0,2.0*s);highp vec4 d00=textureGather(u_shadowmap_0,uv00);highp vec4 d10=textureGather(u_shadowmap_0,uv10);highp vec4 d01=textureGather(u_shadowmap_0,uv01);highp vec4 d11=textureGather(u_shadowmap_0,uv11);highp vec4 c00=step(d00,vec4(compare0));highp vec4 c01=step(d01,vec4(compare0));highp vec4 c10=step(d10,vec4(compare0));highp vec4 c11=step(d11,vec4(compare0));highp float o00=c00.a;highp float o10=c00.b;highp float o20=c10.a;highp float o30=c10.b;highp float o01=c00.r;highp float o11=c00.g;highp float o21=c10.r;highp float o31=c10.g;highp float o02=c01.a;highp float o12=c01.b;highp float o22=c11.a;highp float o32=c11.b;highp float o03=c01.r;highp float o13=c01.g;highp float o23=c11.r;highp float o33=c11.g;
#else
highp vec2 uv00=(texel-f+0.5)*s;highp vec2 uv10=uv00+vec2(1.0*s,0);highp vec2 uv20=uv00+vec2(2.0*s,0);highp vec2 uv30=uv00+vec2(3.0*s,0);highp vec2 uv01=uv00+vec2(0.0,1.0*s);highp vec2 uv11=uv01+vec2(1.0*s,0);highp vec2 uv21=uv01+vec2(2.0*s,0);highp vec2 uv31=uv01+vec2(3.0*s,0);highp vec2 uv02=uv01+vec2(0.0,1.0*s);highp vec2 uv12=uv02+vec2(1.0*s,0);highp vec2 uv22=uv02+vec2(2.0*s,0);highp vec2 uv32=uv02+vec2(3.0*s,0);highp vec2 uv03=uv02+vec2(0.0,1.0*s);highp vec2 uv13=uv03+vec2(1.0*s,0);highp vec2 uv23=uv03+vec2(2.0*s,0);highp vec2 uv33=uv03+vec2(3.0*s,0);highp float o00=shadow_sample_0(uv00,compare0);highp float o10=shadow_sample_0(uv10,compare0);highp float o20=shadow_sample_0(uv20,compare0);highp float o30=shadow_sample_0(uv30,compare0);highp float o01=shadow_sample_0(uv01,compare0);highp float o11=shadow_sample_0(uv11,compare0);highp float o21=shadow_sample_0(uv21,compare0);highp float o31=shadow_sample_0(uv31,compare0);highp float o02=shadow_sample_0(uv02,compare0);highp float o12=shadow_sample_0(uv12,compare0);highp float o22=shadow_sample_0(uv22,compare0);highp float o32=shadow_sample_0(uv32,compare0);highp float o03=shadow_sample_0(uv03,compare0);highp float o13=shadow_sample_0(uv13,compare0);highp float o23=shadow_sample_0(uv23,compare0);highp float o33=shadow_sample_0(uv33,compare0);
#endif
highp float value=
(1.0-f.x)*(1.0-f.y)*o00+(1.0-f.y)*(o10+o20)+f.x*(1.0-f.y)*o30+(1.0-f.x)*(o01+o02)+f.x*(o31+o32)+(1.0-f.x)*f.y*o03+f.y*(o13+o23)+f.x*f.y*o33+o11+o21+o12+o22;return clamp(value/9.0,0.0,1.0);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp float NDotL=dot(N,u_shadow_direction);if (NDotL < 0.0)
return 0.0;highp float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return (1.0-(u_shadow_intensity*occlusion))*NDotL;}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp float NDotL=dot(N,u_shadow_direction);if (NDotL < 0.0)
return 0.0;float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return (1.0-(u_shadow_intensity*occlusion))*NDotL;}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let n2={},Ey={},Ty={};const pl=[];ya(YE,pl),ya(t2,pl),ya(KE,pl),ya(JE,pl),ya(QE,pl),ya(e2,pl),ya(r2,pl),n2=tr("",KE),Ey=tr(QE,JE),Ty=tr(r2,e2);const i2=tr(`
#if __VERSION__ >=300
#define varying in
#define gl_FragColor glFragColor
#define texture2D texture
#define textureCube texture
out vec4 glFragColor;
#endif
highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color) {
#ifdef INDICATOR_CUTOUT
float holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}`,`
#if __VERSION__ >=300
#define attribute in
#define varying out
#define texture2D texture
#endif
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered.`),o2=YE,s2=t2,Iy=`
#ifdef GL_ES
precision mediump float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`;var a2={background:tr(`uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
varying vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;varying vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:tr(`uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;varying vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:tr(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
gl_FragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:tr("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:tr(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:tr(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:tr("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:tr("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}",`attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:tr("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",`attribute vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;
#endif
varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:tr(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:tr(`varying vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:tr(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;varying vec2 v_pos;varying vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;varying vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:tr(`uniform vec2 u_texsize;uniform sampler2D u_image;varying vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
gl_FragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:tr(`varying vec4 v_color;
#ifdef RENDER_SHADOWS
varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
varying highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
varying float v_flood_radius;varying float v_has_floodlight;
#endif
varying float v_height;void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
uniform highp float u_vertical_scale;varying vec4 v_color;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
varying vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
varying highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
varying float v_flood_radius;varying float v_has_floodlight;
#endif
varying float v_height;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=color;
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:tr(`varying highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
gl_FragColor=pack_depth(v_depth);
#endif
}`,`uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
varying highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:tr(`uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
varying vec3 v_normal;
#endif
varying vec2 v_pos;varying vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
varying vec2 v_pos;varying vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;varying vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
varying vec3 v_normal;
#endif
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:tr(`#ifdef GL_ES
precision highp float;
#endif
uniform vec3 u_ground_shadow_factor;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#ifdef FOG
varying float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);
#endif
gl_FragColor=vec4(shadow,1.0);}`,`uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;attribute vec2 a_pos;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#ifdef FOG
varying float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);v_depth=gl_Position.w;
#ifdef FOG
v_fog_opacity=fog(fog_position(a_pos));
#endif
}`),fillExtrusionGroundEffect:tr(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;
#ifdef SDF_SUBPASS
varying highp vec2 v_pos;varying highp vec4 v_line_segment;varying highp float v_flood_light_radius_tile;varying highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
varying highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texelFetch(u_fb,ivec2(gl_FragCoord.xy),0);
#endif
gl_FragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
gl_FragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
gl_FragColor=color;HANDLE_WIREFRAME_DEBUG;
#endif
#endif
}`,`attribute highp vec4 a_pos_end;attribute highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
varying highp vec2 v_pos;varying highp vec4 v_line_segment;varying highp float v_flood_light_radius_tile;varying highp vec2 v_ao;
#ifdef FOG
varying highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
#pragma mapbox: define highp float base
void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
#pragma mapbox: initialize highp float base
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float flood_radius_tile=flood_light_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass);vec2 offset_along_edge=v*effect_radius*(0.5-start_bottom.x)*2.0;vec2 extrusion=vec2(-v.y,v.x)*effect_radius*(start_bottom.y-1.0);vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=offset_along_edge+extrusion;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q);v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog=1.0-fog(fog_position(pos));
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(flood_light_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=float(base > 0.0);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));}`),hillshadePrepare:tr(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
return texture2D(u_image,coord).a/4.0;
#else
vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;
#endif
}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:tr(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
gl_FragColor=apply_lighting_ground(gl_FragColor);
#endif
#ifdef FOG
gl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:tr(`uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;varying vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture2D(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture2D(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trimmed=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}
#endif
#ifdef RENDER_LINE_ALPHA_DISCARD
if (alpha < u_alpha_discard_threshold) {discard;}
#endif
#ifdef RENDER_LINE_BORDER
float edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);
#ifdef RENDER_LINE_BORDER_AUTO
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}
#else
out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);
#endif
}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`
#define EXTRUDE_SCALE 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
attribute highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
attribute float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;varying vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:tr(`uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture2D(u_image,pos);
#ifdef LIGHTING_3D_MODE
color=apply_lighting_ground(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:tr(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec2 u_colorization_scale;uniform highp vec4 u_colorization_mix;highp vec4 colormap (highp float value) {highp float scaled_value=value*u_colorization_scale.y+u_colorization_scale.x;highp vec2 coords=vec2(scaled_value,0.5);return texture2D(u_color_ramp,coords);}
#endif
void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);vec4 color;
#ifdef RASTER_COLOR
highp vec4 fadedColor=mix(color0,color1,u_fade_t);color=colormap(dot(vec4(fadedColor.rgb,1),u_colorization_mix));color.a*=fadedColor.a;if (color.a > 0.0) {color.rgb/=color.a;}
#else
if (color0.a > 0.0) {color0.rgb/=color0.a;}if (color1.a > 0.0) {color1.rgb/=color1.a;}color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_ground(out_color);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply(out_color,v_fog_pos));
#endif
gl_FragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),symbolIcon:tr(`uniform sampler2D u_texture;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
varying float v_fade_opacity;varying vec2 v_tex_a;
#ifdef ICON_TRANSITION
varying vec2 v_tex_b;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
lowp float alpha=opacity*v_fade_opacity;vec4 out_color;
#ifdef ICON_TRANSITION
vec4 a=texture2D(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture2D(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;
#else
out_color=texture2D(u_texture,v_tex_a)*alpha;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
attribute vec2 a_texb;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
varying vec2 v_tex_a;
#ifdef ICON_TRANSITION
varying vec2 v_tex_b;
#endif
varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
v_tex_a=a_tex/u_texsize;
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
v_fade_opacity=out_fade_opacity;}`),symbolSDF:tr(`#define SDF_PX 8.0
uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;
#if __VERSION__ >=300
flat varying float v_draw_halo;
#endif
varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo;
#if __VERSION__ >=300
draw_halo=v_draw_halo > 0.0;
#else
draw_halo=u_is_halo;
#endif
if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
#if __VERSION__ >=300
flat varying float v_draw_halo;
#endif
varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;
#if __VERSION__ >=300
v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;
#endif
v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}`),symbolTextAndIcon:tr(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;
#if __VERSION__ >=300
flat varying float v_draw_halo;
#endif
varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo;
#if __VERSION__ >=300
draw_halo=v_draw_halo > 0.0;
#else
draw_halo=u_is_halo;
#endif
if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
gl_FragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_projected_pos;attribute float a_fade_opacity;
#ifdef PROJECTION_GLOBE_VIEW
attribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
#if __VERSION__ >=300
flat varying float v_draw_halo;
#endif
varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;
#if __VERSION__ >=300
v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;
#endif
v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}`),terrainRaster:tr(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture2D(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,v_depth,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,(1.0-(u_shadow_intensity*occlusion))*ndotl);vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color=apply_lighting(image_color,normal,lighting_factor);
#endif
#else
float lighting_factor=calculate_NdotL(normal);color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;varying vec2 v_pos0;
#ifdef FOG
varying float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;
#endif
}`),terrainDepth:tr(`#ifdef GL_ES
precision highp float;
#endif
varying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}`,"uniform mat4 u_matrix;attribute vec2 a_pos;varying float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:tr(`
varying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,$E),skyboxGradient:tr(`varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,$E),skyboxCapture:tr(`
varying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;
#ifdef GL_ES
precision highp float;
#endif
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}`,"attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:tr(`uniform sampler2D u_image0;varying vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture2D(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture2D(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
gl_FragColor=color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
attribute vec3 a_globe_pos;attribute vec2 a_uv;
#else
attribute vec2 a_pos;
#endif
varying vec2 v_pos0;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:tr(`uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
gl_FragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
gl_FragColor=vec4(1,1,1,1);
#else
gl_FragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(dot(dir,horizon_dir)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;float closest_point_to_center=length(closest_point-u_globe_pos);float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);gl_FragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;
#ifndef NATIVE
c=dither(c,gl_FragCoord.xy+u_temporal_offset);
#endif
gl_FragColor=vec4(c*t,t);
#endif
}`,`attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:tr(`uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;varying highp vec3 v_position;varying lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth_shadows;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
varying lowp vec4 v_roughness_metallic_emissive_alpha;varying mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
varying highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture2D(u_depthTexture,coord));return v_depth > depth+0.0005;}
#endif
const float M_PI=3.141592653589793;
#define saturate(_x) clamp(_x,0.,1.)
float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture2D(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
texColor.rgb=sRGBToLinear(texColor.rgb);if(u_baseTextureIsAlpha) {if (texColor.w < 0.5) {discard;}albedo*=mix(vec4(texColor.rgb,texColor.a),vec4(texColor.a),float(u_baseTextureIsAlpha));} else {albedo*=texColor;}
#endif
return vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position.x),dFdx(v_position.y),dFdx(v_position.z));highp vec3 fdy=vec3(dFdy(v_position.x),dFdy(v_position.y),dFdy(v_position.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture2D( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture2D(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(M_PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/M_PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/M_PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 diffuse=getDiffuseShadedColor(getBaseColor().rgb,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture2D(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(diffuse,1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
float ao=(texture2D(u_occlusionTexture,uv_2f).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture2D(u_emissionTexture,uv_2f).rgb);
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor);
#endif
gl_FragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`attribute vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
attribute vec4 a_normal_matrix0;attribute vec4 a_normal_matrix1;attribute vec4 a_normal_matrix2;attribute vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth_shadows;
#endif
varying vec3 v_position;varying lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
varying highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
varying lowp vec4 v_roughness_metallic_emissive_alpha;varying mediump vec4 v_height_based_emission_params;
#endif
void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=local_pos;
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:tr(`varying highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
gl_FragColor=pack_depth(v_depth);
#endif
}`,`attribute vec3 a_pos_3f;uniform mat4 u_matrix;varying highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
attribute vec4 a_instance0;attribute vec4 a_instance1;attribute vec4 a_instance2;attribute vec4 a_instance3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_instance0,a_instance1,a_instance2,a_instance3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:tr(`varying highp vec2 v_uv;varying mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;gl_FragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
attribute vec3 a_pos_3f;attribute vec2 a_uv;attribute float a_size_scale;attribute float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;varying highp vec2 v_uv;varying mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`)};function ya(e,t){const r=e.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let n of r)if(n=n.trim(),n[0]==="#"&&n.includes("if")&&!n.includes("endif")){n=n.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const i=n.split(" ");for(const s of i)t.includes(s)||t.push(s)}}function tr(e,t){const r=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let n=t.match(/attribute(\S*) (highp |mediump |lowp )?([\w]+) ([\w]+)/g);n&&(n=n.filter((a,l)=>n.indexOf(a)===l));const i={},s=[...pl];return ya(e,s),ya(t,s),{fragmentSource:e=e.replace(r,(a,l,p,f,m)=>(i[m]=!0,l==="define"?`
#ifndef HAS_UNIFORM_u_${m}
varying ${p} ${f} ${m};
#else
uniform ${p} ${f} u_${m};
#endif
`:l==="initialize"?`
#ifdef HAS_UNIFORM_u_${m}
    ${p} ${f} ${m} = u_${m};
#endif
`:l==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${m}
    varying ${p} ${f} ${m};
#endif
`:l==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(r,(a,l,p,f,m)=>{const _=f==="float"?"vec2":f,y=m.match(/color/)?"color":_;return l==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${m}
attribute ${p} ${f} a_${m};
#endif
`:i[m]?l==="define"?`
#ifndef HAS_UNIFORM_u_${m}
uniform lowp float u_${m}_t;
attribute ${p} ${_} a_${m};
varying ${p} ${f} ${m};
#else
uniform ${p} ${f} u_${m};
#endif
`:l==="initialize"?y==="vec4"?`
#ifndef HAS_UNIFORM_u_${m}
    ${m} = a_${m};
#else
    ${p} ${f} ${m} = u_${m};
#endif
`:`
#ifndef HAS_UNIFORM_u_${m}
    ${m} = unpack_mix_${y}(a_${m}, u_${m}_t);
#else
    ${p} ${f} ${m} = u_${m};
#endif
`:l==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${m}
    attribute ${p} ${f} a_${m};
    varying ${p} ${f} ${m};
#endif
`:l==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${m}
    ${m} = a_${m};
#endif
`:void 0:l==="define"?`
#ifndef HAS_UNIFORM_u_${m}
uniform lowp float u_${m}_t;
attribute ${p} ${_} a_${m};
#else
uniform ${p} ${f} u_${m};
#endif
`:l==="define-instanced"?y==="mat4"?`
#ifdef INSTANCED_ARRAYS
attribute vec4 a_${m}0;
attribute vec4 a_${m}1;
attribute vec4 a_${m}2;
attribute vec4 a_${m}3;
#else
uniform ${p} ${f} u_${m};
#endif
`:`
#ifdef INSTANCED_ARRAYS
attribute ${p} ${_} a_${m};
#else
uniform ${p} ${f} u_${m};
#endif
`:l==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${m}
    ${p} ${f} ${m} = a_${m};
#endif
`:y==="vec4"?`
#ifndef HAS_UNIFORM_u_${m}
    ${p} ${f} ${m} = a_${m};
#else
    ${p} ${f} ${m} = u_${m};
#endif
`:`
#ifndef HAS_UNIFORM_u_${m}
    ${p} ${f} ${m} = unpack_mix_${y}(a_${m}, u_${m}_t);
#else
    ${p} ${f} ${m} = u_${m};
#endif
`}),staticAttributes:n,usedDefines:s}}class qL{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,r,n,i,s,a,l){this.context=t;let p=this.boundPaintVertexBuffers.length!==i.length;for(let m=0;!p&&m<i.length;m++)this.boundPaintVertexBuffers[m]!==i[m]&&(p=!0);let f=this.boundDynamicVertexBuffers.length!==l.length;for(let m=0;!f&&m<l.length;m++)this.boundDynamicVertexBuffers[m]!==l[m]&&(f=!0);if(!t.extVertexArrayObject||!this.vao||this.boundProgram!==r||this.boundLayoutVertexBuffer!==n||p||f||this.boundIndexBuffer!==s||this.boundVertexOffset!==a)this.freshBind(r,n,i,s,a,l);else{t.bindVertexArrayOES.set(this.vao);for(const m of l)m&&m.bind();s&&s.dynamicDraw&&s.bind()}}freshBind(t,r,n,i,s,a){let l;const p=t.numAttributes,f=this.context,m=f.gl;if(f.extVertexArrayObject)this.vao&&this.destroy(),this.vao=f.extVertexArrayObject.createVertexArrayOES(),f.bindVertexArrayOES.set(this.vao),l=0,this.boundProgram=t,this.boundLayoutVertexBuffer=r,this.boundPaintVertexBuffers=n,this.boundIndexBuffer=i,this.boundVertexOffset=s,this.boundDynamicVertexBuffers=a;else{l=f.currentNumAttributes||0;for(let _=p;_<l;_++)m.disableVertexAttribArray(_)}r.enableAttributes(m,t),r.bind(),r.setVertexAttribPointers(m,t,s);for(const _ of n)_.enableAttributes(m,t),_.bind(),_.setVertexAttribPointers(m,t,s);for(const _ of a)_&&(_.enableAttributes(m,t),_.bind(),_.setVertexAttribPointers(m,t,s));i&&i.bind(),f.currentNumAttributes=p}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function ZL(e,t){const r=Math.pow(2,t.canonical.z),n=t.canonical.y;return[new Ue(0,n/r).toLngLat().lat,new Ue(0,(n+1)/r).toLngLat().lat]}function XL(e,t,r,n,i,s,a){const l=e.context,p=l.gl,f=r.fbo;if(!f)return;e.prepareDrawTile();const m=e.useProgram("hillshade");l.activeTexture.set(p.TEXTURE0),p.bindTexture(p.TEXTURE_2D,f.colorAttachment.get());const _=((w,E,T,C)=>{const M=T.paint.get("hillshade-shadow-color"),A=T.paint.get("hillshade-highlight-color"),P=T.paint.get("hillshade-accent-color");let L=T.paint.get("hillshade-illumination-direction")*(Math.PI/180);T.paint.get("hillshade-illumination-anchor")==="viewport"&&(L-=w.transform.angle);const R=!w.options.moving;return{u_matrix:C||w.transform.calculateProjMatrix(E.tileID.toUnwrapped(),R),u_image:0,u_latrange:ZL(0,E.tileID),u_light:[T.paint.get("hillshade-exaggeration"),L],u_shadow:M,u_highlight:A,u_accent:P}})(e,r,n,e.terrain?t.projMatrix:null);e.uploadCommonUniforms(l,m,t.toUnwrapped());const{tileBoundsBuffer:y,tileBoundsIndexBuffer:v,tileBoundsSegments:b}=e.getTileBoundsBuffers(r);m.draw(e,p.TRIANGLES,i,s,a,Ge.disabled,_,n.id,y,v,b)}function l2(e,t,r){if(!t.needsDEMTextureUpload)return;const n=e.context,i=n.gl;n.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||e.getTileTexture(r.stride);const s=r.getPixels();t.demTexture?t.demTexture.update(s,{premultiply:!1}):t.demTexture=new dn(n,s,i.RGBA,{premultiply:!1}),t.needsDEMTextureUpload=!1}function WL(e,t,r,n,i,s){const a=e.context,l=a.gl;if(!t.dem)return;const p=t.dem;if(a.activeTexture.set(l.TEXTURE1),l2(e,t,p),!t.demTexture)return;t.demTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE);const f=p.dim;a.activeTexture.set(l.TEXTURE0);let m=t.fbo;if(!m){const b=new dn(a,{width:f,height:f,data:null},l.RGBA);b.bind(l.LINEAR,l.CLAMP_TO_EDGE),m=t.fbo=a.createFramebuffer(f,f,!0,"renderbuffer"),m.colorAttachment.set(b.texture)}a.bindFramebuffer.set(m.framebuffer),a.viewport.set([0,0,f,f]);const{tileBoundsBuffer:_,tileBoundsIndexBuffer:y,tileBoundsSegments:v}=e.getMercatorTileBoundsBuffers();e.useProgram("hillshadePrepare").draw(e,l.TRIANGLES,n,i,s,Ge.disabled,((b,w)=>{const E=w.stride,T=Q.create();return Q.ortho(T,0,lt,-lt,0,0,1),Q.translate(T,T,[0,-lt,0]),{u_matrix:T,u_image:1,u_dimension:[E,E],u_zoom:b.overscaledZ,u_unpack:w.unpackVector}})(t.tileID,p),r.id,_,y,v),t.needsHillshadePrepare=!1}const u2=e=>({u_matrix:new ve(e),u_image0:new Pe(e),u_skirt_height:new Et(e),u_ground_shadow_factor:new _e(e)}),c2=(e,t,r)=>({u_matrix:e,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:r}),h2=(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b)=>({u_proj_matrix:Float32Array.from(e),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(n),u_merc_matrix:r,u_zoom_transition:i,u_merc_center:s,u_image0:0,u_frustum_tl:a,u_frustum_tr:l,u_frustum_br:p,u_frustum_bl:f,u_globe_pos:m,u_globe_radius:_,u_viewport:y,u_grid_matrix:b?Float32Array.from(b):new Float32Array(9),u_skirt_height:v}),Qi={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},hc=2048;class HL{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._cascades=[],this._depthMode=new de(t.context.gl.LEQUAL,de.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_texel_size:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,r){const n=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,!n.context.isWebGL2||!r||!r.properties)return;const i=r.properties.get("shadow-intensity");if(r.properties.get("cast-shadows")!==!0||i<=0||(this._shadowLayerCount=n.style.order.reduce((v,b)=>{const w=n.style._layers[b];return v+(w.hasShadowPass()&&!w.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this._enabled))return;const s=n.context,a=hc,l=hc;if(this._cascades.length===0)for(let v=0;v<2;++v){const b=n._shadowMapDebug,w=s.gl,E=s.createFramebuffer(a,l,b,"texture"),T=new dn(s,{width:a,height:l,data:null},w.DEPTH_COMPONENT);if(E.depthAttachment.set(T.texture),b){const C=new dn(s,{width:a,height:l,data:null},w.RGBA);E.colorAttachment.set(C.texture)}this._cascades.push({framebuffer:E,texture:T,matrix:[],far:0,boundingSphereRadius:0,frustum:new Bu})}const p=function(v,b){const w=b.properties.get("direction"),E=$t(w.x,w.y,w.z);E[2]=Bt(E[2],0,75);const T=Xt([E[0],E[1],E[2]]);return q.fromValues(T.x,T.y,T.z)}(0,r);let f=0;if(t.elevation){const v=t.elevation,b=[1e4,-1e4];v.visibleDemTiles.filter(w=>w.dem).forEach(w=>{const E=w.dem.tree;b[0]=Math.min(b[0],E.minimums[0]),b[1]=Math.max(b[1],E.maximums[0])}),b[0]!==1e4&&(f=(b[1]-b[0])*v.exaggeration())}const m=1.5*t.cameraToCenterDistance,_=3*m,y=new Float64Array(16);for(let v=0;v<2;++v){const b=this._cascades[v];let w=t.height/50,E=1;v===0?E=m:(w=m,E=_);const[T,C]=YL(t,p,w,E,hc,f);b.matrix=T,b.boundingSphereRadius=C,Q.invert(y,b.matrix),b.frustum=Bu.fromInvProjectionMatrix(y,1,0,!0),b.far=E}this._uniformValues.u_fade_range=[.75*this._cascades[1].far,this._cascades[1].far],this._uniformValues.u_shadow_intensity=i,this._uniformValues.u_shadow_direction=[p[0],p[1],p[2]],this._uniformValues.u_texel_size=.00048828125,this._uniformValues.u_shadowmap_0=Qi.ShadowMap0,this._uniformValues.u_shadowmap_1=Qi.ShadowMap0+1}get enabled(){return this._enabled}set enabled(t){this._enabled=t}drawShadowPass(t,r){if(!this._enabled)return;const n=this.painter,i=n.context;i.viewport.set([0,0,hc,hc]);for(let s=0;s<2;++s){n.currentShadowCascade=s,i.bindFramebuffer.set(this._cascades[s].framebuffer.framebuffer),i.clear({color:Se.white,depth:1});for(const a of t.order){const l=t._layers[a];if(!l.hasShadowPass()||l.isHidden(n.transform.zoom))continue;const p=t._getLayerSourceCache(l),f=p?r[p.id]:void 0;(l.type==="model"||f&&f.length)&&n.renderLayer(n,p,l,f)}}n.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const t=this.painter,r=t.style,n=t.context,i=r.directionalLight,s=r.ambientLight;if(!i||!s)return;const a=t.useProgram("groundShadow"),l=t.transform.coveringTiles({tileSize:512,renderWorldCopies:!0}),p=Sy(i,s),f=new de(n.gl.LEQUAL,de.ReadOnly,t.depthRangeFor3D);for(const m of l){const _=m.toUnwrapped();this.setupShadows(_,a),t.uploadCommonUniforms(n,a,_);const y={u_matrix:t.transform.calculateProjMatrix(_),u_ground_shadow_factor:p};a.draw(t,n.gl.TRIANGLES,f,Be.disabled,sr.multiply,Ge.disabled,y,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,{},t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?sr.unblended:sr.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const r=this.painter.transform,n=r.calculatePosMatrix(t,r.worldSize);return Q.multiply(n,this._cascades[this.painter.currentShadowCascade].matrix,n),Float32Array.from(n)}calculateShadowPassMatrixFromMatrix(t){return Q.multiply(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,r,n,i=0){if(!this._enabled)return;const s=this.painter.transform,a=this.painter.context,l=a.gl,p=this._uniformValues,f=new Float64Array(16),m=s.calculatePosMatrix(t,s.worldSize);for(let _=0;_<2;_++)Q.multiply(f,this._cascades[_].matrix,m),p[_===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(f),a.activeTexture.set(l.TEXTURE0+Qi.ShadowMap0+_),this._cascades[_].texture.bind(l.NEAREST,l.CLAMP_TO_EDGE);if(this.useNormalOffset=!!n,this.useNormalOffset){const _=yh(t.canonical),y=2/s.tileSize*lt/hc,v=y*this._cascades[0].boundingSphereRadius,b=y*this._cascades[1].boundingSphereRadius,w=(n==="vector-tile"?1:3)/Math.pow(2,i-t.canonical.z-(1-s.zoom+Math.floor(s.zoom)));p.u_shadow_normal_offset=[_,v*w,b*w],p.u_shadow_bias=[6e-5,.0012,.012]}else p.u_shadow_bias=[36e-5,.0012,.012];r.setShadowUniformValues(a,p)}setupShadowsFromMatrix(t,r,n=!1){if(!this._enabled)return;const i=this.painter.context,s=i.gl,a=this._uniformValues,l=new Float64Array(16);for(let p=0;p<2;p++)Q.multiply(l,this._cascades[p].matrix,t),a[p===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(l),i.activeTexture.set(s.TEXTURE0+Qi.ShadowMap0+p),this._cascades[p].texture.bind(s.NEAREST,s.CLAMP_TO_EDGE);this.useNormalOffset=n,n?(a.u_shadow_normal_offset=[1,5,5],a.u_shadow_bias=[6e-5,.0012,.012]):a.u_shadow_bias=[36e-5,.0012,.012],r.setShadowUniformValues(i,a)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}}function Sy(e,t){const r=e.properties.get("color"),n=e.properties.get("intensity"),i=e.properties.get("direction"),s=[i.x,i.y,i.z],a=t.properties.get("color"),l=t.properties.get("intensity"),p=Math.max(q.dot([0,0,1],s),0),f=[0,0,0];q.scale(f,a.toArray01Linear().slice(0,3),l);const m=[0,0,0];return q.scale(m,r.toArray01Linear().slice(0,3),p*n),Ur([f[0]>0?f[0]/(f[0]+m[0]):0,f[1]>0?f[1]/(f[1]+m[1]):0,f[2]>0?f[2]/(f[2]+m[2]):0])}function YL(e,t,r,n,i,s){const a=e.zoom,l=e.scale,p=e.worldSize,f=1/p,m=e.aspect,_=Math.sqrt(1+m*m)*Math.tan(.5*e.fovX),y=_*_,v=n-r,b=n+r;let w,E;y>v/b?(w=n,E=n*_):(w=.5*b*(1+y),E=.5*Math.sqrt(v*v+2*(n*n+r*r)*y+b*b*y*y));const T=e.projection.pixelsPerMeter(e.center.lat,p),C=e._camera.getCameraToWorldMercator(),M=[0,0,-w*f];q.transformMat4(M,M,C);let A=E*f;const P=e._edgeInsets;if(!(P.left===0&&P.top===0&&P.right===0&&P.bottom===0||P.left===P.right&&P.top===P.bottom)){const at=e._camera.getWorldToCamera(e.worldSize,e.projection.zAxisUnit==="meters"?T:1),ot=e._camera.getCameraToClipPerspective(e._fov,e.width/e.height,r,n);ot[8]=2*-e.centerOffset.x/e.width,ot[9]=2*e.centerOffset.y/e.height;const It=new Float64Array(16);Q.mul(It,ot,at);const xt=new Float64Array(16);Q.invert(xt,It);const dt=Bu.fromInvProjectionMatrix(xt,p,a,!0);for(const yt of dt.points){const Ot=((L=yt)[0]/=l,L[1]/=l,L[2]=cr(L[2],e._center.lat),L);A=Math.max(A,q.len(q.subtract([],M,Ot)))}}var L;A*=i/(i-1);const R=Math.acos(t[2]),N=Math.atan2(-t[0],-t[1]),k=new od;k.position=M,k.setPitchBearing(R,N);const F=k.getWorldToCamera(p,T),z=A*p,U=Math.min(e._mercatorZfromZoom(17)*p*-2,-2*z),G=k.getCameraToClipOrthographic(-z,z,-z,z,U,(z+s*T)/t[2]),V=new Float64Array(16);Q.multiply(V,G,F);const K=q.fromValues(Math.floor(1e6*M[0])/1e6*p,Math.floor(1e6*M[1])/1e6*p,0),$=.5*i,tt=[0,0,0];q.transformMat4(tt,K,V),q.scale(tt,tt,$);const X=[Math.floor(tt[0]),Math.floor(tt[1]),Math.floor(tt[2])],J=[0,0,0];q.sub(J,tt,X),q.scale(J,J,-1/$);const nt=new Float64Array(16);return Q.identity(nt),Q.translate(nt,nt,J),Q.multiply(V,nt,V),[V,z]}function p2(e,t){return e!=null&&t!=null&&!(!e.hasData()||!t.hasData())&&e.demTexture!=null&&t.demTexture!=null&&e.tileID.key!==t.tileID.key}const pc=new class{constructor(){this.operations={}}newMorphing(e,t,r,n,i){if(e in this.operations){const s=this.operations[e];s.to.tileID.key!==r.tileID.key&&(s.queued=r)}else this.operations[e]={startTime:n,phase:0,duration:i,from:t,to:r,queued:null}}getMorphValuesForProxy(e){if(!(e in this.operations))return null;const t=this.operations[e];return{from:t.from,to:t.to,phase:t.phase}}update(e){for(const t in this.operations){const r=this.operations[t];for(r.phase=(e-r.startTime)/r.duration;r.phase>=1||!this._validOp(r);)if(!this._nextOp(r,e)){delete this.operations[t];break}}}_nextOp(e,t){return!!e.queued&&(e.from=e.to,e.to=e.queued,e.queued=null,e.phase=0,e.startTime=t,!0)}_validOp(e){return e.from.hasData()&&e.to.hasData()}},f2={0:null,1:"TERRAIN_VERTEX_MORPHING"};function d2(e,t,r){if(t===0)return 0;const n=t<1&&r===514?.25/t:1;return 6*Math.pow(1.5,22-e)*Math.max(t,1)*n}function $L(e,t){const r=1<<e.z;return!t&&(e.x===0||e.x===r-1)||e.y===0||e.y===r-1}const Cy=e=>({u_matrix:e});function m2(e,t,r,n,i){if(i>0){const s=ge.now(),a=(s-e.timeAdded)/i,l=t?(s-t.timeAdded)/i:-1,p=r.getSource(),f=n.coveringZoomLevel({tileSize:p.tileSize,roundZoom:p.roundZoom}),m=!t||Math.abs(t.tileID.overscaledZ-f)>Math.abs(e.tileID.overscaledZ-f),_=m&&e.refreshedUponExpiration?1:Bt(m?a:1-l,0,1);return e.refreshedUponExpiration&&a>=1&&(e.refreshedUponExpiration=!1),t?{opacity:1,mix:1-_}:{opacity:_,mix:0}}return{opacity:1,mix:0}}class KL extends ds{constructor(t){const r={type:"raster-dem",maxzoom:t.transform.maxZoom},n=new Xl(jh(),null),i=my("mock-dem",r,n,t.style);super("mock-dem",i,!1),i.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,r){t.state="loaded",r(null)}}class JL extends ds{constructor(t){const r=my("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new Xl(jh(),null),t.style);super("proxy",r,!1),r.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,r,n){if(t.freezeTileCoverage)return;this.transform=t;const i=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((s,a)=>{if(s[a.key]="",!this._tiles[a.key]){const l=new Dh(a,this._source.tileSize*a.overscaleFactor(),t.tileZoom);l.state="loaded",this._tiles[a.key]=l}return s},{});for(const s in this._tiles)s in i||(this.freeFBO(s),this._tiles[s].unloadVectorData(),delete this._tiles[s])}freeFBO(t){const r=this.proxyCachedFBO[t];if(r!==void 0){const n=Object.values(r);this.renderCachePool.push(...n),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class g2 extends wr{constructor(t,r,n){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=r,this.projMatrix=n}}class QL extends VM{constructor(t,r){super(),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[n,i,s]=function(p){const f=new $i,m=new xn,_=131;f.reserve(17161),m.reserve(33800);const y=lt/128,v=lt+y/2,b=v+y;for(let E=-y;E<b;E+=y)for(let T=-y;T<b;T+=y){const C=T<0||T>v||E<0||E>v?24575:0,M=Bt(Math.round(T),0,lt),A=Bt(Math.round(E),0,lt);f.emplaceBack(M+C,A)}const w=(E,T)=>{const C=T*_+E;m.emplaceBack(C+1,C,C+_),m.emplaceBack(C+_,C+_+1,C+1)};for(let E=1;E<129;E++)for(let T=1;T<129;T++)w(T,E);return[0,129].forEach(E=>{for(let T=0;T<130;T++)w(T,E),w(E,T)}),[f,m,32768]}(),a=t.context;this.gridBuffer=a.createVertexBuffer(n,$a.members),this.gridIndexBuffer=a.createIndexBuffer(i),this.gridSegments=mr.simpleSegment(0,0,n.length,i.length),this.gridNoSkirtSegments=mr.simpleSegment(0,0,n.length,s),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new JL(r.map),this.orthoMatrix=Q.create(),Q.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,lt,0,lt,0,1);const l=a.gl;this._overlapStencilMode=new Be({func:l.GEQUAL,mask:255},0,255,l.KEEP,l.KEEP,l.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=r,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new KL(r.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),t.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=t,this._checkRenderCacheEfficiency(),this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,r,n){if(t&&t.terrain){this._style!==t&&(this.style=t),this.enabled=!0;const i=t.terrain.properties;this.sourceCache=t.terrain.drapeRenderMode===0?this._mockSourceCache:t._getSourceCache(i.get("source")),this._exaggeration=i.get("exaggeration");const s=()=>{this.sourceCache.used&&Y(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const a=this.getScaledDemTileSize();this.sourceCache.update(r,a,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,s(),this._initializing=!0),s(),r.updateElevation(!0,n),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(r),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const t=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||t.efficiency!==100&&Y(`Terrain render cache efficiency is not optimal (${t.efficiency}%) and performance
                may be affected negatively, consider placing all background, fill and line layers before layer
                with id '${t.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._sourceCaches)this._style._sourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const r=this.proxySourceCache,n=this.painter.transform;this._initializing&&(this._initializing=n._centerAltitude===0&&this.getAtPointOrZero(Ue.fromLngLat(n.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const i=this.proxyCoords=r.getIds().map(p=>{const f=r.getTileByID(p).tileID;return f.projMatrix=n.calculateProjMatrix(f.toUnwrapped()),f});(function(p,f){const m=f.transform.pointCoordinate(f.transform.getCameraPoint()),_=new H(m.x,m.y);p.sort((y,v)=>{if(v.overscaledZ-y.overscaledZ)return v.overscaledZ-y.overscaledZ;const b=new H(y.canonical.x+(1<<y.canonical.z)*y.wrap,y.canonical.y),w=new H(v.canonical.x+(1<<v.canonical.z)*v.wrap,v.canonical.y),E=_.mult(1<<y.canonical.z);return E.x-=.5,E.y-=.5,E.distSqr(b)-E.distSqr(w)})})(i,this.painter),this._previousZoom=n.zoom;const s=this.proxyToSource||{};this.proxyToSource={},i.forEach(p=>{this.proxyToSource[p.key]={}}),this.terrainTileForTile={};const a=this._style._sourceCaches;for(const p in a){const f=a[p];if(!f.used||(f!==this.sourceCache&&this.resetTileLookupCache(f.id),this._setupProxiedCoordsForOrtho(f,t[p],s),f.usedForTerrain))continue;const m=t[p];f.getSource().reparseOverscaled&&this._assignTerrainTiles(m)}this.proxiedCoords[r.id]=i.map(p=>new g2(p,p.key,this.orthoMatrix)),this._assignTerrainTiles(i),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(s),this.renderingToTexture=!1,this._updateTimestamp=ge.now();const l={};this._visibleDemTiles=[];for(const p of this.proxyCoords){const f=this.terrainTileForTile[p.key];if(!f)continue;const m=f.tileID.key;m in l||(this._visibleDemTiles.push(f),l[m]=m)}}_assignTerrainTiles(t){this._initializing||t.forEach(r=>{if(this.terrainTileForTile[r.key])return;const n=this._findTileCoveringTileID(r,this.sourceCache);n&&(this.terrainTileForTile[r.key]=n)})}_prepareDEMTextures(){const t=this.painter.context,r=t.gl;for(const n in this.terrainTileForTile){const i=this.terrainTileForTile[n],s=i.dem;!s||i.demTexture&&!i.needsDEMTextureUpload||(t.activeTexture.set(r.TEXTURE1),l2(this.painter,i,s))}}_prepareDemTileUniforms(t,r,n,i){if(!r||r.demTexture==null)return!1;const s=t.tileID.canonical,a=Math.pow(2,r.tileID.canonical.z-s.z),l=i||"";return n[`u_dem_tl${l}`]=[s.x*a%1,s.y*a%1],n[`u_dem_scale${l}`]=a,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const t=this.painter.context,r=t.gl;if(!this._emptyDepthBufferTexture){const n=new Yr({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new dn(t,n,r.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let t=0;const r=this._visibleDemTiles.reduce((n,i)=>{if(!i.dem)return n;const s=i.dem.tree.minimums[0];return s>0&&t++,n+s},0);return t?r/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,r=t.gl;t.activeTexture.set(r.TEXTURE2);const n=this._getLoadedAreaMinimum(),i=new Yr({width:1,height:1},new Uint8Array($u.pack(n,this.sourceCache.getSource().encoding)));this._emptyDEMTextureDirty=!1;let s=this._emptyDEMTexture;return s?s.update(i,{premultiply:!1}):s=this._emptyDEMTexture=new dn(t,i,r.RGBA,{premultiply:!1}),s}setupElevationDraw(t,r,n){const i=this.painter.context,s=i.gl,a=(l=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:$u.getUnpackVector(l),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0});var l;a.u_dem_size=this.sourceCache.getSource().tileSize,a.u_exaggeration=this.exaggeration();let p=null,f=null,m=1;if(n&&n.morphing&&this._useVertexMorphing){const _=n.morphing.srcDemTile,y=n.morphing.dstDemTile;m=n.morphing.phase,_&&y&&(this._prepareDemTileUniforms(t,_,a,"_prev")&&(f=_),this._prepareDemTileUniforms(t,y,a)&&(p=y))}if(f&&p?(i.activeTexture.set(s.TEXTURE2),p.demTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),i.activeTexture.set(s.TEXTURE4),f.demTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),a.u_dem_lerp=m):(p=this.terrainTileForTile[t.tileID.key],i.activeTexture.set(s.TEXTURE2),(this._prepareDemTileUniforms(t,p,a)?p.demTexture:this.emptyDEMTexture).bind(s.NEAREST,s.CLAMP_TO_EDGE)),i.activeTexture.set(s.TEXTURE3),n&&n.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),this._depthFBO&&(a.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),a.u_depth_size_inv=[1,1]),n&&n.useMeterToDem&&p){const _=(1<<p.tileID.canonical.z)*cr(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;a.u_meter_to_dem=_}if(n&&n.labelPlaneMatrixInv&&(a.u_label_plane_matrix_inv=n.labelPlaneMatrixInv),r.setTerrainUniformValues(i,a),this.painter.transform.projection.name==="globe"){const _=this.globeUniformValues(this.painter.transform,t.tileID.canonical,n&&n.useDenormalizedUpVectorScale);r.setGlobeUniformValues(i,_)}}globeUniformValues(t,r,n){const i=t.projection;return{u_tile_tl_up:i.upVector(r,0,0),u_tile_tr_up:i.upVector(r,lt,0),u_tile_br_up:i.upVector(r,lt,lt),u_tile_bl_up:i.upVector(r,0,lt),u_tile_up_scale:n?xf(1):i.upVectorScale(r,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const r=this.painter,n=this.painter.context;t.length!==0&&(n.bindFramebuffer.set(null),n.viewport.set([0,0,r.width,r.height]),r.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(i,s,a,l,p){if(i.transform.projection.name==="globe")(function(f,m,_,y,v){const b=f.context,w=b.gl;let E,T;const C=f.transform,M=X1(f,b,C),A=G=>{if(T===G)return;const V=[f2[G],"PROJECTION_GLOBE_VIEW"];M&&V.push("CUSTOM_ANTIALIASING"),E=f.useProgram("globeRaster",null,V),T=G},P=f.colorModeForRenderPass(),L=new de(w.LEQUAL,de.ReadWrite,f.depthRangeFor3D);pc.update(v);const R=function(G){const V=G.pixelsPerMeter,K=V/cr(1,G.center.lat),$=Q.identity(new Float64Array(16));return Q.translate($,$,[G.point.x,G.point.y,0]),Q.scale($,$,[K,K,V]),Float32Array.from($)}(C),N=[Xn(C.center.lng),ri(C.center.lat)],k=f.globeSharedBuffers,F=[C.width*ge.devicePixelRatio,C.height*ge.devicePixelRatio],z=Float32Array.from(C.globeMatrix),U={useDenormalizedUpVectorScale:!0};{const G=f.transform,V=d2(G.zoom,m.exaggeration(),m.sourceCache._source.tileSize);T=-1;const K=w.TRIANGLES;for(const $ of y){const tt=_.getTile($),X=Be.disabled,J=m.prevTerrainTileForTile[$.key],nt=m.terrainTileForTile[$.key];p2(J,nt)&&pc.newMorphing($.key,J,nt,v,250),b.activeTexture.set(w.TEXTURE0),tt.texture.bind(w.LINEAR,w.CLAMP_TO_EDGE);const at=pc.getMorphValuesForProxy($.key),ot=at?1:0;at&&na(U,{morphing:{srcDemTile:at.from,dstDemTile:at.to,phase:Sr(at.phase)}});const It=bf($.canonical),xt=LC(It.getCenter().lat),dt=PC($.canonical,It,xt,G.worldSize/G._pixelsPerMercatorPixel),yt=Gu(hs($.canonical)),Ot=h2(G.projMatrix,z,R,yt,Zn(G.zoom),N,G.frustumCorners.TL,G.frustumCorners.TR,G.frustumCorners.BR,G.frustumCorners.BL,G.globeCenterInViewSpace,G.globeRadius,F,V,dt);if(A(ot),E&&(m.setupElevationDraw(tt,E,U),f.uploadCommonUniforms(b,E,$.toUnwrapped()),k)){const[Jt,Zt,Gt]=k.getGridBuffers(xt,V!==0);E.draw(f,K,L,X,P,Ge.backCCW,Ot,"globe_raster",Jt,Zt,Gt)}}}if(k){const G=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];M&&G.push("CUSTOM_ANTIALIASING"),E=f.useProgram("globeRaster",null,G);for(const V of y){const{x:K,y:$,z:tt}=V.canonical,X=$===0,J=$===(1<<tt)-1,[nt,at,ot,It]=k.getPoleBuffers(tt);if(It&&(X||J)){const xt=_.getTile(V);b.activeTexture.set(w.TEXTURE0),xt.texture.bind(w.LINEAR,w.CLAMP_TO_EDGE);let dt=AC(tt,K,C);const yt=Gu(hs(V.canonical)),Ot=(Jt,Zt)=>Jt.draw(f,w.TRIANGLES,L,Be.disabled,P,Ge.disabled,h2(C.projMatrix,dt,dt,yt,0,N,C.frustumCorners.TL,C.frustumCorners.TR,C.frustumCorners.BR,C.frustumCorners.BL,C.globeCenterInViewSpace,C.globeRadius,F,0),"globe_pole_raster",Zt,ot,It);m.setupElevationDraw(xt,E,U),f.uploadCommonUniforms(b,E,V.toUnwrapped()),X&&Ot(E,nt),J&&(dt=Q.scale(Q.create(),dt,[1,-1,1]),Ot(E,at))}}}})(i,s,a,l,p);else{const f=i.context,m=f.gl;let _,y;const v=i.shadowRenderer,b=A=>{y!==A&&(_=i.useProgram("terrainRaster",null,[f2[A]]),y=A)},w=i.colorModeForRenderPass(),E=new de(m.LEQUAL,de.ReadWrite,i.depthRangeFor3D);pc.update(p);const T=i.transform,C=d2(T.zoom,s.exaggeration(),s.sourceCache._source.tileSize);let M=[0,0,0];if(v){const A=i.style.directionalLight,P=i.style.ambientLight;A&&P&&(M=Sy(A,P))}{y=-1;const A=m.TRIANGLES,[P,L]=[s.gridIndexBuffer,s.gridSegments];for(const R of l){const N=a.getTile(R),k=Be.disabled,F=s.prevTerrainTileForTile[R.key],z=s.terrainTileForTile[R.key];p2(F,z)&&pc.newMorphing(R.key,F,z,p,250),f.activeTexture.set(m.TEXTURE0),N.texture.bind(m.LINEAR,m.CLAMP_TO_EDGE,m.LINEAR_MIPMAP_NEAREST);const U=pc.getMorphValuesForProxy(R.key),G=U?1:0;let V;U&&(V={morphing:{srcDemTile:U.from,dstDemTile:U.to,phase:Sr(U.phase)}});const K=c2(R.projMatrix,$L(R.canonical,T.renderWorldCopies)?C/10:C,M);if(b(G),!_)continue;s.setupElevationDraw(N,_,V);const $=R.toUnwrapped();v&&v.setupShadows($,_),i.uploadCommonUniforms(f,_,$),_.draw(i,A,E,k,w,Ge.backCCW,K,"terrain_raster",s.gridBuffer,P,L)}}}}(r,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,r.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const r=this.painter,n=this.painter.context,i=this.proxySourceCache,s=this.proxiedCoords[i.id],a=this._drapedRenderBatches.shift(),l=r.style.order,p=[];let f=0;for(const m of s){const _=i.getTileByID(m.proxyTileKey),y=i.proxyCachedFBO[m.key]?i.proxyCachedFBO[m.key][t]:void 0,v=y!==void 0?i.renderCache[y]:this.pool[f++],b=y!==void 0;if(_.texture=v.tex,b&&!v.dirty){p.push(_.tileID);continue}let w;n.bindFramebuffer.set(v.fb.framebuffer),this.renderedToTile=!1,v.dirty&&(n.clear({color:Se.transparent,stencil:0}),v.dirty=!1);for(let E=a.start;E<=a.end;++E){const T=r.style._layers[l[E]];if(T.isHidden(r.transform.zoom))continue;const C=r.style._getLayerSourceCache(T),M=C?this.proxyToSource[m.key][C.id]:[m];if(!M)continue;const A=M;n.viewport.set([0,0,v.fb.width,v.fb.height]),w!==(C?C.id:null)&&(this._setupStencil(v,M,T,C),w=C?C.id:null),r.renderLayer(r,C,T,A)}if(this._drapedRenderBatches.length===0)for(const E of this._pendingGroundEffectLayers){const T=r.style._layers[l[E]];if(T.isHidden(r.transform.zoom))continue;const C=r.style._getLayerSourceCache(T),M=C?this.proxyToSource[m.key][C.id]:[m];if(!M)continue;const A=M;n.viewport.set([0,0,v.fb.width,v.fb.height]),w!==(C?C.id:null)&&(this._setupStencil(v,M,T,C),w=C?C.id:null),r.renderLayer(r,C,T,A)}this.renderedToTile?(v.dirty=!0,p.push(_.tileID)):b||--f,f===5&&(f=0,this.renderToBackBuffer(p))}return this.renderToBackBuffer(p),this.renderingToTexture=!1,n.bindFramebuffer.set(null),n.viewport.set([0,0,r.width,r.height]),a.end+1}postRender(){}renderCacheEfficiency(t){const r=t.order.length;if(r===0)return{efficiency:100};let n,i=0,s=0,a=!1;for(let l=0;l<r;++l){const p=t._layers[t.order[l]];this._style.isLayerDraped(p)?(a&&++i,++s):a||(a=!0,n=p.id)}return s===0?{efficiency:100}:{efficiency:100*(1-i/s),firstUndrapedLayer:n}}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(r=>r.dem).forEach(r=>{t=Math.min(t,r.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,r,n){if(!this._visibleDemTiles)return null;const i=this._visibleDemTiles.filter(s=>s.dem).map(s=>{const a=s.tileID,l=1<<a.overscaledZ,{x:p,y:f}=a.canonical,m=p/l,_=(p+1)/l,y=f/l,v=(f+1)/l;return{minx:m,miny:y,maxx:_,maxy:v,t:s.dem.tree.raycastRoot(m,y,_,v,t,r,n),tile:s}});i.sort((s,a)=>(s.t!==null?s.t:Number.MAX_VALUE)-(a.t!==null?a.t:Number.MAX_VALUE));for(const s of i){if(s.t==null)return null;const a=s.tile.dem.tree.raycast(s.minx,s.miny,s.maxx,s.maxy,t,r,n);if(a!=null)return a}return null}_createFBO(){const t=this.painter.context,r=t.gl,n=this.drapeBufferSize;t.activeTexture.set(r.TEXTURE0);const i=new dn(t,{width:n[0],height:n[1],data:null},r.RGBA);i.bind(r.LINEAR,r.CLAMP_TO_EDGE);const s=t.createFramebuffer(n[0],n[1],!0,null);return s.colorAttachment.set(i.texture),s.depthAttachment=new dP(t,s.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,n[0],n[1]),this._stencilRef=0,s.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):s.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&!t.extTextureFilterAnisotropicForceOff&&r.texParameterf(r.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:s,tex:i,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const t in this._style._sourceCaches)if(this._style._sourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const r=this._style._layers[t],n=r.isHidden(this.painter.transform.zoom);return r.type==="custom"?!n&&r.shouldRedrape():!n&&r.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const n of this._style._getSources())if(n instanceof IE){t=!0;break}if(!t)return;const r={};for(let n=0;n<this._style.order.length;++n){const i=this._style._layers[this._style.order[n]],s=this._style._getLayerSourceCache(i);if(s&&!r[s.id]&&!i.isHidden(this.painter.transform.zoom)&&i.type==="line"&&i.widthExpression()instanceof Hp){r[s.id]=!0;for(const a of this.proxyCoords){const l=this.proxyToSource[a.key][s.id];if(l)for(const p of l)this._clearRenderCacheForTile(s.id,p)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const n in this._style._sourceCaches)if(this._style._sourceCaches[n]._source instanceof Uh){t=!0;break}if(!t)return;const r={};for(let n=0;n<this._style.order.length;++n){const i=this._style._layers[this._style.order[n]],s=this._style._getLayerSourceCache(i);if(!s||r[s.id]||i.isHidden(this.painter.transform.zoom)||i.type!=="raster")continue;const a=i.paint.get("raster-fade-duration");for(const l of this.proxyCoords){const p=this.proxyToSource[l.key][s.id];if(p)for(const f of p){const m=m2(s.getTile(f),s.findLoadedParent(f,0),s,this.painter.transform,a);(m.opacity!==1||m.mix!==0)&&this._clearRenderCacheForTile(s.id,f)}}}}_setupDrapedRenderBatches(){const t=this._style.order,r=t.length;if(r===0)return;const n=[];this._pendingGroundEffectLayers=[];let i,s=0,a=this._style._layers[t[s]];for(;!this._style.isLayerDraped(a)&&a.isHidden(this.painter.transform.zoom)&&++s<r;)a=this._style._layers[t[s]];for(;s<r;++s){const l=this._style._layers[t[s]];l.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(l)?i===void 0&&(i=s):(l.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(s),i!==void 0&&(n.push({start:i,end:s-1}),i=void 0)))}if(i!==void 0&&n.push({start:i,end:s-1}),n.length!==0){const l=n[n.length-1];this._pendingGroundEffectLayers.every(f=>f>l.end)||Y("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=n}_setupRenderCache(t){const r=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,r.renderCache.length>r.renderCachePool.length){const a=Object.values(r.proxyCachedFBO);r.proxyCachedFBO={};for(let l=0;l<a.length;++l){const p=Object.values(a[l]);r.renderCachePool.push(...p)}}return}this._clearRasterLayersFromRenderCache();const n=this.proxyCoords,i=this._tilesDirty;for(let a=n.length-1;a>=0;a--){const l=n[a];if(r.getTileByID(l.key),r.proxyCachedFBO[l.key]!==void 0){const p=t[l.key],f=this.proxyToSource[l.key];let m=0;for(const _ in f){const y=f[_],v=p[_];if(!v||v.length!==y.length||y.some((b,w)=>b!==v[w]||i[_]&&i[_].hasOwnProperty(b.key))){m=-1;break}++m}for(const _ in r.proxyCachedFBO[l.key])r.renderCache[r.proxyCachedFBO[l.key][_]].dirty=m<0||m!==Object.values(p).length}}const s=[...this._drapedRenderBatches];s.sort((a,l)=>l.end-l.start-(a.end-a.start));for(const a of s)for(const l of n){if(r.proxyCachedFBO[l.key])continue;let p=r.renderCachePool.pop();p===void 0&&r.renderCache.length<50&&(p=r.renderCache.length,r.renderCache.push(this._createFBO())),p!==void 0&&(r.proxyCachedFBO[l.key]={},r.proxyCachedFBO[l.key][a.start]=p,r.renderCache[p].dirty=!0)}this._tilesDirty={}}_setupStencil(t,r,n,i){if(!i||!this._sourceTilesOverlap[i.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const s=this.painter.context,a=s.gl;if(r.length<=1)return void(this._overlapStencilType=!1);let l;if(n.isTileClipped())l=r.length,this._overlapStencilMode.test={func:a.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(r[0].overscaledZ>r[r.length-1].overscaledZ))return void(this._overlapStencilType=!1);l=1,this._overlapStencilMode.test={func:a.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+l>255&&(s.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=l,this._overlapStencilMode.ref=this._stencilRef,n.isTileClipped()&&this._renderTileClippingMasks(r,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Be.disabled}_renderTileClippingMasks(t,r){const n=this.painter,i=this.painter.context,s=i.gl;n._tileClippingMaskIDs={},i.setColorMode(sr.disabled),i.setDepthMode(de.disabled);const a=n.useProgram("clippingMask");for(const l of t){const p=n._tileClippingMaskIDs[l.key]=--r;a.draw(n,s.TRIANGLES,de.disabled,new Be({func:s.ALWAYS,mask:0},p,255,s.KEEP,s.KEEP,s.REPLACE),sr.disabled,Ge.disabled,Cy(l.projMatrix),"$clipping",n.tileExtentBuffer,n.quadTriangleIndexBuffer,n.tileExtentSegments)}}pointCoordinate(t){const r=this.painter.transform;if(t.x<0||t.x>r.width||t.y<0||t.y>r.height)return null;const n=[t.x,t.y,1,1];gr.transformMat4(n,n,r.pixelMatrixInverse),gr.scale(n,n,1/n[3]),n[0]/=r.worldSize,n[1]/=r.worldSize;const i=r._camera.position,s=cr(1,r.center.lat),a=[i[0],i[1],i[2]/s,0],l=q.subtract([],n.slice(0,3),a);q.normalize(l,l);const p=this.raycast(a,l,this._exaggeration);return p!==null&&p?(q.scaleAndAdd(a,a,l,p),a[3]=a[2],a[2]*=s,a):null}drawDepth(){const t=this.painter,r=t.context,n=this.proxySourceCache,i=Math.ceil(t.width),s=Math.ceil(t.height);if(!this._depthFBO||this._depthFBO.width===i&&this._depthFBO.height===s||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const a=r.gl,l=r.createFramebuffer(i,s,!0,"renderbuffer");r.activeTexture.set(a.TEXTURE0);const p=new dn(r,{width:i,height:s,data:null},a.RGBA);p.bind(a.NEAREST,a.CLAMP_TO_EDGE),l.colorAttachment.set(p.texture);const f=r.createRenderbuffer(r.gl.DEPTH_COMPONENT16,i,s);l.depthAttachment.set(f),this._depthFBO=l,this._depthTexture=p}r.bindFramebuffer.set(this._depthFBO.framebuffer),r.viewport.set([0,0,i,s]),function(a,l,p,f){if(a.transform.projection.name==="globe")return;const m=a.context,_=m.gl;m.clear({depth:1});const y=a.useProgram("terrainDepth"),v=new de(_.LESS,de.ReadWrite,a.depthRangeFor3D);for(const b of f){const w=p.getTile(b),E=c2(b.projMatrix,0,[0,0,0]);l.setupElevationDraw(w,y),y.draw(a,_.TRIANGLES,v,Be.disabled,sr.unblended,Ge.backCCW,E,"terrain_depth",l.gridBuffer,l.gridIndexBuffer,l.gridNoSkirtSegments)}}(t,this,n,this.proxyCoords)}_setupProxiedCoordsForOrtho(t,r,n){if(t.getSource()instanceof Wl)return this._setupProxiedCoordsForImageSource(t,r,n);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const i=this.proxiedCoords[t.id]=[],s=this.proxyCoords;for(let l=0;l<s.length;l++){const p=s[l],f=this._findTileCoveringTileID(p,t);if(f){const m=this._createProxiedId(p,f,n[p.key]&&n[p.key][t.id]);i.push(m),this.proxyToSource[p.key][t.id]=[m]}}let a=!1;for(let l=0;l<r.length;l++){const p=t.getTile(r[l]);if(!p||!p.hasData())continue;const f=this._findTileCoveringTileID(p.tileID,this.proxySourceCache);if(f&&f.tileID.canonical.z!==p.tileID.canonical.z){const m=this.proxyToSource[f.tileID.key][t.id],_=this._createProxiedId(f.tileID,p,n[f.tileID.key]&&n[f.tileID.key][t.id]);m?m.splice(m.length-1,0,_):this.proxyToSource[f.tileID.key][t.id]=[_],i.push(_),a=!0}}this._sourceTilesOverlap[t.id]=a}_setupProxiedCoordsForImageSource(t,r,n){if(!t.getSource().loaded())return;const i=this.proxiedCoords[t.id]=[],s=this.proxyCoords,a=t.getSource(),l=new H(a.tileID.x,a.tileID.y)._div(1<<a.tileID.z),p=a.coordinates.map(Ue.fromLngLat).reduce((m,_)=>(m.min.x=Math.min(m.min.x,_.x-l.x),m.min.y=Math.min(m.min.y,_.y-l.y),m.max.x=Math.max(m.max.x,_.x-l.x),m.max.y=Math.max(m.max.y,_.y-l.y),m),{min:new H(Number.MAX_VALUE,Number.MAX_VALUE),max:new H(-Number.MAX_VALUE,-Number.MAX_VALUE)}),f=(m,_)=>{const y=m.wrap+m.canonical.x/(1<<m.canonical.z),v=m.canonical.y/(1<<m.canonical.z),b=lt/(1<<m.canonical.z),w=_.wrap+_.canonical.x/(1<<_.canonical.z),E=_.canonical.y/(1<<_.canonical.z);return y+b<w+p.min.x||y>w+p.max.x||v+b<E+p.min.y||v>E+p.max.y};for(let m=0;m<s.length;m++){const _=s[m];for(let y=0;y<r.length;y++){const v=t.getTile(r[y]);if(!v||!v.hasData()||f(_,v.tileID))continue;const b=this._createProxiedId(_,v,n[_.key]&&n[_.key][t.id]),w=this.proxyToSource[_.key][t.id];w?w.push(b):this.proxyToSource[_.key][t.id]=[b],i.push(b)}}}_createProxiedId(t,r,n){let i=this.orthoMatrix;if(n){const s=n.find(a=>a.key===r.tileID.key);if(s)return s}if(r.tileID.key!==t.key){const s=t.canonical.z-r.tileID.canonical.z;let a,l,p;i=Q.create();const f=r.tileID.wrap-t.wrap<<t.overscaledZ;s>0?(a=lt>>s,l=a*((r.tileID.canonical.x<<s)-t.canonical.x+f),p=a*((r.tileID.canonical.y<<s)-t.canonical.y)):(a=lt<<-s,l=lt*(r.tileID.canonical.x-(t.canonical.x+f<<-s)),p=lt*(r.tileID.canonical.y-(t.canonical.y<<-s))),Q.ortho(i,0,a,0,a,0,1),Q.translate(i,i,[l,p,0])}return new g2(r.tileID,t.key,i)}_findTileCoveringTileID(t,r){let n=r.getTile(t);if(n&&n.hasData())return n;const i=this._findCoveringTileCache[r.id],s=i[t.key];if(n=s?r.getTileByID(s):null,n&&n.hasData()||s===null)return n;let a=n?n.tileID:t,l=a.overscaledZ;const p=r.getSource().minzoom,f=[];if(!s){const _=r.getSource().maxzoom;if(t.canonical.z>=_){const y=t.canonical.z-_;r.getSource().reparseOverscaled?(l=Math.max(t.canonical.z+2,r.transform.tileZoom),a=new wr(l,t.wrap,_,t.canonical.x>>y,t.canonical.y>>y)):y!==0&&(l=_,a=new wr(l,t.wrap,_,t.canonical.x>>y,t.canonical.y>>y))}a.key!==t.key&&(f.push(a.key),n=r.getTile(a))}const m=_=>{f.forEach(y=>{i[y]=_}),f.length=0};for(l-=1;l>=p&&(!n||!n.hasData());l--){n&&m(n.tileID.key);const _=a.calculateScaledKey(l);if(n=r.getTileByID(_),n&&n.hasData())break;const y=i[_];if(y===null)break;y===void 0?f.push(_):n=r.getTileByID(y)}return m(n?n.tileID.key:null),n&&n.hasData()?n:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,r){let n=this._tilesDirty[t];n||(n=this._tilesDirty[t]={}),n[r.key]=!0}}function tD(e,t,r){const n=function(l,p,f){const m=q.dot(p,l),_=q.dot(f,[.2126,.7152,.0722]),y=(b,w,E)=>(1-E)*b+E*w,v=y(1-.3*Math.min(_,1),1,Math.min(m+1,1));return y(.92,1,Math.asin(Bt(p[2],-1,1))/Math.PI+.5)*v}(e,[0,0,1],t),i=[0,0,0];q.scale(i,r.slice(0,3),n);const s=[0,0,0];q.scale(s,t.slice(0,3),e[2]);const a=[0,0,0];return q.add(a,i,s),Ur(a)}const eD=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],rD=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class _2{static cacheKey(t,r,n,i){let s=`${r}${i?i.cacheKey:""}`;for(const a of n)t.usedDefines.includes(a)&&(s+=`/${a}`);return s}constructor(t,r,n,i,s,a){const l=t.gl;this.program=l.createProgram(),this.configuration=i,this.name=r,this.fixedDefines=[...a];const p=function(T){const C=[];for(let M=0;M<T.length;M++){if(T[M]===null)continue;const A=T[M].split(" ");C.push(A.pop())}return C}(n.staticAttributes),f=i?i.getBinderAttributes():[],m=p.concat(f);let _=i?i.defines():[];_=_.concat(a.map(T=>`#define ${T}`));const y=t.isWebGL2?`#version 300 es
`:"",v=y+_.concat(t.extStandardDerivatives&&y.length===0?`#extension GL_OES_standard_derivatives : enable
`.concat(Iy):Iy,Iy,o2,s2,i2.fragmentSource,Ey.fragmentSource,Ty.fragmentSource,n.fragmentSource).join(`
`),b=y+_.concat(`
#ifdef GL_ES
precision highp float;
#else

#if !defined(lowp)
#define lowp
#endif

#if !defined(mediump)
#define mediump
#endif

#if !defined(highp)
#define highp
#endif

#endif`,o2,s2,i2.vertexSource,Ey.vertexSource,Ty.vertexSource,n2.vertexSource,n.vertexSource).join(`
`),w=l.createShader(l.FRAGMENT_SHADER);if(l.isContextLost())return void(this.failedToCreate=!0);l.shaderSource(w,v),l.compileShader(w),l.attachShader(this.program,w);const E=l.createShader(l.VERTEX_SHADER);if(l.isContextLost())this.failedToCreate=!0;else{l.shaderSource(E,b),l.compileShader(E),l.attachShader(this.program,E),this.attributes={},this.numAttributes=m.length;for(let T=0;T<this.numAttributes;T++)if(m[T]){const C=m[T].startsWith("a_")?m[T]:`a_${m[T]}`;l.bindAttribLocation(this.program,T,C),this.attributes[C]=T}l.linkProgram(this.program),l.deleteShader(E),l.deleteShader(w),this.fixedUniforms=s(t),this.binderUniforms=i?i.getUniforms(t):[],a.includes("TERRAIN")&&(this.terrainUniforms=(T=>({u_dem:new Pe(T),u_dem_prev:new Pe(T),u_dem_unpack:new fo(T),u_dem_tl:new Fe(T),u_dem_scale:new Et(T),u_dem_tl_prev:new Fe(T),u_dem_scale_prev:new Et(T),u_dem_size:new Et(T),u_dem_lerp:new Et(T),u_exaggeration:new Et(T),u_depth:new Pe(T),u_depth_size_inv:new Fe(T),u_meter_to_dem:new Et(T),u_label_plane_matrix_inv:new ve(T)}))(t)),a.includes("GLOBE")&&(this.globeUniforms=(T=>({u_tile_tl_up:new _e(T),u_tile_tr_up:new _e(T),u_tile_br_up:new _e(T),u_tile_bl_up:new _e(T),u_tile_up_scale:new Et(T)}))(t)),a.includes("FOG")&&(this.fogUniforms=(T=>({u_fog_matrix:new ve(T),u_fog_range:new Fe(T),u_fog_color:new fo(T),u_fog_horizon_blend:new Et(T),u_fog_temporal_offset:new Et(T),u_frustum_tl:new _e(T),u_frustum_tr:new _e(T),u_frustum_br:new _e(T),u_frustum_bl:new _e(T),u_globe_pos:new _e(T),u_globe_radius:new Et(T),u_globe_transition:new Et(T),u_is_globe:new Pe(T),u_viewport:new Fe(T)}))(t)),a.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(T=>({u_lighting_ambient_color:new _e(T),u_lighting_directional_dir:new _e(T),u_lighting_directional_color:new _e(T),u_ground_radiance:new _e(T)}))(t)),a.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(T=>({u_light_matrix_0:new ve(T),u_light_matrix_1:new ve(T),u_fade_range:new Fe(T),u_shadow_normal_offset:new _e(T),u_shadow_intensity:new Et(T),u_texel_size:new Et(T),u_shadow_direction:new _e(T),u_shadow_bias:new _e(T),u_shadowmap_0:new Pe(T),u_shadowmap_1:new Pe(T)}))(t))}}setTerrainUniformValues(t,r){if(!this.terrainUniforms)return;const n=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const i in r)n[i]&&n[i].set(this.program,i,r[i])}}setGlobeUniformValues(t,r){if(!this.globeUniforms)return;const n=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const i in r)n[i]&&n[i].set(this.program,i,r[i])}}setFogUniformValues(t,r){if(!this.fogUniforms)return;const n=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const i in r)n[i].set(this.program,i,r[i])}}setLightsUniformValues(t,r){if(!this.lightsUniforms)return;const n=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const i in r)n[i].set(this.program,i,r[i])}}setShadowUniformValues(t,r){if(this.failedToCreate||!this.shadowUniforms)return;const n=this.shadowUniforms;t.program.set(this.program);for(const i in r)n[i].set(this.program,i,r[i])}_drawDebugWireframe(t,r,n,i,s,a,l,p,f){const m=t.options.wireframe;if(m.terrain===!1&&m.layers2D===!1&&m.layers3D===!1)return;const _=t.context;if(!_.isWebGL2||!(()=>!(!m.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!m.layers2D||t._terrain&&t._terrain.renderingToTexture||!eD.includes(this.name))||!(!m.layers3D||!rD.includes(this.name)))())return;const y=_.gl,v=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,s,_);if(!v)return;const b=[...this.fixedDefines];b.push("DEBUG_WIREFRAME");const w=t.useProgram(this.name,this.configuration,b);_.program.set(w.program);const E=(T,C,M)=>{if(C[T]&&M[T])for(const A in C[T])M[T][A]&&M[T][A].set(M.program,A,C[T][A].current)};f&&f.setUniforms(w.program,_,w.binderUniforms,l,{zoom:p}),E("fixedUniforms",this,w),E("terrainUniforms",this,w),E("globeUniforms",this,w),E("fogUniforms",this,w),E("lightsUniforms",this,w),E("shadowUniforms",this,w),v.bind(),_.setColorMode(new sr([y.ONE,y.ONE_MINUS_SRC_ALPHA,y.ZERO,y.ONE],Se.transparent,[!0,!0,!0,!1])),_.setDepthMode(new de(r.func===y.LESS?y.LEQUAL:r.func,de.ReadOnly,r.range)),_.setStencilMode(Be.disabled),y.drawElements(y.LINES,3*a.primitiveLength*2,y.UNSIGNED_SHORT,3*a.primitiveOffset*2*2),s.bind(),_.program.set(this.program),_.setDepthMode(r),_.setStencilMode(n),_.setColorMode(i)}draw(t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E){const T=t.context,C=T.gl;if(this.failedToCreate)return;T.program.set(this.program),T.setDepthMode(n),T.setStencilMode(i),T.setColorMode(s),T.setCullFace(a);for(const A of Object.keys(this.fixedUniforms))this.fixedUniforms[A].set(this.program,A,l[A]);b&&b.setUniforms(this.program,T,this.binderUniforms,y,{zoom:v});const M={[C.LINES]:2,[C.TRIANGLES]:3,[C.LINE_STRIP]:1}[r];for(const A of _.get()){const P=A.vaos||(A.vaos={});(P[p]||(P[p]=new qL)).bind(T,this,f,b?b.getPaintVertexBuffers():[],m,A.vertexOffset,w||[]),T.isWebGL2&&E&&E>1?C.drawElementsInstanced(r,A.primitiveLength*M,C.UNSIGNED_SHORT,A.primitiveOffset*M*2,E):C.drawElements(r,A.primitiveLength*M,C.UNSIGNED_SHORT,A.primitiveOffset*M*2),r===C.TRIANGLES&&this._drawDebugWireframe(t,n,i,s,m,A,y,v,b)}}}function y2(e,t){const r=Math.pow(2,t.tileID.overscaledZ),n=t.tileSize*Math.pow(2,e.transform.tileZoom)/r,i=n*(t.tileID.canonical.x+t.tileID.wrap*r),s=n*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture.size,u_tile_units_to_pixels:1/Zl(t,1,e.transform.tileZoom),u_pixel_coord_upper:[i>>16,s>>16],u_pixel_coord_lower:[65535&i,65535&s]}}const nD=Q.create(),v2=(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b)=>{const w=t.style.light,E=w.properties.get("position"),T=[E.x,E.y,E.z],C=Ri.create();w.properties.get("anchor")==="viewport"&&(Ri.fromRotation(C,-t.transform.angle),q.transformMat3(T,T,C));const M=w.properties.get("color"),A=t.transform,P={u_matrix:e,u_lightpos:T,u_lightintensity:w.properties.get("intensity"),u_lightcolor:[M.r,M.g,M.b],u_vertical_gradient:+r,u_opacity:n,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:nD,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:i,u_edge_radius:s,u_flood_light_color:_,u_vertical_scale:y,u_flood_light_intensity:v,u_ground_shadow_factor:b};return A.projection.name==="globe"&&(P.u_tile_id=[a.canonical.x,a.canonical.y,1<<a.canonical.z],P.u_zoom_transition=p,P.u_inv_rot_matrix=m,P.u_merc_center=f,P.u_up_dir=A.projection.upVector(new da(0,0,0),f[0]*lt,f[1]*lt),P.u_height_lift=l),P},iD=(e,t,r)=>({u_matrix:e,u_edge_radius:t,u_vertical_scale:r}),oD=(e,t,r,n,i,s,a,l,p,f,m,_,y,v)=>{const b=v2(e,t,r,n,i,s,a,p,f,m,_,y,v,1,[0,0,0]),w={u_height_factor:-Math.pow(2,a.overscaledZ)/l.tileSize/8};return Yt(b,y2(t,l),w)},sD=(e,t,r,n,i,s,a,l,p)=>({u_matrix:t,u_opacity:r,u_ao_pass:n?1:0,u_meter_to_tile:i,u_ao:s,u_flood_light_intensity:a,u_flood_light_color:l,u_attenuation:p,u_fb:0}),x2=(e,t)=>({u_matrix:e,u_emissive_strength:t}),b2=(e,t,r,n)=>Yt(x2(e,t),y2(r,n)),aD=(e,t,r)=>({u_matrix:e,u_world:r,u_emissive_strength:t}),lD=(e,t,r,n,i)=>Yt(b2(e,t,r,n),{u_world:i}),uD=Q.create(),cD=(e,t,r,n,i,s)=>{const a=e.transform,l=a.projection.name==="globe";let p;if(s.paint.get("circle-pitch-alignment")==="map")if(l){const m=q1(a.zoom,t.canonical)*a._pixelsPerMercatorPixel;p=Float32Array.from([m,0,0,m])}else p=a.calculatePixelsToTileUnitsMatrix(r);else p=new Float32Array([a.pixelsToGLUnits[0],0,0,a.pixelsToGLUnits[1]]);const f={u_camera_to_center_distance:a.cameraToCenterDistance,u_matrix:e.translatePosMatrix(t.projMatrix,r,s.paint.get("circle-translate"),s.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ge.devicePixelRatio,u_extrude_scale:p,u_inv_rot_matrix:uD,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:s.paint.get("circle-emissive-strength")};if(l){f.u_inv_rot_matrix=n,f.u_merc_center=i,f.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],f.u_zoom_transition=Zn(a.zoom);const m=i[0]*lt,_=i[1]*lt;f.u_up_dir=a.projection.upVector(new da(0,0,0),m,_)}return f},hD=e=>{const t=[];return e.paint.get("circle-pitch-alignment")==="map"&&t.push("PITCH_WITH_MAP"),e.paint.get("circle-pitch-scale")==="map"&&t.push("SCALE_WITH_MAP"),t},pD=(e,t,r,n)=>{const i=lt/r.tileSize;return{u_matrix:e,u_camera_to_center_distance:t.getCameraToCenterDistance(n),u_extrude_scale:[t.pixelsToGLUnits[0]/i,t.pixelsToGLUnits[1]/i]}},w2=(e,t,r=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:r}),fD=Q.create(),dD=(e,t,r,n,i,s,a)=>{const l=e.transform,p=l.projection.name==="globe",f=p?q1(l.zoom,t.canonical)*l._pixelsPerMercatorPixel:Zl(r,1,s),m={u_matrix:t.projMatrix,u_extrude_scale:f,u_intensity:a,u_inv_rot_matrix:fD,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(p){m.u_inv_rot_matrix=n,m.u_merc_center=i,m.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],m.u_zoom_transition=Zn(l.zoom);const _=i[0]*lt,y=i[1]*lt;m.u_up_dir=l.projection.upVector(new da(0,0,0),_,y)}return m},mD=(e,t,r,n,i,s,a)=>{const l=e.transform,p=l.calculatePixelsToTileUnitsMatrix(t);return{u_matrix:T2(e,t,r,n),u_pixels_to_tile_units:p,u_device_pixel_ratio:s,u_units_to_pixels:[1/l.pixelsToGLUnits[0],1/l.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:i,u_texsize:I2(r)?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:E2(t,e.transform),u_alpha_discard_threshold:0,u_trim_offset:a,u_emissive_strength:r.paint.get("line-emissive-strength")}},gD=(e,t,r,n,i)=>{const s=e.transform;return{u_matrix:T2(e,t,r,n),u_texsize:t.imageAtlasTexture.size,u_pixels_to_tile_units:s.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:i,u_image:0,u_tile_units_to_pixels:E2(t,s),u_units_to_pixels:[1/s.pixelsToGLUnits[0],1/s.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function E2(e,t){return 1/Zl(e,1,t.tileZoom)}function T2(e,t,r,n){return e.translatePosMatrix(n||t.tileID.projMatrix,t,r.paint.get("line-translate"),r.paint.get("line-translate-anchor"))}function I2(e){const t=e.paint.get("line-dasharray").value;return t.value||t.kind!=="constant"}const _D=(e,t,r,n,i,s,a,l,p)=>{return{u_matrix:e,u_tl_parent:t,u_scale_parent:r,u_fade_t:n.mix,u_opacity:n.opacity*i.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:i.paint.get("raster-brightness-min"),u_brightness_high:i.paint.get("raster-brightness-max"),u_saturation_factor:(m=i.paint.get("raster-saturation"),m>0?1-1/(1.001-m):-m),u_contrast_factor:(f=i.paint.get("raster-contrast"),f>0?1/(1-f):1+f),u_spin_weights:yD(i.paint.get("raster-hue-rotate")),u_perspective_transform:s,u_colorization_mix:l,u_colorization_scale:vD(p),u_color_ramp:a};var f,m};function yD(e){e*=Math.PI/180;const t=Math.sin(e),r=Math.cos(e);return[(2*r+1)/3,(-Math.sqrt(3)*t-r+1)/3,(Math.sqrt(3)*t-r+1)/3]}function vD([e,t]){return e===t?[e,t]:[-e/(t-e),1/(t-e)]}const S2=Q.create(),C2=(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E)=>{const T=i.transform,C={u_is_size_zoom_constant:+(e==="constant"||e==="source"),u_is_size_feature_constant:+(e==="constant"||e==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:T.getCameraToCenterDistance(w),u_rotate_symbol:+r,u_aspect_ratio:T.width/T.height,u_fade_change:i.options.fadeDuration?i.symbolFadeChange:1,u_matrix:s,u_label_plane_matrix:a,u_coord_matrix:l,u_is_text:+p,u_pitch_with_map:+n,u_texsize:f,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:S2,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:S2,u_up_vector:[0,-1,0],u_icon_transition:E||0};return w.name==="globe"&&(C.u_tile_id=[m.canonical.x,m.canonical.y,1<<m.canonical.z],C.u_zoom_transition=_,C.u_inv_rot_matrix=v,C.u_merc_center=y,C.u_camera_forward=T._camera.forward(),C.u_ecef_origin=function(M,A){const P=[0,0,0],L=Gu(hs(A.canonical));return q.transformMat4(P,P,L),q.transformMat4(P,P,M),P}(T.globeMatrix,m.toUnwrapped()),C.u_tile_matrix=Float32Array.from(T.globeMatrix),C.u_up_vector=b),C},M2=(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E)=>Yt(C2(e,t,r,n,i,s,a,l,p,f,_,y,v,b,w,E),{u_gamma_scale:n?i.transform.getCameraToCenterDistance(E)*Math.cos(i.terrain?0:i.transform._pitch):1,u_device_pixel_ratio:ge.devicePixelRatio,u_is_halo:+m,undefined:void 0}),xD=(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w)=>Yt(M2(e,t,r,n,i,s,a,l,!0,p,!0,m,_,y,v,b,w),{u_texsize_icon:f,u_texture_icon:1}),bD=(e,t,r,n)=>({u_matrix:e,u_emissive_strength:t,u_opacity:r,u_color:n}),wD=(e,t,r,n,i,s,a)=>Yt(function(l,p,f,m){const _=f.imageManager.getPattern(l.toString(),p),{width:y,height:v}=f.imageManager.getPixelSize(p),b=Math.pow(2,m.tileID.overscaledZ),w=m.tileSize*Math.pow(2,f.transform.tileZoom)/b,E=w*(m.tileID.canonical.x+m.tileID.wrap*b),T=w*m.tileID.canonical.y;return{u_image:0,u_pattern_tl:_.tl,u_pattern_br:_.br,u_texsize:[y,v],u_pattern_size:_.displaySize,u_tile_units_to_pixels:1/Zl(m,1,f.transform.tileZoom),u_pixel_coord_upper:[E>>16,T>>16],u_pixel_coord_lower:[65535&E,65535&T]}}(i,s,n,a),{u_matrix:e,u_emissive_strength:t,u_opacity:r}),My=(e,t,r,n,i,s,a,l,p,f,m,_=[0,0,0])=>{const y=n.style.light,v=y.properties.get("position"),b=[-v.x,-v.y,v.z],w=Ri.create();y.properties.get("anchor")==="viewport"&&(Ri.fromRotation(w,-n.transform.angle),q.transformMat3(b,b,w));const E=f.alphaMode==="MASK",T=y.properties.get("color"),C=m.paint.get("model-ambient-occlusion-intensity"),M=m.paint.get("model-color").constantOr(Se.white),A=m.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:e,u_lighting_matrix:t,u_normal_matrix:r,u_lightpos:b,u_lightintensity:y.properties.get("intensity"),u_lightcolor:[T.r,T.g,T.b],u_camera_pos:_,u_opacity:i,u_baseTextureIsAlpha:0,u_alphaMask:+E,u_alphaCutoff:f.alphaCutoff,u_baseColorFactor:[s.r,s.g,s.b,s.a],u_emissiveFactor:[a[0],a[1],a[2],1],u_metallicFactor:l,u_roughnessFactor:p,u_baseColorTexture:Qi.BaseColor,u_metallicRoughnessTexture:Qi.MetallicRoughness,u_normalTexture:Qi.Normal,u_occlusionTexture:Qi.Occlusion,u_emissionTexture:Qi.Emission,u_color_mix:[M.r,M.g,M.b,A],u_aoIntensity:C}},A2=new Float32Array(16),P2=(e,t=A2,r=A2)=>({u_matrix:e,u_instance:t,u_node_matrix:r}),ED={fillExtrusion:e=>({u_matrix:new ve(e),u_lightpos:new _e(e),u_lightintensity:new Et(e),u_lightcolor:new _e(e),u_vertical_gradient:new Et(e),u_opacity:new Et(e),u_edge_radius:new Et(e),u_ao:new Fe(e),u_tile_id:new _e(e),u_zoom_transition:new Et(e),u_inv_rot_matrix:new ve(e),u_merc_center:new Fe(e),u_up_dir:new _e(e),u_height_lift:new Et(e),u_flood_light_color:new _e(e),u_vertical_scale:new Et(e),u_flood_light_intensity:new Et(e),u_ground_shadow_factor:new _e(e)}),fillExtrusionDepth:e=>({u_matrix:new ve(e),u_edge_radius:new Et(e),u_vertical_scale:new Et(e)}),fillExtrusionPattern:e=>({u_matrix:new ve(e),u_lightpos:new _e(e),u_lightintensity:new Et(e),u_lightcolor:new _e(e),u_vertical_gradient:new Et(e),u_height_factor:new Et(e),u_edge_radius:new Et(e),u_ao:new Fe(e),u_tile_id:new _e(e),u_zoom_transition:new Et(e),u_inv_rot_matrix:new ve(e),u_merc_center:new Fe(e),u_up_dir:new _e(e),u_height_lift:new Et(e),u_image:new Pe(e),u_texsize:new Fe(e),u_pixel_coord_upper:new Fe(e),u_pixel_coord_lower:new Fe(e),u_tile_units_to_pixels:new Et(e),u_opacity:new Et(e)}),fillExtrusionGroundEffect:e=>({u_matrix:new ve(e),u_opacity:new Et(e),u_ao_pass:new Et(e),u_meter_to_tile:new Et(e),u_ao:new Fe(e),u_flood_light_intensity:new Et(e),u_flood_light_color:new _e(e),u_attenuation:new Et(e),u_fb:new Pe(e)}),fill:e=>({u_matrix:new ve(e),u_emissive_strength:new Et(e)}),fillPattern:e=>({u_matrix:new ve(e),u_emissive_strength:new Et(e),u_image:new Pe(e),u_texsize:new Fe(e),u_pixel_coord_upper:new Fe(e),u_pixel_coord_lower:new Fe(e),u_tile_units_to_pixels:new Et(e)}),fillOutline:e=>({u_matrix:new ve(e),u_emissive_strength:new Et(e),u_world:new Fe(e)}),fillOutlinePattern:e=>({u_matrix:new ve(e),u_emissive_strength:new Et(e),u_world:new Fe(e),u_image:new Pe(e),u_texsize:new Fe(e),u_pixel_coord_upper:new Fe(e),u_pixel_coord_lower:new Fe(e),u_tile_units_to_pixels:new Et(e)}),circle:e=>({u_camera_to_center_distance:new Et(e),u_extrude_scale:new qg(e),u_device_pixel_ratio:new Et(e),u_matrix:new ve(e),u_inv_rot_matrix:new ve(e),u_merc_center:new Fe(e),u_tile_id:new _e(e),u_zoom_transition:new Et(e),u_up_dir:new _e(e),u_emissive_strength:new Et(e)}),collisionBox:e=>({u_matrix:new ve(e),u_camera_to_center_distance:new Et(e),u_extrude_scale:new Fe(e)}),collisionCircle:e=>({u_matrix:new ve(e),u_inv_matrix:new ve(e),u_camera_to_center_distance:new Et(e),u_viewport_size:new Fe(e)}),debug:e=>({u_color:new zu(e),u_matrix:new ve(e),u_overlay:new Pe(e),u_overlay_scale:new Et(e)}),clippingMask:e=>({u_matrix:new ve(e)}),heatmap:e=>({u_extrude_scale:new Et(e),u_intensity:new Et(e),u_matrix:new ve(e),u_inv_rot_matrix:new ve(e),u_merc_center:new Fe(e),u_tile_id:new _e(e),u_zoom_transition:new Et(e),u_up_dir:new _e(e)}),heatmapTexture:e=>({u_image:new Pe(e),u_color_ramp:new Pe(e),u_opacity:new Et(e)}),hillshade:e=>({u_matrix:new ve(e),u_image:new Pe(e),u_latrange:new Fe(e),u_light:new Fe(e),u_shadow:new zu(e),u_highlight:new zu(e),u_accent:new zu(e)}),hillshadePrepare:e=>({u_matrix:new ve(e),u_image:new Pe(e),u_dimension:new Fe(e),u_zoom:new Et(e),u_unpack:new fo(e)}),line:e=>({u_matrix:new ve(e),u_pixels_to_tile_units:new qg(e),u_device_pixel_ratio:new Et(e),u_units_to_pixels:new Fe(e),u_dash_image:new Pe(e),u_gradient_image:new Pe(e),u_image_height:new Et(e),u_texsize:new Fe(e),u_tile_units_to_pixels:new Et(e),u_alpha_discard_threshold:new Et(e),u_trim_offset:new Fe(e),u_emissive_strength:new Et(e)}),linePattern:e=>({u_matrix:new ve(e),u_texsize:new Fe(e),u_pixels_to_tile_units:new qg(e),u_device_pixel_ratio:new Et(e),u_image:new Pe(e),u_units_to_pixels:new Fe(e),u_tile_units_to_pixels:new Et(e),u_alpha_discard_threshold:new Et(e)}),raster:e=>({u_matrix:new ve(e),u_tl_parent:new Fe(e),u_scale_parent:new Et(e),u_fade_t:new Et(e),u_opacity:new Et(e),u_image0:new Pe(e),u_image1:new Pe(e),u_brightness_low:new Et(e),u_brightness_high:new Et(e),u_saturation_factor:new Et(e),u_contrast_factor:new Et(e),u_spin_weights:new _e(e),u_perspective_transform:new Fe(e),u_colorization_mix:new fo(e),u_colorization_scale:new Fe(e),u_color_ramp:new Pe(e)}),symbolIcon:e=>({u_is_size_zoom_constant:new Pe(e),u_is_size_feature_constant:new Pe(e),u_size_t:new Et(e),u_size:new Et(e),u_camera_to_center_distance:new Et(e),u_rotate_symbol:new Pe(e),u_aspect_ratio:new Et(e),u_fade_change:new Et(e),u_matrix:new ve(e),u_label_plane_matrix:new ve(e),u_coord_matrix:new ve(e),u_is_text:new Pe(e),u_pitch_with_map:new Pe(e),u_texsize:new Fe(e),u_tile_id:new _e(e),u_zoom_transition:new Et(e),u_inv_rot_matrix:new ve(e),u_merc_center:new Fe(e),u_camera_forward:new _e(e),u_tile_matrix:new ve(e),u_up_vector:new _e(e),u_ecef_origin:new _e(e),u_texture:new Pe(e),u_icon_transition:new Et(e)}),symbolSDF:e=>({u_is_size_zoom_constant:new Pe(e),u_is_size_feature_constant:new Pe(e),u_size_t:new Et(e),u_size:new Et(e),u_camera_to_center_distance:new Et(e),u_rotate_symbol:new Pe(e),u_aspect_ratio:new Et(e),u_fade_change:new Et(e),u_matrix:new ve(e),u_label_plane_matrix:new ve(e),u_coord_matrix:new ve(e),u_is_text:new Pe(e),u_pitch_with_map:new Pe(e),u_texsize:new Fe(e),u_texture:new Pe(e),u_gamma_scale:new Et(e),u_device_pixel_ratio:new Et(e),u_tile_id:new _e(e),u_zoom_transition:new Et(e),u_inv_rot_matrix:new ve(e),u_merc_center:new Fe(e),u_camera_forward:new _e(e),u_tile_matrix:new ve(e),u_up_vector:new _e(e),u_ecef_origin:new _e(e),u_is_halo:new Pe(e)}),symbolTextAndIcon:e=>({u_is_size_zoom_constant:new Pe(e),u_is_size_feature_constant:new Pe(e),u_size_t:new Et(e),u_size:new Et(e),u_camera_to_center_distance:new Et(e),u_rotate_symbol:new Pe(e),u_aspect_ratio:new Et(e),u_fade_change:new Et(e),u_matrix:new ve(e),u_label_plane_matrix:new ve(e),u_coord_matrix:new ve(e),u_is_text:new Pe(e),u_pitch_with_map:new Pe(e),u_texsize:new Fe(e),u_texsize_icon:new Fe(e),u_texture:new Pe(e),u_texture_icon:new Pe(e),u_gamma_scale:new Et(e),u_device_pixel_ratio:new Et(e),u_is_halo:new Pe(e)}),background:e=>({u_matrix:new ve(e),u_emissive_strength:new Et(e),u_opacity:new Et(e),u_color:new zu(e)}),backgroundPattern:e=>({u_matrix:new ve(e),u_emissive_strength:new Et(e),u_opacity:new Et(e),u_image:new Pe(e),u_pattern_tl:new Fe(e),u_pattern_br:new Fe(e),u_texsize:new Fe(e),u_pattern_size:new Fe(e),u_pixel_coord_upper:new Fe(e),u_pixel_coord_lower:new Fe(e),u_tile_units_to_pixels:new Et(e)}),terrainRaster:u2,terrainDepth:u2,skybox:e=>({u_matrix:new ve(e),u_sun_direction:new _e(e),u_cubemap:new Pe(e),u_opacity:new Et(e),u_temporal_offset:new Et(e)}),skyboxGradient:e=>({u_matrix:new ve(e),u_color_ramp:new Pe(e),u_center_direction:new _e(e),u_radius:new Et(e),u_opacity:new Et(e),u_temporal_offset:new Et(e)}),skyboxCapture:e=>({u_matrix_3f:new xx(e),u_sun_direction:new _e(e),u_sun_intensity:new Et(e),u_color_tint_r:new fo(e),u_color_tint_m:new fo(e),u_luminance:new Et(e)}),globeRaster:e=>({u_proj_matrix:new ve(e),u_globe_matrix:new ve(e),u_normalize_matrix:new ve(e),u_merc_matrix:new ve(e),u_zoom_transition:new Et(e),u_merc_center:new Fe(e),u_image0:new Pe(e),u_grid_matrix:new xx(e),u_skirt_height:new Et(e),u_frustum_tl:new _e(e),u_frustum_tr:new _e(e),u_frustum_br:new _e(e),u_frustum_bl:new _e(e),u_globe_pos:new _e(e),u_globe_radius:new Et(e),u_viewport:new Fe(e)}),globeAtmosphere:e=>({u_frustum_tl:new _e(e),u_frustum_tr:new _e(e),u_frustum_br:new _e(e),u_frustum_bl:new _e(e),u_horizon:new Et(e),u_transition:new Et(e),u_fadeout_range:new Et(e),u_color:new fo(e),u_high_color:new fo(e),u_space_color:new fo(e),u_temporal_offset:new Et(e),u_horizon_angle:new Et(e)}),model:e=>({u_matrix:new ve(e),u_lighting_matrix:new ve(e),u_normal_matrix:new ve(e),u_lightpos:new _e(e),u_lightintensity:new Et(e),u_lightcolor:new _e(e),u_camera_pos:new _e(e),u_opacity:new Et(e),u_baseColorFactor:new fo(e),u_emissiveFactor:new fo(e),u_metallicFactor:new Et(e),u_roughnessFactor:new Et(e),u_baseTextureIsAlpha:new Pe(e),u_alphaMask:new Pe(e),u_alphaCutoff:new Et(e),u_baseColorTexture:new Pe(e),u_metallicRoughnessTexture:new Pe(e),u_normalTexture:new Pe(e),u_occlusionTexture:new Pe(e),u_emissionTexture:new Pe(e),u_color_mix:new fo(e),u_aoIntensity:new Et(e)}),modelDepth:e=>({u_matrix:new ve(e),u_instance:new ve(e),u_node_matrix:new ve(e)}),groundShadow:e=>({u_matrix:new ve(e),u_ground_shadow_factor:new _e(e)}),stars:e=>({u_matrix:new ve(e),u_up:new _e(e),u_right:new _e(e),u_intensity_multiplier:new Et(e)})};let xd;function L2(e,t,r,n,i,s,a){const l=e.context,p=l.gl,f=e.transform,m=e.useProgram("collisionBox"),_=[];let y=0,v=0;for(let A=0;A<n.length;A++){const P=n[A],L=t.getTile(P),R=L.getBucket(r);if(!R)continue;const N=SL(P,R,f);let k=N;i[0]===0&&i[1]===0||(k=e.translatePosMatrix(N,L,i,s));const F=a?R.textCollisionBox:R.iconCollisionBox,z=R.collisionCircleArray;if(z.length>0){const U=Q.create(),G=k;Q.mul(U,R.placementInvProjMatrix,f.glCoordMatrix),Q.mul(U,U,R.placementViewportMatrix),_.push({circleArray:z,circleOffset:v,transform:G,invTransform:U,projection:R.getProjection()}),y+=z.length/4,v=y}F&&(e.terrain&&e.terrain.setupElevationDraw(L,m),m.draw(e,p.LINES,de.disabled,Be.disabled,e.colorModeForRenderPass(),Ge.disabled,pD(k,f,L,R.getProjection()),r.id,F.layoutVertexBuffer,F.indexBuffer,F.segments,null,f.zoom,null,[F.collisionVertexBuffer,F.collisionVertexBufferExt]))}if(!a||!_.length)return;const b=e.useProgram("collisionCircle"),w=new Rg;w.resize(4*y),w._trim();let E=0;for(const A of _)for(let P=0;P<A.circleArray.length/4;P++){const L=4*P,R=A.circleArray[L+0],N=A.circleArray[L+1],k=A.circleArray[L+2],F=A.circleArray[L+3];w.emplace(E++,R,N,k,F,0),w.emplace(E++,R,N,k,F,1),w.emplace(E++,R,N,k,F,2),w.emplace(E++,R,N,k,F,3)}(!xd||xd.length<2*y)&&(xd=function(A){const P=2*A,L=new xn;L.resize(P),L._trim();for(let R=0;R<P;R++){const N=6*R;L.uint16[N+0]=4*R+0,L.uint16[N+1]=4*R+1,L.uint16[N+2]=4*R+2,L.uint16[N+3]=4*R+2,L.uint16[N+4]=4*R+3,L.uint16[N+5]=4*R+0}return L}(y));const T=l.createIndexBuffer(xd,!0),C=l.createVertexBuffer(w,HM.members,!0);for(const A of _){const P={u_matrix:A.transform,u_inv_matrix:A.invTransform,u_camera_to_center_distance:(M=f).getCameraToCenterDistance(A.projection),u_viewport_size:[M.width,M.height]};b.draw(e,p.TRIANGLES,de.disabled,Be.disabled,e.colorModeForRenderPass(),Ge.disabled,P,r.id,C,T,mr.simpleSegment(0,2*A.circleOffset,A.circleArray.length,A.circleArray.length/2),null,f.zoom)}var M;C.destroy(),T.destroy()}const D2=Q.create();function TD({width:e,height:t,anchor:r,textOffset:n,textScale:i},s){const{horizontalAlign:a,verticalAlign:l}=Gf(r),p=-(a-.5)*e,f=-(l-.5)*t,m=G_(r,n);return new H((p/i+m[0])*s,(f/i+m[1])*s)}function ID(e,t,r,n,i,s,a,l,p,f,m){const _=e.text.placedSymbolArray,y=e.text.dynamicLayoutVertexArray,v=e.icon.dynamicLayoutVertexArray,b={},w=e.getProjection(),E=_y(l,w,s),T=s.elevation,C=w.upVectorScale(l.canonical,s.center.lat,s.worldSize).metersToTile;y.clear();for(let M=0;M<_.length;M++){const A=_.get(M),{tileAnchorX:P,tileAnchorY:L,numGlyphs:R}=A,N=A.hidden||!A.crossTileID||e.allowVerticalPlacement&&!A.placedOrientation?null:n[A.crossTileID];if(N){let k=0,F=0,z=0;if(T){const nt=T?T.getAtTileOffset(l,P,L):0,[at,ot,It]=w.upVector(l.canonical,P,L);k=nt*at*C,F=nt*ot*C,z=nt*It*C}let[U,G,V,K]=ms(A.projectedAnchorX+k,A.projectedAnchorY+F,A.projectedAnchorZ+z,r?E:a);const $=Cw(s.getCameraToCenterDistance(w),K);let tt=i.evaluateSizeForFeature(e.textSizeData,f,A)*$/Nn;r&&(tt*=e.tilePixelRatio/p);const X=TD(N,tt);r?({x:U,y:G,z:V}=w.projectTilePoint(P+X.x,L+X.y,l.canonical),[U,G,V]=ms(U+k,G+F,V+z,a)):(t&&X._rotate(-s.angle),U+=X.x,G+=X.y,V=0);const J=e.allowVerticalPlacement&&A.placedOrientation===Dr.vertical?Math.PI/2:0;for(let nt=0;nt<R;nt++)nc(y,U,G,V,J);m&&A.associatedIconIndex>=0&&(b[A.associatedIconIndex]={x:U,y:G,z:V,angle:J})}else oc(R,y)}if(m){v.clear();const M=e.icon.placedSymbolArray;for(let A=0;A<M.length;A++){const P=M.get(A),{numGlyphs:L}=P,R=b[A];if(P.hidden||!R)oc(L,v);else{const{x:N,y:k,z:F,angle:z}=R;for(let U=0;U<L;U++)nc(v,N,k,F,z)}}e.icon.dynamicLayoutVertexBuffer.updateData(v)}e.text.dynamicLayoutVertexBuffer.updateData(y)}function SD(e,t,r){return r.iconsInText&&t?"symbolTextAndIcon":e?"symbolSDF":"symbolIcon"}function R2(e,t,r,n,i,s,a,l,p,f,m,_){const y=e.context,v=y.gl,b=e.transform,w=l==="map",E=p==="map",T=w&&r.layout.get("symbol-placement")!=="point",C=w&&!E&&!T,M=r.layout.get("symbol-sort-key").constantOr(1)!==void 0;let A=!1;const P=e.depthModeForSublayer(0,de.ReadOnly),L=[Xn(b.center.lng),ri(b.center.lat)],R=r.layout.get("text-variable-anchor"),N=b.projection.name==="globe",k=[],F=[0,-1,0];let z=F;!N&&!b.mercatorFromTransition||w||(z=function(U){const G=U._camera.getWorldToCamera(U.worldSize,1),V=Q.multiply([],G,U.globeMatrix);Q.invert(V,V);const K=[0,0,0],$=[0,1,0,0];return gr.transformMat4($,$,V),K[0]=$[0],K[1]=$[1],K[2]=$[2],q.normalize(K,K),K}(b));for(const U of n){const G=t.getTile(U),V=G.getBucket(r);if(!V||V.projection.name==="mercator"&&N)continue;const K=i?V.text:V.icon;if(!K||V.fullyClipped||!K.segments.get().length)continue;const $=K.programConfigurations.get(r.id),tt=i||V.sdfIcons,X=i?V.textSizeData:V.iconSizeData,J=E||b.pitch!==0,nt=ks(X,b.zoom);let at,ot,It,xt,dt=[0,0],yt=null;if(i)ot=G.glyphAtlasTexture,It=v.LINEAR,at=G.glyphAtlasTexture.size,V.iconsInText&&(dt=G.imageAtlasTexture.size,yt=G.imageAtlasTexture,xt=J||e.options.rotating||e.options.zooming||X.kind==="composite"||X.kind==="camera"?v.LINEAR:v.NEAREST);else{const zr=r.layout.get("icon-size").constantOr(0)!==1||V.iconsNeedLinear;ot=G.imageAtlasTexture,It=tt||e.options.rotating||e.options.zooming||zr||J?v.LINEAR:v.NEAREST,at=G.imageAtlasTexture.size}const Ot=V.projection.name==="globe",Jt=Ot?z:F,Zt=Ot?Zn(b.zoom):0,Gt=_y(U,V.getProjection(),b),Qt=b.calculatePixelsToTileUnitsMatrix(G),Re=sd(Gt,G.tileID.canonical,E,w,b,V.getProjection(),Qt),Le=e.terrain&&E&&T?Q.invert(Q.create(),Re):D2,er=Sw(Gt,G.tileID.canonical,E,w,b,V.getProjection(),Qt),De=R&&V.hasTextData(),Oe=V.hasIconTextFit()&&De&&V.hasIconData();if(T){const zr=b.elevation,wn=zr?zr.getAtTileOffsetFunc(U,b.center.lat,b.worldSize,V.getProjection()):null,lr=Iw(Gt,G.tileID.canonical,E,w,b,V.getProjection(),Qt);IP(V,Gt,e,i,lr,er,E,f,wn,U)}const ae=T||i&&R||Oe,Me=e.translatePosMatrix(Gt,G,s,a),rr=ae?D2:Re,Ae=e.translatePosMatrix(er,G,s,a,!0),ar=V.getProjection().createInversionMatrix(b,U.canonical),tn=r.paint.get("icon-image-cross-fade").constantOr(0),en=[];e.terrainRenderModeElevated()&&E&&en.push("PITCH_WITH_MAP_TERRAIN"),Ot&&en.push("PROJECTION_GLOBE_VIEW"),ae&&en.push("PROJECTED_POS_ON_VIEWPORT"),tn>0&&en.push("ICON_TRANSITION");const Br=tt&&r.paint.get(i?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Mr;Mr=tt?V.iconsInText?xD(X.kind,nt,C,E,e,Me,rr,Ae,at,dt,U,Zt,L,ar,Jt,V.getProjection()):M2(X.kind,nt,C,E,e,Me,rr,Ae,i,at,!0,U,Zt,L,ar,Jt,V.getProjection()):C2(X.kind,nt,C,E,e,Me,rr,Ae,i,at,U,Zt,L,ar,Jt,V.getProjection(),tn);const mn={program:e.useProgram(SD(tt,i,V),$,en),buffers:K,uniformValues:Mr,atlasTexture:ot,atlasTextureIcon:yt,atlasInterpolation:It,atlasInterpolationIcon:xt,isSDF:tt,hasHalo:Br,tile:G,labelPlaneMatrixInv:Le};if(M&&V.canOverlap){A=!0;const zr=K.segments.get();for(const wn of zr)k.push({segments:new mr([wn]),sortKey:wn.sortKey,state:mn})}else k.push({segments:K.segments,sortKey:0,state:mn})}A&&k.sort((U,G)=>U.sortKey-G.sortKey);for(const U of k){const G=U.state;if(e.terrain&&e.terrain.setupElevationDraw(G.tile,G.program,{useDepthForOcclusion:!N,labelPlaneMatrixInv:G.labelPlaneMatrixInv}),y.activeTexture.set(v.TEXTURE0),G.atlasTexture.bind(G.atlasInterpolation,v.CLAMP_TO_EDGE),G.atlasTextureIcon&&(y.activeTexture.set(v.TEXTURE1),G.atlasTextureIcon&&G.atlasTextureIcon.bind(G.atlasInterpolationIcon,v.CLAMP_TO_EDGE)),e.uploadCommonLightUniforms(e.context,G.program),y.isWebGL2&&G.hasHalo){const V=G.uniformValues;V.u_is_halo=1,Ay(G.buffers,U.segments,r,e,G.program,P,m,_,V,2),V.u_is_halo=0}else{if(G.isSDF){const V=G.uniformValues;G.hasHalo&&(V.u_is_halo=1,Ay(G.buffers,U.segments,r,e,G.program,P,m,_,V,1)),V.u_is_halo=0}Ay(G.buffers,U.segments,r,e,G.program,P,m,_,G.uniformValues,1)}}}function Ay(e,t,r,n,i,s,a,l,p,f){const m=[e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer,e.iconTransitioningVertexBuffer,e.globeExtVertexBuffer];i.draw(n,n.context.gl.TRIANGLES,s,a,l,Ge.disabled,p,r.id,e.layoutVertexBuffer,e.indexBuffer,t,r.paint,n.transform.zoom,e.programConfigurations.get(r.id),m,f)}function O2(e,t,r,n,i,s,a){const l=e.context.gl,p=r.paint.get("fill-pattern"),f=p&&p.constantOr(1);let m,_,y,v,b;a?(_=f&&!r.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",m=l.LINES):(_=f?"fillPattern":"fill",m=l.TRIANGLES);for(const w of n){const E=t.getTile(w);if(f&&!E.patternsLoaded())continue;const T=E.getBucket(r);if(!T)continue;e.prepareDrawTile();const C=T.programConfigurations.get(r.id),M=e.useProgram(_,C);f&&(e.context.activeTexture.set(l.TEXTURE0),E.imageAtlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE),C.updatePaintBuffers());const A=p.constantOr(null);if(A&&E.imageAtlas){const R=E.imageAtlas.patternPositions[A.toString()];R&&C.setConstantPatternPositions(R)}const P=e.translatePosMatrix(w.projMatrix,E,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor")),L=r.paint.get("fill-emissive-strength");if(a){v=T.indexBuffer2,b=T.segments2;const R=e.terrain&&e.terrain.renderingToTexture?e.terrain.drapeBufferSize:[l.drawingBufferWidth,l.drawingBufferHeight];y=_==="fillOutlinePattern"&&f?lD(P,L,e,E,R):aD(P,L,R)}else v=T.indexBuffer,b=T.segments,y=f?b2(P,L,e,E):x2(P,L);e.uploadCommonUniforms(e.context,M,w.toUnwrapped()),M.draw(e,m,i,e.stencilModeForClipping(w),s,Ge.disabled,y,r.id,T.layoutVertexBuffer,v,b,r.paint,e.transform.zoom,C,void 0)}}function bd(e,t,r,n,i,s,a,l){const p=e.context,f=p.gl,m=e.transform,_=r.paint.get("fill-extrusion-pattern"),y=_.constantOr(1),v=r.paint.get("fill-extrusion-opacity"),b=e.style.enable3dLights(),w=r.paint.get(b&&!y?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),E=[r.paint.get("fill-extrusion-ambient-occlusion-intensity"),w],T=r.layout.get("fill-extrusion-edge-radius"),C=T>0&&!r.paint.get("fill-extrusion-rounded-roof"),M=C?0:T,A=m.projection.name==="globe"?aE():0,P=m.projection.name==="globe",L=P?Zn(m.zoom):0,R=[Xn(m.center.lng),ri(m.center.lat)],N=r.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),k=r.paint.get("fill-extrusion-flood-light-intensity"),F=r.paint.get("fill-extrusion-vertical-scale"),z=[];P&&z.push("PROJECTION_GLOBE_VIEW"),E[0]>0&&z.push("FAUX_AO"),C&&z.push("ZERO_ROOF_RADIUS"),l&&z.push("HAS_CENTROID"),k>0&&z.push("FLOOD_LIGHT");const U=e.renderPass==="shadow",G=e.shadowRenderer,V=U&&!!G;e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!0);let K=[0,0,0];if(G){const $=e.style.directionalLight,tt=e.style.ambientLight;$&&tt&&(K=Sy($,tt))}for(const $ of n){const tt=t.getTile($),X=tt.getBucket(r);if(!X||X.projection.name!==m.projection.name)continue;const J=X.programConfigurations.get(r.id),nt=e.useProgram(V?"fillExtrusionDepth":y?"fillExtrusionPattern":"fillExtrusion",J,z);if(e.terrain){const dt=e.terrain;e.style.terrainSetForDrapingOnly(),dt.setupElevationDraw(tt,nt,{useMeterToDem:!0})}if(!X.centroidVertexBuffer){const dt=nt.attributes.a_centroid_pos;dt!==void 0&&f.vertexAttrib2f(dt,0,0)}!U&&G&&G.setupShadows(tt.tileID.toUnwrapped(),nt,"vector-tile",tt.tileID.overscaledZ),y&&(e.context.activeTexture.set(f.TEXTURE0),tt.imageAtlasTexture.bind(f.LINEAR,f.CLAMP_TO_EDGE),J.updatePaintBuffers());const at=_.constantOr(null);if(at&&tt.imageAtlas){const dt=tt.imageAtlas.patternPositions[at.toString()];dt&&J.setConstantPatternPositions(dt)}const ot=r.paint.get("fill-extrusion-vertical-gradient");let It;if(U&&G){const dt=G.calculateShadowPassMatrixFromTile(tt.tileID.toUnwrapped());It=iD(dt,M,F)}else{const dt=e.translatePosMatrix($.projMatrix,tt,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),yt=m.projection.createInversionMatrix(m,$.canonical);It=y?oD(dt,e,ot,v,E,M,$,tt,A,L,R,yt,N,F):v2(dt,e,ot,v,E,M,$,A,L,R,yt,N,F,k,K)}e.uploadCommonUniforms(p,nt,$.toUnwrapped());const xt=[];(e.terrain||l)&&xt.push(X.centroidVertexBuffer),P&&xt.push(X.layoutVertexExtBuffer),nt.draw(e,p.gl.TRIANGLES,i,s,a,Ge.backCCW,It,r.id,X.layoutVertexBuffer,X.indexBuffer,X.segments,r.paint,e.transform.zoom,J,xt)}e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!1)}function fc(e,t,r,n,i,s,a,l,p,f,m,_,y,v,b,w,E,T){const C=e.context,M=C.gl,A=e.transform,P=[];f==="clear"?(P.push("CLEAR_SUBPASS"),T&&(P.push("CLEAR_FROM_TEXTURE"),C.activeTexture.set(M.TEXTURE0),T.bind(M.LINEAR,M.CLAMP_TO_EDGE))):f==="sdf"&&P.push("SDF_SUBPASS"),E&&P.push("HAS_CENTROID");for(const L of n){const R=t.getTile(L),N=R.getBucket(r);if(!N||N.projection.name!==A.projection.name||!N.groundEffect)continue;const k=N.groundEffect,F=k.programConfigurations.get(r.id),z=e.useProgram("fillExtrusionGroundEffect",F,P),U=e.translatePosMatrix(L.projMatrix,R,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),G=1/N.tileToMeter,V=sD(0,U,m,p,G,[_,y*G],v,b,w),K=[];E&&K.push(N.groundEffect.hiddenByLandmarkVertexBuffer),e.uploadCommonUniforms(C,z,L.toUnwrapped()),z.draw(e,C.gl.TRIANGLES,i,s,a,l,V,r.id,k.vertexBuffer,k.indexBuffer,k.segments,r.paint,e.transform.zoom,F,K)}}function CD(e,t,r,n,i,s,a){n.centroidVertexArray.length===0&&n.createCentroidsBuffer();const l=s?s.findDEMTileFor(r):null;if(!(l&&l.dem||a))return;const p=[C=>{let M=C.canonical.x-1,A=C.wrap;return M<0&&(M=(1<<C.canonical.z)-1,A--),new wr(C.overscaledZ,A,C.canonical.z,M,C.canonical.y)},C=>{let M=C.canonical.x+1,A=C.wrap;return M===1<<C.canonical.z&&(M=0,A++),new wr(C.overscaledZ,A,C.canonical.z,M,C.canonical.y)},C=>new wr(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,(C.canonical.y===0?1<<C.canonical.z:C.canonical.y)-1),C=>new wr(C.overscaledZ,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y===(1<<C.canonical.z)-1?0:C.canonical.y+1)],f=C=>{const M=t.getSource().minzoom,A=L=>{const R=t.getTileByID(L);if(R&&R.hasData())return R.getBucket(i)},P=[0,-1,1];for(const L of P){if(C.overscaledZ+L<M)continue;const R=A(C.calculateScaledKey(C.overscaledZ+L));if(R)return R}},m=[0,0,0],_=(C,M)=>(m[0]=Math.min(C.min.y,M.min.y),m[1]=Math.max(C.max.y,M.max.y),m[2]=lt-M.min.x>C.max.x?M.min.x-lt:C.max.x,m),y=(C,M)=>(m[0]=Math.min(C.min.x,M.min.x),m[1]=Math.max(C.max.x,M.max.x),m[2]=lt-M.min.y>C.max.y?M.min.y-lt:C.max.y,m),v=[(C,M)=>_(C,M),(C,M)=>_(M,C),(C,M)=>y(C,M),(C,M)=>y(M,C)],b=(C,M,A,P,L,R,N)=>{if(!s)return 0;const k=[[R?A:C,R?C:A,0],[R?A:M,R?M:A,0]],F=N<0?lt+N:N,z=[R?F:(C+M)/2,R?(C+M)/2:F,0];return A===0&&N<0||A!==0&&N>0?s.getForTilePoints(L,[z],!0,P):k.push(z),s.getForTilePoints(r,k,!0,l),Math.max(k[0][2],k[1][2],z[2])/s.exaggeration()};for(let C=0;C<4;C++){const M=n.borderFeatureIndices[C];if(M.length===0)continue;const A=p[C](r),P=f(A);if(!(P&&P instanceof Fh)||n.borderDoneWithNeighborZ[C]===P.canonical.z)continue;P.centroidVertexArray.length===0&&P.createCentroidsBuffer();const L=s?s.findDEMTileFor(A):null;if(!(L&&L.dem||a))continue;const R=(C<2?1:5)-C,N=P.borderDoneWithNeighborZ[R]!==n.canonical.z,k=P.borderFeatureIndices[R];let F=0;if(n.canonical.z!==P.canonical.z){for(const z of M)n.showCentroid(n.featuresOnBorder[z]);if(N)for(const z of k)P.showCentroid(P.featuresOnBorder[z]);n.borderDoneWithNeighborZ[C]=P.canonical.z,P.borderDoneWithNeighborZ[R]=n.canonical.z}for(const z of M){const U=n.featuresOnBorder[z],G=n.centroidData[U.centroidDataIndex],V=U.borders[C];let K;for(;F<k.length;){K=P.featuresOnBorder[k[F]];const $=K.borders[R];if($[1]>V[0]+3||$[0]>V[0]-3)break;P.showCentroid(K),F++}if(K&&F<k.length){const $=F;let tt=0;for(;!(K.borders[R][0]>V[1]-3)&&(tt++,++F!==k.length);)K=P.featuresOnBorder[k[F]];if(K=P.featuresOnBorder[k[$]],tt>1){const nt=K.borders[R];Math.abs(V[0]-nt[0])<3&&Math.abs(V[1]-nt[1])<3&&(tt=1,F=$+1)}else if(tt===0){n.showCentroid(U);continue}const X=P.centroidData[K.centroidDataIndex];a&&tt===1&&(((E=G).flags|(T=X).flags)&cl?(E.flags|=cl,T.flags|=cl):(E.flags&=2147483647,T.flags&=2147483647));let J=new H(0,0);if(tt>1)F=$;else if(L&&L.dem&&!(U.intersectsCount()>1||K.intersectsCount()>1)){const nt=v[C](G,X),at=C%2?lt-1:0;w=b(nt[0],Math.min(lt-1,nt[1]),at,L,A,C<2,nt[2]),J=new H(Math.ceil(7*(w+450)),0)}G.centroidXY=X.centroidXY=J,n.writeCentroidToBuffer(G),P.writeCentroidToBuffer(X)}else n.showCentroid(U)}n.borderDoneWithNeighborZ[C]=P.canonical.z,P.borderDoneWithNeighborZ[R]=n.canonical.z}var w,E,T;(n.needsCentroidUpdate||!n.centroidVertexBuffer&&n.centroidVertexArray.length!==0)&&n.uploadCentroid(e)}const MD=new Se(1,0,0,1),AD=new Se(0,1,0,1),PD=new Se(0,0,1,1),LD=new Se(1,0,1,1),DD=new Se(0,1,1,1);function RD(e,t,r){const n=e.context,i=e.transform,s=n.gl,a=i.projection.name==="globe",l=a?["PROJECTION_GLOBE_VIEW"]:null;let p=r.projMatrix;if(a&&Zn(i.zoom)>0){const F=f_(U1(r.canonical,i));p=Q.multiply(new Float32Array(16),i.globeMatrix,F),Q.multiply(p,i.projMatrix,p)}const f=e.useProgram("debug",null,l),m=t.getTileByID(r.key);e.terrain&&e.terrain.setupElevationDraw(m,f);const _=de.disabled,y=Be.disabled,v=e.colorModeForRenderPass(),b="$debug";n.activeTexture.set(s.TEXTURE0),e.emptyTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE),a?m._makeGlobeTileDebugBuffers(e.context,i):m._makeDebugTileBoundsBuffers(e.context,i.projection);const w=m._tileDebugBuffer||e.debugBuffer,E=m._tileDebugIndexBuffer||e.debugIndexBuffer,T=m._tileDebugSegments||e.debugSegments;f.draw(e,s.LINE_STRIP,_,y,v,Ge.disabled,w2(p,Se.red),b,w,E,T,null,null,null,[m._globeTileDebugBorderBuffer]);const C=m.latestRawTileData,M=Math.floor((C&&C.byteLength||0)/1024),A=t.getTile(r).tileSize,P=512/Math.min(A,512)*(r.overscaledZ/i.zoom)*.5;let L=r.canonical.toString();r.overscaledZ!==r.canonical.z&&(L+=` => ${r.overscaledZ}`),L+=` ${M}kb`,function(F,z){F.initDebugOverlayCanvas();const U=F.debugOverlayCanvas,G=F.context.gl,V=F.debugOverlayCanvas.getContext("2d");V.clearRect(0,0,U.width,U.height),V.shadowColor="white",V.shadowBlur=2,V.lineWidth=1.5,V.strokeStyle="white",V.textBaseline="top",V.font="bold 36px Open Sans, sans-serif",V.fillText(z,5,5),V.strokeText(z,5,5),F.debugOverlayTexture.update(U),F.debugOverlayTexture.bind(G.LINEAR,G.CLAMP_TO_EDGE)}(e,L);const R=m._tileDebugTextBuffer||e.debugBuffer,N=m._tileDebugTextIndexBuffer||e.quadTriangleIndexBuffer,k=m._tileDebugTextSegments||e.debugSegments;f.draw(e,s.TRIANGLES,_,y,sr.alphaBlended,Ge.disabled,w2(p,Se.transparent,P),b,R,N,k,null,null,null,[m._globeTileDebugTextBuffer])}function N2(e,t,r,n){wd(e,0,t+r/2,e.transform.width,r,n)}function z2(e,t,r,n){wd(e,t-r/2,0,r,e.transform.height,n)}function wd(e,t,r,n,i,s){const a=e.context,l=a.gl;l.enable(l.SCISSOR_TEST),l.scissor(t*ge.devicePixelRatio,r*ge.devicePixelRatio,n*ge.devicePixelRatio,i*ge.devicePixelRatio),a.clear({color:s}),l.disable(l.SCISSOR_TEST)}const OD=Je([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:ND}=OD;function fl(e,t,r,n){e.emplaceBack(t,r,n)}class k2{constructor(t){this.vertexArray=new Za,this.indices=new xn,fl(this.vertexArray,-1,-1,1),fl(this.vertexArray,1,-1,1),fl(this.vertexArray,-1,1,1),fl(this.vertexArray,1,1,1),fl(this.vertexArray,-1,-1,-1),fl(this.vertexArray,1,-1,-1),fl(this.vertexArray,-1,1,-1),fl(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,ND),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=mr.simpleSegment(0,0,36,12)}}function dc(e,t,r,n,i,s){const a=e.context.gl,l=t.paint.get("sky-atmosphere-color"),p=t.paint.get("sky-atmosphere-halo-color"),f=t.paint.get("sky-atmosphere-sun-intensity"),m=((_,y,v,b,w)=>({u_matrix_3f:_,u_sun_direction:y,u_sun_intensity:v,u_color_tint_r:[b.r,b.g,b.b,b.a],u_color_tint_m:[w.r,w.g,w.b,w.a],u_luminance:5e-5}))(Ri.fromMat4(Ri.create(),n),i,f,l,p);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+s,t.skyboxTexture,0),r.draw(e,a.TRIANGLES,de.disabled,Be.disabled,sr.unblended,Ge.frontCW,m,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const zD=Je([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class kD{constructor(t){const r=new hh;r.emplaceBack(-1,1,1,0,0),r.emplaceBack(1,1,1,1,0),r.emplaceBack(1,-1,1,1,1),r.emplaceBack(-1,-1,1,0,1);const n=new xn;n.emplaceBack(0,1,2),n.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(r,zD.members),this.indexBuffer=t.createIndexBuffer(n),this.segments=mr.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const FD=Je([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class BD{constructor(){this.colorModeAlphaBlendedWriteRGB=new sr([1,id,1,id],Se.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new sr([1,0,1,0],Se.transparent,[!1,!1,!1,!0])}update(t){const r=t.context;if(!this.atmosphereBuffer){this.atmosphereBuffer=new kD(r);const n=100,i=100,s=function(m){const _=ag(30),y=[];for(let v=0;v<16e3;++v){const b=2*Math.PI*_(),w=Math.acos(1-2*_())-.5*Math.PI;y.push(q.fromValues(Math.cos(w)*Math.cos(b),Math.cos(w)*Math.sin(b),Math.sin(w)))}return y}(),a=ag(300),l=new kg,p=new xn;let f=0;for(let m=0;m<s.length;++m){const _=q.scale([],s[m],200),y=1+.01*n*(1*a()-.5),v=1+.01*i*(1*a()-.5);l.emplaceBack(_[0],_[1],_[2],-1,-1,y,v),l.emplaceBack(_[0],_[1],_[2],1,-1,y,v),l.emplaceBack(_[0],_[1],_[2],1,1,y,v),l.emplaceBack(_[0],_[1],_[2],-1,1,y,v),p.emplaceBack(f+0,f+1,f+2),p.emplaceBack(f+0,f+2,f+3),f+=4}this.starsVx=r.createVertexBuffer(l,FD.members),this.starsIdx=r.createIndexBuffer(p),this.starsSegments=mr.simpleSegment(0,0,l.length,p.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,r){const n=t.context,i=n.gl,s=t.transform,a=new de(i.LEQUAL,de.ReadOnly,[0,1]),l=Zn(s.zoom),p=r.properties.get("color").toArray01(),f=r.properties.get("high-color").toArray01(),m=r.properties.get("space-color").toArray01PremultipliedAlpha(),_=5e-4,y=Bt((r.properties.get("horizon-blend")-0)/1*.2495+_,5e-4,.25),v=X1(t,n,s)&&y===_?s.worldSize/(2*Math.PI*1.025)-1:s.globeRadius,b=t.frameCounter/1e3%1,w=q.length(s.globeCenterInViewSpace),E=Math.sqrt(Math.pow(w,2)-Math.pow(v,2)),T=Math.acos(E/w),C=M=>{const A=s.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];M&&A.push("ALPHA_PASS");const P=t.useProgram("globeAtmosphere",null,A),L=((N,k,F,z,U,G,V,K,$,tt,X,J)=>({u_frustum_tl:N,u_frustum_tr:k,u_frustum_br:F,u_frustum_bl:z,u_horizon:U,u_transition:G,u_fadeout_range:V,u_color:K,u_high_color:$,u_space_color:tt,u_temporal_offset:X,u_horizon_angle:J}))(s.frustumCorners.TL,s.frustumCorners.TR,s.frustumCorners.BR,s.frustumCorners.BL,s.frustumCorners.horizon,l,y,p,f,m,b,T);t.uploadCommonUniforms(n,P);const R=this.atmosphereBuffer;R&&P.draw(t,i.TRIANGLES,a,Be.disabled,M?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Ge.backCW,L,M?"atmosphere_glow_alpha":"atmosphere_glow",R.vertexBuffer,R.indexBuffer,R.segments)};C(!1),C(!0)}drawStars(t,r){const n=Bt(r.properties.get("star-intensity"),0,1);if(n===0)return;const i=t.context,s=i.gl,a=t.transform,l=t.useProgram("stars"),p=ei.identity([]);ei.rotateX(p,p,-a._pitch),ei.rotateZ(p,p,-a.angle),ei.rotateX(p,p,re(a._center.lat)),ei.rotateY(p,p,-re(a._center.lng));const f=Q.fromQuat(new Float32Array(16),p),m=Q.multiply([],a.starsProjMatrix,f),_=Ri.fromMat4([],f),y=Ri.invert([],_),v=[0,1,0];q.transformMat3(v,v,y),q.scale(v,v,.2);const b=[1,0,0];q.transformMat3(b,b,y),q.scale(b,b,.2);const w=((E,T,C,M)=>({u_matrix:Float32Array.from(E),u_up:T,u_right:C,u_intensity_multiplier:M}))(m,v,b,n);t.uploadCommonUniforms(i,l),this.starsVx&&this.starsIdx&&l.draw(t,s.TRIANGLES,de.disabled,Be.disabled,this.colorModeAlphaBlendedWriteRGB,Ge.disabled,w,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function F2(e,t){const r=[...e],n=t.cameraWorldSizeForFog/t.worldSize,i=Q.identity([]);return Q.scale(i,i,[n,n,1]),Q.multiply(r,i,r),Q.multiply(r,t.worldToFogMatrix,r),r}function Py(e,t,r,n){const i=r.material,s=i.pbrMetallicRoughness,a=n.context;if(s.baseColorTexture){e.push("HAS_TEXTURE_u_baseColorTexture"),a.activeTexture.set(a.gl.TEXTURE0+Qi.BaseColor);const l=s.baseColorTexture.sampler;s.baseColorTexture.gfxTexture&&s.baseColorTexture.gfxTexture.bindExtraParam(l.minFilter,l.magFilter,l.wrapS,l.wrapT)}if(s.metallicRoughnessTexture){e.push("HAS_TEXTURE_u_metallicRoughnessTexture"),a.activeTexture.set(a.gl.TEXTURE0+Qi.MetallicRoughness);const l=s.metallicRoughnessTexture.sampler;s.metallicRoughnessTexture.gfxTexture&&s.metallicRoughnessTexture.gfxTexture.bindExtraParam(l.minFilter,l.magFilter,l.wrapS,l.wrapT)}if(i.normalTexture){e.push("HAS_TEXTURE_u_normalTexture"),a.activeTexture.set(a.gl.TEXTURE0+Qi.Normal);const l=i.normalTexture.sampler;i.normalTexture.gfxTexture&&i.normalTexture.gfxTexture.bindExtraParam(l.minFilter,l.magFilter,l.wrapS,l.wrapT)}if(i.occlusionTexture){e.push("HAS_TEXTURE_u_occlusionTexture"),a.activeTexture.set(a.gl.TEXTURE0+Qi.Occlusion);const l=i.occlusionTexture.sampler;i.occlusionTexture.gfxTexture&&i.occlusionTexture.gfxTexture.bindExtraParam(l.minFilter,l.magFilter,l.wrapS,l.wrapT)}if(i.emissionTexture){e.push("HAS_TEXTURE_u_emissionTexture"),a.activeTexture.set(a.gl.TEXTURE0+Qi.Emission);const l=i.emissionTexture.sampler;i.emissionTexture.gfxTexture&&i.emissionTexture.gfxTexture.bindExtraParam(l.minFilter,l.magFilter,l.wrapS,l.wrapT)}r.texcoordBuffer&&(e.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(r.texcoordBuffer)),r.colorBuffer&&(e.push(r.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(r.colorBuffer)),r.normalBuffer&&(e.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(r.normalBuffer)),r.pbrBuffer&&(e.push("HAS_ATTRIBUTE_a_pbr"),e.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(r.pbrBuffer)),i.alphaMode!=="OPAQUE"&&i.alphaMode!=="MASK"||e.push("UNPREMULT_TEXTURE_IN_SHADER"),i.defined||e.push("DIFFUSE_SHADED"),e.push("USE_STANDARD_DERIVATIVES")}function Ed(e,t,r,n,i,s){const a=r.paint.get("model-opacity"),l=t.context,p=new de(t.context.gl.LEQUAL,de.ReadWrite,t.depthRangeFor3D),f=e.mesh,m=f.material,_=m.pbrMetallicRoughness;let y;y=t.transform.projection.zAxisUnit==="pixels"?[...e.nodeModelMatrix]:Q.multiply([],n.zScaleMatrix,e.nodeModelMatrix),Q.multiply(y,n.negCameraPosMatrix,y);const v=Q.invert([],y);Q.transpose(v,v);const b=My(new Float32Array(e.worldViewProjection),new Float32Array(y),new Float32Array(v),t,a,_.baseColorFactor,m.emissiveFactor,_.metallicFactor,_.roughnessFactor,m,r),w=[],E=[];Py(w,E,f,t);const T=t.shadowRenderer;T&&(T.useNormalOffset=!1);const C=t.useProgram("model",null,w);let M=null;if(t.style.fog){const A=F2(e.nodeModelMatrix,t.transform);w.push("FOG","FOG_DITHERING"),M=new Float32Array(A)}t.uploadCommonUniforms(l,C,null,M),t.renderPass!=="shadow"&&T&&T.setupShadowsFromMatrix(e.nodeModelMatrix,C),C.draw(t,l.gl.TRIANGLES,p,i,s,Ge.backCCW,b,r.id,f.vertexBuffer,f.indexBuffer,f.segments,r.paint,t.transform.zoom,void 0,E)}function B2(e,t,r,n,i,s,a){let l;l=e.projection.name==="globe"?kw(r,e):[...r],Q.multiply(l,l,t.matrix);const p=Q.multiply([],n,l);if(t.meshes)for(const f of t.meshes){if(f.material.alphaMode!=="BLEND"){a.push({mesh:f,depth:0,modelIndex:i,worldViewProjection:p,nodeModelMatrix:l});continue}const m=q.transformMat4([],f.centroid,p);m[2]>0&&s.push({mesh:f,depth:m[2],modelIndex:i,worldViewProjection:p,nodeModelMatrix:l})}if(t.children)for(const f of t.children)B2(e,f,r,n,i,s,a)}function Ly(e,t,r,n){const i=r.shadowRenderer;if(!i)return;const s=i.getShadowPassDepthMode(),a=i.getShadowPassColorMode(),l=i.calculateShadowPassMatrixFromMatrix(t),p=P2(l);r.useProgram("modelDepth",null,["DEPTH_TEXTURE"]).draw(r,r.context.gl.TRIANGLES,s,Be.disabled,a,Ge.backCCW,p,n.id,e.vertexBuffer,e.indexBuffer,e.segments,n.paint,r.transform.zoom,void 0,void 0)}function VD(e,t,r){let n,i,s,a=e.terrain?e.terrain.exaggeration():0;if(e.terrain&&a>0){const l=e.terrain,p=l.findDEMTileFor(r);p&&p.dem?n=Ku.create(l,r,p):a=0}if(a===0&&(t.terrainElevationMin=0,t.terrainElevationMax=0),a!==t.validForExaggeration||!(a===0||n&&n._demTile&&n._demTile.tileID===t.validForDEMTile)){for(const l in t.instancesPerModel){const p=t.instancesPerModel[l];for(let f=0;f<p.instancedDataArray.length;++f){const m=(n?a*n.getElevationAt(0|p.instancedDataArray.float32[16*f],0|p.instancedDataArray.float32[16*f+1],!0,!0):0)+p.instancesEvaluatedElevation[f];p.instancedDataArray.float32[16*f+6]=m,i=i?Math.min(t.terrainElevationMin,m):m,s=s?Math.max(t.terrainElevationMax,m):m}}t.terrainElevationMin=i||0,t.terrainElevationMax=s||0,t.validForExaggeration=a,t.validForDEMTile=n&&n._demTile?n._demTile.tileID:void 0,t.uploaded=!1,t.upload(e.context)}}const va={shadowUniformsInitialized:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new Zr([0,0,0],[lt,lt,0])};function V2(e,t,r,n,i,s,a){const l=e.context,p=e.renderPass==="shadow",f=e.shadowRenderer,m=p&&f?f.getShadowPassDepthMode():new de(l.gl.LEQUAL,de.ReadWrite,e.depthRangeFor3D),_=p&&f?f.getShadowPassColorMode():e.colorModeForRenderPass();if(r.meshes)for(const y of r.meshes){const v=["MODEL_POSITION_ON_GPU"],b=[];let w,E;if(p&&f)w=e.useProgram("modelDepth",null,v),E=P2(a.shadowTileMatrix,a.shadowTileMatrix,Float32Array.from(r.matrix));else{Py(v,b,y,e),w=e.useProgram("model",null,v);const C=y.material,M=C.pbrMetallicRoughness;E=My(s.projMatrix,Float32Array.from(r.matrix),new Float32Array(16),e,t.paint.get("model-opacity"),M.baseColorFactor,C.emissiveFactor,M.metallicFactor,M.roughnessFactor,C,t,i),f&&(a.shadowUniformsInitialized?w.setShadowUniformValues(l,f.getShadowUniformValues()):(f.setupShadows(s.toUnwrapped(),w,"model-tile",s.overscaledZ),a.shadowUniformsInitialized=!0))}e.uploadCommonUniforms(l,w,s.toUnwrapped());const T=p?"u_instance":"u_normal_matrix";for(let C=0;C<n.instancedDataArray.length;++C)E[T]=new Float32Array(n.instancedDataArray.arrayBuffer,64*C,16),w.draw(e,l.gl.TRIANGLES,m,Be.disabled,_,Ge.disabled,E,t.id,y.vertexBuffer,y.indexBuffer,y.segments,t.paint,e.transform.zoom,void 0,b)}if(r.children)for(const y of r.children)V2(e,t,y,n,i,s,a)}const UD=[1,-1,1];function GD(e,t,r,n,i,s,a,l){if(r.renderPass==="opaque")return;const p=e.node,f=r.context,m=r.renderPass==="light-beam",_=[...s];for(let y=0;y<p.meshes.length;++y){const v=p.meshes[y],b=y===p.lightMeshIndex;if(b){if(!m&&!r.terrain&&r.shadowRenderer){r.currentLayer<r.firstLightBeamLayer&&(r.firstLightBeamLayer=r.currentLayer);continue}}else if(m)continue;const w=[],E=[];Py(w,E,v,r),4&t||w.push("DIFFUSE_SHADED");const T=e.evaluatedScale;let C=0;r.terrain&&p.elevation&&(C=p.elevation*r.terrain.exaggeration()),Q.translate(_,_,[(p.anchor?p.anchor[0]:0)*(T[0]-1),(p.anchor?p.anchor[1]:0)*(T[1]-1),C]),T!==SP&&Q.scale(_,_,T),Q.multiply(_,_,p.matrix);const M=r.renderPass==="shadow";if(M)return void Ly(v,_,r,n);let A=null;if(r.style.fog){const V=F2(_,r.transform);w.push("FOG","FOG_DITHERING"),A=new Float32Array(V)}const P=r.useProgram("model",null,w),L=Q.multiply([],a,_);Q.multiply(L,l,L);const R=Q.invert([],L);Q.transpose(R,R),Q.scale(R,R,UD);const N=Q.multiply([],r.transform.projMatrix,_),k=r.shadowRenderer;!M&&k&&(k.useNormalOffset=!!v.normalBuffer,k.setupShadowsFromMatrix(_,P,k.useNormalOffset)),r.uploadCommonUniforms(f,P,i.toUnwrapped(),A);const F=v.material,z=F.pbrMetallicRoughness;z.metallicFactor=.9,z.roughnessFactor=.5;const U=My(new Float32Array(N),new Float32Array(L),new Float32Array(R),r,n.paint.get("model-opacity"),z.baseColorFactor,F.emissiveFactor,z.metallicFactor,z.roughnessFactor,F,n),G=new de(f.gl.LEQUAL,b?de.ReadOnly:de.ReadWrite,r.depthRangeFor3D);P.draw(r,f.gl.TRIANGLES,G,Be.disabled,r.colorModeForRenderPass(),Ge.backCCW,U,n.id,v.vertexBuffer,v.indexBuffer,v.segments,n.paint,r.transform.zoom,void 0,E)}}function jD(e,t,r,n){if(!r.modelManager)return!0;const i=r.modelManager;if(!r.shadowRenderer)return!0;const s=r.shadowRenderer,a=t.aabb;let l=!0,p=e.maxHeight;if(p===0){let m=0;for(const _ in e.instancesPerModel){const y=i.getModel(_,n);y?m=Math.max(m,Math.max(Math.max(y.aabb.max[0],y.aabb.max[1]),y.aabb.max[2])):l=!1}p=e.maxScale*m*1.41+e.maxVerticalOffset,l&&(e.maxHeight=p)}a.max[2]=p,a.min[2]+=e.terrainElevationMin,a.max[2]+=e.terrainElevationMax,q.transformMat4(a.min,a.min,t.tileMatrix),q.transformMat4(a.max,a.max,t.tileMatrix);const f=a.intersects(s.getCurrentCascadeFrustum());return r.currentShadowCascade===0&&(e.isInsideFirstShadowMapFrustum=f===2),f===0}class qD{}class ZD{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,r,n){if(!n.isWebGL2)return;{const y=this._storage.get(r.id);if(y)return y.lastUsedFrameIdx=t,y.buf}const i=n.gl,s=n.gl,a=s.getBufferParameter(i.ELEMENT_ARRAY_BUFFER,i.BUFFER_SIZE),l=new ArrayBuffer(a),p=new Int16Array(l);s.getBufferSubData(i.ELEMENT_ARRAY_BUFFER,0,new Int16Array(l));const f=new qa;for(let y=0;y<a/2;y+=3){const v=p[y],b=p[y+1],w=p[y+2];f.emplaceBack(v,b),f.emplaceBack(b,w),f.emplaceBack(w,v)}const m=n.bindVertexArrayOES.current,_=new qD;return _.buf=new ll(n,f),_.lastUsedFrameIdx=t,this._storage.set(r.id,_),n.bindVertexArrayOES.set(m),_.buf}update(t){for(const[r,n]of this._storage)t-n.lastUsedFrameIdx>30&&(n.buf.destroy(),this._storage.delete(r))}destroy(){for(const[t,r]of this._storage)r.buf.destroy(),this._storage.delete(t)}}const U2={symbol:function(e,t,r,n,i){if(e.renderPass!=="translucent")return;const s=Be.disabled,a=e.colorModeForRenderPass();r.layout.get("text-variable-anchor")&&function(l,p,f,m,_,y,v){const b=p.transform,w=_==="map",E=y==="map";for(const T of l){const C=m.getTile(T),M=C.getBucket(f);if(!M||!M.text||!M.text.segments.get().length)continue;const A=ks(M.textSizeData,b.zoom),P=_y(T,M.getProjection(),b),L=b.calculatePixelsToTileUnitsMatrix(C),R=sd(P,C.tileID.canonical,E,w,b,M.getProjection(),L),N=M.hasIconTextFit()&&M.hasIconData();if(A){const k=Math.pow(2,b.zoom-C.tileID.overscaledZ);ID(M,w,E,v,YM,b,R,T,k,A,N)}}}(n,e,r,t,r.layout.get("text-rotation-alignment"),r.layout.get("text-pitch-alignment"),i),r.paint.get("icon-opacity").constantOr(1)!==0&&R2(e,t,r,n,!1,r.paint.get("icon-translate"),r.paint.get("icon-translate-anchor"),r.layout.get("icon-rotation-alignment"),r.layout.get("icon-pitch-alignment"),r.layout.get("icon-keep-upright"),s,a),r.paint.get("text-opacity").constantOr(1)!==0&&R2(e,t,r,n,!0,r.paint.get("text-translate"),r.paint.get("text-translate-anchor"),r.layout.get("text-rotation-alignment"),r.layout.get("text-pitch-alignment"),r.layout.get("text-keep-upright"),s,a),t.map.showCollisionBoxes&&(L2(e,t,r,n,r.paint.get("text-translate"),r.paint.get("text-translate-anchor"),!0),L2(e,t,r,n,r.paint.get("icon-translate"),r.paint.get("icon-translate-anchor"),!1))},circle:function(e,t,r,n){if(e.renderPass!=="translucent")return;const i=r.paint.get("circle-opacity"),s=r.paint.get("circle-stroke-width"),a=r.paint.get("circle-stroke-opacity"),l=r.layout.get("circle-sort-key").constantOr(1)!==void 0,p=r.paint.get("circle-emissive-strength");if(i.constantOr(1)===0&&(s.constantOr(1)===0||a.constantOr(1)===0))return;const f=e.context,m=f.gl,_=e.transform,y=e.depthModeForSublayer(0,de.ReadOnly),v=Be.disabled,b=e.colorModeForDrapableLayerRenderPass(p),w=_.projection.name==="globe",E=[Xn(_.center.lng),ri(_.center.lat)],T=[];for(let M=0;M<n.length;M++){const A=n[M],P=t.getTile(A),L=P.getBucket(r);if(!L||L.projection.name!==_.projection.name)continue;const R=L.programConfigurations.get(r.id),N=hD(r);w&&N.push("PROJECTION_GLOBE_VIEW");const k=e.useProgram("circle",R,N),F=L.layoutVertexBuffer,z=L.globeExtVertexBuffer,U=L.indexBuffer,G=_.projection.createInversionMatrix(_,A.canonical),V={programConfiguration:R,program:k,layoutVertexBuffer:F,globeExtVertexBuffer:z,indexBuffer:U,uniformValues:cD(e,A,P,G,E,r),tile:P};if(l){const K=L.segments.get();for(const $ of K)T.push({segments:new mr([$]),sortKey:$.sortKey,state:V})}else T.push({segments:L.segments,sortKey:0,state:V})}l&&T.sort((M,A)=>M.sortKey-A.sortKey);const C={useDepthForOcclusion:!w};for(const M of T){const{programConfiguration:A,program:P,layoutVertexBuffer:L,globeExtVertexBuffer:R,indexBuffer:N,uniformValues:k,tile:F}=M.state,z=M.segments;e.terrain&&e.terrain.setupElevationDraw(F,P,C),e.uploadCommonUniforms(f,P,F.tileID.toUnwrapped()),P.draw(e,m.TRIANGLES,y,v,b,Ge.disabled,k,r.id,L,N,z,r.paint,_.zoom,A,[R])}},heatmap:function(e,t,r,n){if(r.paint.get("heatmap-opacity")!==0)if(e.renderPass==="offscreen"){const i=e.context,s=i.gl,a=Be.disabled,l=new sr([s.ONE,s.ONE,s.ONE,s.ONE],Se.transparent,[!0,!0,!0,!0]);(function(v,b,w,E){const T=v.gl,C=b.width*E,M=b.height*E;v.activeTexture.set(T.TEXTURE1),v.viewport.set([0,0,C,M]);let A=w.heatmapFbo;if(!A||A&&(A.width!==C||A.height!==M)){A&&A.destroy();const P=T.createTexture();T.bindTexture(T.TEXTURE_2D,P),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,T.CLAMP_TO_EDGE),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,T.CLAMP_TO_EDGE),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,T.LINEAR),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,T.LINEAR),A=w.heatmapFbo=v.createFramebuffer(C,M,!0,null),function(L,R,N,k,F,z){const U=L.gl;U.texImage2D(U.TEXTURE_2D,0,L.isWebGL2&&L.extRenderToTextureHalfFloat?U.RGBA16F:U.RGBA,F,z,0,U.RGBA,L.extRenderToTextureHalfFloat?L.isWebGL2?U.HALF_FLOAT:L.extTextureHalfFloat.HALF_FLOAT_OES:U.UNSIGNED_BYTE,null),k.colorAttachment.set(N)}(v,0,P,A,C,M)}else T.bindTexture(T.TEXTURE_2D,A.colorAttachment.get()),v.bindFramebuffer.set(A.framebuffer)})(i,e,r,e.transform.projection.name==="globe"?.5:.25),i.clear({color:Se.transparent});const p=e.transform,f=p.projection.name==="globe",m=f?["PROJECTION_GLOBE_VIEW"]:null,_=f?Ge.frontCCW:Ge.disabled,y=[Xn(p.center.lng),ri(p.center.lat)];for(let v=0;v<n.length;v++){const b=n[v];if(t.hasRenderableParent(b))continue;const w=t.getTile(b),E=w.getBucket(r);if(!E||E.projection.name!==p.projection.name)continue;const T=E.programConfigurations.get(r.id),C=e.useProgram("heatmap",T,m),{zoom:M}=e.transform;e.terrain&&e.terrain.setupElevationDraw(w,C),e.uploadCommonUniforms(i,C,b.toUnwrapped());const A=p.projection.createInversionMatrix(p,b.canonical);C.draw(e,s.TRIANGLES,de.disabled,a,l,_,dD(e,b,w,A,y,M,r.paint.get("heatmap-intensity")),r.id,E.layoutVertexBuffer,E.indexBuffer,E.segments,r.paint,e.transform.zoom,T,f?[E.globeExtVertexBuffer]:null)}i.viewport.set([0,0,e.width,e.height])}else e.renderPass==="translucent"&&(e.context.setColorMode(e.colorModeForRenderPass()),function(i,s){const a=i.context,l=a.gl,p=s.heatmapFbo;if(!p)return;a.activeTexture.set(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,p.colorAttachment.get()),a.activeTexture.set(l.TEXTURE1);let f=s.colorRampTexture;f||(f=s.colorRampTexture=new dn(a,s.colorRamp,l.RGBA)),f.bind(l.LINEAR,l.CLAMP_TO_EDGE),i.useProgram("heatmapTexture").draw(i,l.TRIANGLES,de.disabled,Be.disabled,i.colorModeForRenderPass(),Ge.disabled,((m,_,y,v)=>({u_image:0,u_color_ramp:1,u_opacity:_.paint.get("heatmap-opacity")}))(0,s),s.id,i.viewportBuffer,i.quadTriangleIndexBuffer,i.viewportSegments,s.paint,i.transform.zoom)}(e,r))},line:function(e,t,r,n){if(e.renderPass!=="translucent")return;const i=r.paint.get("line-opacity"),s=r.paint.get("line-width");if(i.constantOr(1)===0||s.constantOr(1)===0)return;const a=r.paint.get("line-emissive-strength"),l=e.depthModeForSublayer(0,de.ReadOnly),p=e.colorModeForDrapableLayerRenderPass(a),f=e.terrain&&e.terrain.renderingToTexture?1:ge.devicePixelRatio,m=r.paint.get("line-dasharray"),_=m.constantOr(1),y=r.layout.get("line-cap"),v=r.paint.get("line-pattern"),b=v.constantOr(1),w=r.paint.get("line-gradient"),E=b?"linePattern":"line",T=e.context,C=T.gl,M=(P=>{const L=[];I2(P)&&L.push("RENDER_LINE_DASH"),P.paint.get("line-gradient")&&L.push("RENDER_LINE_GRADIENT");const R=P.paint.get("line-trim-offset");R[0]===0&&R[1]===0||L.push("RENDER_LINE_TRIM_OFFSET");const N=P.paint.get("line-pattern").constantOr(1),k=P.paint.get("line-opacity").constantOr(1)!==1;return!N&&k&&L.push("RENDER_LINE_ALPHA_DISCARD"),P.paint.get("line-border-width").constantOr(0)>0&&L.push("RENDER_LINE_BORDER"),P.paint.get("line-border-color").constantOr(Se.transparent).a===0&&L.push("RENDER_LINE_BORDER_AUTO"),L})(r);let A=M.includes("RENDER_LINE_ALPHA_DISCARD");e.terrain&&e.terrain.clipOrMaskOverlapStencilType()&&(A=!1);for(const P of n){const L=t.getTile(P);if(b&&!L.patternsLoaded())continue;const R=L.getBucket(r);if(!R)continue;e.prepareDrawTile();const N=R.programConfigurations.get(r.id),k=e.useProgram(E,N,M),F=v.constantOr(null);if(F&&L.imageAtlas){const X=L.imageAtlas.patternPositions[F.toString()];X&&N.setConstantPatternPositions(X)}const z=m.constantOr(null),U=y.constantOr(null);if(!b&&z&&U&&L.lineAtlas){const X=L.lineAtlas.getDash(z,U);X&&N.setConstantPatternPositions(X)}let[G,V]=r.paint.get("line-trim-offset");(U==="round"||U==="square")&&G!==V&&(G===0&&(G-=1),V===1&&(V+=1));const K=e.terrain?P.projMatrix:null,$=b?gD(e,L,r,K,f):mD(e,L,r,K,R.lineClipsArray.length,f,[G,V]);if(w){const X=R.gradients[r.id];let J=X.texture;if(r.gradientVersion!==X.version){let nt=256;if(r.stepInterpolant){const at=t.getSource().maxzoom,ot=P.canonical.z===at?Math.ceil(1<<e.transform.maxZoom-P.canonical.z):1;nt=Bt(Tp(R.maxLineLength/lt*1024*ot),256,T.maxTextureSize)}X.gradient=Mf({expression:r.gradientExpression(),evaluationKey:"lineProgress",resolution:nt,image:X.gradient||void 0,clips:R.lineClipsArray}),X.texture?X.texture.update(X.gradient):X.texture=new dn(T,X.gradient,C.RGBA),X.version=r.gradientVersion,J=X.texture}T.activeTexture.set(C.TEXTURE1),J.bind(r.stepInterpolant?C.NEAREST:C.LINEAR,C.CLAMP_TO_EDGE)}_&&(T.activeTexture.set(C.TEXTURE0),L.lineAtlasTexture.bind(C.LINEAR,C.REPEAT),N.updatePaintBuffers()),b&&(T.activeTexture.set(C.TEXTURE0),L.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),N.updatePaintBuffers()),e.uploadCommonUniforms(T,k,P.toUnwrapped());const tt=X=>{k.draw(e,C.TRIANGLES,l,X,p,Ge.disabled,$,r.id,R.layoutVertexBuffer,R.indexBuffer,R.segments,r.paint,e.transform.zoom,N,[R.layoutVertexBuffer2])};if(A){const X=e.stencilModeForClipping(P).ref;X===0&&e.terrain&&T.clear({stencil:0});const J={func:C.EQUAL,mask:255};$.u_alpha_discard_threshold=.8,tt(new Be(J,X,255,C.KEEP,C.KEEP,C.INVERT)),$.u_alpha_discard_threshold=0,tt(new Be(J,X,255,C.KEEP,C.KEEP,C.KEEP))}else tt(e.stencilModeForClipping(P))}A&&(e.resetStencilClippingMasks(),e.terrain&&T.clear({stencil:0}))},fill:function(e,t,r,n){const i=r.paint.get("fill-color"),s=r.paint.get("fill-opacity");if(s.constantOr(1)===0)return;const a=r.paint.get("fill-emissive-strength"),l=e.colorModeForDrapableLayerRenderPass(a),p=r.paint.get("fill-pattern"),f=e.opaquePassEnabledForLayer()&&!p.constantOr(1)&&i.constantOr(Se.transparent).a===1&&s.constantOr(0)===1?"opaque":"translucent";if(e.renderPass===f){const m=e.depthModeForSublayer(1,e.renderPass==="opaque"?de.ReadWrite:de.ReadOnly);O2(e,t,r,n,m,l,!1)}if(e.renderPass==="translucent"&&r.paint.get("fill-antialias")){const m=e.depthModeForSublayer(r.getPaintProperty("fill-outline-color")?2:0,de.ReadOnly);O2(e,t,r,n,m,l,!0)}},"fill-extrusion":function(e,t,r,n){const i=r.paint.get("fill-extrusion-opacity"),s=e.context,a=s.gl,l=e.terrain,p=l&&l.renderingToTexture;if(i===0)return;const f=e.conflationActive&&e.layerUsedInConflation(r,t.getSource());if(f&&function(m,_,y,v){for(const b of v){const w=_.getTile(b).getBucket(y);w&&(w.updateReplacement(b,m.replacementSource),w.uploadCentroid(m.context))}}(e,t,r,n),l||f)for(const m of n){const _=t.getTile(m).getBucket(r);_&&CD(e.context,t,m,_,r,l,f)}if(e.renderPass==="shadow"&&e.shadowRenderer){const m=e.shadowRenderer,_=m.getShadowPassDepthMode(),y=m.getShadowPassColorMode();bd(e,t,r,n,_,Be.disabled,y,f)}else if(e.renderPass==="translucent"){const m=!r.paint.get("fill-extrusion-pattern").constantOr(1);if(!p){const y=new de(e.context.gl.LEQUAL,de.ReadWrite,e.depthRangeFor3D);if(i===1&&m){const v=e.colorModeForRenderPass();bd(e,t,r,n,y,Be.disabled,v,f)}else bd(e,t,r,n,y,Be.disabled,sr.disabled,f),bd(e,t,r,n,y,e.stencilModeFor3D(),e.colorModeForRenderPass(),f),e.resetStencilClippingMasks()}const _=e.style.enable3dLights();if(e.context.isWebGL2&&_&&m&&(!l&&e.transform.projection.name!=="globe"||p)){const y=r.paint.get("fill-extrusion-opacity"),v=r.paint.get("fill-extrusion-ambient-occlusion-intensity"),b=r.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),w=r.paint.get("fill-extrusion-flood-light-intensity"),E=r.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),T=v>0&&b>0,C=w>0,M=(P,L,R)=>(1-R)*P+R*L,A=P=>{const L=e.depthModeForSublayer(1,de.ReadOnly,a.LEQUAL,!0),R=r.paint.get(P?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),N=M(.1,3,R),k=e._showOverdrawInspector;{const F=new Be({func:a.ALWAYS,mask:255},255,255,a.KEEP,a.KEEP,a.REPLACE),z=new sr([a.ONE,a.ONE,a.ONE,a.ONE],Se.transparent,[!1,!1,!1,!0],a.MIN);fc(e,t,r,n,L,F,z,Ge.disabled,P,"sdf",y,v,b,w,E,N,f)}{const F=new Be({func:a.EQUAL,mask:255},255,255,a.KEEP,a.DECR,a.DECR),z=new sr([a.ONE_MINUS_DST_ALPHA,a.DST_ALPHA,a.ONE,a.ONE],Se.transparent,[!0,!0,!0,!0]);fc(e,t,r,n,L,F,k?e.colorModeForRenderPass():z,Ge.disabled,P,"color",y,v,b,w,E,N,f)}};if(p){const P=(L,R)=>{const N=e.depthModeForSublayer(1,de.ReadOnly,a.LEQUAL,!1),k=r.paint.get(L?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),F=M(.1,3,k);{const z=new sr([a.ONE,a.ONE,a.ONE,a.ONE],Se.transparent,[!1,!1,!1,!0]);fc(e,t,r,n,N,Be.disabled,z,Ge.disabled,L,"clear",y,v,b,w,E,F,f)}{const z=new Be({func:a.ALWAYS,mask:255},255,255,a.KEEP,a.KEEP,a.REPLACE),U=new sr([a.ONE,a.ONE,a.ONE,a.ONE],Se.transparent,[!1,!1,!1,!0],a.MIN);fc(e,t,r,n,N,z,U,Ge.disabled,L,"sdf",y,v,b,w,E,F,f)}{const z=L?a.ZERO:a.ONE_MINUS_DST_ALPHA,U=new Be({func:a.EQUAL,mask:255},255,255,a.KEEP,a.DECR,a.DECR),G=new sr([z,a.DST_ALPHA,a.ONE_MINUS_DST_ALPHA,a.ZERO],Se.transparent,[!0,!0,!0,!0]);fc(e,t,r,n,N,U,G,Ge.disabled,L,"color",y,v,b,w,E,F,f)}{const z=new sr([a.ONE,a.ONE,a.ONE,L?a.ZERO:a.ONE],Se.transparent,[!1,!1,!1,!0],L?a.FUNC_ADD:a.MAX);fc(e,t,r,n,N,Be.disabled,z,Ge.disabled,L,"clear",y,v,b,w,E,F,f,R)}};if(T||C){let L;if(e.prepareDrawTile(),l){const R=l.drapeBufferSize[0],N=l.drapeBufferSize[1];L=l.framebufferCopyTexture,L&&(!L||L.size[0]===R&&L.size[1]===N)||(L&&L.destroy(),L=l.framebufferCopyTexture=new dn(s,new Yr({width:R,height:N}),a.RGBA)),L.bind(a.LINEAR,a.CLAMP_TO_EDGE),a.copyTexImage2D(a.TEXTURE_2D,0,a.RGBA,0,0,R,N,0)}T&&P(!0,L),C&&P(!1,L)}}else T&&A(!0),C&&A(!1)}}},hillshade:function(e,t,r,n){if(e.renderPass!=="offscreen"&&e.renderPass!=="translucent")return;const i=e.context,s=e.depthModeForSublayer(0,de.ReadOnly),a=e.colorModeForRenderPass(),l=e.terrain&&e.terrain.renderingToTexture,[p,f]=e.renderPass!=="translucent"||l?[{},n]:e.stencilConfigForOverlap(n);for(const m of f){const _=t.getTile(m);if(_.needsHillshadePrepare&&e.renderPass==="offscreen")WL(e,_,r,s,Be.disabled,a);else if(e.renderPass==="translucent"){const y=l&&e.terrain?e.terrain.stencilModeForRTTOverlap(m):p[m.overscaledZ];XL(e,m,_,r,s,y,a)}}i.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(e,t,r,n,i,s){if(e.renderPass!=="translucent"||r.paint.get("raster-opacity")===0||!n.length)return;const a=e.context,l=a.gl,p=t.getSource(),f=function(T,C,M){const A=[];let P,L;if(T.paint.get("raster-color")){A.push("RASTER_COLOR"),P=T.paint.get("raster-color-mix"),L=T.paint.get("raster-color-range"),C.activeTexture.set(M.TEXTURE2);let R=T.colorRampTexture;R||(R=T.colorRampTexture=new dn(C,T.colorRamp,M.RGBA)),R.bind(M.LINEAR,M.CLAMP_TO_EDGE)}return{mix:P,range:L,defines:A}}(r,a,l),m=e.useProgram("raster",null,f.defines),_=e.colorModeForDrapableLayerRenderPass(),y=e.terrain&&e.terrain.renderingToTexture,[v,b]=p instanceof Wl||y?[{},n]:e.stencilConfigForOverlap(n),w=b[b.length-1].overscaledZ,E=!e.options.moving;for(const T of b){const C=y?de.disabled:e.depthModeForSublayer(T.overscaledZ-w,r.paint.get("raster-opacity")===1?de.ReadWrite:de.ReadOnly,l.LESS),M=T.toUnwrapped(),A=t.getTile(T);if(y&&(!A||!A.hasData()))continue;const P=y?T.projMatrix:e.transform.calculateProjMatrix(M,E),L=e.terrain&&y?e.terrain.stencilModeForRTTOverlap(T):v[T.overscaledZ],R=s?0:r.paint.get("raster-fade-duration");A.registerFadeDuration(R);const N=t.findLoadedParent(T,0),k=m2(A,N,t,e.transform,R);let F,z;e.terrain&&e.terrain.prepareDrawTile();const U=r.paint.get("raster-resampling")==="nearest"?l.NEAREST:l.LINEAR;a.activeTexture.set(l.TEXTURE0),A.texture.bind(U,l.CLAMP_TO_EDGE),a.activeTexture.set(l.TEXTURE1),N?(N.texture.bind(U,l.CLAMP_TO_EDGE),F=Math.pow(2,N.tileID.overscaledZ-A.tileID.overscaledZ),z=[A.tileID.canonical.x*F%1,A.tileID.canonical.y*F%1]):A.texture.bind(U,l.CLAMP_TO_EDGE),A.texture.useMipmap&&a.extTextureFilterAnisotropic&&e.transform.pitch>20&&l.texParameterf(l.TEXTURE_2D,a.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,a.extTextureFilterAnisotropicMax);const G=_D(P,z||[0,0],F||1,k,r,p instanceof Wl?p.perspectiveTransform:[0,0],2,f.mix||[0,0,0,0],f.range||[0,0]);if(e.uploadCommonUniforms(a,m,M),p instanceof Wl)p.boundsBuffer&&p.boundsSegments&&m.draw(e,l.TRIANGLES,C,Be.disabled,_,Ge.disabled,G,r.id,p.boundsBuffer,e.quadTriangleIndexBuffer,p.boundsSegments);else{const{tileBoundsBuffer:V,tileBoundsIndexBuffer:K,tileBoundsSegments:$}=e.getTileBoundsBuffers(A);m.draw(e,l.TRIANGLES,C,L,_,Ge.disabled,G,r.id,V,K,$)}}e.resetStencilClippingMasks()},background:function(e,t,r,n){const i=r.paint.get("background-color"),s=r.paint.get("background-opacity"),a=r.paint.get("background-emissive-strength");if(s===0)return;const l=e.context,p=l.gl,f=e.transform,m=f.tileSize,_=r.paint.get("background-pattern");if(e.isPatternMissing(_,r.scope))return;const y=!_&&i.a===1&&s===1&&e.opaquePassEnabledForLayer()?"opaque":"translucent";if(e.renderPass!==y)return;const v=Be.disabled,b=e.depthModeForSublayer(0,y==="opaque"?de.ReadWrite:de.ReadOnly),w=e.colorModeForDrapableLayerRenderPass(a),E=e.useProgram(_?"backgroundPattern":"background");let T,C=n;C||(T=e.getBackgroundTiles(),C=Object.values(T).map(M=>M.tileID)),_&&(l.activeTexture.set(p.TEXTURE0),e.imageManager.bind(e.context,r.scope));for(const M of C){const A=M.toUnwrapped(),P=n?M.projMatrix:e.transform.calculateProjMatrix(A);e.prepareDrawTile();const L=t?t.getTile(M):T?T[M.key]:new Dh(M,m,f.zoom,e),R=_?wD(P,a,s,e,_,r.scope,{tileID:M,tileSize:m}):bD(P,a,s,i);e.uploadCommonUniforms(l,E,A);const{tileBoundsBuffer:N,tileBoundsIndexBuffer:k,tileBoundsSegments:F}=e.getTileBoundsBuffers(L);E.draw(e,p.TRIANGLES,b,v,w,Ge.disabled,R,r.id,N,k,F)}},sky:function(e,t,r){const n=e._atmosphere?Zn(e.transform.zoom):1,i=r.paint.get("sky-opacity")*n;if(i===0)return;const s=e.context,a=r.paint.get("sky-type"),l=new de(s.gl.LEQUAL,de.ReadOnly,[0,1]),p=e.frameCounter/1e3%1;a==="atmosphere"?e.renderPass==="offscreen"?r.needsSkyboxCapture(e)&&(function(f,m,_,y){const v=f.context,b=v.gl;let w=m.skyboxFbo;if(!w){w=m.skyboxFbo=v.createFramebuffer(32,32,!0,null),m.skyboxGeometry=new k2(v),m.skyboxTexture=v.gl.createTexture(),b.bindTexture(b.TEXTURE_CUBE_MAP,m.skyboxTexture),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_MAG_FILTER,b.LINEAR);for(let M=0;M<6;++M)b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+M,0,b.RGBA,32,32,0,b.RGBA,b.UNSIGNED_BYTE,null)}v.bindFramebuffer.set(w.framebuffer),v.viewport.set([0,0,32,32]);const E=m.getCenter(f,!0),T=f.useProgram("skyboxCapture"),C=new Float64Array(16);Q.identity(C),Q.rotateY(C,C,.5*-Math.PI),dc(f,m,T,C,E,0),Q.identity(C),Q.rotateY(C,C,.5*Math.PI),dc(f,m,T,C,E,1),Q.identity(C),Q.rotateX(C,C,.5*-Math.PI),dc(f,m,T,C,E,2),Q.identity(C),Q.rotateX(C,C,.5*Math.PI),dc(f,m,T,C,E,3),Q.identity(C),dc(f,m,T,C,E,4),Q.identity(C),Q.rotateY(C,C,Math.PI),dc(f,m,T,C,E,5),v.viewport.set([0,0,f.width,f.height])}(e,r),r.markSkyboxValid(e)):e.renderPass==="sky"&&function(f,m,_,y,v){const b=f.context,w=b.gl,E=f.transform,T=f.useProgram("skybox");b.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_CUBE_MAP,m.skyboxTexture);const C=((M,A,P,L,R)=>({u_matrix:M,u_sun_direction:A,u_cubemap:0,u_opacity:L,u_temporal_offset:R}))(E.skyboxMatrix,m.getCenter(f,!1),0,y,v);f.uploadCommonUniforms(b,T),T.draw(f,w.TRIANGLES,_,Be.disabled,f.colorModeForRenderPass(),Ge.backCW,C,"skybox",m.skyboxGeometry.vertexBuffer,m.skyboxGeometry.indexBuffer,m.skyboxGeometry.segment)}(e,r,l,i,p):a==="gradient"&&e.renderPass==="sky"&&function(f,m,_,y,v){const b=f.context,w=b.gl,E=f.transform,T=f.useProgram("skyboxGradient");m.skyboxGeometry||(m.skyboxGeometry=new k2(b)),b.activeTexture.set(w.TEXTURE0);let C=m.colorRampTexture;C||(C=m.colorRampTexture=new dn(b,m.colorRamp,w.RGBA)),C.bind(w.LINEAR,w.CLAMP_TO_EDGE);const M=((A,P,L,R,N)=>({u_matrix:A,u_color_ramp:0,u_center_direction:P,u_radius:re(L),u_opacity:R,u_temporal_offset:N}))(E.skyboxMatrix,m.getCenter(f,!1),m.paint.get("sky-gradient-radius"),y,v);f.uploadCommonUniforms(b,T),T.draw(f,w.TRIANGLES,_,Be.disabled,f.colorModeForRenderPass(),Ge.backCW,M,"skyboxGradient",m.skyboxGeometry.vertexBuffer,m.skyboxGeometry.indexBuffer,m.skyboxGeometry.segment)}(e,r,l,i,p)},debug:function(e,t,r){for(let n=0;n<r.length;n++)RD(e,t,r[n])},custom:function(e,t,r,n){const i=e.context,s=r.implementation;if(!e.transform.projection.unsupportedLayers||!e.transform.projection.unsupportedLayers.includes("custom")||e.terrain&&(e.terrain.renderingToTexture||e.renderPass==="offscreen")&&r.isLayerDraped()){if(e.renderPass==="offscreen"){const a=s.prerender;if(a){if(e.setCustomLayerDefaults(),i.setColorMode(e.colorModeForRenderPass()),e.transform.projection.name==="globe"){const l=e.transform.pointMerc;a.call(s,i.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),Zn(e.transform.zoom),[l.x,l.y],e.transform.pixelsPerMeterRatio)}else a.call(s,i.gl,e.transform.customLayerMatrix());i.setDirty(),e.setBaseState()}}else if(e.renderPass==="translucent"){if(e.terrain&&e.terrain.renderingToTexture){const l=s.renderToTile;if(l){const p=n[0].canonical,f=new Ue(p.x+n[0].wrap*(1<<p.z),p.y,p.z);i.setDepthMode(de.disabled),i.setStencilMode(Be.disabled),i.setColorMode(e.colorModeForRenderPass()),e.setCustomLayerDefaults(),l.call(s,i.gl,f),i.setDirty(),e.setBaseState()}return}e.setCustomLayerDefaults(),i.setColorMode(e.colorModeForRenderPass()),i.setStencilMode(Be.disabled);const a=s.renderingMode==="3d"?new de(e.context.gl.LEQUAL,de.ReadWrite,e.depthRangeFor3D):e.depthModeForSublayer(0,de.ReadOnly);if(i.setDepthMode(a),e.transform.projection.name==="globe"){const l=e.transform.pointMerc;s.render(i.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),Zn(e.transform.zoom),[l.x,l.y],e.transform.pixelsPerMeterRatio)}else s.render(i.gl,e.transform.customLayerMatrix());i.setDirty(),e.setBaseState(),i.bindFramebuffer.set(null)}}else Y("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(e,t,r,n){if(e.renderPass==="opaque")return;const i=r.paint.get("model-opacity");if(i===0)return;const s=r.paint.get("model-cast-shadows");if(e.renderPass==="shadow"&&!s)return;const a=e.shadowRenderer,l=r.paint.get("model-receive-shadows");a&&(a.useNormalOffset=!0,l||(a.enabled=!1));const p=()=>{a&&(a.useNormalOffset=!0,l||(a.enabled=!0))},f=t.getSource();if(e.renderPass==="light-beam"&&f.type!=="batched-model"||!f.loaded())return;if(f.type==="vector"||f.type==="geojson")return function(T,C,M,A){const P=T.transform;if(P.projection.name!=="mercator")return void Y(`Drawing 3D models for ${P.projection.name} projection is not yet implemented`);const L=P.getFreeCameraOptions().position,R=[L.x,L.y,L.z-P.pixelsPerMeter/P.worldSize*P._centerAltitude],N=T.transform._camera.forward(),k=[0,0,0],F=[0,0,0];if(!T.modelManager)return;const z=T.modelManager;if(!M._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const U=M._unevaluatedLayout._values["model-id"],G={...M.layout.get("model-id").parameters};for(const V of A){const K=C.getTile(V).getBucket(M);if(!K||K.projection.name!==P.projection.name)continue;let $=K.zoom;F[0]=V.wrap+(V.canonical.x+(T.transform.bearing<0?.75:.25))/(1<<V.canonical.z),F[1]=(V.canonical.y+(Math.abs(T.transform.bearing)<90?.75:.25))/(1<<V.canonical.z),q.sub(k,F,R);const tt=Math.max(0,q.dot(k,N));$=T.transform._zoomFromMercatorZ(tt),T.transform.pitch>30&&$<T.transform.zoom&&K.instanceCount>400&&($-=.5),G.zoom=$;const X=U.possiblyEvaluate(G);if(VD(T,K,V),va.shadowUniformsInitialized=!1,T.renderPass==="shadow"&&T.shadowRenderer){const nt=T.shadowRenderer;if(T.currentShadowCascade===1&&K.isInsideFirstShadowMapFrustum)continue;const at=P.calculatePosMatrix(V.toUnwrapped(),P.worldSize);if(va.tileMatrix.set(at),va.shadowTileMatrix=Float32Array.from(nt.calculateShadowPassMatrixFromMatrix(at)),va.aabb.min.fill(0),va.aabb.max[0]=va.aabb.max[1]=lt,va.aabb.max[2]=0,jD(K,va,T,M.scope))continue}let J=q.scale([],R,1<<V.canonical.z);J=[(J[0]-V.canonical.x-V.wrap*(1<<V.canonical.z))*lt,(J[1]-V.canonical.y)*lt,J[2]*lt];for(let nt in K.instancesPerModel){const at=K.instancesPerModel[nt];at.features.length>0&&(nt=X.evaluate(at.features[0].feature,{}));const ot=z.getModel(nt,M.scope);if(ot)for(const It of ot.nodes)V2(T,M,It,at,J,V,va)}}}(e,t,r,n),void p();if(f.type==="batched-model")return function(T,C,M,A){const P=T.transform;if(P.projection.name!=="mercator")return void Y(`Drawing 3D landmark models for ${P.projection.name} projection is not yet implemented`);const L=T.transform.getFreeCameraOptions().position,R=q.scale([],[L.x,L.y,L.z],T.transform.worldSize);q.negate(R,R);const N=Q.identity([]),k=Qa(P.center.lat,P.zoom),F=Q.fromScaling([],[1,1,1/k]);Q.translate(N,N,R),function(z,U,G,V){const K=z.terrain?z.terrain.exaggeration():0,$=z.transform.zoom;for(const tt of V){const X=U.getTile(tt).getBucket(G);X&&(z.conflationActive&&X.updateReplacement(tt,z.replacementSource),X.evaluateScale(z,G),z.terrain&&K>0&&X.elevationUpdate(z.terrain,K,tt),X.needsReEvaluation(z,$,G)&&X.evaluate(G))}}(T,C,M,A);for(const z of A){const U=C.getTile(z).getBucket(M);if(!U||!U.uploaded)continue;const G=P.calculatePosMatrix(z.toUnwrapped(),P.worldSize),V=U.getNodesInfo();for(const K of V)K.hiddenByReplacement||K.node.meshes&&GD(K,U.modelTraits,T,M,z,G,F,N)}}(e,t,r,n),void p();const m=f.getModels(),_=[],y=e.transform.getFreeCameraOptions().position,v=q.scale([],[y.x,y.y,y.z],e.transform.worldSize);q.negate(v,v);const b=[],w=[];let E=0;for(const T of m){const C=r.paint.get("model-rotation").constantOr(null),M=r.paint.get("model-scale").constantOr(null),A=r.paint.get("model-translation").constantOr(null);T.computeModelMatrix(e,C,M,A,!0,!0,!1);const P=Q.identity([]),L=Qa(T.position.lat,e.transform.zoom),R=Q.fromScaling([],[1,1,1/L]);Q.translate(P,P,v),_.push({zScaleMatrix:R,negCameraPosMatrix:P});for(const N of T.nodes)B2(e.transform,N,T.matrix,e.transform.projMatrix,E,b,w);E++}if(b.sort((T,C)=>C.depth-T.depth),e.renderPass!=="shadow"){if(i===1)for(const T of w)Ed(T,e,r,_[T.modelIndex],Be.disabled,e.colorModeForRenderPass());else{for(const T of w)Ed(T,e,r,_[T.modelIndex],Be.disabled,sr.disabled);for(const T of w)Ed(T,e,r,_[T.modelIndex],e.stencilModeFor3D(),e.colorModeForRenderPass());e.resetStencilClippingMasks()}for(const T of b)Ed(T,e,r,_[T.modelIndex],Be.disabled,e.colorModeForRenderPass());p()}else{for(const T of w)Ly(T.mesh,T.nodeModelMatrix,e,r);for(const T of b)Ly(T.mesh,T.nodeModelMatrix,e,r);p()}}},G2={modelUpload:function(e,t,r){const n=t.getSource();if(!n.loaded())return;if(n.type==="vector"||n.type==="geojson")return void(e.modelManager&&e.modelManager.upload(e,r));if(n.type==="batched-model")return;const i=n.getModels();for(const s of i)s.upload(e.context)}};class XD{constructor(t,r,n=!1){this.context=new gP(t,n),this.transform=r,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=ds.maxUnderzooming+ds.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new DP,this._shadowRenderer=new HL(this),this._wireframeDebugCache=new ZD}updateTerrain(t,r){const n=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(n||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new QL(this,t));const i=this._terrain;this.transform.elevation=n?i:null,i.update(t,this.transform,r)}_updateFog(t){const r=t.fog;if(!r||this.transform.projection.name==="globe"||r.getOpacity(this.transform.pitch)<1||r.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[n,i]=r.getFovAdjustedRange(this.transform._fov);if(n>i)return void(this.transform.fogCullDistSq=null);const s=n+.78*(i-n);this.transform.fogCullDistSq=s*s}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,r){if(this.width=t*ge.devicePixelRatio,this.height=r*ge.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const n of this.style.order)this.style._layers[n].resize()}setup(){const t=this.context,r=new $i;r.emplaceBack(0,0),r.emplaceBack(lt,0),r.emplaceBack(0,lt),r.emplaceBack(lt,lt),this.tileExtentBuffer=t.createVertexBuffer(r,$a.members),this.tileExtentSegments=mr.simpleSegment(0,0,4,2);const n=new $i;n.emplaceBack(0,0),n.emplaceBack(lt,0),n.emplaceBack(0,lt),n.emplaceBack(lt,lt),this.debugBuffer=t.createVertexBuffer(n,$a.members),this.debugSegments=mr.simpleSegment(0,0,4,5);const i=new $i;i.emplaceBack(-1,-1),i.emplaceBack(1,-1),i.emplaceBack(-1,1),i.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(i,$a.members),this.viewportSegments=mr.simpleSegment(0,0,4,2);const s=new Ua;s.emplaceBack(0,0,0,0),s.emplaceBack(lt,0,lt,0),s.emplaceBack(0,lt,0,lt),s.emplaceBack(lt,lt,lt,lt),this.mercatorBoundsBuffer=t.createVertexBuffer(s,H_.members),this.mercatorBoundsSegments=mr.simpleSegment(0,0,4,2);const a=new xn;a.emplaceBack(0,1,2),a.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(a);const l=new ph;for(const f of[0,1,3,2,0])l.emplaceBack(f);this.debugIndexBuffer=t.createIndexBuffer(l),this.emptyTexture=new dn(t,new Yr({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA),this.identityMat=Q.create();const p=this.context.gl;this.stencilClearMode=new Be({func:p.ALWAYS,mask:0},0,255,p.ZERO,p.ZERO,p.ZERO),this.loadTimeStamps.push(S.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(this,t.TRIANGLES,de.disabled,this.stencilClearMode,sr.disabled,Ge.disabled,Cy(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,r,n){if(!r||this.currentStencilSource===r.id||!t.isTileClipped()||!n||n.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let l=!1;for(const p of n)if(this._tileClippingMaskIDs[p.key]===void 0){l=!0;break}if(!l)return}this.currentStencilSource=r.id;const i=this.context,s=i.gl;this.nextStencilID+n.length>256&&this.clearStencil(),i.setColorMode(sr.disabled),i.setDepthMode(de.disabled);const a=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const l of n){const p=r.getTile(l),f=this._tileClippingMaskIDs[l.key]=this.nextStencilID++,{tileBoundsBuffer:m,tileBoundsIndexBuffer:_,tileBoundsSegments:y}=this.getTileBoundsBuffers(p);a.draw(this,s.TRIANGLES,de.disabled,new Be({func:s.ALWAYS,mask:0},f,255,s.KEEP,s.KEEP,s.REPLACE),sr.disabled,Ge.disabled,Cy(l.projMatrix),"$clipping",m,_,y)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,r=this.context.gl;return new Be({func:r.NOTEQUAL,mask:255},t,255,r.KEEP,r.KEEP,r.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const r=this.context.gl;return new Be({func:r.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,r.KEEP,r.KEEP,r.REPLACE)}stencilConfigForOverlap(t){const r=this.context.gl,n=t.sort((a,l)=>l.overscaledZ-a.overscaledZ),i=n[n.length-1].overscaledZ,s=n[0].overscaledZ-i+1;if(s>1){this.currentStencilSource=void 0,this.nextStencilID+s>256&&this.clearStencil();const a={};for(let l=0;l<s;l++)a[l+i]=new Be({func:r.GEQUAL,mask:255},l+this.nextStencilID,255,r.KEEP,r.KEEP,r.REPLACE);return this.nextStencilID+=s,[a,n]}return[{[i]:Be.disabled},n]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new sr([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new Se(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?sr.unblended:sr.alphaBlended}colorModeForDrapableLayerRenderPass(t){const r=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.style.map._optimizeForTerrain)()&&this.renderPass==="translucent"?new sr([r.ONE,r.ONE_MINUS_SRC_ALPHA,r.CONSTANT_ALPHA,r.ONE_MINUS_SRC_ALPHA],new Se(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,r,n,i=!1){if(!this.opaquePassEnabledForLayer()&&!i)return de.disabled;const s=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new de(n||this.context.gl.LEQUAL,r,[s,s])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,r){this._wireframeDebugCache.update(this.frameCounter),this.style=t,this.options=r;const n=this.style._layers,i=this.style.order,s=i.map(E=>n[E]),a=this.style._sourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(ge.now()),this.imageManager.beginFrame();let l=0,p=!1;for(const E in a){const T=a[E];T.used&&(T.prepare(this.context),T.getSource().usedInConflation&&++l)}const f={},m={},_={};for(const E in a){const T=a[E];f[E]=T.getVisibleCoordinates(),m[E]=f[E].slice().reverse(),_[E]=T.getVisibleCoordinates(!0).reverse()}if(l){const E=C=>{const M=this.style._getLayerSourceCache(C);return M&&M.used?M.getSource():null},T=[];for(const C of s)this.layerUsedInConflation(C,E(C))&&T.push(C);if(T&&T.length>1){const C=[];for(const M of T){const A=this.style._getLayerSourceCache(M);A&&A.used&&A.getSource().usedInConflation&&C.push({layer:M.id,cache:A})}this.replacementSource.setSources(C),p=!0}}p||this.replacementSource.clear(),this.conflationActive=p,this.opaquePassCutoff=1/0;for(let E=0;E<s.length;E++)if(s[E].is3D()){this.opaquePassCutoff=E;break}this.terrain&&(this.terrain.updateTileBinding(_),this.opaquePassCutoff=0),this._shadowRenderer&&this._shadowRenderer.updateShadowParameters(this.transform,this.style.directionalLight),this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new OC(this.context));for(const E of s){if(E.isHidden(this.transform.zoom))continue;const T=t._getLayerSourceCache(E);this.uploadLayer(this,E,T)}if(this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new BD),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!Sp.has(this.context.gl))return;this.renderPass="offscreen";for(const E of s){const T=t._getLayerSourceCache(E);if(!E.hasOffscreenPass()||E.isHidden(this.transform.zoom))continue;const C=T?m[T.id]:void 0;(E.type==="custom"||E.isSky()||C&&C.length)&&this.renderLayer(this,T,E,C)}this.depthRangeFor3D=[0,1-(s.length+2)*this.numSublayers*this.depthEpsilon];const y=this.terrain;y&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&y.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,m)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const v=(()=>{if(r.showOverdrawInspector)return Se.black;if(this.style.fog&&this.transform.projection.supportsFog){const E=this.style.fog.properties.get("space-color").toArray01();return new Se(...E)}return Se.transparent})();if(this.context.clear({color:v,depth:1}),this.clearStencil(),this._showOverdrawInspector=r.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=i.length-1;this.currentLayer>=0;this.currentLayer--){const E=s[this.currentLayer],T=t._getLayerSourceCache(E);if(E.isSky())continue;const C=T?m[T.id]:void 0;this._renderTileClippingMasks(E,T,C),this.renderLayer(this,T,E,C)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||Zn(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<i.length;this.currentLayer++){const E=s[this.currentLayer],T=t._getLayerSourceCache(E);E.isSky()&&this.renderLayer(this,T,E,T?m[T.id]:void 0)}this.renderPass="translucent",this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let b=0;const w=this.shadowRenderer;for(w&&(b=w.getShadowCastingLayerCount());this.currentLayer<i.length;){const E=s[this.currentLayer],T=t._getLayerSourceCache(E);if(E.isSky()){++this.currentLayer;continue}if(y&&this.style.isLayerDraped(E)){if(E.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=y.renderBatch(this.currentLayer);continue}const C=T?(E.type==="symbol"?_:m)[T.id]:void 0;if(this._renderTileClippingMasks(E,T,T?f[T.id]:void 0),this.renderLayer(this,T,E,C),!y&&w&&b>0&&E.hasShadowPass()&&--b==0&&(w.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const M=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=M;this.currentLayer++){const A=s[this.currentLayer];if(!A.hasLightBeamPass())continue;const P=t._getLayerSourceCache(A);this.renderLayer(this,P,A,P?m[P.id]:void 0)}this.currentLayer=M,this.renderPass="translucent"}++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let E=null;s.forEach(T=>{const C=t._getLayerSourceCache(T);C&&!T.isHidden(this.transform.zoom)&&(!E||E.getSource().maxzoom<C.getSource().maxzoom)&&(E=C)}),E&&this.options.showTileBoundaries&&U2.debug(this,E,E.getVisibleCoordinates())}this.options.showPadding&&function(E){const T=E.transform.padding;N2(E,E.transform.height-(T.top||0),3,MD),N2(E,T.bottom||0,3,AD),z2(E,T.left||0,3,PD),z2(E,E.transform.width-(T.right||0),3,LD);const C=E.transform.centerPoint;(function(M,A,P,L){wd(M,A-1,P-10,2,20,L),wd(M,A-10,P-1,20,2,L)})(E,C.x,E.transform.height-C.y,DD)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(S.performance.now()),this.saveCanvasCopy()),p||(this.conflationActive=!1)}uploadLayer(t,r,n){this.gpuTimingStart(r),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(r.type)||t.terrain&&r.type==="custom")&&G2[`${r.type}Upload`]&&G2[`${r.type}Upload`](t,n,r.scope),this.gpuTimingEnd()}renderLayer(t,r,n,i){n.isHidden(this.transform.zoom)||(n.type==="background"||n.type==="sky"||n.type==="custom"||n.type==="model"||i&&i.length)&&(this.id=n.id,this.gpuTimingStart(n),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(n.type)||t.terrain&&n.type==="custom")&&U2[n.type](t,r,n,i,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const r=this.context.extTimerQuery;let n=this.gpuTimers[t.id];n||(n=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:r.createQueryEXT()}),n.calls++,r.beginQueryEXT(r.TIME_ELAPSED_EXT,n.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,r=t.createQueryEXT();this.deferredRenderGpuTimeQueries.push(r),t.beginQueryEXT(t.TIME_ELAPSED_EXT,r)}}gpuTimingDeferredRenderEnd(){if(!this.options.gpuTimingDeferredRender)return;const t=this.context.extTimerQuery;t.endQueryEXT(t.TIME_ELAPSED_EXT)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery;t.endQueryEXT(t.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const r={};for(const n in t){const i=t[n],s=this.context.extTimerQuery,a=s.getQueryObjectEXT(i.query,s.QUERY_RESULT_EXT)/1e6;s.deleteQueryEXT(i.query),r[n]=a}return r}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const r=this.context.extTimerQuery;let n=0;for(const i of t)n+=r.getQueryObjectEXT(i,r.QUERY_RESULT_EXT)/1e6,r.deleteQueryEXT(i);return n}translatePosMatrix(t,r,n,i,s){if(!n[0]&&!n[1])return t;const a=s?i==="map"?this.transform.angle:0:i==="viewport"?-this.transform.angle:0;if(a){const f=Math.sin(a),m=Math.cos(a);n=[n[0]*m-n[1]*f,n[0]*f+n[1]*m]}const l=[s?n[0]:Zl(r,n[0],this.transform.zoom),s?n[1]:Zl(r,n[1],this.transform.zoom),0],p=new Float32Array(16);return Q.translate(p,t,l),p}saveTileTexture(t){const r=this._tileTextures[t.size[0]];r?r.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const r=this._tileTextures[t];return r&&r.length>0?r.pop():null}isPatternMissing(t,r){return t===null||t!==void 0&&!this.imageManager.getPattern(t.toString(),r)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}currentGlobalDefines(t){const r=this.terrain&&this.terrain.renderingToTexture,n=this.terrain&&this.terrain.exaggeration()===0,i=this.style&&this.style.fog,s=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?this.style.map._optimizeForTerrain&&(s.push("LIGHTING_3D_MODE"),s.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):r&&this.style.map._optimizeForTerrain||s.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"?this._shadowMapDebug||s.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?s.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):s.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&s.push("TERRAIN"),this.transform.projection.name==="globe"&&s.push("GLOBE"),n&&s.push("ZERO_EXAGGERATION"),i&&!r&&i.getOpacity(this.transform.pitch)!==0&&s.push("FOG","FOG_DITHERING"),r&&s.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&s.push("OVERDRAW_INSPECTOR"),s}useProgram(t,r,n){this.cache=this.cache||{};const i=n||[],s=this.currentGlobalDefines(t).concat(i),a=_2.cacheKey(a2[t],t,s,r);return this.cache[a]||(this.cache[a]=new _2(this.context,t,a2[t],r,ED[t],s)),this.cache[a]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=S.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new dn(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,r){if(this.style.enable3dLights()){const n=this.style.directionalLight,i=this.style.ambientLight;if(n&&i){const s=((a,l)=>{const p=a.properties.get("direction"),f=a.properties.get("color").toArray01(),m=a.properties.get("intensity"),_=l.properties.get("color").toArray01(),y=l.properties.get("intensity"),v=[p.x,p.y,p.z],b=Qr(_,y),w=Qr(f,m);return{u_lighting_ambient_color:b,u_lighting_directional_dir:v,u_lighting_directional_color:w,u_ground_radiance:tD(v,w,b)}})(n,i);r.setLightsUniformValues(t,s)}}}uploadCommonUniforms(t,r,n,i){if(this.uploadCommonLightUniforms(t,r),this.terrain&&this.terrain.renderingToTexture)return;const s=this.style.fog;if(s){const a=s.getOpacity(this.transform.pitch),l=((p,f,m,_,y,v,b,w,E,T,C,M)=>{const A=p.transform,P=f.properties.get("color").toArray01();P[3]=_;const L=p.frameCounter/1e3%1;return{u_fog_matrix:m?A.calculateFogTileMatrix(m):M||p.identityMat,u_fog_range:f.getFovAdjustedRange(A._fov),u_fog_color:P,u_fog_horizon_blend:f.properties.get("horizon-blend"),u_fog_temporal_offset:L,u_frustum_tl:y,u_frustum_tr:v,u_frustum_br:b,u_frustum_bl:w,u_globe_pos:E,u_globe_radius:T,u_viewport:C,u_globe_transition:Zn(A.zoom),u_is_globe:+(A.projection.name==="globe")}})(this,s,n,a,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*ge.devicePixelRatio,this.transform.height*ge.devicePixelRatio],i);r.setFogUniformValues(t,l)}}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),r}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,r=this._backgroundTiles={},n=this.transform.coveringTiles({tileSize:512});for(const i of n)r[i.key]=t[i.key]||new Dh(i,512,this.transform.tileZoom,this);return r}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(t,r){return!(!t.is3D()||t.minzoom&&t.minzoom>this.transform.zoom||t.sourceLayer!=="building"&&(!r||r.type!=="batched-model"))}}class WD extends hn{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.loaded={}}async loadModel(t,r){const n=cy(await DE(r)),i=new Fw(t,r,void 0,void 0,n);return i.computeBoundsAndApplyParent(),i}async load(t,r){this.models[r]||(this.models[r]={}),this.loaded[r]=!1;for(const n in t){const i=t[n],s=await this.loadModel(n,i);this.models[r][n]=s}this.loaded[r]=!0,this.fire(new wt("data",{dataType:"style"}))}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}hasModel(t,r){return!!this.getModel(t,r)}getModel(t,r){return this.models[r]||(this.models[r]={}),this.models[r][t]}async addModel(t,r,n){this.models[n]||(this.models[n]={}),this.hasModel(t,n)&&this.removeModel(t,n),this.load({[t]:this.requestManager.normalizeModelURL(r)},n)}addModels(t,r){const n={};for(const i in t)n[i]=this.requestManager.normalizeModelURL(t[i]);this.load(n,r)}removeModel(t,r){this.models[r]||(this.models[r]={});const n=this.models[r][t];delete this.models[r][t],n.destroy()}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,r){this.models[r]||(this.models[r]={});for(const n in this.models[r])this.models[r][n].upload(t.context)}}const Wh=(e,t)=>ef(e,t&&t.filter(r=>r.identifier!=="source.canvas")),HD=Zi(_r,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera"]),YD=Zi(_r,["setCenter","setZoom","setBearing","setPitch"]),j2={version:8,layers:[],sources:{}},$D={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class gs extends hn{constructor(t,r={}){super(),this.map=t,this.imports=[],this.scope=r.scope||"",this.importDepth=r.importDepth||0,this.importsCache=r.importsCache||new Map,this.resolvedImports=r.resolvedImports||new Set,this.parentCamera=r.camera,this._ownOrder=[],this._ownLayers={},this._ownSourceCaches={},this.dispatcher=r.dispatcher?r.dispatcher:new Xl(jh(),this),r.imageManager?this.imageManager=r.imageManager:(this.imageManager=new KP,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=r.glyphManager?r.glyphManager:new Qu(t._requestManager,r.localFontFamily?2:r.localIdeographFontFamily?1:0,r.localFontFamily||r.localIdeographFontFamily),r.modelManager?this.modelManager=r.modelManager:(this.modelManager=new WD(t._requestManager),this.modelManager.setEventedParent(this)),this.crossTileSymbolIndex=new jL,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this.options=r.config||new Map,this._configDependentLayers=new Set,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",Mt());const n=this;this._rtlTextPluginCallback=gs.registerForPluginStateChange(i=>{n.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:i.pluginStatus,pluginURL:i.pluginURL},(s,a)=>{if(tx(s),a&&a.every(l=>l))for(const l in n._sourceCaches){const p=n._sourceCaches[l],f=p.getSource().type;f!=="vector"&&f!=="geojson"||p.reload()}})}),this.on("data",i=>{if(i.dataType!=="source"||i.sourceDataType!=="metadata")return;const s=this.getSource(i.sourceId);if(s&&s.vectorLayerIds)for(const a in this._layers){const l=this._layers[a];l.source===s.id&&this._validateLayer(l)}})}loadURL(t,r={}){this.fire(new wt("dataloading",{dataType:"style"}));const n=typeof r.validate=="boolean"?r.validate:!br(t);t=this.map._requestManager.normalizeStyleURL(t,r.accessToken),this.resolvedImports.add(t);const i=this.importsCache.get(t);if(i)return this._load(i,n);const s=this.map._requestManager.transformRequest(t,ct.Style);this._request=Lt(s,(a,l)=>{if(this._request=null,a)this.fire(new fe(a));else if(l)return this.importsCache.set(t,l),this._load(l,n)})}loadJSON(t,r={}){this.fire(new wt("dataloading",{dataType:"style"})),this._request=ge.frame(()=>{this._request=null,this._load(t,r.validate!==!1)})}loadEmpty(){this.fire(new wt("dataloading",{dataType:"style"})),this._load(j2,!1)}_updateLayerCount(t,r){const n=r?1:-1;t.is3D()&&(this._num3DLayers+=n),t.type==="circle"&&(this._numCircleLayers+=n),t.type==="symbol"&&(this._numSymbolLayers+=n)}_loadImports(t,r){const n=()=>{this._mergeLayers(),this._mergeSources();for(const{style:s,id:a}of this.imports){for(const[l,p]of s.options.entries())this.options.set(cc(l,a),p);s.stylesheet.camera!=null&&(this.stylesheet.camera=s.stylesheet.camera),s.stylesheet.projection!=null&&(this.stylesheet.projection=s.stylesheet.projection),s.stylesheet.light!=null&&(this.light=s.light),s.ambientLight!=null&&(this.ambientLight=s.ambientLight),s.directionalLight!=null&&(this.directionalLight=s.directionalLight),s.terrain!=null&&(this.terrain=s.terrain),s.fog!=null&&(this.fog=s.fog)}this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._ownOrder),scope:this.scope,options:this.options}),this.fire(new wt("data",{dataType:"style"})),this.fire(new wt("style.load"))};if(this.importDepth>=4)return Y("Style doesn't support nesting deeper than 5"),n();const i=[];for(const s of t){const a=this.scope?cc(s.id,this.scope):s.id,l=new Map,p=s.config;if(p)for(const y of Object.keys(p)){const v=Fa(p[y]);v.result==="success"&&l.set(y,v.value.expression)}const f=new gs(this.map,{scope:a,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,camera:this.stylesheet.camera,config:l});f.setEventedParent(this.map,{style:f});const m=new Promise(y=>f.on("style.load",y));if(i.push(m),this.resolvedImports.has(s.url)){f.loadEmpty();continue}const _=s.data||this.importsCache.get(s.url);_?f.loadJSON(_,{validate:r}):s.url?f.loadURL(s.url,{validate:r}):f.loadEmpty(),this.imports.push({id:s.id,style:f,config:s.config})}Promise.all(i).then(n)}_load(t,r){const n=t.schema;if(this.importDepth===0&&(t.fragment||n)){const l=Yt({},j2,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(l,r)}if(n)for(const l of Object.keys(n)){if(this.options.has(l))continue;const p=Fa(n[l].default);p.result==="success"&&this.options.set(l,p.value.expression)}if(r&&Wh(this,Lu(t)))return;this._loaded=!0,this.stylesheet=j(t),this._updateMapProjection();for(const l in t.sources){const p=cc(l,this.scope);this.addSource(p,t.sources[l],{validate:!1})}this._changed=!1,t.sprite?this._loadSprite(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(t.glyphs,this.scope);const i=NE(this.stylesheet.layers);this._ownOrder=i.map(l=>cc(l.id,this.scope)),this._ownLayers={},this._serializedLayers={};for(const l of i){const p=dd(l,this.options);p.id=cc(p.id,this.scope),p.scope=this.scope,p.isConfigDependent&&this._configDependentLayers.add(p.id),p.source&&(p.source=cc(p.source,this.scope)),p.setEventedParent(this,{layer:{id:p.id}}),this._layers[p.id]=p,this._ownLayers[p.id]=p,this._serializedLayers[p.id]=p.serialize(),this._updateLayerCount(p,!0)}if(this.stylesheet.light&&console.log("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const l=this.stylesheet.lights[0];this.light=new dE(l.properties,l.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new dE(this.stylesheet.light)),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const s=this.stylesheet.terrain;s&&!this.terrainSetForDrapingOnly()&&this._createTerrain(s,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog);const a=this.stylesheet.camera=this.stylesheet.camera||this.parentCamera||{"camera-projection":"perspective"};this.map.setCamera(a),this._mergeLayers(),this._mergeSources(),this.fire(new wt("data",{dataType:"style"})),t.imports?this._loadImports(t.imports,r):(this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._ownOrder),scope:this.scope,options:this.options}),this.fire(new wt("style.load")))}_mergeSources(){const t={},r={},n={};(function i(s){for(const a of s.imports)i(a.style);for(const a in s._sourceCaches)t[a]=s._sourceCaches[a];for(const a in s._otherSourceCaches)r[a]=s._otherSourceCaches[a];for(const a in s._symbolSourceCaches)n[a]=s._symbolSourceCaches[a]})(this),this._sourceCaches=t,this._otherSourceCaches=r,this._symbolSourceCaches=n}_mergeLayers(){const t={},r=[],n={};(function s(a){for(const l of a.imports)s(l.style);for(const l of a._ownOrder){const p=a._ownLayers[l];if(p.type==="slot"){const f=WE(l);if(t[f])continue;t[f]=[]}p.slot&&t[p.slot]?t[p.slot].push(p):r.push(p)}})(this),this._order=[];const i=(s=[])=>{for(const a of s)if(a.type==="slot"){const l=WE(a.id);t[l]&&i(t[l])}else this._order.push(a.id),n[a.id]=a};i(r),this._layers=n,this._updateDrapeFirstLayers()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.stylesheet.projection)}_loadSprite(t){this._spriteRequest=function(r,n,i){let s,a,l;const p=ge.devicePixelRatio>1?"@2x":"";let f=Lt(n.transformRequest(n.normalizeSpriteURL(r,p,".json"),ct.SpriteJSON),(y,v)=>{f=null,l||(l=y,s=v,_())}),m=Ke(n.transformRequest(n.normalizeSpriteURL(r,p,".png"),ct.SpriteImage),(y,v)=>{m=null,l||(l=y,a=v,_())});function _(){if(l)i(l);else if(s&&a){const y=ge.getImageData(a),v={};for(const b in s){const{width:w,height:E,x:T,y:C,sdf:M,pixelRatio:A,stretchX:P,stretchY:L,content:R}=s[b],N=new Yr({width:w,height:E});Yr.copy(y,N,{x:T,y:C},{x:0,y:0},{width:w,height:E}),v[b]={data:N,pixelRatio:A,sdf:M,stretchX:P,stretchY:L,content:R}}i(null,v)}}return{cancel(){f&&(f.cancel(),f=null),m&&(m.cancel(),m=null)}}}(t,this.map._requestManager,(r,n)=>{if(this._spriteRequest=null,r)this.fire(new fe(r));else if(n)for(const i in n)this.imageManager.addImage(i,this.scope,n[i]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new wt("data",{dataType:"style"}))})}_validateLayer(t){const r=this.getSource(t.source);if(!r)return;const n=t.sourceLayer;n&&(r.type==="geojson"||r.vectorLayerIds&&r.vectorLayerIds.indexOf(n)===-1)&&this.fire(new fe(new Error(`Source layer "${n}" does not exist on source "${r.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.stylesheet.models&&!this.modelManager.isLoaded())return!1;for(const{style:t}of this.imports)if(!t.loaded())return!1;return!0}_serializeLayers(t){const r=[];for(const n of t){const i=this._layers[n];i&&i.type!=="custom"&&r.push(i.serialize())}return r}hasTransitions(){if(this.light&&this.light.hasTransition()||this.fog&&this.fog.hasTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(t){return!!this.terrain&&(typeof t.isLayerDraped=="function"?t.isLayerDraped():$D[t.type])}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(t){if(!this._loaded)return;t.brightness!==this._brightness&&(this._brightness=t.brightness,this.dispatcher.broadcast("setBrightness",t.brightness));const r=this._changed;if(this._changed){const i=Object.keys(this._updatedLayers),s=Object.keys(this._removedLayers);if(i.length||s.length){const a={};for(const l of i){const p=HE(l);(a[p]=a[p]||{updatedIds:[],removedIds:[]}).updatedIds.push(l)}for(const l of s){const p=HE(l);(a[p]=a[p]||{updatedIds:[],removedIds:[]}).removedIds.push(l)}for(const[l,{updatedIds:p,removedIds:f}]of Object.entries(a))this.getFragmentById(l)._updateWorkerLayers(p,f)}for(const a in this._updatedSources){const l=this._updatedSources[a];l==="reload"?this._reloadSource(a):l==="clear"&&this._clearSource(a)}this._updateTilesForChangedImages();for(const a in this._updatedPaintProps)this._layers[a].updateTransitions(t);this.light.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this._resetUpdates()}const n={};for(const i in this._sourceCaches){const s=this._sourceCaches[i];n[i]=s.used,s.used=!1}for(const i of this._order){const s=this._layers[i];if(s.recalculate(t,this._availableImages),!s.isHidden(t.zoom)){const l=this._getLayerSourceCache(s);l&&(l.used=!0)}const a=this.map.painter;if(a){const l=s.getProgramIds();if(!l)continue;const p=s.getProgramConfiguration(t.zoom);for(const f of l)a.useProgram(f,p)}}for(const i in n){const s=this._sourceCaches[i];n[i]!==s.used&&s.getSource().fire(new wt("data",{sourceDataType:"visibility",dataType:"source",sourceId:s.getSource().id}))}this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),r&&this.fire(new wt("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const r in this._sourceCaches)this._sourceCaches[r].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateWorkerLayers(t,r){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(t),scope:this.scope,removedIds:r,options:this.options})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(t){if(this._checkLoaded(),Wh(this,Lu(t)))return!1;(t=j(t)).layers=NE(t.layers);const r=function(i,s){if(!i)return[{command:_r.setStyle,args:[s]}];let a=[];try{if(!ue(i.version,s.version))return[{command:_r.setStyle,args:[s]}];ue(i.center,s.center)||a.push({command:_r.setCenter,args:[s.center]}),ue(i.zoom,s.zoom)||a.push({command:_r.setZoom,args:[s.zoom]}),ue(i.bearing,s.bearing)||a.push({command:_r.setBearing,args:[s.bearing]}),ue(i.pitch,s.pitch)||a.push({command:_r.setPitch,args:[s.pitch]}),ue(i.sprite,s.sprite)||a.push({command:_r.setSprite,args:[s.sprite]}),ue(i.glyphs,s.glyphs)||a.push({command:_r.setGlyphs,args:[s.glyphs]}),ue(i.transition,s.transition)||a.push({command:_r.setTransition,args:[s.transition]}),ue(i.light,s.light)||a.push({command:_r.setLight,args:[s.light]}),ue(i.fog,s.fog)||a.push({command:_r.setFog,args:[s.fog]}),ue(i.projection,s.projection)||a.push({command:_r.setProjection,args:[s.projection]}),ue(i.lights,s.lights)||a.push({command:_r.setLights,args:[s.lights]}),ue(i.camera,s.camera)||a.push({command:_r.setCamera,args:[s.camera]});const l={},p=[];(function(_,y,v,b){let w;for(w in y=y||{},_=_||{})_.hasOwnProperty(w)&&(y.hasOwnProperty(w)||kE(w,v,b));for(w in y){if(!y.hasOwnProperty(w))continue;const E=y[w];_.hasOwnProperty(w)?ue(_[w],E)||(_[w].type==="geojson"&&E.type==="geojson"&&EL(_,y,w)?v.push({command:_r.setGeoJSONSourceData,args:[w,E.data]}):wL(w,y,v,b)):zE(w,y,v)}})(i.sources,s.sources,p,l);const f=[];i.layers&&i.layers.forEach(_=>{_.source&&l[_.source]?a.push({command:_r.removeLayer,args:[_.id]}):f.push(_)});let m=i.terrain;m&&l[m.source]&&(a.push({command:_r.setTerrain,args:[void 0]}),m=void 0),a=a.concat(p),ue(m,s.terrain)||a.push({command:_r.setTerrain,args:[s.terrain]}),function(_,y,v){y=y||[];const b=(_=_||[]).map(FE),w=y.map(FE),E=_.reduce(BE,{}),T=y.reduce(BE,{}),C=b.slice(),M=Object.create(null);let A,P,L,R,N,k,F;for(A=0,P=0;A<b.length;A++)L=b[A],T.hasOwnProperty(L)?P++:(v.push({command:_r.removeLayer,args:[L]}),C.splice(C.indexOf(L,P),1));for(A=0,P=0;A<w.length;A++)L=w[w.length-1-A],C[C.length-1-A]!==L&&(E.hasOwnProperty(L)?(v.push({command:_r.removeLayer,args:[L]}),C.splice(C.lastIndexOf(L,C.length-P),1)):P++,k=C[C.length-A],v.push({command:_r.addLayer,args:[T[L],k]}),C.splice(C.length-A,0,L),M[L]=!0);for(A=0;A<w.length;A++)if(L=w[A],R=E[L],N=T[L],!M[L]&&!ue(R,N))if(ue(R.source,N.source)&&ue(R["source-layer"],N["source-layer"])&&ue(R.type,N.type)){for(F in gd(R.layout,N.layout,v,L,null,_r.setLayoutProperty),gd(R.paint,N.paint,v,L,null,_r.setPaintProperty),ue(R.filter,N.filter)||v.push({command:_r.setFilter,args:[L,N.filter]}),ue(R.minzoom,N.minzoom)&&ue(R.maxzoom,N.maxzoom)||v.push({command:_r.setLayerZoomRange,args:[L,N.minzoom,N.maxzoom]}),R)R.hasOwnProperty(F)&&F!=="layout"&&F!=="paint"&&F!=="filter"&&F!=="metadata"&&F!=="minzoom"&&F!=="maxzoom"&&(F.indexOf("paint.")===0?gd(R[F],N[F],v,L,F.slice(6),_r.setPaintProperty):ue(R[F],N[F])||v.push({command:_r.setLayerProperty,args:[L,F,N[F]]}));for(F in N)N.hasOwnProperty(F)&&!R.hasOwnProperty(F)&&F!=="layout"&&F!=="paint"&&F!=="filter"&&F!=="metadata"&&F!=="minzoom"&&F!=="maxzoom"&&(F.indexOf("paint.")===0?gd(R[F],N[F],v,L,F.slice(6),_r.setPaintProperty):ue(R[F],N[F])||v.push({command:_r.setLayerProperty,args:[L,F,N[F]]}))}else v.push({command:_r.removeLayer,args:[L]}),k=C[C.lastIndexOf(L)+1],v.push({command:_r.addLayer,args:[N,k]})}(f,s.layers,a)}catch(l){console.warn("Unable to compute style diff:",l),a=[{command:_r.setStyle,args:[s]}]}return a}(this.serialize(),t).filter(i=>!(i.command in YD));if(r.length===0)return!1;const n=r.filter(i=>!(i.command in HD));if(n.length>0)throw new Error(`Unimplemented: ${n.map(i=>i.command).join(", ")}.`);return r.forEach(i=>{i.command!=="setTransition"&&i.command!=="setProjection"&&this[i.command].apply(this,i.args)}),this.stylesheet=t,this._updateMapProjection(),!0}addImage(t,r){return this.getImage(t)?this.fire(new fe(new Error("An image with this name already exists."))):(this.imageManager.addImage(t,this.scope,r),this._afterImageUpdated(t),this)}updateImage(t,r){this.imageManager.updateImage(t,this.scope,r)}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._afterImageUpdated(t),this):this.fire(new fe(new Error("No image with this name exists.")))}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(this.scope),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new wt("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(t,r,n={}){return this._checkLoaded(),this._validate(BS,`models.${t}`,r,null,n)||(this.modelManager.addModel(t,r,this.scope),this._changed=!0),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this):this.fire(new fe(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,r,n={}){if(this._checkLoaded(),this.getSource(t)!==void 0)throw new Error("There is already a source with this ID");if(!r.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(r).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(r.type)>=0&&this._validate(LS,`sources.${t}`,r,null,n))return;this.map&&this.map._collectResourceTiming&&(r.collectResourceTiming=!0);const i=my(t,r,this.dispatcher,this);i.scope=this.scope,i.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(t),source:i.serialize(),sourceId:t}));const s=a=>{const l=(a?"symbol:":"other:")+t,p=this._ownSourceCaches[t]=this._sourceCaches[l]=new ds(l,i,a);(a?this._symbolSourceCaches:this._otherSourceCaches)[t]=p,p.style=this,p.onAdd(this.map)};s(!1),r.type!=="vector"&&r.type!=="geojson"||s(!0),i.onAdd&&i.onAdd(this.map),this._changed=!0}removeSource(t){this._checkLoaded();const r=this.getSource(t);if(!r)throw new Error("There is no source with this ID");for(const i in this._layers)if(this._layers[i].source===t)return this.fire(new fe(new Error(`Source "${t}" cannot be removed while layer "${i}" is using it.`)));if(this.terrain&&this.terrain.get().source===t)return this.fire(new fe(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const n=this._getSourceCaches(t);for(const i of n)delete this._sourceCaches[i.id],delete this._updatedSources[i.id],i.fire(new wt("data",{sourceDataType:"metadata",dataType:"source",sourceId:i.getSource().id})),i.setEventedParent(null),i.clearTiles();return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],r.setEventedParent(null),r.onRemove&&r.onRemove(this.map),this._changed=!0,this}setGeoJSONSourceData(t,r){this._checkLoaded(),this.getSource(t).setData(r),this._changed=!0}getSource(t){const r=this._getSourceCache(t);return r&&r.getSource()}getOwnSource(t){const r=this._getOwnSourceCache(t);return r&&r.getSource()}_getSources(){const t=[];for(const r in this._otherSourceCaches){const n=this._getSourceCache(r);n&&t.push(n.getSource())}return t}setLights(t){if(this._checkLoaded(),delete this.ambientLight,delete this.directionalLight,t){for(const n of t){if(this._validate(RS,"lights",n))return;const i=this._getTransitionParameters({duration:0});switch(n.type){case"ambient":this.ambientLight=new yE(n,oL,this.options),this.ambientLight.updateTransitions(i);break;case"directional":this.directionalLight=new yE(n,sL,this.options),this.directionalLight.updateTransitions(i)}}const r=new jr(this.z||0,{now:ge.now(),transition:this.getTransition()});this.ambientLight&&this.ambientLight.recalculate(r),this.directionalLight&&this.directionalLight.recalculate(r),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}}calculateLightsBrightness(){const t=this.directionalLight,r=this.ambientLight;if(!t||!r)return;const n=_=>.2126*(_[0]<=.03928?_[0]/12.92:Math.pow((_[0]+.055)/1.055,2.4))+.7152*(_[1]<=.03928?_[1]/12.92:Math.pow((_[1]+.055)/1.055,2.4))+.0722*(_[2]<=.03928?_[2]/12.92:Math.pow((_[2]+.055)/1.055,2.4)),i=t.properties.get("color").toArray01(),s=t.properties.get("intensity"),a=t.properties.get("direction"),l=1-$t(a.x,a.y,a.z)[2]/90,p=n(i)*s*l,f=r.properties.get("color").toArray01(),m=r.properties.get("intensity");return(p+n(f)*m)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentById(t){if(!t)return this;const r=this.imports.find(({id:n})=>n===t);if(!r)throw new Error(`Style import not found: ${t}`);return r.style}setConfigProperty(t,r,n){const i=Fa(n);if(i.result==="success"){const s=i.value.expression,a=this.getFragmentById(t);a.options.set(r,s);for(const l of a._configDependentLayers){const p=this.getLayer(l);p&&this._updateLayer(p)}this._changed=!0}else Wh(this,i.value)}addLayer(t,r,n={}){this._checkLoaded();const i=t.id;if(this._ownLayers[i])return void this.fire(new fe(new Error(`Layer with id "${i}" already exists on this map`)));let s;if(t.type==="custom"){if(Wh(this,function(p){const f=[],m=p.id;return m===void 0&&f.push({message:`layers.${m}: missing required property "id"`}),p.render===void 0&&f.push({message:`layers.${m}: missing required method "render"`}),p.renderingMode&&p.renderingMode!=="2d"&&p.renderingMode!=="3d"&&f.push({message:`layers.${m}: property "renderingMode" must be either "2d" or "3d"`}),f}(t)))return;s=dd(t,this.options)}else{if(typeof t.source=="object"&&(this.addSource(i,t.source),t=Yt(t=j(t),{source:i})),this._validate(zS,`layers.${i}`,t,{arrayIndex:-1},n))return;s=dd(t,this.options),this._validateLayer(s),s.setEventedParent(this,{layer:{id:i}}),this._serializedLayers[s.id]=s.serialize(),this._updateLayerCount(s,!0)}s.isConfigDependent&&this._configDependentLayers.add(s.id);const a=r?this._ownOrder.indexOf(r):this._ownOrder.length;if(r&&a===-1)return void this.fire(new fe(new Error(`Layer with id "${r}" does not exist on this map.`)));this._ownOrder.splice(a,0,i),this._layerOrderChanged=!0,this._ownLayers[i]=s;const l=this._getLayerSourceCache(s);if(this._removedLayers[i]&&s.source&&l&&s.type!=="custom"){const p=this._removedLayers[i];delete this._removedLayers[i],p.type!==s.type?this._updatedSources[s.source]="clear":(this._updatedSources[s.source]="reload",l.pause())}this._updateLayer(s),s.onAdd&&s.onAdd(this.map),this._mergeLayers()}moveLayer(t,r){if(this._checkLoaded(),this._changed=!0,!this._ownLayers[t])return void this.fire(new fe(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===r)return;const n=this._ownOrder.indexOf(t);this._ownOrder.splice(n,1);const i=r?this._ownOrder.indexOf(r):this._ownOrder.length;r&&i===-1?this.fire(new fe(new Error(`Layer with id "${r}" does not exist on this map.`))):(this._ownOrder.splice(i,0,t),this._layerOrderChanged=!0,this._mergeLayers())}removeLayer(t){this._checkLoaded();const r=this._ownLayers[t];if(!r)return void this.fire(new fe(new Error(`The layer '${t}' does not exist in the map's style and cannot be removed.`)));r.setEventedParent(null),this._updateLayerCount(r,!1);const n=this._ownOrder.indexOf(t);this._ownOrder.splice(n,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=r,delete this._ownLayers[t],delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],this._configDependentLayers.delete(t),r.onRemove&&r.onRemove(this.map),this._mergeLayers()}getLayer(t){return this._layers[t]}getOwnLayer(t){return this._ownLayers[t]}hasLayer(t){return t in this._layers}hasLayerType(t){for(const r in this._layers)if(this._layers[r].type===t)return!0;return!1}setLayerZoomRange(t,r,n){this._checkLoaded();const i=this.getLayer(t);i?i.minzoom===r&&i.maxzoom===n||(r!=null&&(i.minzoom=r),n!=null&&(i.maxzoom=n),this._updateLayer(i)):this.fire(new fe(new Error(`The layer '${t}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(t,r,n={}){this._checkLoaded();const i=this.getLayer(t);if(i){if(!ue(i.filter,r))return r==null?(i.filter=void 0,void this._updateLayer(i)):void(this._validate(_g,`layers.${i.id}.filter`,r,{layerType:i.type},n)||(i.filter=j(r),this._updateLayer(i)))}else this.fire(new fe(new Error(`The layer '${t}' does not exist in the map's style and cannot be filtered.`)))}getFilter(t){const r=this.getLayer(t);return r&&j(r.filter)}setLayoutProperty(t,r,n,i={}){this._checkLoaded();const s=this.getLayer(t);s?ue(s.getLayoutProperty(r),n)||(s.setLayoutProperty(r,n,i),s.isConfigDependent&&this._configDependentLayers.add(s.id),this._updateLayer(s)):this.fire(new fe(new Error(`The layer '${t}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(t,r){const n=this.getLayer(t);if(n)return n.getLayoutProperty(r);this.fire(new fe(new Error(`The layer '${t}' does not exist in the map's style.`)))}setPaintProperty(t,r,n,i={}){this._checkLoaded();const s=this.getLayer(t);if(!s)return void this.fire(new fe(new Error(`The layer '${t}' does not exist in the map's style and cannot be styled.`)));if(ue(s.getPaintProperty(r),n))return;const a=s.setPaintProperty(r,n,i);s.isConfigDependent&&this._configDependentLayers.add(s.id),a&&this._updateLayer(s),this._changed=!0,this._updatedPaintProps[t]=!0}getPaintProperty(t,r){const n=this.getLayer(t);return n&&n.getPaintProperty(r)}setFeatureState(t,r){this._checkLoaded();const n=t.source,i=t.sourceLayer,s=this.getSource(n);if(!s)return void this.fire(new fe(new Error(`The source '${n}' does not exist in the map's style.`)));const a=s.type;if(a==="geojson"&&i)return void this.fire(new fe(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(a==="vector"&&!i)return void this.fire(new fe(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new fe(new Error("The feature id parameter must be provided.")));const l=this._getSourceCaches(n);for(const p of l)p.setFeatureState(i,t.id,r)}removeFeatureState(t,r){this._checkLoaded();const n=t.source,i=this.getSource(n);if(!i)return void this.fire(new fe(new Error(`The source '${n}' does not exist in the map's style.`)));const s=i.type,a=s==="vector"?t.sourceLayer:void 0;if(s==="vector"&&!a)return void this.fire(new fe(new Error("The sourceLayer parameter must be provided for vector source types.")));if(r&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new fe(new Error("A feature id is required to remove its specific state property.")));const l=this._getSourceCaches(n);for(const p of l)p.removeFeatureState(a,t.id,r)}getFeatureState(t){this._checkLoaded();const r=t.source,n=t.sourceLayer,i=this.getSource(r);if(i){if(i.type!=="vector"||n)return t.id===void 0&&this.fire(new fe(new Error("The feature id parameter must be provided."))),this._getSourceCaches(r)[0].getFeatureState(n,t.id);this.fire(new fe(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new fe(new Error(`The source '${r}' does not exist in the map's style.`)))}getTransition(){return Yt({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){this._checkLoaded();const t={};for(const r in this._sourceCaches){const n=this._sourceCaches[r].getSource();t[n.id]||(t[n.id]=n.serialize())}return St({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this.stylesheet.imports,light:this.stylesheet.light,terrain:this.getTerrain()||void 0,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:t,layers:this._serializeLayers(this._ownOrder)},r=>r!==void 0)}_updateLayer(t){this._updatedLayers[t.id]=!0;const r=this._getLayerSourceCache(t);t.source&&!this._updatedSources[t.source]&&r&&r.getSource().type!=="raster"&&(this._updatedSources[t.source]="reload",r.pause()),this._changed=!0,t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const r=a=>this._layers[a].type==="fill-extrusion",n={},i=[];for(let a=this._order.length-1;a>=0;a--){const l=this._order[a];if(r(l)){n[l]=a;for(const p of t){const f=p[l];if(f)for(const m of f)i.push(m)}}}i.sort((a,l)=>l.intersectionZ-a.intersectionZ);const s=[];for(let a=this._order.length-1;a>=0;a--){const l=this._order[a];if(r(l))for(let p=i.length-1;p>=0;p--){const f=i[p].feature;if(n[f.layer.id]<a)break;s.push(f),i.pop()}else for(const p of t){const f=p[l];if(f)for(const m of f)s.push(m.feature)}}return s}queryRenderedFeatures(t,r,n){r&&r.filter&&this._validate(_g,"queryRenderedFeatures.filter",r.filter,null,r);const i={};if(r&&r.layers){if(!Array.isArray(r.layers))return this.fire(new fe(new Error("parameters.layers must be an Array."))),[];for(const p of r.layers){const f=this._layers[p];if(!f)return this.fire(new fe(new Error(`The layer '${p}' does not exist in the map's style and cannot be queried for features.`))),[];i[f.source]=!0}}const s=[];r.availableImages=this._availableImages;const a=r&&r.layers?r.layers.some(p=>{const f=this.getLayer(p);return f&&f.is3D()}):this.has3DLayers(),l=oy.createFromScreenPoints(t,n);for(const p in this._sourceCaches){const f=this._sourceCaches[p].getSource().id;r.layers&&!i[f]||s.push(vL(this._sourceCaches[p],this._layers,this._serializedLayers,l,r,n,a,!!this.map._showQueryGeometry))}return this.placement&&s.push(function(p,f,m,_,y,v,b){const w={},E=v.queryRenderedSymbols(_),T=[];for(const C of Object.keys(E).map(Number))T.push(b[C]);T.sort(RE);for(const C of T){const M=C.featureIndex.lookupSymbolFeatures(E[C.bucketInstanceId],f,C.bucketIndex,C.sourceLayerIndex,y.filter,y.layers,y.availableImages,p);for(const A in M){const P=w[A]=w[A]||[],L=M[A];L.sort((R,N)=>{const k=C.featureSortOrder;if(k){const F=k.indexOf(R.featureIndex);return k.indexOf(N.featureIndex)-F}return N.featureIndex-R.featureIndex});for(const R of L)P.push(R)}}for(const C in w)w[C].forEach(M=>{const A=M.feature,P=m(p[C]);if(!P)return;const L=P.getFeatureState(A.layer["source-layer"],A.id);A.source=A.layer.source,A.layer["source-layer"]&&(A.sourceLayer=A.layer["source-layer"]),A.state=L});return w}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),l.screenGeometry,r,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(s)}querySourceFeatures(t,r){r&&r.filter&&this._validate(_g,"querySourceFeatures.filter",r.filter,null,r);const n=this._getSourceCaches(t);let i=[];for(const s of n)i=i.concat(xL(s,r));return i}addSourceType(t,r,n){return gs.getSourceType(t)?n(new Error(`A source type called "${t}" already exists.`)):(gs.setSourceType(t,r),r.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:r.workerSourceURL},n):n(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,r,n={}){this._checkLoaded();const i=this.light.getLight();let s=!1;for(const l in t)if(!ue(t[l],i[l])){s=!0;break}if(!s)return;const a=this._getTransitionParameters({duration:300,delay:0});this.light.setLight(t,r,n),this.light.updateTransitions(a)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(t,r=1){if(this._checkLoaded(),!t)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let n=t;if(r===1){if(typeof n.source=="object"){const i="terrain-dem-src";this.addSource(i,n.source),n=j(n),n=Yt(n,{source:i})}if(this._validate(OS,"terrain",n))return}if(!this.terrain||this.terrain&&r!==this.terrain.drapeRenderMode){if(!n)return;this._createTerrain(n,r)}else{const i=this.terrain,s=i.get();for(const a of Object.keys(rt.terrain))!n.hasOwnProperty(a)&&rt.terrain[a].default&&(n[a]=rt.terrain[a].default);for(const a in t)if(!ue(t[a],s[a])){i.set(t),this.stylesheet.terrain=t;const l=this._getTransitionParameters({duration:0});i.updateTransitions(l);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const r=this.fog=new rL(t,this.map.transform);this.stylesheet.fog=t;const n=this._getTransitionParameters({duration:0});r.updateTransitions(n)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const r=this.fog,n=r.get();Object.keys(t).length===0&&r.set(t);for(const i in t)if(!ue(t[i],n[i])){r.set(t),this.stylesheet.fog=t;const s=this._getTransitionParameters({duration:0});r.updateTransitions(s);break}}else this._createFog(t);this._markersNeedUpdate=!0}_getTransitionParameters(t){return{now:ge.now(),transition:Yt(t,this.stylesheet.transition)}}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const t=[],r=[];for(const n in this._layers){const i=this._layers[n];this.isLayerDraped(i)?t.push(i.id):r.push(i.id)}this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...r)}_createTerrain(t,r){const n=this.terrain=new tL(t,r);this.stylesheet.terrain=t,this.dispatcher.broadcast("enableTerrain",!this.terrainSetForDrapingOnly()),this._updateDrapeFirstLayers(),this._force3DLayerUpdate();const i=this._getTransitionParameters({duration:0});n.updateTransitions(i)}_force3DLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="fill-extrusion"&&this._updateLayer(r)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="symbol"&&this._updateLayer(r)}}_validate(t,r,n,i,s={}){return(!s||s.validate!==!1)&&Wh(this,t.call(Lu,Yt({key:r,style:this.serialize(),value:n,styleSpec:rt},i)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),Ig.off("pluginStateChange",this._rtlTextPluginCallback);for(const{style:t}of this.imports)t._remove();this._mergeLayers(),this._mergeSources();for(const t in this._layers)this._layers[t].setEventedParent(null);for(const t in this._sourceCaches)this._sourceCaches[t].clearTiles(),this._sourceCaches[t].setEventedParent(null);this.modelManager&&this.modelManager.setEventedParent(null),this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(t){const r=this._getSourceCaches(t);for(const n of r)n.clearTiles()}_reloadSource(t){const r=this._getSourceCaches(t);for(const n of r)n.resume(),n.reload()}_reloadSources(){for(const t of this._getSources())t.reload&&t.reload()}_updateSources(t){for(const r in this._sourceCaches)this._sourceCaches[r].update(t)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const r=this._sourceCaches[t];r.resume(),r.reload()}}_updatePlacement(t,r,n,i,s=!1){let a=!1,l=!1;const p={};for(const f of this._order){const m=this._layers[f];if(m.type!=="symbol")continue;if(!p[m.source]){const y=this._getLayerSourceCache(m);if(!y)continue;p[m.source]=y.getRenderableIds(!0).map(v=>y.getTileByID(v)).sort((v,b)=>b.tileID.overscaledZ-v.tileID.overscaledZ||(v.tileID.isLessThan(b.tileID)?-1:1))}const _=this.crossTileSymbolIndex.addLayer(m,p[m.source],t.center.lng,t.projection);a=a||_}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),s=s||this._layerOrderChanged||n===0,this._layerOrderChanged&&this.fire(new wt("neworder")),(s||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(ge.now(),t.zoom))&&(this.pauseablePlacement=new BL(t,this._order,s,r,n,i,this.placement,this.fog&&t.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,p),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(ge.now()),l=!0),a&&this.pauseablePlacement.placement.setStale()),l||a)for(const f of this._order){const m=this._layers[f];m.type==="symbol"&&this.placement.updateLayerOpacities(m,p[m.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(ge.now())}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}getImages(t,r,n){this.imageManager.getImages(r.icons,r.scope,n),this._updateTilesForChangedImages();const i=s=>{s&&s.setDependencies(r.tileID.key,r.type,r.icons)};i(this._otherSourceCaches[r.source]),i(this._symbolSourceCaches[r.source])}getGlyphs(t,r,n){this.glyphManager.getGlyphs(r.stacks,r.scope,n)}getResource(t,r,n){return Ct(r,n)}_getSourceCache(t){return this._otherSourceCaches[t]}_getOwnSourceCache(t){return this._ownSourceCaches[t]}_getLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}_getSourceCaches(t){const r=[];return this._otherSourceCaches[t]&&r.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&r.push(this._symbolSourceCaches[t]),r}_isSourceCacheLoaded(t){const r=this._getSourceCaches(t);return r.length===0?(this.fire(new fe(new Error(`There is no source with ID '${t}'`))),!1):r.every(n=>n.loaded())}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function q2(e,t){let r=!1,n=null;const i=()=>{n=null,r&&(e(),n=setTimeout(i,t),r=!1)};return()=>(r=!0,n||i(),n)}gs.getSourceType=function(e){return dy[e]},gs.setSourceType=function(e,t){dy[e]=t},gs.registerForPluginStateChange=function(e){return e({pluginStatus:Yi,pluginURL:Va}),Ig.on("pluginStateChange",e),e};class KD{constructor(t){this._hashName=t&&encodeURIComponent(t),Ln(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=q2(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,S.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),S.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const r=Z2(t);if(this._hashName){const n=this._hashName;let i=!1;const s=S.location.hash.slice(1).split("&").map(a=>{const l=a.split("=")[0];return l===n?(i=!0,`${l}=${r}`):a}).filter(a=>a);return i||s.push(`${n}=${r}`),`#${s.join("&")}`}return`#${r}`}_getCurrentHash(){const t=S.location.hash.replace("#","");if(this._hashName){let r;return t.split("&").map(n=>n.split("=")).forEach(n=>{n[0]===this._hashName&&(r=n)}),(r&&r[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const r=this._getCurrentHash();if(r.length>=3&&!r.some(n=>isNaN(n))){const n=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(r[3]||0):t.getBearing();return t.jumpTo({center:[+r[2],+r[1]],zoom:+r[0],bearing:n,pitch:+(r[4]||0)}),!0}return!1}_updateHashUnthrottled(){const t=S.location.href.replace(/(#.+)?$/,this.getHashString());S.history.replaceState(S.history.state,null,t)}}function Z2(e,t){const r=e.getCenter(),n=Math.round(100*e.getZoom())/100,i=Math.ceil((n*Math.LN2+Math.log(512/360/.5))/Math.LN10),s=Math.pow(10,i),a=Math.round(r.lng*s)/s,l=Math.round(r.lat*s)/s,p=e.getBearing(),f=e.getPitch();let m=t?`/${a}/${l}/${n}`:`${n}/${l}/${a}`;return(p||f)&&(m+="/"+Math.round(10*p)/10),f&&(m+=`/${Math.round(f)}`),m}const Td={linearity:.3,easing:Bn(0,0,.3,1)},JD=Yt({deceleration:2500,maxSpeed:1400},Td),QD=Yt({deceleration:20,maxSpeed:1400},Td),tR=Yt({deceleration:1e3,maxSpeed:360},Td),eR=Yt({deceleration:1e3,maxSpeed:90},Td);class rR{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:ge.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,r=ge.now();for(;t.length>0&&r-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const r={zoom:0,bearing:0,pitch:0,pan:new H(0,0),pinchAround:void 0,around:void 0};for(const{settings:s}of this._inertiaBuffer)r.zoom+=s.zoomDelta||0,r.bearing+=s.bearingDelta||0,r.pitch+=s.pitchDelta||0,s.panDelta&&r.pan._add(s.panDelta),s.around&&(r.around=s.around),s.pinchAround&&(r.pinchAround=s.pinchAround);const n=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,i={};if(r.pan.mag()){const s=Sd(r.pan.mag(),n,Yt({},JD,t||{}));i.offset=r.pan.mult(s.amount/r.pan.mag()),i.center=this._map.transform.center,Id(i,s)}if(r.zoom){const s=Sd(r.zoom,n,QD);i.zoom=this._map.transform.zoom+s.amount,Id(i,s)}if(r.bearing){const s=Sd(r.bearing,n,tR);i.bearing=this._map.transform.bearing+Bt(s.amount,-179,179),Id(i,s)}if(r.pitch){const s=Sd(r.pitch,n,eR);i.pitch=this._map.transform.pitch+s.amount,Id(i,s)}if(i.zoom||i.bearing){const s=r.pinchAround===void 0?r.around:r.pinchAround;i.around=s?this._map.unproject(s):this._map.getCenter()}return this.clear(),i.noMoveStart=!0,i}}function Id(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing)}function Sd(e,t,r){const{maxSpeed:n,linearity:i,deceleration:s}=r,a=Bt(e*i/(t/1e3),-n,n),l=Math.abs(a)/(s*i);return{easing:r.easing,duration:1e3*l,amount:a*(l/2)}}class vo extends wt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,n,i={}){const s=Zc(r.getCanvasContainer(),n);super(t,Yt({point:s,lngLat:r.unproject(s),originalEvent:n},i)),this._defaultPrevented=!1,this.target=r}}class Cd extends wt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,n){const i=t==="touchend"?n.changedTouches:n.touches,s=Pp(r.getCanvasContainer(),i),a=s.map(p=>r.unproject(p)),l=s.reduce((p,f,m,_)=>p.add(f.div(_.length)),new H(0,0));super(t,{points:s,point:l,lngLats:a,lngLat:r.unproject(l),originalEvent:n}),this._defaultPrevented=!1}}class nR extends wt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,n){super(t,{originalEvent:n}),this._defaultPrevented=!1}}class iR{constructor(t,r){this._map=t,this._clickTolerance=r.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new nR(t.type,this._map,t))}mousedown(t,r){return this._mousedownPos=r,this._firePreventable(new vo(t.type,this._map,t))}mouseup(t){this._map.fire(new vo(t.type,this._map,t))}preclick(t){const r=Yt({},t);r.type="preclick",this._map.fire(new vo(r.type,this._map,r))}click(t,r){this._mousedownPos&&this._mousedownPos.dist(r)>=this._clickTolerance||(this.preclick(t),this._map.fire(new vo(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new vo(t.type,this._map,t))}mouseover(t){this._map.fire(new vo(t.type,this._map,t))}mouseout(t){this._map.fire(new vo(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Cd(t.type,this._map,t))}touchmove(t){this._map.fire(new Cd(t.type,this._map,t))}touchend(t){this._map.fire(new Cd(t.type,this._map,t))}touchcancel(t){this._map.fire(new Cd(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class oR{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new vo(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new vo("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new vo(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class sR{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=r.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,r){this.isEnabled()&&t.shiftKey&&t.button===0&&(Nv(),this._startPos=this._lastPos=r,this._active=!0)}mousemoveWindow(t,r){if(!this._active)return;const n=r,i=this._startPos,s=this._lastPos;if(!i||!s||s.equals(n)||!this._box&&n.dist(i)<this._clickTolerance)return;this._lastPos=n,this._box||(this._box=vr("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const a=Math.min(i.x,n.x),l=Math.max(i.x,n.x),p=Math.min(i.y,n.y),f=Math.max(i.y,n.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${a}px,${p}px)`,this._box.style.width=l-a+"px",this._box.style.height=f-p+"px")})}mouseupWindow(t,r){if(!this._active)return;const n=this._startPos,i=r;if(n&&t.button===0){if(this.reset(),_m(),n.x!==i.x||n.y!==i.y)return this._map.fire(new wt("boxzoomend",{originalEvent:t})),{cameraAnimation:s=>s.fitScreenCoordinates(n,i,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),zv(),delete this._startPos,delete this._lastPos}_fireEvent(t,r){return this._map.fire(new wt(t,{originalEvent:r}))}}function Dy(e,t){const r={};for(let n=0;n<e.length;n++)r[e[n].identifier]=t[n];return r}class aR{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,r,n){(this.centroid||n.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),n.length===this.numTouches&&(this.centroid=function(i){const s=new H(0,0);for(const a of i)s._add(a);return s.div(i.length)}(r),this.touches=Dy(n,r)))}touchmove(t,r,n){if(this.aborted||!this.centroid)return;const i=Dy(n,r);for(const s in this.touches){const a=i[s];(!a||a.dist(this.touches[s])>30)&&(this.aborted=!0)}}touchend(t,r,n){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),n.length===0){const i=!this.aborted&&this.centroid;if(this.reset(),i)return i}}}class Ry{constructor(t){this.singleTap=new aR(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,r,n){this.singleTap.touchstart(t,r,n)}touchmove(t,r,n){this.singleTap.touchmove(t,r,n)}touchend(t,r,n){const i=this.singleTap.touchend(t,r,n);if(i){const s=t.timeStamp-this.lastTime<500,a=!this.lastTap||this.lastTap.dist(i)<30;if(s&&a||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=i,this.count===this.numTaps)return this.reset(),i}}}class lR{constructor(){this._zoomIn=new Ry({numTouches:1,numTaps:2}),this._zoomOut=new Ry({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,r,n){this._zoomIn.touchstart(t,r,n),this._zoomOut.touchstart(t,r,n)}touchmove(t,r,n){this._zoomIn.touchmove(t,r,n),this._zoomOut.touchmove(t,r,n)}touchend(t,r,n){const i=this._zoomIn.touchend(t,r,n),s=this._zoomOut.touchend(t,r,n);return i?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:a=>a.easeTo({duration:300,zoom:a.getZoom()+1,around:a.unproject(i)},{originalEvent:t})}):s?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:a=>a.easeTo({duration:300,zoom:a.getZoom()-1,around:a.unproject(s)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const uR={0:1,2:2};class Oy{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,r){return!1}_move(t,r){return{}}mousedown(t,r){if(this._lastPoint)return;const n=kv(t);this._correctButton(t,n)&&(this._lastPoint=r,this._eventButton=n)}mousemoveWindow(t,r){const n=this._lastPoint;if(n){if(t.preventDefault(),this._eventButton!=null&&function(i,s){const a=uR[s];return i.buttons===void 0||(i.buttons&a)!==a}(t,this._eventButton))this.reset();else if(this._moved||!(r.dist(n)<this._clickTolerance))return this._moved=!0,this._lastPoint=r,this._move(n,r)}}mouseupWindow(t){this._lastPoint&&kv(t)===this._eventButton&&(this._moved&&_m(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class cR extends Oy{mousedown(t,r){super.mousedown(t,r),this._lastPoint&&(this._active=!0)}_correctButton(t,r){return r===0&&!t.ctrlKey}_move(t,r){return{around:r,panDelta:r.sub(t)}}}class X2 extends Oy{_correctButton(t,r){return r===0&&t.ctrlKey||r===2}_move(t,r){const n=.8*(r.x-t.x);if(n)return this._active=!0,{bearingDelta:n}}contextmenu(t){t.preventDefault()}}class W2 extends Oy{_correctButton(t,r){return r===0&&t.ctrlKey||r===2}_move(t,r){const n=-.5*(r.y-t.y);if(n)return this._active=!0,{pitchDelta:n}}contextmenu(t){t.preventDefault()}}class hR{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=r.clickTolerance||1,this.reset(),Ln(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new H(0,0)}touchstart(t,r,n){return this._calculateTransform(t,r,n)}touchmove(t,r,n){if(this._active&&!(n.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(n.length===1&&!yr())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,r,n)}}touchend(t,r,n){this._calculateTransform(t,r,n),this._active&&n.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,r,n){n.length>0&&(this._active=!0);const i=Dy(n,r),s=new H(0,0),a=new H(0,0);let l=0;for(const f in i){const m=i[f],_=this._touches[f];_&&(s._add(m),a._add(m.sub(_)),l++,i[f]=m)}if(this._touches=i,l<this._minTouches||!a.mag())return;const p=a.div(l);return this._sum._add(p),this._sum.mag()<this._clickTolerance?void 0:{around:s.div(l),panDelta:p}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=vr("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")},500)}}class Ny{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,r,n){return{}}touchstart(t,r,n){this._firstTwoTouches||n.length<2||(this._firstTwoTouches=[n[0].identifier,n[1].identifier],this._start([r[0],r[1]]))}touchmove(t,r,n){const i=this._firstTwoTouches;if(!i)return;t.preventDefault();const[s,a]=i,l=Md(n,r,s),p=Md(n,r,a);if(!l||!p)return;const f=this._aroundCenter?null:l.add(p).div(2);return this._move([l,p],f,t)}touchend(t,r,n){if(!this._firstTwoTouches)return;const[i,s]=this._firstTwoTouches,a=Md(n,r,i),l=Md(n,r,s);a&&l||(this._active&&_m(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Md(e,t,r){for(let n=0;n<e.length;n++)if(e[n].identifier===r)return t[n]}function H2(e,t){return Math.log(e/t)/Math.LN2}class pR extends Ny{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,r){const n=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(H2(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:H2(this._distance,n),pinchAround:r}}}function Y2(e,t){return 180*e.angleWith(t)/Math.PI}class fR extends Ny{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,r){const n=this._vector;if(this._vector=t[0].sub(t[1]),n&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Y2(this._vector,n),pinchAround:r}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const r=25/(Math.PI*this._minDiameter)*360,n=this._startVector;if(!n)return!1;const i=Y2(t,n);return Math.abs(i)<r}}function zy(e){return Math.abs(e.y)>Math.abs(e.x)}class dR extends Ny{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,zy(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,r,n){const i=this._lastPoints;if(!i)return;const s=t[0].sub(i[0]),a=t[1].sub(i[1]);return this._map._cooperativeGestures&&!yr()&&n.touches.length<3||(this._valid=this.gestureBeginsVertically(s,a,n.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(s.y+a.y)/2*-.5})}gestureBeginsVertically(t,r,n){if(this._valid!==void 0)return this._valid;const i=t.mag()>=2,s=r.mag()>=2;if(!i&&!s)return;if(!i||!s)return this._firstMove==null&&(this._firstMove=n),n-this._firstMove<100&&void 0;const a=t.y>0==r.y>0;return zy(t)&&zy(r)&&a}}const mR={panStep:100,bearingStep:15,pitchStep:10};class gR{constructor(){const t=mR;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let r=0,n=0,i=0,s=0,a=0;switch(t.keyCode){case 61:case 107:case 171:case 187:r=1;break;case 189:case 109:case 173:r=-1;break;case 37:t.shiftKey?n=-1:(t.preventDefault(),s=-1);break;case 39:t.shiftKey?n=1:(t.preventDefault(),s=1);break;case 38:t.shiftKey?i=1:(t.preventDefault(),a=-1);break;case 40:t.shiftKey?i=-1:(t.preventDefault(),a=1);break;default:return}return this._rotationDisabled&&(n=0,i=0),{cameraAnimation:l=>{const p=l.getZoom();l.easeTo({duration:300,easeId:"keyboardHandler",easing:_R,zoom:r?Math.round(p)+r*(t.shiftKey?2:1):p,bearing:l.getBearing()+n*this._bearingStep,pitch:l.getPitch()+i*this._pitchStep,offset:[-s*this._panStep,-a*this._panStep],center:l.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function _R(e){return e*(2-e)}const $2=4.000244140625;class yR{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._handler=r,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,Ln(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||yr()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let r=t.deltaMode===S.WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const n=ge.now(),i=n-(this._lastWheelEventTime||0);this._lastWheelEventTime=n,r!==0&&r%$2==0?this._type="wheel":r!==0&&Math.abs(r)<4?this._type="trackpad":i>400?(this._type=null,this._lastValue=r,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(i*r)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,r+=this._lastValue)),t.shiftKey&&r&&(r/=4),this._type&&(this._lastWheelEvent=t,this._delta-=r,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const r=Zc(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:r,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const r=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const p=this._type==="wheel"&&Math.abs(this._delta)>$2?this._wheelZoomRate:this._defaultZoomRate;let f=2/(1+Math.exp(-Math.abs(this._delta*p)));this._delta<0&&f!==0&&(f=1/f);const m=r(),_=Math.pow(2,m),y=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):_;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(y*f))),this._type==="wheel"&&(this._startZoom=m,this._easing=this._smoothOutEasing(200)),this._delta=0}const n=typeof this._targetZoom=="number"?this._targetZoom:r(),i=this._startZoom,s=this._easing;let a,l=!1;if(this._type==="wheel"&&i&&s){const p=Math.min((ge.now()-this._lastWheelEventTime)/200,1);a=ce(i,n,s(p)),p<1?this._frameId||(this._frameId=!0):l=!0}else a=n,l=!0;return this._active=!0,l&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!l,zoomDelta:a-r(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let r=ai;if(this._prevEase){const n=this._prevEase,i=(ge.now()-n.start)/n.duration,s=n.easing(i+.01)-n.easing(i),a=.27/Math.sqrt(s*s+1e-4)*.01;r=Bn(a,Math.sqrt(.0729-a*a),.25,1)}return this._prevEase={start:ge.now(),duration:t,easing:r},r}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=vr("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(S.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")},200)}}class vR{constructor(t,r){this._clickZoom=t,this._tapZoom=r}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class xR{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,r){return t.preventDefault(),{cameraAnimation:n=>{n.easeTo({duration:300,zoom:n.getZoom()+(t.shiftKey?-1:1),around:n.unproject(r)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class bR{constructor(){this._tap=new Ry({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,r,n){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?n.length>0&&(this._swipePoint=r[0],this._swipeTouch=n[0].identifier):this._tap.touchstart(t,r,n))}touchmove(t,r,n){if(this._tapTime){if(this._swipePoint){if(n[0].identifier!==this._swipeTouch)return;const i=r[0],s=i.y-this._swipePoint.y;return this._swipePoint=i,t.preventDefault(),this._active=!0,{zoomDelta:s/128}}}else this._tap.touchmove(t,r,n)}touchend(t,r,n){this._tapTime?this._swipePoint&&n.length===0&&this.reset():this._tap.touchend(t,r,n)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class wR{constructor(t,r,n){this._el=t,this._mousePan=r,this._touchPan=n}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class ER{constructor(t,r,n){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=r,this._mousePitch=n}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class TR{constructor(t,r,n,i){this._el=t,this._touchZoom=r,this._touchRotate=n,this._tapDragZoom=i,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Ad=e=>e.zoom||e.drag||e.pitch||e.rotate;class IR extends wt{}class SR{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,r){const n=q.sub([],r,t);this.radius=q.length(n[2]<0?q.div([],n,this.constants):[n[0],n[1],0])}projectRay(t){q.div(t,t,this.constants),q.normalize(t,t),q.mul(t,t,this.constants);const r=q.scale([],t,this.radius);if(r[2]>0){const n=q.scale([],[0,0,1],q.dot(r,[0,0,1])),i=q.scale([],q.normalize([],[r[0],r[1],0]),this.radius),s=q.add([],r,q.scale([],q.sub([],q.add([],i,n),r),2));r[0]=s[0],r[1]=s[1]}return r}}function Pd(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta}class CR{constructor(t,r){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new rR(t),this._bearingSnap=r.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new SR,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(r),Ln(["handleEvent","handleWindowEvent"],this);const n=this._el;this._listeners=[[n,"touchstart",{passive:!0}],[n,"touchmove",{passive:!1}],[n,"touchend",void 0],[n,"touchcancel",void 0],[n,"mousedown",void 0],[n,"mousemove",void 0],[n,"mouseup",void 0],[S.document,"mousemove",{capture:!0}],[S.document,"mouseup",void 0],[n,"mouseover",void 0],[n,"mouseout",void 0],[n,"dblclick",void 0],[n,"click",void 0],[n,"keydown",{capture:!1}],[n,"keyup",void 0],[n,"wheel",{passive:!1}],[n,"contextmenu",void 0],[S,"blur",void 0]];for(const[i,s,a]of this._listeners)i.addEventListener(s,i===S.document?this.handleWindowEvent:this.handleEvent,a)}destroy(){for(const[t,r,n]of this._listeners)t.removeEventListener(r,t===S.document?this.handleWindowEvent:this.handleEvent,n)}_addDefaultHandlers(t){const r=this._map,n=r.getCanvasContainer();this._add("mapEvent",new iR(r,t));const i=r.boxZoom=new sR(r,t);this._add("boxZoom",i);const s=new lR,a=new xR;r.doubleClickZoom=new vR(a,s),this._add("tapZoom",s),this._add("clickZoom",a);const l=new bR;this._add("tapDragZoom",l);const p=r.touchPitch=new dR(r);this._add("touchPitch",p);const f=new X2(t),m=new W2(t);r.dragRotate=new ER(t,f,m),this._add("mouseRotate",f,["mousePitch"]),this._add("mousePitch",m,["mouseRotate"]);const _=new cR(t),y=new hR(r,t);r.dragPan=new wR(n,_,y),this._add("mousePan",_),this._add("touchPan",y,["touchZoom","touchRotate"]);const v=new fR,b=new pR;r.touchZoomRotate=new TR(n,b,v,l),this._add("touchRotate",v,["touchPan","touchZoom"]),this._add("touchZoom",b,["touchPan","touchRotate"]),this._add("blockableMapEvent",new oR(r));const w=r.scrollZoom=new yR(r,this);this._add("scrollZoom",w,["mousePan"]);const E=r.keyboard=new gR;this._add("keyboard",E);for(const T of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[T]&&r[T].enable(t[T])}_add(t,r,n){this._handlers.push({handlerName:t,handler:r,allowed:n}),this._handlersById[t]=r}stop(t){if(!this._updatingCamera){for(const{handler:r}of this._handlers)r.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Ad(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,r,n){for(const i in t)if(i!==n&&(!r||r.indexOf(i)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const r=[];for(const n of t)this._el.contains(n.target)&&r.push(n);return r}handleEvent(t,r){this._updatingCamera=!0;const n=t.type==="renderFrame",i=n?void 0:t,s={needsRenderFrame:!1},a={},l={},p=t.touches?this._getMapTouches(t.touches):void 0,f=p?Pp(this._el,p):n?void 0:Zc(this._el,t);for(const{handlerName:y,handler:v,allowed:b}of this._handlers){if(!v.isEnabled())continue;let w;this._blockedByActive(l,b,y)?v.reset():v[r||t.type]&&(w=v[r||t.type](t,f,p),this.mergeHandlerResult(s,a,w,y,i),w&&w.needsRenderFrame&&this._triggerRenderFrame()),(w||v.isActive())&&(l[y]=v)}const m={};for(const y in this._previousActiveHandlers)l[y]||(m[y]=i);this._previousActiveHandlers=l,(Object.keys(m).length||Pd(s))&&(this._changes.push([s,a,m]),this._triggerRenderFrame()),(Object.keys(l).length||Pd(s))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:_}=s;_&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],_(this._map))}mergeHandlerResult(t,r,n,i,s){if(!n)return;Yt(t,n);const a={handlerName:i,originalEvent:n.originalEvent||s};n.zoomDelta!==void 0&&(r.zoom=a),n.panDelta!==void 0&&(r.drag=a),n.pitchDelta!==void 0&&(r.pitch=a),n.bearingDelta!==void 0&&(r.rotate=a)}_applyChanges(){const t={},r={},n={};for(const[i,s,a]of this._changes)i.panDelta&&(t.panDelta=(t.panDelta||new H(0,0))._add(i.panDelta)),i.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+i.zoomDelta),i.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+i.bearingDelta),i.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+i.pitchDelta),i.around!==void 0&&(t.around=i.around),i.aroundCoord!==void 0&&(t.aroundCoord=i.aroundCoord),i.pinchAround!==void 0&&(t.pinchAround=i.pinchAround),i.noInertia&&(t.noInertia=i.noInertia),Yt(r,s),Yt(n,a);this._updateMapTransform(t,r,n),this._changes=[]}_updateMapTransform(t,r,n){const i=this._map,s=i.transform,a=C=>[C.x,C.y,C.z];if((C=>{const M=this._eventsInProgress.drag;return M&&!this._handlersById[M.handlerName].isActive()})()&&!Pd(t)){const C=s.zoom;s.cameraElevationReference="sea",s.recenterOnTerrain(),s.cameraElevationReference="ground",C!==s.zoom&&this._map._update(!0)}if(s._isCameraConstrained&&i._stop(!0),!Pd(t))return void this._fireEvents(r,n,!0);let{panDelta:l,zoomDelta:p,bearingDelta:f,pitchDelta:m,around:_,aroundCoord:y,pinchAround:v}=t;s._isCameraConstrained&&(p>0&&(p=0),s._isCameraConstrained=!1),v!==void 0&&(_=v),(p||(C=>r[C]&&!this._eventsInProgress[C])("drag"))&&_&&(this._dragOrigin=a(s.pointCoordinate3D(_)),this._trackingEllipsoid.setup(s._camera.position,this._dragOrigin)),s.cameraElevationReference="sea",i._stop(!0),_=_||i.transform.centerPoint,f&&(s.bearing+=f),m&&(s.pitch+=m),s._updateCameraState();const b=[0,0,0];if(l)if(s.projection.name==="mercator"){const C=this._trackingEllipsoid.projectRay(s.screenPointToMercatorRay(_).dir),M=this._trackingEllipsoid.projectRay(s.screenPointToMercatorRay(_.sub(l)).dir);b[0]=M[0]-C[0],b[1]=M[1]-C[1]}else{const C=s.pointCoordinate(_);if(s.projection.name==="globe"){l=l.rotate(-s.angle);const M=s._pixelsPerMercatorPixel/s.worldSize;b[0]=-l.x*__(fn(C.y))*M,b[1]=-l.y*__(s.center.lat)*M}else{const M=s.pointCoordinate(_.sub(l));C&&M&&(b[0]=M.x-C.x,b[1]=M.y-C.y)}}const w=s.zoom,E=[0,0,0];if(p){const C=a(y||s.pointCoordinate3D(_)),M={dir:q.normalize([],q.sub([],C,s._camera.position))};if(M.dir[2]<0){const A=s.zoomDeltaToMovement(C,p);q.scale(E,M.dir,A)}}const T=q.add(b,b,E);s._translateCameraConstrained(T),p&&Math.abs(s.zoom-w)>1e-4&&s.recenterOnTerrain(),s.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(r,n,!0)}_fireEvents(t,r,n){const i=Ad(this._eventsInProgress),s=Ad(t),a={};for(const m in t){const{originalEvent:_}=t[m];this._eventsInProgress[m]||(a[`${m}start`]=_),this._eventsInProgress[m]=t[m]}!i&&s&&this._fireEvent("movestart",s.originalEvent);for(const m in a)this._fireEvent(m,a[m]);s&&this._fireEvent("move",s.originalEvent);for(const m in t){const{originalEvent:_}=t[m];this._fireEvent(m,_)}const l={};let p;for(const m in this._eventsInProgress){const{handlerName:_,originalEvent:y}=this._eventsInProgress[m];this._handlersById[_].isActive()||(delete this._eventsInProgress[m],p=r[_]||y,l[`${m}end`]=p)}for(const m in l)this._fireEvent(m,l[m]);const f=Ad(this._eventsInProgress);if(n&&(i||s)&&!f){this._updatingCamera=!0;const m=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),_=y=>y!==0&&-this._bearingSnap<y&&y<this._bearingSnap;m?(_(m.bearing||this._map.getBearing())&&(m.bearing=0),this._map.easeTo(m,{originalEvent:p})):(this._map.fire(new wt("moveend",{originalEvent:p})),_(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,r){this._map.fire(new wt(t,r?{originalEvent:r}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new IR("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const K2="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class MR extends hn{constructor(t,r){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=r.bearingSnap,this._respectPrefersReducedMotion=r.respectPrefersReducedMotion!==!1,Ln(["_renderFrameCallback"],this)}getCenter(){return new se(this.transform.center.lng,this.transform.center.lat)}setCenter(t,r){return this.jumpTo({center:t},r)}panBy(t,r,n){return t=H.convert(t).mult(-1),this.panTo(this.transform.center,Yt({offset:t},r),n)}panTo(t,r,n){return this.easeTo(Yt({center:t},r),n)}getZoom(){return this.transform.zoom}setZoom(t,r){return this.jumpTo({zoom:t},r),this}zoomTo(t,r,n){return this.easeTo(Yt({zoom:t},r),n)}zoomIn(t,r){return this.zoomTo(this.getZoom()+1,t,r),this}zoomOut(t,r){return this.zoomTo(this.getZoom()-1,t,r),this}getBearing(){return this.transform.bearing}setBearing(t,r){return this.jumpTo({bearing:t},r),this}getPadding(){return this.transform.padding}setPadding(t,r){return this.jumpTo({padding:t},r),this}rotateTo(t,r,n){return this.easeTo(Yt({bearing:t},r),n)}resetNorth(t,r){return this.rotateTo(0,Yt({duration:1e3},t),r),this}resetNorthPitch(t,r){return this.easeTo(Yt({bearing:0,pitch:0,duration:1e3},t),r),this}snapToNorth(t,r){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,r):this}getPitch(){return this.transform.pitch}setPitch(t,r){return this.jumpTo({pitch:t},r),this}cameraForBounds(t,r){t=go.convert(t);const n=r&&r.bearing||0,i=r&&r.pitch||0,s=t.getNorthWest(),a=t.getSouthEast();return this._cameraForBounds(this.transform,s,a,n,i,r)}_extendCameraOptions(t){const r={top:0,bottom:0,right:0,left:0};if(typeof(t=Yt({padding:r,offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=="number"){const n=t.padding;t.padding={top:n,bottom:n,right:n,left:n}}return t.padding=Yt(r,t.padding),t}_minimumAABBFrustumDistance(t,r){const n=r.max[0]-r.min[0],i=r.max[1]-r.min[1];return n/i>t.aspect?n/(2*Math.tan(.5*t.fovX)*t.aspect):i/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,r,n,i,s,a){const l=t.clone(),p=this._extendCameraOptions(a);l.bearing=i,l.pitch=s;const f=se.convert(r),m=se.convert(n),_=.5*(f.lat+m.lat),y=.5*(f.lng+m.lng),v=Oi(_,y),b=q.normalize([],v),w=q.normalize([],q.cross([],b,[0,1,0])),E=q.cross([],w,b),T=[w[0],w[1],w[2],0,E[0],E[1],E[2],0,b[0],b[1],b[2],0,0,0,0,1],C=[v,Oi(f.lat,f.lng),Oi(m.lat,f.lng),Oi(m.lat,m.lng),Oi(f.lat,m.lng),Oi(_,f.lng),Oi(_,m.lng),Oi(f.lat,y),Oi(m.lat,y)];let M=Zr.fromPoints(C.map(J=>[q.dot(w,J),q.dot(E,J),q.dot(b,J)]));const A=q.transformMat4([],M.center,T);q.squaredLength(A)===0&&q.set(A,0,0,1),q.normalize(A,A),q.scale(A,A,Ki),l.center=function([J,nt,at]){const ot=Math.hypot(J,nt,at),It=Math.atan2(J,at),xt=.5*Math.PI-Math.acos(-nt/ot);return new se(qt(It),qt(xt))}(A);const P=l.getWorldToCameraMatrix(),L=Q.invert(new Float64Array(16),P);M=Zr.applyTransform(M,Q.multiply([],P,T)),q.transformMat4(A,A,P);const R=.5*(M.max[2]-M.min[2]),N=this._minimumAABBFrustumDistance(l,M),k=q.scale([],[0,0,1],R),F=q.add(k,A,k),z=N+(l.pitch===0?0:q.distance(A,F)),U=l.globeCenterInViewSpace,G=q.sub([],A,[U[0],U[1],U[2]]);q.normalize(G,G),q.scale(G,G,z);const V=q.add([],A,G);q.transformMat4(V,V,L);const K=ju/Ki,$=q.length(V),tt=cr(Math.max($*K-ju,Number.EPSILON),0),X=Math.min(l.zoomFromMercatorZAdjusted(tt),p.maxZoom);return X>.5*(mh+Ka)?(l.setProjection({name:"mercator"}),l.zoom=X,this._cameraForBounds(l,r,n,i,s,a)):{center:l.center,zoom:X,bearing:i,pitch:s}}queryTerrainElevation(t,r){const n=this.transform.elevation;return n?(r=Yt({},{exaggerated:!0},r),n.getAtPoint(Ue.fromLngLat(t),null,r.exaggerated)):null}_cameraForBounds(t,r,n,i,s,a){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,r,n,i,s,a);const l=t.clone(),p=this._extendCameraOptions(a),f=l.padding;l.bearing=i,l.pitch=s;const m=se.convert(r),_=se.convert(n),y=new se(m.lng,_.lat),v=new se(_.lng,m.lat),b=l.project(m),w=l.project(_),E=this.queryTerrainElevation(m),T=this.queryTerrainElevation(_),C=this.queryTerrainElevation(y),M=this.queryTerrainElevation(v),A=[[b.x,b.y,Math.min(E||0,T||0,C||0,M||0)],[w.x,w.y,Math.max(E||0,T||0,C||0,M||0)]];let P=Zr.fromPoints(A);const L=l.getWorldToCameraMatrix(),R=Q.invert(new Float64Array(16),L);P=Zr.applyTransform(P,L);const N=q.sub([],P.max,P.min),k=f.left||0,F=f.right||0,z=f.bottom||0,U=f.top||0,{left:G,right:V,top:K,bottom:$}=p.padding,tt=.5*(k+F),X=.5*(U+z),J=Math.min(l.scaleZoom(l.scale*Math.min((l.width-(k+F+G+V))/N[0],(l.height-(z+U+$+K))/N[1])),p.maxZoom),nt=l.scale/l.zoomScale(J);P=new Zr([P.min[0]-(G+tt)*nt,P.min[1]-($+X)*nt,P.min[2]],[P.max[0]+(V+tt)*nt,P.max[1]+(K+X)*nt,P.max[2]]);const at=.5*N[2],ot=this._minimumAABBFrustumDistance(l,P),It=[0,0,1,0];gr.transformMat4(It,It,L),gr.normalize(It,It);const xt=q.scale([],It,ot+at),dt=q.add([],P.center,xt),yt=(typeof p.offset.x=="number"&&typeof p.offset.y=="number"?new H(p.offset.x,p.offset.y):H.convert(p.offset)).rotate(-re(i));P.center[0]-=yt.x*nt,P.center[1]+=yt.y*nt,q.transformMat4(P.center,P.center,R),q.transformMat4(dt,dt,R);const Ot=[P.center[0],P.center[1],dt[2]*l.pixelsPerMeter];q.scale(Ot,Ot,1/l.worldSize);const Jt=Ji(Ot[0]),Zt=fn(Ot[1]),Gt=Math.min(l._zoomFromMercatorZ(Ot[2]),p.maxZoom),Qt=new se(Jt,Zt);return l.mercatorFromTransition&&Gt<.5*(mh+Ka)?(l.setProjection({name:"globe"}),l.zoom=Gt,this._cameraForBounds(l,r,n,i,s,a)):{center:Qt,zoom:Gt,bearing:i,pitch:s}}fitBounds(t,r,n){const i=this.cameraForBounds(t,r);return this._fitInternal(i,r,n)}fitScreenCoordinates(t,r,n,i,s){const a=H.convert(t),l=H.convert(r),p=new H(Math.min(a.x,l.x),Math.min(a.y,l.y)),f=new H(Math.max(a.x,l.x),Math.max(a.y,l.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(a,l))return this;const m=this.transform.pointLocation3D(p),_=this.transform.pointLocation3D(f),y=this.transform.pointLocation3D(new H(p.x,f.y)),v=this.transform.pointLocation3D(new H(f.x,p.y)),b=[Math.min(m.lng,_.lng,y.lng,v.lng),Math.min(m.lat,_.lat,y.lat,v.lat)],w=[Math.max(m.lng,_.lng,y.lng,v.lng),Math.max(m.lat,_.lat,y.lat,v.lat)],E=i&&i.pitch?i.pitch:this.getPitch(),T=this._cameraForBounds(this.transform,b,w,n,E,i);return this._fitInternal(T,i,s)}_fitInternal(t,r,n){return t?(delete(r=Yt(t,r)).padding,r.linear?this.easeTo(r,n):this.flyTo(r,n)):this}jumpTo(t,r){this.stop();const n=t.preloadOnly?this.transform.clone():this.transform;let i=!1,s=!1,a=!1;return"zoom"in t&&n.zoom!==+t.zoom&&(i=!0,n.zoom=+t.zoom),t.center!==void 0&&(n.center=se.convert(t.center)),"bearing"in t&&n.bearing!==+t.bearing&&(s=!0,n.bearing=+t.bearing),"pitch"in t&&n.pitch!==+t.pitch&&(a=!0,n.pitch=+t.pitch),t.padding==null||n.isPaddingEqual(t.padding)||(n.padding=t.padding),t.preloadOnly?(this._preloadTiles(n),this):(this.fire(new wt("movestart",r)).fire(new wt("move",r)),i&&this.fire(new wt("zoomstart",r)).fire(new wt("zoom",r)).fire(new wt("zoomend",r)),s&&this.fire(new wt("rotatestart",r)).fire(new wt("rotate",r)).fire(new wt("rotateend",r)),a&&this.fire(new wt("pitchstart",r)).fire(new wt("pitch",r)).fire(new wt("pitchend",r)),this.fire(new wt("moveend",r)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||Y(K2),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,r){const n=this.transform;if(!n.projection.supportsFreeCamera)return Y(K2),this;this.stop();const i=n.zoom,s=n.pitch,a=n.bearing;n.setFreeCameraOptions(t);const l=i!==n.zoom,p=s!==n.pitch,f=a!==n.bearing;return this.fire(new wt("movestart",r)).fire(new wt("move",r)),l&&this.fire(new wt("zoomstart",r)).fire(new wt("zoom",r)).fire(new wt("zoomend",r)),f&&this.fire(new wt("rotatestart",r)).fire(new wt("rotate",r)).fire(new wt("rotateend",r)),p&&this.fire(new wt("pitchstart",r)).fire(new wt("pitch",r)).fire(new wt("pitchend",r)),this.fire(new wt("moveend",r)),this}easeTo(t,r){this._stop(!1,t.easeId),((t=Yt({offset:[0,0],duration:500,easing:ai},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const n=this.transform,i=this.getZoom(),s=this.getBearing(),a=this.getPitch(),l=this.getPadding(),p="zoom"in t?+t.zoom:i,f="bearing"in t?this._normalizeBearing(t.bearing,s):s,m="pitch"in t?+t.pitch:a,_="padding"in t?t.padding:n.padding,y=H.convert(t.offset);let v,b,w;if(n.projection.name==="globe"){const k=Ue.fromLngLat(n.center),F=y.rotate(-n.angle);k.x+=F.x/n.worldSize,k.y+=F.y/n.worldSize;const z=k.toLngLat(),U=se.convert(t.center||z);this._normalizeCenter(U),v=n.centerPoint.add(F),b=new H(k.x,k.y).mult(n.worldSize),w=new H(Xn(U.lng),ri(U.lat)).mult(n.worldSize).sub(b)}else{v=n.centerPoint.add(y);const k=n.pointLocation(v),F=se.convert(t.center||k);this._normalizeCenter(F),b=n.project(k),w=n.project(F).sub(b)}const E=n.zoomScale(p-i);let T,C;t.around&&(T=se.convert(t.around),C=n.locationPoint(T));const M=this._zooming||p!==i,A=this._rotating||s!==f,P=this._pitching||m!==a,L=!n.isPaddingEqual(_),R=k=>F=>{if(M&&(k.zoom=ce(i,p,F)),A&&(k.bearing=ce(s,f,F)),P&&(k.pitch=ce(a,m,F)),L&&(k.interpolatePadding(l,_,F),v=k.centerPoint.add(y)),T)k.setLocationAtPoint(T,C);else{const z=k.zoomScale(k.zoom-i),U=p>i?Math.min(2,E):Math.max(.5,E),G=Math.pow(U,1-F),V=k.unproject(b.add(w.mult(F*G)).mult(z));k.setLocationAtPoint(k.renderWorldCopies?V.wrap():V,v)}return t.preloadOnly||this._fireMoveEvents(r),k};if(t.preloadOnly){const k=this._emulate(R,t.duration,n);return this._preloadTiles(k),this}const N={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=M,this._rotating=A,this._pitching=P,this._padding=L,this._easeId=t.easeId,this._prepareEase(r,t.noMoveStart,N),this._ease(R(n),k=>{n.recenterOnTerrain(),this._afterEase(r,k)},t),this}_prepareEase(t,r,n={}){this._moving=!0,this.transform.cameraElevationReference="sea",r||n.moving||this.fire(new wt("movestart",t)),this._zooming&&!n.zooming&&this.fire(new wt("zoomstart",t)),this._rotating&&!n.rotating&&this.fire(new wt("rotatestart",t)),this._pitching&&!n.pitching&&this.fire(new wt("pitchstart",t))}_fireMoveEvents(t){this.fire(new wt("move",t)),this._zooming&&this.fire(new wt("zoom",t)),this._rotating&&this.fire(new wt("rotate",t)),this._pitching&&this.fire(new wt("pitch",t))}_afterEase(t,r){if(this._easeId&&r&&this._easeId===r)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const n=this._zooming,i=this._rotating,s=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,n&&this.fire(new wt("zoomend",t)),i&&this.fire(new wt("rotateend",t)),s&&this.fire(new wt("pitchend",t)),this.fire(new wt("moveend",t))}flyTo(t,r){if(this._prefersReducedMotion(t)){const J=Zi(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(J,r)}this.stop(),t=Yt({offset:[0,0],speed:1.2,curve:1.42,easing:ai},t);const n=this.transform,i=this.getZoom(),s=this.getBearing(),a=this.getPitch(),l=this.getPadding(),p="zoom"in t?Bt(+t.zoom,n.minZoom,n.maxZoom):i,f="bearing"in t?this._normalizeBearing(t.bearing,s):s,m="pitch"in t?+t.pitch:a,_="padding"in t?t.padding:n.padding,y=n.zoomScale(p-i),v=H.convert(t.offset);let b=n.centerPoint.add(v);const w=n.pointLocation(b),E=se.convert(t.center||w);this._normalizeCenter(E);const T=n.project(w),C=n.project(E).sub(T);let M=t.curve;const A=Math.max(n.width,n.height),P=A/y,L=C.mag();if("minZoom"in t){const J=Bt(Math.min(t.minZoom,i,p),n.minZoom,n.maxZoom),nt=A/n.zoomScale(J-i);M=Math.sqrt(nt/L*2)}const R=M*M;function N(J){const nt=(P*P-A*A+(J?-1:1)*R*R*L*L)/(2*(J?P:A)*R*L);return Math.log(Math.sqrt(nt*nt+1)-nt)}function k(J){return(Math.exp(J)-Math.exp(-J))/2}function F(J){return(Math.exp(J)+Math.exp(-J))/2}const z=N(0);let U=function(J){return F(z)/F(z+M*J)},G=function(J){return A*((F(z)*(k(nt=z+M*J)/F(nt))-k(z))/R)/L;var nt},V=(N(1)-z)/M;if(Math.abs(L)<1e-6||!isFinite(V)){if(Math.abs(A-P)<1e-6)return this.easeTo(t,r);const J=P<A?-1:1;V=Math.abs(Math.log(P/A))/M,G=function(){return 0},U=function(nt){return Math.exp(J*M*nt)}}t.duration="duration"in t?+t.duration:1e3*V/("screenSpeed"in t?+t.screenSpeed/M:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const K=s!==f,$=m!==a,tt=!n.isPaddingEqual(_),X=J=>nt=>{const at=nt*V,ot=1/U(at);J.zoom=nt===1?p:i+J.scaleZoom(ot),K&&(J.bearing=ce(s,f,nt)),$&&(J.pitch=ce(a,m,nt)),tt&&(J.interpolatePadding(l,_,nt),b=J.centerPoint.add(v));const It=nt===1?E:J.unproject(T.add(C.mult(G(at))).mult(ot));return J.setLocationAtPoint(J.renderWorldCopies?It.wrap():It,b),J._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(r),J};if(t.preloadOnly){const J=this._emulate(X,t.duration,n);return this._preloadTiles(J),this}return this._zooming=!0,this._rotating=K,this._pitching=$,this._padding=tt,this._prepareEase(r,!1),this._ease(X(n),()=>this._afterEase(r),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,r){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const n=this._onEaseEnd;this._onEaseEnd=void 0,n.call(this,r)}if(!t){const n=this.handlers;n&&n.stop(!1)}return this}_ease(t,r,n){n.animate===!1||n.duration===0?(t(1),r()):(this._easeStart=ge.now(),this._easeOptions=n,this._onEaseFrame=t,this._onEaseEnd=r,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((ge.now()-this._easeStart)/this._easeOptions.duration,1),r=this._onEaseFrame;r&&r(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,r){t=Vn(t,-180,180);const n=Math.abs(t-r);return Math.abs(t-360-r)<n&&(t-=360),Math.abs(t+360-r)<n&&(t+=360),t}_normalizeCenter(t){const r=this.transform;if(!r.renderWorldCopies||r.maxBounds)return;const n=t.lng-r.center.lng;t.lng+=n>180?-360:n<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&ge.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,r,n){const i=Math.ceil(15*r/1e3),s=[],a=t(n.clone());for(let l=0;l<=i;l++){const p=a(l/i);s.push(p.clone())}return s}}class J2{constructor(t={}){this.options=t,Ln(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const r=this.options&&this.options.compact;return this._map=t,this._container=vr("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=vr("button","mapboxgl-ctrl-attrib-button",this._container),vr("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=vr("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),r&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),r===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(t,r){const n=this._map._getUIString(`AttributionControl.${r}`);t.setAttribute("aria-label",n),t.removeAttribute("title"),t.firstElementChild&&t.firstElementChild.setAttribute("title",n)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const r=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||B.ACCESS_TOKEN}];if(t){const n=r.reduce((i,s,a)=>(s.value&&(i+=`${s.key}=${s.value}${a<r.length-1?"&":""}`),i),"?");t.href=`${B.FEEDBACK_URL}/${n}#${Z2(this._map,!0)}`,t.rel="noopener nofollow",this._setElementTitle(t,"MapFeedback")}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const i=this._map.style.stylesheet;this.styleOwner=i.owner,this.styleId=i.id}const r=this._map.style._sourceCaches;for(const i in r){const s=r[i];if(s.used){const a=s.getSource();a.attribution&&t.indexOf(a.attribution)<0&&t.push(a.attribution)}}t.sort((i,s)=>i.length-s.length),t=t.filter((i,s)=>{for(let a=s+1;a<t.length;a++)if(t[a].indexOf(i)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const n=t.join(" | ");n!==this._attribHTML&&(this._attribHTML=n,t.length?(this._innerContainer.innerHTML=n,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Q2{constructor(){Ln(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=vr("div","mapboxgl-ctrl");const r=vr("a","mapboxgl-ctrl-logo");return r.target="_blank",r.rel="noopener nofollow",r.href="https://www.mapbox.com/",r.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),r.setAttribute("rel","noopener nofollow"),this._container.appendChild(r),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const r in t){const n=t[r].getSource();if(n.hasOwnProperty("mapbox_logo")&&!n.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const r=t[0];this._map.getCanvasContainer().offsetWidth<250?r.classList.add("mapboxgl-compact"):r.classList.remove("mapboxgl-compact")}}}class tT{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const r=++this._id;return this._queue.push({callback:t,id:r,cancelled:!1}),r}remove(t){const r=this._currentlyRunning,n=r?this._queue.concat(r):this._queue;for(const i of n)if(i.id===t)return void(i.cancelled=!0)}run(t=0){const r=this._currentlyRunning=this._queue;this._queue=[];for(const n of r)if(!n.cancelled&&(n.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function eT(e,t,r){if(e=new se(e.lng,e.lat),t){const n=new se(e.lng-360,e.lat),i=new se(e.lng+360,e.lat),s=360*Math.ceil(Math.abs(e.lng-r.center.lng)/360),a=r.locationPoint(e).distSqr(t),l=t.x<0||t.y<0||t.x>r.width||t.y>r.height;r.locationPoint(n).distSqr(t)<a&&(l||Math.abs(n.lng-r.center.lng)<s)?e=n:r.locationPoint(i).distSqr(t)<a&&(l||Math.abs(i.lng-r.center.lng)<s)&&(e=i)}for(;Math.abs(e.lng-r.center.lng)>180;){const n=r.locationPoint(e);if(n.x>=0&&n.y>=0&&n.x<=r.width&&n.y<=r.height)break;e.lng>r.center.lng?e.lng-=360:e.lng+=360}return e}const ky={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Fy extends hn{constructor(t,r){if(super(),(t instanceof S.HTMLElement||r)&&(t=Yt({element:t},r)),Ln(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=t&&t.occludedOpacity||.2,t&&t.element)this._element=t.element,this._offset=H.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=vr("div");const s=41,a=27,l=ra("svg",{display:"block",height:s*this._scale+"px",width:a*this._scale+"px",viewBox:`0 0 ${a} ${s}`},this._element),p=ra("radialGradient",{id:"shadowGradient"},ra("defs",{},l));ra("stop",{offset:"10%","stop-opacity":.4},p),ra("stop",{offset:"100%","stop-opacity":.05},p),ra("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},l),ra("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},l),ra("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},l),ra("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},l),this._offset=H.convert(t&&t.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",s=>{s.preventDefault()}),this._element.addEventListener("mousedown",s=>{s.preventDefault()});const n=this._element.classList;for(const s in ky)n.remove(`mapboxgl-marker-anchor-${s}`);n.add(`mapboxgl-marker-anchor-${this._anchor}`);const i=t&&t.className?t.className.trim().split(/\s+/):[];n.add(...i),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=se.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const i=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[i,-1*(38.1-13.5+i)],"bottom-right":[-i,-1*(38.1-13.5+i)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const r=t.code,n=t.charCode||t.keyCode;r!=="Space"&&r!=="Enter"&&n!==32&&n!==13||this.togglePopup()}_onMapClick(t){const r=t.originalEvent.target,n=this._element;this._popup&&(r===n||n.contains(r))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,r=this._pos;if(!t||!r)return!1;const n=t.unproject(r),i=t.getFreeCameraOptions();if(!i.position)return!1;const s=i.position.toLngLat();return s.distanceTo(n)<.9*s.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const r=this._pos;if(!r||r.x<0||r.x>t.transform.width||r.y<0||r.y>t.transform.height)return void this._clearFadeTimer();const n=t.unproject(r);let i;t._showingGlobe()&&Ef(t.transform,this._lngLat)?i=0:(i=1-t._queryFogOpacity(n),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(i*=this._occludedOpacity)),this._element.style.opacity=`${i}`,this._element.style.pointerEvents=i>0?"auto":"none",this._popup&&this._popup._setOpacity(i),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const r=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${ky[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${r.x}px,${r.y}px)
        `}_calculateXYTransform(){const t=this._pos,r=this._map,n=this.getPitchAlignment();if(!r||!t||n!=="map")return"";if(!r._showingGlobe()){const p=r.getPitch();return p?`rotateX(${p}deg)`:""}const i=qt(H1(r.transform,this._lngLat)),s=t.sub(W1(r.transform)),a=Math.abs(s.x)+Math.abs(s.y);if(a===0)return"";const l=i/a;return`rotateX(${-s.y*l}deg) rotateY(${s.x*l}deg)`}_calculateZTransform(){const t=this._pos,r=this._map;if(!r||!t)return"";let n=0;const i=this.getRotationAlignment();if(i==="map")if(r._showingGlobe()){const s=r.project(new se(this._lngLat.lng,this._lngLat.lat+.001)),a=r.project(new se(this._lngLat.lng,this._lngLat.lat-.001)).sub(s);n=qt(Math.atan2(a.y,a.x))-90}else n=-r.getBearing();else if(i==="horizon"){const s=Ti(4,6,r.getZoom()),a=W1(r.transform);a.y+=s*r.transform.height;const l=t.sub(a),p=qt(Math.atan2(l.y,l.x));n=(p>90?p-270:p+90)*(1-s)}return n+=this._rotation,n?`rotateZ(${n}deg)`:""}_update(t){S.cancelAnimationFrame(this._updateFrameId);const r=this._map;r&&(r.transform.renderWorldCopies&&(this._lngLat=eT(this._lngLat,this._pos,r.transform)),this._pos=r.project(this._lngLat),t===!0?this._updateFrameId=S.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),r._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(r._showingGlobe()||r.getTerrain()||r.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=H.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const r=this._map;if(!r)return;const n=this._pointerdownPos,i=this._positionDelta;if(n&&i){if(!this._isDragging){const s=this._clickTolerance||r._clickTolerance;if(t.point.dist(n)<s)return;this._isDragging=!0}this._pos=t.point.sub(i),this._lngLat=r.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new wt("dragstart"))),this.fire(new wt("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new wt("dragend")),this._state="inactive"}_addDragHandler(t){const r=this._map,n=this._pos;r&&n&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(n),this._pointerdownPos=t.point,this._state="pending",r.on("mousemove",this._onMove),r.on("touchmove",this._onMove),r.once("mouseup",this._onUp),r.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const r=this._map;return r&&(t?(r.on("mousedown",this._addDragHandler),r.on("touchstart",this._addDragHandler)):(r.off("mousedown",this._addDragHandler),r.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const AR={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},PR=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function rT(e=new H(0,0),t="bottom"){if(typeof e=="number"){const r=Math.round(Math.sqrt(.5*Math.pow(e,2)));switch(t){case"top":return new H(0,e);case"top-left":return new H(r,r);case"top-right":return new H(-r,r);case"bottom":return new H(0,-e);case"bottom-left":return new H(r,-r);case"bottom-right":return new H(-r,-r);case"left":return new H(e,0);case"right":return new H(-e,0)}return new H(0,0)}return e instanceof H||Array.isArray(e)?H.convert(e):H.convert(e[t]||[0,0])}class LR{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const r=Sr((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-r)+this._end*r}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,r,n){this._start=this.getValue(r),this._end=t,this._startTime=r,this._endTime=r+n}}const DR={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},RR={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,useWebGL2:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},OR={showCompass:!0,showZoom:!0,visualizePitch:!1};class NR{constructor(t,r,n=!1){this._clickTolerance=10,this.element=r,this.mouseRotate=new X2({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,n&&(this.mousePitch=new W2({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),Ln(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),r.addEventListener("mousedown",this.mousedown),r.addEventListener("touchstart",this.touchstart,{passive:!1}),r.addEventListener("touchmove",this.touchmove),r.addEventListener("touchend",this.touchend),r.addEventListener("touchcancel",this.reset)}down(t,r){this.mouseRotate.mousedown(t,r),this.mousePitch&&this.mousePitch.mousedown(t,r),Nv()}move(t,r){const n=this.map,i=this.mouseRotate.mousemoveWindow(t,r),s=i&&i.bearingDelta;if(s&&n.setBearing(n.getBearing()+s),this.mousePitch){const a=this.mousePitch.mousemoveWindow(t,r),l=a&&a.pitchDelta;l&&n.setPitch(n.getPitch()+l)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){zv(),S.removeEventListener("mousemove",this.mousemove),S.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Yt({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Zc(this.element,t)),S.addEventListener("mousemove",this.mousemove),S.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Zc(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Pp(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=Pp(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const zR={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},kR={maxWidth:100,unit:"metric"},FR={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Ld={version:D,supported:Rv,setRTLTextPlugin:function(e,t,r=!1){if(Yi===xg||Yi===bg||Yi===wg)throw new Error("setRTLTextPlugin cannot be called multiple times.");Va=ge.resolveURL(e),Yi=xg,Eg=t,Tg(),r||ex()},getRTLTextPluginStatus:Sg,Map:class extends MR{constructor(e){if(Lv.mark(Cp.create),(e=Yt({},RR,e)).minZoom!=null&&e.maxZoom!=null&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(e.minPitch!=null&&e.maxPitch!=null&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(e.minPitch!=null&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(e.maxPitch!=null&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(e.antialias&&function(t){const r=t.navigator?t.navigator.userAgent:null;return!!pe(t)&&r&&(r.match("Version/15.4")||r.match("Version/15.5")||r.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))}(S)&&(e.antialias=!1,Y("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new ey(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),e),this._interactive=e.interactive,this._minTileCacheSize=e.minTileCacheSize,this._maxTileCacheSize=e.maxTileCacheSize,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=e.preserveDrawingBuffer,this._antialias=e.antialias,this._useWebGL2=e.useWebGL2,this._trackResize=e.trackResize,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles,this._fadeDuration=e.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=e.crossSourceCollisions,this._collectResourceTiming=e.collectResourceTiming,this._optimizeForTerrain=e.optimizeForTerrain,this._language=this._parseLanguage(e.language),this._worldview=e.worldview,this._renderTaskQueue=new tT,this._domRenderTaskQueue=new tT,this._controls=[],this._markers=[],this._popups=[],this._mapId=gu(),this._locale=Yt({},DR,e.locale),this._clickTolerance=e.clickTolerance,this._cooperativeGestures=e.cooperativeGestures,this._performanceMetricsCollection=e.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new LR(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new Pr(e.transformRequest,e.accessToken,e.testMode),this._silenceAuthErrors=!!e.testMode,typeof e.container=="string"){if(this._container=S.document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container.toString()}' not found.`)}else{if(!(e.container instanceof S.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(this._container.childNodes.length>0&&Y("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),e.maxBounds&&this.setMaxBounds(e.maxBounds),Ln(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),S!==void 0&&(this._fullscreenchangeEvent="onfullscreenchange"in S.document?"fullscreenchange":"webkitfullscreenchange",S.addEventListener("online",this._onWindowOnline,!1),S.addEventListener("resize",this._onWindowResize,!1),S.addEventListener("orientationchange",this._onWindowResize,!1),S.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),S.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new CR(this,e),this._localFontFamily=e.localFontFamily,this._localIdeographFontFamily=e.localIdeographFontFamily,(e.style||!e.testMode)&&this.setStyle(e.style||B.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),e.projection&&this.setProjection(e.projection),e.hash&&(this._hash=new KD(typeof e.hash=="string"&&e.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch});const t=e.bounds;t&&(this.resize(),this.fitBounds(t,Yt({},e.fitBoundsOptions,{duration:0})))}this.resize(),e.attributionControl&&this.addControl(new J2({customAttribution:e.customAttribution})),this._logoControl=new Q2,this.addControl(this._logoControl,e.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",t=>{this._update(t.dataType==="style"),this.fire(new wt(`${t.dataType}data`,t))}),this.on("dataloading",t=>{this.fire(new wt(`${t.dataType}dataloading`,t))})}_getMapId(){return this._mapId}addControl(e,t){if(t===void 0&&(t=e.getDefaultPosition?e.getDefaultPosition():"top-right"),!e||!e.onAdd)return this.fire(new fe(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const r=e.onAdd(this);this._controls.push(e);const n=this._controlPositions[t];return t.indexOf("bottom")!==-1?n.insertBefore(r,n.firstChild):n.appendChild(r),this}removeControl(e){if(!e||!e.onRemove)return this.fire(new fe(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(e);return t>-1&&this._controls.splice(t,1),e.onRemove(this),this}hasControl(e){return this._controls.indexOf(e)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(e){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new wt("movestart",e)).fire(new wt("move",e)),this.fire(new wt("resize",e)),t&&this.fire(new wt("moveend",e)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(e){return this.transform.setMaxBounds(go.convert(e)),this._update()}setMinZoom(e){if((e=e??-2)>=-2&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e?this.setZoom(e):this.fire(new wt("zoomstart")).fire(new wt("zoom")).fire(new wt("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(e){if((e=e??22)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e?this.setZoom(e):this.fire(new wt("zoomstart")).fire(new wt("zoom")).fire(new wt("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(e){if((e=e??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e?this.setPitch(e):this.fire(new wt("pitchstart")).fire(new wt("pitch")).fire(new wt("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(e){if((e=e??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e?this.setPitch(e):this.fire(new wt("pitchstart")).fire(new wt("pitch")).fire(new wt("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(e){return e==="auto"?S.navigator.language:Array.isArray(e)?e.length===0?void 0:e.map(t=>t==="auto"?S.navigator.language:t):e}setLanguage(e){const t=this._parseLanguage(e);if(!this.style||t===this._language)return this;this._language=t,this.style._reloadSources();for(const r of this._controls)r._setLanguage&&r._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(e){return this.style&&e!==this._worldview?(this._worldview=e,this.style._reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(e){return this._lazyInitEmptyStyle(),e?typeof e=="string"&&(e={name:e}):e=null,this._useExplicitProjection=!!e,this._prioritizeAndUpdateProjection(e,this.style.stylesheet?this.style.stylesheet.projection:null)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const e=this.transform,t=e.projection.name;let r;t==="globe"&&e.zoom>=Ka?(e.setMercatorFromTransition(),r=!0):t==="mercator"&&e.zoom<Ka&&(e.setProjection({name:"globe"}),r=!0),r&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(e,t){return this._updateProjection(e||t||{name:"mercator"})}_updateProjection(e){let t;if(t=e.name==="globe"&&this.transform.zoom>=Ka?this.transform.setMercatorFromTransition():this.transform.setProjection(e),this.style.applyProjectionUpdate(),t){this.painter.clearBackgroundTiles();for(const r in this.style._sourceCaches)this.style._sourceCaches[r].clearTiles();this._update(!0),this._forceMarkerAndPopupUpdate(!0)}return this}project(e){return this.transform.locationPoint3D(se.convert(e))}unproject(e){return this.transform.pointLocation3D(H.convert(e))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(e,t,r){if(e==="mouseenter"||e==="mouseover"){let n=!1;const i=a=>{const l=t.filter(f=>this.getLayer(f)),p=l.length?this.queryRenderedFeatures(a.point,{layers:l}):[];p.length?n||(n=!0,r.call(this,new vo(e,this,a.originalEvent,{features:p}))):n=!1},s=()=>{n=!1};return{layers:new Set(t),listener:r,delegates:{mousemove:i,mouseout:s}}}if(e==="mouseleave"||e==="mouseout"){let n=!1;const i=a=>{const l=t.filter(p=>this.getLayer(p));(l.length?this.queryRenderedFeatures(a.point,{layers:l}):[]).length?n=!0:n&&(n=!1,r.call(this,new vo(e,this,a.originalEvent)))},s=a=>{n&&(n=!1,r.call(this,new vo(e,this,a.originalEvent)))};return{layers:new Set(t),listener:r,delegates:{mousemove:i,mouseout:s}}}{const n=i=>{const s=t.filter(l=>this.getLayer(l)),a=s.length?this.queryRenderedFeatures(i.point,{layers:s}):[];a.length&&(i.features=a,r.call(this,i),delete i.features)};return{layers:new Set(t),listener:r,delegates:{[e]:n}}}}on(e,t,r){if(r===void 0)return super.on(e,t);Array.isArray(t)||(t=[t]);const n=this._createDelegatedListener(e,t,r);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(n);for(const i in n.delegates)this.on(i,n.delegates[i]);return this}once(e,t,r){if(r===void 0)return super.once(e,t);Array.isArray(t)||(t=[t]);const n=this._createDelegatedListener(e,t,r);for(const i in n.delegates)this.once(i,n.delegates[i]);return this}off(e,t,r){if(r===void 0)return super.off(e,t);t=new Set(Array.isArray(t)?t:[t]);const n=(s,a)=>{if(s.size!==a.size)return!1;for(const l of s)if(!a.has(l))return!1;return!0},i=this._delegatedListeners?this._delegatedListeners[e]:void 0;return i&&(s=>{for(let a=0;a<s.length;a++){const l=s[a];if(l.listener===r&&n(l.layers,t)){for(const p in l.delegates)this.off(p,l.delegates[p]);return s.splice(a,1),this}}})(i),this}queryRenderedFeatures(e,t){return this.style?(t!==void 0||e===void 0||e instanceof H||Array.isArray(e)||(t=e,e=void 0),this.style.queryRenderedFeatures(e=e||[[0,0],[this.transform.width,this.transform.height]],t=t||{},this.transform)):[]}querySourceFeatures(e,t){return this.style.querySourceFeatures(e,t)}isPointOnSurface(e){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&Y(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(H.convert(e))}setStyle(e,t){return(t=Yt({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t)).diff!==!1&&t.localIdeographFontFamily===this._localIdeographFontFamily&&t.localFontFamily===this._localFontFamily&&this.style&&e?(this._diffStyle(e,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(e,t))}_getUIString(e){const t=this._locale[e];if(t==null)throw new Error(`Missing UI string '${e}'`);return t}_updateStyle(e,t){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),e&&(this.style=new gs(this,t||{}),this.style.setEventedParent(this,{style:this.style}),typeof e=="string"?this.style.loadURL(e):this.style.loadJSON(e)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new gs(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(e,t){if(typeof e=="string"){const r=this._requestManager.normalizeStyleURL(e),n=this._requestManager.transformRequest(r,ct.Style);Lt(n,(i,s)=>{i?this.fire(new fe(i)):s&&this._updateDiff(s,t)})}else typeof e=="object"&&this._updateDiff(e,t)}_updateDiff(e,t){try{this.style.setState(e)&&this._update(!0)}catch(r){Y(`Unable to perform style diff: ${r.message||r.error||r}.  Rebuilding the style from scratch.`),this._updateStyle(e,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(Y("There is no style added to the map."),!1)}addSource(e,t){return this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0)}isSourceLoaded(e){return!!this.style&&this.style._isSourceCacheLoaded(e)}areTilesLoaded(){const e=this.style&&this.style._sourceCaches;for(const t in e){const r=e[t]._tiles;for(const n in r){const i=r[n];if(i.state!=="loaded"&&i.state!=="errored")return!1}}return!0}addSourceType(e,t,r){this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,r)}removeSource(e){return this.style.removeSource(e),this._updateTerrain(),this._update(!0)}getSource(e){return this.style.getOwnSource(e)}addImage(e,t,{pixelRatio:r=1,sdf:n=!1,stretchX:i,stretchY:s,content:a}={}){if(this._lazyInitEmptyStyle(),t instanceof S.HTMLImageElement||S.ImageBitmap&&t instanceof S.ImageBitmap){const{width:l,height:p,data:f}=ge.getImageData(t);this.style.addImage(e,{data:new Yr({width:l,height:p},f),pixelRatio:r,stretchX:i,stretchY:s,content:a,sdf:n,version:0})}else if(t.width===void 0||t.height===void 0)this.fire(new fe(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:l,height:p}=t,f=t;this.style.addImage(e,{data:new Yr({width:l,height:p},new Uint8Array(f.data)),pixelRatio:r,stretchX:i,stretchY:s,content:a,sdf:n,version:0,userImage:f}),f.onAdd&&f.onAdd(this,e)}}updateImage(e,t){const r=this.style.getImage(e);if(!r)return void this.fire(new fe(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const n=t instanceof S.HTMLImageElement||S.ImageBitmap&&t instanceof S.ImageBitmap?ge.getImageData(t):t,{width:i,height:s}=n;i!==void 0&&s!==void 0?i===r.data.width&&s===r.data.height?(r.data.replace(n.data,!(t instanceof S.HTMLImageElement||S.ImageBitmap&&t instanceof S.ImageBitmap)),this.style.updateImage(e,r)):this.fire(new fe(new Error(`The width and height of the updated image (${i}, ${s})
                must be that same as the previous version of the image
                (${r.data.width}, ${r.data.height})`))):this.fire(new fe(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(e){return e?!!this.style.getImage(e):(this.fire(new fe(new Error("Missing required image id"))),!1)}removeImage(e){this.style.removeImage(e)}loadImage(e,t){Ke(this._requestManager.transformRequest(e,ct.Image),(r,n)=>{t(r,n instanceof S.HTMLImageElement?ge.getImageData(n):n)})}listImages(){return this.style.listImages()}addModel(e,t){this._lazyInitEmptyStyle(),this.style.addModel(e,t)}hasModel(e){return e?this.style.hasModel(e):(this.fire(new fe(new Error("Missing required model id"))),!1)}removeModel(e){this.style.removeModel(e)}listModels(){return this.style.listModels()}addLayer(e,t){return this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0)}moveLayer(e,t){return this.style.moveLayer(e,t),this._update(!0)}removeLayer(e){return this.style.removeLayer(e),this._update(!0)}setLights(e){if(this._lazyInitEmptyStyle(),e&&e.length===1&&e[0].type==="flat"){const t=e[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(e),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const e=this.style.getLights()||[];return e.length===0&&e.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),e}getLayer(e){return this.style.getOwnLayer(e)}setLayerZoomRange(e,t,r){return this.style.setLayerZoomRange(e,t,r),this._update(!0)}setFilter(e,t,r={}){return this.style.setFilter(e,t,r),this._update(!0)}getFilter(e){return this.style.getFilter(e)}setPaintProperty(e,t,r,n={}){return this.style.setPaintProperty(e,t,r,n),this._update(!0)}getPaintProperty(e,t){return this.style.getPaintProperty(e,t)}setLayoutProperty(e,t,r,n={}){return this.style.setLayoutProperty(e,t,r,n),this._update(!0)}getLayoutProperty(e,t){return this.style.getLayoutProperty(e,t)}setConfigProperty(e,t,r){return this.style.setConfigProperty(e,t,r),this._update(!0)}setLight(e,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:e}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(e){return this._lazyInitEmptyStyle(),!e&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(e),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(e){return this._lazyInitEmptyStyle(),this.style.setFog(e),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(e){return this.style.stylesheet.camera=e,this._update(this.transform.setOrthographicProjectionAtLowPitch(e["camera-projection"]==="orthographic"))}getCamera(){return this.style.stylesheet.camera}_queryFogOpacity(e){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(se.convert(e),this.transform):0}setFeatureState(e,t){return this.style.setFeatureState(e,t),this._update()}removeFeatureState(e,t){return this.style.removeFeatureState(e,t),this._update()}getFeatureState(e){return this.style.getFeatureState(e)}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let r,n,i,s=this._container;for(;s&&(!n||!i);){const a=S.getComputedStyle(s).transform;a&&a!=="none"&&(r=a.match(/matrix.*\((.+)\)/)[1].split(", "),r[0]&&r[0]!=="0"&&r[0]!=="1"&&(n=r[0]),r[3]&&r[3]!=="0"&&r[3]!=="1"&&(i=r[3])),s=s.parentElement}this._containerWidth=n?Math.abs(e/n):e,this._containerHeight=i?Math.abs(t/i):t}_detectMissingCSS(){S.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&Y("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const e=this._container;e.classList.add("mapboxgl-map"),(this._missingCSSCanary=vr("div","mapboxgl-canary",e)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=vr("div","mapboxgl-canvas-container",e);this._interactive&&t.classList.add("mapboxgl-interactive"),this._canvas=vr("canvas","mapboxgl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const r=this._controlContainer=vr("div","mapboxgl-control-container",e),n=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(i=>{n[i]=vr("div",`mapboxgl-ctrl-${i}`,r)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(e,t){const r=ge.devicePixelRatio||1;this._canvas.width=r*Math.ceil(e),this._canvas.height=r*Math.ceil(t),this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`}_addMarker(e){this._markers.push(e)}_removeMarker(e){const t=this._markers.indexOf(e);t!==-1&&this._markers.splice(t,1)}_addPopup(e){this._popups.push(e)}_removePopup(e){const t=this._popups.indexOf(e);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const e=Yt({},Rv.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._useWebGL2&&this._canvas.getContext("webgl2",e),r=t||this._canvas.getContext("webgl",e)||this._canvas.getContext("experimental-webgl",e);r?(this._useWebGL2&&!t&&Y("Failed to create WebGL 2 context. Using WebGL 1."),Pv(r,!0),this.painter=new XD(r,this.transform,!!t),this.on("data",n=>{n.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),W.testSupport(r)):this.fire(new fe(new Error("Failed to initialize WebGL")))}_contextLost(e){e.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new wt("webglcontextlost",{originalEvent:e}))}_contextRestored(e){this._setupPainter(),this.resize(),this._update(),this.fire(new wt("webglcontextrestored",{originalEvent:e}))}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e)}_cancelRenderFrame(e){this._renderTaskQueue.remove(e)}_requestDomTask(e){!this.loaded()||this.loaded()&&!this.isMoving()?e():this._domRenderTaskQueue.add(e)}_render(e){let t;const r=this.painter.context.extTimerQuery,n=ge.now();if(this.listens("gpu-timing-frame")&&(t=r.createQueryEXT(),r.beginQueryEXT(r.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],S.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],S.performance.now())),this._renderTaskQueue.run(e),this._domRenderTaskQueue.run(e),this._removed)return;this._updateProjectionTransition();const i=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const l=this.transform.zoom,p=this.transform.pitch,f=ge.now(),m=new jr(l,{now:f,fadeDuration:i,pitch:p,transition:this.style.getTransition()});this.style.ambientLight&&this.style.ambientLight.recalculate(m),this.style.directionalLight&&this.style.directionalLight.recalculate(m);const _=this.style.calculateLightsBrightness();_!==void 0&&(m.brightness=_||0),this.style.update(m)}this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let s=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),s=this._updateAverageElevation(n),this.style._updateSources(this.transform),this._forceMarkerAndPopupUpdate()):s=this._updateAverageElevation(n),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,i,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:i,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new wt("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new wt("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const l=ge.now()-n;r.endQueryEXT(r.TIME_ELAPSED_EXT,t),setTimeout(()=>{const p=r.getQueryObjectEXT(t,r.QUERY_RESULT_EXT)/1e6;r.deleteQueryEXT(t),this.fire(new wt("gpu-timing-frame",{cpuTime:l,gpuTime:p})),S.performance.mark("frame-gpu",{startTime:n,detail:{gpuTime:p}})},50)}if(this.listens("gpu-timing-layer")){const l=this.painter.collectGpuTimers();setTimeout(()=>{const p=this.painter.queryGpuTimers(l);this.fire(new wt("gpu-timing-layer",{layerTimes:p}))},50)}if(this.listens("gpu-timing-deferred-render")){const l=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const p=this.painter.queryGpuTimeDeferredRender(l);this.fire(new wt("gpu-timing-deferred-render",{gpuTime:p}))},50)}const a=this._sourcesDirty||this._styleDirty||this._placementDirty||s;if(a||this._repaint)this.triggerRepaint();else{const l=!this.isMoving()&&this.loaded();if(l&&(s=this._updateAverageElevation(n,!0)),s)this.triggerRepaint();else if(this._triggerFrame(!1),l&&(this.fire(new wt("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const p=this._calculateSpeedIndex();this.fire(new wt("speedindexcompleted",{speedIndex:p})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||a||(this._fullyLoaded=!0,Lv.mark(Cp.fullLoad),this._performanceMetricsCollection&&FI(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(e){for(const t of this._markers)e&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!e||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(e,t=!1){const r=n=>(this.transform.averageElevation=n,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&r(0);if((t||e-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(e)){const n=this.transform.averageElevation;let i=this.transform.sampleAverageElevation(),s=!1;this.transform.elevation&&(s=this.transform.elevation.exaggeration()!==this._averageElevationExaggeration,this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(i)?i=0:this._averageElevationLastSampledAt=e;const a=Math.abs(n-i);if(a>1){if(this._isInitialLoad||s)return this._averageElevation.jumpTo(i),r(i);this._averageElevation.easeTo(i,e,300)}else if(a>1e-4)return this._averageElevation.jumpTo(i),r(i)}return!!this._averageElevation.isEasing(e)&&r(this._averageElevation.getValue(e))}_authenticate(){BI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,e=>{if(e&&(e.message===ee||e.status===401)){const t=this.painter.context.gl;Pv(t,!1),this._logoControl instanceof Q2&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new fe(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),kI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){const e=this._isDragging();this.painter.updateTerrain(this.style,e)}_calculateSpeedIndex(){const e=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const r=this.painter.context.gl,n=r.createFramebuffer();function i(s){r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,s,0);const a=new Uint8Array(r.drawingBufferWidth*r.drawingBufferHeight*4);return r.readPixels(0,0,r.drawingBufferWidth,r.drawingBufferHeight,r.RGBA,r.UNSIGNED_BYTE,a),a}return r.bindFramebuffer(r.FRAMEBUFFER,n),this._canvasPixelComparison(i(e),t.canvasCopies.map(i),t.timeStamps)}_canvasPixelComparison(e,t,r){let n=r[1]-r[0];const i=e.length/4;for(let s=0;s<t.length;s++){const a=t[s];let l=0;for(let p=0;p<a.length;p+=4)a[p]===e[p]&&a[p+1]===e[p+1]&&a[p+2]===e[p+2]&&a[p+3]===e[p+3]&&(l+=1);n+=(r[s+2]-r[s+1])*(1-l/i)}return n}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),S!==void 0&&(S.removeEventListener("resize",this._onWindowResize,!1),S.removeEventListener("orientationchange",this._onWindowResize,!1),S.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),S.removeEventListener("online",this._onWindowOnline,!1),S.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Sp.delete(this.painter.context.gl),this._removed=!0,this.fire(new wt("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(e){this._renderNextFrame=this._renderNextFrame||e,this.style&&!this._frame&&(this._frame=ge.frame(t=>{const r=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,r&&this._render(t)}))}_preloadTiles(e){return Lo(this.style?Object.values(this.style._sourceCaches):[],(t,r)=>t._preloadTiles(e,r),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update()}_onVisibilityChange(){S.document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(e){this._showTerrainWireframe!==e&&(this._showTerrainWireframe=e,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(e){this._showLayers2DWireframe!==e&&(this._showLayers2DWireframe=e,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(e){this._showLayers3DWireframe!==e&&(this._showLayers3DWireframe=e,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(e){this._speedIndexTiming!==e&&(this._speedIndexTiming=e,this._update())}get showPadding(){return!!this._showPadding}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,e?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update())}get repaint(){return!!this._repaint}set repaint(e){this._repaint!==e&&(this._repaint=e,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(e){this._vertices=e,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(e){this._showTileAABBs!==e&&(this._showTileAABBs=e,e&&this._update())}_setCacheLimits(e,t){(function(r,n){Li=r,Oa=n})(e,t)}get version(){return D}},NavigationControl:class{constructor(e){this.options=Yt({},OR,e),this._container=vr("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(Ln(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),vr("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),vr("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(Ln(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const r=this._map;r&&(this.options.visualizePitch?r.resetNorthPitch({},{originalEvent:t}):r.resetNorth({},{originalEvent:t}))}),this._compassIcon=vr("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const e=this._map;if(!e)return;const t=e.getZoom(),r=t===e.getMaxZoom(),n=t===e.getMinZoom();this._zoomInButton.disabled=r,this._zoomOutButton.disabled=n,this._zoomInButton.setAttribute("aria-disabled",r.toString()),this._zoomOutButton.setAttribute("aria-disabled",n.toString())}_rotateCompassArrow(){const e=this._map;if(!e)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(e.transform.pitch*(Math.PI/180)),.5)}) rotateX(${e.transform.pitch}deg) rotateZ(${e.transform.angle*(180/Math.PI)}deg)`:`rotate(${e.transform.angle*(180/Math.PI)}deg)`;e._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),e.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&e.on("pitch",this._rotateCompassArrow),e.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new NR(e,this._compass,this.options.visualizePitch)),this._container}onRemove(){const e=this._map;e&&(this._container.remove(),this.options.showZoom&&e.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&e.off("pitch",this._rotateCompassArrow),e.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(e,t){const r=vr("button",e,this._container);return r.type="button",r.addEventListener("click",t),r}_setButtonTitle(e,t){if(!this._map)return;const r=this._map._getUIString(`NavigationControl.${t}`);e.setAttribute("aria-label",r),e.firstElementChild&&e.firstElementChild.setAttribute("title",r)}},GeolocateControl:class extends hn{constructor(e){super(),this.options=Yt({geolocation:S.navigator.geolocation},zR,e),Ln(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=q2(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(e){return this._map=e,this._container=vr("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(e){const t=(r=!!this.options.geolocation)=>{this._supportsGeolocation=r,e(r)};this._supportsGeolocation!==void 0?e(this._supportsGeolocation):S.navigator.permissions!==void 0?S.navigator.permissions.query({name:"geolocation"}).then(r=>t(r.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),r=e.coords;return!!t&&(r.longitude<t.getWest()||r.longitude>t.getEast()||r.latitude<t.getSouth()||r.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(e){if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new wt("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(e),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(e),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new wt("geolocate",e)),this._finish()}}_updateCamera(e){const t=new se(e.coords.longitude,e.coords.latitude),r=e.coords.accuracy,n=Yt({bearing:this._map.getBearing()},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(r),n,{geolocateSource:!0})}_updateMarker(e){if(e){const t=new se(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const e=this._map.transform,t=cr(1,e._center.lat)*e.worldSize,r=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${r}px`,this._circleElement.style.height=`${r}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(e){if(this._map){if(this.options.trackUserLocation)if(e.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(e.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new wt("error",e)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(e){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=vr("button","mapboxgl-ctrl-geolocate",this._container),vr("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",e===!1){Y("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=vr("div","mapboxgl-user-location"),this._dotElement.appendChild(vr("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(vr("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Fy({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=vr("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Fy({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new wt("trackuserlocationend")))})}}_onDeviceOrientation(e){this._userLocationDotMarker&&(e.webkitCompassHeading?this._heading=e.webkitCompassHeading:e.absolute===!0&&(this._heading=-1*e.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return Y("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new wt("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new wt("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new wt("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let e;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(e={maximumAge:6e5,timeout:0},this._noTimeout=!0):(e=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,e),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{S.addEventListener("ondeviceorientationabsolute"in S?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};S.DeviceMotionEvent!==void 0&&typeof S.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&e()}).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),S.removeEventListener("deviceorientation",this._onDeviceOrientation),S.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:J2,ScaleControl:class{constructor(e){this.options=Yt({},kR,e),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),Ln(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const e=this.options.maxWidth||100,t=this._map,r=t._containerHeight/2,n=t._containerWidth/2-e/2,i=t.unproject([n,r]),s=t.unproject([n+e,r]),a=i.distanceTo(s);if(this.options.unit==="imperial"){const l=3.2808*a;l>5280?this._setScale(e,l/5280,"mile"):this._setScale(e,l,"foot")}else this.options.unit==="nautical"?this._setScale(e,a/1852,"nautical-mile"):a>=1e3?this._setScale(e,a/1e3,"kilometer"):this._setScale(e,a,"meter")}_setScale(e,t,r){this._map._requestDomTask(()=>{const n=function(s){const a=Math.pow(10,`${Math.floor(s)}`.length-1);let l=s/a;return l=l>=10?10:l>=5?5:l>=3?3:l>=2?2:l>=1?1:function(p){const f=Math.pow(10,Math.ceil(-Math.log(p)/Math.LN10));return Math.round(p*f)/f}(l),a*l}(t),i=n/t;this._container.innerHTML=this._isNumberFormatSupported&&r!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:r}).format(n):`${n}&nbsp;${FR[r]}`,this._container.style.width=e*i+"px"})}onAdd(e){return this._map=e,this._language=e.getLanguage(),this._container=vr("div","mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(e){this._language=e,this._update()}setUnit(e){this.options.unit=e,this._update()}},FullscreenControl:class{constructor(e){this._fullscreen=!1,e&&e.container&&(e.container instanceof S.HTMLElement?this._container=e.container:Y("Full screen control 'container' must be a DOM element.")),Ln(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in S.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in S.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(e){return this._map=e,this._container||(this._container=this._map.getContainer()),this._controlContainer=vr("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",Y("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,S.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!S.document.fullscreenEnabled&&!S.document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=vr("button","mapboxgl-ctrl-fullscreen",this._controlContainer);vr("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),S.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",e)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(S.document.fullscreenElement||S.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?S.document.exitFullscreen?S.document.exitFullscreen():S.document.webkitCancelFullScreen&&S.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends hn{constructor(e){super(),this.options=Yt(Object.create(AR),e),Ln(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(e&&e.className?e.className.trim().split(/\s+/):[])}addTo(e){return this._map&&this.remove(),this._map=e,this.options.closeOnClick&&e.on("preclick",this._onClose),this.options.closeOnMove&&e.on("move",this._onClose),e.on("remove",this.remove),this._update(),e._addPopup(this),this._focusFirstElement(),this._trackPointer?(e.on("mousemove",this._onMouseEvent),e.on("mouseup",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")):e.on("move",this._update),this.fire(new wt("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const e=this._map;return e&&(e.off("move",this._update),e.off("move",this._onClose),e.off("preclick",this._onClose),e.off("click",this._onClose),e.off("remove",this.remove),e.off("mousemove",this._onMouseEvent),e.off("mouseup",this._onMouseEvent),e.off("drag",this._onMouseEvent),e._canvasContainer&&e._canvasContainer.classList.remove("mapboxgl-track-pointer"),e._removePopup(this),this._map=void 0),this.fire(new wt("close")),this}getLngLat(){return this._lngLat}setLngLat(e){this._lngLat=se.convert(e),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const e=this._map;return e&&(e.off("move",this._update),e.on("mousemove",this._onMouseEvent),e.on("drag",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(S.document.createTextNode(e))}setHTML(e){const t=S.document.createDocumentFragment(),r=S.document.createElement("body");let n;for(r.innerHTML=e;n=r.firstChild,n;)t.appendChild(n);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this}setDOMContent(e){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=vr("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(e),this.options.closeButton){const r=this._closeButton=vr("button","mapboxgl-popup-close-button",t);r.type="button",r.setAttribute("aria-label","Close popup"),r.setAttribute("aria-hidden","true"),r.innerHTML="&#215;",r.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(e){return this._classList.add(e),this._updateClassList(),this}removeClassName(e){return this._classList.delete(e),this._updateClassList(),this}setOffset(e){return this.options.offset=e,this._update(),this}toggleClassName(e){let t;return this._classList.delete(e)?t=!1:(this._classList.add(e),t=!0),this._updateClassList(),t}_onMouseEvent(e){this._update(e.point)}_getAnchor(e){if(this.options.anchor)return this.options.anchor;const t=this._map,r=this._container,n=this._pos;if(!t||!r||!n)return"bottom";const i=r.offsetWidth,s=r.offsetHeight,a=n.x<i/2,l=n.x>t.transform.width-i/2;if(n.y+e<s)return a?"top-left":l?"top-right":"top";if(n.y>t.transform.height-s){if(a)return"bottom-left";if(l)return"bottom-right"}return a?"left":l?"right":"bottom"}_updateClassList(){const e=this._container;if(!e)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),e.className=t.join(" ")}_update(e){const t=this._map,r=this._content;if(!t||!this._lngLat&&!this._trackPointer||!r)return;let n=this._container;if(n||(n=this._container=vr("div","mapboxgl-popup",t.getContainer()),this._tip=vr("div","mapboxgl-popup-tip",n),n.appendChild(r)),this.options.maxWidth&&n.style.maxWidth!==this.options.maxWidth&&(n.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=eT(this._lngLat,this._pos,t.transform)),!this._trackPointer||e){const i=this._pos=this._trackPointer&&e?e:t.project(this._lngLat),s=rT(this.options.offset),a=this._anchor=this._getAnchor(s.y),l=rT(this.options.offset,a),p=i.add(l).round();t._requestDomTask(()=>{this._container&&a&&(this._container.style.transform=`${ky[a]} translate(${p.x}px,${p.y}px)`)})}if(!this._marker&&t._showingGlobe()){const i=Ef(t.transform,this._lngLat)?0:1;this._setOpacity(i)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(PR);e&&e.focus()}_onClose(){this.remove()}_setOpacity(e){this._container&&(this._container.style.opacity=`${e}`),this._content&&(this._content.style.pointerEvents=e?"auto":"none")}},Marker:Fy,Style:gs,LngLat:se,LngLatBounds:go,Point:H,MercatorCoordinate:Ue,FreeCameraOptions:xw,Evented:hn,config:B,prewarm:function(){jh().acquire(hy)},clearPrewarmedResources:function(){const e=Gh;e&&(e.isPreloaded()&&e.numActive()===1?(e.release(hy),Gh=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return B.ACCESS_TOKEN},set accessToken(e){B.ACCESS_TOKEN=e},get baseApiUrl(){return B.API_URL},set baseApiUrl(e){B.API_URL=e},get workerCount(){return uc.workerCount},set workerCount(e){uc.workerCount=e},get maxParallelImageRequests(){return B.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(e){B.MAX_PARALLEL_IMAGE_REQUESTS=e},clearStorage(e){(function(t){if(!Do())return;const r=S.caches.delete(_i);t&&r.catch(t).then(()=>t())})(e)},workerUrl:"",workerClass:null,get loadersUrl(){return PE()},set loadersUrl(e){(function(t){py=ge.resolveURL(t),fy||(fy=new Xl(jh(),new hn)),fy.broadcast("setLoadersUrl",py)})(e)},setNow:ge.setNow,restoreNow:ge.restoreNow};I.Actor=_E,I.DEMData=$u,I.EXTENT=lt,I.Event=wt,I.FeatureIndex=N_,I.KDBush=vd,I.OverscaledTileID=wr,I.Point=H,I.Tiled3dModelBucket=Zw,I.VectorTileFeature=zf,I.VectorTileWorkerSource=class extends hn{constructor(e,t,r,n,i,s){super(),this.actor=e,this.layerIndex=t,this.availableImages=r,this.loadVectorData=i||TE,this.loading={},this.loaded={},this.deduped=new EE(e.scheduler),this.isSpriteLoaded=n,this.scheduler=e.scheduler,this.brightness=s}loadTile(e,t){const r=e.uid,n=e&&e.request,i=n&&n.collectResourceTiming,s=this.loading[r]=new aL(e);s.abort=this.loadVectorData(e,(a,l)=>{const p=!this.loading[r];if(delete this.loading[r],p||a||!l)return s.status="done",p||(this.loaded[r]=s),t(a);const f=l.rawData,m={};l.expires&&(m.expires=l.expires),l.cacheControl&&(m.cacheControl=l.cacheControl),s.vectorTile=l.vectorTile||new R_(new Vf(f));const _=()=>{s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.actor,(y,v)=>{if(y||!v)return t(y);const b={};if(i){const w=Dv(n);w.length>0&&(b.resourceTiming=JSON.parse(JSON.stringify(w)))}t(null,Yt({rawTileData:f.slice(0)},v,m,b))})};this.isSpriteLoaded?_():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(_,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom}):_()}),this.loaded=this.loaded||{},this.loaded[r]=s})}reloadTile(e,t){const r=this.loaded,n=e.uid,i=this;if(r&&r[n]){const s=r[n];s.showCollisionBoxes=e.showCollisionBoxes,s.enableTerrain=!!e.enableTerrain,s.projection=e.projection,s.brightness=e.brightness,s.tileTransform=ql(e.tileID.canonical,e.projection);const a=(l,p)=>{const f=s.reloadCallback;f&&(delete s.reloadCallback,s.parse(s.vectorTile,i.layerIndex,this.availableImages,i.actor,f)),t(l,p)};s.status==="parsing"?s.reloadCallback=a:s.status==="done"&&(s.vectorTile?s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.actor,a):a())}}abortTile(e,t){const r=e.uid,n=this.loading[r];n&&(n.abort&&n.abort(),delete this.loading[r]),t()}removeTile(e,t){const r=this.loaded,n=e.uid;r&&r[n]&&delete r[n],t()}},I.convertB3dm=function(e,t){const r=cy(e);for(const n of r)n.lights&&(n.meshes.push(mL(n.lights,t)),n.lightMeshIndex=n.meshes.length-1);return r},I.createExpression=Fa,I.createStyleLayer=dd,I.enforceCacheSizeLimit=function(e){ss(),Ii&&Ii.then(t=>{t.keys().then(r=>{for(let n=0;n<r.length-e;n++)t.delete(r[n])})})},I.exported=Ld,I.extend=Yt,I.getArrayBuffer=Dt,I.getDefaultExportFromCjs=Nt,I.getJSON=Lt,I.getPerformanceMeasurement=Dv,I.getProjection=Yf,I.load3DTile=async function(e){return await LE(),mapboxglLoaders.parse(e,mapboxglLoaders.Tiles3DLoader,{worker:!1,gltf:{decompressMeshes:!0,postProcess:!1,loadBuffers:!0,loadImages:!0}})},I.pbf=bb,I.plugin=ko,I.pointGeometry=Ve,I.refProperties=OE,I.tileToMeter=yh,I.values=ho,I.vectorTile=Nf,I.window=S}),g(["./shared"],function(I){function S(St){if(typeof St=="number"||typeof St=="boolean"||typeof St=="string"||St==null)return JSON.stringify(St);if(Array.isArray(St)){let Z="[";for(const Y of St)Z+=`${S(Y)},`;return`${Z}]`}let j="{";for(const Z of Object.keys(St).sort())j+=`${Z}:${S(St[Z])},`;return`${j}}`}function D(St){let j="";for(const Z of I.refProperties)j+=`/${S(St[Z])}`;return j}class O{constructor(j){this.keyCache={},j&&this.replace(j)}replace(j,Z){this._layerConfigs={},this._layers={},this.update(j,[],Z)}update(j,Z,Y){this._options=Y;for(const _t of j)this._layerConfigs[_t.id]=_t,(this._layers[_t.id]=I.createStyleLayer(_t,this._options)).compileFilter(),this.keyCache[_t.id]&&delete this.keyCache[_t.id];for(const _t of Z)delete this.keyCache[_t],delete this._layerConfigs[_t],delete this._layers[_t];this.familiesBySource={};const mt=function(_t,Xt){const $t={};for(let ie=0;ie<_t.length;ie++){const oe=Xt&&Xt[_t[ie].id]||D(_t[ie]);Xt&&(Xt[_t[ie].id]=oe);let pe=$t[oe];pe||(pe=$t[oe]=[]),pe.push(_t[ie])}const gt=[];for(const ie in $t)gt.push($t[ie]);return gt}(I.values(this._layerConfigs),this.keyCache);for(const _t of mt){const Xt=_t.map(yr=>this._layers[yr.id]),$t=Xt[0];if($t.visibility==="none")continue;const gt=$t.source||"";let ie=this.familiesBySource[gt];ie||(ie=this.familiesBySource[gt]={});const oe=$t.sourceLayer||"_geojsonTileLayer";let pe=ie[oe];pe||(pe=ie[oe]=[]),pe.push(Xt)}}}class B{loadTile(j,Z){const{uid:Y,encoding:mt,rawImageData:_t,padding:Xt,buildQuadTree:$t}=j,gt=I.window.ImageBitmap&&_t instanceof I.window.ImageBitmap?this.getImageData(_t,Xt):_t;Z(null,new I.DEMData(Y,gt,mt,Xt<1,$t))}getImageData(j,Z){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(j.width,j.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=j.width,this.offscreenCanvas.height=j.height,this.offscreenCanvasContext.drawImage(j,0,0,j.width,j.height);const Y=this.offscreenCanvasContext.getImageData(-Z,-Z,j.width+2*Z,j.height+2*Z);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Y}}function W(St,j){if(St.length!==0){et(St[0],j);for(var Z=1;Z<St.length;Z++)et(St[Z],!j)}}function et(St,j){for(var Z=0,Y=0,mt=0,_t=St.length,Xt=_t-1;mt<_t;Xt=mt++){var $t=(St[mt][0]-St[Xt][0])*(St[Xt][1]+St[mt][1]),gt=Z+$t;Y+=Math.abs(Z)>=Math.abs($t)?Z-gt+$t:$t-gt+Z,Z=gt}Z+Y>=0!=!!j&&St.reverse()}var it=I.getDefaultExportFromCjs(function St(j,Z){var Y,mt=j&&j.type;if(mt==="FeatureCollection")for(Y=0;Y<j.features.length;Y++)St(j.features[Y],Z);else if(mt==="GeometryCollection")for(Y=0;Y<j.geometries.length;Y++)St(j.geometries[Y],Z);else if(mt==="Feature")St(j.geometry,Z);else if(mt==="Polygon")W(j.coordinates,Z);else if(mt==="MultiPolygon")for(Y=0;Y<j.coordinates.length;Y++)W(j.coordinates[Y],Z);return j});const bt=I.VectorTileFeature.prototype.toGeoJSON;var ft={exports:{}},Pt=I.pointGeometry,kt=I.vectorTile.VectorTileFeature,Nt=ne;function ne(St,j){this.options=j||{},this.features=St,this.length=St.length}function Te(St,j){this.id=typeof St.id=="number"?St.id:void 0,this.type=St.type,this.rawGeometry=St.type===1?[St.geometry]:St.geometry,this.properties=St.tags,this.extent=j||4096}ne.prototype.feature=function(St){return new Te(this.features[St],this.options.extent)},Te.prototype.loadGeometry=function(){var St=this.rawGeometry;this.geometry=[];for(var j=0;j<St.length;j++){for(var Z=St[j],Y=[],mt=0;mt<Z.length;mt++)Y.push(new Pt(Z[mt][0],Z[mt][1]));this.geometry.push(Y)}return this.geometry},Te.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var St=this.geometry,j=1/0,Z=-1/0,Y=1/0,mt=-1/0,_t=0;_t<St.length;_t++)for(var Xt=St[_t],$t=0;$t<Xt.length;$t++){var gt=Xt[$t];j=Math.min(j,gt.x),Z=Math.max(Z,gt.x),Y=Math.min(Y,gt.y),mt=Math.max(mt,gt.y)}return[j,Y,Z,mt]},Te.prototype.toGeoJSON=kt.prototype.toGeoJSON;var we=I.pbf,Ve=Nt;function Ne(St){var j=new we;return function(Z,Y){for(var mt in Z.layers)Y.writeMessage(3,H,Z.layers[mt])}(St,j),j.finish()}function H(St,j){var Z;j.writeVarintField(15,St.version||1),j.writeStringField(1,St.name||""),j.writeVarintField(5,St.extent||4096);var Y={keys:[],values:[],keycache:{},valuecache:{}};for(Z=0;Z<St.length;Z++)Y.feature=St.feature(Z),j.writeMessage(2,ue,Y);var mt=Y.keys;for(Z=0;Z<mt.length;Z++)j.writeStringField(3,mt[Z]);var _t=Y.values;for(Z=0;Z<_t.length;Z++)j.writeMessage(4,ir,_t[Z])}function ue(St,j){var Z=St.feature;Z.id!==void 0&&j.writeVarintField(1,Z.id),j.writeMessage(2,Tr,St),j.writeVarintField(3,Z.type),j.writeMessage(4,qt,Z)}function Tr(St,j){var Z=St.feature,Y=St.keys,mt=St.values,_t=St.keycache,Xt=St.valuecache;for(var $t in Z.properties){var gt=Z.properties[$t],ie=_t[$t];if(gt!==null){ie===void 0&&(Y.push($t),_t[$t]=ie=Y.length-1),j.writeVarint(ie);var oe=typeof gt;oe!=="string"&&oe!=="boolean"&&oe!=="number"&&(gt=JSON.stringify(gt));var pe=oe+":"+gt,yr=Xt[pe];yr===void 0&&(mt.push(gt),Xt[pe]=yr=mt.length-1),j.writeVarint(yr)}}}function Ir(St,j){return(j<<3)+(7&St)}function re(St){return St<<1^St>>31}function qt(St,j){for(var Z=St.loadGeometry(),Y=St.type,mt=0,_t=0,Xt=Z.length,$t=0;$t<Xt;$t++){var gt=Z[$t],ie=1;Y===1&&(ie=gt.length),j.writeVarint(Ir(1,ie));for(var oe=Y===3?gt.length-1:gt.length,pe=0;pe<oe;pe++){pe===1&&Y!==1&&j.writeVarint(Ir(2,oe-1));var yr=gt[pe].x-mt,Pn=gt[pe].y-_t;j.writeVarint(re(yr)),j.writeVarint(re(Pn)),mt+=yr,_t+=Pn}Y===3&&j.writeVarint(Ir(7,1))}}function ir(St,j){var Z=typeof St;Z==="string"?j.writeStringField(1,St):Z==="boolean"?j.writeBooleanField(7,St):Z==="number"&&(St%1!=0?j.writeDoubleField(3,St):St<0?j.writeSVarintField(6,St):j.writeVarintField(5,St))}ft.exports=Ne,ft.exports.fromVectorTileJs=Ne,ft.exports.fromGeojsonVt=function(St,j){j=j||{};var Z={};for(var Y in St)Z[Y]=new Ve(St[Y].features,j),Z[Y].name=Y,Z[Y].version=j.version,Z[Y].extent=j.extent;return Ne({layers:Z})},ft.exports.GeoJSONWrapper=Ve;var Sr=I.getDefaultExportFromCjs(ft.exports);const Mn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:St=>St},An=Math.fround||(Bn=new Float32Array(1),St=>(Bn[0]=+St,Bn[0]));var Bn;const ai=3,Bt=5,Ti=6;class Vn{constructor(j){this.options=Object.assign(Object.create(Mn),j),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(j){const{log:Z,minZoom:Y,maxZoom:mt}=this.options;Z&&console.time("total time");const _t=`prepare ${j.length} points`;Z&&console.time(_t),this.points=j;const Xt=[];for(let gt=0;gt<j.length;gt++){const ie=j[gt];if(!ie.geometry)continue;const[oe,pe]=ie.geometry.coordinates,yr=An(Yt(oe)),Pn=An(Zi(pe));Xt.push(yr,Pn,1/0,gt,-1,1),this.options.reduce&&Xt.push(0)}let $t=this.trees[mt+1]=this._createTree(Xt);Z&&console.timeEnd(_t);for(let gt=mt;gt>=Y;gt--){const ie=+Date.now();$t=this.trees[gt]=this._createTree(this._cluster($t,gt)),Z&&console.log("z%d: %d clusters in %dms",gt,$t.numItems,+Date.now()-ie)}return Z&&console.timeEnd("total time"),this}getClusters(j,Z){let Y=((j[0]+180)%360+360)%360-180;const mt=Math.max(-90,Math.min(90,j[1]));let _t=j[2]===180?180:((j[2]+180)%360+360)%360-180;const Xt=Math.max(-90,Math.min(90,j[3]));if(j[2]-j[0]>=360)Y=-180,_t=180;else if(Y>_t){const pe=this.getClusters([Y,mt,180,Xt],Z),yr=this.getClusters([-180,mt,_t,Xt],Z);return pe.concat(yr)}const $t=this.trees[this._limitZoom(Z)],gt=$t.range(Yt(Y),Zi(Xt),Yt(_t),Zi(mt)),ie=$t.data,oe=[];for(const pe of gt){const yr=this.stride*pe;oe.push(ie[yr+Bt]>1?Lo(ie,yr,this.clusterProps):this.points[ie[yr+ai]])}return oe}getChildren(j){const Z=this._getOriginId(j),Y=this._getOriginZoom(j),mt="No cluster with the specified id.",_t=this.trees[Y];if(!_t)throw new Error(mt);const Xt=_t.data;if(Z*this.stride>=Xt.length)throw new Error(mt);const $t=this.options.radius/(this.options.extent*Math.pow(2,Y-1)),gt=_t.within(Xt[Z*this.stride],Xt[Z*this.stride+1],$t),ie=[];for(const oe of gt){const pe=oe*this.stride;Xt[pe+4]===j&&ie.push(Xt[pe+Bt]>1?Lo(Xt,pe,this.clusterProps):this.points[Xt[pe+ai]])}if(ie.length===0)throw new Error(mt);return ie}getLeaves(j,Z,Y){const mt=[];return this._appendLeaves(mt,j,Z=Z||10,Y=Y||0,0),mt}getTile(j,Z,Y){const mt=this.trees[this._limitZoom(j)],_t=Math.pow(2,j),{extent:Xt,radius:$t}=this.options,gt=$t/Xt,ie=(Y-gt)/_t,oe=(Y+1+gt)/_t,pe={features:[]};return this._addTileFeatures(mt.range((Z-gt)/_t,ie,(Z+1+gt)/_t,oe),mt.data,Z,Y,_t,pe),Z===0&&this._addTileFeatures(mt.range(1-gt/_t,ie,1,oe),mt.data,_t,Y,_t,pe),Z===_t-1&&this._addTileFeatures(mt.range(0,ie,gt/_t,oe),mt.data,-1,Y,_t,pe),pe.features.length?pe:null}getClusterExpansionZoom(j){let Z=this._getOriginZoom(j)-1;for(;Z<=this.options.maxZoom;){const Y=this.getChildren(j);if(Z++,Y.length!==1)break;j=Y[0].properties.cluster_id}return Z}_appendLeaves(j,Z,Y,mt,_t){const Xt=this.getChildren(Z);for(const $t of Xt){const gt=$t.properties;if(gt&&gt.cluster?_t+gt.point_count<=mt?_t+=gt.point_count:_t=this._appendLeaves(j,gt.cluster_id,Y,mt,_t):_t<mt?_t++:j.push($t),j.length===Y)break}return _t}_createTree(j){const Z=new I.KDBush(j.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Y=0;Y<j.length;Y+=this.stride)Z.add(j[Y],j[Y+1]);return Z.finish(),Z.data=j,Z}_addTileFeatures(j,Z,Y,mt,_t,Xt){for(const $t of j){const gt=$t*this.stride,ie=Z[gt+Bt]>1;let oe,pe,yr;if(ie)oe=ho(Z,gt,this.clusterProps),pe=Z[gt],yr=Z[gt+1];else{const Wr=this.points[Z[gt+ai]];oe=Wr.properties;const[Qr,Ur]=Wr.geometry.coordinates;pe=Yt(Qr),yr=Zi(Ur)}const Pn={type:1,geometry:[[Math.round(this.options.extent*(pe*_t-Y)),Math.round(this.options.extent*(yr*_t-mt))]],tags:oe};let Jr;Jr=ie||this.options.generateId?Z[gt+ai]:this.points[Z[gt+ai]].id,Jr!==void 0&&(Pn.id=Jr),Xt.features.push(Pn)}}_limitZoom(j){return Math.max(this.options.minZoom,Math.min(Math.floor(+j),this.options.maxZoom+1))}_cluster(j,Z){const{radius:Y,extent:mt,reduce:_t,minPoints:Xt}=this.options,$t=Y/(mt*Math.pow(2,Z)),gt=j.data,ie=[],oe=this.stride;for(let pe=0;pe<gt.length;pe+=oe){if(gt[pe+2]<=Z)continue;gt[pe+2]=Z;const yr=gt[pe],Pn=gt[pe+1],Jr=j.within(gt[pe],gt[pe+1],$t),Wr=gt[pe+Bt];let Qr=Wr;for(const Ur of Jr){const _i=Ur*oe;gt[_i+2]>Z&&(Qr+=gt[_i+Bt])}if(Qr>Wr&&Qr>=Xt){let Ur,_i=yr*Wr,Li=Pn*Wr,Oa=-1;const Ii=((pe/oe|0)<<5)+(Z+1)+this.points.length;for(const Na of Jr){const Do=Na*oe;if(gt[Do+2]<=Z)continue;gt[Do+2]=Z;const ss=gt[Do+Bt];_i+=gt[Do]*ss,Li+=gt[Do+1]*ss,gt[Do+4]=Ii,_t&&(Ur||(Ur=this._map(gt,pe,!0),Oa=this.clusterProps.length,this.clusterProps.push(Ur)),_t(Ur,this._map(gt,Do)))}gt[pe+4]=Ii,ie.push(_i/Qr,Li/Qr,1/0,Ii,-1,Qr),_t&&ie.push(Oa)}else{for(let Ur=0;Ur<oe;Ur++)ie.push(gt[pe+Ur]);if(Qr>1)for(const Ur of Jr){const _i=Ur*oe;if(!(gt[_i+2]<=Z)){gt[_i+2]=Z;for(let Li=0;Li<oe;Li++)ie.push(gt[_i+Li])}}}}return ie}_getOriginId(j){return j-this.points.length>>5}_getOriginZoom(j){return(j-this.points.length)%32}_map(j,Z,Y){if(j[Z+Bt]>1){const Xt=this.clusterProps[j[Z+Ti]];return Y?Object.assign({},Xt):Xt}const mt=this.points[j[Z+ai]].properties,_t=this.options.map(mt);return Y&&_t===mt?Object.assign({},_t):_t}}function Lo(St,j,Z){return{type:"Feature",id:St[j+ai],properties:ho(St,j,Z),geometry:{type:"Point",coordinates:[(Y=St[j],360*(Y-.5)),hm(St[j+1])]}};var Y}function ho(St,j,Z){const Y=St[j+Bt],mt=Y>=1e4?`${Math.round(Y/1e3)}k`:Y>=1e3?Math.round(Y/100)/10+"k":Y,_t=St[j+Ti],Xt=_t===-1?{}:Object.assign({},Z[_t]);return Object.assign(Xt,{cluster:!0,cluster_id:St[j+ai],point_count:Y,point_count_abbreviated:mt})}function Yt(St){return St/360+.5}function Zi(St){const j=Math.sin(St*Math.PI/180),Z=.5-.25*Math.log((1+j)/(1-j))/Math.PI;return Z<0?0:Z>1?1:Z}function hm(St){const j=(180-360*St)*Math.PI/180;return 360*Math.atan(Math.exp(j))/Math.PI-90}var gu={exports:{}};gu.exports=function(){function St(ht,ct,vt,Mt){for(var Ct,Lt=Mt,Dt=vt-ct>>1,At=vt-ct,Wt=ht[ct],Rt=ht[ct+1],Ie=ht[vt],Ke=ht[vt+1],ee=ct+3;ee<vt;ee+=3){var Pr=j(ht[ee],ht[ee+1],Wt,Rt,Ie,Ke);if(Pr>Lt)Ct=ee,Lt=Pr;else if(Pr===Lt){var br=Math.abs(ee-Dt);br<At&&(Ct=ee,At=br)}}Lt>Mt&&(Ct-ct>3&&St(ht,ct,Ct,Mt),ht[Ct+2]=Lt,vt-Ct>3&&St(ht,Ct,vt,Mt))}function j(ht,ct,vt,Mt,Ct,Lt){var Dt=Ct-vt,At=Lt-Mt;if(Dt!==0||At!==0){var Wt=((ht-vt)*Dt+(ct-Mt)*At)/(Dt*Dt+At*At);Wt>1?(vt=Ct,Mt=Lt):Wt>0&&(vt+=Dt*Wt,Mt+=At*Wt)}return(Dt=ht-vt)*Dt+(At=ct-Mt)*At}function Z(ht,ct,vt,Mt){var Ct={id:ht===void 0?null:ht,type:ct,geometry:vt,tags:Mt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Lt){var Dt=Lt.geometry,At=Lt.type;if(At==="Point"||At==="MultiPoint"||At==="LineString")Y(Lt,Dt);else if(At==="Polygon"||At==="MultiLineString")for(var Wt=0;Wt<Dt.length;Wt++)Y(Lt,Dt[Wt]);else if(At==="MultiPolygon")for(Wt=0;Wt<Dt.length;Wt++)for(var Rt=0;Rt<Dt[Wt].length;Rt++)Y(Lt,Dt[Wt][Rt])}(Ct),Ct}function Y(ht,ct){for(var vt=0;vt<ct.length;vt+=3)ht.minX=Math.min(ht.minX,ct[vt]),ht.minY=Math.min(ht.minY,ct[vt+1]),ht.maxX=Math.max(ht.maxX,ct[vt]),ht.maxY=Math.max(ht.maxY,ct[vt+1])}function mt(ht,ct,vt,Mt){if(ct.geometry){var Ct=ct.geometry.coordinates,Lt=ct.geometry.type,Dt=Math.pow(vt.tolerance/((1<<vt.maxZoom)*vt.extent),2),At=[],Wt=ct.id;if(vt.promoteId?Wt=ct.properties[vt.promoteId]:vt.generateId&&(Wt=Mt||0),Lt==="Point")_t(Ct,At);else if(Lt==="MultiPoint")for(var Rt=0;Rt<Ct.length;Rt++)_t(Ct[Rt],At);else if(Lt==="LineString")Xt(Ct,At,Dt,!1);else if(Lt==="MultiLineString"){if(vt.lineMetrics){for(Rt=0;Rt<Ct.length;Rt++)Xt(Ct[Rt],At=[],Dt,!1),ht.push(Z(Wt,"LineString",At,ct.properties));return}$t(Ct,At,Dt,!1)}else if(Lt==="Polygon")$t(Ct,At,Dt,!0);else{if(Lt!=="MultiPolygon"){if(Lt==="GeometryCollection"){for(Rt=0;Rt<ct.geometry.geometries.length;Rt++)mt(ht,{id:Wt,geometry:ct.geometry.geometries[Rt],properties:ct.properties},vt,Mt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Rt=0;Rt<Ct.length;Rt++){var Ie=[];$t(Ct[Rt],Ie,Dt,!0),At.push(Ie)}}ht.push(Z(Wt,Lt,At,ct.properties))}}function _t(ht,ct){ct.push(gt(ht[0])),ct.push(ie(ht[1])),ct.push(0)}function Xt(ht,ct,vt,Mt){for(var Ct,Lt,Dt=0,At=0;At<ht.length;At++){var Wt=gt(ht[At][0]),Rt=ie(ht[At][1]);ct.push(Wt),ct.push(Rt),ct.push(0),At>0&&(Dt+=Mt?(Ct*Rt-Wt*Lt)/2:Math.sqrt(Math.pow(Wt-Ct,2)+Math.pow(Rt-Lt,2))),Ct=Wt,Lt=Rt}var Ie=ct.length-3;ct[2]=1,St(ct,0,Ie,vt),ct[Ie+2]=1,ct.size=Math.abs(Dt),ct.start=0,ct.end=ct.size}function $t(ht,ct,vt,Mt){for(var Ct=0;Ct<ht.length;Ct++){var Lt=[];Xt(ht[Ct],Lt,vt,Mt),ct.push(Lt)}}function gt(ht){return ht/360+.5}function ie(ht){var ct=Math.sin(ht*Math.PI/180),vt=.5-.25*Math.log((1+ct)/(1-ct))/Math.PI;return vt<0?0:vt>1?1:vt}function oe(ht,ct,vt,Mt,Ct,Lt,Dt,At){if(Mt/=ct,Lt>=(vt/=ct)&&Dt<Mt)return ht;if(Dt<vt||Lt>=Mt)return null;for(var Wt=[],Rt=0;Rt<ht.length;Rt++){var Ie=ht[Rt],Ke=Ie.geometry,ee=Ie.type,Pr=Ct===0?Ie.minX:Ie.minY,br=Ct===0?Ie.maxX:Ie.maxY;if(Pr>=vt&&br<Mt)Wt.push(Ie);else if(!(br<vt||Pr>=Mt)){var Gr=[];if(ee==="Point"||ee==="MultiPoint")pe(Ke,Gr,vt,Mt,Ct);else if(ee==="LineString")yr(Ke,Gr,vt,Mt,Ct,!1,At.lineMetrics);else if(ee==="MultiLineString")Jr(Ke,Gr,vt,Mt,Ct,!1);else if(ee==="Polygon")Jr(Ke,Gr,vt,Mt,Ct,!0);else if(ee==="MultiPolygon")for(var vn=0;vn<Ke.length;vn++){var yi=[];Jr(Ke[vn],yi,vt,Mt,Ct,!0),yi.length&&Gr.push(yi)}if(Gr.length){if(At.lineMetrics&&ee==="LineString"){for(vn=0;vn<Gr.length;vn++)Wt.push(Z(Ie.id,ee,Gr[vn],Ie.tags));continue}ee!=="LineString"&&ee!=="MultiLineString"||(Gr.length===1?(ee="LineString",Gr=Gr[0]):ee="MultiLineString"),ee!=="Point"&&ee!=="MultiPoint"||(ee=Gr.length===3?"Point":"MultiPoint"),Wt.push(Z(Ie.id,ee,Gr,Ie.tags))}}}return Wt.length?Wt:null}function pe(ht,ct,vt,Mt,Ct){for(var Lt=0;Lt<ht.length;Lt+=3){var Dt=ht[Lt+Ct];Dt>=vt&&Dt<=Mt&&(ct.push(ht[Lt]),ct.push(ht[Lt+1]),ct.push(ht[Lt+2]))}}function yr(ht,ct,vt,Mt,Ct,Lt,Dt){for(var At,Wt,Rt=Pn(ht),Ie=Ct===0?Qr:Ur,Ke=ht.start,ee=0;ee<ht.length-3;ee+=3){var Pr=ht[ee],br=ht[ee+1],Gr=ht[ee+2],vn=ht[ee+3],yi=ht[ee+4],po=Ct===0?Pr:br,Ro=Ct===0?vn:yi,Un=!1;Dt&&(At=Math.sqrt(Math.pow(Pr-vn,2)+Math.pow(br-yi,2))),po<vt?Ro>vt&&(Wt=Ie(Rt,Pr,br,vn,yi,vt),Dt&&(Rt.start=Ke+At*Wt)):po>Mt?Ro<Mt&&(Wt=Ie(Rt,Pr,br,vn,yi,Mt),Dt&&(Rt.start=Ke+At*Wt)):Wr(Rt,Pr,br,Gr),Ro<vt&&po>=vt&&(Wt=Ie(Rt,Pr,br,vn,yi,vt),Un=!0),Ro>Mt&&po<=Mt&&(Wt=Ie(Rt,Pr,br,vn,yi,Mt),Un=!0),!Lt&&Un&&(Dt&&(Rt.end=Ke+At*Wt),ct.push(Rt),Rt=Pn(ht)),Dt&&(Ke+=At)}var Gn=ht.length-3;Pr=ht[Gn],br=ht[Gn+1],Gr=ht[Gn+2],(po=Ct===0?Pr:br)>=vt&&po<=Mt&&Wr(Rt,Pr,br,Gr),Gn=Rt.length-3,Lt&&Gn>=3&&(Rt[Gn]!==Rt[0]||Rt[Gn+1]!==Rt[1])&&Wr(Rt,Rt[0],Rt[1],Rt[2]),Rt.length&&ct.push(Rt)}function Pn(ht){var ct=[];return ct.size=ht.size,ct.start=ht.start,ct.end=ht.end,ct}function Jr(ht,ct,vt,Mt,Ct,Lt){for(var Dt=0;Dt<ht.length;Dt++)yr(ht[Dt],ct,vt,Mt,Ct,Lt,!1)}function Wr(ht,ct,vt,Mt){ht.push(ct),ht.push(vt),ht.push(Mt)}function Qr(ht,ct,vt,Mt,Ct,Lt){var Dt=(Lt-ct)/(Mt-ct);return ht.push(Lt),ht.push(vt+(Ct-vt)*Dt),ht.push(1),Dt}function Ur(ht,ct,vt,Mt,Ct,Lt){var Dt=(Lt-vt)/(Ct-vt);return ht.push(ct+(Mt-ct)*Dt),ht.push(Lt),ht.push(1),Dt}function _i(ht,ct){for(var vt=[],Mt=0;Mt<ht.length;Mt++){var Ct,Lt=ht[Mt],Dt=Lt.type;if(Dt==="Point"||Dt==="MultiPoint"||Dt==="LineString")Ct=Li(Lt.geometry,ct);else if(Dt==="MultiLineString"||Dt==="Polygon"){Ct=[];for(var At=0;At<Lt.geometry.length;At++)Ct.push(Li(Lt.geometry[At],ct))}else if(Dt==="MultiPolygon")for(Ct=[],At=0;At<Lt.geometry.length;At++){for(var Wt=[],Rt=0;Rt<Lt.geometry[At].length;Rt++)Wt.push(Li(Lt.geometry[At][Rt],ct));Ct.push(Wt)}vt.push(Z(Lt.id,Dt,Ct,Lt.tags))}return vt}function Li(ht,ct){var vt=[];vt.size=ht.size,ht.start!==void 0&&(vt.start=ht.start,vt.end=ht.end);for(var Mt=0;Mt<ht.length;Mt+=3)vt.push(ht[Mt]+ct,ht[Mt+1],ht[Mt+2]);return vt}function Oa(ht,ct){if(ht.transformed)return ht;var vt,Mt,Ct,Lt=1<<ht.z,Dt=ht.x,At=ht.y;for(vt=0;vt<ht.features.length;vt++){var Wt=ht.features[vt],Rt=Wt.geometry,Ie=Wt.type;if(Wt.geometry=[],Ie===1)for(Mt=0;Mt<Rt.length;Mt+=2)Wt.geometry.push(Ii(Rt[Mt],Rt[Mt+1],ct,Lt,Dt,At));else for(Mt=0;Mt<Rt.length;Mt++){var Ke=[];for(Ct=0;Ct<Rt[Mt].length;Ct+=2)Ke.push(Ii(Rt[Mt][Ct],Rt[Mt][Ct+1],ct,Lt,Dt,At));Wt.geometry.push(Ke)}}return ht.transformed=!0,ht}function Ii(ht,ct,vt,Mt,Ct,Lt){return[Math.round(vt*(ht*Mt-Ct)),Math.round(vt*(ct*Mt-Lt))]}function Na(ht,ct,vt,Mt,Ct){for(var Lt=ct===Ct.maxZoom?0:Ct.tolerance/((1<<ct)*Ct.extent),Dt={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:vt,y:Mt,z:ct,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},At=0;At<ht.length;At++){Dt.numFeatures++,Do(Dt,ht[At],Lt,Ct);var Wt=ht[At].minX,Rt=ht[At].minY,Ie=ht[At].maxX,Ke=ht[At].maxY;Wt<Dt.minX&&(Dt.minX=Wt),Rt<Dt.minY&&(Dt.minY=Rt),Ie>Dt.maxX&&(Dt.maxX=Ie),Ke>Dt.maxY&&(Dt.maxY=Ke)}return Dt}function Do(ht,ct,vt,Mt){var Ct=ct.geometry,Lt=ct.type,Dt=[];if(Lt==="Point"||Lt==="MultiPoint")for(var At=0;At<Ct.length;At+=3)Dt.push(Ct[At]),Dt.push(Ct[At+1]),ht.numPoints++,ht.numSimplified++;else if(Lt==="LineString")ss(Dt,Ct,ht,vt,!1,!1);else if(Lt==="MultiLineString"||Lt==="Polygon")for(At=0;At<Ct.length;At++)ss(Dt,Ct[At],ht,vt,Lt==="Polygon",At===0);else if(Lt==="MultiPolygon")for(var Wt=0;Wt<Ct.length;Wt++){var Rt=Ct[Wt];for(At=0;At<Rt.length;At++)ss(Dt,Rt[At],ht,vt,!0,At===0)}if(Dt.length){var Ie=ct.tags||null;if(Lt==="LineString"&&Mt.lineMetrics){for(var Ke in Ie={},ct.tags)Ie[Ke]=ct.tags[Ke];Ie.mapbox_clip_start=Ct.start/Ct.size,Ie.mapbox_clip_end=Ct.end/Ct.size}var ee={geometry:Dt,type:Lt==="Polygon"||Lt==="MultiPolygon"?3:Lt==="LineString"||Lt==="MultiLineString"?2:1,tags:Ie};ct.id!==null&&(ee.id=ct.id),ht.features.push(ee)}}function ss(ht,ct,vt,Mt,Ct,Lt){var Dt=Mt*Mt;if(Mt>0&&ct.size<(Ct?Dt:Mt))vt.numPoints+=ct.length/3;else{for(var At=[],Wt=0;Wt<ct.length;Wt+=3)(Mt===0||ct[Wt+2]>Dt)&&(vt.numSimplified++,At.push(ct[Wt]),At.push(ct[Wt+1])),vt.numPoints++;Ct&&function(Rt,Ie){for(var Ke=0,ee=0,Pr=Rt.length,br=Pr-2;ee<Pr;br=ee,ee+=2)Ke+=(Rt[ee]-Rt[br])*(Rt[ee+1]+Rt[br+1]);if(Ke>0===Ie)for(ee=0,Pr=Rt.length;ee<Pr/2;ee+=2){var Gr=Rt[ee],vn=Rt[ee+1];Rt[ee]=Rt[Pr-2-ee],Rt[ee+1]=Rt[Pr-1-ee],Rt[Pr-2-ee]=Gr,Rt[Pr-1-ee]=vn}}(At,Lt),ht.push(At)}}function Pl(ht,ct){var vt=(ct=this.options=function(Ct,Lt){for(var Dt in Lt)Ct[Dt]=Lt[Dt];return Ct}(Object.create(this.options),ct)).debug;if(vt&&console.time("preprocess data"),ct.maxZoom<0||ct.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(ct.promoteId&&ct.generateId)throw new Error("promoteId and generateId cannot be used together.");var Mt=function(Ct,Lt){var Dt=[];if(Ct.type==="FeatureCollection")for(var At=0;At<Ct.features.length;At++)mt(Dt,Ct.features[At],Lt,At);else mt(Dt,Ct.type==="Feature"?Ct:{geometry:Ct},Lt);return Dt}(ht,ct);this.tiles={},this.tileCoords=[],vt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",ct.indexMaxZoom,ct.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(Mt=function(Ct,Lt){var Dt=Lt.buffer/Lt.extent,At=Ct,Wt=oe(Ct,1,-1-Dt,Dt,0,-1,2,Lt),Rt=oe(Ct,1,1-Dt,2+Dt,0,-1,2,Lt);return(Wt||Rt)&&(At=oe(Ct,1,-Dt,1+Dt,0,-1,2,Lt)||[],Wt&&(At=_i(Wt,1).concat(At)),Rt&&(At=At.concat(_i(Rt,-1)))),At}(Mt,ct)).length&&this.splitTile(Mt,0,0,0),vt&&(Mt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Ll(ht,ct,vt){return 32*((1<<ht)*vt+ct)+ht}return Pl.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Pl.prototype.splitTile=function(ht,ct,vt,Mt,Ct,Lt,Dt){for(var At=[ht,ct,vt,Mt],Wt=this.options,Rt=Wt.debug;At.length;){Mt=At.pop(),vt=At.pop(),ct=At.pop(),ht=At.pop();var Ie=1<<ct,Ke=Ll(ct,vt,Mt),ee=this.tiles[Ke];if(!ee&&(Rt>1&&console.time("creation"),ee=this.tiles[Ke]=Na(ht,ct,vt,Mt,Wt),this.tileCoords.push({z:ct,x:vt,y:Mt}),Rt)){Rt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",ct,vt,Mt,ee.numFeatures,ee.numPoints,ee.numSimplified),console.timeEnd("creation"));var Pr="z"+ct;this.stats[Pr]=(this.stats[Pr]||0)+1,this.total++}if(ee.source=ht,Ct){if(ct===Wt.maxZoom||ct===Ct)continue;var br=1<<Ct-ct;if(vt!==Math.floor(Lt/br)||Mt!==Math.floor(Dt/br))continue}else if(ct===Wt.indexMaxZoom||ee.numPoints<=Wt.indexMaxPoints)continue;if(ee.source=null,ht.length!==0){Rt>1&&console.time("clipping");var Gr,vn,yi,po,Ro,Un,Gn=.5*Wt.buffer/Wt.extent,vu=.5-Gn,xu=.5+Gn,za=1+Gn;Gr=vn=yi=po=null,Ro=oe(ht,Ie,vt-Gn,vt+xu,0,ee.minX,ee.maxX,Wt),Un=oe(ht,Ie,vt+vu,vt+za,0,ee.minX,ee.maxX,Wt),ht=null,Ro&&(Gr=oe(Ro,Ie,Mt-Gn,Mt+xu,1,ee.minY,ee.maxY,Wt),vn=oe(Ro,Ie,Mt+vu,Mt+za,1,ee.minY,ee.maxY,Wt),Ro=null),Un&&(yi=oe(Un,Ie,Mt-Gn,Mt+xu,1,ee.minY,ee.maxY,Wt),po=oe(Un,Ie,Mt+vu,Mt+za,1,ee.minY,ee.maxY,Wt),Un=null),Rt>1&&console.timeEnd("clipping"),At.push(Gr||[],ct+1,2*vt,2*Mt),At.push(vn||[],ct+1,2*vt,2*Mt+1),At.push(yi||[],ct+1,2*vt+1,2*Mt),At.push(po||[],ct+1,2*vt+1,2*Mt+1)}}},Pl.prototype.getTile=function(ht,ct,vt){var Mt=this.options,Ct=Mt.extent,Lt=Mt.debug;if(ht<0||ht>24)return null;var Dt=1<<ht,At=Ll(ht,ct=(ct%Dt+Dt)%Dt,vt);if(this.tiles[At])return Oa(this.tiles[At],Ct);Lt>1&&console.log("drilling down to z%d-%d-%d",ht,ct,vt);for(var Wt,Rt=ht,Ie=ct,Ke=vt;!Wt&&Rt>0;)Rt--,Ie=Math.floor(Ie/2),Ke=Math.floor(Ke/2),Wt=this.tiles[Ll(Rt,Ie,Ke)];return Wt&&Wt.source?(Lt>1&&console.log("found parent tile z%d-%d-%d",Rt,Ie,Ke),Lt>1&&console.time("drilling down"),this.splitTile(Wt.source,Rt,Ie,Ke,ht,ct,vt),Lt>1&&console.timeEnd("drilling down"),this.tiles[At]?Oa(this.tiles[At],Ct):null):null},function(ht,ct){return new Pl(ht,ct)}}();var Ep=I.getDefaultExportFromCjs(gu.exports);function Tp(St,j){const Z=St.tileID.canonical;if(!this._geoJSONIndex)return j(null,null);const Y=this._geoJSONIndex.getTile(Z.z,Z.x,Z.y);if(!Y)return j(null,null);const mt=new class{constructor(Xt){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=I.EXTENT,this.length=Xt.length,this._features=Xt}feature(Xt){return new class{constructor($t){this._feature=$t,this.extent=I.EXTENT,this.type=$t.type,this.properties=$t.tags,"id"in $t&&!isNaN($t.id)&&(this.id=parseInt($t.id,10))}loadGeometry(){if(this._feature.type===1){const $t=[];for(const gt of this._feature.geometry)$t.push([new I.Point(gt[0],gt[1])]);return $t}{const $t=[];for(const gt of this._feature.geometry){const ie=[];for(const oe of gt)ie.push(new I.Point(oe[0],oe[1]));$t.push(ie)}return $t}}toGeoJSON($t,gt,ie){return bt.call(this,$t,gt,ie)}}(this._features[Xt])}}(Y.features);let _t=Sr(mt);_t.byteOffset===0&&_t.byteLength===_t.buffer.byteLength||(_t=new Uint8Array(_t)),j(null,{vectorTile:mt,rawData:_t.buffer})}class Ip extends I.VectorTileWorkerSource{constructor(j,Z,Y,mt,_t,Xt){super(j,Z,Y,mt,Tp,Xt),_t&&(this.loadGeoJSON=_t)}loadData(j,Z){const Y=j&&j.request,mt=Y&&Y.collectResourceTiming;this.loadGeoJSON(j,(_t,Xt)=>{if(_t||!Xt)return Z(_t);if(typeof Xt!="object")return Z(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));{it(Xt,!0);try{if(j.filter){const gt=I.createExpression(j.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(gt.result==="error")throw new Error(gt.value.map(oe=>`${oe.key}: ${oe.message}`).join(", "));Xt={type:"FeatureCollection",features:Xt.features.filter(oe=>gt.value.evaluate({zoom:0},oe))}}this._geoJSONIndex=j.cluster?new Vn(function({superclusterOptions:gt,clusterProperties:ie}){if(!ie||!gt)return gt;const oe={},pe={},yr={accumulated:null,zoom:0},Pn={properties:null},Jr=Object.keys(ie);for(const Wr of Jr){const[Qr,Ur]=ie[Wr],_i=I.createExpression(Ur),Li=I.createExpression(typeof Qr=="string"?[Qr,["accumulated"],["get",Wr]]:Qr);oe[Wr]=_i.value,pe[Wr]=Li.value}return gt.map=Wr=>{Pn.properties=Wr;const Qr={};for(const Ur of Jr)Qr[Ur]=oe[Ur].evaluate(yr,Pn);return Qr},gt.reduce=(Wr,Qr)=>{Pn.properties=Qr;for(const Ur of Jr)yr.accumulated=Wr[Ur],Wr[Ur]=pe[Ur].evaluate(yr,Pn)},gt}(j)).load(Xt.features):Ep(Xt,j.geojsonVtOptions)}catch(gt){return Z(gt)}this.loaded={};const $t={};if(mt){const gt=I.getPerformanceMeasurement(Y);gt&&($t.resourceTiming={},$t.resourceTiming[j.source]=JSON.parse(JSON.stringify(gt)))}Z(null,$t)}})}reloadTile(j,Z){const Y=this.loaded;return Y&&Y[j.uid]?super.reloadTile(j,Z):this.loadTile(j,Z)}loadGeoJSON(j,Z){if(j.request)I.getJSON(j.request,Z);else{if(typeof j.data!="string")return Z(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));try{return Z(null,JSON.parse(j.data))}catch{return Z(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(j,Z){try{Z(null,this._geoJSONIndex.getClusterExpansionZoom(j.clusterId))}catch(Y){Z(Y)}}getClusterChildren(j,Z){try{Z(null,this._geoJSONIndex.getChildren(j.clusterId))}catch(Y){Z(Y)}}getClusterLeaves(j,Z){try{Z(null,this._geoJSONIndex.getLeaves(j.clusterId,j.limit,j.offset))}catch(Y){Z(Y)}}}class Ln{constructor(j,Z){this.tileID=new I.OverscaledTileID(j.tileID.overscaledZ,j.tileID.wrap,j.tileID.canonical.z,j.tileID.canonical.x,j.tileID.canonical.y),this.tileZoom=j.tileZoom,this.uid=j.uid,this.zoom=j.zoom,this.canonical=j.tileID.canonical,this.pixelRatio=j.pixelRatio,this.tileSize=j.tileSize,this.source=j.source,this.overscaling=this.tileID.overscaleFactor(),this.enableTerrain=!!j.enableTerrain,this.projection=j.projection,this.brightness=Z}async parse(j,Z,Y,mt){this.status="parsing";const _t=new I.OverscaledTileID(Y.tileID.overscaledZ,Y.tileID.wrap,Y.tileID.canonical.z,Y.tileID.canonical.x,Y.tileID.canonical.y),Xt={},$t=Z.familiesBySource[Y.source],gt=new I.FeatureIndex(_t,Y.promoteId);gt.bucketLayerIDs=[];const ie=await I.load3DTile(j),oe=I.convertB3dm(ie.gltf,1/I.tileToMeter(Y.tileID.canonical)),pe=ie.gltf.json.extensionsUsed&&ie.gltf.json.extensionsUsed.includes("MAPBOX_mesh_features");for(const yr in $t)for(const Pn of $t[yr]){const Jr=Pn[0],Wr=ie.gltf.json.extensionsUsed,Qr=new I.Tiled3dModelBucket(oe,_t,Wr&&Wr.includes("MAPBOX_mesh_features"),this.brightness);pe||(Qr.needsUpload=!0),Xt[Jr.id]=Qr}this.status="done",mt(null,{buckets:Xt,featureIndex:gt})}}class _u{constructor(j,Z,Y,mt,_t,Xt){this.actor=j,this.layerIndex=Z,this.brightness=Xt,this.loading={},this.loaded={}}loadTile(j,Z){const Y=j.uid,mt=this.loading[Y]=new Ln(j,this.brightness);I.getArrayBuffer(j.request,(_t,Xt)=>{const $t=!this.loading[Y];return delete this.loading[Y],$t||_t?(mt.status="done",$t||(this.loaded[Y]=mt),Z(_t)):Xt&&Xt.byteLength!==0?(mt.parse(Xt,this.layerIndex,j,Z),this.loaded=this.loaded||{},void(this.loaded[Y]=mt)):(mt.status="done",this.loaded[Y]=mt,Z())})}reloadTile(j,Z){const Y=this.loaded,mt=j.uid;if(Y&&Y[mt]){const _t=Y[mt];_t.enableTerrain=!!j.enableTerrain,_t.projection=j.projection,_t.brightness=j.brightness;const Xt=($t,gt)=>{_t.reloadCallback&&(delete _t.reloadCallback,this.loadTile(j,Z)),Z($t,gt)};_t.status==="parsing"?_t.reloadCallback=Xt:_t.status==="done"&&this.loadTile(j,Z)}}abortTile(j,Z){const Y=j.uid;this.loading[Y]&&delete this.loading[Y],Z()}removeTile(j,Z){const Y=this.loaded,mt=j.uid;Y&&Y[mt]&&delete Y[mt],Z()}}class yu{constructor(j){this.self=j,this.actor=new I.Actor(j,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=I.getProjection({name:"mercator"}),this.workerSourceTypes={vector:I.VectorTileWorkerSource,geojson:Ip,"batched-model":_u},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(Z,Y)=>{if(this.workerSourceTypes[Z])throw new Error(`Worker source with name "${Z}" already registered.`);this.workerSourceTypes[Z]=Y},this.self.registerRTLTextPlugin=Z=>{if(I.plugin.isParsed())throw new Error("RTL text plugin already registered.");I.plugin.applyArabicShaping=Z.applyArabicShaping,I.plugin.processBidirectionalText=Z.processBidirectionalText,I.plugin.processStyledBidirectionalText=Z.processStyledBidirectionalText}}clearCaches(j,Z,Y){delete this.layerIndexes[j],delete this.availableImages[j],delete this.workerSources[j],delete this.demWorkerSources[j],Y()}checkIfReady(j,Z,Y){Y()}setReferrer(j,Z){this.referrer=Z}spriteLoaded(j,Z){this.isSpriteLoaded[j]||(this.isSpriteLoaded[j]={}),this.isSpriteLoaded[j][Z.scope]=Z.isLoaded;for(const Y in this.workerSources[j]){const mt=this.workerSources[j][Y];for(const _t in mt)mt[_t]instanceof I.VectorTileWorkerSource&&(mt[_t].isSpriteLoaded=Z.isLoaded,mt[_t].fire(new I.Event("isSpriteLoaded")))}}setImages(j,Z,Y){const{scope:mt,images:_t}=Z;this.availableImages[j]||(this.availableImages[j]={}),this.availableImages[j][mt]=_t;for(const Xt in this.workerSources[j]){const $t=this.workerSources[j][Xt];for(const gt in $t)$t[gt].availableImages=_t}Y()}enableTerrain(j,Z,Y){this.terrain=Z,Y()}setProjection(j,Z){this.projections[j]=I.getProjection(Z)}setBrightness(j,Z,Y){this.brightness=Z,Y()}setLayers(j,Z,Y){this.getLayerIndex(j,Z.scope).replace(Z.layers,Z.options),Y()}updateLayers(j,Z,Y){this.getLayerIndex(j,Z.scope).update(Z.layers,Z.removedIds,Z.options),Y()}loadTile(j,Z,Y){const mt=this.enableTerrain?I.extend({enableTerrain:this.terrain},Z):Z;mt.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,Z.type,Z.source,Z.scope).loadTile(mt,Y)}loadDEMTile(j,Z,Y){const mt=this.enableTerrain?I.extend({buildQuadTree:this.terrain},Z):Z;this.getDEMWorkerSource(j,Z.source,Z.scope).loadTile(mt,Y)}reloadTile(j,Z,Y){const mt=this.enableTerrain?I.extend({enableTerrain:this.terrain},Z):Z;mt.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,Z.type,Z.source,Z.scope).reloadTile(mt,Y)}abortTile(j,Z,Y){this.getWorkerSource(j,Z.type,Z.source,Z.scope).abortTile(Z,Y)}removeTile(j,Z,Y){this.getWorkerSource(j,Z.type,Z.source,Z.scope).removeTile(Z,Y)}removeSource(j,Z,Y){if(!this.workerSources[j]||!this.workerSources[j][Z.type]||!this.workerSources[j][Z.type][Z.source])return;const mt=this.workerSources[j][Z.type][Z.source];delete this.workerSources[j][Z.type][Z.source],mt.removeSource!==void 0?mt.removeSource(Z,Y):Y()}loadWorkerSource(j,Z,Y){try{this.self.importScripts(Z.url),Y()}catch(mt){Y(mt.toString())}}syncRTLPluginState(j,Z,Y){try{I.plugin.setState(Z);const mt=I.plugin.getPluginURL();if(I.plugin.isLoaded()&&!I.plugin.isParsed()&&mt!=null){this.self.importScripts(mt);const _t=I.plugin.isParsed();Y(_t?void 0:new Error(`RTL Text Plugin failed to import scripts from ${mt}`),_t)}}catch(mt){Y(mt.toString())}}setLoadersUrl(j,Z){this.loadersUrl=Z}getAvailableImages(j,Z){this.availableImages[j]||(this.availableImages[j]={});let Y=this.availableImages[j][Z];return Y||(Y=[]),Y}getLayerIndex(j,Z){this.layerIndexes[j]||(this.layerIndexes[j]={});let Y=this.layerIndexes[j][Z];return Y||(Y=this.layerIndexes[j][Z]=new O),Y}getWorkerSource(j,Z,Y,mt){if(this.workerSources[j]||(this.workerSources[j]={}),this.workerSources[j][Z]||(this.workerSources[j][Z]={}),this.isSpriteLoaded[j]||(this.isSpriteLoaded[j]={}),!this.workerSources[j][Z][Y]){const _t={send:(Xt,$t,gt,ie,oe,pe)=>{this.actor.send(Xt,$t,gt,j,oe,pe)},scheduler:this.actor.scheduler};this.workerSources[j][Z][Y]=new this.workerSourceTypes[Z](_t,this.getLayerIndex(j,mt),this.getAvailableImages(j,mt),this.isSpriteLoaded[j][mt],void 0,this.brightness)}return this.workerSources[j][Z][Y]}getDEMWorkerSource(j,Z,Y){return this.demWorkerSources[j]||(this.demWorkerSources[j]={}),this.demWorkerSources[j][Y]||(this.demWorkerSources[j][Y]={}),this.demWorkerSources[j][Y][Z]||(this.demWorkerSources[j][Y][Z]=new B),this.demWorkerSources[j][Y][Z]}enforceCacheSizeLimit(j,Z){I.enforceCacheSizeLimit(Z)}getWorkerPerformanceMetrics(j,Z,Y){Y(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new yu(self)),yu}),g(["./shared"],function(I){return I.exported});var x=d;return x})})(BT);var GR=BT.exports;const Jd=UR(GR);var ki=63710088e-1,UT={centimeters:ki*100,centimetres:ki*100,degrees:ki/111325,feet:ki*3.28084,inches:ki*39.37,kilometers:ki/1e3,kilometres:ki/1e3,meters:ki,metres:ki,miles:ki/1609.344,millimeters:ki*1e3,millimetres:ki*1e3,nauticalmiles:ki/1852,radians:1,yards:ki*1.0936};function av(c,o,u){u===void 0&&(u={});var h={type:"Feature"};return(u.id===0||u.id)&&(h.id=u.id),u.bbox&&(h.bbox=u.bbox),h.properties=o||{},h.geometry=c,h}function jR(c,o,u){if(u===void 0&&(u={}),!c)throw new Error("coordinates is required");if(!Array.isArray(c))throw new Error("coordinates must be an Array");if(c.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!pT(c[0])||!pT(c[1]))throw new Error("coordinates must contain numbers");var h={type:"Point",coordinates:c};return av(h,o,u)}function Yy(c,o){o===void 0&&(o={});var u={type:"FeatureCollection"};return o.id&&(u.id=o.id),o.bbox&&(u.bbox=o.bbox),u.features=c,u}function qR(c,o){o===void 0&&(o="kilometers");var u=UT[o];if(!u)throw new Error(o+" units is invalid");return c*u}function ZR(c,o){o===void 0&&(o="kilometers");var u=UT[o];if(!u)throw new Error(o+" units is invalid");return c/u}function pT(c){return!isNaN(c)&&c!==null&&!Array.isArray(c)}function XR(c){return!!c&&c.constructor===Object}function GT(c,o,u){if(c!==null)for(var h,d,g,x,I,S,D,O=0,B=0,W,et=c.type,it=et==="FeatureCollection",bt=et==="Feature",ft=it?c.features.length:1,Pt=0;Pt<ft;Pt++){D=it?c.features[Pt].geometry:bt?c.geometry:c,W=D?D.type==="GeometryCollection":!1,I=W?D.geometries.length:1;for(var kt=0;kt<I;kt++){var Nt=0,ne=0;if(x=W?D.geometries[kt]:D,x!==null){S=x.coordinates;var Te=x.type;switch(O=u&&(Te==="Polygon"||Te==="MultiPolygon")?1:0,Te){case null:break;case"Point":if(o(S,B,Pt,Nt,ne)===!1)return!1;B++,Nt++;break;case"LineString":case"MultiPoint":for(h=0;h<S.length;h++){if(o(S[h],B,Pt,Nt,ne)===!1)return!1;B++,Te==="MultiPoint"&&Nt++}Te==="LineString"&&Nt++;break;case"Polygon":case"MultiLineString":for(h=0;h<S.length;h++){for(d=0;d<S[h].length-O;d++){if(o(S[h][d],B,Pt,Nt,ne)===!1)return!1;B++}Te==="MultiLineString"&&Nt++,Te==="Polygon"&&ne++}Te==="Polygon"&&Nt++;break;case"MultiPolygon":for(h=0;h<S.length;h++){for(ne=0,d=0;d<S[h].length;d++){for(g=0;g<S[h][d].length-O;g++){if(o(S[h][d][g],B,Pt,Nt,ne)===!1)return!1;B++}ne++}Nt++}break;case"GeometryCollection":for(h=0;h<x.geometries.length;h++)if(GT(x.geometries[h],o,u)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function fT(c,o){if(c.type==="Feature")o(c,0);else if(c.type==="FeatureCollection")for(var u=0;u<c.features.length&&o(c.features[u],u)!==!1;u++);}function lv(c,o){var u,h,d,g,x,I,S,D,O,B,W=0,et=c.type==="FeatureCollection",it=c.type==="Feature",bt=et?c.features.length:1;for(u=0;u<bt;u++){for(I=et?c.features[u].geometry:it?c.geometry:c,D=et?c.features[u].properties:it?c.properties:{},O=et?c.features[u].bbox:it?c.bbox:void 0,B=et?c.features[u].id:it?c.id:void 0,S=I?I.type==="GeometryCollection":!1,x=S?I.geometries.length:1,d=0;d<x;d++){if(g=S?I.geometries[d]:I,g===null){if(o(null,W,D,O,B)===!1)return!1;continue}switch(g.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(o(g,W,D,O,B)===!1)return!1;break}case"GeometryCollection":{for(h=0;h<g.geometries.length;h++)if(o(g.geometries[h],W,D,O,B)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}W++}}function $y(c){var o=[1/0,1/0,-1/0,-1/0];return GT(c,function(u){o[0]>u[0]&&(o[0]=u[0]),o[1]>u[1]&&(o[1]=u[1]),o[2]<u[0]&&(o[2]=u[0]),o[3]<u[1]&&(o[3]=u[1])}),o}$y.default=$y;function Fd(c){if(Array.isArray(c))return c;if(c.type==="Feature"){if(c.geometry!==null)return c.geometry.coordinates}else if(c.coordinates)return c.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function WR(c,o){return c.type==="FeatureCollection"?"FeatureCollection":c.type==="GeometryCollection"?"GeometryCollection":c.type==="Feature"&&c.geometry!==null?c.geometry.type:c.type}function HR(c){if(!c)throw new Error("geojson is required");switch(c.type){case"Feature":return jT(c);case"FeatureCollection":return YR(c);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return uv(c);default:throw new Error("unknown GeoJSON type")}}function jT(c){var o={type:"Feature"};return Object.keys(c).forEach(function(u){switch(u){case"type":case"properties":case"geometry":return;default:o[u]=c[u]}}),o.properties=qT(c.properties),o.geometry=uv(c.geometry),o}function qT(c){var o={};return c&&Object.keys(c).forEach(function(u){var h=c[u];typeof h=="object"?h===null?o[u]=null:Array.isArray(h)?o[u]=h.map(function(d){return d}):o[u]=qT(h):o[u]=h}),o}function YR(c){var o={type:"FeatureCollection"};return Object.keys(c).forEach(function(u){switch(u){case"type":case"features":return;default:o[u]=c[u]}}),o.features=c.features.map(function(u){return jT(u)}),o}function uv(c){var o={type:c.type};return c.bbox&&(o.bbox=c.bbox),c.type==="GeometryCollection"?(o.geometries=c.geometries.map(function(u){return uv(u)}),o):(o.coordinates=ZT(c.coordinates),o)}function ZT(c){var o=c;return typeof o[0]!="object"?o.slice():o.map(function(u){return ZT(u)})}function $R(c,o){o===void 0&&(o={});var u=typeof o=="object"?o.mutate:o;if(!c)throw new Error("geojson is required");var h=WR(c),d=[];switch(h){case"LineString":d=Zy(c);break;case"MultiLineString":case"Polygon":Fd(c).forEach(function(x){d.push(Zy(x))});break;case"MultiPolygon":Fd(c).forEach(function(x){var I=[];x.forEach(function(S){I.push(Zy(S))}),d.push(I)});break;case"Point":return c;case"MultiPoint":var g={};Fd(c).forEach(function(x){var I=x.join("-");Object.prototype.hasOwnProperty.call(g,I)||(d.push(x),g[I]=!0)});break;default:throw new Error(h+" geometry not supported")}return c.coordinates?u===!0?(c.coordinates=d,c):{type:h,coordinates:d}:u===!0?(c.geometry.coordinates=d,c):av({type:h,coordinates:d},c.properties,{bbox:c.bbox,id:c.id})}function Zy(c){var o=Fd(c);if(o.length===2&&!dT(o[0],o[1]))return o;var u=[],h=o.length-1,d=u.length;u.push(o[0]);for(var g=1;g<h;g++){var x=u[u.length-1];o[g][0]===x[0]&&o[g][1]===x[1]||(u.push(o[g]),d=u.length,d>2&&mT(u[d-3],u[d-1],u[d-2])&&u.splice(u.length-2,1))}if(u.push(o[o.length-1]),d=u.length,dT(o[0],o[o.length-1])&&d<4)throw new Error("invalid polygon");return mT(u[d-3],u[d-1],u[d-2])&&u.splice(u.length-2,1),u}function dT(c,o){return c[0]===o[0]&&c[1]===o[1]}function mT(c,o,u){var h=u[0],d=u[1],g=c[0],x=c[1],I=o[0],S=o[1],D=h-g,O=d-x,B=I-g,W=S-x,et=D*W-O*B;return et!==0?!1:Math.abs(B)>=Math.abs(W)?B>0?g<=h&&h<=I:I<=h&&h<=g:W>0?x<=d&&d<=S:S<=d&&d<=x}function KR(c,o){var u=c.x-o.x,h=c.y-o.y;return u*u+h*h}function JR(c,o,u){var h=o.x,d=o.y,g=u.x-h,x=u.y-d;if(g!==0||x!==0){var I=((c.x-h)*g+(c.y-d)*x)/(g*g+x*x);I>1?(h=u.x,d=u.y):I>0&&(h+=g*I,d+=x*I)}return g=c.x-h,x=c.y-d,g*g+x*x}function QR(c,o){for(var u=c[0],h=[u],d,g=1,x=c.length;g<x;g++)d=c[g],KR(d,u)>o&&(h.push(d),u=d);return u!==d&&h.push(d),h}function Ky(c,o,u,h,d){for(var g=h,x,I=o+1;I<u;I++){var S=JR(c[I],c[o],c[u]);S>g&&(x=I,g=S)}g>h&&(x-o>1&&Ky(c,o,x,h,d),d.push(c[x]),u-x>1&&Ky(c,x,u,h,d))}function tO(c,o){var u=c.length-1,h=[c[0]];return Ky(c,0,u,o,h),h.push(c[u]),h}function Jy(c,o,u){if(c.length<=2)return c;var h=o!==void 0?o*o:1;return c=u?c:QR(c,h),c=tO(c,h),c}function eO(c,o){if(o=o||{},!XR(o))throw new Error("options is invalid");var u=o.tolerance!==void 0?o.tolerance:1,h=o.highQuality||!1,d=o.mutate||!1;if(!c)throw new Error("geojson is required");if(u&&u<0)throw new Error("invalid tolerance");return d!==!0&&(c=HR(c)),lv(c,function(g){rO(g,u,h)}),c}function rO(c,o,u){var h=c.type;if(h==="Point"||h==="MultiPoint")return c;$R(c,!0);var d=c.coordinates;switch(h){case"LineString":c.coordinates=gT(d,o,u);break;case"MultiLineString":c.coordinates=d.map(function(g){return gT(g,o,u)});break;case"Polygon":c.coordinates=_T(d,o,u);break;case"MultiPolygon":c.coordinates=d.map(function(g){return _T(g,o,u)})}return c}function gT(c,o,u){return Jy(c.map(function(h){return{x:h[0],y:h[1],z:h[2]}}),o,u).map(function(h){return h.z?[h.x,h.y,h.z]:[h.x,h.y]})}function _T(c,o,u){return c.map(function(h){var d=h.map(function(x){return{x:x[0],y:x[1]}});if(d.length<4)throw new Error("invalid polygon");for(var g=Jy(d,o,u).map(function(x){return[x.x,x.y]});!nO(g);)o-=o*.01,g=Jy(d,o,u).map(function(x){return[x.x,x.y]});return(g[g.length-1][0]!==g[0][0]||g[g.length-1][1]!==g[0][1])&&g.push(g[0]),g})}function nO(c){return c.length<3?!1:!(c.length===3&&c[2][0]===c[0][0]&&c[2][1]===c[0][1])}function iO(c,o){o===void 0&&(o={});var u=$y(c),h=(u[0]+u[2])/2,d=(u[1]+u[3])/2;return jR([h,d],o.properties,o)}"fill"in Array.prototype||Object.defineProperty(Array.prototype,"fill",{configurable:!0,value:function(o){if(this===void 0||this===null)throw new TypeError(this+" is not an object");var u=Object(this),h=Math.max(Math.min(u.length,9007199254740991),0)||0,d=1 in arguments&&parseInt(Number(arguments[1]),10)||0;d=d<0?Math.max(h+d,0):Math.min(d,h);var g=2 in arguments&&arguments[2]!==void 0?parseInt(Number(arguments[2]),10)||0:h;for(g=g<0?Math.max(h+arguments[2],0):Math.min(g,h);d<g;)u[d]=o,++d;return u},writable:!0});Number.isFinite=Number.isFinite||function(c){return typeof c=="number"&&isFinite(c)};Number.isInteger=Number.isInteger||function(c){return typeof c=="number"&&isFinite(c)&&Math.floor(c)===c};Number.parseFloat=Number.parseFloat||parseFloat;Number.isNaN=Number.isNaN||function(c){return c!==c};Math.trunc=Math.trunc||function(c){return c<0?Math.ceil(c):Math.floor(c)};var Jl=function(){};Jl.prototype.interfaces_=function(){return[]};Jl.prototype.getClass=function(){return Jl};Jl.prototype.equalsWithTolerance=function(o,u,h){return Math.abs(o-u)<=h};var Xr=function(c){function o(u){c.call(this,u),this.name="IllegalArgumentException",this.message=u,this.stack=new c().stack}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o}(Error),ke=function(){},XT={MAX_VALUE:{configurable:!0}};ke.isNaN=function(o){return Number.isNaN(o)};ke.doubleToLongBits=function(o){return o};ke.longBitsToDouble=function(o){return o};ke.isInfinite=function(o){return!Number.isFinite(o)};XT.MAX_VALUE.get=function(){return Number.MAX_VALUE};Object.defineProperties(ke,XT);var uo=function(){},Qd=function(){},yc=function(){};function co(){}var st=function c(){if(this.x=null,this.y=null,this.z=null,arguments.length===0)this.x=0,this.y=0,this.z=c.NULL_ORDINATE;else if(arguments.length===1){var o=arguments[0];this.x=o.x,this.y=o.y,this.z=o.z}else arguments.length===2?(this.x=arguments[0],this.y=arguments[1],this.z=c.NULL_ORDINATE):arguments.length===3&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2])},hu={DimensionalComparator:{configurable:!0},serialVersionUID:{configurable:!0},NULL_ORDINATE:{configurable:!0},X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0}};st.prototype.setOrdinate=function(o,u){switch(o){case st.X:this.x=u;break;case st.Y:this.y=u;break;case st.Z:this.z=u;break;default:throw new Xr("Invalid ordinate index: "+o)}};st.prototype.equals2D=function(){if(arguments.length===1){var o=arguments[0];return!(this.x!==o.x||this.y!==o.y)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];return!(!Jl.equalsWithTolerance(this.x,u.x,h)||!Jl.equalsWithTolerance(this.y,u.y,h))}};st.prototype.getOrdinate=function(o){switch(o){case st.X:return this.x;case st.Y:return this.y;case st.Z:return this.z}throw new Xr("Invalid ordinate index: "+o)};st.prototype.equals3D=function(o){return this.x===o.x&&this.y===o.y&&(this.z===o.z||ke.isNaN(this.z))&&ke.isNaN(o.z)};st.prototype.equals=function(o){return o instanceof st?this.equals2D(o):!1};st.prototype.equalInZ=function(o,u){return Jl.equalsWithTolerance(this.z,o.z,u)};st.prototype.compareTo=function(o){var u=o;return this.x<u.x?-1:this.x>u.x?1:this.y<u.y?-1:this.y>u.y?1:0};st.prototype.clone=function(){};st.prototype.copy=function(){return new st(this)};st.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"};st.prototype.distance3D=function(o){var u=this.x-o.x,h=this.y-o.y,d=this.z-o.z;return Math.sqrt(u*u+h*h+d*d)};st.prototype.distance=function(o){var u=this.x-o.x,h=this.y-o.y;return Math.sqrt(u*u+h*h)};st.prototype.hashCode=function(){var o=17;return o=37*o+st.hashCode(this.x),o=37*o+st.hashCode(this.y),o};st.prototype.setCoordinate=function(o){this.x=o.x,this.y=o.y,this.z=o.z};st.prototype.interfaces_=function(){return[uo,Qd,co]};st.prototype.getClass=function(){return st};st.hashCode=function(){if(arguments.length===1){var o=arguments[0],u=ke.doubleToLongBits(o);return Math.trunc((u^u)>>>32)}};hu.DimensionalComparator.get=function(){return wa};hu.serialVersionUID.get=function(){return 6683108902428367e3};hu.NULL_ORDINATE.get=function(){return ke.NaN};hu.X.get=function(){return 0};hu.Y.get=function(){return 1};hu.Z.get=function(){return 2};Object.defineProperties(st,hu);var wa=function(o){if(this._dimensionsToTest=2,arguments.length!==0){if(arguments.length===1){var u=arguments[0];if(u!==2&&u!==3)throw new Xr("only 2 or 3 dimensions may be specified");this._dimensionsToTest=u}}};wa.prototype.compare=function(o,u){var h=o,d=u,g=wa.compare(h.x,d.x);if(g!==0)return g;var x=wa.compare(h.y,d.y);if(x!==0)return x;if(this._dimensionsToTest<=2)return 0;var I=wa.compare(h.z,d.z);return I};wa.prototype.interfaces_=function(){return[yc]};wa.prototype.getClass=function(){return wa};wa.compare=function(o,u){return o<u?-1:o>u?1:ke.isNaN(o)?ke.isNaN(u)?0:-1:ke.isNaN(u)?1:0};var vc=function(){};vc.prototype.create=function(){};vc.prototype.interfaces_=function(){return[]};vc.prototype.getClass=function(){return vc};var ut=function(){},gp={INTERIOR:{configurable:!0},BOUNDARY:{configurable:!0},EXTERIOR:{configurable:!0},NONE:{configurable:!0}};ut.prototype.interfaces_=function(){return[]};ut.prototype.getClass=function(){return ut};ut.toLocationSymbol=function(o){switch(o){case ut.EXTERIOR:return"e";case ut.BOUNDARY:return"b";case ut.INTERIOR:return"i";case ut.NONE:return"-"}throw new Xr("Unknown location value: "+o)};gp.INTERIOR.get=function(){return 0};gp.BOUNDARY.get=function(){return 1};gp.EXTERIOR.get=function(){return 2};gp.NONE.get=function(){return-1};Object.defineProperties(ut,gp);var Ee=function(c,o){return c.interfaces_&&c.interfaces_().indexOf(o)>-1},Vi=function(){},WT={LOG_10:{configurable:!0}};Vi.prototype.interfaces_=function(){return[]};Vi.prototype.getClass=function(){return Vi};Vi.log10=function(o){var u=Math.log(o);return ke.isInfinite(u)||ke.isNaN(u)?u:u/Vi.LOG_10};Vi.min=function(o,u,h,d){var g=o;return u<g&&(g=u),h<g&&(g=h),d<g&&(g=d),g};Vi.clamp=function(){if(typeof arguments[2]=="number"&&typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var o=arguments[0],u=arguments[1],h=arguments[2];return o<u?u:o>h?h:o}else if(Number.isInteger(arguments[2])&&Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var d=arguments[0],g=arguments[1],x=arguments[2];return d<g?g:d>x?x:d}};Vi.wrap=function(o,u){return o<0?u- -o%u:o%u};Vi.max=function(){if(arguments.length===3){var o=arguments[0],u=arguments[1],h=arguments[2],d=o;return u>d&&(d=u),h>d&&(d=h),d}else if(arguments.length===4){var g=arguments[0],x=arguments[1],I=arguments[2],S=arguments[3],D=g;return x>D&&(D=x),I>D&&(D=I),S>D&&(D=S),D}};Vi.average=function(o,u){return(o+u)/2};WT.LOG_10.get=function(){return Math.log(10)};Object.defineProperties(Vi,WT);var is=function(o){this.str=o};is.prototype.append=function(o){this.str+=o};is.prototype.setCharAt=function(o,u){this.str=this.str.substr(0,o)+u+this.str.substr(o+1)};is.prototype.toString=function(o){return this.str};var Ho=function(o){this.value=o};Ho.prototype.intValue=function(){return this.value};Ho.prototype.compareTo=function(o){return this.value<o?-1:this.value>o?1:0};Ho.isNaN=function(o){return Number.isNaN(o)};var Qh=function(){};Qh.isWhitespace=function(o){return o<=32&&o>=0||o===127};Qh.toUpperCase=function(o){return o.toUpperCase()};var pt=function c(){if(this._hi=0,this._lo=0,arguments.length===0)this.init(0);else if(arguments.length===1){if(typeof arguments[0]=="number"){var o=arguments[0];this.init(o)}else if(arguments[0]instanceof c){var u=arguments[0];this.init(u)}else if(typeof arguments[0]=="string"){var h=arguments[0];c.call(this,c.parse(h))}}else if(arguments.length===2){var d=arguments[0],g=arguments[1];this.init(d,g)}},Ao={PI:{configurable:!0},TWO_PI:{configurable:!0},PI_2:{configurable:!0},E:{configurable:!0},NaN:{configurable:!0},EPS:{configurable:!0},SPLIT:{configurable:!0},MAX_PRINT_DIGITS:{configurable:!0},TEN:{configurable:!0},ONE:{configurable:!0},SCI_NOT_EXPONENT_CHAR:{configurable:!0},SCI_NOT_ZERO:{configurable:!0}};pt.prototype.le=function(o){return(this._hi<o._hi||this._hi===o._hi)&&this._lo<=o._lo};pt.prototype.extractSignificantDigits=function(o,u){var h=this.abs(),d=pt.magnitude(h._hi),g=pt.TEN.pow(d);h=h.divide(g),h.gt(pt.TEN)?(h=h.divide(pt.TEN),d+=1):h.lt(pt.ONE)&&(h=h.multiply(pt.TEN),d-=1);for(var x=d+1,I=new is,S=pt.MAX_PRINT_DIGITS-1,D=0;D<=S;D++){o&&D===x&&I.append(".");var O=Math.trunc(h._hi);if(O<0)break;var B=!1,W=0;O>9?(B=!0,W="9"):W="0"+O,I.append(W),h=h.subtract(pt.valueOf(O)).multiply(pt.TEN),B&&h.selfAdd(pt.TEN);var et=!0,it=pt.magnitude(h._hi);if(it<0&&Math.abs(it)>=S-D&&(et=!1),!et)break}return u[0]=d,I.toString()};pt.prototype.sqr=function(){return this.multiply(this)};pt.prototype.doubleValue=function(){return this._hi+this._lo};pt.prototype.subtract=function(){if(arguments[0]instanceof pt){var o=arguments[0];return this.add(o.negate())}else if(typeof arguments[0]=="number"){var u=arguments[0];return this.add(-u)}};pt.prototype.equals=function(){if(arguments.length===1){var o=arguments[0];return this._hi===o._hi&&this._lo===o._lo}};pt.prototype.isZero=function(){return this._hi===0&&this._lo===0};pt.prototype.selfSubtract=function(){if(arguments[0]instanceof pt){var o=arguments[0];return this.isNaN()?this:this.selfAdd(-o._hi,-o._lo)}else if(typeof arguments[0]=="number"){var u=arguments[0];return this.isNaN()?this:this.selfAdd(-u,0)}};pt.prototype.getSpecialNumberString=function(){return this.isZero()?"0.0":this.isNaN()?"NaN ":null};pt.prototype.min=function(o){return this.le(o)?this:o};pt.prototype.selfDivide=function(){if(arguments.length===1){if(arguments[0]instanceof pt){var o=arguments[0];return this.selfDivide(o._hi,o._lo)}else if(typeof arguments[0]=="number"){var u=arguments[0];return this.selfDivide(u,0)}}else if(arguments.length===2){var h=arguments[0],d=arguments[1],g=null,x=null,I=null,S=null,D=null,O=null,B=null,W=null;return D=this._hi/h,O=pt.SPLIT*D,g=O-D,W=pt.SPLIT*h,g=O-g,x=D-g,I=W-h,B=D*h,I=W-I,S=h-I,W=g*I-B+g*S+x*I+x*S,O=(this._hi-B-W+this._lo-D*d)/h,W=D+O,this._hi=W,this._lo=D-W+O,this}};pt.prototype.dump=function(){return"DD<"+this._hi+", "+this._lo+">"};pt.prototype.divide=function(){if(arguments[0]instanceof pt){var o=arguments[0],u=null,h=null,d=null,g=null,x=null,I=null,S=null,D=null;x=this._hi/o._hi,I=pt.SPLIT*x,u=I-x,D=pt.SPLIT*o._hi,u=I-u,h=x-u,d=D-o._hi,S=x*o._hi,d=D-d,g=o._hi-d,D=u*d-S+u*g+h*d+h*g,I=(this._hi-S-D+this._lo-x*o._lo)/o._hi,D=x+I;var O=D,B=x-D+I;return new pt(O,B)}else if(typeof arguments[0]=="number"){var W=arguments[0];return ke.isNaN(W)?pt.createNaN():pt.copy(this).selfDivide(W,0)}};pt.prototype.ge=function(o){return(this._hi>o._hi||this._hi===o._hi)&&this._lo>=o._lo};pt.prototype.pow=function(o){if(o===0)return pt.valueOf(1);var u=new pt(this),h=pt.valueOf(1),d=Math.abs(o);if(d>1)for(;d>0;)d%2===1&&h.selfMultiply(u),d/=2,d>0&&(u=u.sqr());else h=u;return o<0?h.reciprocal():h};pt.prototype.ceil=function(){if(this.isNaN())return pt.NaN;var o=Math.ceil(this._hi),u=0;return o===this._hi&&(u=Math.ceil(this._lo)),new pt(o,u)};pt.prototype.compareTo=function(o){var u=o;return this._hi<u._hi?-1:this._hi>u._hi?1:this._lo<u._lo?-1:this._lo>u._lo?1:0};pt.prototype.rint=function(){if(this.isNaN())return this;var o=this.add(.5);return o.floor()};pt.prototype.setValue=function(){if(arguments[0]instanceof pt){var o=arguments[0];return this.init(o),this}else if(typeof arguments[0]=="number"){var u=arguments[0];return this.init(u),this}};pt.prototype.max=function(o){return this.ge(o)?this:o};pt.prototype.sqrt=function(){if(this.isZero())return pt.valueOf(0);if(this.isNegative())return pt.NaN;var o=1/Math.sqrt(this._hi),u=this._hi*o,h=pt.valueOf(u),d=this.subtract(h.sqr()),g=d._hi*(o*.5);return h.add(g)};pt.prototype.selfAdd=function(){if(arguments.length===1){if(arguments[0]instanceof pt){var o=arguments[0];return this.selfAdd(o._hi,o._lo)}else if(typeof arguments[0]=="number"){var u=arguments[0],h=null,d=null,g=null,x=null,I=null,S=null;return g=this._hi+u,I=g-this._hi,x=g-I,x=u-I+(this._hi-x),S=x+this._lo,h=g+S,d=S+(g-h),this._hi=h+d,this._lo=d+(h-this._hi),this}}else if(arguments.length===2){var D=arguments[0],O=arguments[1],B=null,W=null,et=null,it=null,bt=null,ft=null,Pt=null,kt=null;bt=this._hi+D,et=this._lo+O,Pt=bt-this._hi,kt=et-this._lo,ft=bt-Pt,it=et-kt,ft=D-Pt+(this._hi-ft),it=O-kt+(this._lo-it),Pt=ft+et,B=bt+Pt,W=Pt+(bt-B),Pt=it+W;var Nt=B+Pt,ne=Pt+(B-Nt);return this._hi=Nt,this._lo=ne,this}};pt.prototype.selfMultiply=function(){if(arguments.length===1){if(arguments[0]instanceof pt){var o=arguments[0];return this.selfMultiply(o._hi,o._lo)}else if(typeof arguments[0]=="number"){var u=arguments[0];return this.selfMultiply(u,0)}}else if(arguments.length===2){var h=arguments[0],d=arguments[1],g=null,x=null,I=null,S=null,D=null,O=null;D=pt.SPLIT*this._hi,g=D-this._hi,O=pt.SPLIT*h,g=D-g,x=this._hi-g,I=O-h,D=this._hi*h,I=O-I,S=h-I,O=g*I-D+g*S+x*I+x*S+(this._hi*d+this._lo*h);var B=D+O;g=D-B;var W=O+g;return this._hi=B,this._lo=W,this}};pt.prototype.selfSqr=function(){return this.selfMultiply(this)};pt.prototype.floor=function(){if(this.isNaN())return pt.NaN;var o=Math.floor(this._hi),u=0;return o===this._hi&&(u=Math.floor(this._lo)),new pt(o,u)};pt.prototype.negate=function(){return this.isNaN()?this:new pt(-this._hi,-this._lo)};pt.prototype.clone=function(){};pt.prototype.multiply=function(){if(arguments[0]instanceof pt){var o=arguments[0];return o.isNaN()?pt.createNaN():pt.copy(this).selfMultiply(o)}else if(typeof arguments[0]=="number"){var u=arguments[0];return ke.isNaN(u)?pt.createNaN():pt.copy(this).selfMultiply(u,0)}};pt.prototype.isNaN=function(){return ke.isNaN(this._hi)};pt.prototype.intValue=function(){return Math.trunc(this._hi)};pt.prototype.toString=function(){var o=pt.magnitude(this._hi);return o>=-3&&o<=20?this.toStandardNotation():this.toSciNotation()};pt.prototype.toStandardNotation=function(){var o=this.getSpecialNumberString();if(o!==null)return o;var u=new Array(1).fill(null),h=this.extractSignificantDigits(!0,u),d=u[0]+1,g=h;if(h.charAt(0)===".")g="0"+h;else if(d<0)g="0."+pt.stringOfChar("0",-d)+h;else if(h.indexOf(".")===-1){var x=d-h.length,I=pt.stringOfChar("0",x);g=h+I+".0"}return this.isNegative()?"-"+g:g};pt.prototype.reciprocal=function(){var o=null,u=null,h=null,d=null,g=null,x=null,I=null,S=null;g=1/this._hi,x=pt.SPLIT*g,o=x-g,S=pt.SPLIT*this._hi,o=x-o,u=g-o,h=S-this._hi,I=g*this._hi,h=S-h,d=this._hi-h,S=o*h-I+o*d+u*h+u*d,x=(1-I-S-g*this._lo)/this._hi;var D=g+x,O=g-D+x;return new pt(D,O)};pt.prototype.toSciNotation=function(){if(this.isZero())return pt.SCI_NOT_ZERO;var o=this.getSpecialNumberString();if(o!==null)return o;var u=new Array(1).fill(null),h=this.extractSignificantDigits(!1,u),d=pt.SCI_NOT_EXPONENT_CHAR+u[0];if(h.charAt(0)==="0")throw new Error("Found leading zero: "+h);var g="";h.length>1&&(g=h.substring(1));var x=h.charAt(0)+"."+g;return this.isNegative()?"-"+x+d:x+d};pt.prototype.abs=function(){return this.isNaN()?pt.NaN:this.isNegative()?this.negate():new pt(this)};pt.prototype.isPositive=function(){return(this._hi>0||this._hi===0)&&this._lo>0};pt.prototype.lt=function(o){return(this._hi<o._hi||this._hi===o._hi)&&this._lo<o._lo};pt.prototype.add=function(){if(arguments[0]instanceof pt){var o=arguments[0];return pt.copy(this).selfAdd(o)}else if(typeof arguments[0]=="number"){var u=arguments[0];return pt.copy(this).selfAdd(u)}};pt.prototype.init=function(){if(arguments.length===1){if(typeof arguments[0]=="number"){var o=arguments[0];this._hi=o,this._lo=0}else if(arguments[0]instanceof pt){var u=arguments[0];this._hi=u._hi,this._lo=u._lo}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];this._hi=h,this._lo=d}};pt.prototype.gt=function(o){return(this._hi>o._hi||this._hi===o._hi)&&this._lo>o._lo};pt.prototype.isNegative=function(){return(this._hi<0||this._hi===0)&&this._lo<0};pt.prototype.trunc=function(){return this.isNaN()?pt.NaN:this.isPositive()?this.floor():this.ceil()};pt.prototype.signum=function(){return this._hi>0?1:this._hi<0?-1:this._lo>0?1:this._lo<0?-1:0};pt.prototype.interfaces_=function(){return[co,uo,Qd]};pt.prototype.getClass=function(){return pt};pt.sqr=function(o){return pt.valueOf(o).selfMultiply(o)};pt.valueOf=function(){if(typeof arguments[0]=="string"){var o=arguments[0];return pt.parse(o)}else if(typeof arguments[0]=="number"){var u=arguments[0];return new pt(u)}};pt.sqrt=function(o){return pt.valueOf(o).sqrt()};pt.parse=function(o){for(var u=0,h=o.length;Qh.isWhitespace(o.charAt(u));)u++;var d=!1;if(u<h){var g=o.charAt(u);(g==="-"||g==="+")&&(u++,g==="-"&&(d=!0))}for(var x=new pt,I=0,S=0,D=0;!(u>=h);){var O=o.charAt(u);if(u++,Qh.isDigit(O)){var B=O-"0";x.selfMultiply(pt.TEN),x.selfAdd(B),I++;continue}if(O==="."){S=I;continue}if(O==="e"||O==="E"){var W=o.substring(u);try{D=Ho.parseInt(W)}catch(Pt){throw Pt instanceof Error?new Error("Invalid exponent "+W+" in string "+o):Pt}finally{}break}throw new Error("Unexpected character '"+O+"' at position "+u+" in string "+o)}var et=x,it=I-S-D;if(it===0)et=x;else if(it>0){var bt=pt.TEN.pow(it);et=x.divide(bt)}else if(it<0){var ft=pt.TEN.pow(-it);et=x.multiply(ft)}return d?et.negate():et};pt.createNaN=function(){return new pt(ke.NaN,ke.NaN)};pt.copy=function(o){return new pt(o)};pt.magnitude=function(o){var u=Math.abs(o),h=Math.log(u)/Math.log(10),d=Math.trunc(Math.floor(h)),g=Math.pow(10,d);return g*10<=u&&(d+=1),d};pt.stringOfChar=function(o,u){for(var h=new is,d=0;d<u;d++)h.append(o);return h.toString()};Ao.PI.get=function(){return new pt(3.141592653589793,12246467991473532e-32)};Ao.TWO_PI.get=function(){return new pt(6.283185307179586,24492935982947064e-32)};Ao.PI_2.get=function(){return new pt(1.5707963267948966,6123233995736766e-32)};Ao.E.get=function(){return new pt(2.718281828459045,14456468917292502e-32)};Ao.NaN.get=function(){return new pt(ke.NaN,ke.NaN)};Ao.EPS.get=function(){return 123259516440783e-46};Ao.SPLIT.get=function(){return 134217729};Ao.MAX_PRINT_DIGITS.get=function(){return 32};Ao.TEN.get=function(){return pt.valueOf(10)};Ao.ONE.get=function(){return pt.valueOf(1)};Ao.SCI_NOT_EXPONENT_CHAR.get=function(){return"E"};Ao.SCI_NOT_ZERO.get=function(){return"0.0E0"};Object.defineProperties(pt,Ao);var xi=function(){},HT={DP_SAFE_EPSILON:{configurable:!0}};xi.prototype.interfaces_=function(){return[]};xi.prototype.getClass=function(){return xi};xi.orientationIndex=function(o,u,h){var d=xi.orientationIndexFilter(o,u,h);if(d<=1)return d;var g=pt.valueOf(u.x).selfAdd(-o.x),x=pt.valueOf(u.y).selfAdd(-o.y),I=pt.valueOf(h.x).selfAdd(-u.x),S=pt.valueOf(h.y).selfAdd(-u.y);return g.selfMultiply(S).selfSubtract(x.selfMultiply(I)).signum()};xi.signOfDet2x2=function(o,u,h,d){var g=o.multiply(d).selfSubtract(u.multiply(h));return g.signum()};xi.intersection=function(o,u,h,d){var g=pt.valueOf(d.y).selfSubtract(h.y).selfMultiply(pt.valueOf(u.x).selfSubtract(o.x)),x=pt.valueOf(d.x).selfSubtract(h.x).selfMultiply(pt.valueOf(u.y).selfSubtract(o.y)),I=g.subtract(x),S=pt.valueOf(d.x).selfSubtract(h.x).selfMultiply(pt.valueOf(o.y).selfSubtract(h.y)),D=pt.valueOf(d.y).selfSubtract(h.y).selfMultiply(pt.valueOf(o.x).selfSubtract(h.x)),O=S.subtract(D),B=O.selfDivide(I).doubleValue(),W=pt.valueOf(o.x).selfAdd(pt.valueOf(u.x).selfSubtract(o.x).selfMultiply(B)).doubleValue(),et=pt.valueOf(u.x).selfSubtract(o.x).selfMultiply(pt.valueOf(o.y).selfSubtract(h.y)),it=pt.valueOf(u.y).selfSubtract(o.y).selfMultiply(pt.valueOf(o.x).selfSubtract(h.x)),bt=et.subtract(it),ft=bt.selfDivide(I).doubleValue(),Pt=pt.valueOf(h.y).selfAdd(pt.valueOf(d.y).selfSubtract(h.y).selfMultiply(ft)).doubleValue();return new st(W,Pt)};xi.orientationIndexFilter=function(o,u,h){var d=null,g=(o.x-h.x)*(u.y-h.y),x=(o.y-h.y)*(u.x-h.x),I=g-x;if(g>0){if(x<=0)return xi.signum(I);d=g+x}else if(g<0){if(x>=0)return xi.signum(I);d=-g-x}else return xi.signum(I);var S=xi.DP_SAFE_EPSILON*d;return I>=S||-I>=S?xi.signum(I):2};xi.signum=function(o){return o>0?1:o<0?-1:0};HT.DP_SAFE_EPSILON.get=function(){return 1e-15};Object.defineProperties(xi,HT);var nr=function(){},_p={X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0},M:{configurable:!0}};_p.X.get=function(){return 0};_p.Y.get=function(){return 1};_p.Z.get=function(){return 2};_p.M.get=function(){return 3};nr.prototype.setOrdinate=function(o,u,h){};nr.prototype.size=function(){};nr.prototype.getOrdinate=function(o,u){};nr.prototype.getCoordinate=function(){};nr.prototype.getCoordinateCopy=function(o){};nr.prototype.getDimension=function(){};nr.prototype.getX=function(o){};nr.prototype.clone=function(){};nr.prototype.expandEnvelope=function(o){};nr.prototype.copy=function(){};nr.prototype.getY=function(o){};nr.prototype.toCoordinateArray=function(){};nr.prototype.interfaces_=function(){return[Qd]};nr.prototype.getClass=function(){return nr};Object.defineProperties(nr,_p);var YT=function(){},Bc=function(c){function o(){c.call(this,"Projective point not representable on the Cartesian plane.")}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(YT),$n=function(){};$n.arraycopy=function(o,u,h,d,g){for(var x=0,I=u;I<u+g;I++)h[d+x]=o[I],x++};$n.getProperty=function(o){return{"line.separator":`
`}[o]};var xo=function c(){if(this.x=null,this.y=null,this.w=null,arguments.length===0)this.x=0,this.y=0,this.w=1;else if(arguments.length===1){var o=arguments[0];this.x=o.x,this.y=o.y,this.w=1}else if(arguments.length===2){if(typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var u=arguments[0],h=arguments[1];this.x=u,this.y=h,this.w=1}else if(arguments[0]instanceof c&&arguments[1]instanceof c){var d=arguments[0],g=arguments[1];this.x=d.y*g.w-g.y*d.w,this.y=g.x*d.w-d.x*g.w,this.w=d.x*g.y-g.x*d.y}else if(arguments[0]instanceof st&&arguments[1]instanceof st){var x=arguments[0],I=arguments[1];this.x=x.y-I.y,this.y=I.x-x.x,this.w=x.x*I.y-I.x*x.y}}else if(arguments.length===3){var S=arguments[0],D=arguments[1],O=arguments[2];this.x=S,this.y=D,this.w=O}else if(arguments.length===4){var B=arguments[0],W=arguments[1],et=arguments[2],it=arguments[3],bt=B.y-W.y,ft=W.x-B.x,Pt=B.x*W.y-W.x*B.y,kt=et.y-it.y,Nt=it.x-et.x,ne=et.x*it.y-it.x*et.y;this.x=ft*ne-Nt*Pt,this.y=kt*Pt-bt*ne,this.w=bt*Nt-kt*ft}};xo.prototype.getY=function(){var o=this.y/this.w;if(ke.isNaN(o)||ke.isInfinite(o))throw new Bc;return o};xo.prototype.getX=function(){var o=this.x/this.w;if(ke.isNaN(o)||ke.isInfinite(o))throw new Bc;return o};xo.prototype.getCoordinate=function(){var o=new st;return o.x=this.getX(),o.y=this.getY(),o};xo.prototype.interfaces_=function(){return[]};xo.prototype.getClass=function(){return xo};xo.intersection=function(o,u,h,d){var g=o.y-u.y,x=u.x-o.x,I=o.x*u.y-u.x*o.y,S=h.y-d.y,D=d.x-h.x,O=h.x*d.y-d.x*h.y,B=x*O-D*I,W=S*I-g*O,et=g*D-S*x,it=B/et,bt=W/et;if(ke.isNaN(it)||ke.isInfinite(it)||ke.isNaN(bt)||ke.isInfinite(bt))throw new Bc;return new st(it,bt)};var le=function c(){if(this._minx=null,this._maxx=null,this._miny=null,this._maxy=null,arguments.length===0)this.init();else if(arguments.length===1){if(arguments[0]instanceof st){var o=arguments[0];this.init(o.x,o.x,o.y,o.y)}else if(arguments[0]instanceof c){var u=arguments[0];this.init(u)}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];this.init(h.x,d.x,h.y,d.y)}else if(arguments.length===4){var g=arguments[0],x=arguments[1],I=arguments[2],S=arguments[3];this.init(g,x,I,S)}},$T={serialVersionUID:{configurable:!0}};le.prototype.getArea=function(){return this.getWidth()*this.getHeight()};le.prototype.equals=function(o){if(!(o instanceof le))return!1;var u=o;return this.isNull()?u.isNull():this._maxx===u.getMaxX()&&this._maxy===u.getMaxY()&&this._minx===u.getMinX()&&this._miny===u.getMinY()};le.prototype.intersection=function(o){if(this.isNull()||o.isNull()||!this.intersects(o))return new le;var u=this._minx>o._minx?this._minx:o._minx,h=this._miny>o._miny?this._miny:o._miny,d=this._maxx<o._maxx?this._maxx:o._maxx,g=this._maxy<o._maxy?this._maxy:o._maxy;return new le(u,d,h,g)};le.prototype.isNull=function(){return this._maxx<this._minx};le.prototype.getMaxX=function(){return this._maxx};le.prototype.covers=function(){if(arguments.length===1){if(arguments[0]instanceof st){var o=arguments[0];return this.covers(o.x,o.y)}else if(arguments[0]instanceof le){var u=arguments[0];return this.isNull()||u.isNull()?!1:u.getMinX()>=this._minx&&u.getMaxX()<=this._maxx&&u.getMinY()>=this._miny&&u.getMaxY()<=this._maxy}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];return this.isNull()?!1:h>=this._minx&&h<=this._maxx&&d>=this._miny&&d<=this._maxy}};le.prototype.intersects=function(){if(arguments.length===1){if(arguments[0]instanceof le){var o=arguments[0];return this.isNull()||o.isNull()?!1:!(o._minx>this._maxx||o._maxx<this._minx||o._miny>this._maxy||o._maxy<this._miny)}else if(arguments[0]instanceof st){var u=arguments[0];return this.intersects(u.x,u.y)}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];return this.isNull()?!1:!(h>this._maxx||h<this._minx||d>this._maxy||d<this._miny)}};le.prototype.getMinY=function(){return this._miny};le.prototype.getMinX=function(){return this._minx};le.prototype.expandToInclude=function(){if(arguments.length===1){if(arguments[0]instanceof st){var o=arguments[0];this.expandToInclude(o.x,o.y)}else if(arguments[0]instanceof le){var u=arguments[0];if(u.isNull())return null;this.isNull()?(this._minx=u.getMinX(),this._maxx=u.getMaxX(),this._miny=u.getMinY(),this._maxy=u.getMaxY()):(u._minx<this._minx&&(this._minx=u._minx),u._maxx>this._maxx&&(this._maxx=u._maxx),u._miny<this._miny&&(this._miny=u._miny),u._maxy>this._maxy&&(this._maxy=u._maxy))}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];this.isNull()?(this._minx=h,this._maxx=h,this._miny=d,this._maxy=d):(h<this._minx&&(this._minx=h),h>this._maxx&&(this._maxx=h),d<this._miny&&(this._miny=d),d>this._maxy&&(this._maxy=d))}};le.prototype.minExtent=function(){if(this.isNull())return 0;var o=this.getWidth(),u=this.getHeight();return o<u?o:u};le.prototype.getWidth=function(){return this.isNull()?0:this._maxx-this._minx};le.prototype.compareTo=function(o){var u=o;return this.isNull()?u.isNull()?0:-1:u.isNull()?1:this._minx<u._minx?-1:this._minx>u._minx?1:this._miny<u._miny?-1:this._miny>u._miny?1:this._maxx<u._maxx?-1:this._maxx>u._maxx?1:this._maxy<u._maxy?-1:this._maxy>u._maxy?1:0};le.prototype.translate=function(o,u){if(this.isNull())return null;this.init(this.getMinX()+o,this.getMaxX()+o,this.getMinY()+u,this.getMaxY()+u)};le.prototype.toString=function(){return"Env["+this._minx+" : "+this._maxx+", "+this._miny+" : "+this._maxy+"]"};le.prototype.setToNull=function(){this._minx=0,this._maxx=-1,this._miny=0,this._maxy=-1};le.prototype.getHeight=function(){return this.isNull()?0:this._maxy-this._miny};le.prototype.maxExtent=function(){if(this.isNull())return 0;var o=this.getWidth(),u=this.getHeight();return o>u?o:u};le.prototype.expandBy=function(){if(arguments.length===1){var o=arguments[0];this.expandBy(o,o)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];if(this.isNull())return null;this._minx-=u,this._maxx+=u,this._miny-=h,this._maxy+=h,(this._minx>this._maxx||this._miny>this._maxy)&&this.setToNull()}};le.prototype.contains=function(){if(arguments.length===1){if(arguments[0]instanceof le){var o=arguments[0];return this.covers(o)}else if(arguments[0]instanceof st){var u=arguments[0];return this.covers(u)}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];return this.covers(h,d)}};le.prototype.centre=function(){return this.isNull()?null:new st((this.getMinX()+this.getMaxX())/2,(this.getMinY()+this.getMaxY())/2)};le.prototype.init=function(){if(arguments.length===0)this.setToNull();else if(arguments.length===1){if(arguments[0]instanceof st){var o=arguments[0];this.init(o.x,o.x,o.y,o.y)}else if(arguments[0]instanceof le){var u=arguments[0];this._minx=u._minx,this._maxx=u._maxx,this._miny=u._miny,this._maxy=u._maxy}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];this.init(h.x,d.x,h.y,d.y)}else if(arguments.length===4){var g=arguments[0],x=arguments[1],I=arguments[2],S=arguments[3];g<x?(this._minx=g,this._maxx=x):(this._minx=x,this._maxx=g),I<S?(this._miny=I,this._maxy=S):(this._miny=S,this._maxy=I)}};le.prototype.getMaxY=function(){return this._maxy};le.prototype.distance=function(o){if(this.intersects(o))return 0;var u=0;this._maxx<o._minx?u=o._minx-this._maxx:this._minx>o._maxx&&(u=this._minx-o._maxx);var h=0;return this._maxy<o._miny?h=o._miny-this._maxy:this._miny>o._maxy&&(h=this._miny-o._maxy),u===0?h:h===0?u:Math.sqrt(u*u+h*h)};le.prototype.hashCode=function(){var o=17;return o=37*o+st.hashCode(this._minx),o=37*o+st.hashCode(this._maxx),o=37*o+st.hashCode(this._miny),o=37*o+st.hashCode(this._maxy),o};le.prototype.interfaces_=function(){return[uo,co]};le.prototype.getClass=function(){return le};le.intersects=function(){if(arguments.length===3){var o=arguments[0],u=arguments[1],h=arguments[2];return h.x>=(o.x<u.x?o.x:u.x)&&h.x<=(o.x>u.x?o.x:u.x)&&h.y>=(o.y<u.y?o.y:u.y)&&h.y<=(o.y>u.y?o.y:u.y)}else if(arguments.length===4){var d=arguments[0],g=arguments[1],x=arguments[2],I=arguments[3],S=Math.min(x.x,I.x),D=Math.max(x.x,I.x),O=Math.min(d.x,g.x),B=Math.max(d.x,g.x);return!(O>D||B<S||(S=Math.min(x.y,I.y),D=Math.max(x.y,I.y),O=Math.min(d.y,g.y),B=Math.max(d.y,g.y),O>D)||B<S)}};$T.serialVersionUID.get=function(){return 5873921885273102e3};Object.defineProperties(le,$T);var Go={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,emptyTypeStr:/^\s*(\w+)\s*EMPTY\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},tm=function(o){this.geometryFactory=o||new He};tm.prototype.read=function(o){var u,h,d;o=o.replace(/[\n\r]/g," ");var g=Go.typeStr.exec(o);if(o.search("EMPTY")!==-1&&(g=Go.emptyTypeStr.exec(o),g[2]=void 0),g&&(h=g[1].toLowerCase(),d=g[2],_c[h]&&(u=_c[h].apply(this,[d]))),u===void 0)throw new Error("Could not parse WKT "+o);return u};tm.prototype.write=function(o){return this.extractGeometry(o)};tm.prototype.extractGeometry=function(o){var u=o.getGeometryType().toLowerCase();if(!js[u])return null;var h=u.toUpperCase(),d;return o.isEmpty()?d=h+" EMPTY":d=h+"("+js[u].apply(this,[o])+")",d};var js={coordinate:function(o){return o.x+" "+o.y},point:function(o){return js.coordinate.call(this,o._coordinates._coordinates[0])},multipoint:function(o){for(var u=this,h=[],d=0,g=o._geometries.length;d<g;++d)h.push("("+js.point.apply(u,[o._geometries[d]])+")");return h.join(",")},linestring:function(o){for(var u=this,h=[],d=0,g=o._points._coordinates.length;d<g;++d)h.push(js.coordinate.apply(u,[o._points._coordinates[d]]));return h.join(",")},linearring:function(o){for(var u=this,h=[],d=0,g=o._points._coordinates.length;d<g;++d)h.push(js.coordinate.apply(u,[o._points._coordinates[d]]));return h.join(",")},multilinestring:function(o){for(var u=this,h=[],d=0,g=o._geometries.length;d<g;++d)h.push("("+js.linestring.apply(u,[o._geometries[d]])+")");return h.join(",")},polygon:function(o){var u=this,h=[];h.push("("+js.linestring.apply(this,[o._shell])+")");for(var d=0,g=o._holes.length;d<g;++d)h.push("("+js.linestring.apply(u,[o._holes[d]])+")");return h.join(",")},multipolygon:function(o){for(var u=this,h=[],d=0,g=o._geometries.length;d<g;++d)h.push("("+js.polygon.apply(u,[o._geometries[d]])+")");return h.join(",")},geometrycollection:function(o){for(var u=this,h=[],d=0,g=o._geometries.length;d<g;++d)h.push(u.extractGeometry(o._geometries[d]));return h.join(",")}},_c={point:function(o){if(o===void 0)return this.geometryFactory.createPoint();var u=o.trim().split(Go.spaces);return this.geometryFactory.createPoint(new st(Number.parseFloat(u[0]),Number.parseFloat(u[1])))},multipoint:function(o){var u=this;if(o===void 0)return this.geometryFactory.createMultiPoint();for(var h,d=o.trim().split(","),g=[],x=0,I=d.length;x<I;++x)h=d[x].replace(Go.trimParens,"$1"),g.push(_c.point.apply(u,[h]));return this.geometryFactory.createMultiPoint(g)},linestring:function(o){if(o===void 0)return this.geometryFactory.createLineString();for(var u=o.trim().split(","),h=[],d,g=0,x=u.length;g<x;++g)d=u[g].trim().split(Go.spaces),h.push(new st(Number.parseFloat(d[0]),Number.parseFloat(d[1])));return this.geometryFactory.createLineString(h)},linearring:function(o){if(o===void 0)return this.geometryFactory.createLinearRing();for(var u=o.trim().split(","),h=[],d,g=0,x=u.length;g<x;++g)d=u[g].trim().split(Go.spaces),h.push(new st(Number.parseFloat(d[0]),Number.parseFloat(d[1])));return this.geometryFactory.createLinearRing(h)},multilinestring:function(o){var u=this;if(o===void 0)return this.geometryFactory.createMultiLineString();for(var h,d=o.trim().split(Go.parenComma),g=[],x=0,I=d.length;x<I;++x)h=d[x].replace(Go.trimParens,"$1"),g.push(_c.linestring.apply(u,[h]));return this.geometryFactory.createMultiLineString(g)},polygon:function(o){var u=this;if(o===void 0)return this.geometryFactory.createPolygon();for(var h,d,g,x=o.trim().split(Go.parenComma),I,S=[],D=0,O=x.length;D<O;++D)h=x[D].replace(Go.trimParens,"$1"),d=_c.linestring.apply(u,[h]),g=u.geometryFactory.createLinearRing(d._points),D===0?I=g:S.push(g);return this.geometryFactory.createPolygon(I,S)},multipolygon:function(o){var u=this;if(o===void 0)return this.geometryFactory.createMultiPolygon();for(var h,d=o.trim().split(Go.doubleParenComma),g=[],x=0,I=d.length;x<I;++x)h=d[x].replace(Go.trimParens,"$1"),g.push(_c.polygon.apply(u,[h]));return this.geometryFactory.createMultiPolygon(g)},geometrycollection:function(o){var u=this;if(o===void 0)return this.geometryFactory.createGeometryCollection();o=o.replace(/,\s*([A-Za-z])/g,"|$1");for(var h=o.trim().split("|"),d=[],g=0,x=h.length;g<x;++g)d.push(u.read(h[g]));return this.geometryFactory.createGeometryCollection(d)}},wo=function(o){this.parser=new tm(o)};wo.prototype.write=function(o){return this.parser.write(o)};wo.toLineString=function(o,u){if(arguments.length!==2)throw new Error("Not implemented");return"LINESTRING ( "+o.x+" "+o.y+", "+u.x+" "+u.y+" )"};var Hs=function(c){function o(u){c.call(this,u),this.name="RuntimeException",this.message=u,this.stack=new c().stack}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o}(Error),Ud=function(c){function o(){if(c.call(this),arguments.length===0)c.call(this);else if(arguments.length===1){var u=arguments[0];c.call(this,u)}}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Hs),Ze=function(){};Ze.prototype.interfaces_=function(){return[]};Ze.prototype.getClass=function(){return Ze};Ze.shouldNeverReachHere=function(){if(arguments.length===0)Ze.shouldNeverReachHere(null);else if(arguments.length===1){var o=arguments[0];throw new Ud("Should never reach here"+(o!==null?": "+o:""))}};Ze.isTrue=function(){var o,u;if(arguments.length===1)o=arguments[0],Ze.isTrue(o,null);else if(arguments.length===2&&(o=arguments[0],u=arguments[1],!o))throw u===null?new Ud:new Ud(u)};Ze.equals=function(){var o,u,h;if(arguments.length===2)o=arguments[0],u=arguments[1],Ze.equals(o,u,null);else if(arguments.length===3&&(o=arguments[0],u=arguments[1],h=arguments[2],!u.equals(o)))throw new Ud("Expected "+o+" but encountered "+u+(h!==null?": "+h:""))};var $r=function(){this._result=null,this._inputLines=Array(2).fill().map(function(){return Array(2)}),this._intPt=new Array(2).fill(null),this._intLineIndex=null,this._isProper=null,this._pa=null,this._pb=null,this._precisionModel=null,this._intPt[0]=new st,this._intPt[1]=new st,this._pa=this._intPt[0],this._pb=this._intPt[1],this._result=0},pu={DONT_INTERSECT:{configurable:!0},DO_INTERSECT:{configurable:!0},COLLINEAR:{configurable:!0},NO_INTERSECTION:{configurable:!0},POINT_INTERSECTION:{configurable:!0},COLLINEAR_INTERSECTION:{configurable:!0}};$r.prototype.getIndexAlongSegment=function(o,u){return this.computeIntLineIndex(),this._intLineIndex[o][u]};$r.prototype.getTopologySummary=function(){var o=new is;return this.isEndPoint()&&o.append(" endpoint"),this._isProper&&o.append(" proper"),this.isCollinear()&&o.append(" collinear"),o.toString()};$r.prototype.computeIntersection=function(o,u,h,d){this._inputLines[0][0]=o,this._inputLines[0][1]=u,this._inputLines[1][0]=h,this._inputLines[1][1]=d,this._result=this.computeIntersect(o,u,h,d)};$r.prototype.getIntersectionNum=function(){return this._result};$r.prototype.computeIntLineIndex=function(){if(arguments.length===0)this._intLineIndex===null&&(this._intLineIndex=Array(2).fill().map(function(){return Array(2)}),this.computeIntLineIndex(0),this.computeIntLineIndex(1));else if(arguments.length===1){var o=arguments[0],u=this.getEdgeDistance(o,0),h=this.getEdgeDistance(o,1);u>h?(this._intLineIndex[o][0]=0,this._intLineIndex[o][1]=1):(this._intLineIndex[o][0]=1,this._intLineIndex[o][1]=0)}};$r.prototype.isProper=function(){return this.hasIntersection()&&this._isProper};$r.prototype.setPrecisionModel=function(o){this._precisionModel=o};$r.prototype.isInteriorIntersection=function(){var o=this;if(arguments.length===0)return!!(this.isInteriorIntersection(0)||this.isInteriorIntersection(1));if(arguments.length===1){for(var u=arguments[0],h=0;h<this._result;h++)if(!(o._intPt[h].equals2D(o._inputLines[u][0])||o._intPt[h].equals2D(o._inputLines[u][1])))return!0;return!1}};$r.prototype.getIntersection=function(o){return this._intPt[o]};$r.prototype.isEndPoint=function(){return this.hasIntersection()&&!this._isProper};$r.prototype.hasIntersection=function(){return this._result!==$r.NO_INTERSECTION};$r.prototype.getEdgeDistance=function(o,u){var h=$r.computeEdgeDistance(this._intPt[u],this._inputLines[o][0],this._inputLines[o][1]);return h};$r.prototype.isCollinear=function(){return this._result===$r.COLLINEAR_INTERSECTION};$r.prototype.toString=function(){return wo.toLineString(this._inputLines[0][0],this._inputLines[0][1])+" - "+wo.toLineString(this._inputLines[1][0],this._inputLines[1][1])+this.getTopologySummary()};$r.prototype.getEndpoint=function(o,u){return this._inputLines[o][u]};$r.prototype.isIntersection=function(o){for(var u=this,h=0;h<this._result;h++)if(u._intPt[h].equals2D(o))return!0;return!1};$r.prototype.getIntersectionAlongSegment=function(o,u){return this.computeIntLineIndex(),this._intPt[this._intLineIndex[o][u]]};$r.prototype.interfaces_=function(){return[]};$r.prototype.getClass=function(){return $r};$r.computeEdgeDistance=function(o,u,h){var d=Math.abs(h.x-u.x),g=Math.abs(h.y-u.y),x=-1;if(o.equals(u))x=0;else if(o.equals(h))d>g?x=d:x=g;else{var I=Math.abs(o.x-u.x),S=Math.abs(o.y-u.y);d>g?x=I:x=S,x===0&&!o.equals(u)&&(x=Math.max(I,S))}return Ze.isTrue(!(x===0&&!o.equals(u)),"Bad distance calculation"),x};$r.nonRobustComputeEdgeDistance=function(o,u,h){var d=o.x-u.x,g=o.y-u.y,x=Math.sqrt(d*d+g*g);return Ze.isTrue(!(x===0&&!o.equals(u)),"Invalid distance calculation"),x};pu.DONT_INTERSECT.get=function(){return 0};pu.DO_INTERSECT.get=function(){return 1};pu.COLLINEAR.get=function(){return 2};pu.NO_INTERSECTION.get=function(){return 0};pu.POINT_INTERSECTION.get=function(){return 1};pu.COLLINEAR_INTERSECTION.get=function(){return 2};Object.defineProperties($r,pu);var Ml=function(c){function o(){c.apply(this,arguments)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.isInSegmentEnvelopes=function(h){var d=new le(this._inputLines[0][0],this._inputLines[0][1]),g=new le(this._inputLines[1][0],this._inputLines[1][1]);return d.contains(h)&&g.contains(h)},o.prototype.computeIntersection=function(){if(arguments.length===3){var h=arguments[0],d=arguments[1],g=arguments[2];if(this._isProper=!1,le.intersects(d,g,h)&&Kt.orientationIndex(d,g,h)===0&&Kt.orientationIndex(g,d,h)===0)return this._isProper=!0,(h.equals(d)||h.equals(g))&&(this._isProper=!1),this._result=c.POINT_INTERSECTION,null;this._result=c.NO_INTERSECTION}else return c.prototype.computeIntersection.apply(this,arguments)},o.prototype.normalizeToMinimum=function(h,d,g,x,I){I.x=this.smallestInAbsValue(h.x,d.x,g.x,x.x),I.y=this.smallestInAbsValue(h.y,d.y,g.y,x.y),h.x-=I.x,h.y-=I.y,d.x-=I.x,d.y-=I.y,g.x-=I.x,g.y-=I.y,x.x-=I.x,x.y-=I.y},o.prototype.safeHCoordinateIntersection=function(h,d,g,x){var I=null;try{I=xo.intersection(h,d,g,x)}catch(S){if(S instanceof Bc)I=o.nearestEndpoint(h,d,g,x);else throw S}finally{}return I},o.prototype.intersection=function(h,d,g,x){var I=this.intersectionWithNormalization(h,d,g,x);return this.isInSegmentEnvelopes(I)||(I=new st(o.nearestEndpoint(h,d,g,x))),this._precisionModel!==null&&this._precisionModel.makePrecise(I),I},o.prototype.smallestInAbsValue=function(h,d,g,x){var I=h,S=Math.abs(I);return Math.abs(d)<S&&(I=d,S=Math.abs(d)),Math.abs(g)<S&&(I=g,S=Math.abs(g)),Math.abs(x)<S&&(I=x),I},o.prototype.checkDD=function(h,d,g,x,I){var S=xi.intersection(h,d,g,x),D=this.isInSegmentEnvelopes(S);$n.out.println("DD in env = "+D+"  --------------------- "+S),I.distance(S)>1e-4&&$n.out.println("Distance = "+I.distance(S))},o.prototype.intersectionWithNormalization=function(h,d,g,x){var I=new st(h),S=new st(d),D=new st(g),O=new st(x),B=new st;this.normalizeToEnvCentre(I,S,D,O,B);var W=this.safeHCoordinateIntersection(I,S,D,O);return W.x+=B.x,W.y+=B.y,W},o.prototype.computeCollinearIntersection=function(h,d,g,x){var I=le.intersects(h,d,g),S=le.intersects(h,d,x),D=le.intersects(g,x,h),O=le.intersects(g,x,d);return I&&S?(this._intPt[0]=g,this._intPt[1]=x,c.COLLINEAR_INTERSECTION):D&&O?(this._intPt[0]=h,this._intPt[1]=d,c.COLLINEAR_INTERSECTION):I&&D?(this._intPt[0]=g,this._intPt[1]=h,g.equals(h)&&!S&&!O?c.POINT_INTERSECTION:c.COLLINEAR_INTERSECTION):I&&O?(this._intPt[0]=g,this._intPt[1]=d,g.equals(d)&&!S&&!D?c.POINT_INTERSECTION:c.COLLINEAR_INTERSECTION):S&&D?(this._intPt[0]=x,this._intPt[1]=h,x.equals(h)&&!I&&!O?c.POINT_INTERSECTION:c.COLLINEAR_INTERSECTION):S&&O?(this._intPt[0]=x,this._intPt[1]=d,x.equals(d)&&!I&&!D?c.POINT_INTERSECTION:c.COLLINEAR_INTERSECTION):c.NO_INTERSECTION},o.prototype.normalizeToEnvCentre=function(h,d,g,x,I){var S=h.x<d.x?h.x:d.x,D=h.y<d.y?h.y:d.y,O=h.x>d.x?h.x:d.x,B=h.y>d.y?h.y:d.y,W=g.x<x.x?g.x:x.x,et=g.y<x.y?g.y:x.y,it=g.x>x.x?g.x:x.x,bt=g.y>x.y?g.y:x.y,ft=S>W?S:W,Pt=O<it?O:it,kt=D>et?D:et,Nt=B<bt?B:bt,ne=(ft+Pt)/2,Te=(kt+Nt)/2;I.x=ne,I.y=Te,h.x-=I.x,h.y-=I.y,d.x-=I.x,d.y-=I.y,g.x-=I.x,g.y-=I.y,x.x-=I.x,x.y-=I.y},o.prototype.computeIntersect=function(h,d,g,x){if(this._isProper=!1,!le.intersects(h,d,g,x))return c.NO_INTERSECTION;var I=Kt.orientationIndex(h,d,g),S=Kt.orientationIndex(h,d,x);if(I>0&&S>0||I<0&&S<0)return c.NO_INTERSECTION;var D=Kt.orientationIndex(g,x,h),O=Kt.orientationIndex(g,x,d);if(D>0&&O>0||D<0&&O<0)return c.NO_INTERSECTION;var B=I===0&&S===0&&D===0&&O===0;return B?this.computeCollinearIntersection(h,d,g,x):(I===0||S===0||D===0||O===0?(this._isProper=!1,h.equals2D(g)||h.equals2D(x)?this._intPt[0]=h:d.equals2D(g)||d.equals2D(x)?this._intPt[0]=d:I===0?this._intPt[0]=new st(g):S===0?this._intPt[0]=new st(x):D===0?this._intPt[0]=new st(h):O===0&&(this._intPt[0]=new st(d))):(this._isProper=!0,this._intPt[0]=this.intersection(h,d,g,x)),c.POINT_INTERSECTION)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o.nearestEndpoint=function(h,d,g,x){var I=h,S=Kt.distancePointLine(h,g,x),D=Kt.distancePointLine(d,g,x);return D<S&&(S=D,I=d),D=Kt.distancePointLine(g,h,d),D<S&&(S=D,I=g),D=Kt.distancePointLine(x,h,d),D<S&&(S=D,I=x),I},o}($r),Ql=function(){};Ql.prototype.interfaces_=function(){return[]};Ql.prototype.getClass=function(){return Ql};Ql.orientationIndex=function(o,u,h){var d=u.x-o.x,g=u.y-o.y,x=h.x-u.x,I=h.y-u.y;return Ql.signOfDet2x2(d,g,x,I)};Ql.signOfDet2x2=function(o,u,h,d){var g=null,x=null,I=null;if(g=1,o===0||d===0)return u===0||h===0?0:u>0?h>0?-g:g:h>0?g:-g;if(u===0||h===0)return d>0?o>0?g:-g:o>0?-g:g;if(u>0?d>0?u<=d||(g=-g,x=o,o=h,h=x,x=u,u=d,d=x):u<=-d?(g=-g,h=-h,d=-d):(x=o,o=-h,h=x,x=u,u=-d,d=x):d>0?-u<=d?(g=-g,o=-o,u=-u):(x=-o,o=h,h=x,x=-u,u=d,d=x):u>=d?(o=-o,u=-u,h=-h,d=-d):(g=-g,x=-o,o=-h,h=x,x=-u,u=-d,d=x),o>0)if(h>0){if(!(o<=h))return g}else return g;else{if(h>0)return-g;if(o>=h)g=-g,o=-o,h=-h;else return-g}for(;;){if(I=Math.floor(h/o),h=h-I*o,d=d-I*u,d<0)return-g;if(d>u)return g;if(o>h+h){if(u<d+d)return g}else{if(u>d+d)return-g;h=o-h,d=u-d,g=-g}if(d===0)return h===0?0:-g;if(h===0||(I=Math.floor(o/h),o=o-I*h,u=u-I*d,u<0))return g;if(u>d)return-g;if(h>o+o){if(d<u+u)return-g}else{if(d>u+u)return g;o=h-o,u=d-u,g=-g}if(u===0)return o===0?0:g;if(o===0)return-g}};var Xo=function(){this._p=null,this._crossingCount=0,this._isPointOnSegment=!1;var o=arguments[0];this._p=o};Xo.prototype.countSegment=function(o,u){if(o.x<this._p.x&&u.x<this._p.x)return null;if(this._p.x===u.x&&this._p.y===u.y)return this._isPointOnSegment=!0,null;if(o.y===this._p.y&&u.y===this._p.y){var h=o.x,d=u.x;return h>d&&(h=u.x,d=o.x),this._p.x>=h&&this._p.x<=d&&(this._isPointOnSegment=!0),null}if(o.y>this._p.y&&u.y<=this._p.y||u.y>this._p.y&&o.y<=this._p.y){var g=o.x-this._p.x,x=o.y-this._p.y,I=u.x-this._p.x,S=u.y-this._p.y,D=Ql.signOfDet2x2(g,x,I,S);if(D===0)return this._isPointOnSegment=!0,null;S<x&&(D=-D),D>0&&this._crossingCount++}};Xo.prototype.isPointInPolygon=function(){return this.getLocation()!==ut.EXTERIOR};Xo.prototype.getLocation=function(){return this._isPointOnSegment?ut.BOUNDARY:this._crossingCount%2===1?ut.INTERIOR:ut.EXTERIOR};Xo.prototype.isOnSegment=function(){return this._isPointOnSegment};Xo.prototype.interfaces_=function(){return[]};Xo.prototype.getClass=function(){return Xo};Xo.locatePointInRing=function(){if(arguments[0]instanceof st&&Ee(arguments[1],nr)){for(var o=arguments[0],u=arguments[1],h=new Xo(o),d=new st,g=new st,x=1;x<u.size();x++)if(u.getCoordinate(x,d),u.getCoordinate(x-1,g),h.countSegment(d,g),h.isOnSegment())return h.getLocation();return h.getLocation()}else if(arguments[0]instanceof st&&arguments[1]instanceof Array){for(var I=arguments[0],S=arguments[1],D=new Xo(I),O=1;O<S.length;O++){var B=S[O],W=S[O-1];if(D.countSegment(B,W),D.isOnSegment())return D.getLocation()}return D.getLocation()}};var Kt=function(){},fu={CLOCKWISE:{configurable:!0},RIGHT:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},LEFT:{configurable:!0},COLLINEAR:{configurable:!0},STRAIGHT:{configurable:!0}};Kt.prototype.interfaces_=function(){return[]};Kt.prototype.getClass=function(){return Kt};Kt.orientationIndex=function(o,u,h){return xi.orientationIndex(o,u,h)};Kt.signedArea=function(){if(arguments[0]instanceof Array){var o=arguments[0];if(o.length<3)return 0;for(var u=0,h=o[0].x,d=1;d<o.length-1;d++){var g=o[d].x-h,x=o[d+1].y,I=o[d-1].y;u+=g*(I-x)}return u/2}else if(Ee(arguments[0],nr)){var S=arguments[0],D=S.size();if(D<3)return 0;var O=new st,B=new st,W=new st;S.getCoordinate(0,B),S.getCoordinate(1,W);var et=B.x;W.x-=et;for(var it=0,bt=1;bt<D-1;bt++)O.y=B.y,B.x=W.x,B.y=W.y,S.getCoordinate(bt+1,W),W.x-=et,it+=B.x*(O.y-W.y);return it/2}};Kt.distanceLineLine=function(o,u,h,d){if(o.equals(u))return Kt.distancePointLine(o,h,d);if(h.equals(d))return Kt.distancePointLine(d,o,u);var g=!1;if(!le.intersects(o,u,h,d))g=!0;else{var x=(u.x-o.x)*(d.y-h.y)-(u.y-o.y)*(d.x-h.x);if(x===0)g=!0;else{var I=(o.y-h.y)*(d.x-h.x)-(o.x-h.x)*(d.y-h.y),S=(o.y-h.y)*(u.x-o.x)-(o.x-h.x)*(u.y-o.y),D=S/x,O=I/x;(O<0||O>1||D<0||D>1)&&(g=!0)}}return g?Vi.min(Kt.distancePointLine(o,h,d),Kt.distancePointLine(u,h,d),Kt.distancePointLine(h,o,u),Kt.distancePointLine(d,o,u)):0};Kt.isPointInRing=function(o,u){return Kt.locatePointInRing(o,u)!==ut.EXTERIOR};Kt.computeLength=function(o){var u=o.size();if(u<=1)return 0;var h=0,d=new st;o.getCoordinate(0,d);for(var g=d.x,x=d.y,I=1;I<u;I++){o.getCoordinate(I,d);var S=d.x,D=d.y,O=S-g,B=D-x;h+=Math.sqrt(O*O+B*B),g=S,x=D}return h};Kt.isCCW=function(o){var u=o.length-1;if(u<3)throw new Xr("Ring has fewer than 4 points, so orientation cannot be determined");for(var h=o[0],d=0,g=1;g<=u;g++){var x=o[g];x.y>h.y&&(h=x,d=g)}var I=d;do I=I-1,I<0&&(I=u);while(o[I].equals2D(h)&&I!==d);var S=d;do S=(S+1)%u;while(o[S].equals2D(h)&&S!==d);var D=o[I],O=o[S];if(D.equals2D(h)||O.equals2D(h)||D.equals2D(O))return!1;var B=Kt.computeOrientation(D,h,O),W=!1;return B===0?W=D.x>O.x:W=B>0,W};Kt.locatePointInRing=function(o,u){return Xo.locatePointInRing(o,u)};Kt.distancePointLinePerpendicular=function(o,u,h){var d=(h.x-u.x)*(h.x-u.x)+(h.y-u.y)*(h.y-u.y),g=((u.y-o.y)*(h.x-u.x)-(u.x-o.x)*(h.y-u.y))/d;return Math.abs(g)*Math.sqrt(d)};Kt.computeOrientation=function(o,u,h){return Kt.orientationIndex(o,u,h)};Kt.distancePointLine=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1];if(u.length===0)throw new Xr("Line array must contain at least one vertex");for(var h=o.distance(u[0]),d=0;d<u.length-1;d++){var g=Kt.distancePointLine(o,u[d],u[d+1]);g<h&&(h=g)}return h}else if(arguments.length===3){var x=arguments[0],I=arguments[1],S=arguments[2];if(I.x===S.x&&I.y===S.y)return x.distance(I);var D=(S.x-I.x)*(S.x-I.x)+(S.y-I.y)*(S.y-I.y),O=((x.x-I.x)*(S.x-I.x)+(x.y-I.y)*(S.y-I.y))/D;if(O<=0)return x.distance(I);if(O>=1)return x.distance(S);var B=((I.y-x.y)*(S.x-I.x)-(I.x-x.x)*(S.y-I.y))/D;return Math.abs(B)*Math.sqrt(D)}};Kt.isOnLine=function(o,u){for(var h=new Ml,d=1;d<u.length;d++){var g=u[d-1],x=u[d];if(h.computeIntersection(o,g,x),h.hasIntersection())return!0}return!1};fu.CLOCKWISE.get=function(){return-1};fu.RIGHT.get=function(){return Kt.CLOCKWISE};fu.COUNTERCLOCKWISE.get=function(){return 1};fu.LEFT.get=function(){return Kt.COUNTERCLOCKWISE};fu.COLLINEAR.get=function(){return 0};fu.STRAIGHT.get=function(){return Kt.COLLINEAR};Object.defineProperties(Kt,fu);var Ys=function(){};Ys.prototype.filter=function(o){};Ys.prototype.interfaces_=function(){return[]};Ys.prototype.getClass=function(){return Ys};var be=function(){var o=arguments[0];this._envelope=null,this._factory=null,this._SRID=null,this._userData=null,this._factory=o,this._SRID=o.getSRID()},As={serialVersionUID:{configurable:!0},SORTINDEX_POINT:{configurable:!0},SORTINDEX_MULTIPOINT:{configurable:!0},SORTINDEX_LINESTRING:{configurable:!0},SORTINDEX_LINEARRING:{configurable:!0},SORTINDEX_MULTILINESTRING:{configurable:!0},SORTINDEX_POLYGON:{configurable:!0},SORTINDEX_MULTIPOLYGON:{configurable:!0},SORTINDEX_GEOMETRYCOLLECTION:{configurable:!0},geometryChangedFilter:{configurable:!0}};be.prototype.isGeometryCollection=function(){return this.getSortIndex()===be.SORTINDEX_GEOMETRYCOLLECTION};be.prototype.getFactory=function(){return this._factory};be.prototype.getGeometryN=function(o){return this};be.prototype.getArea=function(){return 0};be.prototype.isRectangle=function(){return!1};be.prototype.equals=function(){if(arguments[0]instanceof be){var o=arguments[0];return o===null?!1:this.equalsTopo(o)}else if(arguments[0]instanceof Object){var u=arguments[0];if(!(u instanceof be))return!1;var h=u;return this.equalsExact(h)}};be.prototype.equalsExact=function(o){return this===o||this.equalsExact(o,0)};be.prototype.geometryChanged=function(){this.apply(be.geometryChangedFilter)};be.prototype.geometryChangedAction=function(){this._envelope=null};be.prototype.equalsNorm=function(o){return o===null?!1:this.norm().equalsExact(o.norm())};be.prototype.getLength=function(){return 0};be.prototype.getNumGeometries=function(){return 1};be.prototype.compareTo=function(){if(arguments.length===1){var o=arguments[0],u=o;return this.getSortIndex()!==u.getSortIndex()?this.getSortIndex()-u.getSortIndex():this.isEmpty()&&u.isEmpty()?0:this.isEmpty()?-1:u.isEmpty()?1:this.compareToSameClass(o)}else if(arguments.length===2){var h=arguments[0],d=arguments[1];return this.getSortIndex()!==h.getSortIndex()?this.getSortIndex()-h.getSortIndex():this.isEmpty()&&h.isEmpty()?0:this.isEmpty()?-1:h.isEmpty()?1:this.compareToSameClass(h,d)}};be.prototype.getUserData=function(){return this._userData};be.prototype.getSRID=function(){return this._SRID};be.prototype.getEnvelope=function(){return this.getFactory().toGeometry(this.getEnvelopeInternal())};be.prototype.checkNotGeometryCollection=function(o){if(o.getSortIndex()===be.SORTINDEX_GEOMETRYCOLLECTION)throw new Xr("This method does not support GeometryCollection arguments")};be.prototype.equal=function(o,u,h){return h===0?o.equals(u):o.distance(u)<=h};be.prototype.norm=function(){var o=this.copy();return o.normalize(),o};be.prototype.getPrecisionModel=function(){return this._factory.getPrecisionModel()};be.prototype.getEnvelopeInternal=function(){return this._envelope===null&&(this._envelope=this.computeEnvelopeInternal()),new le(this._envelope)};be.prototype.setSRID=function(o){this._SRID=o};be.prototype.setUserData=function(o){this._userData=o};be.prototype.compare=function(o,u){for(var h=o.iterator(),d=u.iterator();h.hasNext()&&d.hasNext();){var g=h.next(),x=d.next(),I=g.compareTo(x);if(I!==0)return I}return h.hasNext()?1:d.hasNext()?-1:0};be.prototype.hashCode=function(){return this.getEnvelopeInternal().hashCode()};be.prototype.isGeometryCollectionOrDerived=function(){return this.getSortIndex()===be.SORTINDEX_GEOMETRYCOLLECTION||this.getSortIndex()===be.SORTINDEX_MULTIPOINT||this.getSortIndex()===be.SORTINDEX_MULTILINESTRING||this.getSortIndex()===be.SORTINDEX_MULTIPOLYGON};be.prototype.interfaces_=function(){return[Qd,uo,co]};be.prototype.getClass=function(){return be};be.hasNonEmptyElements=function(o){for(var u=0;u<o.length;u++)if(!o[u].isEmpty())return!0;return!1};be.hasNullElements=function(o){for(var u=0;u<o.length;u++)if(o[u]===null)return!0;return!1};As.serialVersionUID.get=function(){return 8763622679187377e3};As.SORTINDEX_POINT.get=function(){return 0};As.SORTINDEX_MULTIPOINT.get=function(){return 1};As.SORTINDEX_LINESTRING.get=function(){return 2};As.SORTINDEX_LINEARRING.get=function(){return 3};As.SORTINDEX_MULTILINESTRING.get=function(){return 4};As.SORTINDEX_POLYGON.get=function(){return 5};As.SORTINDEX_MULTIPOLYGON.get=function(){return 6};As.SORTINDEX_GEOMETRYCOLLECTION.get=function(){return 7};As.geometryChangedFilter.get=function(){return cv};Object.defineProperties(be,As);var cv=function(){};cv.interfaces_=function(){return[Ys]};cv.filter=function(o){o.geometryChangedAction()};var xs=function(){};xs.prototype.filter=function(o){};xs.prototype.interfaces_=function(){return[]};xs.prototype.getClass=function(){return xs};var so=function(){},ta={Mod2BoundaryNodeRule:{configurable:!0},EndPointBoundaryNodeRule:{configurable:!0},MultiValentEndPointBoundaryNodeRule:{configurable:!0},MonoValentEndPointBoundaryNodeRule:{configurable:!0},MOD2_BOUNDARY_RULE:{configurable:!0},ENDPOINT_BOUNDARY_RULE:{configurable:!0},MULTIVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},MONOVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},OGC_SFS_BOUNDARY_RULE:{configurable:!0}};so.prototype.isInBoundary=function(o){};so.prototype.interfaces_=function(){return[]};so.prototype.getClass=function(){return so};ta.Mod2BoundaryNodeRule.get=function(){return xc};ta.EndPointBoundaryNodeRule.get=function(){return bc};ta.MultiValentEndPointBoundaryNodeRule.get=function(){return wc};ta.MonoValentEndPointBoundaryNodeRule.get=function(){return Ec};ta.MOD2_BOUNDARY_RULE.get=function(){return new xc};ta.ENDPOINT_BOUNDARY_RULE.get=function(){return new bc};ta.MULTIVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new wc};ta.MONOVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new Ec};ta.OGC_SFS_BOUNDARY_RULE.get=function(){return so.MOD2_BOUNDARY_RULE};Object.defineProperties(so,ta);var xc=function(){};xc.prototype.isInBoundary=function(o){return o%2===1};xc.prototype.interfaces_=function(){return[so]};xc.prototype.getClass=function(){return xc};var bc=function(){};bc.prototype.isInBoundary=function(o){return o>0};bc.prototype.interfaces_=function(){return[so]};bc.prototype.getClass=function(){return bc};var wc=function(){};wc.prototype.isInBoundary=function(o){return o>1};wc.prototype.interfaces_=function(){return[so]};wc.prototype.getClass=function(){return wc};var Ec=function(){};Ec.prototype.isInBoundary=function(o){return o===1};Ec.prototype.interfaces_=function(){return[so]};Ec.prototype.getClass=function(){return Ec};var En=function(){};En.prototype.add=function(){};En.prototype.addAll=function(){};En.prototype.isEmpty=function(){};En.prototype.iterator=function(){};En.prototype.size=function(){};En.prototype.toArray=function(){};En.prototype.remove=function(){};function hv(c){this.message=c||""}hv.prototype=new Error;hv.prototype.name="IndexOutOfBoundsException";var Vc=function(){};Vc.prototype.hasNext=function(){};Vc.prototype.next=function(){};Vc.prototype.remove=function(){};var bo=function(c){function o(){c.apply(this,arguments)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.get=function(){},o.prototype.set=function(){},o.prototype.isEmpty=function(){},o}(En);function Uc(c){this.message=c||""}Uc.prototype=new Error;Uc.prototype.name="NoSuchElementException";var jt=function(c){function o(){c.call(this),this.array_=[],arguments[0]instanceof En&&this.addAll(arguments[0])}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.ensureCapacity=function(){},o.prototype.interfaces_=function(){return[c,En]},o.prototype.add=function(h){return arguments.length===1?this.array_.push(h):this.array_.splice(arguments[0],arguments[1]),!0},o.prototype.clear=function(){this.array_=[]},o.prototype.addAll=function(h){for(var d=this,g=h.iterator();g.hasNext();)d.add(g.next());return!0},o.prototype.set=function(h,d){var g=this.array_[h];return this.array_[h]=d,g},o.prototype.iterator=function(){return new oO(this)},o.prototype.get=function(h){if(h<0||h>=this.size())throw new hv;return this.array_[h]},o.prototype.isEmpty=function(){return this.array_.length===0},o.prototype.size=function(){return this.array_.length},o.prototype.toArray=function(){for(var h=this,d=[],g=0,x=this.array_.length;g<x;g++)d.push(h.array_[g]);return d},o.prototype.remove=function(h){for(var d=this,g=!1,x=0,I=this.array_.length;x<I;x++)if(d.array_[x]===h){d.array_.splice(x,1),g=!0;break}return g},o}(bo),oO=function(c){function o(u){c.call(this),this.arrayList_=u,this.position_=0}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.next=function(){if(this.position_===this.arrayList_.size())throw new Uc;return this.arrayList_.get(this.position_++)},o.prototype.hasNext=function(){return this.position_<this.arrayList_.size()},o.prototype.set=function(h){return this.arrayList_.set(this.position_-1,h)},o.prototype.remove=function(){this.arrayList_.remove(this.arrayList_.get(this.position_))},o}(Vc),yp=function(c){function o(){if(c.call(this),arguments.length!==0){if(arguments.length===1){var h=arguments[0];this.ensureCapacity(h.length),this.add(h,!0)}else if(arguments.length===2){var d=arguments[0],g=arguments[1];this.ensureCapacity(d.length),this.add(d,g)}}}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={coordArrayType:{configurable:!0}};return u.coordArrayType.get=function(){return new Array(0).fill(null)},o.prototype.getCoordinate=function(d){return this.get(d)},o.prototype.addAll=function(){var d=this;if(arguments.length===2){for(var g=arguments[0],x=arguments[1],I=!1,S=g.iterator();S.hasNext();)d.add(S.next(),x),I=!0;return I}else return c.prototype.addAll.apply(this,arguments)},o.prototype.clone=function(){for(var d=this,g=c.prototype.clone.call(this),x=0;x<this.size();x++)g.add(x,d.get(x).copy());return g},o.prototype.toCoordinateArray=function(){return this.toArray(o.coordArrayType)},o.prototype.add=function(){var d=this;if(arguments.length===1){var g=arguments[0];c.prototype.add.call(this,g)}else if(arguments.length===2){if(arguments[0]instanceof Array&&typeof arguments[1]=="boolean"){var x=arguments[0],I=arguments[1];return this.add(x,I,!0),!0}else if(arguments[0]instanceof st&&typeof arguments[1]=="boolean"){var S=arguments[0],D=arguments[1];if(!D&&this.size()>=1){var O=this.get(this.size()-1);if(O.equals2D(S))return null}c.prototype.add.call(this,S)}else if(arguments[0]instanceof Object&&typeof arguments[1]=="boolean"){var B=arguments[0],W=arguments[1];return this.add(B,W),!0}}else if(arguments.length===3){if(typeof arguments[2]=="boolean"&&arguments[0]instanceof Array&&typeof arguments[1]=="boolean"){var et=arguments[0],it=arguments[1],bt=arguments[2];if(bt)for(var ft=0;ft<et.length;ft++)d.add(et[ft],it);else for(var Pt=et.length-1;Pt>=0;Pt--)d.add(et[Pt],it);return!0}else if(typeof arguments[2]=="boolean"&&Number.isInteger(arguments[0])&&arguments[1]instanceof st){var kt=arguments[0],Nt=arguments[1],ne=arguments[2];if(!ne){var Te=this.size();if(Te>0){if(kt>0){var we=this.get(kt-1);if(we.equals2D(Nt))return null}if(kt<Te){var Ve=this.get(kt);if(Ve.equals2D(Nt))return null}}}c.prototype.add.call(this,kt,Nt)}}else if(arguments.length===4){var Ne=arguments[0],H=arguments[1],ue=arguments[2],Tr=arguments[3],Ir=1;ue>Tr&&(Ir=-1);for(var re=ue;re!==Tr;re+=Ir)d.add(Ne[re],H);return!0}},o.prototype.closeRing=function(){this.size()>0&&this.add(new st(this.get(0)),!1)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},Object.defineProperties(o,u),o}(jt),Ye=function(){},em={ForwardComparator:{configurable:!0},BidirectionalComparator:{configurable:!0},coordArrayType:{configurable:!0}};em.ForwardComparator.get=function(){return tp};em.BidirectionalComparator.get=function(){return Tc};em.coordArrayType.get=function(){return new Array(0).fill(null)};Ye.prototype.interfaces_=function(){return[]};Ye.prototype.getClass=function(){return Ye};Ye.isRing=function(o){return!(o.length<4||!o[0].equals2D(o[o.length-1]))};Ye.ptNotInList=function(o,u){for(var h=0;h<o.length;h++){var d=o[h];if(Ye.indexOf(d,u)<0)return d}return null};Ye.scroll=function(o,u){var h=Ye.indexOf(u,o);if(h<0)return null;var d=new Array(o.length).fill(null);$n.arraycopy(o,h,d,0,o.length-h),$n.arraycopy(o,0,d,o.length-h,h),$n.arraycopy(d,0,o,0,o.length)};Ye.equals=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1];if(o===u)return!0;if(o===null||u===null||o.length!==u.length)return!1;for(var h=0;h<o.length;h++)if(!o[h].equals(u[h]))return!1;return!0}else if(arguments.length===3){var d=arguments[0],g=arguments[1],x=arguments[2];if(d===g)return!0;if(d===null||g===null||d.length!==g.length)return!1;for(var I=0;I<d.length;I++)if(x.compare(d[I],g[I])!==0)return!1;return!0}};Ye.intersection=function(o,u){for(var h=new yp,d=0;d<o.length;d++)u.intersects(o[d])&&h.add(o[d],!0);return h.toCoordinateArray()};Ye.hasRepeatedPoints=function(o){for(var u=1;u<o.length;u++)if(o[u-1].equals(o[u]))return!0;return!1};Ye.removeRepeatedPoints=function(o){if(!Ye.hasRepeatedPoints(o))return o;var u=new yp(o,!1);return u.toCoordinateArray()};Ye.reverse=function(o){for(var u=o.length-1,h=Math.trunc(u/2),d=0;d<=h;d++){var g=o[d];o[d]=o[u-d],o[u-d]=g}};Ye.removeNull=function(o){for(var u=0,h=0;h<o.length;h++)o[h]!==null&&u++;var d=new Array(u).fill(null);if(u===0)return d;for(var g=0,x=0;x<o.length;x++)o[x]!==null&&(d[g++]=o[x]);return d};Ye.copyDeep=function(){if(arguments.length===1){for(var o=arguments[0],u=new Array(o.length).fill(null),h=0;h<o.length;h++)u[h]=new st(o[h]);return u}else if(arguments.length===5)for(var d=arguments[0],g=arguments[1],x=arguments[2],I=arguments[3],S=arguments[4],D=0;D<S;D++)x[I+D]=new st(d[g+D])};Ye.isEqualReversed=function(o,u){for(var h=0;h<o.length;h++){var d=o[h],g=u[o.length-h-1];if(d.compareTo(g)!==0)return!1}return!0};Ye.envelope=function(o){for(var u=new le,h=0;h<o.length;h++)u.expandToInclude(o[h]);return u};Ye.toCoordinateArray=function(o){return o.toArray(Ye.coordArrayType)};Ye.atLeastNCoordinatesOrNothing=function(o,u){return u.length>=o?u:[]};Ye.indexOf=function(o,u){for(var h=0;h<u.length;h++)if(o.equals(u[h]))return h;return-1};Ye.increasingDirection=function(o){for(var u=0;u<Math.trunc(o.length/2);u++){var h=o.length-1-u,d=o[u].compareTo(o[h]);if(d!==0)return d}return 1};Ye.compare=function(o,u){for(var h=0;h<o.length&&h<u.length;){var d=o[h].compareTo(u[h]);if(d!==0)return d;h++}return h<u.length?-1:h<o.length?1:0};Ye.minCoordinate=function(o){for(var u=null,h=0;h<o.length;h++)(u===null||u.compareTo(o[h])>0)&&(u=o[h]);return u};Ye.extract=function(o,u,h){u=Vi.clamp(u,0,o.length),h=Vi.clamp(h,-1,o.length);var d=h-u+1;h<0&&(d=0),u>=o.length&&(d=0),h<u&&(d=0);var g=new Array(d).fill(null);if(d===0)return g;for(var x=0,I=u;I<=h;I++)g[x++]=o[I];return g};Object.defineProperties(Ye,em);var tp=function(){};tp.prototype.compare=function(o,u){var h=o,d=u;return Ye.compare(h,d)};tp.prototype.interfaces_=function(){return[yc]};tp.prototype.getClass=function(){return tp};var Tc=function(){};Tc.prototype.compare=function(o,u){var h=o,d=u;if(h.length<d.length)return-1;if(h.length>d.length)return 1;if(h.length===0)return 0;var g=Ye.compare(h,d),x=Ye.isEqualReversed(h,d);return x?0:g};Tc.prototype.OLDcompare=function(o,u){var h=o,d=u;if(h.length<d.length)return-1;if(h.length>d.length)return 1;if(h.length===0)return 0;for(var g=Ye.increasingDirection(h),x=Ye.increasingDirection(d),I=g>0?0:h.length-1,S=x>0?0:h.length-1,D=0;D<h.length;D++){var O=h[I].compareTo(d[S]);if(O!==0)return O;I+=g,S+=x}return 0};Tc.prototype.interfaces_=function(){return[yc]};Tc.prototype.getClass=function(){return Tc};var du=function(){};du.prototype.get=function(){};du.prototype.put=function(){};du.prototype.size=function(){};du.prototype.values=function(){};du.prototype.entrySet=function(){};var sO=function(c){function o(){c.apply(this,arguments)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o}(du);function vp(c){this.message=c||""}vp.prototype=new Error;vp.prototype.name="OperationNotSupported";function rm(){}rm.prototype=new En;rm.prototype.contains=function(){};var pv=function(c){function o(){c.call(this),this.array_=[],arguments[0]instanceof En&&this.addAll(arguments[0])}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.contains=function(h){for(var d=this,g=0,x=this.array_.length;g<x;g++){var I=d.array_[g];if(I===h)return!0}return!1},o.prototype.add=function(h){return this.contains(h)?!1:(this.array_.push(h),!0)},o.prototype.addAll=function(h){for(var d=this,g=h.iterator();g.hasNext();)d.add(g.next());return!0},o.prototype.remove=function(h){throw new Error},o.prototype.size=function(){return this.array_.length},o.prototype.isEmpty=function(){return this.array_.length===0},o.prototype.toArray=function(){for(var h=this,d=[],g=0,x=this.array_.length;g<x;g++)d.push(h.array_[g]);return d},o.prototype.iterator=function(){return new aO(this)},o}(rm),aO=function(c){function o(u){c.call(this),this.hashSet_=u,this.position_=0}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.next=function(){if(this.position_===this.hashSet_.size())throw new Uc;return this.hashSet_.array_[this.position_++]},o.prototype.hasNext=function(){return this.position_<this.hashSet_.size()},o.prototype.remove=function(){throw new vp},o}(Vc),Zs=0,ml=1;function yT(c){return c===null?Zs:c.color}function Rr(c){return c===null?null:c.parent}function Gs(c,o){c!==null&&(c.color=o)}function Xy(c){return c===null?null:c.left}function vT(c){return c===null?null:c.right}function ii(){this.root_=null,this.size_=0}ii.prototype=new sO;ii.prototype.get=function(c){for(var o=this.root_;o!==null;){var u=c.compareTo(o.key);if(u<0)o=o.left;else if(u>0)o=o.right;else return o.value}return null};ii.prototype.put=function(c,o){if(this.root_===null)return this.root_={key:c,value:o,left:null,right:null,parent:null,color:Zs,getValue:function(){return this.value},getKey:function(){return this.key}},this.size_=1,null;var u=this.root_,h,d;do if(h=u,d=c.compareTo(u.key),d<0)u=u.left;else if(d>0)u=u.right;else{var g=u.value;return u.value=o,g}while(u!==null);var x={key:c,left:null,right:null,value:o,parent:h,color:Zs,getValue:function(){return this.value},getKey:function(){return this.key}};return d<0?h.left=x:h.right=x,this.fixAfterInsertion(x),this.size_++,null};ii.prototype.fixAfterInsertion=function(c){var o=this;for(c.color=ml;c!=null&&c!==this.root_&&c.parent.color===ml;)if(Rr(c)===Xy(Rr(Rr(c)))){var u=vT(Rr(Rr(c)));yT(u)===ml?(Gs(Rr(c),Zs),Gs(u,Zs),Gs(Rr(Rr(c)),ml),c=Rr(Rr(c))):(c===vT(Rr(c))&&(c=Rr(c),o.rotateLeft(c)),Gs(Rr(c),Zs),Gs(Rr(Rr(c)),ml),o.rotateRight(Rr(Rr(c))))}else{var h=Xy(Rr(Rr(c)));yT(h)===ml?(Gs(Rr(c),Zs),Gs(h,Zs),Gs(Rr(Rr(c)),ml),c=Rr(Rr(c))):(c===Xy(Rr(c))&&(c=Rr(c),o.rotateRight(c)),Gs(Rr(c),Zs),Gs(Rr(Rr(c)),ml),o.rotateLeft(Rr(Rr(c))))}this.root_.color=Zs};ii.prototype.values=function(){var c=new jt,o=this.getFirstEntry();if(o!==null)for(c.add(o.value);(o=ii.successor(o))!==null;)c.add(o.value);return c};ii.prototype.entrySet=function(){var c=new pv,o=this.getFirstEntry();if(o!==null)for(c.add(o);(o=ii.successor(o))!==null;)c.add(o);return c};ii.prototype.rotateLeft=function(c){if(c!=null){var o=c.right;c.right=o.left,o.left!=null&&(o.left.parent=c),o.parent=c.parent,c.parent===null?this.root_=o:c.parent.left===c?c.parent.left=o:c.parent.right=o,o.left=c,c.parent=o}};ii.prototype.rotateRight=function(c){if(c!=null){var o=c.left;c.left=o.right,o.right!=null&&(o.right.parent=c),o.parent=c.parent,c.parent===null?this.root_=o:c.parent.right===c?c.parent.right=o:c.parent.left=o,o.right=c,c.parent=o}};ii.prototype.getFirstEntry=function(){var c=this.root_;if(c!=null)for(;c.left!=null;)c=c.left;return c};ii.successor=function(c){if(c===null)return null;if(c.right!==null){for(var o=c.right;o.left!==null;)o=o.left;return o}else{for(var u=c.parent,h=c;u!==null&&h===u.right;)h=u,u=u.parent;return u}};ii.prototype.size=function(){return this.size_};var ep=function(){};ep.prototype.interfaces_=function(){return[]};ep.prototype.getClass=function(){return ep};function KT(){}KT.prototype=new rm;function Yo(){this.array_=[],arguments[0]instanceof En&&this.addAll(arguments[0])}Yo.prototype=new KT;Yo.prototype.contains=function(c){for(var o=this,u=0,h=this.array_.length;u<h;u++){var d=o.array_[u];if(d.compareTo(c)===0)return!0}return!1};Yo.prototype.add=function(c){var o=this;if(this.contains(c))return!1;for(var u=0,h=this.array_.length;u<h;u++){var d=o.array_[u];if(d.compareTo(c)===1)return o.array_.splice(u,0,c),!0}return this.array_.push(c),!0};Yo.prototype.addAll=function(c){for(var o=this,u=c.iterator();u.hasNext();)o.add(u.next());return!0};Yo.prototype.remove=function(c){throw new vp};Yo.prototype.size=function(){return this.array_.length};Yo.prototype.isEmpty=function(){return this.array_.length===0};Yo.prototype.toArray=function(){for(var c=this,o=[],u=0,h=this.array_.length;u<h;u++)o.push(c.array_[u]);return o};Yo.prototype.iterator=function(){return new nm(this)};var nm=function(c){this.treeSet_=c,this.position_=0};nm.prototype.next=function(){if(this.position_===this.treeSet_.size())throw new Uc;return this.treeSet_.array_[this.position_++]};nm.prototype.hasNext=function(){return this.position_<this.treeSet_.size()};nm.prototype.remove=function(){throw new vp};var _l=function(){};_l.sort=function(){var o=arguments[0],u,h,d,g;if(arguments.length===1)g=function(I,S){return I.compareTo(S)},o.sort(g);else if(arguments.length===2)d=arguments[1],g=function(I,S){return d.compare(I,S)},o.sort(g);else if(arguments.length===3){h=o.slice(arguments[1],arguments[2]),h.sort();var x=o.slice(0,arguments[1]).concat(h,o.slice(arguments[2],o.length));for(o.splice(0,o.length),u=0;u<x.length;u++)o.push(x[u])}else if(arguments.length===4)for(h=o.slice(arguments[1],arguments[2]),d=arguments[3],g=function(I,S){return d.compare(I,S)},h.sort(g),x=o.slice(0,arguments[1]).concat(h,o.slice(arguments[2],o.length)),o.splice(0,o.length),u=0;u<x.length;u++)o.push(x[u])};_l.asList=function(o){for(var u=new jt,h=0,d=o.length;h<d;h++)u.add(o[h]);return u};var hr=function(){},Po={P:{configurable:!0},L:{configurable:!0},A:{configurable:!0},FALSE:{configurable:!0},TRUE:{configurable:!0},DONTCARE:{configurable:!0},SYM_FALSE:{configurable:!0},SYM_TRUE:{configurable:!0},SYM_DONTCARE:{configurable:!0},SYM_P:{configurable:!0},SYM_L:{configurable:!0},SYM_A:{configurable:!0}};Po.P.get=function(){return 0};Po.L.get=function(){return 1};Po.A.get=function(){return 2};Po.FALSE.get=function(){return-1};Po.TRUE.get=function(){return-2};Po.DONTCARE.get=function(){return-3};Po.SYM_FALSE.get=function(){return"F"};Po.SYM_TRUE.get=function(){return"T"};Po.SYM_DONTCARE.get=function(){return"*"};Po.SYM_P.get=function(){return"0"};Po.SYM_L.get=function(){return"1"};Po.SYM_A.get=function(){return"2"};hr.prototype.interfaces_=function(){return[]};hr.prototype.getClass=function(){return hr};hr.toDimensionSymbol=function(o){switch(o){case hr.FALSE:return hr.SYM_FALSE;case hr.TRUE:return hr.SYM_TRUE;case hr.DONTCARE:return hr.SYM_DONTCARE;case hr.P:return hr.SYM_P;case hr.L:return hr.SYM_L;case hr.A:return hr.SYM_A}throw new Xr("Unknown dimension value: "+o)};hr.toDimensionValue=function(o){switch(Qh.toUpperCase(o)){case hr.SYM_FALSE:return hr.FALSE;case hr.SYM_TRUE:return hr.TRUE;case hr.SYM_DONTCARE:return hr.DONTCARE;case hr.SYM_P:return hr.P;case hr.SYM_L:return hr.L;case hr.SYM_A:return hr.A}throw new Xr("Unknown dimension symbol: "+o)};Object.defineProperties(hr,Po);var $o=function(){};$o.prototype.filter=function(o){};$o.prototype.interfaces_=function(){return[]};$o.prototype.getClass=function(){return $o};var Eo=function(){};Eo.prototype.filter=function(o,u){};Eo.prototype.isDone=function(){};Eo.prototype.isGeometryChanged=function(){};Eo.prototype.interfaces_=function(){return[]};Eo.prototype.getClass=function(){return Eo};var fi=function(c){function o(h,d){if(c.call(this,d),this._geometries=h||[],c.hasNullElements(this._geometries))throw new Xr("geometries must not contain null elements")}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={serialVersionUID:{configurable:!0}};return o.prototype.computeEnvelopeInternal=function(){for(var d=this,g=new le,x=0;x<this._geometries.length;x++)g.expandToInclude(d._geometries[x].getEnvelopeInternal());return g},o.prototype.getGeometryN=function(d){return this._geometries[d]},o.prototype.getSortIndex=function(){return c.SORTINDEX_GEOMETRYCOLLECTION},o.prototype.getCoordinates=function(){for(var d=this,g=new Array(this.getNumPoints()).fill(null),x=-1,I=0;I<this._geometries.length;I++)for(var S=d._geometries[I].getCoordinates(),D=0;D<S.length;D++)x++,g[x]=S[D];return g},o.prototype.getArea=function(){for(var d=this,g=0,x=0;x<this._geometries.length;x++)g+=d._geometries[x].getArea();return g},o.prototype.equalsExact=function(){var d=this;if(arguments.length===2){var g=arguments[0],x=arguments[1];if(!this.isEquivalentClass(g))return!1;var I=g;if(this._geometries.length!==I._geometries.length)return!1;for(var S=0;S<this._geometries.length;S++)if(!d._geometries[S].equalsExact(I._geometries[S],x))return!1;return!0}else return c.prototype.equalsExact.apply(this,arguments)},o.prototype.normalize=function(){for(var d=this,g=0;g<this._geometries.length;g++)d._geometries[g].normalize();_l.sort(this._geometries)},o.prototype.getCoordinate=function(){return this.isEmpty()?null:this._geometries[0].getCoordinate()},o.prototype.getBoundaryDimension=function(){for(var d=this,g=hr.FALSE,x=0;x<this._geometries.length;x++)g=Math.max(g,d._geometries[x].getBoundaryDimension());return g},o.prototype.getDimension=function(){for(var d=this,g=hr.FALSE,x=0;x<this._geometries.length;x++)g=Math.max(g,d._geometries[x].getDimension());return g},o.prototype.getLength=function(){for(var d=this,g=0,x=0;x<this._geometries.length;x++)g+=d._geometries[x].getLength();return g},o.prototype.getNumPoints=function(){for(var d=this,g=0,x=0;x<this._geometries.length;x++)g+=d._geometries[x].getNumPoints();return g},o.prototype.getNumGeometries=function(){return this._geometries.length},o.prototype.reverse=function(){for(var d=this,g=this._geometries.length,x=new Array(g).fill(null),I=0;I<this._geometries.length;I++)x[I]=d._geometries[I].reverse();return this.getFactory().createGeometryCollection(x)},o.prototype.compareToSameClass=function(){var d=this;if(arguments.length===1){var g=arguments[0],x=new Yo(_l.asList(this._geometries)),I=new Yo(_l.asList(g._geometries));return this.compare(x,I)}else if(arguments.length===2){for(var S=arguments[0],D=arguments[1],O=S,B=this.getNumGeometries(),W=O.getNumGeometries(),et=0;et<B&&et<W;){var it=d.getGeometryN(et),bt=O.getGeometryN(et),ft=it.compareToSameClass(bt,D);if(ft!==0)return ft;et++}return et<B?1:et<W?-1:0}},o.prototype.apply=function(){var d=this;if(Ee(arguments[0],xs))for(var g=arguments[0],x=0;x<this._geometries.length;x++)d._geometries[x].apply(g);else if(Ee(arguments[0],Eo)){var I=arguments[0];if(this._geometries.length===0)return null;for(var S=0;S<this._geometries.length&&(d._geometries[S].apply(I),!I.isDone());S++);I.isGeometryChanged()&&this.geometryChanged()}else if(Ee(arguments[0],$o)){var D=arguments[0];D.filter(this);for(var O=0;O<this._geometries.length;O++)d._geometries[O].apply(D)}else if(Ee(arguments[0],Ys)){var B=arguments[0];B.filter(this);for(var W=0;W<this._geometries.length;W++)d._geometries[W].apply(B)}},o.prototype.getBoundary=function(){return this.checkNotGeometryCollection(this),Ze.shouldNeverReachHere(),null},o.prototype.clone=function(){var d=this,g=c.prototype.clone.call(this);g._geometries=new Array(this._geometries.length).fill(null);for(var x=0;x<this._geometries.length;x++)g._geometries[x]=d._geometries[x].clone();return g},o.prototype.getGeometryType=function(){return"GeometryCollection"},o.prototype.copy=function(){for(var d=this,g=new Array(this._geometries.length).fill(null),x=0;x<g.length;x++)g[x]=d._geometries[x].copy();return new o(g,this._factory)},o.prototype.isEmpty=function(){for(var d=this,g=0;g<this._geometries.length;g++)if(!d._geometries[g].isEmpty())return!1;return!0},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},u.serialVersionUID.get=function(){return-5694727726395021e3},Object.defineProperties(o,u),o}(be),vl=function(c){function o(){c.apply(this,arguments)}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={serialVersionUID:{configurable:!0}};return o.prototype.getSortIndex=function(){return be.SORTINDEX_MULTILINESTRING},o.prototype.equalsExact=function(){if(arguments.length===2){var d=arguments[0],g=arguments[1];return this.isEquivalentClass(d)?c.prototype.equalsExact.call(this,d,g):!1}else return c.prototype.equalsExact.apply(this,arguments)},o.prototype.getBoundaryDimension=function(){return this.isClosed()?hr.FALSE:0},o.prototype.isClosed=function(){var d=this;if(this.isEmpty())return!1;for(var g=0;g<this._geometries.length;g++)if(!d._geometries[g].isClosed())return!1;return!0},o.prototype.getDimension=function(){return 1},o.prototype.reverse=function(){for(var d=this,g=this._geometries.length,x=new Array(g).fill(null),I=0;I<this._geometries.length;I++)x[g-1-I]=d._geometries[I].reverse();return this.getFactory().createMultiLineString(x)},o.prototype.getBoundary=function(){return new no(this).getBoundary()},o.prototype.getGeometryType=function(){return"MultiLineString"},o.prototype.copy=function(){for(var d=this,g=new Array(this._geometries.length).fill(null),x=0;x<g.length;x++)g[x]=d._geometries[x].copy();return new o(g,this._factory)},o.prototype.interfaces_=function(){return[ep]},o.prototype.getClass=function(){return o},u.serialVersionUID.get=function(){return 8166665132445434e3},Object.defineProperties(o,u),o}(fi),no=function(){if(this._geom=null,this._geomFact=null,this._bnRule=null,this._endpointMap=null,arguments.length===1){var o=arguments[0],u=so.MOD2_BOUNDARY_RULE;this._geom=o,this._geomFact=o.getFactory(),this._bnRule=u}else if(arguments.length===2){var h=arguments[0],d=arguments[1];this._geom=h,this._geomFact=h.getFactory(),this._bnRule=d}};no.prototype.boundaryMultiLineString=function(o){if(this._geom.isEmpty())return this.getEmptyMultiPoint();var u=this.computeBoundaryCoordinates(o);return u.length===1?this._geomFact.createPoint(u[0]):this._geomFact.createMultiPointFromCoords(u)};no.prototype.getBoundary=function(){return this._geom instanceof nn?this.boundaryLineString(this._geom):this._geom instanceof vl?this.boundaryMultiLineString(this._geom):this._geom.getBoundary()};no.prototype.boundaryLineString=function(o){if(this._geom.isEmpty())return this.getEmptyMultiPoint();if(o.isClosed()){var u=this._bnRule.isInBoundary(2);return u?o.getStartPoint():this._geomFact.createMultiPoint()}return this._geomFact.createMultiPoint([o.getStartPoint(),o.getEndPoint()])};no.prototype.getEmptyMultiPoint=function(){return this._geomFact.createMultiPoint()};no.prototype.computeBoundaryCoordinates=function(o){var u=this,h=new jt;this._endpointMap=new ii;for(var d=0;d<o.getNumGeometries();d++){var g=o.getGeometryN(d);g.getNumPoints()!==0&&(u.addEndpoint(g.getCoordinateN(0)),u.addEndpoint(g.getCoordinateN(g.getNumPoints()-1)))}for(var x=this._endpointMap.entrySet().iterator();x.hasNext();){var I=x.next(),S=I.getValue(),D=S.count;u._bnRule.isInBoundary(D)&&h.add(I.getKey())}return Ye.toCoordinateArray(h)};no.prototype.addEndpoint=function(o){var u=this._endpointMap.get(o);u===null&&(u=new Gd,this._endpointMap.put(o,u)),u.count++};no.prototype.interfaces_=function(){return[]};no.prototype.getClass=function(){return no};no.getBoundary=function(){if(arguments.length===1){var o=arguments[0],u=new no(o);return u.getBoundary()}else if(arguments.length===2){var h=arguments[0],d=arguments[1],g=new no(h,d);return g.getBoundary()}};var Gd=function(){this.count=null};Gd.prototype.interfaces_=function(){return[]};Gd.prototype.getClass=function(){return Gd};function lO(){}function uO(){}var cO=function(){};function hO(){}function pO(){}function fO(){}var io=function(){},fv={NEWLINE:{configurable:!0},SIMPLE_ORDINATE_FORMAT:{configurable:!0}};io.prototype.interfaces_=function(){return[]};io.prototype.getClass=function(){return io};io.chars=function(o,u){for(var h=new Array(u).fill(null),d=0;d<u;d++)h[d]=o;return String(h)};io.getStackTrace=function(){if(arguments.length===1){var o=arguments[0],u=new hO,h=new lO;return o.printStackTrace(h),u.toString()}else if(arguments.length===2){var d=arguments[0],g=arguments[1],x="";new uO(io.getStackTrace(d));for(var I=new fO,S=0;S<g;S++)try{x+=I.readLine()+io.NEWLINE}catch(D){if(D instanceof pO)Ze.shouldNeverReachHere();else throw D}finally{}return x}};io.split=function(o,u){for(var h=u.length,d=new jt,g=""+o,x=g.indexOf(u);x>=0;){var I=g.substring(0,x);d.add(I),g=g.substring(x+h),x=g.indexOf(u)}g.length>0&&d.add(g);for(var S=new Array(d.size()).fill(null),D=0;D<S.length;D++)S[D]=d.get(D);return S};io.toString=function(){if(arguments.length===1){var o=arguments[0];return io.SIMPLE_ORDINATE_FORMAT.format(o)}};io.spaces=function(o){return io.chars(" ",o)};fv.NEWLINE.get=function(){return $n.getProperty("line.separator")};fv.SIMPLE_ORDINATE_FORMAT.get=function(){return new cO};Object.defineProperties(io,fv);var un=function(){};un.prototype.interfaces_=function(){return[]};un.prototype.getClass=function(){return un};un.copyCoord=function(o,u,h,d){for(var g=Math.min(o.getDimension(),h.getDimension()),x=0;x<g;x++)h.setOrdinate(d,x,o.getOrdinate(u,x))};un.isRing=function(o){var u=o.size();return u===0?!0:u<=3?!1:o.getOrdinate(0,nr.X)===o.getOrdinate(u-1,nr.X)&&o.getOrdinate(0,nr.Y)===o.getOrdinate(u-1,nr.Y)};un.isEqual=function(o,u){var h=o.size(),d=u.size();if(h!==d)return!1;for(var g=Math.min(o.getDimension(),u.getDimension()),x=0;x<h;x++)for(var I=0;I<g;I++){var S=o.getOrdinate(x,I),D=u.getOrdinate(x,I);if(o.getOrdinate(x,I)!==u.getOrdinate(x,I)&&!(ke.isNaN(S)&&ke.isNaN(D)))return!1}return!0};un.extend=function(o,u,h){var d=o.create(h,u.getDimension()),g=u.size();if(un.copy(u,0,d,0,g),g>0)for(var x=g;x<h;x++)un.copy(u,g-1,d,x,1);return d};un.reverse=function(o){for(var u=o.size()-1,h=Math.trunc(u/2),d=0;d<=h;d++)un.swap(o,d,u-d)};un.swap=function(o,u,h){if(u===h)return null;for(var d=0;d<o.getDimension();d++){var g=o.getOrdinate(u,d);o.setOrdinate(u,d,o.getOrdinate(h,d)),o.setOrdinate(h,d,g)}};un.copy=function(o,u,h,d,g){for(var x=0;x<g;x++)un.copyCoord(o,u+x,h,d+x)};un.toString=function(){if(arguments.length===1){var o=arguments[0],u=o.size();if(u===0)return"()";var h=o.getDimension(),d=new is;d.append("(");for(var g=0;g<u;g++){g>0&&d.append(" ");for(var x=0;x<h;x++)x>0&&d.append(","),d.append(io.toString(o.getOrdinate(g,x)))}return d.append(")"),d.toString()}};un.ensureValidRing=function(o,u){var h=u.size();if(h===0)return u;if(h<=3)return un.createClosedRing(o,u,4);var d=u.getOrdinate(0,nr.X)===u.getOrdinate(h-1,nr.X)&&u.getOrdinate(0,nr.Y)===u.getOrdinate(h-1,nr.Y);return d?u:un.createClosedRing(o,u,h+1)};un.createClosedRing=function(o,u,h){var d=o.create(h,u.getDimension()),g=u.size();un.copy(u,0,d,0,g);for(var x=g;x<h;x++)un.copy(u,0,d,x,1);return d};var nn=function(c){function o(h,d){c.call(this,d),this._points=null,this.init(h)}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={serialVersionUID:{configurable:!0}};return o.prototype.computeEnvelopeInternal=function(){return this.isEmpty()?new le:this._points.expandEnvelope(new le)},o.prototype.isRing=function(){return this.isClosed()&&this.isSimple()},o.prototype.getSortIndex=function(){return c.SORTINDEX_LINESTRING},o.prototype.getCoordinates=function(){return this._points.toCoordinateArray()},o.prototype.equalsExact=function(){var d=this;if(arguments.length===2){var g=arguments[0],x=arguments[1];if(!this.isEquivalentClass(g))return!1;var I=g;if(this._points.size()!==I._points.size())return!1;for(var S=0;S<this._points.size();S++)if(!d.equal(d._points.getCoordinate(S),I._points.getCoordinate(S),x))return!1;return!0}else return c.prototype.equalsExact.apply(this,arguments)},o.prototype.normalize=function(){for(var d=this,g=0;g<Math.trunc(this._points.size()/2);g++){var x=d._points.size()-1-g;if(!d._points.getCoordinate(g).equals(d._points.getCoordinate(x)))return d._points.getCoordinate(g).compareTo(d._points.getCoordinate(x))>0&&un.reverse(d._points),null}},o.prototype.getCoordinate=function(){return this.isEmpty()?null:this._points.getCoordinate(0)},o.prototype.getBoundaryDimension=function(){return this.isClosed()?hr.FALSE:0},o.prototype.isClosed=function(){return this.isEmpty()?!1:this.getCoordinateN(0).equals2D(this.getCoordinateN(this.getNumPoints()-1))},o.prototype.getEndPoint=function(){return this.isEmpty()?null:this.getPointN(this.getNumPoints()-1)},o.prototype.getDimension=function(){return 1},o.prototype.getLength=function(){return Kt.computeLength(this._points)},o.prototype.getNumPoints=function(){return this._points.size()},o.prototype.reverse=function(){var d=this._points.copy();un.reverse(d);var g=this.getFactory().createLineString(d);return g},o.prototype.compareToSameClass=function(){var d=this;if(arguments.length===1){for(var g=arguments[0],x=g,I=0,S=0;I<this._points.size()&&S<x._points.size();){var D=d._points.getCoordinate(I).compareTo(x._points.getCoordinate(S));if(D!==0)return D;I++,S++}return I<this._points.size()?1:S<x._points.size()?-1:0}else if(arguments.length===2){var O=arguments[0],B=arguments[1],W=O;return B.compare(this._points,W._points)}},o.prototype.apply=function(){var d=this;if(Ee(arguments[0],xs))for(var g=arguments[0],x=0;x<this._points.size();x++)g.filter(d._points.getCoordinate(x));else if(Ee(arguments[0],Eo)){var I=arguments[0];if(this._points.size()===0)return null;for(var S=0;S<this._points.size()&&(I.filter(d._points,S),!I.isDone());S++);I.isGeometryChanged()&&this.geometryChanged()}else if(Ee(arguments[0],$o)){var D=arguments[0];D.filter(this)}else if(Ee(arguments[0],Ys)){var O=arguments[0];O.filter(this)}},o.prototype.getBoundary=function(){return new no(this).getBoundary()},o.prototype.isEquivalentClass=function(d){return d instanceof o},o.prototype.clone=function(){var d=c.prototype.clone.call(this);return d._points=this._points.clone(),d},o.prototype.getCoordinateN=function(d){return this._points.getCoordinate(d)},o.prototype.getGeometryType=function(){return"LineString"},o.prototype.copy=function(){return new o(this._points.copy(),this._factory)},o.prototype.getCoordinateSequence=function(){return this._points},o.prototype.isEmpty=function(){return this._points.size()===0},o.prototype.init=function(d){if(d===null&&(d=this.getFactory().getCoordinateSequenceFactory().create([])),d.size()===1)throw new Xr("Invalid number of points in LineString (found "+d.size()+" - must be 0 or >= 2)");this._points=d},o.prototype.isCoordinate=function(d){for(var g=this,x=0;x<this._points.size();x++)if(g._points.getCoordinate(x).equals(d))return!0;return!1},o.prototype.getStartPoint=function(){return this.isEmpty()?null:this.getPointN(0)},o.prototype.getPointN=function(d){return this.getFactory().createPoint(this._points.getCoordinate(d))},o.prototype.interfaces_=function(){return[ep]},o.prototype.getClass=function(){return o},u.serialVersionUID.get=function(){return 0x2b2b51ba435c8e00},Object.defineProperties(o,u),o}(be),rp=function(){};rp.prototype.interfaces_=function(){return[]};rp.prototype.getClass=function(){return rp};var Ci=function(c){function o(h,d){c.call(this,d),this._coordinates=h||null,this.init(this._coordinates)}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={serialVersionUID:{configurable:!0}};return o.prototype.computeEnvelopeInternal=function(){if(this.isEmpty())return new le;var d=new le;return d.expandToInclude(this._coordinates.getX(0),this._coordinates.getY(0)),d},o.prototype.getSortIndex=function(){return c.SORTINDEX_POINT},o.prototype.getCoordinates=function(){return this.isEmpty()?[]:[this.getCoordinate()]},o.prototype.equalsExact=function(){if(arguments.length===2){var d=arguments[0],g=arguments[1];return this.isEquivalentClass(d)?this.isEmpty()&&d.isEmpty()?!0:this.isEmpty()!==d.isEmpty()?!1:this.equal(d.getCoordinate(),this.getCoordinate(),g):!1}else return c.prototype.equalsExact.apply(this,arguments)},o.prototype.normalize=function(){},o.prototype.getCoordinate=function(){return this._coordinates.size()!==0?this._coordinates.getCoordinate(0):null},o.prototype.getBoundaryDimension=function(){return hr.FALSE},o.prototype.getDimension=function(){return 0},o.prototype.getNumPoints=function(){return this.isEmpty()?0:1},o.prototype.reverse=function(){return this.copy()},o.prototype.getX=function(){if(this.getCoordinate()===null)throw new Error("getX called on empty Point");return this.getCoordinate().x},o.prototype.compareToSameClass=function(){if(arguments.length===1){var d=arguments[0],g=d;return this.getCoordinate().compareTo(g.getCoordinate())}else if(arguments.length===2){var x=arguments[0],I=arguments[1],S=x;return I.compare(this._coordinates,S._coordinates)}},o.prototype.apply=function(){if(Ee(arguments[0],xs)){var d=arguments[0];if(this.isEmpty())return null;d.filter(this.getCoordinate())}else if(Ee(arguments[0],Eo)){var g=arguments[0];if(this.isEmpty())return null;g.filter(this._coordinates,0),g.isGeometryChanged()&&this.geometryChanged()}else if(Ee(arguments[0],$o)){var x=arguments[0];x.filter(this)}else if(Ee(arguments[0],Ys)){var I=arguments[0];I.filter(this)}},o.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},o.prototype.clone=function(){var d=c.prototype.clone.call(this);return d._coordinates=this._coordinates.clone(),d},o.prototype.getGeometryType=function(){return"Point"},o.prototype.copy=function(){return new o(this._coordinates.copy(),this._factory)},o.prototype.getCoordinateSequence=function(){return this._coordinates},o.prototype.getY=function(){if(this.getCoordinate()===null)throw new Error("getY called on empty Point");return this.getCoordinate().y},o.prototype.isEmpty=function(){return this._coordinates.size()===0},o.prototype.init=function(d){d===null&&(d=this.getFactory().getCoordinateSequenceFactory().create([])),Ze.isTrue(d.size()<=1),this._coordinates=d},o.prototype.isSimple=function(){return!0},o.prototype.interfaces_=function(){return[rp]},o.prototype.getClass=function(){return o},u.serialVersionUID.get=function(){return 4902022702746615e3},Object.defineProperties(o,u),o}(be),Ia=function(){};Ia.prototype.interfaces_=function(){return[]};Ia.prototype.getClass=function(){return Ia};var Cn=function(c){function o(h,d,g){if(c.call(this,g),this._shell=null,this._holes=null,h===null&&(h=this.getFactory().createLinearRing()),d===null&&(d=[]),c.hasNullElements(d))throw new Xr("holes must not contain null elements");if(h.isEmpty()&&c.hasNonEmptyElements(d))throw new Xr("shell is empty but holes are not");this._shell=h,this._holes=d}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={serialVersionUID:{configurable:!0}};return o.prototype.computeEnvelopeInternal=function(){return this._shell.getEnvelopeInternal()},o.prototype.getSortIndex=function(){return c.SORTINDEX_POLYGON},o.prototype.getCoordinates=function(){var d=this;if(this.isEmpty())return[];for(var g=new Array(this.getNumPoints()).fill(null),x=-1,I=this._shell.getCoordinates(),S=0;S<I.length;S++)x++,g[x]=I[S];for(var D=0;D<this._holes.length;D++)for(var O=d._holes[D].getCoordinates(),B=0;B<O.length;B++)x++,g[x]=O[B];return g},o.prototype.getArea=function(){var d=this,g=0;g+=Math.abs(Kt.signedArea(this._shell.getCoordinateSequence()));for(var x=0;x<this._holes.length;x++)g-=Math.abs(Kt.signedArea(d._holes[x].getCoordinateSequence()));return g},o.prototype.isRectangle=function(){if(this.getNumInteriorRing()!==0||this._shell===null||this._shell.getNumPoints()!==5)return!1;for(var d=this._shell.getCoordinateSequence(),g=this.getEnvelopeInternal(),x=0;x<5;x++){var I=d.getX(x);if(!(I===g.getMinX()||I===g.getMaxX()))return!1;var S=d.getY(x);if(!(S===g.getMinY()||S===g.getMaxY()))return!1}for(var D=d.getX(0),O=d.getY(0),B=1;B<=4;B++){var W=d.getX(B),et=d.getY(B),it=W!==D,bt=et!==O;if(it===bt)return!1;D=W,O=et}return!0},o.prototype.equalsExact=function(){var d=this;if(arguments.length===2){var g=arguments[0],x=arguments[1];if(!this.isEquivalentClass(g))return!1;var I=g,S=this._shell,D=I._shell;if(!S.equalsExact(D,x)||this._holes.length!==I._holes.length)return!1;for(var O=0;O<this._holes.length;O++)if(!d._holes[O].equalsExact(I._holes[O],x))return!1;return!0}else return c.prototype.equalsExact.apply(this,arguments)},o.prototype.normalize=function(){var d=this;if(arguments.length===0){this.normalize(this._shell,!0);for(var g=0;g<this._holes.length;g++)d.normalize(d._holes[g],!1);_l.sort(this._holes)}else if(arguments.length===2){var x=arguments[0],I=arguments[1];if(x.isEmpty())return null;var S=new Array(x.getCoordinates().length-1).fill(null);$n.arraycopy(x.getCoordinates(),0,S,0,S.length);var D=Ye.minCoordinate(x.getCoordinates());Ye.scroll(S,D),$n.arraycopy(S,0,x.getCoordinates(),0,S.length),x.getCoordinates()[S.length]=S[0],Kt.isCCW(x.getCoordinates())===I&&Ye.reverse(x.getCoordinates())}},o.prototype.getCoordinate=function(){return this._shell.getCoordinate()},o.prototype.getNumInteriorRing=function(){return this._holes.length},o.prototype.getBoundaryDimension=function(){return 1},o.prototype.getDimension=function(){return 2},o.prototype.getLength=function(){var d=this,g=0;g+=this._shell.getLength();for(var x=0;x<this._holes.length;x++)g+=d._holes[x].getLength();return g},o.prototype.getNumPoints=function(){for(var d=this,g=this._shell.getNumPoints(),x=0;x<this._holes.length;x++)g+=d._holes[x].getNumPoints();return g},o.prototype.reverse=function(){var d=this,g=this.copy();g._shell=this._shell.copy().reverse(),g._holes=new Array(this._holes.length).fill(null);for(var x=0;x<this._holes.length;x++)g._holes[x]=d._holes[x].copy().reverse();return g},o.prototype.convexHull=function(){return this.getExteriorRing().convexHull()},o.prototype.compareToSameClass=function(){var d=this;if(arguments.length===1){var g=arguments[0],x=this._shell,I=g._shell;return x.compareToSameClass(I)}else if(arguments.length===2){var S=arguments[0],D=arguments[1],O=S,B=this._shell,W=O._shell,et=B.compareToSameClass(W,D);if(et!==0)return et;for(var it=this.getNumInteriorRing(),bt=O.getNumInteriorRing(),ft=0;ft<it&&ft<bt;){var Pt=d.getInteriorRingN(ft),kt=O.getInteriorRingN(ft),Nt=Pt.compareToSameClass(kt,D);if(Nt!==0)return Nt;ft++}return ft<it?1:ft<bt?-1:0}},o.prototype.apply=function(d){var g=this;if(Ee(d,xs)){this._shell.apply(d);for(var x=0;x<this._holes.length;x++)g._holes[x].apply(d)}else if(Ee(d,Eo)){if(this._shell.apply(d),!d.isDone())for(var I=0;I<this._holes.length&&(g._holes[I].apply(d),!d.isDone());I++);d.isGeometryChanged()&&this.geometryChanged()}else if(Ee(d,$o))d.filter(this);else if(Ee(d,Ys)){d.filter(this),this._shell.apply(d);for(var S=0;S<this._holes.length;S++)g._holes[S].apply(d)}},o.prototype.getBoundary=function(){var d=this;if(this.isEmpty())return this.getFactory().createMultiLineString();var g=new Array(this._holes.length+1).fill(null);g[0]=this._shell;for(var x=0;x<this._holes.length;x++)g[x+1]=d._holes[x];return g.length<=1?this.getFactory().createLinearRing(g[0].getCoordinateSequence()):this.getFactory().createMultiLineString(g)},o.prototype.clone=function(){var d=this,g=c.prototype.clone.call(this);g._shell=this._shell.clone(),g._holes=new Array(this._holes.length).fill(null);for(var x=0;x<this._holes.length;x++)g._holes[x]=d._holes[x].clone();return g},o.prototype.getGeometryType=function(){return"Polygon"},o.prototype.copy=function(){for(var d=this,g=this._shell.copy(),x=new Array(this._holes.length).fill(null),I=0;I<x.length;I++)x[I]=d._holes[I].copy();return new o(g,x,this._factory)},o.prototype.getExteriorRing=function(){return this._shell},o.prototype.isEmpty=function(){return this._shell.isEmpty()},o.prototype.getInteriorRingN=function(d){return this._holes[d]},o.prototype.interfaces_=function(){return[Ia]},o.prototype.getClass=function(){return o},u.serialVersionUID.get=function(){return-0x307ffefd8dc97200},Object.defineProperties(o,u),o}(be),Ic=function(c){function o(){c.apply(this,arguments)}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={serialVersionUID:{configurable:!0}};return o.prototype.getSortIndex=function(){return be.SORTINDEX_MULTIPOINT},o.prototype.isValid=function(){return!0},o.prototype.equalsExact=function(){if(arguments.length===2){var d=arguments[0],g=arguments[1];return this.isEquivalentClass(d)?c.prototype.equalsExact.call(this,d,g):!1}else return c.prototype.equalsExact.apply(this,arguments)},o.prototype.getCoordinate=function(){if(arguments.length===1){var d=arguments[0];return this._geometries[d].getCoordinate()}else return c.prototype.getCoordinate.apply(this,arguments)},o.prototype.getBoundaryDimension=function(){return hr.FALSE},o.prototype.getDimension=function(){return 0},o.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},o.prototype.getGeometryType=function(){return"MultiPoint"},o.prototype.copy=function(){for(var d=this,g=new Array(this._geometries.length).fill(null),x=0;x<g.length;x++)g[x]=d._geometries[x].copy();return new o(g,this._factory)},o.prototype.interfaces_=function(){return[rp]},o.prototype.getClass=function(){return o},u.serialVersionUID.get=function(){return-8048474874175356e3},Object.defineProperties(o,u),o}(fi),bs=function(c){function o(h,d){h instanceof st&&d instanceof He&&(h=d.getCoordinateSequenceFactory().create(h)),c.call(this,h,d),this.validateConstruction()}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={MINIMUM_VALID_SIZE:{configurable:!0},serialVersionUID:{configurable:!0}};return o.prototype.getSortIndex=function(){return be.SORTINDEX_LINEARRING},o.prototype.getBoundaryDimension=function(){return hr.FALSE},o.prototype.isClosed=function(){return this.isEmpty()?!0:c.prototype.isClosed.call(this)},o.prototype.reverse=function(){var d=this._points.copy();un.reverse(d);var g=this.getFactory().createLinearRing(d);return g},o.prototype.validateConstruction=function(){if(!this.isEmpty()&&!c.prototype.isClosed.call(this))throw new Xr("Points of LinearRing do not form a closed linestring");if(this.getCoordinateSequence().size()>=1&&this.getCoordinateSequence().size()<o.MINIMUM_VALID_SIZE)throw new Xr("Invalid number of points in LinearRing (found "+this.getCoordinateSequence().size()+" - must be 0 or >= 4)")},o.prototype.getGeometryType=function(){return"LinearRing"},o.prototype.copy=function(){return new o(this._points.copy(),this._factory)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},u.MINIMUM_VALID_SIZE.get=function(){return 4},u.serialVersionUID.get=function(){return-0x3b229e262367a600},Object.defineProperties(o,u),o}(nn),ys=function(c){function o(){c.apply(this,arguments)}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={serialVersionUID:{configurable:!0}};return o.prototype.getSortIndex=function(){return be.SORTINDEX_MULTIPOLYGON},o.prototype.equalsExact=function(){if(arguments.length===2){var d=arguments[0],g=arguments[1];return this.isEquivalentClass(d)?c.prototype.equalsExact.call(this,d,g):!1}else return c.prototype.equalsExact.apply(this,arguments)},o.prototype.getBoundaryDimension=function(){return 1},o.prototype.getDimension=function(){return 2},o.prototype.reverse=function(){for(var d=this,g=this._geometries.length,x=new Array(g).fill(null),I=0;I<this._geometries.length;I++)x[I]=d._geometries[I].reverse();return this.getFactory().createMultiPolygon(x)},o.prototype.getBoundary=function(){var d=this;if(this.isEmpty())return this.getFactory().createMultiLineString();for(var g=new jt,x=0;x<this._geometries.length;x++)for(var I=d._geometries[x],S=I.getBoundary(),D=0;D<S.getNumGeometries();D++)g.add(S.getGeometryN(D));var O=new Array(g.size()).fill(null);return this.getFactory().createMultiLineString(g.toArray(O))},o.prototype.getGeometryType=function(){return"MultiPolygon"},o.prototype.copy=function(){for(var d=this,g=new Array(this._geometries.length).fill(null),x=0;x<g.length;x++)g[x]=d._geometries[x].copy();return new o(g,this._factory)},o.prototype.interfaces_=function(){return[Ia]},o.prototype.getClass=function(){return o},u.serialVersionUID.get=function(){return-0x7a5aa1369171980},Object.defineProperties(o,u),o}(fi),ao=function(o){this._factory=o||null,this._isUserDataCopied=!1},im={NoOpGeometryOperation:{configurable:!0},CoordinateOperation:{configurable:!0},CoordinateSequenceOperation:{configurable:!0}};ao.prototype.setCopyUserData=function(o){this._isUserDataCopied=o};ao.prototype.edit=function(o,u){if(o===null)return null;var h=this.editInternal(o,u);return this._isUserDataCopied&&h.setUserData(o.getUserData()),h};ao.prototype.editInternal=function(o,u){return this._factory===null&&(this._factory=o.getFactory()),o instanceof fi?this.editGeometryCollection(o,u):o instanceof Cn?this.editPolygon(o,u):o instanceof Ci?u.edit(o,this._factory):o instanceof nn?u.edit(o,this._factory):(Ze.shouldNeverReachHere("Unsupported Geometry class: "+o.getClass().getName()),null)};ao.prototype.editGeometryCollection=function(o,u){for(var h=this,d=u.edit(o,this._factory),g=new jt,x=0;x<d.getNumGeometries();x++){var I=h.edit(d.getGeometryN(x),u);I===null||I.isEmpty()||g.add(I)}return d.getClass()===Ic?this._factory.createMultiPoint(g.toArray([])):d.getClass()===vl?this._factory.createMultiLineString(g.toArray([])):d.getClass()===ys?this._factory.createMultiPolygon(g.toArray([])):this._factory.createGeometryCollection(g.toArray([]))};ao.prototype.editPolygon=function(o,u){var h=this,d=u.edit(o,this._factory);if(d===null&&(d=this._factory.createPolygon(null)),d.isEmpty())return d;var g=this.edit(d.getExteriorRing(),u);if(g===null||g.isEmpty())return this._factory.createPolygon();for(var x=new jt,I=0;I<d.getNumInteriorRing();I++){var S=h.edit(d.getInteriorRingN(I),u);S===null||S.isEmpty()||x.add(S)}return this._factory.createPolygon(g,x.toArray([]))};ao.prototype.interfaces_=function(){return[]};ao.prototype.getClass=function(){return ao};ao.GeometryEditorOperation=function(){};im.NoOpGeometryOperation.get=function(){return np};im.CoordinateOperation.get=function(){return ip};im.CoordinateSequenceOperation.get=function(){return op};Object.defineProperties(ao,im);var np=function(){};np.prototype.edit=function(o,u){return o};np.prototype.interfaces_=function(){return[ao.GeometryEditorOperation]};np.prototype.getClass=function(){return np};var ip=function(){};ip.prototype.edit=function(o,u){var h=this.editCoordinates(o.getCoordinates(),o);return h===null?o:o instanceof bs?u.createLinearRing(h):o instanceof nn?u.createLineString(h):o instanceof Ci?h.length>0?u.createPoint(h[0]):u.createPoint():o};ip.prototype.interfaces_=function(){return[ao.GeometryEditorOperation]};ip.prototype.getClass=function(){return ip};var op=function(){};op.prototype.edit=function(o,u){return o instanceof bs?u.createLinearRing(this.edit(o.getCoordinateSequence(),o)):o instanceof nn?u.createLineString(this.edit(o.getCoordinateSequence(),o)):o instanceof Ci?u.createPoint(this.edit(o.getCoordinateSequence(),o)):o};op.prototype.interfaces_=function(){return[ao.GeometryEditorOperation]};op.prototype.getClass=function(){return op};var an=function(){var o=this;if(this._dimension=3,this._coordinates=null,arguments.length===1){if(arguments[0]instanceof Array)this._coordinates=arguments[0],this._dimension=3;else if(Number.isInteger(arguments[0])){var u=arguments[0];this._coordinates=new Array(u).fill(null);for(var h=0;h<u;h++)o._coordinates[h]=new st}else if(Ee(arguments[0],nr)){var d=arguments[0];if(d===null)return this._coordinates=new Array(0).fill(null),null;this._dimension=d.getDimension(),this._coordinates=new Array(d.size()).fill(null);for(var g=0;g<this._coordinates.length;g++)o._coordinates[g]=d.getCoordinateCopy(g)}}else if(arguments.length===2){if(arguments[0]instanceof Array&&Number.isInteger(arguments[1])){var x=arguments[0],I=arguments[1];this._coordinates=x,this._dimension=I,x===null&&(this._coordinates=new Array(0).fill(null))}else if(Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var S=arguments[0],D=arguments[1];this._coordinates=new Array(S).fill(null),this._dimension=D;for(var O=0;O<S;O++)o._coordinates[O]=new st}}},JT={serialVersionUID:{configurable:!0}};an.prototype.setOrdinate=function(o,u,h){switch(u){case nr.X:this._coordinates[o].x=h;break;case nr.Y:this._coordinates[o].y=h;break;case nr.Z:this._coordinates[o].z=h;break;default:throw new Xr("invalid ordinateIndex")}};an.prototype.size=function(){return this._coordinates.length};an.prototype.getOrdinate=function(o,u){switch(u){case nr.X:return this._coordinates[o].x;case nr.Y:return this._coordinates[o].y;case nr.Z:return this._coordinates[o].z}return ke.NaN};an.prototype.getCoordinate=function(){if(arguments.length===1){var o=arguments[0];return this._coordinates[o]}else if(arguments.length===2){var u=arguments[0],h=arguments[1];h.x=this._coordinates[u].x,h.y=this._coordinates[u].y,h.z=this._coordinates[u].z}};an.prototype.getCoordinateCopy=function(o){return new st(this._coordinates[o])};an.prototype.getDimension=function(){return this._dimension};an.prototype.getX=function(o){return this._coordinates[o].x};an.prototype.clone=function(){for(var o=this,u=new Array(this.size()).fill(null),h=0;h<this._coordinates.length;h++)u[h]=o._coordinates[h].clone();return new an(u,this._dimension)};an.prototype.expandEnvelope=function(o){for(var u=this,h=0;h<this._coordinates.length;h++)o.expandToInclude(u._coordinates[h]);return o};an.prototype.copy=function(){for(var o=this,u=new Array(this.size()).fill(null),h=0;h<this._coordinates.length;h++)u[h]=o._coordinates[h].copy();return new an(u,this._dimension)};an.prototype.toString=function(){var o=this;if(this._coordinates.length>0){var u=new is(17*this._coordinates.length);u.append("("),u.append(this._coordinates[0]);for(var h=1;h<this._coordinates.length;h++)u.append(", "),u.append(o._coordinates[h]);return u.append(")"),u.toString()}else return"()"};an.prototype.getY=function(o){return this._coordinates[o].y};an.prototype.toCoordinateArray=function(){return this._coordinates};an.prototype.interfaces_=function(){return[nr,co]};an.prototype.getClass=function(){return an};JT.serialVersionUID.get=function(){return-0xcb44a778db18e00};Object.defineProperties(an,JT);var ws=function(){},dv={serialVersionUID:{configurable:!0},instanceObject:{configurable:!0}};ws.prototype.readResolve=function(){return ws.instance()};ws.prototype.create=function(){if(arguments.length===1){if(arguments[0]instanceof Array){var o=arguments[0];return new an(o)}else if(Ee(arguments[0],nr)){var u=arguments[0];return new an(u)}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];return d>3&&(d=3),d<2?new an(h):new an(h,d)}};ws.prototype.interfaces_=function(){return[vc,co]};ws.prototype.getClass=function(){return ws};ws.instance=function(){return ws.instanceObject};dv.serialVersionUID.get=function(){return-0x38e49fa6cf6f2e00};dv.instanceObject.get=function(){return new ws};Object.defineProperties(ws,dv);var QT=function(c){function o(){c.call(this),this.map_=new Map}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.get=function(h){return this.map_.get(h)||null},o.prototype.put=function(h,d){return this.map_.set(h,d),d},o.prototype.values=function(){for(var h=new jt,d=this.map_.values(),g=d.next();!g.done;)h.add(g.value),g=d.next();return h},o.prototype.entrySet=function(){var h=new pv;return this.map_.entries().forEach(function(d){return h.add(d)}),h},o.prototype.size=function(){return this.map_.size()},o}(du),fr=function c(){if(this._modelType=null,this._scale=null,arguments.length===0)this._modelType=c.FLOATING;else if(arguments.length===1){if(arguments[0]instanceof Ko){var o=arguments[0];this._modelType=o,o===c.FIXED&&this.setScale(1)}else if(typeof arguments[0]=="number"){var u=arguments[0];this._modelType=c.FIXED,this.setScale(u)}else if(arguments[0]instanceof c){var h=arguments[0];this._modelType=h._modelType,this._scale=h._scale}}},mv={serialVersionUID:{configurable:!0},maximumPreciseValue:{configurable:!0}};fr.prototype.equals=function(o){if(!(o instanceof fr))return!1;var u=o;return this._modelType===u._modelType&&this._scale===u._scale};fr.prototype.compareTo=function(o){var u=o,h=this.getMaximumSignificantDigits(),d=u.getMaximumSignificantDigits();return new Ho(h).compareTo(new Ho(d))};fr.prototype.getScale=function(){return this._scale};fr.prototype.isFloating=function(){return this._modelType===fr.FLOATING||this._modelType===fr.FLOATING_SINGLE};fr.prototype.getType=function(){return this._modelType};fr.prototype.toString=function(){var o="UNKNOWN";return this._modelType===fr.FLOATING?o="Floating":this._modelType===fr.FLOATING_SINGLE?o="Floating-Single":this._modelType===fr.FIXED&&(o="Fixed (Scale="+this.getScale()+")"),o};fr.prototype.makePrecise=function(){if(typeof arguments[0]=="number"){var o=arguments[0];if(ke.isNaN(o))return o;if(this._modelType===fr.FLOATING_SINGLE){var u=o;return u}return this._modelType===fr.FIXED?Math.round(o*this._scale)/this._scale:o}else if(arguments[0]instanceof st){var h=arguments[0];if(this._modelType===fr.FLOATING)return null;h.x=this.makePrecise(h.x),h.y=this.makePrecise(h.y)}};fr.prototype.getMaximumSignificantDigits=function(){var o=16;return this._modelType===fr.FLOATING?o=16:this._modelType===fr.FLOATING_SINGLE?o=6:this._modelType===fr.FIXED&&(o=1+Math.trunc(Math.ceil(Math.log(this.getScale())/Math.log(10)))),o};fr.prototype.setScale=function(o){this._scale=Math.abs(o)};fr.prototype.interfaces_=function(){return[co,uo]};fr.prototype.getClass=function(){return fr};fr.mostPrecise=function(o,u){return o.compareTo(u)>=0?o:u};mv.serialVersionUID.get=function(){return 7777263578777804e3};mv.maximumPreciseValue.get=function(){return 9007199254740992};Object.defineProperties(fr,mv);var Ko=function c(o){this._name=o||null,c.nameToTypeMap.put(o,this)},gv={serialVersionUID:{configurable:!0},nameToTypeMap:{configurable:!0}};Ko.prototype.readResolve=function(){return Ko.nameToTypeMap.get(this._name)};Ko.prototype.toString=function(){return this._name};Ko.prototype.interfaces_=function(){return[co]};Ko.prototype.getClass=function(){return Ko};gv.serialVersionUID.get=function(){return-552860263173159e4};gv.nameToTypeMap.get=function(){return new QT};Object.defineProperties(Ko,gv);fr.Type=Ko;fr.FIXED=new Ko("FIXED");fr.FLOATING=new Ko("FLOATING");fr.FLOATING_SINGLE=new Ko("FLOATING SINGLE");var He=function c(){this._precisionModel=new fr,this._SRID=0,this._coordinateSequenceFactory=c.getDefaultCoordinateSequenceFactory(),arguments.length===0||(arguments.length===1?Ee(arguments[0],vc)?this._coordinateSequenceFactory=arguments[0]:arguments[0]instanceof fr&&(this._precisionModel=arguments[0]):arguments.length===2?(this._precisionModel=arguments[0],this._SRID=arguments[1]):arguments.length===3&&(this._precisionModel=arguments[0],this._SRID=arguments[1],this._coordinateSequenceFactory=arguments[2]))},tI={serialVersionUID:{configurable:!0}};He.prototype.toGeometry=function(o){return o.isNull()?this.createPoint(null):o.getMinX()===o.getMaxX()&&o.getMinY()===o.getMaxY()?this.createPoint(new st(o.getMinX(),o.getMinY())):o.getMinX()===o.getMaxX()||o.getMinY()===o.getMaxY()?this.createLineString([new st(o.getMinX(),o.getMinY()),new st(o.getMaxX(),o.getMaxY())]):this.createPolygon(this.createLinearRing([new st(o.getMinX(),o.getMinY()),new st(o.getMinX(),o.getMaxY()),new st(o.getMaxX(),o.getMaxY()),new st(o.getMaxX(),o.getMinY()),new st(o.getMinX(),o.getMinY())]),null)};He.prototype.createLineString=function(o){if(o){if(o instanceof Array)return new nn(this.getCoordinateSequenceFactory().create(o),this);if(Ee(o,nr))return new nn(o,this)}else return new nn(this.getCoordinateSequenceFactory().create([]),this)};He.prototype.createMultiLineString=function(){if(arguments.length===0)return new vl(null,this);if(arguments.length===1){var o=arguments[0];return new vl(o,this)}};He.prototype.buildGeometry=function(o){for(var u=null,h=!1,d=!1,g=o.iterator();g.hasNext();){var x=g.next(),I=x.getClass();u===null&&(u=I),I!==u&&(h=!0),x.isGeometryCollectionOrDerived()&&(d=!0)}if(u===null)return this.createGeometryCollection();if(h||d)return this.createGeometryCollection(He.toGeometryArray(o));var S=o.iterator().next(),D=o.size()>1;if(D){if(S instanceof Cn)return this.createMultiPolygon(He.toPolygonArray(o));if(S instanceof nn)return this.createMultiLineString(He.toLineStringArray(o));if(S instanceof Ci)return this.createMultiPoint(He.toPointArray(o));Ze.shouldNeverReachHere("Unhandled class: "+S.getClass().getName())}return S};He.prototype.createMultiPointFromCoords=function(o){return this.createMultiPoint(o!==null?this.getCoordinateSequenceFactory().create(o):null)};He.prototype.createPoint=function(){if(arguments.length===0)return this.createPoint(this.getCoordinateSequenceFactory().create([]));if(arguments.length===1){if(arguments[0]instanceof st){var o=arguments[0];return this.createPoint(o!==null?this.getCoordinateSequenceFactory().create([o]):null)}else if(Ee(arguments[0],nr)){var u=arguments[0];return new Ci(u,this)}}};He.prototype.getCoordinateSequenceFactory=function(){return this._coordinateSequenceFactory};He.prototype.createPolygon=function(){if(arguments.length===0)return new Cn(null,null,this);if(arguments.length===1){if(Ee(arguments[0],nr)){var o=arguments[0];return this.createPolygon(this.createLinearRing(o))}else if(arguments[0]instanceof Array){var u=arguments[0];return this.createPolygon(this.createLinearRing(u))}else if(arguments[0]instanceof bs){var h=arguments[0];return this.createPolygon(h,null)}}else if(arguments.length===2){var d=arguments[0],g=arguments[1];return new Cn(d,g,this)}};He.prototype.getSRID=function(){return this._SRID};He.prototype.createGeometryCollection=function(){if(arguments.length===0)return new fi(null,this);if(arguments.length===1){var o=arguments[0];return new fi(o,this)}};He.prototype.createGeometry=function(o){var u=new ao(this);return u.edit(o,{edit:function(){if(arguments.length===2){var h=arguments[0];return this._coordinateSequenceFactory.create(h)}}})};He.prototype.getPrecisionModel=function(){return this._precisionModel};He.prototype.createLinearRing=function(){if(arguments.length===0)return this.createLinearRing(this.getCoordinateSequenceFactory().create([]));if(arguments.length===1){if(arguments[0]instanceof Array){var o=arguments[0];return this.createLinearRing(o!==null?this.getCoordinateSequenceFactory().create(o):null)}else if(Ee(arguments[0],nr)){var u=arguments[0];return new bs(u,this)}}};He.prototype.createMultiPolygon=function(){if(arguments.length===0)return new ys(null,this);if(arguments.length===1){var o=arguments[0];return new ys(o,this)}};He.prototype.createMultiPoint=function(){var o=this;if(arguments.length===0)return new Ic(null,this);if(arguments.length===1){if(arguments[0]instanceof Array){var u=arguments[0];return new Ic(u,this)}else if(arguments[0]instanceof Array){var h=arguments[0];return this.createMultiPoint(h!==null?this.getCoordinateSequenceFactory().create(h):null)}else if(Ee(arguments[0],nr)){var d=arguments[0];if(d===null)return this.createMultiPoint(new Array(0).fill(null));for(var g=new Array(d.size()).fill(null),x=0;x<d.size();x++){var I=o.getCoordinateSequenceFactory().create(1,d.getDimension());un.copy(d,x,I,0,1),g[x]=o.createPoint(I)}return this.createMultiPoint(g)}}};He.prototype.interfaces_=function(){return[co]};He.prototype.getClass=function(){return He};He.toMultiPolygonArray=function(o){var u=new Array(o.size()).fill(null);return o.toArray(u)};He.toGeometryArray=function(o){if(o===null)return null;var u=new Array(o.size()).fill(null);return o.toArray(u)};He.getDefaultCoordinateSequenceFactory=function(){return ws.instance()};He.toMultiLineStringArray=function(o){var u=new Array(o.size()).fill(null);return o.toArray(u)};He.toLineStringArray=function(o){var u=new Array(o.size()).fill(null);return o.toArray(u)};He.toMultiPointArray=function(o){var u=new Array(o.size()).fill(null);return o.toArray(u)};He.toLinearRingArray=function(o){var u=new Array(o.size()).fill(null);return o.toArray(u)};He.toPointArray=function(o){var u=new Array(o.size()).fill(null);return o.toArray(u)};He.toPolygonArray=function(o){var u=new Array(o.size()).fill(null);return o.toArray(u)};He.createPointFromInternalCoord=function(o,u){return u.getPrecisionModel().makePrecise(o),u.getFactory().createPoint(o)};tI.serialVersionUID.get=function(){return-6820524753094096e3};Object.defineProperties(He,tI);var dO=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],om=function(o){this.geometryFactory=o||new He};om.prototype.read=function(o){var u;typeof o=="string"?u=JSON.parse(o):u=o;var h=u.type;if(!qo[h])throw new Error("Unknown GeoJSON type: "+u.type);return dO.indexOf(h)!==-1?qo[h].apply(this,[u.coordinates]):h==="GeometryCollection"?qo[h].apply(this,[u.geometries]):qo[h].apply(this,[u])};om.prototype.write=function(o){var u=o.getGeometryType();if(!qs[u])throw new Error("Geometry is not supported");return qs[u].apply(this,[o])};var qo={Feature:function(c){var o={};for(var u in c)o[u]=c[u];if(c.geometry){var h=c.geometry.type;if(!qo[h])throw new Error("Unknown GeoJSON type: "+c.type);o.geometry=this.read(c.geometry)}return c.bbox&&(o.bbox=qo.bbox.apply(this,[c.bbox])),o},FeatureCollection:function(c){var o=this,u={};if(c.features){u.features=[];for(var h=0;h<c.features.length;++h)u.features.push(o.read(c.features[h]))}return c.bbox&&(u.bbox=this.parse.bbox.apply(this,[c.bbox])),u},coordinates:function(c){for(var o=[],u=0;u<c.length;++u){var h=c[u];o.push(new st(h[0],h[1]))}return o},bbox:function(c){return this.geometryFactory.createLinearRing([new st(c[0],c[1]),new st(c[2],c[1]),new st(c[2],c[3]),new st(c[0],c[3]),new st(c[0],c[1])])},Point:function(c){var o=new st(c[0],c[1]);return this.geometryFactory.createPoint(o)},MultiPoint:function(c){for(var o=this,u=[],h=0;h<c.length;++h)u.push(qo.Point.apply(o,[c[h]]));return this.geometryFactory.createMultiPoint(u)},LineString:function(c){var o=qo.coordinates.apply(this,[c]);return this.geometryFactory.createLineString(o)},MultiLineString:function(c){for(var o=this,u=[],h=0;h<c.length;++h)u.push(qo.LineString.apply(o,[c[h]]));return this.geometryFactory.createMultiLineString(u)},Polygon:function(c){for(var o=this,u=qo.coordinates.apply(this,[c[0]]),h=this.geometryFactory.createLinearRing(u),d=[],g=1;g<c.length;++g){var x=c[g],I=qo.coordinates.apply(o,[x]),S=o.geometryFactory.createLinearRing(I);d.push(S)}return this.geometryFactory.createPolygon(h,d)},MultiPolygon:function(c){for(var o=this,u=[],h=0;h<c.length;++h){var d=c[h];u.push(qo.Polygon.apply(o,[d]))}return this.geometryFactory.createMultiPolygon(u)},GeometryCollection:function(c){for(var o=this,u=[],h=0;h<c.length;++h){var d=c[h];u.push(o.read(d))}return this.geometryFactory.createGeometryCollection(u)}},qs={coordinate:function(c){return[c.x,c.y]},Point:function(c){var o=qs.coordinate.apply(this,[c.getCoordinate()]);return{type:"Point",coordinates:o}},MultiPoint:function(c){for(var o=this,u=[],h=0;h<c._geometries.length;++h){var d=c._geometries[h],g=qs.Point.apply(o,[d]);u.push(g.coordinates)}return{type:"MultiPoint",coordinates:u}},LineString:function(c){for(var o=this,u=[],h=c.getCoordinates(),d=0;d<h.length;++d){var g=h[d];u.push(qs.coordinate.apply(o,[g]))}return{type:"LineString",coordinates:u}},MultiLineString:function(c){for(var o=this,u=[],h=0;h<c._geometries.length;++h){var d=c._geometries[h],g=qs.LineString.apply(o,[d]);u.push(g.coordinates)}return{type:"MultiLineString",coordinates:u}},Polygon:function(c){var o=this,u=[],h=qs.LineString.apply(this,[c._shell]);u.push(h.coordinates);for(var d=0;d<c._holes.length;++d){var g=c._holes[d],x=qs.LineString.apply(o,[g]);u.push(x.coordinates)}return{type:"Polygon",coordinates:u}},MultiPolygon:function(c){for(var o=this,u=[],h=0;h<c._geometries.length;++h){var d=c._geometries[h],g=qs.Polygon.apply(o,[d]);u.push(g.coordinates)}return{type:"MultiPolygon",coordinates:u}},GeometryCollection:function(c){for(var o=this,u=[],h=0;h<c._geometries.length;++h){var d=c._geometries[h],g=d.getGeometryType();u.push(qs[g].apply(o,[d]))}return{type:"GeometryCollection",geometries:u}}},_v=function(o){this.geometryFactory=o||new He,this.precisionModel=this.geometryFactory.getPrecisionModel(),this.parser=new om(this.geometryFactory)};_v.prototype.read=function(o){var u=this.parser.read(o);return this.precisionModel.getType()===fr.FIXED&&this.reducePrecision(u),u};_v.prototype.reducePrecision=function(o){var u=this,h,d;if(o.coordinate)this.precisionModel.makePrecise(o.coordinate);else if(o.points)for(h=0,d=o.points.length;h<d;h++)u.precisionModel.makePrecise(o.points[h]);else if(o.geometries)for(h=0,d=o.geometries.length;h<d;h++)u.reducePrecision(o.geometries[h])};var eI=function(){this.parser=new om(this.geometryFactory)};eI.prototype.write=function(o){return this.parser.write(o)};var zt=function(){},sm={ON:{configurable:!0},LEFT:{configurable:!0},RIGHT:{configurable:!0}};zt.prototype.interfaces_=function(){return[]};zt.prototype.getClass=function(){return zt};zt.opposite=function(o){return o===zt.LEFT?zt.RIGHT:o===zt.RIGHT?zt.LEFT:o};sm.ON.get=function(){return 0};sm.LEFT.get=function(){return 1};sm.RIGHT.get=function(){return 2};Object.defineProperties(zt,sm);function am(c){this.message=c||""}am.prototype=new Error;am.prototype.name="EmptyStackException";function os(){this.array_=[]}os.prototype=new bo;os.prototype.add=function(c){return this.array_.push(c),!0};os.prototype.get=function(c){if(c<0||c>=this.size())throw new Error;return this.array_[c]};os.prototype.push=function(c){return this.array_.push(c),c};os.prototype.pop=function(c){if(this.array_.length===0)throw new am;return this.array_.pop()};os.prototype.peek=function(){if(this.array_.length===0)throw new am;return this.array_[this.array_.length-1]};os.prototype.empty=function(){return this.array_.length===0};os.prototype.isEmpty=function(){return this.empty()};os.prototype.search=function(c){return this.array_.indexOf(c)};os.prototype.size=function(){return this.array_.length};os.prototype.toArray=function(){for(var c=this,o=[],u=0,h=this.array_.length;u<h;u++)o.push(c.array_[u]);return o};var Jo=function(){this._minIndex=-1,this._minCoord=null,this._minDe=null,this._orientedDe=null};Jo.prototype.getCoordinate=function(){return this._minCoord};Jo.prototype.getRightmostSide=function(o,u){var h=this.getRightmostSideOfSegment(o,u);return h<0&&(h=this.getRightmostSideOfSegment(o,u-1)),h<0&&(this._minCoord=null,this.checkForRightmostCoordinate(o)),h};Jo.prototype.findRightmostEdgeAtVertex=function(){var o=this._minDe.getEdge().getCoordinates();Ze.isTrue(this._minIndex>0&&this._minIndex<o.length,"rightmost point expected to be interior vertex of edge");var u=o[this._minIndex-1],h=o[this._minIndex+1],d=Kt.computeOrientation(this._minCoord,h,u),g=!1;(u.y<this._minCoord.y&&h.y<this._minCoord.y&&d===Kt.COUNTERCLOCKWISE||u.y>this._minCoord.y&&h.y>this._minCoord.y&&d===Kt.CLOCKWISE)&&(g=!0),g&&(this._minIndex=this._minIndex-1)};Jo.prototype.getRightmostSideOfSegment=function(o,u){var h=o.getEdge(),d=h.getCoordinates();if(u<0||u+1>=d.length||d[u].y===d[u+1].y)return-1;var g=zt.LEFT;return d[u].y<d[u+1].y&&(g=zt.RIGHT),g};Jo.prototype.getEdge=function(){return this._orientedDe};Jo.prototype.checkForRightmostCoordinate=function(o){for(var u=this,h=o.getEdge().getCoordinates(),d=0;d<h.length-1;d++)(u._minCoord===null||h[d].x>u._minCoord.x)&&(u._minDe=o,u._minIndex=d,u._minCoord=h[d])};Jo.prototype.findRightmostEdgeAtNode=function(){var o=this._minDe.getNode(),u=o.getEdges();this._minDe=u.getRightmostEdge(),this._minDe.isForward()||(this._minDe=this._minDe.getSym(),this._minIndex=this._minDe.getEdge().getCoordinates().length-1)};Jo.prototype.findEdge=function(o){for(var u=this,h=o.iterator();h.hasNext();){var d=h.next();d.isForward()&&u.checkForRightmostCoordinate(d)}Ze.isTrue(this._minIndex!==0||this._minCoord.equals(this._minDe.getCoordinate()),"inconsistency in rightmost processing"),this._minIndex===0?this.findRightmostEdgeAtNode():this.findRightmostEdgeAtVertex(),this._orientedDe=this._minDe;var g=this.getRightmostSide(this._minDe,this._minIndex);g===zt.LEFT&&(this._orientedDe=this._minDe.getSym())};Jo.prototype.interfaces_=function(){return[]};Jo.prototype.getClass=function(){return Jo};var $s=function(c){function o(u,h){c.call(this,o.msgWithCoord(u,h)),this.pt=h?new st(h):null,this.name="TopologyException"}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.getCoordinate=function(){return this.pt},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o.msgWithCoord=function(h,d){return d?h:h+" [ "+d+" ]"},o}(Hs),lm=function(){this.array_=[]};lm.prototype.addLast=function(o){this.array_.push(o)};lm.prototype.removeFirst=function(){return this.array_.shift()};lm.prototype.isEmpty=function(){return this.array_.length===0};var di=function(){this._finder=null,this._dirEdgeList=new jt,this._nodes=new jt,this._rightMostCoord=null,this._env=null,this._finder=new Jo};di.prototype.clearVisitedEdges=function(){for(var o=this._dirEdgeList.iterator();o.hasNext();){var u=o.next();u.setVisited(!1)}};di.prototype.getRightmostCoordinate=function(){return this._rightMostCoord};di.prototype.computeNodeDepth=function(o){for(var u=this,h=null,d=o.getEdges().iterator();d.hasNext();){var g=d.next();if(g.isVisited()||g.getSym().isVisited()){h=g;break}}if(h===null)throw new $s("unable to find edge to compute depths at "+o.getCoordinate());o.getEdges().computeDepths(h);for(var x=o.getEdges().iterator();x.hasNext();){var I=x.next();I.setVisited(!0),u.copySymDepths(I)}};di.prototype.computeDepth=function(o){this.clearVisitedEdges();var u=this._finder.getEdge();u.setEdgeDepths(zt.RIGHT,o),this.copySymDepths(u),this.computeDepths(u)};di.prototype.create=function(o){this.addReachable(o),this._finder.findEdge(this._dirEdgeList),this._rightMostCoord=this._finder.getCoordinate()};di.prototype.findResultEdges=function(){for(var o=this._dirEdgeList.iterator();o.hasNext();){var u=o.next();u.getDepth(zt.RIGHT)>=1&&u.getDepth(zt.LEFT)<=0&&!u.isInteriorAreaEdge()&&u.setInResult(!0)}};di.prototype.computeDepths=function(o){var u=this,h=new pv,d=new lm,g=o.getNode();for(d.addLast(g),h.add(g),o.setVisited(!0);!d.isEmpty();){var x=d.removeFirst();h.add(x),u.computeNodeDepth(x);for(var I=x.getEdges().iterator();I.hasNext();){var S=I.next(),D=S.getSym();if(!D.isVisited()){var O=D.getNode();h.contains(O)||(d.addLast(O),h.add(O))}}}};di.prototype.compareTo=function(o){var u=o;return this._rightMostCoord.x<u._rightMostCoord.x?-1:this._rightMostCoord.x>u._rightMostCoord.x?1:0};di.prototype.getEnvelope=function(){if(this._env===null){for(var o=new le,u=this._dirEdgeList.iterator();u.hasNext();)for(var h=u.next(),d=h.getEdge().getCoordinates(),g=0;g<d.length-1;g++)o.expandToInclude(d[g]);this._env=o}return this._env};di.prototype.addReachable=function(o){var u=this,h=new os;for(h.add(o);!h.empty();){var d=h.pop();u.add(d,h)}};di.prototype.copySymDepths=function(o){var u=o.getSym();u.setDepth(zt.LEFT,o.getDepth(zt.RIGHT)),u.setDepth(zt.RIGHT,o.getDepth(zt.LEFT))};di.prototype.add=function(o,u){var h=this;o.setVisited(!0),this._nodes.add(o);for(var d=o.getEdges().iterator();d.hasNext();){var g=d.next();h._dirEdgeList.add(g);var x=g.getSym(),I=x.getNode();I.isVisited()||u.push(I)}};di.prototype.getNodes=function(){return this._nodes};di.prototype.getDirectedEdges=function(){return this._dirEdgeList};di.prototype.interfaces_=function(){return[uo]};di.prototype.getClass=function(){return di};var Or=function c(){var o=this;if(this.location=null,arguments.length===1){if(arguments[0]instanceof Array){var u=arguments[0];this.init(u.length)}else if(Number.isInteger(arguments[0])){var h=arguments[0];this.init(1),this.location[zt.ON]=h}else if(arguments[0]instanceof c){var d=arguments[0];if(this.init(d.location.length),d!==null)for(var g=0;g<this.location.length;g++)o.location[g]=d.location[g]}}else if(arguments.length===3){var x=arguments[0],I=arguments[1],S=arguments[2];this.init(3),this.location[zt.ON]=x,this.location[zt.LEFT]=I,this.location[zt.RIGHT]=S}};Or.prototype.setAllLocations=function(o){for(var u=this,h=0;h<this.location.length;h++)u.location[h]=o};Or.prototype.isNull=function(){for(var o=this,u=0;u<this.location.length;u++)if(o.location[u]!==ut.NONE)return!1;return!0};Or.prototype.setAllLocationsIfNull=function(o){for(var u=this,h=0;h<this.location.length;h++)u.location[h]===ut.NONE&&(u.location[h]=o)};Or.prototype.isLine=function(){return this.location.length===1};Or.prototype.merge=function(o){var u=this;if(o.location.length>this.location.length){var h=new Array(3).fill(null);h[zt.ON]=this.location[zt.ON],h[zt.LEFT]=ut.NONE,h[zt.RIGHT]=ut.NONE,this.location=h}for(var d=0;d<this.location.length;d++)u.location[d]===ut.NONE&&d<o.location.length&&(u.location[d]=o.location[d])};Or.prototype.getLocations=function(){return this.location};Or.prototype.flip=function(){if(this.location.length<=1)return null;var o=this.location[zt.LEFT];this.location[zt.LEFT]=this.location[zt.RIGHT],this.location[zt.RIGHT]=o};Or.prototype.toString=function(){var o=new is;return this.location.length>1&&o.append(ut.toLocationSymbol(this.location[zt.LEFT])),o.append(ut.toLocationSymbol(this.location[zt.ON])),this.location.length>1&&o.append(ut.toLocationSymbol(this.location[zt.RIGHT])),o.toString()};Or.prototype.setLocations=function(o,u,h){this.location[zt.ON]=o,this.location[zt.LEFT]=u,this.location[zt.RIGHT]=h};Or.prototype.get=function(o){return o<this.location.length?this.location[o]:ut.NONE};Or.prototype.isArea=function(){return this.location.length>1};Or.prototype.isAnyNull=function(){for(var o=this,u=0;u<this.location.length;u++)if(o.location[u]===ut.NONE)return!0;return!1};Or.prototype.setLocation=function(){if(arguments.length===1){var o=arguments[0];this.setLocation(zt.ON,o)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];this.location[u]=h}};Or.prototype.init=function(o){this.location=new Array(o).fill(null),this.setAllLocations(ut.NONE)};Or.prototype.isEqualOnSide=function(o,u){return this.location[u]===o.location[u]};Or.prototype.allPositionsEqual=function(o){for(var u=this,h=0;h<this.location.length;h++)if(u.location[h]!==o)return!1;return!0};Or.prototype.interfaces_=function(){return[]};Or.prototype.getClass=function(){return Or};var xr=function c(){if(this.elt=new Array(2).fill(null),arguments.length===1){if(Number.isInteger(arguments[0])){var o=arguments[0];this.elt[0]=new Or(o),this.elt[1]=new Or(o)}else if(arguments[0]instanceof c){var u=arguments[0];this.elt[0]=new Or(u.elt[0]),this.elt[1]=new Or(u.elt[1])}}else if(arguments.length===2){var h=arguments[0],d=arguments[1];this.elt[0]=new Or(ut.NONE),this.elt[1]=new Or(ut.NONE),this.elt[h].setLocation(d)}else if(arguments.length===3){var g=arguments[0],x=arguments[1],I=arguments[2];this.elt[0]=new Or(g,x,I),this.elt[1]=new Or(g,x,I)}else if(arguments.length===4){var S=arguments[0],D=arguments[1],O=arguments[2],B=arguments[3];this.elt[0]=new Or(ut.NONE,ut.NONE,ut.NONE),this.elt[1]=new Or(ut.NONE,ut.NONE,ut.NONE),this.elt[S].setLocations(D,O,B)}};xr.prototype.getGeometryCount=function(){var o=0;return this.elt[0].isNull()||o++,this.elt[1].isNull()||o++,o};xr.prototype.setAllLocations=function(o,u){this.elt[o].setAllLocations(u)};xr.prototype.isNull=function(o){return this.elt[o].isNull()};xr.prototype.setAllLocationsIfNull=function(){if(arguments.length===1){var o=arguments[0];this.setAllLocationsIfNull(0,o),this.setAllLocationsIfNull(1,o)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];this.elt[u].setAllLocationsIfNull(h)}};xr.prototype.isLine=function(o){return this.elt[o].isLine()};xr.prototype.merge=function(o){for(var u=this,h=0;h<2;h++)u.elt[h]===null&&o.elt[h]!==null?u.elt[h]=new Or(o.elt[h]):u.elt[h].merge(o.elt[h])};xr.prototype.flip=function(){this.elt[0].flip(),this.elt[1].flip()};xr.prototype.getLocation=function(){if(arguments.length===1){var o=arguments[0];return this.elt[o].get(zt.ON)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];return this.elt[u].get(h)}};xr.prototype.toString=function(){var o=new is;return this.elt[0]!==null&&(o.append("A:"),o.append(this.elt[0].toString())),this.elt[1]!==null&&(o.append(" B:"),o.append(this.elt[1].toString())),o.toString()};xr.prototype.isArea=function(){if(arguments.length===0)return this.elt[0].isArea()||this.elt[1].isArea();if(arguments.length===1){var o=arguments[0];return this.elt[o].isArea()}};xr.prototype.isAnyNull=function(o){return this.elt[o].isAnyNull()};xr.prototype.setLocation=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1];this.elt[o].setLocation(zt.ON,u)}else if(arguments.length===3){var h=arguments[0],d=arguments[1],g=arguments[2];this.elt[h].setLocation(d,g)}};xr.prototype.isEqualOnSide=function(o,u){return this.elt[0].isEqualOnSide(o.elt[0],u)&&this.elt[1].isEqualOnSide(o.elt[1],u)};xr.prototype.allPositionsEqual=function(o,u){return this.elt[o].allPositionsEqual(u)};xr.prototype.toLine=function(o){this.elt[o].isArea()&&(this.elt[o]=new Or(this.elt[o].location[0]))};xr.prototype.interfaces_=function(){return[]};xr.prototype.getClass=function(){return xr};xr.toLineLabel=function(o){for(var u=new xr(ut.NONE),h=0;h<2;h++)u.setLocation(h,o.getLocation(h));return u};var yn=function(){this._startDe=null,this._maxNodeDegree=-1,this._edges=new jt,this._pts=new jt,this._label=new xr(ut.NONE),this._ring=null,this._isHole=null,this._shell=null,this._holes=new jt,this._geometryFactory=null;var o=arguments[0],u=arguments[1];this._geometryFactory=u,this.computePoints(o),this.computeRing()};yn.prototype.computeRing=function(){var o=this;if(this._ring!==null)return null;for(var u=new Array(this._pts.size()).fill(null),h=0;h<this._pts.size();h++)u[h]=o._pts.get(h);this._ring=this._geometryFactory.createLinearRing(u),this._isHole=Kt.isCCW(this._ring.getCoordinates())};yn.prototype.isIsolated=function(){return this._label.getGeometryCount()===1};yn.prototype.computePoints=function(o){var u=this;this._startDe=o;var h=o,d=!0;do{if(h===null)throw new $s("Found null DirectedEdge");if(h.getEdgeRing()===u)throw new $s("Directed Edge visited twice during ring-building at "+h.getCoordinate());u._edges.add(h);var g=h.getLabel();Ze.isTrue(g.isArea()),u.mergeLabel(g),u.addPoints(h.getEdge(),h.isForward(),d),d=!1,u.setEdgeRing(h,u),h=u.getNext(h)}while(h!==this._startDe)};yn.prototype.getLinearRing=function(){return this._ring};yn.prototype.getCoordinate=function(o){return this._pts.get(o)};yn.prototype.computeMaxNodeDegree=function(){var o=this;this._maxNodeDegree=0;var u=this._startDe;do{var h=u.getNode(),d=h.getEdges().getOutgoingDegree(o);d>o._maxNodeDegree&&(o._maxNodeDegree=d),u=o.getNext(u)}while(u!==this._startDe);this._maxNodeDegree*=2};yn.prototype.addPoints=function(o,u,h){var d=this,g=o.getCoordinates();if(u){var x=1;h&&(x=0);for(var I=x;I<g.length;I++)d._pts.add(g[I])}else{var S=g.length-2;h&&(S=g.length-1);for(var D=S;D>=0;D--)d._pts.add(g[D])}};yn.prototype.isHole=function(){return this._isHole};yn.prototype.setInResult=function(){var o=this._startDe;do o.getEdge().setInResult(!0),o=o.getNext();while(o!==this._startDe)};yn.prototype.containsPoint=function(o){var u=this.getLinearRing(),h=u.getEnvelopeInternal();if(!h.contains(o)||!Kt.isPointInRing(o,u.getCoordinates()))return!1;for(var d=this._holes.iterator();d.hasNext();){var g=d.next();if(g.containsPoint(o))return!1}return!0};yn.prototype.addHole=function(o){this._holes.add(o)};yn.prototype.isShell=function(){return this._shell===null};yn.prototype.getLabel=function(){return this._label};yn.prototype.getEdges=function(){return this._edges};yn.prototype.getMaxNodeDegree=function(){return this._maxNodeDegree<0&&this.computeMaxNodeDegree(),this._maxNodeDegree};yn.prototype.getShell=function(){return this._shell};yn.prototype.mergeLabel=function(){if(arguments.length===1){var o=arguments[0];this.mergeLabel(o,0),this.mergeLabel(o,1)}else if(arguments.length===2){var u=arguments[0],h=arguments[1],d=u.getLocation(h,zt.RIGHT);if(d===ut.NONE)return null;if(this._label.getLocation(h)===ut.NONE)return this._label.setLocation(h,d),null}};yn.prototype.setShell=function(o){this._shell=o,o!==null&&o.addHole(this)};yn.prototype.toPolygon=function(o){for(var u=this,h=new Array(this._holes.size()).fill(null),d=0;d<this._holes.size();d++)h[d]=u._holes.get(d).getLinearRing();var g=o.createPolygon(this.getLinearRing(),h);return g};yn.prototype.interfaces_=function(){return[]};yn.prototype.getClass=function(){return yn};var mO=function(c){function o(){var u=arguments[0],h=arguments[1];c.call(this,u,h)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.setEdgeRing=function(h,d){h.setMinEdgeRing(d)},o.prototype.getNext=function(h){return h.getNextMin()},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(yn),gO=function(c){function o(){var u=arguments[0],h=arguments[1];c.call(this,u,h)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.buildMinimalRings=function(){var h=this,d=new jt,g=this._startDe;do{if(g.getMinEdgeRing()===null){var x=new mO(g,h._geometryFactory);d.add(x)}g=g.getNext()}while(g!==this._startDe);return d},o.prototype.setEdgeRing=function(h,d){h.setEdgeRing(d)},o.prototype.linkDirectedEdgesForMinimalEdgeRings=function(){var h=this,d=this._startDe;do{var g=d.getNode();g.getEdges().linkMinimalDirectedEdges(h),d=d.getNext()}while(d!==this._startDe)},o.prototype.getNext=function(h){return h.getNext()},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(yn),Ui=function(){if(this._label=null,this._isInResult=!1,this._isCovered=!1,this._isCoveredSet=!1,this._isVisited=!1,arguments.length!==0){if(arguments.length===1){var o=arguments[0];this._label=o}}};Ui.prototype.setVisited=function(o){this._isVisited=o};Ui.prototype.setInResult=function(o){this._isInResult=o};Ui.prototype.isCovered=function(){return this._isCovered};Ui.prototype.isCoveredSet=function(){return this._isCoveredSet};Ui.prototype.setLabel=function(o){this._label=o};Ui.prototype.getLabel=function(){return this._label};Ui.prototype.setCovered=function(o){this._isCovered=o,this._isCoveredSet=!0};Ui.prototype.updateIM=function(o){Ze.isTrue(this._label.getGeometryCount()>=2,"found partial label"),this.computeIM(o)};Ui.prototype.isInResult=function(){return this._isInResult};Ui.prototype.isVisited=function(){return this._isVisited};Ui.prototype.interfaces_=function(){return[]};Ui.prototype.getClass=function(){return Ui};var um=function(c){function o(){c.call(this),this._coord=null,this._edges=null;var u=arguments[0],h=arguments[1];this._coord=u,this._edges=h,this._label=new xr(0,ut.NONE)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.isIncidentEdgeInResult=function(){for(var h=this.getEdges().getEdges().iterator();h.hasNext();){var d=h.next();if(d.getEdge().isInResult())return!0}return!1},o.prototype.isIsolated=function(){return this._label.getGeometryCount()===1},o.prototype.getCoordinate=function(){return this._coord},o.prototype.print=function(h){h.println("node "+this._coord+" lbl: "+this._label)},o.prototype.computeIM=function(h){},o.prototype.computeMergedLocation=function(h,d){var g=ut.NONE;if(g=this._label.getLocation(d),!h.isNull(d)){var x=h.getLocation(d);g!==ut.BOUNDARY&&(g=x)}return g},o.prototype.setLabel=function(){if(arguments.length===2){var h=arguments[0],d=arguments[1];this._label===null?this._label=new xr(h,d):this._label.setLocation(h,d)}else return c.prototype.setLabel.apply(this,arguments)},o.prototype.getEdges=function(){return this._edges},o.prototype.mergeLabel=function(){var h=this;if(arguments[0]instanceof o){var d=arguments[0];this.mergeLabel(d._label)}else if(arguments[0]instanceof xr)for(var g=arguments[0],x=0;x<2;x++){var I=h.computeMergedLocation(g,x),S=h._label.getLocation(x);S===ut.NONE&&h._label.setLocation(x,I)}},o.prototype.add=function(h){this._edges.insert(h),h.setNode(this)},o.prototype.setLabelBoundary=function(h){if(this._label===null)return null;var d=ut.NONE;this._label!==null&&(d=this._label.getLocation(h));var g=null;switch(d){case ut.BOUNDARY:g=ut.INTERIOR;break;case ut.INTERIOR:g=ut.BOUNDARY;break;default:g=ut.BOUNDARY;break}this._label.setLocation(h,g)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Ui),Qo=function(){this.nodeMap=new ii,this.nodeFact=null;var o=arguments[0];this.nodeFact=o};Qo.prototype.find=function(o){return this.nodeMap.get(o)};Qo.prototype.addNode=function(){if(arguments[0]instanceof st){var o=arguments[0],u=this.nodeMap.get(o);return u===null&&(u=this.nodeFact.createNode(o),this.nodeMap.put(o,u)),u}else if(arguments[0]instanceof um){var h=arguments[0],d=this.nodeMap.get(h.getCoordinate());return d===null?(this.nodeMap.put(h.getCoordinate(),h),h):(d.mergeLabel(h),d)}};Qo.prototype.print=function(o){for(var u=this.iterator();u.hasNext();){var h=u.next();h.print(o)}};Qo.prototype.iterator=function(){return this.nodeMap.values().iterator()};Qo.prototype.values=function(){return this.nodeMap.values()};Qo.prototype.getBoundaryNodes=function(o){for(var u=new jt,h=this.iterator();h.hasNext();){var d=h.next();d.getLabel().getLocation(o)===ut.BOUNDARY&&u.add(d)}return u};Qo.prototype.add=function(o){var u=o.getCoordinate(),h=this.addNode(u);h.add(o)};Qo.prototype.interfaces_=function(){return[]};Qo.prototype.getClass=function(){return Qo};var Er=function(){},xp={NE:{configurable:!0},NW:{configurable:!0},SW:{configurable:!0},SE:{configurable:!0}};Er.prototype.interfaces_=function(){return[]};Er.prototype.getClass=function(){return Er};Er.isNorthern=function(o){return o===Er.NE||o===Er.NW};Er.isOpposite=function(o,u){if(o===u)return!1;var h=(o-u+4)%4;return h===2};Er.commonHalfPlane=function(o,u){if(o===u)return o;var h=(o-u+4)%4;if(h===2)return-1;var d=o<u?o:u,g=o>u?o:u;return d===0&&g===3?3:d};Er.isInHalfPlane=function(o,u){return u===Er.SE?o===Er.SE||o===Er.SW:o===u||o===u+1};Er.quadrant=function(){if(typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var o=arguments[0],u=arguments[1];if(o===0&&u===0)throw new Xr("Cannot compute the quadrant for point ( "+o+", "+u+" )");return o>=0?u>=0?Er.NE:Er.SE:u>=0?Er.NW:Er.SW}else if(arguments[0]instanceof st&&arguments[1]instanceof st){var h=arguments[0],d=arguments[1];if(d.x===h.x&&d.y===h.y)throw new Xr("Cannot compute the quadrant for two identical points "+h);return d.x>=h.x?d.y>=h.y?Er.NE:Er.SE:d.y>=h.y?Er.NW:Er.SW}};xp.NE.get=function(){return 0};xp.NW.get=function(){return 1};xp.SW.get=function(){return 2};xp.SE.get=function(){return 3};Object.defineProperties(Er,xp);var oi=function(){if(this._edge=null,this._label=null,this._node=null,this._p0=null,this._p1=null,this._dx=null,this._dy=null,this._quadrant=null,arguments.length===1){var o=arguments[0];this._edge=o}else if(arguments.length===3){var u=arguments[0],h=arguments[1],d=arguments[2],g=null;this._edge=u,this.init(h,d),this._label=g}else if(arguments.length===4){var x=arguments[0],I=arguments[1],S=arguments[2],D=arguments[3];this._edge=x,this.init(I,S),this._label=D}};oi.prototype.compareDirection=function(o){return this._dx===o._dx&&this._dy===o._dy?0:this._quadrant>o._quadrant?1:this._quadrant<o._quadrant?-1:Kt.computeOrientation(o._p0,o._p1,this._p1)};oi.prototype.getDy=function(){return this._dy};oi.prototype.getCoordinate=function(){return this._p0};oi.prototype.setNode=function(o){this._node=o};oi.prototype.print=function(o){var u=Math.atan2(this._dy,this._dx),h=this.getClass().getName(),d=h.lastIndexOf("."),g=h.substring(d+1);o.print("  "+g+": "+this._p0+" - "+this._p1+" "+this._quadrant+":"+u+"   "+this._label)};oi.prototype.compareTo=function(o){var u=o;return this.compareDirection(u)};oi.prototype.getDirectedCoordinate=function(){return this._p1};oi.prototype.getDx=function(){return this._dx};oi.prototype.getLabel=function(){return this._label};oi.prototype.getEdge=function(){return this._edge};oi.prototype.getQuadrant=function(){return this._quadrant};oi.prototype.getNode=function(){return this._node};oi.prototype.toString=function(){var o=Math.atan2(this._dy,this._dx),u=this.getClass().getName(),h=u.lastIndexOf("."),d=u.substring(h+1);return"  "+d+": "+this._p0+" - "+this._p1+" "+this._quadrant+":"+o+"   "+this._label};oi.prototype.computeLabel=function(o){};oi.prototype.init=function(o,u){this._p0=o,this._p1=u,this._dx=u.x-o.x,this._dy=u.y-o.y,this._quadrant=Er.quadrant(this._dx,this._dy),Ze.isTrue(!(this._dx===0&&this._dy===0),"EdgeEnd with identical endpoints found")};oi.prototype.interfaces_=function(){return[uo]};oi.prototype.getClass=function(){return oi};var Qy=function(c){function o(){var u=arguments[0],h=arguments[1];if(c.call(this,u),this._isForward=null,this._isInResult=!1,this._isVisited=!1,this._sym=null,this._next=null,this._nextMin=null,this._edgeRing=null,this._minEdgeRing=null,this._depth=[0,-999,-999],this._isForward=h,h)this.init(u.getCoordinate(0),u.getCoordinate(1));else{var d=u.getNumPoints()-1;this.init(u.getCoordinate(d),u.getCoordinate(d-1))}this.computeDirectedLabel()}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.getNextMin=function(){return this._nextMin},o.prototype.getDepth=function(h){return this._depth[h]},o.prototype.setVisited=function(h){this._isVisited=h},o.prototype.computeDirectedLabel=function(){this._label=new xr(this._edge.getLabel()),this._isForward||this._label.flip()},o.prototype.getNext=function(){return this._next},o.prototype.setDepth=function(h,d){if(this._depth[h]!==-999&&this._depth[h]!==d)throw new $s("assigned depths do not match",this.getCoordinate());this._depth[h]=d},o.prototype.isInteriorAreaEdge=function(){for(var h=this,d=!0,g=0;g<2;g++)h._label.isArea(g)&&h._label.getLocation(g,zt.LEFT)===ut.INTERIOR&&h._label.getLocation(g,zt.RIGHT)===ut.INTERIOR||(d=!1);return d},o.prototype.setNextMin=function(h){this._nextMin=h},o.prototype.print=function(h){c.prototype.print.call(this,h),h.print(" "+this._depth[zt.LEFT]+"/"+this._depth[zt.RIGHT]),h.print(" ("+this.getDepthDelta()+")"),this._isInResult&&h.print(" inResult")},o.prototype.setMinEdgeRing=function(h){this._minEdgeRing=h},o.prototype.isLineEdge=function(){var h=this._label.isLine(0)||this._label.isLine(1),d=!this._label.isArea(0)||this._label.allPositionsEqual(0,ut.EXTERIOR),g=!this._label.isArea(1)||this._label.allPositionsEqual(1,ut.EXTERIOR);return h&&d&&g},o.prototype.setEdgeRing=function(h){this._edgeRing=h},o.prototype.getMinEdgeRing=function(){return this._minEdgeRing},o.prototype.getDepthDelta=function(){var h=this._edge.getDepthDelta();return this._isForward||(h=-h),h},o.prototype.setInResult=function(h){this._isInResult=h},o.prototype.getSym=function(){return this._sym},o.prototype.isForward=function(){return this._isForward},o.prototype.getEdge=function(){return this._edge},o.prototype.printEdge=function(h){this.print(h),h.print(" "),this._isForward?this._edge.print(h):this._edge.printReverse(h)},o.prototype.setSym=function(h){this._sym=h},o.prototype.setVisitedEdge=function(h){this.setVisited(h),this._sym.setVisited(h)},o.prototype.setEdgeDepths=function(h,d){var g=this.getEdge().getDepthDelta();this._isForward||(g=-g);var x=1;h===zt.LEFT&&(x=-1);var I=zt.opposite(h),S=g*x,D=d+S;this.setDepth(h,d),this.setDepth(I,D)},o.prototype.getEdgeRing=function(){return this._edgeRing},o.prototype.isInResult=function(){return this._isInResult},o.prototype.setNext=function(h){this._next=h},o.prototype.isVisited=function(){return this._isVisited},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o.depthFactor=function(h,d){return h===ut.EXTERIOR&&d===ut.INTERIOR?1:h===ut.INTERIOR&&d===ut.EXTERIOR?-1:0},o}(oi),Sc=function(){};Sc.prototype.createNode=function(o){return new um(o,null)};Sc.prototype.interfaces_=function(){return[]};Sc.prototype.getClass=function(){return Sc};var Kr=function(){if(this._edges=new jt,this._nodes=null,this._edgeEndList=new jt,arguments.length===0)this._nodes=new Qo(new Sc);else if(arguments.length===1){var o=arguments[0];this._nodes=new Qo(o)}};Kr.prototype.printEdges=function(o){var u=this;o.println("Edges:");for(var h=0;h<this._edges.size();h++){o.println("edge "+h+":");var d=u._edges.get(h);d.print(o),d.eiList.print(o)}};Kr.prototype.find=function(o){return this._nodes.find(o)};Kr.prototype.addNode=function(){if(arguments[0]instanceof um){var o=arguments[0];return this._nodes.addNode(o)}else if(arguments[0]instanceof st){var u=arguments[0];return this._nodes.addNode(u)}};Kr.prototype.getNodeIterator=function(){return this._nodes.iterator()};Kr.prototype.linkResultDirectedEdges=function(){for(var o=this._nodes.iterator();o.hasNext();){var u=o.next();u.getEdges().linkResultDirectedEdges()}};Kr.prototype.debugPrintln=function(o){$n.out.println(o)};Kr.prototype.isBoundaryNode=function(o,u){var h=this._nodes.find(u);if(h===null)return!1;var d=h.getLabel();return d!==null&&d.getLocation(o)===ut.BOUNDARY};Kr.prototype.linkAllDirectedEdges=function(){for(var o=this._nodes.iterator();o.hasNext();){var u=o.next();u.getEdges().linkAllDirectedEdges()}};Kr.prototype.matchInSameDirection=function(o,u,h,d){return o.equals(h)?Kt.computeOrientation(o,u,d)===Kt.COLLINEAR&&Er.quadrant(o,u)===Er.quadrant(h,d):!1};Kr.prototype.getEdgeEnds=function(){return this._edgeEndList};Kr.prototype.debugPrint=function(o){$n.out.print(o)};Kr.prototype.getEdgeIterator=function(){return this._edges.iterator()};Kr.prototype.findEdgeInSameDirection=function(o,u){for(var h=this,d=0;d<this._edges.size();d++){var g=h._edges.get(d),x=g.getCoordinates();if(h.matchInSameDirection(o,u,x[0],x[1])||h.matchInSameDirection(o,u,x[x.length-1],x[x.length-2]))return g}return null};Kr.prototype.insertEdge=function(o){this._edges.add(o)};Kr.prototype.findEdgeEnd=function(o){for(var u=this.getEdgeEnds().iterator();u.hasNext();){var h=u.next();if(h.getEdge()===o)return h}return null};Kr.prototype.addEdges=function(o){for(var u=this,h=o.iterator();h.hasNext();){var d=h.next();u._edges.add(d);var g=new Qy(d,!0),x=new Qy(d,!1);g.setSym(x),x.setSym(g),u.add(g),u.add(x)}};Kr.prototype.add=function(o){this._nodes.add(o),this._edgeEndList.add(o)};Kr.prototype.getNodes=function(){return this._nodes.values()};Kr.prototype.findEdge=function(o,u){for(var h=this,d=0;d<this._edges.size();d++){var g=h._edges.get(d),x=g.getCoordinates();if(o.equals(x[0])&&u.equals(x[1]))return g}return null};Kr.prototype.interfaces_=function(){return[]};Kr.prototype.getClass=function(){return Kr};Kr.linkResultDirectedEdges=function(o){for(var u=o.iterator();u.hasNext();){var h=u.next();h.getEdges().linkResultDirectedEdges()}};var Mi=function(){this._geometryFactory=null,this._shellList=new jt;var o=arguments[0];this._geometryFactory=o};Mi.prototype.sortShellsAndHoles=function(o,u,h){for(var d=o.iterator();d.hasNext();){var g=d.next();g.isHole()?h.add(g):u.add(g)}};Mi.prototype.computePolygons=function(o){for(var u=this,h=new jt,d=o.iterator();d.hasNext();){var g=d.next(),x=g.toPolygon(u._geometryFactory);h.add(x)}return h};Mi.prototype.placeFreeHoles=function(o,u){for(var h=this,d=u.iterator();d.hasNext();){var g=d.next();if(g.getShell()===null){var x=h.findEdgeRingContaining(g,o);if(x===null)throw new $s("unable to assign hole to a shell",g.getCoordinate(0));g.setShell(x)}}};Mi.prototype.buildMinimalEdgeRings=function(o,u,h){for(var d=this,g=new jt,x=o.iterator();x.hasNext();){var I=x.next();if(I.getMaxNodeDegree()>2){I.linkDirectedEdgesForMinimalEdgeRings();var S=I.buildMinimalRings(),D=d.findShell(S);D!==null?(d.placePolygonHoles(D,S),u.add(D)):h.addAll(S)}else g.add(I)}return g};Mi.prototype.containsPoint=function(o){for(var u=this._shellList.iterator();u.hasNext();){var h=u.next();if(h.containsPoint(o))return!0}return!1};Mi.prototype.buildMaximalEdgeRings=function(o){for(var u=this,h=new jt,d=o.iterator();d.hasNext();){var g=d.next();if(g.isInResult()&&g.getLabel().isArea()&&g.getEdgeRing()===null){var x=new gO(g,u._geometryFactory);h.add(x),x.setInResult()}}return h};Mi.prototype.placePolygonHoles=function(o,u){for(var h=u.iterator();h.hasNext();){var d=h.next();d.isHole()&&d.setShell(o)}};Mi.prototype.getPolygons=function(){var o=this.computePolygons(this._shellList);return o};Mi.prototype.findEdgeRingContaining=function(o,u){for(var h=o.getLinearRing(),d=h.getEnvelopeInternal(),g=h.getCoordinateN(0),x=null,I=null,S=u.iterator();S.hasNext();){var D=S.next(),O=D.getLinearRing(),B=O.getEnvelopeInternal();x!==null&&(I=x.getLinearRing().getEnvelopeInternal());var W=!1;B.contains(d)&&Kt.isPointInRing(g,O.getCoordinates())&&(W=!0),W&&(x===null||I.contains(B))&&(x=D)}return x};Mi.prototype.findShell=function(o){for(var u=0,h=null,d=o.iterator();d.hasNext();){var g=d.next();g.isHole()||(h=g,u++)}return Ze.isTrue(u<=1,"found two shells in MinimalEdgeRing list"),h};Mi.prototype.add=function(){if(arguments.length===1){var o=arguments[0];this.add(o.getEdgeEnds(),o.getNodes())}else if(arguments.length===2){var u=arguments[0],h=arguments[1];Kr.linkResultDirectedEdges(h);var d=this.buildMaximalEdgeRings(u),g=new jt,x=this.buildMinimalEdgeRings(d,this._shellList,g);this.sortShellsAndHoles(x,this._shellList,g),this.placeFreeHoles(this._shellList,g)}};Mi.prototype.interfaces_=function(){return[]};Mi.prototype.getClass=function(){return Mi};var Cc=function(){};Cc.prototype.getBounds=function(){};Cc.prototype.interfaces_=function(){return[]};Cc.prototype.getClass=function(){return Cc};var To=function(){this._bounds=null,this._item=null;var o=arguments[0],u=arguments[1];this._bounds=o,this._item=u};To.prototype.getItem=function(){return this._item};To.prototype.getBounds=function(){return this._bounds};To.prototype.interfaces_=function(){return[Cc,co]};To.prototype.getClass=function(){return To};var Ks=function(){this._size=null,this._items=null,this._size=0,this._items=new jt,this._items.add(null)};Ks.prototype.poll=function(){if(this.isEmpty())return null;var o=this._items.get(1);return this._items.set(1,this._items.get(this._size)),this._size-=1,this.reorder(1),o};Ks.prototype.size=function(){return this._size};Ks.prototype.reorder=function(o){for(var u=this,h=null,d=this._items.get(o);o*2<=this._size&&(h=o*2,h!==u._size&&u._items.get(h+1).compareTo(u._items.get(h))<0&&h++,u._items.get(h).compareTo(d)<0);o=h)u._items.set(o,u._items.get(h));this._items.set(o,d)};Ks.prototype.clear=function(){this._size=0,this._items.clear()};Ks.prototype.isEmpty=function(){return this._size===0};Ks.prototype.add=function(o){var u=this;this._items.add(null),this._size+=1;var h=this._size;for(this._items.set(0,o);o.compareTo(this._items.get(Math.trunc(h/2)))<0;h/=2)u._items.set(h,u._items.get(Math.trunc(h/2)));this._items.set(h,o)};Ks.prototype.interfaces_=function(){return[]};Ks.prototype.getClass=function(){return Ks};var Sa=function(){};Sa.prototype.visitItem=function(o){};Sa.prototype.interfaces_=function(){return[]};Sa.prototype.getClass=function(){return Sa};var tu=function(){};tu.prototype.insert=function(o,u){};tu.prototype.remove=function(o,u){};tu.prototype.query=function(){};tu.prototype.interfaces_=function(){return[]};tu.prototype.getClass=function(){return tu};var Sn=function(){if(this._childBoundables=new jt,this._bounds=null,this._level=null,arguments.length!==0){if(arguments.length===1){var o=arguments[0];this._level=o}}},rI={serialVersionUID:{configurable:!0}};Sn.prototype.getLevel=function(){return this._level};Sn.prototype.size=function(){return this._childBoundables.size()};Sn.prototype.getChildBoundables=function(){return this._childBoundables};Sn.prototype.addChildBoundable=function(o){Ze.isTrue(this._bounds===null),this._childBoundables.add(o)};Sn.prototype.isEmpty=function(){return this._childBoundables.isEmpty()};Sn.prototype.getBounds=function(){return this._bounds===null&&(this._bounds=this.computeBounds()),this._bounds};Sn.prototype.interfaces_=function(){return[Cc,co]};Sn.prototype.getClass=function(){return Sn};rI.serialVersionUID.get=function(){return 6493722185909574e3};Object.defineProperties(Sn,rI);var Io=function(){};Io.reverseOrder=function(){return{compare:function(u,h){return h.compareTo(u)}}};Io.min=function(o){return Io.sort(o),o.get(0)};Io.sort=function(o,u){var h=o.toArray();u?_l.sort(h,u):_l.sort(h);for(var d=o.iterator(),g=0,x=h.length;g<x;g++)d.next(),d.set(h[g])};Io.singletonList=function(o){var u=new jt;return u.add(o),u};var gn=function(){this._boundable1=null,this._boundable2=null,this._distance=null,this._itemDistance=null;var o=arguments[0],u=arguments[1],h=arguments[2];this._boundable1=o,this._boundable2=u,this._itemDistance=h,this._distance=this.distance()};gn.prototype.expandToQueue=function(o,u){var h=gn.isComposite(this._boundable1),d=gn.isComposite(this._boundable2);if(h&&d)return gn.area(this._boundable1)>gn.area(this._boundable2)?(this.expand(this._boundable1,this._boundable2,o,u),null):(this.expand(this._boundable2,this._boundable1,o,u),null);if(h)return this.expand(this._boundable1,this._boundable2,o,u),null;if(d)return this.expand(this._boundable2,this._boundable1,o,u),null;throw new Xr("neither boundable is composite")};gn.prototype.isLeaves=function(){return!(gn.isComposite(this._boundable1)||gn.isComposite(this._boundable2))};gn.prototype.compareTo=function(o){var u=o;return this._distance<u._distance?-1:this._distance>u._distance?1:0};gn.prototype.expand=function(o,u,h,d){for(var g=this,x=o.getChildBoundables(),I=x.iterator();I.hasNext();){var S=I.next(),D=new gn(S,u,g._itemDistance);D.getDistance()<d&&h.add(D)}};gn.prototype.getBoundable=function(o){return o===0?this._boundable1:this._boundable2};gn.prototype.getDistance=function(){return this._distance};gn.prototype.distance=function(){return this.isLeaves()?this._itemDistance.distance(this._boundable1,this._boundable2):this._boundable1.getBounds().distance(this._boundable2.getBounds())};gn.prototype.interfaces_=function(){return[uo]};gn.prototype.getClass=function(){return gn};gn.area=function(o){return o.getBounds().getArea()};gn.isComposite=function(o){return o instanceof Sn};var zn=function c(){if(this._root=null,this._built=!1,this._itemBoundables=new jt,this._nodeCapacity=null,arguments.length===0){var o=c.DEFAULT_NODE_CAPACITY;this._nodeCapacity=o}else if(arguments.length===1){var u=arguments[0];Ze.isTrue(u>1,"Node capacity must be greater than 1"),this._nodeCapacity=u}},cm={IntersectsOp:{configurable:!0},serialVersionUID:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};zn.prototype.getNodeCapacity=function(){return this._nodeCapacity};zn.prototype.lastNode=function(o){return o.get(o.size()-1)};zn.prototype.size=function(){var o=this;if(arguments.length===0)return this.isEmpty()?0:(this.build(),this.size(this._root));if(arguments.length===1){for(var u=arguments[0],h=0,d=u.getChildBoundables().iterator();d.hasNext();){var g=d.next();g instanceof Sn?h+=o.size(g):g instanceof To&&(h+=1)}return h}};zn.prototype.removeItem=function(o,u){for(var h=null,d=o.getChildBoundables().iterator();d.hasNext();){var g=d.next();g instanceof To&&g.getItem()===u&&(h=g)}return h!==null?(o.getChildBoundables().remove(h),!0):!1};zn.prototype.itemsTree=function(){var o=this;if(arguments.length===0){this.build();var u=this.itemsTree(this._root);return u===null?new jt:u}else if(arguments.length===1){for(var h=arguments[0],d=new jt,g=h.getChildBoundables().iterator();g.hasNext();){var x=g.next();if(x instanceof Sn){var I=o.itemsTree(x);I!==null&&d.add(I)}else x instanceof To?d.add(x.getItem()):Ze.shouldNeverReachHere()}return d.size()<=0?null:d}};zn.prototype.insert=function(o,u){Ze.isTrue(!this._built,"Cannot insert items into an STR packed R-tree after it has been built."),this._itemBoundables.add(new To(o,u))};zn.prototype.boundablesAtLevel=function(){var o=this;if(arguments.length===1){var u=arguments[0],h=new jt;return this.boundablesAtLevel(u,this._root,h),h}else if(arguments.length===3){var d=arguments[0],g=arguments[1],x=arguments[2];if(Ze.isTrue(d>-2),g.getLevel()===d)return x.add(g),null;for(var I=g.getChildBoundables().iterator();I.hasNext();){var S=I.next();S instanceof Sn?o.boundablesAtLevel(d,S,x):(Ze.isTrue(S instanceof To),d===-1&&x.add(S))}return null}};zn.prototype.query=function(){var o=this;if(arguments.length===1){var u=arguments[0];this.build();var h=new jt;return this.isEmpty()||this.getIntersectsOp().intersects(this._root.getBounds(),u)&&this.query(u,this._root,h),h}else if(arguments.length===2){var d=arguments[0],g=arguments[1];if(this.build(),this.isEmpty())return null;this.getIntersectsOp().intersects(this._root.getBounds(),d)&&this.query(d,this._root,g)}else if(arguments.length===3){if(Ee(arguments[2],Sa)&&arguments[0]instanceof Object&&arguments[1]instanceof Sn)for(var x=arguments[0],I=arguments[1],S=arguments[2],D=I.getChildBoundables(),O=0;O<D.size();O++){var B=D.get(O);o.getIntersectsOp().intersects(B.getBounds(),x)&&(B instanceof Sn?o.query(x,B,S):B instanceof To?S.visitItem(B.getItem()):Ze.shouldNeverReachHere())}else if(Ee(arguments[2],bo)&&arguments[0]instanceof Object&&arguments[1]instanceof Sn)for(var W=arguments[0],et=arguments[1],it=arguments[2],bt=et.getChildBoundables(),ft=0;ft<bt.size();ft++){var Pt=bt.get(ft);o.getIntersectsOp().intersects(Pt.getBounds(),W)&&(Pt instanceof Sn?o.query(W,Pt,it):Pt instanceof To?it.add(Pt.getItem()):Ze.shouldNeverReachHere())}}};zn.prototype.build=function(){if(this._built)return null;this._root=this._itemBoundables.isEmpty()?this.createNode(0):this.createHigherLevels(this._itemBoundables,-1),this._itemBoundables=null,this._built=!0};zn.prototype.getRoot=function(){return this.build(),this._root};zn.prototype.remove=function(){var o=this;if(arguments.length===2){var u=arguments[0],h=arguments[1];return this.build(),this.getIntersectsOp().intersects(this._root.getBounds(),u)?this.remove(u,this._root,h):!1}else if(arguments.length===3){var d=arguments[0],g=arguments[1],x=arguments[2],I=this.removeItem(g,x);if(I)return!0;for(var S=null,D=g.getChildBoundables().iterator();D.hasNext();){var O=D.next();if(o.getIntersectsOp().intersects(O.getBounds(),d)&&O instanceof Sn&&(I=o.remove(d,O,x),I)){S=O;break}}return S!==null&&S.getChildBoundables().isEmpty()&&g.getChildBoundables().remove(S),I}};zn.prototype.createHigherLevels=function(o,u){Ze.isTrue(!o.isEmpty());var h=this.createParentBoundables(o,u+1);return h.size()===1?h.get(0):this.createHigherLevels(h,u+1)};zn.prototype.depth=function(){var o=this;if(arguments.length===0)return this.isEmpty()?0:(this.build(),this.depth(this._root));if(arguments.length===1){for(var u=arguments[0],h=0,d=u.getChildBoundables().iterator();d.hasNext();){var g=d.next();if(g instanceof Sn){var x=o.depth(g);x>h&&(h=x)}}return h+1}};zn.prototype.createParentBoundables=function(o,u){var h=this;Ze.isTrue(!o.isEmpty());var d=new jt;d.add(this.createNode(u));var g=new jt(o);Io.sort(g,this.getComparator());for(var x=g.iterator();x.hasNext();){var I=x.next();h.lastNode(d).getChildBoundables().size()===h.getNodeCapacity()&&d.add(h.createNode(u)),h.lastNode(d).addChildBoundable(I)}return d};zn.prototype.isEmpty=function(){return this._built?this._root.isEmpty():this._itemBoundables.isEmpty()};zn.prototype.interfaces_=function(){return[co]};zn.prototype.getClass=function(){return zn};zn.compareDoubles=function(o,u){return o>u?1:o<u?-1:0};cm.IntersectsOp.get=function(){return _O};cm.serialVersionUID.get=function(){return-3886435814360241e3};cm.DEFAULT_NODE_CAPACITY.get=function(){return 10};Object.defineProperties(zn,cm);var _O=function(){},Mc=function(){};Mc.prototype.distance=function(o,u){};Mc.prototype.interfaces_=function(){return[]};Mc.prototype.getClass=function(){return Mc};var nI=function(c){function o(h){h=h||o.DEFAULT_NODE_CAPACITY,c.call(this,h)}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={STRtreeNode:{configurable:!0},serialVersionUID:{configurable:!0},xComparator:{configurable:!0},yComparator:{configurable:!0},intersectsOp:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};return o.prototype.createParentBoundablesFromVerticalSlices=function(d,g){var x=this;Ze.isTrue(d.length>0);for(var I=new jt,S=0;S<d.length;S++)I.addAll(x.createParentBoundablesFromVerticalSlice(d[S],g));return I},o.prototype.createNode=function(d){return new xT(d)},o.prototype.size=function(){return arguments.length===0?c.prototype.size.call(this):c.prototype.size.apply(this,arguments)},o.prototype.insert=function(){if(arguments.length===2){var d=arguments[0],g=arguments[1];if(d.isNull())return null;c.prototype.insert.call(this,d,g)}else return c.prototype.insert.apply(this,arguments)},o.prototype.getIntersectsOp=function(){return o.intersectsOp},o.prototype.verticalSlices=function(d,g){for(var x=Math.trunc(Math.ceil(d.size()/g)),I=new Array(g).fill(null),S=d.iterator(),D=0;D<g;D++){I[D]=new jt;for(var O=0;S.hasNext()&&O<x;){var B=S.next();I[D].add(B),O++}}return I},o.prototype.query=function(){if(arguments.length===1){var d=arguments[0];return c.prototype.query.call(this,d)}else if(arguments.length===2){var g=arguments[0],x=arguments[1];c.prototype.query.call(this,g,x)}else if(arguments.length===3){if(Ee(arguments[2],Sa)&&arguments[0]instanceof Object&&arguments[1]instanceof Sn){var I=arguments[0],S=arguments[1],D=arguments[2];c.prototype.query.call(this,I,S,D)}else if(Ee(arguments[2],bo)&&arguments[0]instanceof Object&&arguments[1]instanceof Sn){var O=arguments[0],B=arguments[1],W=arguments[2];c.prototype.query.call(this,O,B,W)}}},o.prototype.getComparator=function(){return o.yComparator},o.prototype.createParentBoundablesFromVerticalSlice=function(d,g){return c.prototype.createParentBoundables.call(this,d,g)},o.prototype.remove=function(){if(arguments.length===2){var d=arguments[0],g=arguments[1];return c.prototype.remove.call(this,d,g)}else return c.prototype.remove.apply(this,arguments)},o.prototype.depth=function(){return arguments.length===0?c.prototype.depth.call(this):c.prototype.depth.apply(this,arguments)},o.prototype.createParentBoundables=function(d,g){Ze.isTrue(!d.isEmpty());var x=Math.trunc(Math.ceil(d.size()/this.getNodeCapacity())),I=new jt(d);Io.sort(I,o.xComparator);var S=this.verticalSlices(I,Math.trunc(Math.ceil(Math.sqrt(x))));return this.createParentBoundablesFromVerticalSlices(S,g)},o.prototype.nearestNeighbour=function(){if(arguments.length===1){if(Ee(arguments[0],Mc)){var d=arguments[0],g=new gn(this.getRoot(),this.getRoot(),d);return this.nearestNeighbour(g)}else if(arguments[0]instanceof gn){var x=arguments[0];return this.nearestNeighbour(x,ke.POSITIVE_INFINITY)}}else if(arguments.length===2){if(arguments[0]instanceof o&&Ee(arguments[1],Mc)){var I=arguments[0],S=arguments[1],D=new gn(this.getRoot(),I.getRoot(),S);return this.nearestNeighbour(D)}else if(arguments[0]instanceof gn&&typeof arguments[1]=="number"){var O=arguments[0],B=arguments[1],W=B,et=null,it=new Ks;for(it.add(O);!it.isEmpty()&&W>0;){var bt=it.poll(),ft=bt.getDistance();if(ft>=W)break;bt.isLeaves()?(W=ft,et=bt):bt.expandToQueue(it,W)}return[et.getBoundable(0).getItem(),et.getBoundable(1).getItem()]}}else if(arguments.length===3){var Pt=arguments[0],kt=arguments[1],Nt=arguments[2],ne=new To(Pt,kt),Te=new gn(this.getRoot(),ne,Nt);return this.nearestNeighbour(Te)[0]}},o.prototype.interfaces_=function(){return[tu,co]},o.prototype.getClass=function(){return o},o.centreX=function(d){return o.avg(d.getMinX(),d.getMaxX())},o.avg=function(d,g){return(d+g)/2},o.centreY=function(d){return o.avg(d.getMinY(),d.getMaxY())},u.STRtreeNode.get=function(){return xT},u.serialVersionUID.get=function(){return 0x39920f7d5f261e0},u.xComparator.get=function(){return{interfaces_:function(){return[yc]},compare:function(h,d){return c.compareDoubles(o.centreX(h.getBounds()),o.centreX(d.getBounds()))}}},u.yComparator.get=function(){return{interfaces_:function(){return[yc]},compare:function(h,d){return c.compareDoubles(o.centreY(h.getBounds()),o.centreY(d.getBounds()))}}},u.intersectsOp.get=function(){return{interfaces_:function(){return[c.IntersectsOp]},intersects:function(h,d){return h.intersects(d)}}},u.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(o,u),o}(zn),xT=function(c){function o(){var u=arguments[0];c.call(this,u)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.computeBounds=function(){for(var h=null,d=this.getChildBoundables().iterator();d.hasNext();){var g=d.next();h===null?h=new le(g.getBounds()):h.expandToInclude(g.getBounds())}return h},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Sn),vi=function(){};vi.prototype.interfaces_=function(){return[]};vi.prototype.getClass=function(){return vi};vi.relativeSign=function(o,u){return o<u?-1:o>u?1:0};vi.compare=function(o,u,h){if(u.equals2D(h))return 0;var d=vi.relativeSign(u.x,h.x),g=vi.relativeSign(u.y,h.y);switch(o){case 0:return vi.compareValue(d,g);case 1:return vi.compareValue(g,d);case 2:return vi.compareValue(g,-d);case 3:return vi.compareValue(-d,g);case 4:return vi.compareValue(-d,-g);case 5:return vi.compareValue(-g,-d);case 6:return vi.compareValue(-g,d);case 7:return vi.compareValue(d,-g)}return Ze.shouldNeverReachHere("invalid octant value"),0};vi.compareValue=function(o,u){return o<0?-1:o>0?1:u<0?-1:u>0?1:0};var Ca=function(){this._segString=null,this.coord=null,this.segmentIndex=null,this._segmentOctant=null,this._isInterior=null;var o=arguments[0],u=arguments[1],h=arguments[2],d=arguments[3];this._segString=o,this.coord=new st(u),this.segmentIndex=h,this._segmentOctant=d,this._isInterior=!u.equals2D(o.getCoordinate(h))};Ca.prototype.getCoordinate=function(){return this.coord};Ca.prototype.print=function(o){o.print(this.coord),o.print(" seg # = "+this.segmentIndex)};Ca.prototype.compareTo=function(o){var u=o;return this.segmentIndex<u.segmentIndex?-1:this.segmentIndex>u.segmentIndex?1:this.coord.equals2D(u.coord)?0:vi.compare(this._segmentOctant,this.coord,u.coord)};Ca.prototype.isEndPoint=function(o){return this.segmentIndex===0&&!this._isInterior||this.segmentIndex===o};Ca.prototype.isInterior=function(){return this._isInterior};Ca.prototype.interfaces_=function(){return[uo]};Ca.prototype.getClass=function(){return Ca};var mi=function(){this._nodeMap=new ii,this._edge=null;var o=arguments[0];this._edge=o};mi.prototype.getSplitCoordinates=function(){var o=this,u=new yp;this.addEndpoints();for(var h=this.iterator(),d=h.next();h.hasNext();){var g=h.next();o.addEdgeCoordinates(d,g,u),d=g}return u.toCoordinateArray()};mi.prototype.addCollapsedNodes=function(){var o=this,u=new jt;this.findCollapsesFromInsertedNodes(u),this.findCollapsesFromExistingVertices(u);for(var h=u.iterator();h.hasNext();){var d=h.next().intValue();o.add(o._edge.getCoordinate(d),d)}};mi.prototype.print=function(o){o.println("Intersections:");for(var u=this.iterator();u.hasNext();){var h=u.next();h.print(o)}};mi.prototype.findCollapsesFromExistingVertices=function(o){for(var u=this,h=0;h<this._edge.size()-2;h++){var d=u._edge.getCoordinate(h),g=u._edge.getCoordinate(h+2);d.equals2D(g)&&o.add(new Ho(h+1))}};mi.prototype.addEdgeCoordinates=function(o,u,h){var d=this,g=this._edge.getCoordinate(u.segmentIndex),x=u.isInterior()||!u.coord.equals2D(g);h.add(new st(o.coord),!1);for(var I=o.segmentIndex+1;I<=u.segmentIndex;I++)h.add(d._edge.getCoordinate(I));x&&h.add(new st(u.coord))};mi.prototype.iterator=function(){return this._nodeMap.values().iterator()};mi.prototype.addSplitEdges=function(o){var u=this;this.addEndpoints(),this.addCollapsedNodes();for(var h=this.iterator(),d=h.next();h.hasNext();){var g=h.next(),x=u.createSplitEdge(d,g);o.add(x),d=g}};mi.prototype.findCollapseIndex=function(o,u,h){if(!o.coord.equals2D(u.coord))return!1;var d=u.segmentIndex-o.segmentIndex;return u.isInterior()||d--,d===1?(h[0]=o.segmentIndex+1,!0):!1};mi.prototype.findCollapsesFromInsertedNodes=function(o){for(var u=this,h=new Array(1).fill(null),d=this.iterator(),g=d.next();d.hasNext();){var x=d.next(),I=u.findCollapseIndex(g,x,h);I&&o.add(new Ho(h[0])),g=x}};mi.prototype.getEdge=function(){return this._edge};mi.prototype.addEndpoints=function(){var o=this._edge.size()-1;this.add(this._edge.getCoordinate(0),0),this.add(this._edge.getCoordinate(o),o)};mi.prototype.createSplitEdge=function(o,u){var h=this,d=u.segmentIndex-o.segmentIndex+2,g=this._edge.getCoordinate(u.segmentIndex),x=u.isInterior()||!u.coord.equals2D(g);x||d--;var I=new Array(d).fill(null),S=0;I[S++]=new st(o.coord);for(var D=o.segmentIndex+1;D<=u.segmentIndex;D++)I[S++]=h._edge.getCoordinate(D);return x&&(I[S]=new st(u.coord)),new cn(I,this._edge.getData())};mi.prototype.add=function(o,u){var h=new Ca(this._edge,o,u,this._edge.getSegmentOctant(u)),d=this._nodeMap.get(h);return d!==null?(Ze.isTrue(d.coord.equals2D(o),"Found equal nodes with different coordinates"),d):(this._nodeMap.put(h,h),h)};mi.prototype.checkSplitEdgesCorrectness=function(o){var u=this._edge.getCoordinates(),h=o.get(0),d=h.getCoordinate(0);if(!d.equals2D(u[0]))throw new Hs("bad split edge start point at "+d);var g=o.get(o.size()-1),x=g.getCoordinates(),I=x[x.length-1];if(!I.equals2D(u[u.length-1]))throw new Hs("bad split edge end point at "+I)};mi.prototype.interfaces_=function(){return[]};mi.prototype.getClass=function(){return mi};var eu=function(){};eu.prototype.interfaces_=function(){return[]};eu.prototype.getClass=function(){return eu};eu.octant=function(){if(typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var o=arguments[0],u=arguments[1];if(o===0&&u===0)throw new Xr("Cannot compute the octant for point ( "+o+", "+u+" )");var h=Math.abs(o),d=Math.abs(u);return o>=0?u>=0?h>=d?0:1:h>=d?7:6:u>=0?h>=d?3:2:h>=d?4:5}else if(arguments[0]instanceof st&&arguments[1]instanceof st){var g=arguments[0],x=arguments[1],I=x.x-g.x,S=x.y-g.y;if(I===0&&S===0)throw new Xr("Cannot compute the octant for two identical points "+g);return eu.octant(I,S)}};var Es=function(){};Es.prototype.getCoordinates=function(){};Es.prototype.size=function(){};Es.prototype.getCoordinate=function(o){};Es.prototype.isClosed=function(){};Es.prototype.setData=function(o){};Es.prototype.getData=function(){};Es.prototype.interfaces_=function(){return[]};Es.prototype.getClass=function(){return Es};var sp=function(){};sp.prototype.addIntersection=function(o,u){};sp.prototype.interfaces_=function(){return[Es]};sp.prototype.getClass=function(){return sp};var cn=function(){this._nodeList=new mi(this),this._pts=null,this._data=null;var o=arguments[0],u=arguments[1];this._pts=o,this._data=u};cn.prototype.getCoordinates=function(){return this._pts};cn.prototype.size=function(){return this._pts.length};cn.prototype.getCoordinate=function(o){return this._pts[o]};cn.prototype.isClosed=function(){return this._pts[0].equals(this._pts[this._pts.length-1])};cn.prototype.getSegmentOctant=function(o){return o===this._pts.length-1?-1:this.safeOctant(this.getCoordinate(o),this.getCoordinate(o+1))};cn.prototype.setData=function(o){this._data=o};cn.prototype.safeOctant=function(o,u){return o.equals2D(u)?0:eu.octant(o,u)};cn.prototype.getData=function(){return this._data};cn.prototype.addIntersection=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1];this.addIntersectionNode(o,u)}else if(arguments.length===4){var h=arguments[0],d=arguments[1],g=arguments[3],x=new st(h.getIntersection(g));this.addIntersection(x,d)}};cn.prototype.toString=function(){return wo.toLineString(new an(this._pts))};cn.prototype.getNodeList=function(){return this._nodeList};cn.prototype.addIntersectionNode=function(o,u){var h=u,d=h+1;if(d<this._pts.length){var g=this._pts[d];o.equals2D(g)&&(h=d)}var x=this._nodeList.add(o,h);return x};cn.prototype.addIntersections=function(o,u,h){for(var d=this,g=0;g<o.getIntersectionNum();g++)d.addIntersection(o,u,h,g)};cn.prototype.interfaces_=function(){return[sp]};cn.prototype.getClass=function(){return cn};cn.getNodedSubstrings=function(){if(arguments.length===1){var o=arguments[0],u=new jt;return cn.getNodedSubstrings(o,u),u}else if(arguments.length===2)for(var h=arguments[0],d=arguments[1],g=h.iterator();g.hasNext();){var x=g.next();x.getNodeList().addSplitEdges(d)}};var he=function(){if(this.p0=null,this.p1=null,arguments.length===0)this.p0=new st,this.p1=new st;else if(arguments.length===1){var o=arguments[0];this.p0=new st(o.p0),this.p1=new st(o.p1)}else if(arguments.length===2)this.p0=arguments[0],this.p1=arguments[1];else if(arguments.length===4){var u=arguments[0],h=arguments[1],d=arguments[2],g=arguments[3];this.p0=new st(u,h),this.p1=new st(d,g)}},iI={serialVersionUID:{configurable:!0}};he.prototype.minX=function(){return Math.min(this.p0.x,this.p1.x)};he.prototype.orientationIndex=function(){if(arguments[0]instanceof he){var o=arguments[0],u=Kt.orientationIndex(this.p0,this.p1,o.p0),h=Kt.orientationIndex(this.p0,this.p1,o.p1);return u>=0&&h>=0||u<=0&&h<=0?Math.max(u,h):0}else if(arguments[0]instanceof st){var d=arguments[0];return Kt.orientationIndex(this.p0,this.p1,d)}};he.prototype.toGeometry=function(o){return o.createLineString([this.p0,this.p1])};he.prototype.isVertical=function(){return this.p0.x===this.p1.x};he.prototype.equals=function(o){if(!(o instanceof he))return!1;var u=o;return this.p0.equals(u.p0)&&this.p1.equals(u.p1)};he.prototype.intersection=function(o){var u=new Ml;return u.computeIntersection(this.p0,this.p1,o.p0,o.p1),u.hasIntersection()?u.getIntersection(0):null};he.prototype.project=function(){if(arguments[0]instanceof st){var o=arguments[0];if(o.equals(this.p0)||o.equals(this.p1))return new st(o);var u=this.projectionFactor(o),h=new st;return h.x=this.p0.x+u*(this.p1.x-this.p0.x),h.y=this.p0.y+u*(this.p1.y-this.p0.y),h}else if(arguments[0]instanceof he){var d=arguments[0],g=this.projectionFactor(d.p0),x=this.projectionFactor(d.p1);if(g>=1&&x>=1||g<=0&&x<=0)return null;var I=this.project(d.p0);g<0&&(I=this.p0),g>1&&(I=this.p1);var S=this.project(d.p1);return x<0&&(S=this.p0),x>1&&(S=this.p1),new he(I,S)}};he.prototype.normalize=function(){this.p1.compareTo(this.p0)<0&&this.reverse()};he.prototype.angle=function(){return Math.atan2(this.p1.y-this.p0.y,this.p1.x-this.p0.x)};he.prototype.getCoordinate=function(o){return o===0?this.p0:this.p1};he.prototype.distancePerpendicular=function(o){return Kt.distancePointLinePerpendicular(o,this.p0,this.p1)};he.prototype.minY=function(){return Math.min(this.p0.y,this.p1.y)};he.prototype.midPoint=function(){return he.midPoint(this.p0,this.p1)};he.prototype.projectionFactor=function(o){if(o.equals(this.p0))return 0;if(o.equals(this.p1))return 1;var u=this.p1.x-this.p0.x,h=this.p1.y-this.p0.y,d=u*u+h*h;if(d<=0)return ke.NaN;var g=((o.x-this.p0.x)*u+(o.y-this.p0.y)*h)/d;return g};he.prototype.closestPoints=function(o){var u=this.intersection(o);if(u!==null)return[u,u];var h=new Array(2).fill(null),d=ke.MAX_VALUE,g=null,x=this.closestPoint(o.p0);d=x.distance(o.p0),h[0]=x,h[1]=o.p0;var I=this.closestPoint(o.p1);g=I.distance(o.p1),g<d&&(d=g,h[0]=I,h[1]=o.p1);var S=o.closestPoint(this.p0);g=S.distance(this.p0),g<d&&(d=g,h[0]=this.p0,h[1]=S);var D=o.closestPoint(this.p1);return g=D.distance(this.p1),g<d&&(d=g,h[0]=this.p1,h[1]=D),h};he.prototype.closestPoint=function(o){var u=this.projectionFactor(o);if(u>0&&u<1)return this.project(o);var h=this.p0.distance(o),d=this.p1.distance(o);return h<d?this.p0:this.p1};he.prototype.maxX=function(){return Math.max(this.p0.x,this.p1.x)};he.prototype.getLength=function(){return this.p0.distance(this.p1)};he.prototype.compareTo=function(o){var u=o,h=this.p0.compareTo(u.p0);return h!==0?h:this.p1.compareTo(u.p1)};he.prototype.reverse=function(){var o=this.p0;this.p0=this.p1,this.p1=o};he.prototype.equalsTopo=function(o){return this.p0.equals(o.p0)&&(this.p1.equals(o.p1)||this.p0.equals(o.p1))&&this.p1.equals(o.p0)};he.prototype.lineIntersection=function(o){try{var u=xo.intersection(this.p0,this.p1,o.p0,o.p1);return u}catch(h){if(!(h instanceof Bc))throw h}finally{}return null};he.prototype.maxY=function(){return Math.max(this.p0.y,this.p1.y)};he.prototype.pointAlongOffset=function(o,u){var h=this.p0.x+o*(this.p1.x-this.p0.x),d=this.p0.y+o*(this.p1.y-this.p0.y),g=this.p1.x-this.p0.x,x=this.p1.y-this.p0.y,I=Math.sqrt(g*g+x*x),S=0,D=0;if(u!==0){if(I<=0)throw new Error("Cannot compute offset from zero-length line segment");S=u*g/I,D=u*x/I}var O=h-D,B=d+S,W=new st(O,B);return W};he.prototype.setCoordinates=function(){if(arguments.length===1){var o=arguments[0];this.setCoordinates(o.p0,o.p1)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];this.p0.x=u.x,this.p0.y=u.y,this.p1.x=h.x,this.p1.y=h.y}};he.prototype.segmentFraction=function(o){var u=this.projectionFactor(o);return u<0?u=0:(u>1||ke.isNaN(u))&&(u=1),u};he.prototype.toString=function(){return"LINESTRING( "+this.p0.x+" "+this.p0.y+", "+this.p1.x+" "+this.p1.y+")"};he.prototype.isHorizontal=function(){return this.p0.y===this.p1.y};he.prototype.distance=function(){if(arguments[0]instanceof he){var o=arguments[0];return Kt.distanceLineLine(this.p0,this.p1,o.p0,o.p1)}else if(arguments[0]instanceof st){var u=arguments[0];return Kt.distancePointLine(u,this.p0,this.p1)}};he.prototype.pointAlong=function(o){var u=new st;return u.x=this.p0.x+o*(this.p1.x-this.p0.x),u.y=this.p0.y+o*(this.p1.y-this.p0.y),u};he.prototype.hashCode=function(){var o=ke.doubleToLongBits(this.p0.x);o^=ke.doubleToLongBits(this.p0.y)*31;var u=Math.trunc(o)^Math.trunc(o>>32),h=ke.doubleToLongBits(this.p1.x);h^=ke.doubleToLongBits(this.p1.y)*31;var d=Math.trunc(h)^Math.trunc(h>>32);return u^d};he.prototype.interfaces_=function(){return[uo,co]};he.prototype.getClass=function(){return he};he.midPoint=function(o,u){return new st((o.x+u.x)/2,(o.y+u.y)/2)};iI.serialVersionUID.get=function(){return 0x2d2172135f411c00};Object.defineProperties(he,iI);var ap=function(){this.tempEnv1=new le,this.tempEnv2=new le,this._overlapSeg1=new he,this._overlapSeg2=new he};ap.prototype.overlap=function(){if(arguments.length!==2){if(arguments.length===4){var o=arguments[0],u=arguments[1],h=arguments[2],d=arguments[3];o.getLineSegment(u,this._overlapSeg1),h.getLineSegment(d,this._overlapSeg2),this.overlap(this._overlapSeg1,this._overlapSeg2)}}};ap.prototype.interfaces_=function(){return[]};ap.prototype.getClass=function(){return ap};var Ai=function(){this._pts=null,this._start=null,this._end=null,this._env=null,this._context=null,this._id=null;var o=arguments[0],u=arguments[1],h=arguments[2],d=arguments[3];this._pts=o,this._start=u,this._end=h,this._context=d};Ai.prototype.getLineSegment=function(o,u){u.p0=this._pts[o],u.p1=this._pts[o+1]};Ai.prototype.computeSelect=function(o,u,h,d){var g=this._pts[u],x=this._pts[h];if(d.tempEnv1.init(g,x),h-u===1)return d.select(this,u),null;if(!o.intersects(d.tempEnv1))return null;var I=Math.trunc((u+h)/2);u<I&&this.computeSelect(o,u,I,d),I<h&&this.computeSelect(o,I,h,d)};Ai.prototype.getCoordinates=function(){for(var o=this,u=new Array(this._end-this._start+1).fill(null),h=0,d=this._start;d<=this._end;d++)u[h++]=o._pts[d];return u};Ai.prototype.computeOverlaps=function(o,u){this.computeOverlapsInternal(this._start,this._end,o,o._start,o._end,u)};Ai.prototype.setId=function(o){this._id=o};Ai.prototype.select=function(o,u){this.computeSelect(o,this._start,this._end,u)};Ai.prototype.getEnvelope=function(){if(this._env===null){var o=this._pts[this._start],u=this._pts[this._end];this._env=new le(o,u)}return this._env};Ai.prototype.getEndIndex=function(){return this._end};Ai.prototype.getStartIndex=function(){return this._start};Ai.prototype.getContext=function(){return this._context};Ai.prototype.getId=function(){return this._id};Ai.prototype.computeOverlapsInternal=function(o,u,h,d,g,x){var I=this._pts[o],S=this._pts[u],D=h._pts[d],O=h._pts[g];if(u-o===1&&g-d===1)return x.overlap(this,o,h,d),null;if(x.tempEnv1.init(I,S),x.tempEnv2.init(D,O),!x.tempEnv1.intersects(x.tempEnv2))return null;var B=Math.trunc((o+u)/2),W=Math.trunc((d+g)/2);o<B&&(d<W&&this.computeOverlapsInternal(o,B,h,d,W,x),W<g&&this.computeOverlapsInternal(o,B,h,W,g,x)),B<u&&(d<W&&this.computeOverlapsInternal(B,u,h,d,W,x),W<g&&this.computeOverlapsInternal(B,u,h,W,g,x))};Ai.prototype.interfaces_=function(){return[]};Ai.prototype.getClass=function(){return Ai};var Wo=function(){};Wo.prototype.interfaces_=function(){return[]};Wo.prototype.getClass=function(){return Wo};Wo.getChainStartIndices=function(o){var u=0,h=new jt;h.add(new Ho(u));do{var d=Wo.findChainEnd(o,u);h.add(new Ho(d)),u=d}while(u<o.length-1);var g=Wo.toIntArray(h);return g};Wo.findChainEnd=function(o,u){for(var h=u;h<o.length-1&&o[h].equals2D(o[h+1]);)h++;if(h>=o.length-1)return o.length-1;for(var d=Er.quadrant(o[h],o[h+1]),g=u+1;g<o.length;){if(!o[g-1].equals2D(o[g])){var x=Er.quadrant(o[g-1],o[g]);if(x!==d)break}g++}return g-1};Wo.getChains=function(){if(arguments.length===1){var o=arguments[0];return Wo.getChains(o,null)}else if(arguments.length===2){for(var u=arguments[0],h=arguments[1],d=new jt,g=Wo.getChainStartIndices(u),x=0;x<g.length-1;x++){var I=new Ai(u,g[x],g[x+1],h);d.add(I)}return d}};Wo.toIntArray=function(o){for(var u=new Array(o.size()).fill(null),h=0;h<u.length;h++)u[h]=o.get(h).intValue();return u};var xl=function(){};xl.prototype.computeNodes=function(o){};xl.prototype.getNodedSubstrings=function(){};xl.prototype.interfaces_=function(){return[]};xl.prototype.getClass=function(){return xl};var lp=function(){if(this._segInt=null,arguments.length!==0){if(arguments.length===1){var o=arguments[0];this.setSegmentIntersector(o)}}};lp.prototype.setSegmentIntersector=function(o){this._segInt=o};lp.prototype.interfaces_=function(){return[xl]};lp.prototype.getClass=function(){return lp};var yv=function(c){function o(h){h?c.call(this,h):c.call(this),this._monoChains=new jt,this._index=new nI,this._idCounter=0,this._nodedSegStrings=null,this._nOverlaps=0}c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o;var u={SegmentOverlapAction:{configurable:!0}};return o.prototype.getMonotoneChains=function(){return this._monoChains},o.prototype.getNodedSubstrings=function(){return cn.getNodedSubstrings(this._nodedSegStrings)},o.prototype.getIndex=function(){return this._index},o.prototype.add=function(d){for(var g=this,x=Wo.getChains(d.getCoordinates(),d),I=x.iterator();I.hasNext();){var S=I.next();S.setId(g._idCounter++),g._index.insert(S.getEnvelope(),S),g._monoChains.add(S)}},o.prototype.computeNodes=function(d){var g=this;this._nodedSegStrings=d;for(var x=d.iterator();x.hasNext();)g.add(x.next());this.intersectChains()},o.prototype.intersectChains=function(){for(var d=this,g=new bT(this._segInt),x=this._monoChains.iterator();x.hasNext();)for(var I=x.next(),S=d._index.query(I.getEnvelope()),D=S.iterator();D.hasNext();){var O=D.next();if(O.getId()>I.getId()&&(I.computeOverlaps(O,g),d._nOverlaps++),d._segInt.isDone())return null}},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},u.SegmentOverlapAction.get=function(){return bT},Object.defineProperties(o,u),o}(lp),bT=function(c){function o(){c.call(this),this._si=null;var u=arguments[0];this._si=u}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.overlap=function(){if(arguments.length===4){var h=arguments[0],d=arguments[1],g=arguments[2],x=arguments[3],I=h.getContext(),S=g.getContext();this._si.processIntersections(I,d,S,x)}else return c.prototype.overlap.apply(this,arguments)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(ap),pr=function c(){if(this._quadrantSegments=c.DEFAULT_QUADRANT_SEGMENTS,this._endCapStyle=c.CAP_ROUND,this._joinStyle=c.JOIN_ROUND,this._mitreLimit=c.DEFAULT_MITRE_LIMIT,this._isSingleSided=!1,this._simplifyFactor=c.DEFAULT_SIMPLIFY_FACTOR,arguments.length!==0){if(arguments.length===1){var o=arguments[0];this.setQuadrantSegments(o)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];this.setQuadrantSegments(u),this.setEndCapStyle(h)}else if(arguments.length===4){var d=arguments[0],g=arguments[1],x=arguments[2],I=arguments[3];this.setQuadrantSegments(d),this.setEndCapStyle(g),this.setJoinStyle(x),this.setMitreLimit(I)}}},ea={CAP_ROUND:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},JOIN_ROUND:{configurable:!0},JOIN_MITRE:{configurable:!0},JOIN_BEVEL:{configurable:!0},DEFAULT_QUADRANT_SEGMENTS:{configurable:!0},DEFAULT_MITRE_LIMIT:{configurable:!0},DEFAULT_SIMPLIFY_FACTOR:{configurable:!0}};pr.prototype.getEndCapStyle=function(){return this._endCapStyle};pr.prototype.isSingleSided=function(){return this._isSingleSided};pr.prototype.setQuadrantSegments=function(o){this._quadrantSegments=o,this._quadrantSegments===0&&(this._joinStyle=pr.JOIN_BEVEL),this._quadrantSegments<0&&(this._joinStyle=pr.JOIN_MITRE,this._mitreLimit=Math.abs(this._quadrantSegments)),o<=0&&(this._quadrantSegments=1),this._joinStyle!==pr.JOIN_ROUND&&(this._quadrantSegments=pr.DEFAULT_QUADRANT_SEGMENTS)};pr.prototype.getJoinStyle=function(){return this._joinStyle};pr.prototype.setJoinStyle=function(o){this._joinStyle=o};pr.prototype.setSimplifyFactor=function(o){this._simplifyFactor=o<0?0:o};pr.prototype.getSimplifyFactor=function(){return this._simplifyFactor};pr.prototype.getQuadrantSegments=function(){return this._quadrantSegments};pr.prototype.setEndCapStyle=function(o){this._endCapStyle=o};pr.prototype.getMitreLimit=function(){return this._mitreLimit};pr.prototype.setMitreLimit=function(o){this._mitreLimit=o};pr.prototype.setSingleSided=function(o){this._isSingleSided=o};pr.prototype.interfaces_=function(){return[]};pr.prototype.getClass=function(){return pr};pr.bufferDistanceError=function(o){var u=Math.PI/2/o;return 1-Math.cos(u/2)};ea.CAP_ROUND.get=function(){return 1};ea.CAP_FLAT.get=function(){return 2};ea.CAP_SQUARE.get=function(){return 3};ea.JOIN_ROUND.get=function(){return 1};ea.JOIN_MITRE.get=function(){return 2};ea.JOIN_BEVEL.get=function(){return 3};ea.DEFAULT_QUADRANT_SEGMENTS.get=function(){return 8};ea.DEFAULT_MITRE_LIMIT.get=function(){return 5};ea.DEFAULT_SIMPLIFY_FACTOR.get=function(){return .01};Object.defineProperties(pr,ea);var on=function(o){this._distanceTol=null,this._isDeleted=null,this._angleOrientation=Kt.COUNTERCLOCKWISE,this._inputLine=o||null},bp={INIT:{configurable:!0},DELETE:{configurable:!0},KEEP:{configurable:!0},NUM_PTS_TO_CHECK:{configurable:!0}};on.prototype.isDeletable=function(o,u,h,d){var g=this._inputLine[o],x=this._inputLine[u],I=this._inputLine[h];return!this.isConcave(g,x,I)||!this.isShallow(g,x,I,d)?!1:this.isShallowSampled(g,x,o,h,d)};on.prototype.deleteShallowConcavities=function(){for(var o=this,u=1,h=this.findNextNonDeletedIndex(u),d=this.findNextNonDeletedIndex(h),g=!1;d<this._inputLine.length;){var x=!1;o.isDeletable(u,h,d,o._distanceTol)&&(o._isDeleted[h]=on.DELETE,x=!0,g=!0),x?u=d:u=h,h=o.findNextNonDeletedIndex(u),d=o.findNextNonDeletedIndex(h)}return g};on.prototype.isShallowConcavity=function(o,u,h,d){var g=Kt.computeOrientation(o,u,h),x=g===this._angleOrientation;if(!x)return!1;var I=Kt.distancePointLine(u,o,h);return I<d};on.prototype.isShallowSampled=function(o,u,h,d,g){var x=this,I=Math.trunc((d-h)/on.NUM_PTS_TO_CHECK);I<=0&&(I=1);for(var S=h;S<d;S+=I)if(!x.isShallow(o,u,x._inputLine[S],g))return!1;return!0};on.prototype.isConcave=function(o,u,h){var d=Kt.computeOrientation(o,u,h),g=d===this._angleOrientation;return g};on.prototype.simplify=function(o){var u=this;this._distanceTol=Math.abs(o),o<0&&(this._angleOrientation=Kt.CLOCKWISE),this._isDeleted=new Array(this._inputLine.length).fill(null);var h=!1;do h=u.deleteShallowConcavities();while(h);return this.collapseLine()};on.prototype.findNextNonDeletedIndex=function(o){for(var u=o+1;u<this._inputLine.length&&this._isDeleted[u]===on.DELETE;)u++;return u};on.prototype.isShallow=function(o,u,h,d){var g=Kt.distancePointLine(u,o,h);return g<d};on.prototype.collapseLine=function(){for(var o=this,u=new yp,h=0;h<this._inputLine.length;h++)o._isDeleted[h]!==on.DELETE&&u.add(o._inputLine[h]);return u.toCoordinateArray()};on.prototype.interfaces_=function(){return[]};on.prototype.getClass=function(){return on};on.simplify=function(o,u){var h=new on(o);return h.simplify(u)};bp.INIT.get=function(){return 0};bp.DELETE.get=function(){return 1};bp.KEEP.get=function(){return 1};bp.NUM_PTS_TO_CHECK.get=function(){return 10};Object.defineProperties(on,bp);var Gi=function(){this._ptList=null,this._precisionModel=null,this._minimimVertexDistance=0,this._ptList=new jt},oI={COORDINATE_ARRAY_TYPE:{configurable:!0}};Gi.prototype.getCoordinates=function(){var o=this._ptList.toArray(Gi.COORDINATE_ARRAY_TYPE);return o};Gi.prototype.setPrecisionModel=function(o){this._precisionModel=o};Gi.prototype.addPt=function(o){var u=new st(o);if(this._precisionModel.makePrecise(u),this.isRedundant(u))return null;this._ptList.add(u)};Gi.prototype.revere=function(){};Gi.prototype.addPts=function(o,u){var h=this;if(u)for(var d=0;d<o.length;d++)h.addPt(o[d]);else for(var g=o.length-1;g>=0;g--)h.addPt(o[g])};Gi.prototype.isRedundant=function(o){if(this._ptList.size()<1)return!1;var u=this._ptList.get(this._ptList.size()-1),h=o.distance(u);return h<this._minimimVertexDistance};Gi.prototype.toString=function(){var o=new He,u=o.createLineString(this.getCoordinates());return u.toString()};Gi.prototype.closeRing=function(){if(this._ptList.size()<1)return null;var o=new st(this._ptList.get(0)),u=this._ptList.get(this._ptList.size()-1);if(o.equals(u))return null;this._ptList.add(o)};Gi.prototype.setMinimumVertexDistance=function(o){this._minimimVertexDistance=o};Gi.prototype.interfaces_=function(){return[]};Gi.prototype.getClass=function(){return Gi};oI.COORDINATE_ARRAY_TYPE.get=function(){return new Array(0).fill(null)};Object.defineProperties(Gi,oI);var Qe=function(){},mu={PI_TIMES_2:{configurable:!0},PI_OVER_2:{configurable:!0},PI_OVER_4:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},CLOCKWISE:{configurable:!0},NONE:{configurable:!0}};Qe.prototype.interfaces_=function(){return[]};Qe.prototype.getClass=function(){return Qe};Qe.toDegrees=function(o){return o*180/Math.PI};Qe.normalize=function(o){for(;o>Math.PI;)o-=Qe.PI_TIMES_2;for(;o<=-Math.PI;)o+=Qe.PI_TIMES_2;return o};Qe.angle=function(){if(arguments.length===1){var o=arguments[0];return Math.atan2(o.y,o.x)}else if(arguments.length===2){var u=arguments[0],h=arguments[1],d=h.x-u.x,g=h.y-u.y;return Math.atan2(g,d)}};Qe.isAcute=function(o,u,h){var d=o.x-u.x,g=o.y-u.y,x=h.x-u.x,I=h.y-u.y,S=d*x+g*I;return S>0};Qe.isObtuse=function(o,u,h){var d=o.x-u.x,g=o.y-u.y,x=h.x-u.x,I=h.y-u.y,S=d*x+g*I;return S<0};Qe.interiorAngle=function(o,u,h){var d=Qe.angle(u,o),g=Qe.angle(u,h);return Math.abs(g-d)};Qe.normalizePositive=function(o){if(o<0){for(;o<0;)o+=Qe.PI_TIMES_2;o>=Qe.PI_TIMES_2&&(o=0)}else{for(;o>=Qe.PI_TIMES_2;)o-=Qe.PI_TIMES_2;o<0&&(o=0)}return o};Qe.angleBetween=function(o,u,h){var d=Qe.angle(u,o),g=Qe.angle(u,h);return Qe.diff(d,g)};Qe.diff=function(o,u){var h=null;return o<u?h=u-o:h=o-u,h>Math.PI&&(h=2*Math.PI-h),h};Qe.toRadians=function(o){return o*Math.PI/180};Qe.getTurn=function(o,u){var h=Math.sin(u-o);return h>0?Qe.COUNTERCLOCKWISE:h<0?Qe.CLOCKWISE:Qe.NONE};Qe.angleBetweenOriented=function(o,u,h){var d=Qe.angle(u,o),g=Qe.angle(u,h),x=g-d;return x<=-Math.PI?x+Qe.PI_TIMES_2:x>Math.PI?x-Qe.PI_TIMES_2:x};mu.PI_TIMES_2.get=function(){return 2*Math.PI};mu.PI_OVER_2.get=function(){return Math.PI/2};mu.PI_OVER_4.get=function(){return Math.PI/4};mu.COUNTERCLOCKWISE.get=function(){return Kt.COUNTERCLOCKWISE};mu.CLOCKWISE.get=function(){return Kt.CLOCKWISE};mu.NONE.get=function(){return Kt.COLLINEAR};Object.defineProperties(Qe,mu);var Vr=function c(){this._maxCurveSegmentError=0,this._filletAngleQuantum=null,this._closingSegLengthFactor=1,this._segList=null,this._distance=0,this._precisionModel=null,this._bufParams=null,this._li=null,this._s0=null,this._s1=null,this._s2=null,this._seg0=new he,this._seg1=new he,this._offset0=new he,this._offset1=new he,this._side=0,this._hasNarrowConcaveAngle=!1;var o=arguments[0],u=arguments[1],h=arguments[2];this._precisionModel=o,this._bufParams=u,this._li=new Ml,this._filletAngleQuantum=Math.PI/2/u.getQuadrantSegments(),u.getQuadrantSegments()>=8&&u.getJoinStyle()===pr.JOIN_ROUND&&(this._closingSegLengthFactor=c.MAX_CLOSING_SEG_LEN_FACTOR),this.init(h)},wp={OFFSET_SEGMENT_SEPARATION_FACTOR:{configurable:!0},INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},CURVE_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},MAX_CLOSING_SEG_LEN_FACTOR:{configurable:!0}};Vr.prototype.addNextSegment=function(o,u){if(this._s0=this._s1,this._s1=this._s2,this._s2=o,this._seg0.setCoordinates(this._s0,this._s1),this.computeOffsetSegment(this._seg0,this._side,this._distance,this._offset0),this._seg1.setCoordinates(this._s1,this._s2),this.computeOffsetSegment(this._seg1,this._side,this._distance,this._offset1),this._s1.equals(this._s2))return null;var h=Kt.computeOrientation(this._s0,this._s1,this._s2),d=h===Kt.CLOCKWISE&&this._side===zt.LEFT||h===Kt.COUNTERCLOCKWISE&&this._side===zt.RIGHT;h===0?this.addCollinear(u):d?this.addOutsideTurn(h,u):this.addInsideTurn(h,u)};Vr.prototype.addLineEndCap=function(o,u){var h=new he(o,u),d=new he;this.computeOffsetSegment(h,zt.LEFT,this._distance,d);var g=new he;this.computeOffsetSegment(h,zt.RIGHT,this._distance,g);var x=u.x-o.x,I=u.y-o.y,S=Math.atan2(I,x);switch(this._bufParams.getEndCapStyle()){case pr.CAP_ROUND:this._segList.addPt(d.p1),this.addFilletArc(u,S+Math.PI/2,S-Math.PI/2,Kt.CLOCKWISE,this._distance),this._segList.addPt(g.p1);break;case pr.CAP_FLAT:this._segList.addPt(d.p1),this._segList.addPt(g.p1);break;case pr.CAP_SQUARE:var D=new st;D.x=Math.abs(this._distance)*Math.cos(S),D.y=Math.abs(this._distance)*Math.sin(S);var O=new st(d.p1.x+D.x,d.p1.y+D.y),B=new st(g.p1.x+D.x,g.p1.y+D.y);this._segList.addPt(O),this._segList.addPt(B);break}};Vr.prototype.getCoordinates=function(){var o=this._segList.getCoordinates();return o};Vr.prototype.addMitreJoin=function(o,u,h,d){var g=!0,x=null;try{x=xo.intersection(u.p0,u.p1,h.p0,h.p1);var I=d<=0?1:x.distance(o)/Math.abs(d);I>this._bufParams.getMitreLimit()&&(g=!1)}catch(S){if(S instanceof Bc)x=new st(0,0),g=!1;else throw S}finally{}g?this._segList.addPt(x):this.addLimitedMitreJoin(u,h,d,this._bufParams.getMitreLimit())};Vr.prototype.addFilletCorner=function(o,u,h,d,g){var x=u.x-o.x,I=u.y-o.y,S=Math.atan2(I,x),D=h.x-o.x,O=h.y-o.y,B=Math.atan2(O,D);d===Kt.CLOCKWISE?S<=B&&(S+=2*Math.PI):S>=B&&(S-=2*Math.PI),this._segList.addPt(u),this.addFilletArc(o,S,B,d,g),this._segList.addPt(h)};Vr.prototype.addOutsideTurn=function(o,u){if(this._offset0.p1.distance(this._offset1.p0)<this._distance*Vr.OFFSET_SEGMENT_SEPARATION_FACTOR)return this._segList.addPt(this._offset0.p1),null;this._bufParams.getJoinStyle()===pr.JOIN_MITRE?this.addMitreJoin(this._s1,this._offset0,this._offset1,this._distance):this._bufParams.getJoinStyle()===pr.JOIN_BEVEL?this.addBevelJoin(this._offset0,this._offset1):(u&&this._segList.addPt(this._offset0.p1),this.addFilletCorner(this._s1,this._offset0.p1,this._offset1.p0,o,this._distance),this._segList.addPt(this._offset1.p0))};Vr.prototype.createSquare=function(o){this._segList.addPt(new st(o.x+this._distance,o.y+this._distance)),this._segList.addPt(new st(o.x+this._distance,o.y-this._distance)),this._segList.addPt(new st(o.x-this._distance,o.y-this._distance)),this._segList.addPt(new st(o.x-this._distance,o.y+this._distance)),this._segList.closeRing()};Vr.prototype.addSegments=function(o,u){this._segList.addPts(o,u)};Vr.prototype.addFirstSegment=function(){this._segList.addPt(this._offset1.p0)};Vr.prototype.addLastSegment=function(){this._segList.addPt(this._offset1.p1)};Vr.prototype.initSideSegments=function(o,u,h){this._s1=o,this._s2=u,this._side=h,this._seg1.setCoordinates(o,u),this.computeOffsetSegment(this._seg1,h,this._distance,this._offset1)};Vr.prototype.addLimitedMitreJoin=function(o,u,h,d){var g=this._seg0.p1,x=Qe.angle(g,this._seg0.p0),I=Qe.angleBetweenOriented(this._seg0.p0,g,this._seg1.p1),S=I/2,D=Qe.normalize(x+S),O=Qe.normalize(D+Math.PI),B=d*h,W=B*Math.abs(Math.sin(S)),et=h-W,it=g.x+B*Math.cos(O),bt=g.y+B*Math.sin(O),ft=new st(it,bt),Pt=new he(g,ft),kt=Pt.pointAlongOffset(1,et),Nt=Pt.pointAlongOffset(1,-et);this._side===zt.LEFT?(this._segList.addPt(kt),this._segList.addPt(Nt)):(this._segList.addPt(Nt),this._segList.addPt(kt))};Vr.prototype.computeOffsetSegment=function(o,u,h,d){var g=u===zt.LEFT?1:-1,x=o.p1.x-o.p0.x,I=o.p1.y-o.p0.y,S=Math.sqrt(x*x+I*I),D=g*h*x/S,O=g*h*I/S;d.p0.x=o.p0.x-O,d.p0.y=o.p0.y+D,d.p1.x=o.p1.x-O,d.p1.y=o.p1.y+D};Vr.prototype.addFilletArc=function(o,u,h,d,g){var x=this,I=d===Kt.CLOCKWISE?-1:1,S=Math.abs(u-h),D=Math.trunc(S/this._filletAngleQuantum+.5);if(D<1)return null;for(var O=0,B=S/D,W=O,et=new st;W<S;){var it=u+I*W;et.x=o.x+g*Math.cos(it),et.y=o.y+g*Math.sin(it),x._segList.addPt(et),W+=B}};Vr.prototype.addInsideTurn=function(o,u){if(this._li.computeIntersection(this._offset0.p0,this._offset0.p1,this._offset1.p0,this._offset1.p1),this._li.hasIntersection())this._segList.addPt(this._li.getIntersection(0));else if(this._hasNarrowConcaveAngle=!0,this._offset0.p1.distance(this._offset1.p0)<this._distance*Vr.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR)this._segList.addPt(this._offset0.p1);else{if(this._segList.addPt(this._offset0.p1),this._closingSegLengthFactor>0){var h=new st((this._closingSegLengthFactor*this._offset0.p1.x+this._s1.x)/(this._closingSegLengthFactor+1),(this._closingSegLengthFactor*this._offset0.p1.y+this._s1.y)/(this._closingSegLengthFactor+1));this._segList.addPt(h);var d=new st((this._closingSegLengthFactor*this._offset1.p0.x+this._s1.x)/(this._closingSegLengthFactor+1),(this._closingSegLengthFactor*this._offset1.p0.y+this._s1.y)/(this._closingSegLengthFactor+1));this._segList.addPt(d)}else this._segList.addPt(this._s1);this._segList.addPt(this._offset1.p0)}};Vr.prototype.createCircle=function(o){var u=new st(o.x+this._distance,o.y);this._segList.addPt(u),this.addFilletArc(o,0,2*Math.PI,-1,this._distance),this._segList.closeRing()};Vr.prototype.addBevelJoin=function(o,u){this._segList.addPt(o.p1),this._segList.addPt(u.p0)};Vr.prototype.init=function(o){this._distance=o,this._maxCurveSegmentError=o*(1-Math.cos(this._filletAngleQuantum/2)),this._segList=new Gi,this._segList.setPrecisionModel(this._precisionModel),this._segList.setMinimumVertexDistance(o*Vr.CURVE_VERTEX_SNAP_DISTANCE_FACTOR)};Vr.prototype.addCollinear=function(o){this._li.computeIntersection(this._s0,this._s1,this._s1,this._s2);var u=this._li.getIntersectionNum();u>=2&&(this._bufParams.getJoinStyle()===pr.JOIN_BEVEL||this._bufParams.getJoinStyle()===pr.JOIN_MITRE?(o&&this._segList.addPt(this._offset0.p1),this._segList.addPt(this._offset1.p0)):this.addFilletCorner(this._s1,this._offset0.p1,this._offset1.p0,Kt.CLOCKWISE,this._distance))};Vr.prototype.closeRing=function(){this._segList.closeRing()};Vr.prototype.hasNarrowConcaveAngle=function(){return this._hasNarrowConcaveAngle};Vr.prototype.interfaces_=function(){return[]};Vr.prototype.getClass=function(){return Vr};wp.OFFSET_SEGMENT_SEPARATION_FACTOR.get=function(){return .001};wp.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return .001};wp.CURVE_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return 1e-6};wp.MAX_CLOSING_SEG_LEN_FACTOR.get=function(){return 80};Object.defineProperties(Vr,wp);var bi=function(){this._distance=0,this._precisionModel=null,this._bufParams=null;var o=arguments[0],u=arguments[1];this._precisionModel=o,this._bufParams=u};bi.prototype.getOffsetCurve=function(o,u){if(this._distance=u,u===0)return null;var h=u<0,d=Math.abs(u),g=this.getSegGen(d);o.length<=1?this.computePointCurve(o[0],g):this.computeOffsetCurve(o,h,g);var x=g.getCoordinates();return h&&Ye.reverse(x),x};bi.prototype.computeSingleSidedBufferCurve=function(o,u,h){var d=this.simplifyTolerance(this._distance);if(u){h.addSegments(o,!0);var g=on.simplify(o,-d),x=g.length-1;h.initSideSegments(g[x],g[x-1],zt.LEFT),h.addFirstSegment();for(var I=x-2;I>=0;I--)h.addNextSegment(g[I],!0)}else{h.addSegments(o,!1);var S=on.simplify(o,d),D=S.length-1;h.initSideSegments(S[0],S[1],zt.LEFT),h.addFirstSegment();for(var O=2;O<=D;O++)h.addNextSegment(S[O],!0)}h.addLastSegment(),h.closeRing()};bi.prototype.computeRingBufferCurve=function(o,u,h){var d=this.simplifyTolerance(this._distance);u===zt.RIGHT&&(d=-d);var g=on.simplify(o,d),x=g.length-1;h.initSideSegments(g[x-1],g[0],u);for(var I=1;I<=x;I++){var S=I!==1;h.addNextSegment(g[I],S)}h.closeRing()};bi.prototype.computeLineBufferCurve=function(o,u){var h=this.simplifyTolerance(this._distance),d=on.simplify(o,h),g=d.length-1;u.initSideSegments(d[0],d[1],zt.LEFT);for(var x=2;x<=g;x++)u.addNextSegment(d[x],!0);u.addLastSegment(),u.addLineEndCap(d[g-1],d[g]);var I=on.simplify(o,-h),S=I.length-1;u.initSideSegments(I[S],I[S-1],zt.LEFT);for(var D=S-2;D>=0;D--)u.addNextSegment(I[D],!0);u.addLastSegment(),u.addLineEndCap(I[1],I[0]),u.closeRing()};bi.prototype.computePointCurve=function(o,u){switch(this._bufParams.getEndCapStyle()){case pr.CAP_ROUND:u.createCircle(o);break;case pr.CAP_SQUARE:u.createSquare(o);break}};bi.prototype.getLineCurve=function(o,u){if(this._distance=u,u<0&&!this._bufParams.isSingleSided()||u===0)return null;var h=Math.abs(u),d=this.getSegGen(h);if(o.length<=1)this.computePointCurve(o[0],d);else if(this._bufParams.isSingleSided()){var g=u<0;this.computeSingleSidedBufferCurve(o,g,d)}else this.computeLineBufferCurve(o,d);var x=d.getCoordinates();return x};bi.prototype.getBufferParameters=function(){return this._bufParams};bi.prototype.simplifyTolerance=function(o){return o*this._bufParams.getSimplifyFactor()};bi.prototype.getRingCurve=function(o,u,h){if(this._distance=h,o.length<=2)return this.getLineCurve(o,h);if(h===0)return bi.copyCoordinates(o);var d=this.getSegGen(h);return this.computeRingBufferCurve(o,u,d),d.getCoordinates()};bi.prototype.computeOffsetCurve=function(o,u,h){var d=this.simplifyTolerance(this._distance);if(u){var g=on.simplify(o,-d),x=g.length-1;h.initSideSegments(g[x],g[x-1],zt.LEFT),h.addFirstSegment();for(var I=x-2;I>=0;I--)h.addNextSegment(g[I],!0)}else{var S=on.simplify(o,d),D=S.length-1;h.initSideSegments(S[0],S[1],zt.LEFT),h.addFirstSegment();for(var O=2;O<=D;O++)h.addNextSegment(S[O],!0)}h.addLastSegment()};bi.prototype.getSegGen=function(o){return new Vr(this._precisionModel,this._bufParams,o)};bi.prototype.interfaces_=function(){return[]};bi.prototype.getClass=function(){return bi};bi.copyCoordinates=function(o){for(var u=new Array(o.length).fill(null),h=0;h<u.length;h++)u[h]=new st(o[h]);return u};var ru=function(){this._subgraphs=null,this._seg=new he,this._cga=new Kt;var o=arguments[0];this._subgraphs=o},sI={DepthSegment:{configurable:!0}};ru.prototype.findStabbedSegments=function(){var o=this;if(arguments.length===1){for(var u=arguments[0],h=new jt,d=this._subgraphs.iterator();d.hasNext();){var g=d.next(),x=g.getEnvelope();u.y<x.getMinY()||u.y>x.getMaxY()||o.findStabbedSegments(u,g.getDirectedEdges(),h)}return h}else if(arguments.length===3){if(Ee(arguments[2],bo)&&arguments[0]instanceof st&&arguments[1]instanceof Qy)for(var I=arguments[0],S=arguments[1],D=arguments[2],O=S.getEdge().getCoordinates(),B=0;B<O.length-1;B++){o._seg.p0=O[B],o._seg.p1=O[B+1],o._seg.p0.y>o._seg.p1.y&&o._seg.reverse();var W=Math.max(o._seg.p0.x,o._seg.p1.x);if(!(W<I.x)&&!o._seg.isHorizontal()&&!(I.y<o._seg.p0.y||I.y>o._seg.p1.y)&&Kt.computeOrientation(o._seg.p0,o._seg.p1,I)!==Kt.RIGHT){var et=S.getDepth(zt.LEFT);o._seg.p0.equals(O[B])||(et=S.getDepth(zt.RIGHT));var it=new bl(o._seg,et);D.add(it)}}else if(Ee(arguments[2],bo)&&arguments[0]instanceof st&&Ee(arguments[1],bo))for(var bt=arguments[0],ft=arguments[1],Pt=arguments[2],kt=ft.iterator();kt.hasNext();){var Nt=kt.next();Nt.isForward()&&o.findStabbedSegments(bt,Nt,Pt)}}};ru.prototype.getDepth=function(o){var u=this.findStabbedSegments(o);if(u.size()===0)return 0;var h=Io.min(u);return h._leftDepth};ru.prototype.interfaces_=function(){return[]};ru.prototype.getClass=function(){return ru};sI.DepthSegment.get=function(){return bl};Object.defineProperties(ru,sI);var bl=function(){this._upwardSeg=null,this._leftDepth=null;var o=arguments[0],u=arguments[1];this._upwardSeg=new he(o),this._leftDepth=u};bl.prototype.compareTo=function(o){var u=o;if(this._upwardSeg.minX()>=u._upwardSeg.maxX())return 1;if(this._upwardSeg.maxX()<=u._upwardSeg.minX())return-1;var h=this._upwardSeg.orientationIndex(u._upwardSeg);return h!==0||(h=-1*u._upwardSeg.orientationIndex(this._upwardSeg),h!==0)?h:this._upwardSeg.compareTo(u._upwardSeg)};bl.prototype.compareX=function(o,u){var h=o.p0.compareTo(u.p0);return h!==0?h:o.p1.compareTo(u.p1)};bl.prototype.toString=function(){return this._upwardSeg.toString()};bl.prototype.interfaces_=function(){return[uo]};bl.prototype.getClass=function(){return bl};var dr=function(o,u,h){this.p0=o||null,this.p1=u||null,this.p2=h||null};dr.prototype.area=function(){return dr.area(this.p0,this.p1,this.p2)};dr.prototype.signedArea=function(){return dr.signedArea(this.p0,this.p1,this.p2)};dr.prototype.interpolateZ=function(o){if(o===null)throw new Xr("Supplied point is null.");return dr.interpolateZ(o,this.p0,this.p1,this.p2)};dr.prototype.longestSideLength=function(){return dr.longestSideLength(this.p0,this.p1,this.p2)};dr.prototype.isAcute=function(){return dr.isAcute(this.p0,this.p1,this.p2)};dr.prototype.circumcentre=function(){return dr.circumcentre(this.p0,this.p1,this.p2)};dr.prototype.area3D=function(){return dr.area3D(this.p0,this.p1,this.p2)};dr.prototype.centroid=function(){return dr.centroid(this.p0,this.p1,this.p2)};dr.prototype.inCentre=function(){return dr.inCentre(this.p0,this.p1,this.p2)};dr.prototype.interfaces_=function(){return[]};dr.prototype.getClass=function(){return dr};dr.area=function(o,u,h){return Math.abs(((h.x-o.x)*(u.y-o.y)-(u.x-o.x)*(h.y-o.y))/2)};dr.signedArea=function(o,u,h){return((h.x-o.x)*(u.y-o.y)-(u.x-o.x)*(h.y-o.y))/2};dr.det=function(o,u,h,d){return o*d-u*h};dr.interpolateZ=function(o,u,h,d){var g=u.x,x=u.y,I=h.x-g,S=d.x-g,D=h.y-x,O=d.y-x,B=I*O-S*D,W=o.x-g,et=o.y-x,it=(O*W-S*et)/B,bt=(-D*W+I*et)/B,ft=u.z+it*(h.z-u.z)+bt*(d.z-u.z);return ft};dr.longestSideLength=function(o,u,h){var d=o.distance(u),g=u.distance(h),x=h.distance(o),I=d;return g>I&&(I=g),x>I&&(I=x),I};dr.isAcute=function(o,u,h){return!(!Qe.isAcute(o,u,h)||!Qe.isAcute(u,h,o)||!Qe.isAcute(h,o,u))};dr.circumcentre=function(o,u,h){var d=h.x,g=h.y,x=o.x-d,I=o.y-g,S=u.x-d,D=u.y-g,O=2*dr.det(x,I,S,D),B=dr.det(I,x*x+I*I,D,S*S+D*D),W=dr.det(x,x*x+I*I,S,S*S+D*D),et=d-B/O,it=g+W/O;return new st(et,it)};dr.perpendicularBisector=function(o,u){var h=u.x-o.x,d=u.y-o.y,g=new xo(o.x+h/2,o.y+d/2,1),x=new xo(o.x-d+h/2,o.y+h+d/2,1);return new xo(g,x)};dr.angleBisector=function(o,u,h){var d=u.distance(o),g=u.distance(h),x=d/(d+g),I=h.x-o.x,S=h.y-o.y,D=new st(o.x+x*I,o.y+x*S);return D};dr.area3D=function(o,u,h){var d=u.x-o.x,g=u.y-o.y,x=u.z-o.z,I=h.x-o.x,S=h.y-o.y,D=h.z-o.z,O=g*D-x*S,B=x*I-d*D,W=d*S-g*I,et=O*O+B*B+W*W,it=Math.sqrt(et)/2;return it};dr.centroid=function(o,u,h){var d=(o.x+u.x+h.x)/3,g=(o.y+u.y+h.y)/3;return new st(d,g)};dr.inCentre=function(o,u,h){var d=u.distance(h),g=o.distance(h),x=o.distance(u),I=d+g+x,S=(d*o.x+g*u.x+x*h.x)/I,D=(d*o.y+g*u.y+x*h.y)/I;return new st(S,D)};var lo=function(){this._inputGeom=null,this._distance=null,this._curveBuilder=null,this._curveList=new jt;var o=arguments[0],u=arguments[1],h=arguments[2];this._inputGeom=o,this._distance=u,this._curveBuilder=h};lo.prototype.addPoint=function(o){if(this._distance<=0)return null;var u=o.getCoordinates(),h=this._curveBuilder.getLineCurve(u,this._distance);this.addCurve(h,ut.EXTERIOR,ut.INTERIOR)};lo.prototype.addPolygon=function(o){var u=this,h=this._distance,d=zt.LEFT;this._distance<0&&(h=-this._distance,d=zt.RIGHT);var g=o.getExteriorRing(),x=Ye.removeRepeatedPoints(g.getCoordinates());if(this._distance<0&&this.isErodedCompletely(g,this._distance)||this._distance<=0&&x.length<3)return null;this.addPolygonRing(x,h,d,ut.EXTERIOR,ut.INTERIOR);for(var I=0;I<o.getNumInteriorRing();I++){var S=o.getInteriorRingN(I),D=Ye.removeRepeatedPoints(S.getCoordinates());u._distance>0&&u.isErodedCompletely(S,-u._distance)||u.addPolygonRing(D,h,zt.opposite(d),ut.INTERIOR,ut.EXTERIOR)}};lo.prototype.isTriangleErodedCompletely=function(o,u){var h=new dr(o[0],o[1],o[2]),d=h.inCentre(),g=Kt.distancePointLine(d,h.p0,h.p1);return g<Math.abs(u)};lo.prototype.addLineString=function(o){if(this._distance<=0&&!this._curveBuilder.getBufferParameters().isSingleSided())return null;var u=Ye.removeRepeatedPoints(o.getCoordinates()),h=this._curveBuilder.getLineCurve(u,this._distance);this.addCurve(h,ut.EXTERIOR,ut.INTERIOR)};lo.prototype.addCurve=function(o,u,h){if(o===null||o.length<2)return null;var d=new cn(o,new xr(0,ut.BOUNDARY,u,h));this._curveList.add(d)};lo.prototype.getCurves=function(){return this.add(this._inputGeom),this._curveList};lo.prototype.addPolygonRing=function(o,u,h,d,g){if(u===0&&o.length<bs.MINIMUM_VALID_SIZE)return null;var x=d,I=g;o.length>=bs.MINIMUM_VALID_SIZE&&Kt.isCCW(o)&&(x=g,I=d,h=zt.opposite(h));var S=this._curveBuilder.getRingCurve(o,h,u);this.addCurve(S,x,I)};lo.prototype.add=function(o){if(o.isEmpty())return null;o instanceof Cn?this.addPolygon(o):o instanceof nn?this.addLineString(o):o instanceof Ci?this.addPoint(o):o instanceof Ic?this.addCollection(o):o instanceof vl?this.addCollection(o):o instanceof ys?this.addCollection(o):o instanceof fi&&this.addCollection(o)};lo.prototype.isErodedCompletely=function(o,u){var h=o.getCoordinates();if(h.length<4)return u<0;if(h.length===4)return this.isTriangleErodedCompletely(h,u);var d=o.getEnvelopeInternal(),g=Math.min(d.getHeight(),d.getWidth());return u<0&&2*Math.abs(u)>g};lo.prototype.addCollection=function(o){for(var u=this,h=0;h<o.getNumGeometries();h++){var d=o.getGeometryN(h);u.add(d)}};lo.prototype.interfaces_=function(){return[]};lo.prototype.getClass=function(){return lo};var Ac=function(){};Ac.prototype.locate=function(o){};Ac.prototype.interfaces_=function(){return[]};Ac.prototype.getClass=function(){return Ac};var vs=function(){this._parent=null,this._atStart=null,this._max=null,this._index=null,this._subcollectionIterator=null;var o=arguments[0];this._parent=o,this._atStart=!0,this._index=0,this._max=o.getNumGeometries()};vs.prototype.next=function(){if(this._atStart)return this._atStart=!1,vs.isAtomic(this._parent)&&this._index++,this._parent;if(this._subcollectionIterator!==null){if(this._subcollectionIterator.hasNext())return this._subcollectionIterator.next();this._subcollectionIterator=null}if(this._index>=this._max)throw new Uc;var o=this._parent.getGeometryN(this._index++);return o instanceof fi?(this._subcollectionIterator=new vs(o),this._subcollectionIterator.next()):o};vs.prototype.remove=function(){throw new Error(this.getClass().getName())};vs.prototype.hasNext=function(){if(this._atStart)return!0;if(this._subcollectionIterator!==null){if(this._subcollectionIterator.hasNext())return!0;this._subcollectionIterator=null}return!(this._index>=this._max)};vs.prototype.interfaces_=function(){return[Vc]};vs.prototype.getClass=function(){return vs};vs.isAtomic=function(o){return!(o instanceof fi)};var Bi=function(){this._geom=null;var o=arguments[0];this._geom=o};Bi.prototype.locate=function(o){return Bi.locate(o,this._geom)};Bi.prototype.interfaces_=function(){return[Ac]};Bi.prototype.getClass=function(){return Bi};Bi.isPointInRing=function(o,u){return u.getEnvelopeInternal().intersects(o)?Kt.isPointInRing(o,u.getCoordinates()):!1};Bi.containsPointInPolygon=function(o,u){if(u.isEmpty())return!1;var h=u.getExteriorRing();if(!Bi.isPointInRing(o,h))return!1;for(var d=0;d<u.getNumInteriorRing();d++){var g=u.getInteriorRingN(d);if(Bi.isPointInRing(o,g))return!1}return!0};Bi.containsPoint=function(o,u){if(u instanceof Cn)return Bi.containsPointInPolygon(o,u);if(u instanceof fi)for(var h=new vs(u);h.hasNext();){var d=h.next();if(d!==u&&Bi.containsPoint(o,d))return!0}return!1};Bi.locate=function(o,u){return u.isEmpty()?ut.EXTERIOR:Bi.containsPoint(o,u)?ut.INTERIOR:ut.EXTERIOR};var si=function(){this._edgeMap=new ii,this._edgeList=null,this._ptInAreaLocation=[ut.NONE,ut.NONE]};si.prototype.getNextCW=function(o){this.getEdges();var u=this._edgeList.indexOf(o),h=u-1;return u===0&&(h=this._edgeList.size()-1),this._edgeList.get(h)};si.prototype.propagateSideLabels=function(o){for(var u=ut.NONE,h=this.iterator();h.hasNext();){var d=h.next(),g=d.getLabel();g.isArea(o)&&g.getLocation(o,zt.LEFT)!==ut.NONE&&(u=g.getLocation(o,zt.LEFT))}if(u===ut.NONE)return null;for(var x=u,I=this.iterator();I.hasNext();){var S=I.next(),D=S.getLabel();if(D.getLocation(o,zt.ON)===ut.NONE&&D.setLocation(o,zt.ON,x),D.isArea(o)){var O=D.getLocation(o,zt.LEFT),B=D.getLocation(o,zt.RIGHT);if(B!==ut.NONE){if(B!==x)throw new $s("side location conflict",S.getCoordinate());O===ut.NONE&&Ze.shouldNeverReachHere("found single null side (at "+S.getCoordinate()+")"),x=O}else Ze.isTrue(D.getLocation(o,zt.LEFT)===ut.NONE,"found single null side"),D.setLocation(o,zt.RIGHT,x),D.setLocation(o,zt.LEFT,x)}}};si.prototype.getCoordinate=function(){var o=this.iterator();if(!o.hasNext())return null;var u=o.next();return u.getCoordinate()};si.prototype.print=function(o){$n.out.println("EdgeEndStar:   "+this.getCoordinate());for(var u=this.iterator();u.hasNext();){var h=u.next();h.print(o)}};si.prototype.isAreaLabelsConsistent=function(o){return this.computeEdgeEndLabels(o.getBoundaryNodeRule()),this.checkAreaLabelsConsistent(0)};si.prototype.checkAreaLabelsConsistent=function(o){var u=this.getEdges();if(u.size()<=0)return!0;var h=u.size()-1,d=u.get(h).getLabel(),g=d.getLocation(o,zt.LEFT);Ze.isTrue(g!==ut.NONE,"Found unlabelled area edge");for(var x=g,I=this.iterator();I.hasNext();){var S=I.next(),D=S.getLabel();Ze.isTrue(D.isArea(o),"Found non-area edge");var O=D.getLocation(o,zt.LEFT),B=D.getLocation(o,zt.RIGHT);if(O===B||B!==x)return!1;x=O}return!0};si.prototype.findIndex=function(o){var u=this;this.iterator();for(var h=0;h<this._edgeList.size();h++){var d=u._edgeList.get(h);if(d===o)return h}return-1};si.prototype.iterator=function(){return this.getEdges().iterator()};si.prototype.getEdges=function(){return this._edgeList===null&&(this._edgeList=new jt(this._edgeMap.values())),this._edgeList};si.prototype.getLocation=function(o,u,h){return this._ptInAreaLocation[o]===ut.NONE&&(this._ptInAreaLocation[o]=Bi.locate(u,h[o].getGeometry())),this._ptInAreaLocation[o]};si.prototype.toString=function(){var o=new is;o.append("EdgeEndStar:   "+this.getCoordinate()),o.append(`
`);for(var u=this.iterator();u.hasNext();){var h=u.next();o.append(h),o.append(`
`)}return o.toString()};si.prototype.computeEdgeEndLabels=function(o){for(var u=this.iterator();u.hasNext();){var h=u.next();h.computeLabel(o)}};si.prototype.computeLabelling=function(o){var u=this;this.computeEdgeEndLabels(o[0].getBoundaryNodeRule()),this.propagateSideLabels(0),this.propagateSideLabels(1);for(var h=[!1,!1],d=this.iterator();d.hasNext();)for(var g=d.next(),x=g.getLabel(),I=0;I<2;I++)x.isLine(I)&&x.getLocation(I)===ut.BOUNDARY&&(h[I]=!0);for(var S=this.iterator();S.hasNext();)for(var D=S.next(),O=D.getLabel(),B=0;B<2;B++)if(O.isAnyNull(B)){var W=ut.NONE;if(h[B])W=ut.EXTERIOR;else{var et=D.getCoordinate();W=u.getLocation(B,et,o)}O.setAllLocationsIfNull(B,W)}};si.prototype.getDegree=function(){return this._edgeMap.size()};si.prototype.insertEdgeEnd=function(o,u){this._edgeMap.put(o,u),this._edgeList=null};si.prototype.interfaces_=function(){return[]};si.prototype.getClass=function(){return si};var yO=function(c){function o(){c.call(this),this._resultAreaEdgeList=null,this._label=null,this._SCANNING_FOR_INCOMING=1,this._LINKING_TO_OUTGOING=2}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.linkResultDirectedEdges=function(){var h=this;this.getResultAreaEdges();for(var d=null,g=null,x=this._SCANNING_FOR_INCOMING,I=0;I<this._resultAreaEdgeList.size();I++){var S=h._resultAreaEdgeList.get(I),D=S.getSym();if(S.getLabel().isArea())switch(d===null&&S.isInResult()&&(d=S),x){case h._SCANNING_FOR_INCOMING:if(!D.isInResult())continue;g=D,x=h._LINKING_TO_OUTGOING;break;case h._LINKING_TO_OUTGOING:if(!S.isInResult())continue;g.setNext(S),x=h._SCANNING_FOR_INCOMING;break}}if(x===this._LINKING_TO_OUTGOING){if(d===null)throw new $s("no outgoing dirEdge found",this.getCoordinate());Ze.isTrue(d.isInResult(),"unable to link last incoming dirEdge"),g.setNext(d)}},o.prototype.insert=function(h){var d=h;this.insertEdgeEnd(d,d)},o.prototype.getRightmostEdge=function(){var h=this.getEdges(),d=h.size();if(d<1)return null;var g=h.get(0);if(d===1)return g;var x=h.get(d-1),I=g.getQuadrant(),S=x.getQuadrant();return Er.isNorthern(I)&&Er.isNorthern(S)?g:!Er.isNorthern(I)&&!Er.isNorthern(S)?x:g.getDy()!==0?g:x.getDy()!==0?x:(Ze.shouldNeverReachHere("found two horizontal edges incident on node"),null)},o.prototype.print=function(h){$n.out.println("DirectedEdgeStar: "+this.getCoordinate());for(var d=this.iterator();d.hasNext();){var g=d.next();h.print("out "),g.print(h),h.println(),h.print("in "),g.getSym().print(h),h.println()}},o.prototype.getResultAreaEdges=function(){var h=this;if(this._resultAreaEdgeList!==null)return this._resultAreaEdgeList;this._resultAreaEdgeList=new jt;for(var d=this.iterator();d.hasNext();){var g=d.next();(g.isInResult()||g.getSym().isInResult())&&h._resultAreaEdgeList.add(g)}return this._resultAreaEdgeList},o.prototype.updateLabelling=function(h){for(var d=this.iterator();d.hasNext();){var g=d.next(),x=g.getLabel();x.setAllLocationsIfNull(0,h.getLocation(0)),x.setAllLocationsIfNull(1,h.getLocation(1))}},o.prototype.linkAllDirectedEdges=function(){var h=this;this.getEdges();for(var d=null,g=null,x=this._edgeList.size()-1;x>=0;x--){var I=h._edgeList.get(x),S=I.getSym();g===null&&(g=S),d!==null&&S.setNext(d),d=I}g.setNext(d)},o.prototype.computeDepths=function(){var h=this;if(arguments.length===1){var d=arguments[0],g=this.findIndex(d),x=d.getDepth(zt.LEFT),I=d.getDepth(zt.RIGHT),S=this.computeDepths(g+1,this._edgeList.size(),x),D=this.computeDepths(0,g,S);if(D!==I)throw new $s("depth mismatch at "+d.getCoordinate())}else if(arguments.length===3){for(var O=arguments[0],B=arguments[1],W=arguments[2],et=W,it=O;it<B;it++){var bt=h._edgeList.get(it);bt.setEdgeDepths(zt.RIGHT,et),et=bt.getDepth(zt.LEFT)}return et}},o.prototype.mergeSymLabels=function(){for(var h=this.iterator();h.hasNext();){var d=h.next(),g=d.getLabel();g.merge(d.getSym().getLabel())}},o.prototype.linkMinimalDirectedEdges=function(h){for(var d=this,g=null,x=null,I=this._SCANNING_FOR_INCOMING,S=this._resultAreaEdgeList.size()-1;S>=0;S--){var D=d._resultAreaEdgeList.get(S),O=D.getSym();switch(g===null&&D.getEdgeRing()===h&&(g=D),I){case d._SCANNING_FOR_INCOMING:if(O.getEdgeRing()!==h)continue;x=O,I=d._LINKING_TO_OUTGOING;break;case d._LINKING_TO_OUTGOING:if(D.getEdgeRing()!==h)continue;x.setNextMin(D),I=d._SCANNING_FOR_INCOMING;break}}I===this._LINKING_TO_OUTGOING&&(Ze.isTrue(g!==null,"found null for first outgoing dirEdge"),Ze.isTrue(g.getEdgeRing()===h,"unable to link last incoming dirEdge"),x.setNextMin(g))},o.prototype.getOutgoingDegree=function(){if(arguments.length===0){for(var h=0,d=this.iterator();d.hasNext();){var g=d.next();g.isInResult()&&h++}return h}else if(arguments.length===1){for(var x=arguments[0],I=0,S=this.iterator();S.hasNext();){var D=S.next();D.getEdgeRing()===x&&I++}return I}},o.prototype.getLabel=function(){return this._label},o.prototype.findCoveredLineEdges=function(){for(var h=ut.NONE,d=this.iterator();d.hasNext();){var g=d.next(),x=g.getSym();if(!g.isLineEdge()){if(g.isInResult()){h=ut.INTERIOR;break}if(x.isInResult()){h=ut.EXTERIOR;break}}}if(h===ut.NONE)return null;for(var I=h,S=this.iterator();S.hasNext();){var D=S.next(),O=D.getSym();D.isLineEdge()?D.getEdge().setCovered(I===ut.INTERIOR):(D.isInResult()&&(I=ut.EXTERIOR),O.isInResult()&&(I=ut.INTERIOR))}},o.prototype.computeLabelling=function(h){var d=this;c.prototype.computeLabelling.call(this,h),this._label=new xr(ut.NONE);for(var g=this.iterator();g.hasNext();)for(var x=g.next(),I=x.getEdge(),S=I.getLabel(),D=0;D<2;D++){var O=S.getLocation(D);(O===ut.INTERIOR||O===ut.BOUNDARY)&&d._label.setLocation(D,ut.INTERIOR)}},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(si),aI=function(c){function o(){c.apply(this,arguments)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.createNode=function(h){return new um(h,new yO)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Sc),Ma=function c(){this._pts=null,this._orientation=null;var o=arguments[0];this._pts=o,this._orientation=c.orientation(o)};Ma.prototype.compareTo=function(o){var u=o,h=Ma.compareOriented(this._pts,this._orientation,u._pts,u._orientation);return h};Ma.prototype.interfaces_=function(){return[uo]};Ma.prototype.getClass=function(){return Ma};Ma.orientation=function(o){return Ye.increasingDirection(o)===1};Ma.compareOriented=function(o,u,h,d){for(var g=u?1:-1,x=d?1:-1,I=u?o.length:-1,S=d?h.length:-1,D=u?0:o.length-1,O=d?0:h.length-1;;){var B=o[D].compareTo(h[O]);if(B!==0)return B;D+=g,O+=x;var W=D===I,et=O===S;if(W&&!et)return-1;if(!W&&et)return 1;if(W&&et)return 0}};var So=function(){this._edges=new jt,this._ocaMap=new ii};So.prototype.print=function(o){var u=this;o.print("MULTILINESTRING ( ");for(var h=0;h<this._edges.size();h++){var d=u._edges.get(h);h>0&&o.print(","),o.print("(");for(var g=d.getCoordinates(),x=0;x<g.length;x++)x>0&&o.print(","),o.print(g[x].x+" "+g[x].y);o.println(")")}o.print(")  ")};So.prototype.addAll=function(o){for(var u=this,h=o.iterator();h.hasNext();)u.add(h.next())};So.prototype.findEdgeIndex=function(o){for(var u=this,h=0;h<this._edges.size();h++)if(u._edges.get(h).equals(o))return h;return-1};So.prototype.iterator=function(){return this._edges.iterator()};So.prototype.getEdges=function(){return this._edges};So.prototype.get=function(o){return this._edges.get(o)};So.prototype.findEqualEdge=function(o){var u=new Ma(o.getCoordinates()),h=this._ocaMap.get(u);return h};So.prototype.add=function(o){this._edges.add(o);var u=new Ma(o.getCoordinates());this._ocaMap.put(u,o)};So.prototype.interfaces_=function(){return[]};So.prototype.getClass=function(){return So};var wl=function(){};wl.prototype.processIntersections=function(o,u,h,d){};wl.prototype.isDone=function(){};wl.prototype.interfaces_=function(){return[]};wl.prototype.getClass=function(){return wl};var ji=function(){this._hasIntersection=!1,this._hasProper=!1,this._hasProperInterior=!1,this._hasInterior=!1,this._properIntersectionPoint=null,this._li=null,this._isSelfIntersection=null,this.numIntersections=0,this.numInteriorIntersections=0,this.numProperIntersections=0,this.numTests=0;var o=arguments[0];this._li=o};ji.prototype.isTrivialIntersection=function(o,u,h,d){if(o===h&&this._li.getIntersectionNum()===1){if(ji.isAdjacentSegments(u,d))return!0;if(o.isClosed()){var g=o.size()-1;if(u===0&&d===g||d===0&&u===g)return!0}}return!1};ji.prototype.getProperIntersectionPoint=function(){return this._properIntersectionPoint};ji.prototype.hasProperInteriorIntersection=function(){return this._hasProperInterior};ji.prototype.getLineIntersector=function(){return this._li};ji.prototype.hasProperIntersection=function(){return this._hasProper};ji.prototype.processIntersections=function(o,u,h,d){if(o===h&&u===d)return null;this.numTests++;var g=o.getCoordinates()[u],x=o.getCoordinates()[u+1],I=h.getCoordinates()[d],S=h.getCoordinates()[d+1];this._li.computeIntersection(g,x,I,S),this._li.hasIntersection()&&(this.numIntersections++,this._li.isInteriorIntersection()&&(this.numInteriorIntersections++,this._hasInterior=!0),this.isTrivialIntersection(o,u,h,d)||(this._hasIntersection=!0,o.addIntersections(this._li,u,0),h.addIntersections(this._li,d,1),this._li.isProper()&&(this.numProperIntersections++,this._hasProper=!0,this._hasProperInterior=!0)))};ji.prototype.hasIntersection=function(){return this._hasIntersection};ji.prototype.isDone=function(){return!1};ji.prototype.hasInteriorIntersection=function(){return this._hasInterior};ji.prototype.interfaces_=function(){return[wl]};ji.prototype.getClass=function(){return ji};ji.isAdjacentSegments=function(o,u){return Math.abs(o-u)===1};var ts=function(){this.coord=null,this.segmentIndex=null,this.dist=null;var o=arguments[0],u=arguments[1],h=arguments[2];this.coord=new st(o),this.segmentIndex=u,this.dist=h};ts.prototype.getSegmentIndex=function(){return this.segmentIndex};ts.prototype.getCoordinate=function(){return this.coord};ts.prototype.print=function(o){o.print(this.coord),o.print(" seg # = "+this.segmentIndex),o.println(" dist = "+this.dist)};ts.prototype.compareTo=function(o){var u=o;return this.compare(u.segmentIndex,u.dist)};ts.prototype.isEndPoint=function(o){return this.segmentIndex===0&&this.dist===0||this.segmentIndex===o};ts.prototype.toString=function(){return this.coord+" seg # = "+this.segmentIndex+" dist = "+this.dist};ts.prototype.getDistance=function(){return this.dist};ts.prototype.compare=function(o,u){return this.segmentIndex<o?-1:this.segmentIndex>o?1:this.dist<u?-1:this.dist>u?1:0};ts.prototype.interfaces_=function(){return[uo]};ts.prototype.getClass=function(){return ts};var Ts=function(){this._nodeMap=new ii,this.edge=null;var o=arguments[0];this.edge=o};Ts.prototype.print=function(o){o.println("Intersections:");for(var u=this.iterator();u.hasNext();){var h=u.next();h.print(o)}};Ts.prototype.iterator=function(){return this._nodeMap.values().iterator()};Ts.prototype.addSplitEdges=function(o){var u=this;this.addEndpoints();for(var h=this.iterator(),d=h.next();h.hasNext();){var g=h.next(),x=u.createSplitEdge(d,g);o.add(x),d=g}};Ts.prototype.addEndpoints=function(){var o=this.edge.pts.length-1;this.add(this.edge.pts[0],0,0),this.add(this.edge.pts[o],o,0)};Ts.prototype.createSplitEdge=function(o,u){var h=this,d=u.segmentIndex-o.segmentIndex+2,g=this.edge.pts[u.segmentIndex],x=u.dist>0||!u.coord.equals2D(g);x||d--;var I=new Array(d).fill(null),S=0;I[S++]=new st(o.coord);for(var D=o.segmentIndex+1;D<=u.segmentIndex;D++)I[S++]=h.edge.pts[D];return x&&(I[S]=u.coord),new jd(I,new xr(this.edge._label))};Ts.prototype.add=function(o,u,h){var d=new ts(o,u,h),g=this._nodeMap.get(d);return g!==null?g:(this._nodeMap.put(d,d),d)};Ts.prototype.isIntersection=function(o){for(var u=this.iterator();u.hasNext();){var h=u.next();if(h.coord.equals(o))return!0}return!1};Ts.prototype.interfaces_=function(){return[]};Ts.prototype.getClass=function(){return Ts};var El=function(){};El.prototype.getChainStartIndices=function(o){var u=this,h=0,d=new jt;d.add(new Ho(h));do{var g=u.findChainEnd(o,h);d.add(new Ho(g)),h=g}while(h<o.length-1);var x=El.toIntArray(d);return x};El.prototype.findChainEnd=function(o,u){for(var h=Er.quadrant(o[u],o[u+1]),d=u+1;d<o.length;){var g=Er.quadrant(o[d-1],o[d]);if(g!==h)break;d++}return d-1};El.prototype.interfaces_=function(){return[]};El.prototype.getClass=function(){return El};El.toIntArray=function(o){for(var u=new Array(o.size()).fill(null),h=0;h<u.length;h++)u[h]=o.get(h).intValue();return u};var Js=function(){this.e=null,this.pts=null,this.startIndex=null,this.env1=new le,this.env2=new le;var o=arguments[0];this.e=o,this.pts=o.getCoordinates();var u=new El;this.startIndex=u.getChainStartIndices(this.pts)};Js.prototype.getCoordinates=function(){return this.pts};Js.prototype.getMaxX=function(o){var u=this.pts[this.startIndex[o]].x,h=this.pts[this.startIndex[o+1]].x;return u>h?u:h};Js.prototype.getMinX=function(o){var u=this.pts[this.startIndex[o]].x,h=this.pts[this.startIndex[o+1]].x;return u<h?u:h};Js.prototype.computeIntersectsForChain=function(){if(arguments.length===4){var o=arguments[0],u=arguments[1],h=arguments[2],d=arguments[3];this.computeIntersectsForChain(this.startIndex[o],this.startIndex[o+1],u,u.startIndex[h],u.startIndex[h+1],d)}else if(arguments.length===6){var g=arguments[0],x=arguments[1],I=arguments[2],S=arguments[3],D=arguments[4],O=arguments[5],B=this.pts[g],W=this.pts[x],et=I.pts[S],it=I.pts[D];if(x-g===1&&D-S===1)return O.addIntersections(this.e,g,I.e,S),null;if(this.env1.init(B,W),this.env2.init(et,it),!this.env1.intersects(this.env2))return null;var bt=Math.trunc((g+x)/2),ft=Math.trunc((S+D)/2);g<bt&&(S<ft&&this.computeIntersectsForChain(g,bt,I,S,ft,O),ft<D&&this.computeIntersectsForChain(g,bt,I,ft,D,O)),bt<x&&(S<ft&&this.computeIntersectsForChain(bt,x,I,S,ft,O),ft<D&&this.computeIntersectsForChain(bt,x,I,ft,D,O))}};Js.prototype.getStartIndexes=function(){return this.startIndex};Js.prototype.computeIntersects=function(o,u){for(var h=this,d=0;d<this.startIndex.length-1;d++)for(var g=0;g<o.startIndex.length-1;g++)h.computeIntersectsForChain(d,o,g,u)};Js.prototype.interfaces_=function(){return[]};Js.prototype.getClass=function(){return Js};var Yn=function c(){var o=this;this._depth=Array(2).fill().map(function(){return Array(3)});for(var u=0;u<2;u++)for(var h=0;h<3;h++)o._depth[u][h]=c.NULL_VALUE},lI={NULL_VALUE:{configurable:!0}};Yn.prototype.getDepth=function(o,u){return this._depth[o][u]};Yn.prototype.setDepth=function(o,u,h){this._depth[o][u]=h};Yn.prototype.isNull=function(){var o=this;if(arguments.length===0){for(var u=0;u<2;u++)for(var h=0;h<3;h++)if(o._depth[u][h]!==Yn.NULL_VALUE)return!1;return!0}else if(arguments.length===1){var d=arguments[0];return this._depth[d][1]===Yn.NULL_VALUE}else if(arguments.length===2){var g=arguments[0],x=arguments[1];return this._depth[g][x]===Yn.NULL_VALUE}};Yn.prototype.normalize=function(){for(var o=this,u=0;u<2;u++)if(!o.isNull(u)){var h=o._depth[u][1];o._depth[u][2]<h&&(h=o._depth[u][2]),h<0&&(h=0);for(var d=1;d<3;d++){var g=0;o._depth[u][d]>h&&(g=1),o._depth[u][d]=g}}};Yn.prototype.getDelta=function(o){return this._depth[o][zt.RIGHT]-this._depth[o][zt.LEFT]};Yn.prototype.getLocation=function(o,u){return this._depth[o][u]<=0?ut.EXTERIOR:ut.INTERIOR};Yn.prototype.toString=function(){return"A: "+this._depth[0][1]+","+this._depth[0][2]+" B: "+this._depth[1][1]+","+this._depth[1][2]};Yn.prototype.add=function(){var o=this;if(arguments.length===1)for(var u=arguments[0],h=0;h<2;h++)for(var d=1;d<3;d++){var g=u.getLocation(h,d);(g===ut.EXTERIOR||g===ut.INTERIOR)&&(o.isNull(h,d)?o._depth[h][d]=Yn.depthAtLocation(g):o._depth[h][d]+=Yn.depthAtLocation(g))}else if(arguments.length===3){var x=arguments[0],I=arguments[1],S=arguments[2];S===ut.INTERIOR&&this._depth[x][I]++}};Yn.prototype.interfaces_=function(){return[]};Yn.prototype.getClass=function(){return Yn};Yn.depthAtLocation=function(o){return o===ut.EXTERIOR?0:o===ut.INTERIOR?1:Yn.NULL_VALUE};lI.NULL_VALUE.get=function(){return-1};Object.defineProperties(Yn,lI);var jd=function(c){function o(){if(c.call(this),this.pts=null,this._env=null,this.eiList=new Ts(this),this._name=null,this._mce=null,this._isIsolated=!0,this._depth=new Yn,this._depthDelta=0,arguments.length===1){var u=arguments[0];o.call(this,u,null)}else if(arguments.length===2){var h=arguments[0],d=arguments[1];this.pts=h,this._label=d}}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.getDepth=function(){return this._depth},o.prototype.getCollapsedEdge=function(){var h=new Array(2).fill(null);h[0]=this.pts[0],h[1]=this.pts[1];var d=new o(h,xr.toLineLabel(this._label));return d},o.prototype.isIsolated=function(){return this._isIsolated},o.prototype.getCoordinates=function(){return this.pts},o.prototype.setIsolated=function(h){this._isIsolated=h},o.prototype.setName=function(h){this._name=h},o.prototype.equals=function(h){var d=this;if(!(h instanceof o))return!1;var g=h;if(this.pts.length!==g.pts.length)return!1;for(var x=!0,I=!0,S=this.pts.length,D=0;D<this.pts.length;D++)if(d.pts[D].equals2D(g.pts[D])||(x=!1),d.pts[D].equals2D(g.pts[--S])||(I=!1),!x&&!I)return!1;return!0},o.prototype.getCoordinate=function(){if(arguments.length===0)return this.pts.length>0?this.pts[0]:null;if(arguments.length===1){var h=arguments[0];return this.pts[h]}},o.prototype.print=function(h){var d=this;h.print("edge "+this._name+": "),h.print("LINESTRING (");for(var g=0;g<this.pts.length;g++)g>0&&h.print(","),h.print(d.pts[g].x+" "+d.pts[g].y);h.print(")  "+this._label+" "+this._depthDelta)},o.prototype.computeIM=function(h){o.updateIM(this._label,h)},o.prototype.isCollapsed=function(){return!this._label.isArea()||this.pts.length!==3?!1:!!this.pts[0].equals(this.pts[2])},o.prototype.isClosed=function(){return this.pts[0].equals(this.pts[this.pts.length-1])},o.prototype.getMaximumSegmentIndex=function(){return this.pts.length-1},o.prototype.getDepthDelta=function(){return this._depthDelta},o.prototype.getNumPoints=function(){return this.pts.length},o.prototype.printReverse=function(h){var d=this;h.print("edge "+this._name+": ");for(var g=this.pts.length-1;g>=0;g--)h.print(d.pts[g]+" ");h.println("")},o.prototype.getMonotoneChainEdge=function(){return this._mce===null&&(this._mce=new Js(this)),this._mce},o.prototype.getEnvelope=function(){var h=this;if(this._env===null){this._env=new le;for(var d=0;d<this.pts.length;d++)h._env.expandToInclude(h.pts[d])}return this._env},o.prototype.addIntersection=function(h,d,g,x){var I=new st(h.getIntersection(x)),S=d,D=h.getEdgeDistance(g,x),O=S+1;if(O<this.pts.length){var B=this.pts[O];I.equals2D(B)&&(S=O,D=0)}this.eiList.add(I,S,D)},o.prototype.toString=function(){var h=this,d=new is;d.append("edge "+this._name+": "),d.append("LINESTRING (");for(var g=0;g<this.pts.length;g++)g>0&&d.append(","),d.append(h.pts[g].x+" "+h.pts[g].y);return d.append(")  "+this._label+" "+this._depthDelta),d.toString()},o.prototype.isPointwiseEqual=function(h){var d=this;if(this.pts.length!==h.pts.length)return!1;for(var g=0;g<this.pts.length;g++)if(!d.pts[g].equals2D(h.pts[g]))return!1;return!0},o.prototype.setDepthDelta=function(h){this._depthDelta=h},o.prototype.getEdgeIntersectionList=function(){return this.eiList},o.prototype.addIntersections=function(h,d,g){for(var x=this,I=0;I<h.getIntersectionNum();I++)x.addIntersection(h,d,g,I)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o.updateIM=function(){if(arguments.length===2){var h=arguments[0],d=arguments[1];d.setAtLeastIfValid(h.getLocation(0,zt.ON),h.getLocation(1,zt.ON),1),h.isArea()&&(d.setAtLeastIfValid(h.getLocation(0,zt.LEFT),h.getLocation(1,zt.LEFT),2),d.setAtLeastIfValid(h.getLocation(0,zt.RIGHT),h.getLocation(1,zt.RIGHT),2))}else return c.prototype.updateIM.apply(this,arguments)},o}(Ui),pi=function(o){this._workingPrecisionModel=null,this._workingNoder=null,this._geomFact=null,this._graph=null,this._edgeList=new So,this._bufParams=o||null};pi.prototype.setWorkingPrecisionModel=function(o){this._workingPrecisionModel=o};pi.prototype.insertUniqueEdge=function(o){var u=this._edgeList.findEqualEdge(o);if(u!==null){var h=u.getLabel(),d=o.getLabel();u.isPointwiseEqual(o)||(d=new xr(o.getLabel()),d.flip()),h.merge(d);var g=pi.depthDelta(d),x=u.getDepthDelta(),I=x+g;u.setDepthDelta(I)}else this._edgeList.add(o),o.setDepthDelta(pi.depthDelta(o.getLabel()))};pi.prototype.buildSubgraphs=function(o,u){for(var h=new jt,d=o.iterator();d.hasNext();){var g=d.next(),x=g.getRightmostCoordinate(),I=new ru(h),S=I.getDepth(x);g.computeDepth(S),g.findResultEdges(),h.add(g),u.add(g.getDirectedEdges(),g.getNodes())}};pi.prototype.createSubgraphs=function(o){for(var u=new jt,h=o.getNodes().iterator();h.hasNext();){var d=h.next();if(!d.isVisited()){var g=new di;g.create(d),u.add(g)}}return Io.sort(u,Io.reverseOrder()),u};pi.prototype.createEmptyResultGeometry=function(){var o=this._geomFact.createPolygon();return o};pi.prototype.getNoder=function(o){if(this._workingNoder!==null)return this._workingNoder;var u=new yv,h=new Ml;return h.setPrecisionModel(o),u.setSegmentIntersector(new ji(h)),u};pi.prototype.buffer=function(o,u){var h=this._workingPrecisionModel;h===null&&(h=o.getPrecisionModel()),this._geomFact=o.getFactory();var d=new bi(h,this._bufParams),g=new lo(o,u,d),x=g.getCurves();if(x.size()<=0)return this.createEmptyResultGeometry();this.computeNodedEdges(x,h),this._graph=new Kr(new aI),this._graph.addEdges(this._edgeList.getEdges());var I=this.createSubgraphs(this._graph),S=new Mi(this._geomFact);this.buildSubgraphs(I,S);var D=S.getPolygons();if(D.size()<=0)return this.createEmptyResultGeometry();var O=this._geomFact.buildGeometry(D);return O};pi.prototype.computeNodedEdges=function(o,u){var h=this,d=this.getNoder(u);d.computeNodes(o);for(var g=d.getNodedSubstrings(),x=g.iterator();x.hasNext();){var I=x.next(),S=I.getCoordinates();if(!(S.length===2&&S[0].equals2D(S[1]))){var D=I.getData(),O=new jd(I.getCoordinates(),new xr(D));h.insertUniqueEdge(O)}}};pi.prototype.setNoder=function(o){this._workingNoder=o};pi.prototype.interfaces_=function(){return[]};pi.prototype.getClass=function(){return pi};pi.depthDelta=function(o){var u=o.getLocation(0,zt.LEFT),h=o.getLocation(0,zt.RIGHT);return u===ut.INTERIOR&&h===ut.EXTERIOR?1:u===ut.EXTERIOR&&h===ut.INTERIOR?-1:0};pi.convertSegStrings=function(o){for(var u=new He,h=new jt;o.hasNext();){var d=o.next(),g=u.createLineString(d.getCoordinates());h.add(g)}return u.buildGeometry(h)};var Aa=function(){if(this._noder=null,this._scaleFactor=null,this._offsetX=null,this._offsetY=null,this._isScaled=!1,arguments.length===2){var o=arguments[0],u=arguments[1];this._noder=o,this._scaleFactor=u,this._offsetX=0,this._offsetY=0,this._isScaled=!this.isIntegerPrecision()}else if(arguments.length===4){var h=arguments[0],d=arguments[1],g=arguments[2],x=arguments[3];this._noder=h,this._scaleFactor=d,this._offsetX=g,this._offsetY=x,this._isScaled=!this.isIntegerPrecision()}};Aa.prototype.rescale=function(){var o=this;if(Ee(arguments[0],En))for(var u=arguments[0],h=u.iterator();h.hasNext();){var d=h.next();o.rescale(d.getCoordinates())}else if(arguments[0]instanceof Array){for(var g=arguments[0],x=0;x<g.length;x++)g[x].x=g[x].x/o._scaleFactor+o._offsetX,g[x].y=g[x].y/o._scaleFactor+o._offsetY;g.length===2&&g[0].equals2D(g[1])&&$n.out.println(g)}};Aa.prototype.scale=function(){var o=this;if(Ee(arguments[0],En)){for(var u=arguments[0],h=new jt,d=u.iterator();d.hasNext();){var g=d.next();h.add(new cn(o.scale(g.getCoordinates()),g.getData()))}return h}else if(arguments[0]instanceof Array){for(var x=arguments[0],I=new Array(x.length).fill(null),S=0;S<x.length;S++)I[S]=new st(Math.round((x[S].x-o._offsetX)*o._scaleFactor),Math.round((x[S].y-o._offsetY)*o._scaleFactor),x[S].z);var D=Ye.removeRepeatedPoints(I);return D}};Aa.prototype.isIntegerPrecision=function(){return this._scaleFactor===1};Aa.prototype.getNodedSubstrings=function(){var o=this._noder.getNodedSubstrings();return this._isScaled&&this.rescale(o),o};Aa.prototype.computeNodes=function(o){var u=o;this._isScaled&&(u=this.scale(o)),this._noder.computeNodes(u)};Aa.prototype.interfaces_=function(){return[xl]};Aa.prototype.getClass=function(){return Aa};var es=function(){this._li=new Ml,this._segStrings=null;var o=arguments[0];this._segStrings=o},uI={fact:{configurable:!0}};es.prototype.checkEndPtVertexIntersections=function(){var o=this;if(arguments.length===0)for(var u=this._segStrings.iterator();u.hasNext();){var h=u.next(),d=h.getCoordinates();o.checkEndPtVertexIntersections(d[0],o._segStrings),o.checkEndPtVertexIntersections(d[d.length-1],o._segStrings)}else if(arguments.length===2){for(var g=arguments[0],x=arguments[1],I=x.iterator();I.hasNext();)for(var S=I.next(),D=S.getCoordinates(),O=1;O<D.length-1;O++)if(D[O].equals(g))throw new Hs("found endpt/interior pt intersection at index "+O+" :pt "+g)}};es.prototype.checkInteriorIntersections=function(){var o=this;if(arguments.length===0)for(var u=this._segStrings.iterator();u.hasNext();)for(var h=u.next(),d=this._segStrings.iterator();d.hasNext();){var g=d.next();o.checkInteriorIntersections(h,g)}else if(arguments.length===2)for(var x=arguments[0],I=arguments[1],S=x.getCoordinates(),D=I.getCoordinates(),O=0;O<S.length-1;O++)for(var B=0;B<D.length-1;B++)o.checkInteriorIntersections(x,O,I,B);else if(arguments.length===4){var W=arguments[0],et=arguments[1],it=arguments[2],bt=arguments[3];if(W===it&&et===bt)return null;var ft=W.getCoordinates()[et],Pt=W.getCoordinates()[et+1],kt=it.getCoordinates()[bt],Nt=it.getCoordinates()[bt+1];if(this._li.computeIntersection(ft,Pt,kt,Nt),this._li.hasIntersection()&&(this._li.isProper()||this.hasInteriorIntersection(this._li,ft,Pt)||this.hasInteriorIntersection(this._li,kt,Nt)))throw new Hs("found non-noded intersection at "+ft+"-"+Pt+" and "+kt+"-"+Nt)}};es.prototype.checkValid=function(){this.checkEndPtVertexIntersections(),this.checkInteriorIntersections(),this.checkCollapses()};es.prototype.checkCollapses=function(){var o=this;if(arguments.length===0)for(var u=this._segStrings.iterator();u.hasNext();){var h=u.next();o.checkCollapses(h)}else if(arguments.length===1)for(var d=arguments[0],g=d.getCoordinates(),x=0;x<g.length-2;x++)o.checkCollapse(g[x],g[x+1],g[x+2])};es.prototype.hasInteriorIntersection=function(o,u,h){for(var d=0;d<o.getIntersectionNum();d++){var g=o.getIntersection(d);if(!(g.equals(u)||g.equals(h)))return!0}return!1};es.prototype.checkCollapse=function(o,u,h){if(o.equals(h))throw new Hs("found non-noded collapse at "+es.fact.createLineString([o,u,h]))};es.prototype.interfaces_=function(){return[]};es.prototype.getClass=function(){return es};uI.fact.get=function(){return new He};Object.defineProperties(es,uI);var wi=function(){this._li=null,this._pt=null,this._originalPt=null,this._ptScaled=null,this._p0Scaled=null,this._p1Scaled=null,this._scaleFactor=null,this._minx=null,this._maxx=null,this._miny=null,this._maxy=null,this._corner=new Array(4).fill(null),this._safeEnv=null;var o=arguments[0],u=arguments[1],h=arguments[2];if(this._originalPt=o,this._pt=o,this._scaleFactor=u,this._li=h,u<=0)throw new Xr("Scale factor must be non-zero");u!==1&&(this._pt=new st(this.scale(o.x),this.scale(o.y)),this._p0Scaled=new st,this._p1Scaled=new st),this.initCorners(this._pt)},cI={SAFE_ENV_EXPANSION_FACTOR:{configurable:!0}};wi.prototype.intersectsScaled=function(o,u){var h=Math.min(o.x,u.x),d=Math.max(o.x,u.x),g=Math.min(o.y,u.y),x=Math.max(o.y,u.y),I=this._maxx<h||this._minx>d||this._maxy<g||this._miny>x;if(I)return!1;var S=this.intersectsToleranceSquare(o,u);return Ze.isTrue(!(I&&S),"Found bad envelope test"),S};wi.prototype.initCorners=function(o){var u=.5;this._minx=o.x-u,this._maxx=o.x+u,this._miny=o.y-u,this._maxy=o.y+u,this._corner[0]=new st(this._maxx,this._maxy),this._corner[1]=new st(this._minx,this._maxy),this._corner[2]=new st(this._minx,this._miny),this._corner[3]=new st(this._maxx,this._miny)};wi.prototype.intersects=function(o,u){return this._scaleFactor===1?this.intersectsScaled(o,u):(this.copyScaled(o,this._p0Scaled),this.copyScaled(u,this._p1Scaled),this.intersectsScaled(this._p0Scaled,this._p1Scaled))};wi.prototype.scale=function(o){return Math.round(o*this._scaleFactor)};wi.prototype.getCoordinate=function(){return this._originalPt};wi.prototype.copyScaled=function(o,u){u.x=this.scale(o.x),u.y=this.scale(o.y)};wi.prototype.getSafeEnvelope=function(){if(this._safeEnv===null){var o=wi.SAFE_ENV_EXPANSION_FACTOR/this._scaleFactor;this._safeEnv=new le(this._originalPt.x-o,this._originalPt.x+o,this._originalPt.y-o,this._originalPt.y+o)}return this._safeEnv};wi.prototype.intersectsPixelClosure=function(o,u){return this._li.computeIntersection(o,u,this._corner[0],this._corner[1]),!!(this._li.hasIntersection()||(this._li.computeIntersection(o,u,this._corner[1],this._corner[2]),this._li.hasIntersection())||(this._li.computeIntersection(o,u,this._corner[2],this._corner[3]),this._li.hasIntersection())||(this._li.computeIntersection(o,u,this._corner[3],this._corner[0]),this._li.hasIntersection()))};wi.prototype.intersectsToleranceSquare=function(o,u){var h=!1,d=!1;return this._li.computeIntersection(o,u,this._corner[0],this._corner[1]),!!(this._li.isProper()||(this._li.computeIntersection(o,u,this._corner[1],this._corner[2]),this._li.isProper())||(this._li.hasIntersection()&&(h=!0),this._li.computeIntersection(o,u,this._corner[2],this._corner[3]),this._li.isProper())||(this._li.hasIntersection()&&(d=!0),this._li.computeIntersection(o,u,this._corner[3],this._corner[0]),this._li.isProper())||h&&d||o.equals(this._pt)||u.equals(this._pt))};wi.prototype.addSnappedNode=function(o,u){var h=o.getCoordinate(u),d=o.getCoordinate(u+1);return this.intersects(h,d)?(o.addIntersection(this.getCoordinate(),u),!0):!1};wi.prototype.interfaces_=function(){return[]};wi.prototype.getClass=function(){return wi};cI.SAFE_ENV_EXPANSION_FACTOR.get=function(){return .75};Object.defineProperties(wi,cI);var up=function(){this.tempEnv1=new le,this.selectedSegment=new he};up.prototype.select=function(){if(arguments.length!==1){if(arguments.length===2){var o=arguments[0],u=arguments[1];o.getLineSegment(u,this.selectedSegment),this.select(this.selectedSegment)}}};up.prototype.interfaces_=function(){return[]};up.prototype.getClass=function(){return up};var Pc=function(){this._index=null;var o=arguments[0];this._index=o},hI={HotPixelSnapAction:{configurable:!0}};Pc.prototype.snap=function(){if(arguments.length===1){var o=arguments[0];return this.snap(o,null,-1)}else if(arguments.length===3){var u=arguments[0],h=arguments[1],d=arguments[2],g=u.getSafeEnvelope(),x=new pI(u,h,d);return this._index.query(g,{interfaces_:function(){return[Sa]},visitItem:function(I){var S=I;S.select(g,x)}}),x.isNodeAdded()}};Pc.prototype.interfaces_=function(){return[]};Pc.prototype.getClass=function(){return Pc};hI.HotPixelSnapAction.get=function(){return pI};Object.defineProperties(Pc,hI);var pI=function(c){function o(){c.call(this),this._hotPixel=null,this._parentEdge=null,this._hotPixelVertexIndex=null,this._isNodeAdded=!1;var u=arguments[0],h=arguments[1],d=arguments[2];this._hotPixel=u,this._parentEdge=h,this._hotPixelVertexIndex=d}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.isNodeAdded=function(){return this._isNodeAdded},o.prototype.select=function(){if(arguments.length===2){var h=arguments[0],d=arguments[1],g=h.getContext();if(this._parentEdge!==null&&g===this._parentEdge&&d===this._hotPixelVertexIndex)return null;this._isNodeAdded=this._hotPixel.addSnappedNode(g,d)}else return c.prototype.select.apply(this,arguments)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(up),nu=function(){this._li=null,this._interiorIntersections=null;var o=arguments[0];this._li=o,this._interiorIntersections=new jt};nu.prototype.processIntersections=function(o,u,h,d){var g=this;if(o===h&&u===d)return null;var x=o.getCoordinates()[u],I=o.getCoordinates()[u+1],S=h.getCoordinates()[d],D=h.getCoordinates()[d+1];if(this._li.computeIntersection(x,I,S,D),this._li.hasIntersection()&&this._li.isInteriorIntersection()){for(var O=0;O<this._li.getIntersectionNum();O++)g._interiorIntersections.add(g._li.getIntersection(O));o.addIntersections(this._li,u,0),h.addIntersections(this._li,d,1)}};nu.prototype.isDone=function(){return!1};nu.prototype.getInteriorIntersections=function(){return this._interiorIntersections};nu.prototype.interfaces_=function(){return[wl]};nu.prototype.getClass=function(){return nu};var Is=function(){this._pm=null,this._li=null,this._scaleFactor=null,this._noder=null,this._pointSnapper=null,this._nodedSegStrings=null;var o=arguments[0];this._pm=o,this._li=new Ml,this._li.setPrecisionModel(o),this._scaleFactor=o.getScale()};Is.prototype.checkCorrectness=function(o){var u=cn.getNodedSubstrings(o),h=new es(u);try{h.checkValid()}catch(d){if(d instanceof YT)d.printStackTrace();else throw d}finally{}};Is.prototype.getNodedSubstrings=function(){return cn.getNodedSubstrings(this._nodedSegStrings)};Is.prototype.snapRound=function(o,u){var h=this.findInteriorIntersections(o,u);this.computeIntersectionSnaps(h),this.computeVertexSnaps(o)};Is.prototype.findInteriorIntersections=function(o,u){var h=new nu(u);return this._noder.setSegmentIntersector(h),this._noder.computeNodes(o),h.getInteriorIntersections()};Is.prototype.computeVertexSnaps=function(){var o=this;if(Ee(arguments[0],En))for(var u=arguments[0],h=u.iterator();h.hasNext();){var d=h.next();o.computeVertexSnaps(d)}else if(arguments[0]instanceof cn)for(var g=arguments[0],x=g.getCoordinates(),I=0;I<x.length;I++){var S=new wi(x[I],o._scaleFactor,o._li),D=o._pointSnapper.snap(S,g,I);D&&g.addIntersection(x[I],I)}};Is.prototype.computeNodes=function(o){this._nodedSegStrings=o,this._noder=new yv,this._pointSnapper=new Pc(this._noder.getIndex()),this.snapRound(o,this._li)};Is.prototype.computeIntersectionSnaps=function(o){for(var u=this,h=o.iterator();h.hasNext();){var d=h.next(),g=new wi(d,u._scaleFactor,u._li);u._pointSnapper.snap(g)}};Is.prototype.interfaces_=function(){return[xl]};Is.prototype.getClass=function(){return Is};var Hn=function(){if(this._argGeom=null,this._distance=null,this._bufParams=new pr,this._resultGeometry=null,this._saveException=null,arguments.length===1){var o=arguments[0];this._argGeom=o}else if(arguments.length===2){var u=arguments[0],h=arguments[1];this._argGeom=u,this._bufParams=h}},Gc={CAP_ROUND:{configurable:!0},CAP_BUTT:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},MAX_PRECISION_DIGITS:{configurable:!0}};Hn.prototype.bufferFixedPrecision=function(o){var u=new Aa(new Is(new fr(1)),o.getScale()),h=new pi(this._bufParams);h.setWorkingPrecisionModel(o),h.setNoder(u),this._resultGeometry=h.buffer(this._argGeom,this._distance)};Hn.prototype.bufferReducedPrecision=function(){var o=this;if(arguments.length===0){for(var u=Hn.MAX_PRECISION_DIGITS;u>=0;u--){try{o.bufferReducedPrecision(u)}catch(x){if(x instanceof $s)o._saveException=x;else throw x}finally{}if(o._resultGeometry!==null)return null}throw this._saveException}else if(arguments.length===1){var h=arguments[0],d=Hn.precisionScaleFactor(this._argGeom,this._distance,h),g=new fr(d);this.bufferFixedPrecision(g)}};Hn.prototype.computeGeometry=function(){if(this.bufferOriginalPrecision(),this._resultGeometry!==null)return null;var o=this._argGeom.getFactory().getPrecisionModel();o.getType()===fr.FIXED?this.bufferFixedPrecision(o):this.bufferReducedPrecision()};Hn.prototype.setQuadrantSegments=function(o){this._bufParams.setQuadrantSegments(o)};Hn.prototype.bufferOriginalPrecision=function(){try{var o=new pi(this._bufParams);this._resultGeometry=o.buffer(this._argGeom,this._distance)}catch(u){if(u instanceof Hs)this._saveException=u;else throw u}finally{}};Hn.prototype.getResultGeometry=function(o){return this._distance=o,this.computeGeometry(),this._resultGeometry};Hn.prototype.setEndCapStyle=function(o){this._bufParams.setEndCapStyle(o)};Hn.prototype.interfaces_=function(){return[]};Hn.prototype.getClass=function(){return Hn};Hn.bufferOp=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1],h=new Hn(o),d=h.getResultGeometry(u);return d}else if(arguments.length===3){if(Number.isInteger(arguments[2])&&arguments[0]instanceof be&&typeof arguments[1]=="number"){var g=arguments[0],x=arguments[1],I=arguments[2],S=new Hn(g);S.setQuadrantSegments(I);var D=S.getResultGeometry(x);return D}else if(arguments[2]instanceof pr&&arguments[0]instanceof be&&typeof arguments[1]=="number"){var O=arguments[0],B=arguments[1],W=arguments[2],et=new Hn(O,W),it=et.getResultGeometry(B);return it}}else if(arguments.length===4){var bt=arguments[0],ft=arguments[1],Pt=arguments[2],kt=arguments[3],Nt=new Hn(bt);Nt.setQuadrantSegments(Pt),Nt.setEndCapStyle(kt);var ne=Nt.getResultGeometry(ft);return ne}};Hn.precisionScaleFactor=function(o,u,h){var d=o.getEnvelopeInternal(),g=Vi.max(Math.abs(d.getMaxX()),Math.abs(d.getMaxY()),Math.abs(d.getMinX()),Math.abs(d.getMinY())),x=u>0?u:0,I=g+2*x,S=Math.trunc(Math.log(I)/Math.log(10)+1),D=h-S,O=Math.pow(10,D);return O};Gc.CAP_ROUND.get=function(){return pr.CAP_ROUND};Gc.CAP_BUTT.get=function(){return pr.CAP_FLAT};Gc.CAP_FLAT.get=function(){return pr.CAP_FLAT};Gc.CAP_SQUARE.get=function(){return pr.CAP_SQUARE};Gc.MAX_PRECISION_DIGITS.get=function(){return 12};Object.defineProperties(Hn,Gc);var ui=function(){this._pt=[new st,new st],this._distance=ke.NaN,this._isNull=!0};ui.prototype.getCoordinates=function(){return this._pt};ui.prototype.getCoordinate=function(o){return this._pt[o]};ui.prototype.setMinimum=function(){if(arguments.length===1){var o=arguments[0];this.setMinimum(o._pt[0],o._pt[1])}else if(arguments.length===2){var u=arguments[0],h=arguments[1];if(this._isNull)return this.initialize(u,h),null;var d=u.distance(h);d<this._distance&&this.initialize(u,h,d)}};ui.prototype.initialize=function(){if(arguments.length===0)this._isNull=!0;else if(arguments.length===2){var o=arguments[0],u=arguments[1];this._pt[0].setCoordinate(o),this._pt[1].setCoordinate(u),this._distance=o.distance(u),this._isNull=!1}else if(arguments.length===3){var h=arguments[0],d=arguments[1],g=arguments[2];this._pt[0].setCoordinate(h),this._pt[1].setCoordinate(d),this._distance=g,this._isNull=!1}};ui.prototype.getDistance=function(){return this._distance};ui.prototype.setMaximum=function(){if(arguments.length===1){var o=arguments[0];this.setMaximum(o._pt[0],o._pt[1])}else if(arguments.length===2){var u=arguments[0],h=arguments[1];if(this._isNull)return this.initialize(u,h),null;var d=u.distance(h);d>this._distance&&this.initialize(u,h,d)}};ui.prototype.interfaces_=function(){return[]};ui.prototype.getClass=function(){return ui};var _s=function(){};_s.prototype.interfaces_=function(){return[]};_s.prototype.getClass=function(){return _s};_s.computeDistance=function(){if(arguments[2]instanceof ui&&arguments[0]instanceof nn&&arguments[1]instanceof st)for(var o=arguments[0],u=arguments[1],h=arguments[2],d=o.getCoordinates(),g=new he,x=0;x<d.length-1;x++){g.setCoordinates(d[x],d[x+1]);var I=g.closestPoint(u);h.setMinimum(I,u)}else if(arguments[2]instanceof ui&&arguments[0]instanceof Cn&&arguments[1]instanceof st){var S=arguments[0],D=arguments[1],O=arguments[2];_s.computeDistance(S.getExteriorRing(),D,O);for(var B=0;B<S.getNumInteriorRing();B++)_s.computeDistance(S.getInteriorRingN(B),D,O)}else if(arguments[2]instanceof ui&&arguments[0]instanceof be&&arguments[1]instanceof st){var W=arguments[0],et=arguments[1],it=arguments[2];if(W instanceof nn)_s.computeDistance(W,et,it);else if(W instanceof Cn)_s.computeDistance(W,et,it);else if(W instanceof fi)for(var bt=W,ft=0;ft<bt.getNumGeometries();ft++){var Pt=bt.getGeometryN(ft);_s.computeDistance(Pt,et,it)}else it.setMinimum(W.getCoordinate(),et)}else if(arguments[2]instanceof ui&&arguments[0]instanceof he&&arguments[1]instanceof st){var kt=arguments[0],Nt=arguments[1],ne=arguments[2],Te=kt.closestPoint(Nt);ne.setMinimum(Te,Nt)}};var Tl=function(o){this._maxPtDist=new ui,this._inputGeom=o||null},vv={MaxPointDistanceFilter:{configurable:!0},MaxMidpointDistanceFilter:{configurable:!0}};Tl.prototype.computeMaxMidpointDistance=function(o){var u=new Pa(this._inputGeom);o.apply(u),this._maxPtDist.setMaximum(u.getMaxPointDistance())};Tl.prototype.computeMaxVertexDistance=function(o){var u=new iu(this._inputGeom);o.apply(u),this._maxPtDist.setMaximum(u.getMaxPointDistance())};Tl.prototype.findDistance=function(o){return this.computeMaxVertexDistance(o),this.computeMaxMidpointDistance(o),this._maxPtDist.getDistance()};Tl.prototype.getDistancePoints=function(){return this._maxPtDist};Tl.prototype.interfaces_=function(){return[]};Tl.prototype.getClass=function(){return Tl};vv.MaxPointDistanceFilter.get=function(){return iu};vv.MaxMidpointDistanceFilter.get=function(){return Pa};Object.defineProperties(Tl,vv);var iu=function(o){this._maxPtDist=new ui,this._minPtDist=new ui,this._geom=o||null};iu.prototype.filter=function(o){this._minPtDist.initialize(),_s.computeDistance(this._geom,o,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)};iu.prototype.getMaxPointDistance=function(){return this._maxPtDist};iu.prototype.interfaces_=function(){return[xs]};iu.prototype.getClass=function(){return iu};var Pa=function(o){this._maxPtDist=new ui,this._minPtDist=new ui,this._geom=o||null};Pa.prototype.filter=function(o,u){if(u===0)return null;var h=o.getCoordinate(u-1),d=o.getCoordinate(u),g=new st((h.x+d.x)/2,(h.y+d.y)/2);this._minPtDist.initialize(),_s.computeDistance(this._geom,g,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)};Pa.prototype.isDone=function(){return!1};Pa.prototype.isGeometryChanged=function(){return!1};Pa.prototype.getMaxPointDistance=function(){return this._maxPtDist};Pa.prototype.interfaces_=function(){return[Eo]};Pa.prototype.getClass=function(){return Pa};var Ws=function(o){this._comps=o||null};Ws.prototype.filter=function(o){o instanceof Cn&&this._comps.add(o)};Ws.prototype.interfaces_=function(){return[$o]};Ws.prototype.getClass=function(){return Ws};Ws.getPolygons=function(){if(arguments.length===1){var o=arguments[0];return Ws.getPolygons(o,new jt)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];return u instanceof Cn?h.add(u):u instanceof fi&&u.apply(new Ws(h)),h}};var Wn=function(){if(this._lines=null,this._isForcedToLineString=!1,arguments.length===1){var o=arguments[0];this._lines=o}else if(arguments.length===2){var u=arguments[0],h=arguments[1];this._lines=u,this._isForcedToLineString=h}};Wn.prototype.filter=function(o){if(this._isForcedToLineString&&o instanceof bs){var u=o.getFactory().createLineString(o.getCoordinateSequence());return this._lines.add(u),null}o instanceof nn&&this._lines.add(o)};Wn.prototype.setForceToLineString=function(o){this._isForcedToLineString=o};Wn.prototype.interfaces_=function(){return[Ys]};Wn.prototype.getClass=function(){return Wn};Wn.getGeometry=function(){if(arguments.length===1){var o=arguments[0];return o.getFactory().buildGeometry(Wn.getLines(o))}else if(arguments.length===2){var u=arguments[0],h=arguments[1];return u.getFactory().buildGeometry(Wn.getLines(u,h))}};Wn.getLines=function(){if(arguments.length===1){var o=arguments[0];return Wn.getLines(o,!1)}else if(arguments.length===2){if(Ee(arguments[0],En)&&Ee(arguments[1],En)){for(var u=arguments[0],h=arguments[1],d=u.iterator();d.hasNext();){var g=d.next();Wn.getLines(g,h)}return h}else if(arguments[0]instanceof be&&typeof arguments[1]=="boolean"){var x=arguments[0],I=arguments[1],S=new jt;return x.apply(new Wn(S,I)),S}else if(arguments[0]instanceof be&&Ee(arguments[1],En)){var D=arguments[0],O=arguments[1];return D instanceof nn?O.add(D):D.apply(new Wn(O)),O}}else if(arguments.length===3){if(typeof arguments[2]=="boolean"&&Ee(arguments[0],En)&&Ee(arguments[1],En)){for(var B=arguments[0],W=arguments[1],et=arguments[2],it=B.iterator();it.hasNext();){var bt=it.next();Wn.getLines(bt,W,et)}return W}else if(typeof arguments[2]=="boolean"&&arguments[0]instanceof be&&Ee(arguments[1],En)){var ft=arguments[0],Pt=arguments[1],kt=arguments[2];return ft.apply(new Wn(Pt,kt)),Pt}}};var Co=function(){if(this._boundaryRule=so.OGC_SFS_BOUNDARY_RULE,this._isIn=null,this._numBoundaries=null,arguments.length!==0){if(arguments.length===1){var o=arguments[0];if(o===null)throw new Xr("Rule must be non-null");this._boundaryRule=o}}};Co.prototype.locateInternal=function(){var o=this;if(arguments[0]instanceof st&&arguments[1]instanceof Cn){var u=arguments[0],h=arguments[1];if(h.isEmpty())return ut.EXTERIOR;var d=h.getExteriorRing(),g=this.locateInPolygonRing(u,d);if(g===ut.EXTERIOR)return ut.EXTERIOR;if(g===ut.BOUNDARY)return ut.BOUNDARY;for(var x=0;x<h.getNumInteriorRing();x++){var I=h.getInteriorRingN(x),S=o.locateInPolygonRing(u,I);if(S===ut.INTERIOR)return ut.EXTERIOR;if(S===ut.BOUNDARY)return ut.BOUNDARY}return ut.INTERIOR}else if(arguments[0]instanceof st&&arguments[1]instanceof nn){var D=arguments[0],O=arguments[1];if(!O.getEnvelopeInternal().intersects(D))return ut.EXTERIOR;var B=O.getCoordinates();return!O.isClosed()&&(D.equals(B[0])||D.equals(B[B.length-1]))?ut.BOUNDARY:Kt.isOnLine(D,B)?ut.INTERIOR:ut.EXTERIOR}else if(arguments[0]instanceof st&&arguments[1]instanceof Ci){var W=arguments[0],et=arguments[1],it=et.getCoordinate();return it.equals2D(W)?ut.INTERIOR:ut.EXTERIOR}};Co.prototype.locateInPolygonRing=function(o,u){return u.getEnvelopeInternal().intersects(o)?Kt.locatePointInRing(o,u.getCoordinates()):ut.EXTERIOR};Co.prototype.intersects=function(o,u){return this.locate(o,u)!==ut.EXTERIOR};Co.prototype.updateLocationInfo=function(o){o===ut.INTERIOR&&(this._isIn=!0),o===ut.BOUNDARY&&this._numBoundaries++};Co.prototype.computeLocation=function(o,u){var h=this;if(u instanceof Ci&&this.updateLocationInfo(this.locateInternal(o,u)),u instanceof nn)this.updateLocationInfo(this.locateInternal(o,u));else if(u instanceof Cn)this.updateLocationInfo(this.locateInternal(o,u));else if(u instanceof vl)for(var d=u,g=0;g<d.getNumGeometries();g++){var x=d.getGeometryN(g);h.updateLocationInfo(h.locateInternal(o,x))}else if(u instanceof ys)for(var I=u,S=0;S<I.getNumGeometries();S++){var D=I.getGeometryN(S);h.updateLocationInfo(h.locateInternal(o,D))}else if(u instanceof fi)for(var O=new vs(u);O.hasNext();){var B=O.next();B!==u&&h.computeLocation(o,B)}};Co.prototype.locate=function(o,u){return u.isEmpty()?ut.EXTERIOR:u instanceof nn?this.locateInternal(o,u):u instanceof Cn?this.locateInternal(o,u):(this._isIn=!1,this._numBoundaries=0,this.computeLocation(o,u),this._boundaryRule.isInBoundary(this._numBoundaries)?ut.BOUNDARY:this._numBoundaries>0||this._isIn?ut.INTERIOR:ut.EXTERIOR)};Co.prototype.interfaces_=function(){return[]};Co.prototype.getClass=function(){return Co};var ci=function c(){if(this._component=null,this._segIndex=null,this._pt=null,arguments.length===2){var o=arguments[0],u=arguments[1];c.call(this,o,c.INSIDE_AREA,u)}else if(arguments.length===3){var h=arguments[0],d=arguments[1],g=arguments[2];this._component=h,this._segIndex=d,this._pt=g}},fI={INSIDE_AREA:{configurable:!0}};ci.prototype.isInsideArea=function(){return this._segIndex===ci.INSIDE_AREA};ci.prototype.getCoordinate=function(){return this._pt};ci.prototype.getGeometryComponent=function(){return this._component};ci.prototype.getSegmentIndex=function(){return this._segIndex};ci.prototype.interfaces_=function(){return[]};ci.prototype.getClass=function(){return ci};fI.INSIDE_AREA.get=function(){return-1};Object.defineProperties(ci,fI);var Ea=function(o){this._pts=o||null};Ea.prototype.filter=function(o){o instanceof Ci&&this._pts.add(o)};Ea.prototype.interfaces_=function(){return[$o]};Ea.prototype.getClass=function(){return Ea};Ea.getPoints=function(){if(arguments.length===1){var o=arguments[0];return o instanceof Ci?Io.singletonList(o):Ea.getPoints(o,new jt)}else if(arguments.length===2){var u=arguments[0],h=arguments[1];return u instanceof Ci?h.add(u):u instanceof fi&&u.apply(new Ea(h)),h}};var ou=function(){this._locations=null;var o=arguments[0];this._locations=o};ou.prototype.filter=function(o){(o instanceof Ci||o instanceof nn||o instanceof Cn)&&this._locations.add(new ci(o,0,o.getCoordinate()))};ou.prototype.interfaces_=function(){return[$o]};ou.prototype.getClass=function(){return ou};ou.getLocations=function(o){var u=new jt;return o.apply(new ou(u)),u};var Kn=function(){if(this._geom=null,this._terminateDistance=0,this._ptLocator=new Co,this._minDistanceLocation=null,this._minDistance=ke.MAX_VALUE,arguments.length===2){var o=arguments[0],u=arguments[1];this._geom=[o,u],this._terminateDistance=0}else if(arguments.length===3){var h=arguments[0],d=arguments[1],g=arguments[2];this._geom=new Array(2).fill(null),this._geom[0]=h,this._geom[1]=d,this._terminateDistance=g}};Kn.prototype.computeContainmentDistance=function(){var o=this;if(arguments.length===0){var u=new Array(2).fill(null);if(this.computeContainmentDistance(0,u),this._minDistance<=this._terminateDistance)return null;this.computeContainmentDistance(1,u)}else if(arguments.length===2){var h=arguments[0],d=arguments[1],g=1-h,x=Ws.getPolygons(this._geom[h]);if(x.size()>0){var I=ou.getLocations(this._geom[g]);if(this.computeContainmentDistance(I,x,d),this._minDistance<=this._terminateDistance)return this._minDistanceLocation[g]=d[0],this._minDistanceLocation[h]=d[1],null}}else if(arguments.length===3){if(arguments[2]instanceof Array&&Ee(arguments[0],bo)&&Ee(arguments[1],bo)){for(var S=arguments[0],D=arguments[1],O=arguments[2],B=0;B<S.size();B++)for(var W=S.get(B),et=0;et<D.size();et++)if(o.computeContainmentDistance(W,D.get(et),O),o._minDistance<=o._terminateDistance)return null}else if(arguments[2]instanceof Array&&arguments[0]instanceof ci&&arguments[1]instanceof Cn){var it=arguments[0],bt=arguments[1],ft=arguments[2],Pt=it.getCoordinate();if(ut.EXTERIOR!==this._ptLocator.locate(Pt,bt))return this._minDistance=0,ft[0]=it,ft[1]=new ci(bt,Pt),null}}};Kn.prototype.computeMinDistanceLinesPoints=function(o,u,h){for(var d=this,g=0;g<o.size();g++)for(var x=o.get(g),I=0;I<u.size();I++){var S=u.get(I);if(d.computeMinDistance(x,S,h),d._minDistance<=d._terminateDistance)return null}};Kn.prototype.computeFacetDistance=function(){var o=new Array(2).fill(null),u=Wn.getLines(this._geom[0]),h=Wn.getLines(this._geom[1]),d=Ea.getPoints(this._geom[0]),g=Ea.getPoints(this._geom[1]);if(this.computeMinDistanceLines(u,h,o),this.updateMinDistance(o,!1),this._minDistance<=this._terminateDistance||(o[0]=null,o[1]=null,this.computeMinDistanceLinesPoints(u,g,o),this.updateMinDistance(o,!1),this._minDistance<=this._terminateDistance)||(o[0]=null,o[1]=null,this.computeMinDistanceLinesPoints(h,d,o),this.updateMinDistance(o,!0),this._minDistance<=this._terminateDistance))return null;o[0]=null,o[1]=null,this.computeMinDistancePoints(d,g,o),this.updateMinDistance(o,!1)};Kn.prototype.nearestLocations=function(){return this.computeMinDistance(),this._minDistanceLocation};Kn.prototype.updateMinDistance=function(o,u){if(o[0]===null)return null;u?(this._minDistanceLocation[0]=o[1],this._minDistanceLocation[1]=o[0]):(this._minDistanceLocation[0]=o[0],this._minDistanceLocation[1]=o[1])};Kn.prototype.nearestPoints=function(){this.computeMinDistance();var o=[this._minDistanceLocation[0].getCoordinate(),this._minDistanceLocation[1].getCoordinate()];return o};Kn.prototype.computeMinDistance=function(){var o=this;if(arguments.length===0){if(this._minDistanceLocation!==null||(this._minDistanceLocation=new Array(2).fill(null),this.computeContainmentDistance(),this._minDistance<=this._terminateDistance))return null;this.computeFacetDistance()}else if(arguments.length===3){if(arguments[2]instanceof Array&&arguments[0]instanceof nn&&arguments[1]instanceof Ci){var u=arguments[0],h=arguments[1],d=arguments[2];if(u.getEnvelopeInternal().distance(h.getEnvelopeInternal())>this._minDistance)return null;for(var g=u.getCoordinates(),x=h.getCoordinate(),I=0;I<g.length-1;I++){var S=Kt.distancePointLine(x,g[I],g[I+1]);if(S<o._minDistance){o._minDistance=S;var D=new he(g[I],g[I+1]),O=D.closestPoint(x);d[0]=new ci(u,I,O),d[1]=new ci(h,0,x)}if(o._minDistance<=o._terminateDistance)return null}}else if(arguments[2]instanceof Array&&arguments[0]instanceof nn&&arguments[1]instanceof nn){var B=arguments[0],W=arguments[1],et=arguments[2];if(B.getEnvelopeInternal().distance(W.getEnvelopeInternal())>this._minDistance)return null;for(var it=B.getCoordinates(),bt=W.getCoordinates(),ft=0;ft<it.length-1;ft++)for(var Pt=0;Pt<bt.length-1;Pt++){var kt=Kt.distanceLineLine(it[ft],it[ft+1],bt[Pt],bt[Pt+1]);if(kt<o._minDistance){o._minDistance=kt;var Nt=new he(it[ft],it[ft+1]),ne=new he(bt[Pt],bt[Pt+1]),Te=Nt.closestPoints(ne);et[0]=new ci(B,ft,Te[0]),et[1]=new ci(W,Pt,Te[1])}if(o._minDistance<=o._terminateDistance)return null}}}};Kn.prototype.computeMinDistancePoints=function(o,u,h){for(var d=this,g=0;g<o.size();g++)for(var x=o.get(g),I=0;I<u.size();I++){var S=u.get(I),D=x.getCoordinate().distance(S.getCoordinate());if(D<d._minDistance&&(d._minDistance=D,h[0]=new ci(x,0,x.getCoordinate()),h[1]=new ci(S,0,S.getCoordinate())),d._minDistance<=d._terminateDistance)return null}};Kn.prototype.distance=function(){if(this._geom[0]===null||this._geom[1]===null)throw new Xr("null geometries are not supported");return this._geom[0].isEmpty()||this._geom[1].isEmpty()?0:(this.computeMinDistance(),this._minDistance)};Kn.prototype.computeMinDistanceLines=function(o,u,h){for(var d=this,g=0;g<o.size();g++)for(var x=o.get(g),I=0;I<u.size();I++){var S=u.get(I);if(d.computeMinDistance(x,S,h),d._minDistance<=d._terminateDistance)return null}};Kn.prototype.interfaces_=function(){return[]};Kn.prototype.getClass=function(){return Kn};Kn.distance=function(o,u){var h=new Kn(o,u);return h.distance()};Kn.isWithinDistance=function(o,u,h){var d=new Kn(o,u,h);return d.distance()<=h};Kn.nearestPoints=function(o,u){var h=new Kn(o,u);return h.nearestPoints()};var ni=function(){this._pt=[new st,new st],this._distance=ke.NaN,this._isNull=!0};ni.prototype.getCoordinates=function(){return this._pt};ni.prototype.getCoordinate=function(o){return this._pt[o]};ni.prototype.setMinimum=function(){if(arguments.length===1){var o=arguments[0];this.setMinimum(o._pt[0],o._pt[1])}else if(arguments.length===2){var u=arguments[0],h=arguments[1];if(this._isNull)return this.initialize(u,h),null;var d=u.distance(h);d<this._distance&&this.initialize(u,h,d)}};ni.prototype.initialize=function(){if(arguments.length===0)this._isNull=!0;else if(arguments.length===2){var o=arguments[0],u=arguments[1];this._pt[0].setCoordinate(o),this._pt[1].setCoordinate(u),this._distance=o.distance(u),this._isNull=!1}else if(arguments.length===3){var h=arguments[0],d=arguments[1],g=arguments[2];this._pt[0].setCoordinate(h),this._pt[1].setCoordinate(d),this._distance=g,this._isNull=!1}};ni.prototype.toString=function(){return wo.toLineString(this._pt[0],this._pt[1])};ni.prototype.getDistance=function(){return this._distance};ni.prototype.setMaximum=function(){if(arguments.length===1){var o=arguments[0];this.setMaximum(o._pt[0],o._pt[1])}else if(arguments.length===2){var u=arguments[0],h=arguments[1];if(this._isNull)return this.initialize(u,h),null;var d=u.distance(h);d>this._distance&&this.initialize(u,h,d)}};ni.prototype.interfaces_=function(){return[]};ni.prototype.getClass=function(){return ni};var Zo=function(){};Zo.prototype.interfaces_=function(){return[]};Zo.prototype.getClass=function(){return Zo};Zo.computeDistance=function(){if(arguments[2]instanceof ni&&arguments[0]instanceof nn&&arguments[1]instanceof st)for(var o=arguments[0],u=arguments[1],h=arguments[2],d=new he,g=o.getCoordinates(),x=0;x<g.length-1;x++){d.setCoordinates(g[x],g[x+1]);var I=d.closestPoint(u);h.setMinimum(I,u)}else if(arguments[2]instanceof ni&&arguments[0]instanceof Cn&&arguments[1]instanceof st){var S=arguments[0],D=arguments[1],O=arguments[2];Zo.computeDistance(S.getExteriorRing(),D,O);for(var B=0;B<S.getNumInteriorRing();B++)Zo.computeDistance(S.getInteriorRingN(B),D,O)}else if(arguments[2]instanceof ni&&arguments[0]instanceof be&&arguments[1]instanceof st){var W=arguments[0],et=arguments[1],it=arguments[2];if(W instanceof nn)Zo.computeDistance(W,et,it);else if(W instanceof Cn)Zo.computeDistance(W,et,it);else if(W instanceof fi)for(var bt=W,ft=0;ft<bt.getNumGeometries();ft++){var Pt=bt.getGeometryN(ft);Zo.computeDistance(Pt,et,it)}else it.setMinimum(W.getCoordinate(),et)}else if(arguments[2]instanceof ni&&arguments[0]instanceof he&&arguments[1]instanceof st){var kt=arguments[0],Nt=arguments[1],ne=arguments[2],Te=kt.closestPoint(Nt);ne.setMinimum(Te,Nt)}};var oo=function(){this._g0=null,this._g1=null,this._ptDist=new ni,this._densifyFrac=0;var o=arguments[0],u=arguments[1];this._g0=o,this._g1=u},xv={MaxPointDistanceFilter:{configurable:!0},MaxDensifiedByFractionDistanceFilter:{configurable:!0}};oo.prototype.getCoordinates=function(){return this._ptDist.getCoordinates()};oo.prototype.setDensifyFraction=function(o){if(o>1||o<=0)throw new Xr("Fraction is not in range (0.0 - 1.0]");this._densifyFrac=o};oo.prototype.compute=function(o,u){this.computeOrientedDistance(o,u,this._ptDist),this.computeOrientedDistance(u,o,this._ptDist)};oo.prototype.distance=function(){return this.compute(this._g0,this._g1),this._ptDist.getDistance()};oo.prototype.computeOrientedDistance=function(o,u,h){var d=new su(u);if(o.apply(d),h.setMaximum(d.getMaxPointDistance()),this._densifyFrac>0){var g=new La(u,this._densifyFrac);o.apply(g),h.setMaximum(g.getMaxPointDistance())}};oo.prototype.orientedDistance=function(){return this.computeOrientedDistance(this._g0,this._g1,this._ptDist),this._ptDist.getDistance()};oo.prototype.interfaces_=function(){return[]};oo.prototype.getClass=function(){return oo};oo.distance=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1],h=new oo(o,u);return h.distance()}else if(arguments.length===3){var d=arguments[0],g=arguments[1],x=arguments[2],I=new oo(d,g);return I.setDensifyFraction(x),I.distance()}};xv.MaxPointDistanceFilter.get=function(){return su};xv.MaxDensifiedByFractionDistanceFilter.get=function(){return La};Object.defineProperties(oo,xv);var su=function(){this._maxPtDist=new ni,this._minPtDist=new ni,this._euclideanDist=new Zo,this._geom=null;var o=arguments[0];this._geom=o};su.prototype.filter=function(o){this._minPtDist.initialize(),Zo.computeDistance(this._geom,o,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)};su.prototype.getMaxPointDistance=function(){return this._maxPtDist};su.prototype.interfaces_=function(){return[xs]};su.prototype.getClass=function(){return su};var La=function(){this._maxPtDist=new ni,this._minPtDist=new ni,this._geom=null,this._numSubSegs=0;var o=arguments[0],u=arguments[1];this._geom=o,this._numSubSegs=Math.trunc(Math.round(1/u))};La.prototype.filter=function(o,u){var h=this;if(u===0)return null;for(var d=o.getCoordinate(u-1),g=o.getCoordinate(u),x=(g.x-d.x)/this._numSubSegs,I=(g.y-d.y)/this._numSubSegs,S=0;S<this._numSubSegs;S++){var D=d.x+S*x,O=d.y+S*I,B=new st(D,O);h._minPtDist.initialize(),Zo.computeDistance(h._geom,B,h._minPtDist),h._maxPtDist.setMaximum(h._minPtDist)}};La.prototype.isDone=function(){return!1};La.prototype.isGeometryChanged=function(){return!1};La.prototype.getMaxPointDistance=function(){return this._maxPtDist};La.prototype.interfaces_=function(){return[Eo]};La.prototype.getClass=function(){return La};var Si=function(o,u,h){this._minValidDistance=null,this._maxValidDistance=null,this._minDistanceFound=null,this._maxDistanceFound=null,this._isValid=!0,this._errMsg=null,this._errorLocation=null,this._errorIndicator=null,this._input=o||null,this._bufDistance=u||null,this._result=h||null},bv={VERBOSE:{configurable:!0},MAX_DISTANCE_DIFF_FRAC:{configurable:!0}};Si.prototype.checkMaximumDistance=function(o,u,h){var d=new oo(u,o);if(d.setDensifyFraction(.25),this._maxDistanceFound=d.orientedDistance(),this._maxDistanceFound>h){this._isValid=!1;var g=d.getCoordinates();this._errorLocation=g[1],this._errorIndicator=o.getFactory().createLineString(g),this._errMsg="Distance between buffer curve and input is too large ("+this._maxDistanceFound+" at "+wo.toLineString(g[0],g[1])+")"}};Si.prototype.isValid=function(){var o=Math.abs(this._bufDistance),u=Si.MAX_DISTANCE_DIFF_FRAC*o;return this._minValidDistance=o-u,this._maxValidDistance=o+u,this._input.isEmpty()||this._result.isEmpty()?!0:(this._bufDistance>0?this.checkPositiveValid():this.checkNegativeValid(),Si.VERBOSE&&$n.out.println("Min Dist= "+this._minDistanceFound+"  err= "+(1-this._minDistanceFound/this._bufDistance)+"  Max Dist= "+this._maxDistanceFound+"  err= "+(this._maxDistanceFound/this._bufDistance-1)),this._isValid)};Si.prototype.checkNegativeValid=function(){if(!(this._input instanceof Cn||this._input instanceof ys||this._input instanceof fi))return null;var o=this.getPolygonLines(this._input);if(this.checkMinimumDistance(o,this._result,this._minValidDistance),!this._isValid)return null;this.checkMaximumDistance(o,this._result,this._maxValidDistance)};Si.prototype.getErrorIndicator=function(){return this._errorIndicator};Si.prototype.checkMinimumDistance=function(o,u,h){var d=new Kn(o,u,h);if(this._minDistanceFound=d.distance(),this._minDistanceFound<h){this._isValid=!1;var g=d.nearestPoints();this._errorLocation=d.nearestPoints()[1],this._errorIndicator=o.getFactory().createLineString(g),this._errMsg="Distance between buffer curve and input is too small ("+this._minDistanceFound+" at "+wo.toLineString(g[0],g[1])+" )"}};Si.prototype.checkPositiveValid=function(){var o=this._result.getBoundary();if(this.checkMinimumDistance(this._input,o,this._minValidDistance),!this._isValid)return null;this.checkMaximumDistance(this._input,o,this._maxValidDistance)};Si.prototype.getErrorLocation=function(){return this._errorLocation};Si.prototype.getPolygonLines=function(o){for(var u=new jt,h=new Wn(u),d=Ws.getPolygons(o),g=d.iterator();g.hasNext();){var x=g.next();x.apply(h)}return o.getFactory().buildGeometry(u)};Si.prototype.getErrorMessage=function(){return this._errMsg};Si.prototype.interfaces_=function(){return[]};Si.prototype.getClass=function(){return Si};bv.VERBOSE.get=function(){return!1};bv.MAX_DISTANCE_DIFF_FRAC.get=function(){return .012};Object.defineProperties(Si,bv);var Jn=function(o,u,h){this._isValid=!0,this._errorMsg=null,this._errorLocation=null,this._errorIndicator=null,this._input=o||null,this._distance=u||null,this._result=h||null},wv={VERBOSE:{configurable:!0},MAX_ENV_DIFF_FRAC:{configurable:!0}};Jn.prototype.isValid=function(){return this.checkPolygonal(),this._isValid?(this.checkExpectedEmpty(),this._isValid?(this.checkEnvelope(),this._isValid?(this.checkArea(),this._isValid?(this.checkDistance(),this._isValid):this._isValid):this._isValid):this._isValid):this._isValid};Jn.prototype.checkEnvelope=function(){if(this._distance<0)return null;var o=this._distance*Jn.MAX_ENV_DIFF_FRAC;o===0&&(o=.001);var u=new le(this._input.getEnvelopeInternal());u.expandBy(this._distance);var h=new le(this._result.getEnvelopeInternal());h.expandBy(o),h.contains(u)||(this._isValid=!1,this._errorMsg="Buffer envelope is incorrect",this._errorIndicator=this._input.getFactory().toGeometry(h)),this.report("Envelope")};Jn.prototype.checkDistance=function(){var o=new Si(this._input,this._distance,this._result);o.isValid()||(this._isValid=!1,this._errorMsg=o.getErrorMessage(),this._errorLocation=o.getErrorLocation(),this._errorIndicator=o.getErrorIndicator()),this.report("Distance")};Jn.prototype.checkArea=function(){var o=this._input.getArea(),u=this._result.getArea();this._distance>0&&o>u&&(this._isValid=!1,this._errorMsg="Area of positive buffer is smaller than input",this._errorIndicator=this._result),this._distance<0&&o<u&&(this._isValid=!1,this._errorMsg="Area of negative buffer is larger than input",this._errorIndicator=this._result),this.report("Area")};Jn.prototype.checkPolygonal=function(){this._result instanceof Cn||this._result instanceof ys||(this._isValid=!1),this._errorMsg="Result is not polygonal",this._errorIndicator=this._result,this.report("Polygonal")};Jn.prototype.getErrorIndicator=function(){return this._errorIndicator};Jn.prototype.getErrorLocation=function(){return this._errorLocation};Jn.prototype.checkExpectedEmpty=function(){if(this._input.getDimension()>=2||this._distance>0)return null;this._result.isEmpty()||(this._isValid=!1,this._errorMsg="Result is non-empty",this._errorIndicator=this._result),this.report("ExpectedEmpty")};Jn.prototype.report=function(o){if(!Jn.VERBOSE)return null;$n.out.println("Check "+o+": "+(this._isValid?"passed":"FAILED"))};Jn.prototype.getErrorMessage=function(){return this._errorMsg};Jn.prototype.interfaces_=function(){return[]};Jn.prototype.getClass=function(){return Jn};Jn.isValidMsg=function(o,u,h){var d=new Jn(o,u,h);return d.isValid()?null:d.getErrorMessage()};Jn.isValid=function(o,u,h){var d=new Jn(o,u,h);return!!d.isValid()};wv.VERBOSE.get=function(){return!1};wv.MAX_ENV_DIFF_FRAC.get=function(){return .012};Object.defineProperties(Jn,wv);var rs=function(){this._pts=null,this._data=null;var o=arguments[0],u=arguments[1];this._pts=o,this._data=u};rs.prototype.getCoordinates=function(){return this._pts};rs.prototype.size=function(){return this._pts.length};rs.prototype.getCoordinate=function(o){return this._pts[o]};rs.prototype.isClosed=function(){return this._pts[0].equals(this._pts[this._pts.length-1])};rs.prototype.getSegmentOctant=function(o){return o===this._pts.length-1?-1:eu.octant(this.getCoordinate(o),this.getCoordinate(o+1))};rs.prototype.setData=function(o){this._data=o};rs.prototype.getData=function(){return this._data};rs.prototype.toString=function(){return wo.toLineString(new an(this._pts))};rs.prototype.interfaces_=function(){return[Es]};rs.prototype.getClass=function(){return rs};var kn=function(){this._findAllIntersections=!1,this._isCheckEndSegmentsOnly=!1,this._li=null,this._interiorIntersection=null,this._intSegments=null,this._intersections=new jt,this._intersectionCount=0,this._keepIntersections=!0;var o=arguments[0];this._li=o,this._interiorIntersection=null};kn.prototype.getInteriorIntersection=function(){return this._interiorIntersection};kn.prototype.setCheckEndSegmentsOnly=function(o){this._isCheckEndSegmentsOnly=o};kn.prototype.getIntersectionSegments=function(){return this._intSegments};kn.prototype.count=function(){return this._intersectionCount};kn.prototype.getIntersections=function(){return this._intersections};kn.prototype.setFindAllIntersections=function(o){this._findAllIntersections=o};kn.prototype.setKeepIntersections=function(o){this._keepIntersections=o};kn.prototype.processIntersections=function(o,u,h,d){if(!this._findAllIntersections&&this.hasIntersection()||o===h&&u===d)return null;if(this._isCheckEndSegmentsOnly){var g=this.isEndSegment(o,u)||this.isEndSegment(h,d);if(!g)return null}var x=o.getCoordinates()[u],I=o.getCoordinates()[u+1],S=h.getCoordinates()[d],D=h.getCoordinates()[d+1];this._li.computeIntersection(x,I,S,D),this._li.hasIntersection()&&this._li.isInteriorIntersection()&&(this._intSegments=new Array(4).fill(null),this._intSegments[0]=x,this._intSegments[1]=I,this._intSegments[2]=S,this._intSegments[3]=D,this._interiorIntersection=this._li.getIntersection(0),this._keepIntersections&&this._intersections.add(this._interiorIntersection),this._intersectionCount++)};kn.prototype.isEndSegment=function(o,u){return u===0||u>=o.size()-2};kn.prototype.hasIntersection=function(){return this._interiorIntersection!==null};kn.prototype.isDone=function(){return this._findAllIntersections?!1:this._interiorIntersection!==null};kn.prototype.interfaces_=function(){return[wl]};kn.prototype.getClass=function(){return kn};kn.createAllIntersectionsFinder=function(o){var u=new kn(o);return u.setFindAllIntersections(!0),u};kn.createAnyIntersectionFinder=function(o){return new kn(o)};kn.createIntersectionCounter=function(o){var u=new kn(o);return u.setFindAllIntersections(!0),u.setKeepIntersections(!1),u};var Mo=function(){this._li=new Ml,this._segStrings=null,this._findAllIntersections=!1,this._segInt=null,this._isValid=!0;var o=arguments[0];this._segStrings=o};Mo.prototype.execute=function(){if(this._segInt!==null)return null;this.checkInteriorIntersections()};Mo.prototype.getIntersections=function(){return this._segInt.getIntersections()};Mo.prototype.isValid=function(){return this.execute(),this._isValid};Mo.prototype.setFindAllIntersections=function(o){this._findAllIntersections=o};Mo.prototype.checkInteriorIntersections=function(){this._isValid=!0,this._segInt=new kn(this._li),this._segInt.setFindAllIntersections(this._findAllIntersections);var o=new yv;if(o.setSegmentIntersector(this._segInt),o.computeNodes(this._segStrings),this._segInt.hasIntersection())return this._isValid=!1,null};Mo.prototype.checkValid=function(){if(this.execute(),!this._isValid)throw new $s(this.getErrorMessage(),this._segInt.getInteriorIntersection())};Mo.prototype.getErrorMessage=function(){if(this._isValid)return"no intersections found";var o=this._segInt.getIntersectionSegments();return"found non-noded intersection between "+wo.toLineString(o[0],o[1])+" and "+wo.toLineString(o[2],o[3])};Mo.prototype.interfaces_=function(){return[]};Mo.prototype.getClass=function(){return Mo};Mo.computeIntersections=function(o){var u=new Mo(o);return u.setFindAllIntersections(!0),u.isValid(),u.getIntersections()};var Il=function c(){this._nv=null;var o=arguments[0];this._nv=new Mo(c.toSegmentStrings(o))};Il.prototype.checkValid=function(){this._nv.checkValid()};Il.prototype.interfaces_=function(){return[]};Il.prototype.getClass=function(){return Il};Il.toSegmentStrings=function(o){for(var u=new jt,h=o.iterator();h.hasNext();){var d=h.next();u.add(new rs(d.getCoordinates(),d))}return u};Il.checkValid=function(o){var u=new Il(o);u.checkValid()};var au=function(o){this._mapOp=o};au.prototype.map=function(o){for(var u=this,h=new jt,d=0;d<o.getNumGeometries();d++){var g=u._mapOp.map(o.getGeometryN(d));g.isEmpty()||h.add(g)}return o.getFactory().createGeometryCollection(He.toGeometryArray(h))};au.prototype.interfaces_=function(){return[]};au.prototype.getClass=function(){return au};au.map=function(o,u){var h=new au(u);return h.map(o)};var ns=function(){this._op=null,this._geometryFactory=null,this._ptLocator=null,this._lineEdgesList=new jt,this._resultLineList=new jt;var o=arguments[0],u=arguments[1],h=arguments[2];this._op=o,this._geometryFactory=u,this._ptLocator=h};ns.prototype.collectLines=function(o){for(var u=this,h=this._op.getGraph().getEdgeEnds().iterator();h.hasNext();){var d=h.next();u.collectLineEdge(d,o,u._lineEdgesList),u.collectBoundaryTouchEdge(d,o,u._lineEdgesList)}};ns.prototype.labelIsolatedLine=function(o,u){var h=this._ptLocator.locate(o.getCoordinate(),this._op.getArgGeometry(u));o.getLabel().setLocation(u,h)};ns.prototype.build=function(o){return this.findCoveredLineEdges(),this.collectLines(o),this.buildLines(o),this._resultLineList};ns.prototype.collectLineEdge=function(o,u,h){var d=o.getLabel(),g=o.getEdge();o.isLineEdge()&&!o.isVisited()&&je.isResultOfOp(d,u)&&!g.isCovered()&&(h.add(g),o.setVisitedEdge(!0))};ns.prototype.findCoveredLineEdges=function(){for(var o=this,u=this._op.getGraph().getNodes().iterator();u.hasNext();){var h=u.next();h.getEdges().findCoveredLineEdges()}for(var d=this._op.getGraph().getEdgeEnds().iterator();d.hasNext();){var g=d.next(),x=g.getEdge();if(g.isLineEdge()&&!x.isCoveredSet()){var I=o._op.isCoveredByA(g.getCoordinate());x.setCovered(I)}}};ns.prototype.labelIsolatedLines=function(o){for(var u=this,h=o.iterator();h.hasNext();){var d=h.next(),g=d.getLabel();d.isIsolated()&&(g.isNull(0)?u.labelIsolatedLine(d,0):u.labelIsolatedLine(d,1))}};ns.prototype.buildLines=function(o){for(var u=this,h=this._lineEdgesList.iterator();h.hasNext();){var d=h.next(),g=u._geometryFactory.createLineString(d.getCoordinates());u._resultLineList.add(g),d.setInResult(!0)}};ns.prototype.collectBoundaryTouchEdge=function(o,u,h){var d=o.getLabel();if(o.isLineEdge()||o.isVisited()||o.isInteriorAreaEdge()||o.getEdge().isInResult())return null;Ze.isTrue(!(o.isInResult()||o.getSym().isInResult())||!o.getEdge().isInResult()),je.isResultOfOp(d,u)&&u===je.INTERSECTION&&(h.add(o.getEdge()),o.setVisitedEdge(!0))};ns.prototype.interfaces_=function(){return[]};ns.prototype.getClass=function(){return ns};var lu=function(){this._op=null,this._geometryFactory=null,this._resultPointList=new jt;var o=arguments[0],u=arguments[1];this._op=o,this._geometryFactory=u};lu.prototype.filterCoveredNodeToPoint=function(o){var u=o.getCoordinate();if(!this._op.isCoveredByLA(u)){var h=this._geometryFactory.createPoint(u);this._resultPointList.add(h)}};lu.prototype.extractNonCoveredResultNodes=function(o){for(var u=this,h=this._op.getGraph().getNodes().iterator();h.hasNext();){var d=h.next();if(!d.isInResult()&&!d.isIncidentEdgeInResult()&&(d.getEdges().getDegree()===0||o===je.INTERSECTION)){var g=d.getLabel();je.isResultOfOp(g,o)&&u.filterCoveredNodeToPoint(d)}}};lu.prototype.build=function(o){return this.extractNonCoveredResultNodes(o),this._resultPointList};lu.prototype.interfaces_=function(){return[]};lu.prototype.getClass=function(){return lu};var Ei=function(){this._inputGeom=null,this._factory=null,this._pruneEmptyGeometry=!0,this._preserveGeometryCollectionType=!0,this._preserveCollections=!1,this._preserveType=!1};Ei.prototype.transformPoint=function(o,u){return this._factory.createPoint(this.transformCoordinates(o.getCoordinateSequence(),o))};Ei.prototype.transformPolygon=function(o,u){var h=this,d=!0,g=this.transformLinearRing(o.getExteriorRing(),o);(g===null||!(g instanceof bs)||g.isEmpty())&&(d=!1);for(var x=new jt,I=0;I<o.getNumInteriorRing();I++){var S=h.transformLinearRing(o.getInteriorRingN(I),o);S===null||S.isEmpty()||(S instanceof bs||(d=!1),x.add(S))}if(d)return this._factory.createPolygon(g,x.toArray([]));var D=new jt;return g!==null&&D.add(g),D.addAll(x),this._factory.buildGeometry(D)};Ei.prototype.createCoordinateSequence=function(o){return this._factory.getCoordinateSequenceFactory().create(o)};Ei.prototype.getInputGeometry=function(){return this._inputGeom};Ei.prototype.transformMultiLineString=function(o,u){for(var h=this,d=new jt,g=0;g<o.getNumGeometries();g++){var x=h.transformLineString(o.getGeometryN(g),o);x!==null&&(x.isEmpty()||d.add(x))}return this._factory.buildGeometry(d)};Ei.prototype.transformCoordinates=function(o,u){return this.copy(o)};Ei.prototype.transformLineString=function(o,u){return this._factory.createLineString(this.transformCoordinates(o.getCoordinateSequence(),o))};Ei.prototype.transformMultiPoint=function(o,u){for(var h=this,d=new jt,g=0;g<o.getNumGeometries();g++){var x=h.transformPoint(o.getGeometryN(g),o);x!==null&&(x.isEmpty()||d.add(x))}return this._factory.buildGeometry(d)};Ei.prototype.transformMultiPolygon=function(o,u){for(var h=this,d=new jt,g=0;g<o.getNumGeometries();g++){var x=h.transformPolygon(o.getGeometryN(g),o);x!==null&&(x.isEmpty()||d.add(x))}return this._factory.buildGeometry(d)};Ei.prototype.copy=function(o){return o.copy()};Ei.prototype.transformGeometryCollection=function(o,u){for(var h=this,d=new jt,g=0;g<o.getNumGeometries();g++){var x=h.transform(o.getGeometryN(g));x!==null&&(h._pruneEmptyGeometry&&x.isEmpty()||d.add(x))}return this._preserveGeometryCollectionType?this._factory.createGeometryCollection(He.toGeometryArray(d)):this._factory.buildGeometry(d)};Ei.prototype.transform=function(o){if(this._inputGeom=o,this._factory=o.getFactory(),o instanceof Ci)return this.transformPoint(o,null);if(o instanceof Ic)return this.transformMultiPoint(o,null);if(o instanceof bs)return this.transformLinearRing(o,null);if(o instanceof nn)return this.transformLineString(o,null);if(o instanceof vl)return this.transformMultiLineString(o,null);if(o instanceof Cn)return this.transformPolygon(o,null);if(o instanceof ys)return this.transformMultiPolygon(o,null);if(o instanceof fi)return this.transformGeometryCollection(o,null);throw new Xr("Unknown Geometry subtype: "+o.getClass().getName())};Ei.prototype.transformLinearRing=function(o,u){var h=this.transformCoordinates(o.getCoordinateSequence(),o);if(h===null)return this._factory.createLinearRing(null);var d=h.size();return d>0&&d<4&&!this._preserveType?this._factory.createLineString(h):this._factory.createLinearRing(h)};Ei.prototype.interfaces_=function(){return[]};Ei.prototype.getClass=function(){return Ei};var Ss=function c(){if(this._snapTolerance=0,this._srcPts=null,this._seg=new he,this._allowSnappingToSourceVertices=!1,this._isClosed=!1,arguments[0]instanceof nn&&typeof arguments[1]=="number"){var o=arguments[0],u=arguments[1];c.call(this,o.getCoordinates(),u)}else if(arguments[0]instanceof Array&&typeof arguments[1]=="number"){var h=arguments[0],d=arguments[1];this._srcPts=h,this._isClosed=c.isClosed(h),this._snapTolerance=d}};Ss.prototype.snapVertices=function(o,u){for(var h=this,d=this._isClosed?o.size()-1:o.size(),g=0;g<d;g++){var x=o.get(g),I=h.findSnapForVertex(x,u);I!==null&&(o.set(g,new st(I)),g===0&&h._isClosed&&o.set(o.size()-1,new st(I)))}};Ss.prototype.findSnapForVertex=function(o,u){for(var h=this,d=0;d<u.length;d++){if(o.equals2D(u[d]))return null;if(o.distance(u[d])<h._snapTolerance)return u[d]}return null};Ss.prototype.snapTo=function(o){var u=new yp(this._srcPts);this.snapVertices(u,o),this.snapSegments(u,o);var h=u.toCoordinateArray();return h};Ss.prototype.snapSegments=function(o,u){var h=this;if(u.length===0)return null;var d=u.length;u[0].equals2D(u[u.length-1])&&(d=u.length-1);for(var g=0;g<d;g++){var x=u[g],I=h.findSegmentIndexToSnap(x,o);I>=0&&o.add(I+1,new st(x),!1)}};Ss.prototype.findSegmentIndexToSnap=function(o,u){for(var h=this,d=ke.MAX_VALUE,g=-1,x=0;x<u.size()-1;x++){if(h._seg.p0=u.get(x),h._seg.p1=u.get(x+1),h._seg.p0.equals2D(o)||h._seg.p1.equals2D(o)){if(h._allowSnappingToSourceVertices)continue;return-1}var I=h._seg.distance(o);I<h._snapTolerance&&I<d&&(d=I,g=x)}return g};Ss.prototype.setAllowSnappingToSourceVertices=function(o){this._allowSnappingToSourceVertices=o};Ss.prototype.interfaces_=function(){return[]};Ss.prototype.getClass=function(){return Ss};Ss.isClosed=function(o){return o.length<=1?!1:o[0].equals2D(o[o.length-1])};var ln=function(o){this._srcGeom=o||null},dI={SNAP_PRECISION_FACTOR:{configurable:!0}};ln.prototype.snapTo=function(o,u){var h=this.extractTargetCoordinates(o),d=new mI(u,h);return d.transform(this._srcGeom)};ln.prototype.snapToSelf=function(o,u){var h=this.extractTargetCoordinates(this._srcGeom),d=new mI(o,h,!0),g=d.transform(this._srcGeom),x=g;return u&&Ee(x,Ia)&&(x=g.buffer(0)),x};ln.prototype.computeSnapTolerance=function(o){var u=this.computeMinimumSegmentLength(o),h=u/10;return h};ln.prototype.extractTargetCoordinates=function(o){for(var u=new Yo,h=o.getCoordinates(),d=0;d<h.length;d++)u.add(h[d]);return u.toArray(new Array(0).fill(null))};ln.prototype.computeMinimumSegmentLength=function(o){for(var u=ke.MAX_VALUE,h=0;h<o.length-1;h++){var d=o[h].distance(o[h+1]);d<u&&(u=d)}return u};ln.prototype.interfaces_=function(){return[]};ln.prototype.getClass=function(){return ln};ln.snap=function(o,u,h){var d=new Array(2).fill(null),g=new ln(o);d[0]=g.snapTo(u,h);var x=new ln(u);return d[1]=x.snapTo(d[0],h),d};ln.computeOverlaySnapTolerance=function(){if(arguments.length===1){var o=arguments[0],u=ln.computeSizeBasedSnapTolerance(o),h=o.getPrecisionModel();if(h.getType()===fr.FIXED){var d=1/h.getScale()*2/1.415;d>u&&(u=d)}return u}else if(arguments.length===2){var g=arguments[0],x=arguments[1];return Math.min(ln.computeOverlaySnapTolerance(g),ln.computeOverlaySnapTolerance(x))}};ln.computeSizeBasedSnapTolerance=function(o){var u=o.getEnvelopeInternal(),h=Math.min(u.getHeight(),u.getWidth()),d=h*ln.SNAP_PRECISION_FACTOR;return d};ln.snapToSelf=function(o,u,h){var d=new ln(o);return d.snapToSelf(u,h)};dI.SNAP_PRECISION_FACTOR.get=function(){return 1e-9};Object.defineProperties(ln,dI);var mI=function(c){function o(u,h,d){c.call(this),this._snapTolerance=u||null,this._snapPts=h||null,this._isSelfSnap=d!==void 0?d:!1}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.snapLine=function(h,d){var g=new Ss(h,this._snapTolerance);return g.setAllowSnappingToSourceVertices(this._isSelfSnap),g.snapTo(d)},o.prototype.transformCoordinates=function(h,d){var g=h.toCoordinateArray(),x=this.snapLine(g,this._snapPts);return this._factory.getCoordinateSequenceFactory().create(x)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Ei),li=function(){this._isFirst=!0,this._commonMantissaBitsCount=53,this._commonBits=0,this._commonSignExp=null};li.prototype.getCommon=function(){return ke.longBitsToDouble(this._commonBits)};li.prototype.add=function(o){var u=ke.doubleToLongBits(o);if(this._isFirst)return this._commonBits=u,this._commonSignExp=li.signExpBits(this._commonBits),this._isFirst=!1,null;var h=li.signExpBits(u);if(h!==this._commonSignExp)return this._commonBits=0,null;this._commonMantissaBitsCount=li.numCommonMostSigMantissaBits(this._commonBits,u),this._commonBits=li.zeroLowerBits(this._commonBits,64-(12+this._commonMantissaBitsCount))};li.prototype.toString=function(){if(arguments.length===1){var o=arguments[0],u=ke.longBitsToDouble(o),h=ke.toBinaryString(o),d="0000000000000000000000000000000000000000000000000000000000000000"+h,g=d.substring(d.length-64),x=g.substring(0,1)+"  "+g.substring(1,12)+"(exp) "+g.substring(12)+" [ "+u+" ]";return x}};li.prototype.interfaces_=function(){return[]};li.prototype.getClass=function(){return li};li.getBit=function(o,u){var h=1<<u;return o&h?1:0};li.signExpBits=function(o){return o>>52};li.zeroLowerBits=function(o,u){var h=(1<<u)-1,d=~h,g=o&d;return g};li.numCommonMostSigMantissaBits=function(o,u){for(var h=0,d=52;d>=0;d--){if(li.getBit(o,d)!==li.getBit(u,d))return h;h++}return 52};var Da=function(){this._commonCoord=null,this._ccFilter=new uu},Ev={CommonCoordinateFilter:{configurable:!0},Translater:{configurable:!0}};Da.prototype.addCommonBits=function(o){var u=new Ra(this._commonCoord);o.apply(u),o.geometryChanged()};Da.prototype.removeCommonBits=function(o){if(this._commonCoord.x===0&&this._commonCoord.y===0)return o;var u=new st(this._commonCoord);u.x=-u.x,u.y=-u.y;var h=new Ra(u);return o.apply(h),o.geometryChanged(),o};Da.prototype.getCommonCoordinate=function(){return this._commonCoord};Da.prototype.add=function(o){o.apply(this._ccFilter),this._commonCoord=this._ccFilter.getCommonCoordinate()};Da.prototype.interfaces_=function(){return[]};Da.prototype.getClass=function(){return Da};Ev.CommonCoordinateFilter.get=function(){return uu};Ev.Translater.get=function(){return Ra};Object.defineProperties(Da,Ev);var uu=function(){this._commonBitsX=new li,this._commonBitsY=new li};uu.prototype.filter=function(o){this._commonBitsX.add(o.x),this._commonBitsY.add(o.y)};uu.prototype.getCommonCoordinate=function(){return new st(this._commonBitsX.getCommon(),this._commonBitsY.getCommon())};uu.prototype.interfaces_=function(){return[xs]};uu.prototype.getClass=function(){return uu};var Ra=function(){this.trans=null;var o=arguments[0];this.trans=o};Ra.prototype.filter=function(o,u){var h=o.getOrdinate(u,0)+this.trans.x,d=o.getOrdinate(u,1)+this.trans.y;o.setOrdinate(u,0,h),o.setOrdinate(u,1,d)};Ra.prototype.isDone=function(){return!1};Ra.prototype.isGeometryChanged=function(){return!0};Ra.prototype.interfaces_=function(){return[Eo]};Ra.prototype.getClass=function(){return Ra};var Fn=function(o,u){this._geom=new Array(2).fill(null),this._snapTolerance=null,this._cbr=null,this._geom[0]=o,this._geom[1]=u,this.computeSnapTolerance()};Fn.prototype.selfSnap=function(o){var u=new ln(o),h=u.snapTo(o,this._snapTolerance);return h};Fn.prototype.removeCommonBits=function(o){this._cbr=new Da,this._cbr.add(o[0]),this._cbr.add(o[1]);var u=new Array(2).fill(null);return u[0]=this._cbr.removeCommonBits(o[0].copy()),u[1]=this._cbr.removeCommonBits(o[1].copy()),u};Fn.prototype.prepareResult=function(o){return this._cbr.addCommonBits(o),o};Fn.prototype.getResultGeometry=function(o){var u=this.snap(this._geom),h=je.overlayOp(u[0],u[1],o);return this.prepareResult(h)};Fn.prototype.checkValid=function(o){o.isValid()||$n.out.println("Snapped geometry is invalid")};Fn.prototype.computeSnapTolerance=function(){this._snapTolerance=ln.computeOverlaySnapTolerance(this._geom[0],this._geom[1])};Fn.prototype.snap=function(o){var u=this.removeCommonBits(o),h=ln.snap(u[0],u[1],this._snapTolerance);return h};Fn.prototype.interfaces_=function(){return[]};Fn.prototype.getClass=function(){return Fn};Fn.overlayOp=function(o,u,h){var d=new Fn(o,u);return d.getResultGeometry(h)};Fn.union=function(o,u){return Fn.overlayOp(o,u,je.UNION)};Fn.intersection=function(o,u){return Fn.overlayOp(o,u,je.INTERSECTION)};Fn.symDifference=function(o,u){return Fn.overlayOp(o,u,je.SYMDIFFERENCE)};Fn.difference=function(o,u){return Fn.overlayOp(o,u,je.DIFFERENCE)};var gi=function(o,u){this._geom=new Array(2).fill(null),this._geom[0]=o,this._geom[1]=u};gi.prototype.getResultGeometry=function(o){var u=null,h=!1,d=null;try{u=je.overlayOp(this._geom[0],this._geom[1],o);var g=!0;g&&(h=!0)}catch(x){if(x instanceof Hs)d=x;else throw x}finally{}if(!h)try{u=Fn.overlayOp(this._geom[0],this._geom[1],o)}catch(x){throw x instanceof Hs?d:x}finally{}return u};gi.prototype.interfaces_=function(){return[]};gi.prototype.getClass=function(){return gi};gi.overlayOp=function(o,u,h){var d=new gi(o,u);return d.getResultGeometry(h)};gi.union=function(o,u){return gi.overlayOp(o,u,je.UNION)};gi.intersection=function(o,u){return gi.overlayOp(o,u,je.INTERSECTION)};gi.symDifference=function(o,u){return gi.overlayOp(o,u,je.SYMDIFFERENCE)};gi.difference=function(o,u){return gi.overlayOp(o,u,je.DIFFERENCE)};var cp=function(){this.mce=null,this.chainIndex=null;var o=arguments[0],u=arguments[1];this.mce=o,this.chainIndex=u};cp.prototype.computeIntersections=function(o,u){this.mce.computeIntersectsForChain(this.chainIndex,o.mce,o.chainIndex,u)};cp.prototype.interfaces_=function(){return[]};cp.prototype.getClass=function(){return cp};var Pi=function c(){if(this._label=null,this._xValue=null,this._eventType=null,this._insertEvent=null,this._deleteEventIndex=null,this._obj=null,arguments.length===2){var o=arguments[0],u=arguments[1];this._eventType=c.DELETE,this._xValue=o,this._insertEvent=u}else if(arguments.length===3){var h=arguments[0],d=arguments[1],g=arguments[2];this._eventType=c.INSERT,this._label=h,this._xValue=d,this._obj=g}},Tv={INSERT:{configurable:!0},DELETE:{configurable:!0}};Pi.prototype.isDelete=function(){return this._eventType===Pi.DELETE};Pi.prototype.setDeleteEventIndex=function(o){this._deleteEventIndex=o};Pi.prototype.getObject=function(){return this._obj};Pi.prototype.compareTo=function(o){var u=o;return this._xValue<u._xValue?-1:this._xValue>u._xValue?1:this._eventType<u._eventType?-1:this._eventType>u._eventType?1:0};Pi.prototype.getInsertEvent=function(){return this._insertEvent};Pi.prototype.isInsert=function(){return this._eventType===Pi.INSERT};Pi.prototype.isSameLabel=function(o){return this._label===null?!1:this._label===o._label};Pi.prototype.getDeleteEventIndex=function(){return this._deleteEventIndex};Pi.prototype.interfaces_=function(){return[uo]};Pi.prototype.getClass=function(){return Pi};Tv.INSERT.get=function(){return 1};Tv.DELETE.get=function(){return 2};Object.defineProperties(Pi,Tv);var qd=function(){};qd.prototype.interfaces_=function(){return[]};qd.prototype.getClass=function(){return qd};var Qn=function(){this._hasIntersection=!1,this._hasProper=!1,this._hasProperInterior=!1,this._properIntersectionPoint=null,this._li=null,this._includeProper=null,this._recordIsolated=null,this._isSelfIntersection=null,this._numIntersections=0,this.numTests=0,this._bdyNodes=null,this._isDone=!1,this._isDoneWhenProperInt=!1;var o=arguments[0],u=arguments[1],h=arguments[2];this._li=o,this._includeProper=u,this._recordIsolated=h};Qn.prototype.isTrivialIntersection=function(o,u,h,d){if(o===h&&this._li.getIntersectionNum()===1){if(Qn.isAdjacentSegments(u,d))return!0;if(o.isClosed()){var g=o.getNumPoints()-1;if(u===0&&d===g||d===0&&u===g)return!0}}return!1};Qn.prototype.getProperIntersectionPoint=function(){return this._properIntersectionPoint};Qn.prototype.setIsDoneIfProperInt=function(o){this._isDoneWhenProperInt=o};Qn.prototype.hasProperInteriorIntersection=function(){return this._hasProperInterior};Qn.prototype.isBoundaryPointInternal=function(o,u){for(var h=u.iterator();h.hasNext();){var d=h.next(),g=d.getCoordinate();if(o.isIntersection(g))return!0}return!1};Qn.prototype.hasProperIntersection=function(){return this._hasProper};Qn.prototype.hasIntersection=function(){return this._hasIntersection};Qn.prototype.isDone=function(){return this._isDone};Qn.prototype.isBoundaryPoint=function(o,u){return u===null?!1:!!(this.isBoundaryPointInternal(o,u[0])||this.isBoundaryPointInternal(o,u[1]))};Qn.prototype.setBoundaryNodes=function(o,u){this._bdyNodes=new Array(2).fill(null),this._bdyNodes[0]=o,this._bdyNodes[1]=u};Qn.prototype.addIntersections=function(o,u,h,d){if(o===h&&u===d)return null;this.numTests++;var g=o.getCoordinates()[u],x=o.getCoordinates()[u+1],I=h.getCoordinates()[d],S=h.getCoordinates()[d+1];this._li.computeIntersection(g,x,I,S),this._li.hasIntersection()&&(this._recordIsolated&&(o.setIsolated(!1),h.setIsolated(!1)),this._numIntersections++,this.isTrivialIntersection(o,u,h,d)||(this._hasIntersection=!0,(this._includeProper||!this._li.isProper())&&(o.addIntersections(this._li,u,0),h.addIntersections(this._li,d,1)),this._li.isProper()&&(this._properIntersectionPoint=this._li.getIntersection(0).copy(),this._hasProper=!0,this._isDoneWhenProperInt&&(this._isDone=!0),this.isBoundaryPoint(this._li,this._bdyNodes)||(this._hasProperInterior=!0))))};Qn.prototype.interfaces_=function(){return[]};Qn.prototype.getClass=function(){return Qn};Qn.isAdjacentSegments=function(o,u){return Math.abs(o-u)===1};var vO=function(c){function o(){c.call(this),this.events=new jt,this.nOverlaps=null}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.prepareEvents=function(){var h=this;Io.sort(this.events);for(var d=0;d<this.events.size();d++){var g=h.events.get(d);g.isDelete()&&g.getInsertEvent().setDeleteEventIndex(d)}},o.prototype.computeIntersections=function(){var h=this;if(arguments.length===1){var d=arguments[0];this.nOverlaps=0,this.prepareEvents();for(var g=0;g<this.events.size();g++){var x=h.events.get(g);if(x.isInsert()&&h.processOverlaps(g,x.getDeleteEventIndex(),x,d),d.isDone())break}}else if(arguments.length===3){if(arguments[2]instanceof Qn&&Ee(arguments[0],bo)&&Ee(arguments[1],bo)){var I=arguments[0],S=arguments[1],D=arguments[2];this.addEdges(I,I),this.addEdges(S,S),this.computeIntersections(D)}else if(typeof arguments[2]=="boolean"&&Ee(arguments[0],bo)&&arguments[1]instanceof Qn){var O=arguments[0],B=arguments[1],W=arguments[2];W?this.addEdges(O,null):this.addEdges(O),this.computeIntersections(B)}}},o.prototype.addEdge=function(h,d){for(var g=this,x=h.getMonotoneChainEdge(),I=x.getStartIndexes(),S=0;S<I.length-1;S++){var D=new cp(x,S),O=new Pi(d,x.getMinX(S),D);g.events.add(O),g.events.add(new Pi(x.getMaxX(S),O))}},o.prototype.processOverlaps=function(h,d,g,x){for(var I=this,S=g.getObject(),D=h;D<d;D++){var O=I.events.get(D);if(O.isInsert()){var B=O.getObject();g.isSameLabel(O)||(S.computeIntersections(B,x),I.nOverlaps++)}}},o.prototype.addEdges=function(){var h=this;if(arguments.length===1)for(var d=arguments[0],g=d.iterator();g.hasNext();){var x=g.next();h.addEdge(x,x)}else if(arguments.length===2)for(var I=arguments[0],S=arguments[1],D=I.iterator();D.hasNext();){var O=D.next();h.addEdge(O,S)}},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(qd),Cs=function(){this._min=ke.POSITIVE_INFINITY,this._max=ke.NEGATIVE_INFINITY},gI={NodeComparator:{configurable:!0}};Cs.prototype.getMin=function(){return this._min};Cs.prototype.intersects=function(o,u){return!(this._min>u||this._max<o)};Cs.prototype.getMax=function(){return this._max};Cs.prototype.toString=function(){return wo.toLineString(new st(this._min,0),new st(this._max,0))};Cs.prototype.interfaces_=function(){return[]};Cs.prototype.getClass=function(){return Cs};gI.NodeComparator.get=function(){return hp};Object.defineProperties(Cs,gI);var hp=function(){};hp.prototype.compare=function(o,u){var h=o,d=u,g=(h._min+h._max)/2,x=(d._min+d._max)/2;return g<x?-1:g>x?1:0};hp.prototype.interfaces_=function(){return[yc]};hp.prototype.getClass=function(){return hp};var xO=function(c){function o(){c.call(this),this._item=null;var u=arguments[0],h=arguments[1],d=arguments[2];this._min=u,this._max=h,this._item=d}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.query=function(h,d,g){if(!this.intersects(h,d))return null;g.visitItem(this._item)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Cs),bO=function(c){function o(){c.call(this),this._node1=null,this._node2=null;var u=arguments[0],h=arguments[1];this._node1=u,this._node2=h,this.buildExtent(this._node1,this._node2)}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.buildExtent=function(h,d){this._min=Math.min(h._min,d._min),this._max=Math.max(h._max,d._max)},o.prototype.query=function(h,d,g){if(!this.intersects(h,d))return null;this._node1!==null&&this._node1.query(h,d,g),this._node2!==null&&this._node2.query(h,d,g)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Cs),Ms=function(){this._leaves=new jt,this._root=null,this._level=0};Ms.prototype.buildTree=function(){var o=this;Io.sort(this._leaves,new Cs.NodeComparator);for(var u=this._leaves,h=null,d=new jt;;){if(o.buildLevel(u,d),d.size()===1)return d.get(0);h=u,u=d,d=h}};Ms.prototype.insert=function(o,u,h){if(this._root!==null)throw new Error("Index cannot be added to once it has been queried");this._leaves.add(new xO(o,u,h))};Ms.prototype.query=function(o,u,h){this.init(),this._root.query(o,u,h)};Ms.prototype.buildRoot=function(){if(this._root!==null)return null;this._root=this.buildTree()};Ms.prototype.printNode=function(o){$n.out.println(wo.toLineString(new st(o._min,this._level),new st(o._max,this._level)))};Ms.prototype.init=function(){if(this._root!==null)return null;this.buildRoot()};Ms.prototype.buildLevel=function(o,u){this._level++,u.clear();for(var h=0;h<o.size();h+=2){var d=o.get(h),g=h+1<o.size()?o.get(h):null;if(g===null)u.add(d);else{var x=new bO(o.get(h),o.get(h+1));u.add(x)}}};Ms.prototype.interfaces_=function(){return[]};Ms.prototype.getClass=function(){return Ms};var Lc=function(){this._items=new jt};Lc.prototype.visitItem=function(o){this._items.add(o)};Lc.prototype.getItems=function(){return this._items};Lc.prototype.interfaces_=function(){return[Sa]};Lc.prototype.getClass=function(){return Lc};var Dc=function(){this._index=null;var o=arguments[0];if(!Ee(o,Ia))throw new Xr("Argument must be Polygonal");this._index=new Sl(o)},Iv={SegmentVisitor:{configurable:!0},IntervalIndexedGeometry:{configurable:!0}};Dc.prototype.locate=function(o){var u=new Xo(o),h=new Rc(u);return this._index.query(o.y,o.y,h),u.getLocation()};Dc.prototype.interfaces_=function(){return[Ac]};Dc.prototype.getClass=function(){return Dc};Iv.SegmentVisitor.get=function(){return Rc};Iv.IntervalIndexedGeometry.get=function(){return Sl};Object.defineProperties(Dc,Iv);var Rc=function(){this._counter=null;var o=arguments[0];this._counter=o};Rc.prototype.visitItem=function(o){var u=o;this._counter.countSegment(u.getCoordinate(0),u.getCoordinate(1))};Rc.prototype.interfaces_=function(){return[Sa]};Rc.prototype.getClass=function(){return Rc};var Sl=function(){this._index=new Ms;var o=arguments[0];this.init(o)};Sl.prototype.init=function(o){for(var u=this,h=Wn.getLines(o),d=h.iterator();d.hasNext();){var g=d.next(),x=g.getCoordinates();u.addLine(x)}};Sl.prototype.addLine=function(o){for(var u=this,h=1;h<o.length;h++){var d=new he(o[h-1],o[h]),g=Math.min(d.p0.y,d.p1.y),x=Math.max(d.p0.y,d.p1.y);u._index.insert(g,x,d)}};Sl.prototype.query=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1],h=new Lc;return this._index.query(o,u,h),h.getItems()}else if(arguments.length===3){var d=arguments[0],g=arguments[1],x=arguments[2];this._index.query(d,g,x)}};Sl.prototype.interfaces_=function(){return[]};Sl.prototype.getClass=function(){return Sl};var $h=function(c){function o(){if(c.call(this),this._parentGeom=null,this._lineEdgeMap=new QT,this._boundaryNodeRule=null,this._useBoundaryDeterminationRule=!0,this._argIndex=null,this._boundaryNodes=null,this._hasTooFewPoints=!1,this._invalidPoint=null,this._areaPtLocator=null,this._ptLocator=new Co,arguments.length===2){var u=arguments[0],h=arguments[1],d=so.OGC_SFS_BOUNDARY_RULE;this._argIndex=u,this._parentGeom=h,this._boundaryNodeRule=d,h!==null&&this.add(h)}else if(arguments.length===3){var g=arguments[0],x=arguments[1],I=arguments[2];this._argIndex=g,this._parentGeom=x,this._boundaryNodeRule=I,x!==null&&this.add(x)}}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.insertBoundaryPoint=function(h,d){var g=this._nodes.addNode(d),x=g.getLabel(),I=1,S=ut.NONE;S=x.getLocation(h,zt.ON),S===ut.BOUNDARY&&I++;var D=o.determineBoundary(this._boundaryNodeRule,I);x.setLocation(h,D)},o.prototype.computeSelfNodes=function(){if(arguments.length===2){var h=arguments[0],d=arguments[1];return this.computeSelfNodes(h,d,!1)}else if(arguments.length===3){var g=arguments[0],x=arguments[1],I=arguments[2],S=new Qn(g,!0,!1);S.setIsDoneIfProperInt(I);var D=this.createEdgeSetIntersector(),O=this._parentGeom instanceof bs||this._parentGeom instanceof Cn||this._parentGeom instanceof ys,B=x||!O;return D.computeIntersections(this._edges,S,B),this.addSelfIntersectionNodes(this._argIndex),S}},o.prototype.computeSplitEdges=function(h){for(var d=this._edges.iterator();d.hasNext();){var g=d.next();g.eiList.addSplitEdges(h)}},o.prototype.computeEdgeIntersections=function(h,d,g){var x=new Qn(d,g,!0);x.setBoundaryNodes(this.getBoundaryNodes(),h.getBoundaryNodes());var I=this.createEdgeSetIntersector();return I.computeIntersections(this._edges,h._edges,x),x},o.prototype.getGeometry=function(){return this._parentGeom},o.prototype.getBoundaryNodeRule=function(){return this._boundaryNodeRule},o.prototype.hasTooFewPoints=function(){return this._hasTooFewPoints},o.prototype.addPoint=function(){if(arguments[0]instanceof Ci){var h=arguments[0],d=h.getCoordinate();this.insertPoint(this._argIndex,d,ut.INTERIOR)}else if(arguments[0]instanceof st){var g=arguments[0];this.insertPoint(this._argIndex,g,ut.INTERIOR)}},o.prototype.addPolygon=function(h){var d=this;this.addPolygonRing(h.getExteriorRing(),ut.EXTERIOR,ut.INTERIOR);for(var g=0;g<h.getNumInteriorRing();g++){var x=h.getInteriorRingN(g);d.addPolygonRing(x,ut.INTERIOR,ut.EXTERIOR)}},o.prototype.addEdge=function(h){this.insertEdge(h);var d=h.getCoordinates();this.insertPoint(this._argIndex,d[0],ut.BOUNDARY),this.insertPoint(this._argIndex,d[d.length-1],ut.BOUNDARY)},o.prototype.addLineString=function(h){var d=Ye.removeRepeatedPoints(h.getCoordinates());if(d.length<2)return this._hasTooFewPoints=!0,this._invalidPoint=d[0],null;var g=new jd(d,new xr(this._argIndex,ut.INTERIOR));this._lineEdgeMap.put(h,g),this.insertEdge(g),Ze.isTrue(d.length>=2,"found LineString with single point"),this.insertBoundaryPoint(this._argIndex,d[0]),this.insertBoundaryPoint(this._argIndex,d[d.length-1])},o.prototype.getInvalidPoint=function(){return this._invalidPoint},o.prototype.getBoundaryPoints=function(){for(var h=this.getBoundaryNodes(),d=new Array(h.size()).fill(null),g=0,x=h.iterator();x.hasNext();){var I=x.next();d[g++]=I.getCoordinate().copy()}return d},o.prototype.getBoundaryNodes=function(){return this._boundaryNodes===null&&(this._boundaryNodes=this._nodes.getBoundaryNodes(this._argIndex)),this._boundaryNodes},o.prototype.addSelfIntersectionNode=function(h,d,g){if(this.isBoundaryNode(h,d))return null;g===ut.BOUNDARY&&this._useBoundaryDeterminationRule?this.insertBoundaryPoint(h,d):this.insertPoint(h,d,g)},o.prototype.addPolygonRing=function(h,d,g){if(h.isEmpty())return null;var x=Ye.removeRepeatedPoints(h.getCoordinates());if(x.length<4)return this._hasTooFewPoints=!0,this._invalidPoint=x[0],null;var I=d,S=g;Kt.isCCW(x)&&(I=g,S=d);var D=new jd(x,new xr(this._argIndex,ut.BOUNDARY,I,S));this._lineEdgeMap.put(h,D),this.insertEdge(D),this.insertPoint(this._argIndex,x[0],ut.BOUNDARY)},o.prototype.insertPoint=function(h,d,g){var x=this._nodes.addNode(d),I=x.getLabel();I===null?x._label=new xr(h,g):I.setLocation(h,g)},o.prototype.createEdgeSetIntersector=function(){return new vO},o.prototype.addSelfIntersectionNodes=function(h){for(var d=this,g=this._edges.iterator();g.hasNext();)for(var x=g.next(),I=x.getLabel().getLocation(h),S=x.eiList.iterator();S.hasNext();){var D=S.next();d.addSelfIntersectionNode(h,D.coord,I)}},o.prototype.add=function(){if(arguments.length===1){var h=arguments[0];if(h.isEmpty())return null;if(h instanceof ys&&(this._useBoundaryDeterminationRule=!1),h instanceof Cn)this.addPolygon(h);else if(h instanceof nn)this.addLineString(h);else if(h instanceof Ci)this.addPoint(h);else if(h instanceof Ic)this.addCollection(h);else if(h instanceof vl)this.addCollection(h);else if(h instanceof ys)this.addCollection(h);else if(h instanceof fi)this.addCollection(h);else throw new Error(h.getClass().getName())}else return c.prototype.add.apply(this,arguments)},o.prototype.addCollection=function(h){for(var d=this,g=0;g<h.getNumGeometries();g++){var x=h.getGeometryN(g);d.add(x)}},o.prototype.locate=function(h){return Ee(this._parentGeom,Ia)&&this._parentGeom.getNumGeometries()>50?(this._areaPtLocator===null&&(this._areaPtLocator=new Dc(this._parentGeom)),this._areaPtLocator.locate(h)):this._ptLocator.locate(h,this._parentGeom)},o.prototype.findEdge=function(){if(arguments.length===1){var h=arguments[0];return this._lineEdgeMap.get(h)}else return c.prototype.findEdge.apply(this,arguments)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o.determineBoundary=function(h,d){return h.isInBoundary(d)?ut.BOUNDARY:ut.INTERIOR},o}(Kr),Oc=function(){if(this._li=new Ml,this._resultPrecisionModel=null,this._arg=null,arguments.length===1){var o=arguments[0];this.setComputationPrecision(o.getPrecisionModel()),this._arg=new Array(1).fill(null),this._arg[0]=new $h(0,o)}else if(arguments.length===2){var u=arguments[0],h=arguments[1],d=so.OGC_SFS_BOUNDARY_RULE;u.getPrecisionModel().compareTo(h.getPrecisionModel())>=0?this.setComputationPrecision(u.getPrecisionModel()):this.setComputationPrecision(h.getPrecisionModel()),this._arg=new Array(2).fill(null),this._arg[0]=new $h(0,u,d),this._arg[1]=new $h(1,h,d)}else if(arguments.length===3){var g=arguments[0],x=arguments[1],I=arguments[2];g.getPrecisionModel().compareTo(x.getPrecisionModel())>=0?this.setComputationPrecision(g.getPrecisionModel()):this.setComputationPrecision(x.getPrecisionModel()),this._arg=new Array(2).fill(null),this._arg[0]=new $h(0,g,I),this._arg[1]=new $h(1,x,I)}};Oc.prototype.getArgGeometry=function(o){return this._arg[o].getGeometry()};Oc.prototype.setComputationPrecision=function(o){this._resultPrecisionModel=o,this._li.setPrecisionModel(this._resultPrecisionModel)};Oc.prototype.interfaces_=function(){return[]};Oc.prototype.getClass=function(){return Oc};var yl=function(){};yl.prototype.interfaces_=function(){return[]};yl.prototype.getClass=function(){return yl};yl.map=function(){if(arguments[0]instanceof be&&Ee(arguments[1],yl.MapOp)){for(var o=arguments[0],u=arguments[1],h=new jt,d=0;d<o.getNumGeometries();d++){var g=u.map(o.getGeometryN(d));g!==null&&h.add(g)}return o.getFactory().buildGeometry(h)}else if(Ee(arguments[0],En)&&Ee(arguments[1],yl.MapOp)){for(var x=arguments[0],I=arguments[1],S=new jt,D=x.iterator();D.hasNext();){var O=D.next(),B=I.map(O);B!==null&&S.add(B)}return S}};yl.MapOp=function(){};var je=function(c){function o(){var u=arguments[0],h=arguments[1];c.call(this,u,h),this._ptLocator=new Co,this._geomFact=null,this._resultGeom=null,this._graph=null,this._edgeList=new So,this._resultPolyList=new jt,this._resultLineList=new jt,this._resultPointList=new jt,this._graph=new Kr(new aI),this._geomFact=u.getFactory()}return c&&(o.__proto__=c),o.prototype=Object.create(c&&c.prototype),o.prototype.constructor=o,o.prototype.insertUniqueEdge=function(h){var d=this._edgeList.findEqualEdge(h);if(d!==null){var g=d.getLabel(),x=h.getLabel();d.isPointwiseEqual(h)||(x=new xr(h.getLabel()),x.flip());var I=d.getDepth();I.isNull()&&I.add(g),I.add(x),g.merge(x)}else this._edgeList.add(h)},o.prototype.getGraph=function(){return this._graph},o.prototype.cancelDuplicateResultEdges=function(){for(var h=this._graph.getEdgeEnds().iterator();h.hasNext();){var d=h.next(),g=d.getSym();d.isInResult()&&g.isInResult()&&(d.setInResult(!1),g.setInResult(!1))}},o.prototype.isCoveredByLA=function(h){return!!(this.isCovered(h,this._resultLineList)||this.isCovered(h,this._resultPolyList))},o.prototype.computeGeometry=function(h,d,g,x){var I=new jt;return I.addAll(h),I.addAll(d),I.addAll(g),I.isEmpty()?o.createEmptyResult(x,this._arg[0].getGeometry(),this._arg[1].getGeometry(),this._geomFact):this._geomFact.buildGeometry(I)},o.prototype.mergeSymLabels=function(){for(var h=this._graph.getNodes().iterator();h.hasNext();){var d=h.next();d.getEdges().mergeSymLabels()}},o.prototype.isCovered=function(h,d){for(var g=this,x=d.iterator();x.hasNext();){var I=x.next(),S=g._ptLocator.locate(h,I);if(S!==ut.EXTERIOR)return!0}return!1},o.prototype.replaceCollapsedEdges=function(){for(var h=new jt,d=this._edgeList.iterator();d.hasNext();){var g=d.next();g.isCollapsed()&&(d.remove(),h.add(g.getCollapsedEdge()))}this._edgeList.addAll(h)},o.prototype.updateNodeLabelling=function(){for(var h=this._graph.getNodes().iterator();h.hasNext();){var d=h.next(),g=d.getEdges().getLabel();d.getLabel().merge(g)}},o.prototype.getResultGeometry=function(h){return this.computeOverlay(h),this._resultGeom},o.prototype.insertUniqueEdges=function(h){for(var d=this,g=h.iterator();g.hasNext();){var x=g.next();d.insertUniqueEdge(x)}},o.prototype.computeOverlay=function(h){this.copyPoints(0),this.copyPoints(1),this._arg[0].computeSelfNodes(this._li,!1),this._arg[1].computeSelfNodes(this._li,!1),this._arg[0].computeEdgeIntersections(this._arg[1],this._li,!0);var d=new jt;this._arg[0].computeSplitEdges(d),this._arg[1].computeSplitEdges(d),this.insertUniqueEdges(d),this.computeLabelsFromDepths(),this.replaceCollapsedEdges(),Il.checkValid(this._edgeList.getEdges()),this._graph.addEdges(this._edgeList.getEdges()),this.computeLabelling(),this.labelIncompleteNodes(),this.findResultAreaEdges(h),this.cancelDuplicateResultEdges();var g=new Mi(this._geomFact);g.add(this._graph),this._resultPolyList=g.getPolygons();var x=new ns(this,this._geomFact,this._ptLocator);this._resultLineList=x.build(h);var I=new lu(this,this._geomFact,this._ptLocator);this._resultPointList=I.build(h),this._resultGeom=this.computeGeometry(this._resultPointList,this._resultLineList,this._resultPolyList,h)},o.prototype.labelIncompleteNode=function(h,d){var g=this._ptLocator.locate(h.getCoordinate(),this._arg[d].getGeometry());h.getLabel().setLocation(d,g)},o.prototype.copyPoints=function(h){for(var d=this,g=this._arg[h].getNodeIterator();g.hasNext();){var x=g.next(),I=d._graph.addNode(x.getCoordinate());I.setLabel(h,x.getLabel().getLocation(h))}},o.prototype.findResultAreaEdges=function(h){for(var d=this._graph.getEdgeEnds().iterator();d.hasNext();){var g=d.next(),x=g.getLabel();x.isArea()&&!g.isInteriorAreaEdge()&&o.isResultOfOp(x.getLocation(0,zt.RIGHT),x.getLocation(1,zt.RIGHT),h)&&g.setInResult(!0)}},o.prototype.computeLabelsFromDepths=function(){for(var h=this._edgeList.iterator();h.hasNext();){var d=h.next(),g=d.getLabel(),x=d.getDepth();if(!x.isNull()){x.normalize();for(var I=0;I<2;I++)!g.isNull(I)&&g.isArea()&&!x.isNull(I)&&(x.getDelta(I)===0?g.toLine(I):(Ze.isTrue(!x.isNull(I,zt.LEFT),"depth of LEFT side has not been initialized"),g.setLocation(I,zt.LEFT,x.getLocation(I,zt.LEFT)),Ze.isTrue(!x.isNull(I,zt.RIGHT),"depth of RIGHT side has not been initialized"),g.setLocation(I,zt.RIGHT,x.getLocation(I,zt.RIGHT))))}}},o.prototype.computeLabelling=function(){for(var h=this,d=this._graph.getNodes().iterator();d.hasNext();){var g=d.next();g.getEdges().computeLabelling(h._arg)}this.mergeSymLabels(),this.updateNodeLabelling()},o.prototype.labelIncompleteNodes=function(){for(var h=this,d=this._graph.getNodes().iterator();d.hasNext();){var g=d.next(),x=g.getLabel();g.isIsolated()&&(x.isNull(0)?h.labelIncompleteNode(g,0):h.labelIncompleteNode(g,1)),g.getEdges().updateLabelling(x)}},o.prototype.isCoveredByA=function(h){return!!this.isCovered(h,this._resultPolyList)},o.prototype.interfaces_=function(){return[]},o.prototype.getClass=function(){return o},o}(Oc);je.overlayOp=function(c,o,u){var h=new je(c,o),d=h.getResultGeometry(u);return d};je.intersection=function(c,o){if(c.isEmpty()||o.isEmpty())return je.createEmptyResult(je.INTERSECTION,c,o,c.getFactory());if(c.isGeometryCollection()){var u=o;return au.map(c,{interfaces_:function(){return[yl.MapOp]},map:function(h){return h.intersection(u)}})}return c.checkNotGeometryCollection(c),c.checkNotGeometryCollection(o),gi.overlayOp(c,o,je.INTERSECTION)};je.symDifference=function(c,o){if(c.isEmpty()||o.isEmpty()){if(c.isEmpty()&&o.isEmpty())return je.createEmptyResult(je.SYMDIFFERENCE,c,o,c.getFactory());if(c.isEmpty())return o.copy();if(o.isEmpty())return c.copy()}return c.checkNotGeometryCollection(c),c.checkNotGeometryCollection(o),gi.overlayOp(c,o,je.SYMDIFFERENCE)};je.resultDimension=function(c,o,u){var h=o.getDimension(),d=u.getDimension(),g=-1;switch(c){case je.INTERSECTION:g=Math.min(h,d);break;case je.UNION:g=Math.max(h,d);break;case je.DIFFERENCE:g=h;break;case je.SYMDIFFERENCE:g=Math.max(h,d);break}return g};je.createEmptyResult=function(c,o,u,h){var d=null;switch(je.resultDimension(c,o,u)){case-1:d=h.createGeometryCollection(new Array(0).fill(null));break;case 0:d=h.createPoint();break;case 1:d=h.createLineString();break;case 2:d=h.createPolygon();break}return d};je.difference=function(c,o){return c.isEmpty()?je.createEmptyResult(je.DIFFERENCE,c,o,c.getFactory()):o.isEmpty()?c.copy():(c.checkNotGeometryCollection(c),c.checkNotGeometryCollection(o),gi.overlayOp(c,o,je.DIFFERENCE))};je.isResultOfOp=function(){if(arguments.length===2){var c=arguments[0],o=arguments[1],u=c.getLocation(0),h=c.getLocation(1);return je.isResultOfOp(u,h,o)}else if(arguments.length===3){var d=arguments[0],g=arguments[1],x=arguments[2];switch(d===ut.BOUNDARY&&(d=ut.INTERIOR),g===ut.BOUNDARY&&(g=ut.INTERIOR),x){case je.INTERSECTION:return d===ut.INTERIOR&&g===ut.INTERIOR;case je.UNION:return d===ut.INTERIOR||g===ut.INTERIOR;case je.DIFFERENCE:return d===ut.INTERIOR&&g!==ut.INTERIOR;case je.SYMDIFFERENCE:return d===ut.INTERIOR&&g!==ut.INTERIOR||d!==ut.INTERIOR&&g===ut.INTERIOR}return!1}};je.INTERSECTION=1;je.UNION=2;je.DIFFERENCE=3;je.SYMDIFFERENCE=4;var Ta=function(){this._g=null,this._boundaryDistanceTolerance=null,this._linework=null,this._ptLocator=new Co,this._seg=new he;var o=arguments[0],u=arguments[1];this._g=o,this._boundaryDistanceTolerance=u,this._linework=this.extractLinework(o)};Ta.prototype.isWithinToleranceOfBoundary=function(o){for(var u=this,h=0;h<this._linework.getNumGeometries();h++)for(var d=u._linework.getGeometryN(h),g=d.getCoordinateSequence(),x=0;x<g.size()-1;x++){g.getCoordinate(x,u._seg.p0),g.getCoordinate(x+1,u._seg.p1);var I=u._seg.distance(o);if(I<=u._boundaryDistanceTolerance)return!0}return!1};Ta.prototype.getLocation=function(o){return this.isWithinToleranceOfBoundary(o)?ut.BOUNDARY:this._ptLocator.locate(o,this._g)};Ta.prototype.extractLinework=function(o){var u=new Nc;o.apply(u);var h=u.getLinework(),d=He.toLineStringArray(h);return o.getFactory().createMultiLineString(d)};Ta.prototype.interfaces_=function(){return[]};Ta.prototype.getClass=function(){return Ta};var Nc=function(){this._linework=null,this._linework=new jt};Nc.prototype.getLinework=function(){return this._linework};Nc.prototype.filter=function(o){var u=this;if(o instanceof Cn){var h=o;this._linework.add(h.getExteriorRing());for(var d=0;d<h.getNumInteriorRing();d++)u._linework.add(h.getInteriorRingN(d))}};Nc.prototype.interfaces_=function(){return[$o]};Nc.prototype.getClass=function(){return Nc};var Cl=function(){this._g=null,this._doLeft=!0,this._doRight=!0;var o=arguments[0];this._g=o};Cl.prototype.extractPoints=function(o,u,h){for(var d=this,g=o.getCoordinates(),x=0;x<g.length-1;x++)d.computeOffsetPoints(g[x],g[x+1],u,h)};Cl.prototype.setSidesToGenerate=function(o,u){this._doLeft=o,this._doRight=u};Cl.prototype.getPoints=function(o){for(var u=this,h=new jt,d=Wn.getLines(this._g),g=d.iterator();g.hasNext();){var x=g.next();u.extractPoints(x,o,h)}return h};Cl.prototype.computeOffsetPoints=function(o,u,h,d){var g=u.x-o.x,x=u.y-o.y,I=Math.sqrt(g*g+x*x),S=h*g/I,D=h*x/I,O=(u.x+o.x)/2,B=(u.y+o.y)/2;if(this._doLeft){var W=new st(O-D,B+S);d.add(W)}if(this._doRight){var et=new st(O+D,B-S);d.add(et)}};Cl.prototype.interfaces_=function(){return[]};Cl.prototype.getClass=function(){return Cl};var qi=function c(){this._geom=null,this._locFinder=null,this._location=new Array(3).fill(null),this._invalidLocation=null,this._boundaryDistanceTolerance=c.TOLERANCE,this._testCoords=new jt;var o=arguments[0],u=arguments[1],h=arguments[2];this._boundaryDistanceTolerance=c.computeBoundaryDistanceTolerance(o,u),this._geom=[o,u,h],this._locFinder=[new Ta(this._geom[0],this._boundaryDistanceTolerance),new Ta(this._geom[1],this._boundaryDistanceTolerance),new Ta(this._geom[2],this._boundaryDistanceTolerance)]},_I={TOLERANCE:{configurable:!0}};qi.prototype.reportResult=function(o,u,h){$n.out.println("Overlay result invalid - A:"+ut.toLocationSymbol(u[0])+" B:"+ut.toLocationSymbol(u[1])+" expected:"+(h?"i":"e")+" actual:"+ut.toLocationSymbol(u[2]))};qi.prototype.isValid=function(o){this.addTestPts(this._geom[0]),this.addTestPts(this._geom[1]);var u=this.checkValid(o);return u};qi.prototype.checkValid=function(){var o=this;if(arguments.length===1){for(var u=arguments[0],h=0;h<this._testCoords.size();h++){var d=o._testCoords.get(h);if(!o.checkValid(u,d))return o._invalidLocation=d,!1}return!0}else if(arguments.length===2){var g=arguments[0],x=arguments[1];return this._location[0]=this._locFinder[0].getLocation(x),this._location[1]=this._locFinder[1].getLocation(x),this._location[2]=this._locFinder[2].getLocation(x),qi.hasLocation(this._location,ut.BOUNDARY)?!0:this.isValidResult(g,this._location)}};qi.prototype.addTestPts=function(o){var u=new Cl(o);this._testCoords.addAll(u.getPoints(5*this._boundaryDistanceTolerance))};qi.prototype.isValidResult=function(o,u){var h=je.isResultOfOp(u[0],u[1],o),d=u[2]===ut.INTERIOR,g=!(h^d);return g||this.reportResult(o,u,h),g};qi.prototype.getInvalidLocation=function(){return this._invalidLocation};qi.prototype.interfaces_=function(){return[]};qi.prototype.getClass=function(){return qi};qi.hasLocation=function(o,u){for(var h=0;h<3;h++)if(o[h]===u)return!0;return!1};qi.computeBoundaryDistanceTolerance=function(o,u){return Math.min(ln.computeSizeBasedSnapTolerance(o),ln.computeSizeBasedSnapTolerance(u))};qi.isValid=function(o,u,h,d){var g=new qi(o,u,d);return g.isValid(h)};_I.TOLERANCE.get=function(){return 1e-6};Object.defineProperties(qi,_I);var Fi=function c(o){this._geomFactory=null,this._skipEmpty=!1,this._inputGeoms=null,this._geomFactory=c.extractFactory(o),this._inputGeoms=o};Fi.prototype.extractElements=function(o,u){var h=this;if(o===null)return null;for(var d=0;d<o.getNumGeometries();d++){var g=o.getGeometryN(d);h._skipEmpty&&g.isEmpty()||u.add(g)}};Fi.prototype.combine=function(){for(var o=this,u=new jt,h=this._inputGeoms.iterator();h.hasNext();){var d=h.next();o.extractElements(d,u)}return u.size()===0?this._geomFactory!==null?this._geomFactory.createGeometryCollection(null):null:this._geomFactory.buildGeometry(u)};Fi.prototype.interfaces_=function(){return[]};Fi.prototype.getClass=function(){return Fi};Fi.combine=function(){if(arguments.length===1){var o=arguments[0],u=new Fi(o);return u.combine()}else if(arguments.length===2){var h=arguments[0],d=arguments[1],g=new Fi(Fi.createList(h,d));return g.combine()}else if(arguments.length===3){var x=arguments[0],I=arguments[1],S=arguments[2],D=new Fi(Fi.createList(x,I,S));return D.combine()}};Fi.extractFactory=function(o){return o.isEmpty()?null:o.iterator().next().getFactory()};Fi.createList=function(){if(arguments.length===2){var o=arguments[0],u=arguments[1],h=new jt;return h.add(o),h.add(u),h}else if(arguments.length===3){var d=arguments[0],g=arguments[1],x=arguments[2],I=new jt;return I.add(d),I.add(g),I.add(x),I}};var _n=function(){this._inputPolys=null,this._geomFactory=null;var o=arguments[0];this._inputPolys=o,this._inputPolys===null&&(this._inputPolys=new jt)},yI={STRTREE_NODE_CAPACITY:{configurable:!0}};_n.prototype.reduceToGeometries=function(o){for(var u=this,h=new jt,d=o.iterator();d.hasNext();){var g=d.next(),x=null;Ee(g,bo)?x=u.unionTree(g):g instanceof be&&(x=g),h.add(x)}return h};_n.prototype.extractByEnvelope=function(o,u,h){for(var d=new jt,g=0;g<u.getNumGeometries();g++){var x=u.getGeometryN(g);x.getEnvelopeInternal().intersects(o)?d.add(x):h.add(x)}return this._geomFactory.buildGeometry(d)};_n.prototype.unionOptimized=function(o,u){var h=o.getEnvelopeInternal(),d=u.getEnvelopeInternal();if(!h.intersects(d)){var g=Fi.combine(o,u);return g}if(o.getNumGeometries()<=1&&u.getNumGeometries()<=1)return this.unionActual(o,u);var x=h.intersection(d);return this.unionUsingEnvelopeIntersection(o,u,x)};_n.prototype.union=function(){if(this._inputPolys===null)throw new Error("union() method cannot be called twice");if(this._inputPolys.isEmpty())return null;this._geomFactory=this._inputPolys.iterator().next().getFactory();for(var o=new nI(_n.STRTREE_NODE_CAPACITY),u=this._inputPolys.iterator();u.hasNext();){var h=u.next();o.insert(h.getEnvelopeInternal(),h)}this._inputPolys=null;var d=o.itemsTree(),g=this.unionTree(d);return g};_n.prototype.binaryUnion=function(){if(arguments.length===1){var o=arguments[0];return this.binaryUnion(o,0,o.size())}else if(arguments.length===3){var u=arguments[0],h=arguments[1],d=arguments[2];if(d-h<=1){var g=_n.getGeometry(u,h);return this.unionSafe(g,null)}else{if(d-h===2)return this.unionSafe(_n.getGeometry(u,h),_n.getGeometry(u,h+1));var x=Math.trunc((d+h)/2),I=this.binaryUnion(u,h,x),S=this.binaryUnion(u,x,d);return this.unionSafe(I,S)}}};_n.prototype.repeatedUnion=function(o){for(var u=null,h=o.iterator();h.hasNext();){var d=h.next();u===null?u=d.copy():u=u.union(d)}return u};_n.prototype.unionSafe=function(o,u){return o===null&&u===null?null:o===null?u.copy():u===null?o.copy():this.unionOptimized(o,u)};_n.prototype.unionActual=function(o,u){return _n.restrictToPolygons(o.union(u))};_n.prototype.unionTree=function(o){var u=this.reduceToGeometries(o),h=this.binaryUnion(u);return h};_n.prototype.unionUsingEnvelopeIntersection=function(o,u,h){var d=new jt,g=this.extractByEnvelope(h,o,d),x=this.extractByEnvelope(h,u,d),I=this.unionActual(g,x);d.add(I);var S=Fi.combine(d);return S};_n.prototype.bufferUnion=function(){if(arguments.length===1){var o=arguments[0],u=o.get(0).getFactory(),h=u.buildGeometry(o),d=h.buffer(0);return d}else if(arguments.length===2){var g=arguments[0],x=arguments[1],I=g.getFactory(),S=I.createGeometryCollection([g,x]),D=S.buffer(0);return D}};_n.prototype.interfaces_=function(){return[]};_n.prototype.getClass=function(){return _n};_n.restrictToPolygons=function(o){if(Ee(o,Ia))return o;var u=Ws.getPolygons(o);return u.size()===1?u.get(0):o.getFactory().createMultiPolygon(He.toPolygonArray(u))};_n.getGeometry=function(o,u){return u>=o.size()?null:o.get(u)};_n.union=function(o){var u=new _n(o);return u.union()};yI.STRTREE_NODE_CAPACITY.get=function(){return 4};Object.defineProperties(_n,yI);var Zd=function(){};Zd.prototype.interfaces_=function(){return[]};Zd.prototype.getClass=function(){return Zd};Zd.union=function(o,u){if(o.isEmpty()||u.isEmpty()){if(o.isEmpty()&&u.isEmpty())return je.createEmptyResult(je.UNION,o,u,o.getFactory());if(o.isEmpty())return u.copy();if(u.isEmpty())return o.copy()}return o.checkNotGeometryCollection(o),o.checkNotGeometryCollection(u),gi.overlayOp(o,u,je.UNION)};function Al(){return new Xd}function Xd(){this.reset()}Xd.prototype={constructor:Xd,reset:function(){this.s=this.t=0},add:function(c){wT(Rd,c,this.t),wT(this,Rd.s,this.s),this.s?this.t+=Rd.t:this.s=Rd.t},valueOf:function(){return this.s}};var Rd=new Xd;function wT(c,o,u){var h=c.s=o+u,d=h-o,g=h-d;c.t=o-g+(u-d)}var rn=1e-6,Ar=Math.PI,Xs=Ar/2,ET=Ar/4,Qs=Ar*2,gl=180/Ar,jo=Ar/180,hi=Math.abs,wO=Math.atan,zc=Math.atan2,Tn=Math.cos,In=Math.sin,jc=Math.sqrt;function vI(c){return c>1?0:c<-1?Ar:Math.acos(c)}function cu(c){return c>1?Xs:c<-1?-Xs:Math.asin(c)}function Kh(){}function Wd(c,o){c&&IT.hasOwnProperty(c.type)&&IT[c.type](c,o)}var TT={Feature:function(c,o){Wd(c.geometry,o)},FeatureCollection:function(c,o){for(var u=c.features,h=-1,d=u.length;++h<d;)Wd(u[h].geometry,o)}},IT={Sphere:function(c,o){o.sphere()},Point:function(c,o){c=c.coordinates,o.point(c[0],c[1],c[2])},MultiPoint:function(c,o){for(var u=c.coordinates,h=-1,d=u.length;++h<d;)c=u[h],o.point(c[0],c[1],c[2])},LineString:function(c,o){tv(c.coordinates,o,0)},MultiLineString:function(c,o){for(var u=c.coordinates,h=-1,d=u.length;++h<d;)tv(u[h],o,0)},Polygon:function(c,o){ST(c.coordinates,o)},MultiPolygon:function(c,o){for(var u=c.coordinates,h=-1,d=u.length;++h<d;)ST(u[h],o)},GeometryCollection:function(c,o){for(var u=c.geometries,h=-1,d=u.length;++h<d;)Wd(u[h],o)}};function tv(c,o,u){var h=-1,d=c.length-u,g;for(o.lineStart();++h<d;)g=c[h],o.point(g[0],g[1],g[2]);o.lineEnd()}function ST(c,o){var u=-1,h=c.length;for(o.polygonStart();++u<h;)tv(c[u],o,1);o.polygonEnd()}function EO(c,o){c&&TT.hasOwnProperty(c.type)?TT[c.type](c,o):Wd(c,o)}Al();Al();function ev(c){return[zc(c[1],c[0]),cu(c[2])]}function kc(c){var o=c[0],u=c[1],h=Tn(u);return[h*Tn(o),h*In(o),In(u)]}function Od(c,o){return c[0]*o[0]+c[1]*o[1]+c[2]*o[2]}function Hd(c,o){return[c[1]*o[2]-c[2]*o[1],c[2]*o[0]-c[0]*o[2],c[0]*o[1]-c[1]*o[0]]}function Wy(c,o){c[0]+=o[0],c[1]+=o[1],c[2]+=o[2]}function Nd(c,o){return[c[0]*o,c[1]*o,c[2]*o]}function rv(c){var o=jc(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);c[0]/=o,c[1]/=o,c[2]/=o}Al();function xI(c,o){function u(h,d){return h=c(h,d),o(h[0],h[1])}return c.invert&&o.invert&&(u.invert=function(h,d){return h=o.invert(h,d),h&&c.invert(h[0],h[1])}),u}function nv(c,o){return[c>Ar?c-Qs:c<-Ar?c+Qs:c,o]}nv.invert=nv;function TO(c,o,u){return(c%=Qs)?o||u?xI(MT(c),AT(o,u)):MT(c):o||u?AT(o,u):nv}function CT(c){return function(o,u){return o+=c,[o>Ar?o-Qs:o<-Ar?o+Qs:o,u]}}function MT(c){var o=CT(c);return o.invert=CT(-c),o}function AT(c,o){var u=Tn(c),h=In(c),d=Tn(o),g=In(o);function x(I,S){var D=Tn(S),O=Tn(I)*D,B=In(I)*D,W=In(S),et=W*u+O*h;return[zc(B*d-et*g,O*u-W*h),cu(et*d+B*g)]}return x.invert=function(I,S){var D=Tn(S),O=Tn(I)*D,B=In(I)*D,W=In(S),et=W*d-B*g;return[zc(B*d+W*g,O*u+et*h),cu(et*u-O*h)]},x}function IO(c,o,u,h,d,g){if(u){var x=Tn(o),I=In(o),S=h*u;d==null?(d=o+h*Qs,g=o-S/2):(d=PT(x,d),g=PT(x,g),(h>0?d<g:d>g)&&(d+=h*Qs));for(var D,O=d;h>0?O>g:O<g;O-=S)D=ev([x,-I*Tn(O),-I*In(O)]),c.point(D[0],D[1])}}function PT(c,o){o=kc(o),o[0]-=c,rv(o);var u=vI(-o[1]);return((-o[2]<0?-u:u)+Qs-rn)%Qs}function bI(){var c=[],o;return{point:function(u,h){o.push([u,h])},lineStart:function(){c.push(o=[])},lineEnd:Kh,rejoin:function(){c.length>1&&c.push(c.pop().concat(c.shift()))},result:function(){var u=c;return c=[],o=null,u}}}function SO(c,o,u,h,d,g){var x=c[0],I=c[1],S=o[0],D=o[1],O=0,B=1,W=S-x,et=D-I,it;if(it=u-x,!(!W&&it>0)){if(it/=W,W<0){if(it<O)return;it<B&&(B=it)}else if(W>0){if(it>B)return;it>O&&(O=it)}if(it=d-x,!(!W&&it<0)){if(it/=W,W<0){if(it>B)return;it>O&&(O=it)}else if(W>0){if(it<O)return;it<B&&(B=it)}if(it=h-I,!(!et&&it>0)){if(it/=et,et<0){if(it<O)return;it<B&&(B=it)}else if(et>0){if(it>B)return;it>O&&(O=it)}if(it=g-I,!(!et&&it<0)){if(it/=et,et<0){if(it>B)return;it>O&&(O=it)}else if(et>0){if(it<O)return;it<B&&(B=it)}return O>0&&(c[0]=x+O*W,c[1]=I+O*et),B<1&&(o[0]=x+B*W,o[1]=I+B*et),!0}}}}}function Bd(c,o){return hi(c[0]-o[0])<rn&&hi(c[1]-o[1])<rn}function zd(c,o,u,h){this.x=c,this.z=o,this.o=u,this.e=h,this.v=!1,this.n=this.p=null}function wI(c,o,u,h,d){var g=[],x=[],I,S;if(c.forEach(function(it){if(!((bt=it.length-1)<=0)){var bt,ft=it[0],Pt=it[bt],kt;if(Bd(ft,Pt)){for(d.lineStart(),I=0;I<bt;++I)d.point((ft=it[I])[0],ft[1]);d.lineEnd();return}g.push(kt=new zd(ft,it,null,!0)),x.push(kt.o=new zd(ft,null,kt,!1)),g.push(kt=new zd(Pt,it,null,!1)),x.push(kt.o=new zd(Pt,null,kt,!0))}}),!!g.length){for(x.sort(o),LT(g),LT(x),I=0,S=x.length;I<S;++I)x[I].e=u=!u;for(var D=g[0],O,B;;){for(var W=D,et=!0;W.v;)if((W=W.n)===D)return;O=W.z,d.lineStart();do{if(W.v=W.o.v=!0,W.e){if(et)for(I=0,S=O.length;I<S;++I)d.point((B=O[I])[0],B[1]);else h(W.x,W.n.x,1,d);W=W.n}else{if(et)for(O=W.p.z,I=O.length-1;I>=0;--I)d.point((B=O[I])[0],B[1]);else h(W.x,W.p.x,-1,d);W=W.p}W=W.o,O=W.z,et=!et}while(!W.v);d.lineEnd()}}}function LT(c){if(o=c.length){for(var o,u=0,h=c[0],d;++u<o;)h.n=d=c[u],d.p=h,h=d;h.n=d=c[0],d.p=h}}function EI(c,o){return c<o?-1:c>o?1:c>=o?0:NaN}function CO(c){return c.length===1&&(c=MO(c)),{left:function(o,u,h,d){for(h==null&&(h=0),d==null&&(d=o.length);h<d;){var g=h+d>>>1;c(o[g],u)<0?h=g+1:d=g}return h},right:function(o,u,h,d){for(h==null&&(h=0),d==null&&(d=o.length);h<d;){var g=h+d>>>1;c(o[g],u)>0?d=g:h=g+1}return h}}}function MO(c){return function(o,u){return EI(c(o),u)}}CO(EI);function TI(c){for(var o=c.length,u,h=-1,d=0,g,x;++h<o;)d+=c[h].length;for(g=new Array(d);--o>=0;)for(x=c[o],u=x.length;--u>=0;)g[--d]=x[u];return g}var Jh=1e9,kd=-Jh;function AO(c,o,u,h){function d(D,O){return c<=D&&D<=u&&o<=O&&O<=h}function g(D,O,B,W){var et=0,it=0;if(D==null||(et=x(D,B))!==(it=x(O,B))||S(D,O)<0^B>0)do W.point(et===0||et===3?c:u,et>1?h:o);while((et=(et+B+4)%4)!==it);else W.point(O[0],O[1])}function x(D,O){return hi(D[0]-c)<rn?O>0?0:3:hi(D[0]-u)<rn?O>0?2:1:hi(D[1]-o)<rn?O>0?1:0:O>0?3:2}function I(D,O){return S(D.x,O.x)}function S(D,O){var B=x(D,1),W=x(O,1);return B!==W?B-W:B===0?O[1]-D[1]:B===1?D[0]-O[0]:B===2?D[1]-O[1]:O[0]-D[0]}return function(D){var O=D,B=bI(),W,et,it,bt,ft,Pt,kt,Nt,ne,Te,we,Ve={point:Ne,lineStart:Ir,lineEnd:re,polygonStart:ue,polygonEnd:Tr};function Ne(ir,Sr){d(ir,Sr)&&O.point(ir,Sr)}function H(){for(var ir=0,Sr=0,Mn=et.length;Sr<Mn;++Sr)for(var An=et[Sr],Bn=1,ai=An.length,Bt=An[0],Ti,Vn,Lo=Bt[0],ho=Bt[1];Bn<ai;++Bn)Ti=Lo,Vn=ho,Bt=An[Bn],Lo=Bt[0],ho=Bt[1],Vn<=h?ho>h&&(Lo-Ti)*(h-Vn)>(ho-Vn)*(c-Ti)&&++ir:ho<=h&&(Lo-Ti)*(h-Vn)<(ho-Vn)*(c-Ti)&&--ir;return ir}function ue(){O=B,W=[],et=[],we=!0}function Tr(){var ir=H(),Sr=we&&ir,Mn=(W=TI(W)).length;(Sr||Mn)&&(D.polygonStart(),Sr&&(D.lineStart(),g(null,null,1,D),D.lineEnd()),Mn&&wI(W,I,ir,g,D),D.polygonEnd()),O=D,W=et=it=null}function Ir(){Ve.point=qt,et&&et.push(it=[]),Te=!0,ne=!1,kt=Nt=NaN}function re(){W&&(qt(bt,ft),Pt&&ne&&B.rejoin(),W.push(B.result())),Ve.point=Ne,ne&&O.lineEnd()}function qt(ir,Sr){var Mn=d(ir,Sr);if(et&&it.push([ir,Sr]),Te)bt=ir,ft=Sr,Pt=Mn,Te=!1,Mn&&(O.lineStart(),O.point(ir,Sr));else if(Mn&&ne)O.point(ir,Sr);else{var An=[kt=Math.max(kd,Math.min(Jh,kt)),Nt=Math.max(kd,Math.min(Jh,Nt))],Bn=[ir=Math.max(kd,Math.min(Jh,ir)),Sr=Math.max(kd,Math.min(Jh,Sr))];SO(An,Bn,c,o,u,h)?(ne||(O.lineStart(),O.point(An[0],An[1])),O.point(Bn[0],Bn[1]),Mn||O.lineEnd(),we=!1):Mn&&(O.lineStart(),O.point(ir,Sr),we=!1)}kt=ir,Nt=Sr,ne=Mn}return Ve}}var Hy=Al();function PO(c,o){var u=o[0],h=o[1],d=[In(u),-Tn(u),0],g=0,x=0;Hy.reset();for(var I=0,S=c.length;I<S;++I)if(O=(D=c[I]).length)for(var D,O,B=D[O-1],W=B[0],et=B[1]/2+ET,it=In(et),bt=Tn(et),ft=0;ft<O;++ft,W=kt,it=ne,bt=Te,B=Pt){var Pt=D[ft],kt=Pt[0],Nt=Pt[1]/2+ET,ne=In(Nt),Te=Tn(Nt),we=kt-W,Ve=we>=0?1:-1,Ne=Ve*we,H=Ne>Ar,ue=it*ne;if(Hy.add(zc(ue*Ve*In(Ne),bt*Te+ue*Tn(Ne))),g+=H?we+Ve*Qs:we,H^W>=u^kt>=u){var Tr=Hd(kc(B),kc(Pt));rv(Tr);var Ir=Hd(d,Tr);rv(Ir);var re=(H^we>=0?-1:1)*cu(Ir[2]);(h>re||h===re&&(Tr[0]||Tr[1]))&&(x+=H^we>=0?1:-1)}}return(g<-rn||g<rn&&Hy<-rn)^x&1}Al();function DT(c){return c}Al();Al();var Fc=1/0,Yd=Fc,pp=-Fc,$d=pp,RT={point:LO,lineStart:Kh,lineEnd:Kh,polygonStart:Kh,polygonEnd:Kh,result:function(){var c=[[Fc,Yd],[pp,$d]];return pp=$d=-(Yd=Fc=1/0),c}};function LO(c,o){c<Fc&&(Fc=c),c>pp&&(pp=c),o<Yd&&(Yd=o),o>$d&&($d=o)}Al();function II(c,o,u,h){return function(d,g){var x=o(g),I=d.invert(h[0],h[1]),S=bI(),D=o(S),O=!1,B,W,et,it={point:bt,lineStart:Pt,lineEnd:kt,polygonStart:function(){it.point=Nt,it.lineStart=ne,it.lineEnd=Te,W=[],B=[]},polygonEnd:function(){it.point=bt,it.lineStart=Pt,it.lineEnd=kt,W=TI(W);var we=PO(B,I);W.length?(O||(g.polygonStart(),O=!0),wI(W,RO,we,u,g)):we&&(O||(g.polygonStart(),O=!0),g.lineStart(),u(null,null,1,g),g.lineEnd()),O&&(g.polygonEnd(),O=!1),W=B=null},sphere:function(){g.polygonStart(),g.lineStart(),u(null,null,1,g),g.lineEnd(),g.polygonEnd()}};function bt(we,Ve){var Ne=d(we,Ve);c(we=Ne[0],Ve=Ne[1])&&g.point(we,Ve)}function ft(we,Ve){var Ne=d(we,Ve);x.point(Ne[0],Ne[1])}function Pt(){it.point=ft,x.lineStart()}function kt(){it.point=bt,x.lineEnd()}function Nt(we,Ve){et.push([we,Ve]);var Ne=d(we,Ve);D.point(Ne[0],Ne[1])}function ne(){D.lineStart(),et=[]}function Te(){Nt(et[0][0],et[0][1]),D.lineEnd();var we=D.clean(),Ve=S.result(),Ne,H=Ve.length,ue,Tr,Ir;if(et.pop(),B.push(et),et=null,!!H){if(we&1){if(Tr=Ve[0],(ue=Tr.length-1)>0){for(O||(g.polygonStart(),O=!0),g.lineStart(),Ne=0;Ne<ue;++Ne)g.point((Ir=Tr[Ne])[0],Ir[1]);g.lineEnd()}return}H>1&&we&2&&Ve.push(Ve.pop().concat(Ve.shift())),W.push(Ve.filter(DO))}}return it}}function DO(c){return c.length>1}function RO(c,o){return((c=c.x)[0]<0?c[1]-Xs-rn:Xs-c[1])-((o=o.x)[0]<0?o[1]-Xs-rn:Xs-o[1])}const OT=II(function(){return!0},OO,zO,[-Ar,-Xs]);function OO(c){var o=NaN,u=NaN,h=NaN,d;return{lineStart:function(){c.lineStart(),d=1},point:function(g,x){var I=g>0?Ar:-Ar,S=hi(g-o);hi(S-Ar)<rn?(c.point(o,u=(u+x)/2>0?Xs:-Xs),c.point(h,u),c.lineEnd(),c.lineStart(),c.point(I,u),c.point(g,u),d=0):h!==I&&S>=Ar&&(hi(o-h)<rn&&(o-=h*rn),hi(g-I)<rn&&(g-=I*rn),u=NO(o,u,g,x),c.point(h,u),c.lineEnd(),c.lineStart(),c.point(I,u),d=0),c.point(o=g,u=x),h=I},lineEnd:function(){c.lineEnd(),o=u=NaN},clean:function(){return 2-d}}}function NO(c,o,u,h){var d,g,x=In(c-u);return hi(x)>rn?wO((In(o)*(g=Tn(h))*In(u)-In(h)*(d=Tn(o))*In(c))/(d*g*x)):(o+h)/2}function zO(c,o,u,h){var d;if(c==null)d=u*Xs,h.point(-Ar,d),h.point(0,d),h.point(Ar,d),h.point(Ar,0),h.point(Ar,-d),h.point(0,-d),h.point(-Ar,-d),h.point(-Ar,0),h.point(-Ar,d);else if(hi(c[0]-o[0])>rn){var g=c[0]<o[0]?Ar:-Ar;d=u*g/2,h.point(-g,d),h.point(0,d),h.point(g,d)}else h.point(o[0],o[1])}function kO(c,o){var u=Tn(c),h=u>0,d=hi(u)>rn;function g(O,B,W,et){IO(et,c,o,W,O,B)}function x(O,B){return Tn(O)*Tn(B)>u}function I(O){var B,W,et,it,bt;return{lineStart:function(){it=et=!1,bt=1},point:function(ft,Pt){var kt=[ft,Pt],Nt,ne=x(ft,Pt),Te=h?ne?0:D(ft,Pt):ne?D(ft+(ft<0?Ar:-Ar),Pt):0;if(!B&&(it=et=ne)&&O.lineStart(),ne!==et&&(Nt=S(B,kt),(!Nt||Bd(B,Nt)||Bd(kt,Nt))&&(kt[0]+=rn,kt[1]+=rn,ne=x(kt[0],kt[1]))),ne!==et)bt=0,ne?(O.lineStart(),Nt=S(kt,B),O.point(Nt[0],Nt[1])):(Nt=S(B,kt),O.point(Nt[0],Nt[1]),O.lineEnd()),B=Nt;else if(d&&B&&h^ne){var we;!(Te&W)&&(we=S(kt,B,!0))&&(bt=0,h?(O.lineStart(),O.point(we[0][0],we[0][1]),O.point(we[1][0],we[1][1]),O.lineEnd()):(O.point(we[1][0],we[1][1]),O.lineEnd(),O.lineStart(),O.point(we[0][0],we[0][1])))}ne&&(!B||!Bd(B,kt))&&O.point(kt[0],kt[1]),B=kt,et=ne,W=Te},lineEnd:function(){et&&O.lineEnd(),B=null},clean:function(){return bt|(it&&et)<<1}}}function S(O,B,W){var et=kc(O),it=kc(B),bt=[1,0,0],ft=Hd(et,it),Pt=Od(ft,ft),kt=ft[0],Nt=Pt-kt*kt;if(!Nt)return!W&&O;var ne=u*Pt/Nt,Te=-u*kt/Nt,we=Hd(bt,ft),Ve=Nd(bt,ne),Ne=Nd(ft,Te);Wy(Ve,Ne);var H=we,ue=Od(Ve,H),Tr=Od(H,H),Ir=ue*ue-Tr*(Od(Ve,Ve)-1);if(!(Ir<0)){var re=jc(Ir),qt=Nd(H,(-ue-re)/Tr);if(Wy(qt,Ve),qt=ev(qt),!W)return qt;var ir=O[0],Sr=B[0],Mn=O[1],An=B[1],Bn;Sr<ir&&(Bn=ir,ir=Sr,Sr=Bn);var ai=Sr-ir,Bt=hi(ai-Ar)<rn,Ti=Bt||ai<rn;if(!Bt&&An<Mn&&(Bn=Mn,Mn=An,An=Bn),Ti?Bt?Mn+An>0^qt[1]<(hi(qt[0]-ir)<rn?Mn:An):Mn<=qt[1]&&qt[1]<=An:ai>Ar^(ir<=qt[0]&&qt[0]<=Sr)){var Vn=Nd(H,(-ue+re)/Tr);return Wy(Vn,Ve),[qt,ev(Vn)]}}}function D(O,B){var W=h?c:Ar-c,et=0;return O<-W?et|=1:O>W&&(et|=2),B<-W?et|=4:B>W&&(et|=8),et}return II(x,I,g,h?[0,-c]:[-Ar,c-Ar])}function SI(c){return function(o){var u=new iv;for(var h in c)u[h]=c[h];return u.stream=o,u}}function iv(){}iv.prototype={constructor:iv,point:function(c,o){this.stream.point(c,o)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function CI(c,o,u){var h=o[1][0]-o[0][0],d=o[1][1]-o[0][1],g=c.clipExtent&&c.clipExtent();c.scale(150).translate([0,0]),g!=null&&c.clipExtent(null),EO(u,c.stream(RT));var x=RT.result(),I=Math.min(h/(x[1][0]-x[0][0]),d/(x[1][1]-x[0][1])),S=+o[0][0]+(h-I*(x[1][0]+x[0][0]))/2,D=+o[0][1]+(d-I*(x[1][1]+x[0][1]))/2;return g!=null&&c.clipExtent(g),c.scale(I*150).translate([S,D])}function FO(c,o,u){return CI(c,[[0,0],o],u)}var NT=16,BO=Tn(30*jo);function zT(c,o){return+o?UO(c,o):VO(c)}function VO(c){return SI({point:function(o,u){o=c(o,u),this.stream.point(o[0],o[1])}})}function UO(c,o){function u(h,d,g,x,I,S,D,O,B,W,et,it,bt,ft){var Pt=D-h,kt=O-d,Nt=Pt*Pt+kt*kt;if(Nt>4*o&&bt--){var ne=x+W,Te=I+et,we=S+it,Ve=jc(ne*ne+Te*Te+we*we),Ne=cu(we/=Ve),H=hi(hi(we)-1)<rn||hi(g-B)<rn?(g+B)/2:zc(Te,ne),ue=c(H,Ne),Tr=ue[0],Ir=ue[1],re=Tr-h,qt=Ir-d,ir=kt*re-Pt*qt;(ir*ir/Nt>o||hi((Pt*re+kt*qt)/Nt-.5)>.3||x*W+I*et+S*it<BO)&&(u(h,d,g,x,I,S,Tr,Ir,H,ne/=Ve,Te/=Ve,we,bt,ft),ft.point(Tr,Ir),u(Tr,Ir,H,ne,Te,we,D,O,B,W,et,it,bt,ft))}}return function(h){var d,g,x,I,S,D,O,B,W,et,it,bt,ft={point:Pt,lineStart:kt,lineEnd:ne,polygonStart:function(){h.polygonStart(),ft.lineStart=Te},polygonEnd:function(){h.polygonEnd(),ft.lineStart=kt}};function Pt(Ne,H){Ne=c(Ne,H),h.point(Ne[0],Ne[1])}function kt(){B=NaN,ft.point=Nt,h.lineStart()}function Nt(Ne,H){var ue=kc([Ne,H]),Tr=c(Ne,H);u(B,W,O,et,it,bt,B=Tr[0],W=Tr[1],O=Ne,et=ue[0],it=ue[1],bt=ue[2],NT,h),h.point(B,W)}function ne(){ft.point=Pt,h.lineEnd()}function Te(){kt(),ft.point=we,ft.lineEnd=Ve}function we(Ne,H){Nt(d=Ne,H),g=B,x=W,I=et,S=it,D=bt,ft.point=Nt}function Ve(){u(B,W,O,et,it,bt,g,x,d,I,S,D,NT,h),ft.lineEnd=ne,ne()}return ft}}var GO=SI({point:function(c,o){this.stream.point(c*jo,o*jo)}});function jO(c){return qO(function(){return c})()}function qO(c){var o,u=150,h=480,d=250,g,x,I=0,S=0,D=0,O=0,B=0,W,et,it=null,bt=OT,ft=null,Pt,kt,Nt,ne=DT,Te=.5,we=zT(Tr,Te),Ve,Ne;function H(qt){return qt=et(qt[0]*jo,qt[1]*jo),[qt[0]*u+g,x-qt[1]*u]}function ue(qt){return qt=et.invert((qt[0]-g)/u,(x-qt[1])/u),qt&&[qt[0]*gl,qt[1]*gl]}function Tr(qt,ir){return qt=o(qt,ir),[qt[0]*u+g,x-qt[1]*u]}H.stream=function(qt){return Ve&&Ne===qt?Ve:Ve=GO(bt(W,we(ne(Ne=qt))))},H.clipAngle=function(qt){return arguments.length?(bt=+qt?kO(it=qt*jo,6*jo):(it=null,OT),re()):it*gl},H.clipExtent=function(qt){return arguments.length?(ne=qt==null?(ft=Pt=kt=Nt=null,DT):AO(ft=+qt[0][0],Pt=+qt[0][1],kt=+qt[1][0],Nt=+qt[1][1]),re()):ft==null?null:[[ft,Pt],[kt,Nt]]},H.scale=function(qt){return arguments.length?(u=+qt,Ir()):u},H.translate=function(qt){return arguments.length?(h=+qt[0],d=+qt[1],Ir()):[h,d]},H.center=function(qt){return arguments.length?(I=qt[0]%360*jo,S=qt[1]%360*jo,Ir()):[I*gl,S*gl]},H.rotate=function(qt){return arguments.length?(D=qt[0]%360*jo,O=qt[1]%360*jo,B=qt.length>2?qt[2]%360*jo:0,Ir()):[D*gl,O*gl,B*gl]},H.precision=function(qt){return arguments.length?(we=zT(Tr,Te=qt*qt),re()):jc(Te)},H.fitExtent=function(qt,ir){return CI(H,qt,ir)},H.fitSize=function(qt,ir){return FO(H,qt,ir)};function Ir(){et=xI(W=TO(D,O,B),o);var qt=o(I,S);return g=h-qt[0]*u,x=d+qt[1]*u,re()}function re(){return Ve=Ne=null,H}return function(){return o=c.apply(this,arguments),H.invert=o.invert&&ue,Ir()}}function MI(c){return function(o,u){var h=Tn(o),d=Tn(u),g=c(h*d);return[g*d*In(o),g*In(u)]}}function AI(c){return function(o,u){var h=jc(o*o+u*u),d=c(h),g=In(d),x=Tn(d);return[zc(o*g,h*x),cu(h&&u*g/h)]}}var ZO=MI(function(c){return jc(2/(1+c))});ZO.invert=AI(function(c){return 2*cu(c/2)});var PI=MI(function(c){return(c=vI(c))&&c/In(c)});PI.invert=AI(function(c){return c});function XO(){return jO(PI).scale(79.4188).clipAngle(180-.001)}function kT(c,o){return[c,o]}kT.invert=kT;function WO(c,o,u){u=u||{};var h=u.units||"kilometers",d=u.steps||8;if(!c)throw new Error("geojson is required");if(typeof u!="object")throw new Error("options must be an object");if(typeof d!="number")throw new Error("steps must be an number");if(o===void 0)throw new Error("radius is required");if(d<=0)throw new Error("steps must be greater than 0");var g=[];switch(c.type){case"GeometryCollection":return lv(c,function(x){var I=Vd(x,o,h,d);I&&g.push(I)}),Yy(g);case"FeatureCollection":return fT(c,function(x){var I=Vd(x,o,h,d);I&&fT(I,function(S){S&&g.push(S)})}),Yy(g)}return Vd(c,o,h,d)}function Vd(c,o,u,h){var d=c.properties||{},g=c.type==="Feature"?c.geometry:c;if(g.type==="GeometryCollection"){var x=[];return lv(c,function(bt){var ft=Vd(bt,o,u,h);ft&&x.push(ft)}),Yy(x)}var I=HO(g),S={type:g.type,coordinates:DI(g.coordinates,I)},D=new _v,O=D.read(S),B=qR(ZR(o,u),"meters"),W=Hn.bufferOp(O,B,h),et=new eI;if(W=et.write(W),!LI(W.coordinates)){var it={type:W.type,coordinates:RI(W.coordinates,I)};return av(it,d)}}function LI(c){return Array.isArray(c[0])?LI(c[0]):isNaN(c[0])}function DI(c,o){return typeof c[0]!="object"?o(c):c.map(function(u){return DI(u,o)})}function RI(c,o){return typeof c[0]!="object"?o.invert(c):c.map(function(u){return RI(u,o)})}function HO(c){var o=iO(c).geometry.coordinates,u=[-o[0],-o[1]];return XO().rotate(u).scale(ki)}const YO=({target:c,map:o,tolerance:u,bufferRadius:h})=>{var d,g;if(!c.getAttribute("disabled")&&o.getSource("route")){const x=(d=o.getSource("route"))==null?void 0:d._data;if(x){const I=WO(x,h),S=eO(I,{tolerance:u});(g=o.getSource("buffer"))==null||g.setData(S);const D=document.getElementById("polygon-points");D.textContent=`Points: ${S.geometry.coordinates[0].length}`}}},$O=({map:c,firstLngLat:o,lastLngLat:u})=>{const h=`https://api.mapbox.com/directions/v5/mapbox/driving/${o[0]},${o[1]};${u[0]},${u[1]}?geometries=geojson&access_token=pk.eyJ1Ijoib3J1Y2JlIiwiYSI6ImNsbTZuZGxrZjBoN3czamxnM2V6aHBiZGEifQ.Fami0mGh65buxFjfJ0Ppjg`;fetch(h).then(d=>d.json()).then(d=>{const g=d.routes[0].geometry,x={type:"Feature",properties:{},geometry:g};c.getSource("route")&&(c.getSource("route").setData(x),document.getElementById("btn-buffer").removeAttribute("disabled"))})};Jd.accessToken="pk.eyJ1Ijoib3J1Y2JlIiwiYSI6ImNsbTZuZGxrZjBoN3czamxnM2V6aHBiZGEifQ.Fami0mGh65buxFjfJ0Ppjg";let fp=[],dp=[],mp=.0033;const ov=new Jd.Marker({color:"green"}),sv=new Jd.Marker({color:"red"}),ro=new Jd.Map({container:"mapContainer",zoom:10,center:[29,41.015137]}),$l=document.getElementById("btn-start"),Kl=document.getElementById("btn-finish"),Kd=document.getElementById("btn-draw-line"),KO=document.getElementById("btn-reset"),OI=document.getElementById("btn-buffer"),JO=document.getElementById("polygon-points");$l.addEventListener("click",()=>{if($l.dataset.active==="true"){$l.dataset.active=!1;return}Kl.dataset.active=!1,$l.dataset.active=!0});Kl.addEventListener("click",()=>{if(Kl.dataset.active==="true"){Kl.dataset.active=!1;return}$l.dataset.active=!1,Kl.dataset.active=!0});Kd.addEventListener("click",c=>{c.target.getAttribute("disabled")||$O({map:ro,firstLngLat:fp,lastLngLat:dp})});OI.addEventListener("click",c=>{c.target.getAttribute("disabled")||YO({target:c.target,map:ro,tolerance:mp,bufferRadius:.3})});const QO=()=>{fp=[],ov.remove(),dp=[],sv.remove(),$l.dataset.active=!1,Kl.dataset.active=!1,Kd.setAttribute("disabled",!0),OI.setAttribute("disabled",!0),JO.textContent="Points: -",ro.getSource("route")&&ro.getSource("route").setData({type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[]}}),ro.getSource("buffer")&&ro.getSource("buffer").setData({type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[]}})};KO.addEventListener("click",QO);const NI=document.getElementById("slider-tolerance"),zI=document.getElementById("text-tolerance");NI.addEventListener("input",c=>{mp=c.target.value,zI.value=String(parseFloat(mp).toFixed(4)).padEnd(4,"0")});zI.addEventListener("input",c=>{mp=parseFloat(c.target.value).toFixed(4),NI.value=mp});const FT=()=>{fp.length>0&&dp.length>0?Kd.removeAttribute("disabled"):Kd.setAttribute("disabled",!0)};ro.on("load",()=>{ro.addSource("buffer",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[]}}}),ro.addLayer({id:"buffer",type:"fill",source:"buffer",paint:{"fill-color":"#f00","fill-opacity":.4,"fill-outline-color":"#f00"}}),ro.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[]}}}),ro.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#00f","line-width":4}}),ro.on("click",c=>{if($l.dataset.active==="true"){fp=c.lngLat.toArray(),ov.remove(),ov.setLngLat(fp).addTo(ro),FT();return}if(Kl.dataset.active==="true"){dp=c.lngLat.toArray(),sv.remove(),sv.setLngLat(dp).addTo(ro),FT();return}})});
